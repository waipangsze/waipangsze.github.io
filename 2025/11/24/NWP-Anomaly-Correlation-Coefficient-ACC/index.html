

<!DOCTYPE html>
<html lang="en" data-default-color-scheme=light>



<head>
  <meta charset="UTF-8">

  <link rel="apple-touch-icon" sizes="76x76" href="/img/fluid.png">
  <link rel="icon" href="/img/fluid.png">
  

  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="wpsze">
  <meta name="keywords" content="">
  
    <meta name="description" content="Anomaly Correlation Coefficient (ACC)  https:&#x2F;&#x2F;confluence.ecmwf.int&#x2F;display&#x2F;FUG&#x2F;Section+6.2.2+Anomaly+Correlation+Coefficient ECMWF_ACC_definition  The Anomaly Correlation Coefficient (ACC) is one of">
<meta property="og:type" content="article">
<meta property="og:title" content="NWP | Anomaly Correlation Coefficient (ACC)">
<meta property="og:url" content="https://waipangsze.github.io/2025/11/24/NWP-Anomaly-Correlation-Coefficient-ACC/index.html">
<meta property="og:site_name" content="wpsze">
<meta property="og:description" content="Anomaly Correlation Coefficient (ACC)  https:&#x2F;&#x2F;confluence.ecmwf.int&#x2F;display&#x2F;FUG&#x2F;Section+6.2.2+Anomaly+Correlation+Coefficient ECMWF_ACC_definition  The Anomaly Correlation Coefficient (ACC) is one of">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://i.imgur.com/TfdXucM.png">
<meta property="article:published_time" content="2025-11-23T22:30:00.000Z">
<meta property="article:modified_time" content="2025-12-09T01:27:04.253Z">
<meta property="article:author" content="wpsze">
<meta property="article:tag" content="WRF">
<meta property="article:tag" content="MPAS">
<meta property="article:tag" content="NWP">
<meta property="article:tag" content="GFS">
<meta property="article:tag" content="FNL">
<meta property="article:tag" content="ERA5">
<meta property="article:tag" content="IFS">
<meta property="article:tag" content="CMA">
<meta property="article:tag" content="ACC">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://i.imgur.com/TfdXucM.png">
  
  
    <meta name="referrer" content="no-referrer-when-downgrade">
  
  
  <title>NWP | Anomaly Correlation Coefficient (ACC) - wpsze</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/c/font_1749284_5i9bdhy70f8.css">



<link rel="stylesheet" href="//at.alicdn.com/t/c/font_1736178_k526ubmyhba.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"waipangsze.github.io","root":"/","version":"1.9.8","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":true,"follow_dnt":true,"baidu":null,"google":{"measurement_id":"F7MK-FcxSomhtc1N3hIUDA"},"tencent":{"sid":null,"cid":null},"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false},"umami":{"src":null,"website_id":null,"domains":null,"start_time":"2024-01-01T00:00:00.000Z","token":null,"api_server":null}},"search_path":"/local-search.xml","include_content_in_search":true};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  

  

  
    <!-- Google tag (gtag.js) -->
    <script async>
      if (!Fluid.ctx.dnt) {
        Fluid.utils.createScript("https://www.googletagmanager.com/gtag/js?id=F7MK-FcxSomhtc1N3hIUDA", function() {
          window.dataLayer = window.dataLayer || [];
          function gtag() {
            dataLayer.push(arguments);
          }
          gtag('js', new Date());
          gtag('config', 'F7MK-FcxSomhtc1N3hIUDA');
        });
      }
    </script>
  

  

  

  



  
<meta name="generator" content="Hexo 7.3.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>wpsze</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/" target="_self">
                <i class="iconfont icon-home-fill"></i>
                <span>Home</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/" target="_self">
                <i class="iconfont icon-archive-fill"></i>
                <span>Archives</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/" target="_self">
                <i class="iconfont icon-category-fill"></i>
                <span>Categories</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/" target="_self">
                <i class="iconfont icon-tags-fill"></i>
                <span>Tags</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/links/" target="_self">
                <i class="iconfont icon-link-fill"></i>
                <span>Links</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/bookmark/" target="_self">
                <i class="iconfont icon-bookmark"></i>
                <span>Bookmarks</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item dropdown">
              <a class="nav-link dropdown-toggle" target="_self" href="javascript:;" role="button"
                 data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                <i class="iconfont icon-books"></i>
                <span>Docs</span>
              </a>
              <div class="dropdown-menu" aria-labelledby="navbarDropdown">
                
                  
                  
                  
                  <a class="dropdown-item" href="/categories/Physics/" target="_self">
                    <i class="iconfont icon-plan"></i>
                    <span>Physics</span>
                  </a>
                
                  
                  
                  
                  <a class="dropdown-item" href="/categories/Maths/" target="_self">
                    <i class="iconfont icon-plan"></i>
                    <span>Maths</span>
                  </a>
                
                  
                  
                  
                  <a class="dropdown-item" href="/categories/CFD/" target="_self">
                    <i class="iconfont icon-plan"></i>
                    <span>CFD</span>
                  </a>
                
                  
                  
                  
                  <a class="dropdown-item" href="/categories/ML/" target="_self">
                    <i class="iconfont icon-plan"></i>
                    <span>ML</span>
                  </a>
                
                  
                  
                  
                  <a class="dropdown-item" href="/categories/Meteorology/" target="_self">
                    <i class="iconfont icon-plan"></i>
                    <span>Meteorology</span>
                  </a>
                
                  
                  
                  
                  <a class="dropdown-item" href="/categories/MPAS/" target="_self">
                    <i class="iconfont icon-plan"></i>
                    <span>MPAS</span>
                  </a>
                
                  
                  
                  
                  <a class="dropdown-item" href="/categories/PALM/" target="_self">
                    <i class="iconfont icon-plan"></i>
                    <span>PALM</span>
                  </a>
                
                  
                  
                  
                  <a class="dropdown-item" href="/monitor/" target="_self">
                    
                    <span>Real Time Monitoring</span>
                  </a>
                
              </div>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/" target="_self">
                <i class="iconfont icon-user-fill"></i>
                <span>About Me</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('https://i.imgur.com/TfdXucM.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="NWP | Anomaly Correlation Coefficient (ACC)"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2025-11-24 06:30" pubdate>
          November 24, 2025 am
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          2.5k words
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          21 mins
        
      </span>
    

    
    
      
        <span id="busuanzi_container_page_pv" style="display: none">
          <i class="iconfont icon-eye" aria-hidden="true"></i>
          <span id="busuanzi_value_page_pv"></span> views
        </span>
        

      
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <h1 id="seo-header">NWP | Anomaly Correlation Coefficient (ACC)</h1>
            
            
              <div class="markdown-body">
                
                <h1 id="anomaly-correlation-coefficient-acc">Anomaly Correlation Coefficient (ACC)</h1>
<ul>
<li><a target="_blank" rel="noopener" href="https://confluence.ecmwf.int/display/FUG/Section+6.2.2+Anomaly+Correlation+Coefficient" class="uri">https://confluence.ecmwf.int/display/FUG/Section+6.2.2+Anomaly+Correlation+Coefficient</a></li>
<li><a target="_blank" rel="noopener" href="https://www.atmos.albany.edu/daes/atmclasses/atm401/spring_2016/ppts_pdfs/ECMWF_ACC_definition.pdf">ECMWF_ACC_definition</a></li>
</ul>
<p>The Anomaly Correlation Coefficient (ACC) is one of the most widely used measures in the verification of spatial fields. <strong>It is the spatial correlation between a forecast anomaly relative to climatology, and a verifying analysis anomaly relative to climatology</strong>. ACC is a measure of how well the forecast anomalies have represented the observed anomalies. It shows how well the predicted values from a forecast model "fit" with the real-life data. ACC for a series of forecast lead-times is a measure of how well trends in the predicted anomalies follow trends in actual anomalies.</p>
<div class="note note-primary">
            <p>The correlating forecasts directly with observations or analyses <strong>may give misleadingly high values because of the seasonal variations</strong>. It is therefore established practice to subtract the climate average from both the forecast and the verification and to verify the forecast and observed anomalies according to the anomaly correlation coefficient (ACC).</p>
          </div>
<p>ACC values lie between +1 and -1. Where ACC values:</p>
<ul>
<li>approach +1 there is good agreement and the forecast anomaly has had value.</li>
<li>lie around 0 there is poor agreement and the forecast has had no value.</li>
<li>approach –1 the agreement is in anti-phase and the forecast has been very misleading.</li>
</ul>
<p>Where the <strong>ACC value falls below 0.6</strong> it is considered that the positioning of synoptic scale features ceases to have value for forecasting purposes.</p>
<p><img src="https://confluence.ecmwf.int/download/attachments/462552904/Screenshot%202024-10-01%20at%2011.59.10.png?version=1&amp;modificationDate=1731409141794&amp;api=v2" srcset="/img/loading.gif" lazyload width="400" /></p>
<h1 id="what-the-acc-measures">What the ACC Measures</h1>
<p>The fundamental purpose of the ACC is to determine how well the forecast model captures the large-scale <strong>pattern and location</strong> of weather features that deviate from the long-term normal (the climatology).</p>
<ol type="1">
<li><strong>Anomaly Calculation:</strong> An anomaly is the deviation of a variable (e.g., <span class="math inline">\(500 \text{ hPa}\)</span> geopotential height) from its long-term average for that <strong>specific time and location</strong> (the <strong>climatology</strong>).
<ul>
<li><strong>Forecast Anomaly (<span class="math inline">\(F&#39;\)</span>):</strong> <span class="math inline">\(\text{Forecast} - \text{Climatology}\)</span></li>
<li><strong>Observed Anomaly (<span class="math inline">\(A&#39;\)</span>):</strong> <span class="math inline">\(\text{Observation} - \text{Climatology}\)</span></li>
</ul></li>
<li><strong>Correlation:</strong> The ACC is the <strong>Pearson correlation coefficient</strong> applied to the forecast anomalies (<span class="math inline">\(F&#39;\)</span>) and the observed anomalies (<span class="math inline">\(A&#39;\)</span>) across all grid points in the verification domain (e.g., the Northern Hemisphere).</li>
</ol>
<p>The ACC is a measure of the <strong>pattern accuracy</strong>, not the magnitude of the errors.</p>
<h2 id="the-formula">The Formula</h2>
<p>The ACC is mathematically defined as the spatial correlation between the forecast anomaly and the analysis (observed) anomaly:</p>
<p><span class="math display">\[
\text{ACC}_\text{uncentered}
= \frac{\sum_i w_i F&#39;_i A&#39;_i}
        {\sqrt{\sum_i w_i (F&#39;_i)^2}\,\sqrt{\sum_i w_i (A&#39;_i)^2}}
\]</span></p>
<p>or</p>
<p><span class="math display">\[\text{ACC}_\text{centered} = \frac{\sum_{i=1}^{N} w_i (F&#39;_i - \overline{F&#39;}) (A&#39;_i - \overline{A&#39;})}{\sqrt{\sum_{i=1}^{N} w_i (F&#39;_i - \overline{F&#39;})^2} \sqrt{\sum_{i=1}^{N} w_i (A&#39;_i - \overline{A&#39;})^2}}\]</span></p>
<p>Where:</p>
<ul>
<li><span class="math inline">\(N\)</span> is the total number of grid points in the domain.</li>
<li><span class="math inline">\(F&#39;_i\)</span> is the forecast anomaly at grid point <span class="math inline">\(i\)</span>.</li>
<li><span class="math inline">\(A&#39;_i\)</span> is the observed anomaly at grid point <span class="math inline">\(i\)</span>.</li>
<li><span class="math inline">\(\overline{F&#39;}\)</span> and <span class="math inline">\(\overline{A&#39;}\)</span> are the spatial mean of the forecast and observed anomalies, respectively (often calculated using weighting).</li>
<li><span class="math inline">\(w_i\)</span> is the <strong>area weighting coefficient</strong> for grid point <span class="math inline">\(i\)</span> (used because grid cells closer to the poles cover a smaller area).
<ul>
<li>To counteract the shrinking area of grid cells towards the poles, the most common and standard way to calculate the area weighting coefficient is using the <strong>cosine of the latitude</strong> (<span class="math inline">\(\phi_i\)</span>) for each grid point <span class="math inline">\(i\)</span>:
<ul>
<li><span class="math display">\[\mathbf{w_i \propto \cos(\phi_i)}\]</span>
<ul>
<li><strong>At the Equator (<span class="math inline">\(\phi = 0^{\circ}\)</span>):</strong> <span class="math inline">\(\cos(0^{\circ}) = 1\)</span>. The weighting is maximum, as these grid cells cover the largest area.</li>
<li><strong>Near the Poles (<span class="math inline">\(\phi \approx 90^{\circ}\)</span>):</strong> <span class="math inline">\(\cos(90^{\circ}) \approx 0\)</span>. The weighting is near zero, effectively down-weighting the small grid cells to ensure they don't overly influence the final result.</li>
<li></li>
</ul></li>
<li>By multiplying the forecast and observed anomalies by <span class="math inline">\(\cos(\phi_i)\)</span> before summing them in the numerator and denominator of the ACC formula, the calculation is essentially performed over an <strong>equal-area basis</strong>.</li>
<li>In practice, the ACC formula uses the weighted sum of anomalies and their squares, ensuring the final correlation value accurately reflects the skill of the forecast model across the entire geographical domain.</li>
</ul></li>
</ul></li>
</ul>
<p>The ACC ranges from <strong>-1 to +1</strong>, similar to the standard correlation coefficient:</p>
<table>

<thead>
<tr class="header">
<th style="text-align: center;">ACC Value</th>
<th style="text-align: left;">Interpretation</th>
<th style="text-align: left;">Skill Implication</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;"><strong>+1.0</strong></td>
<td style="text-align: left;"><strong>Perfect correlation.</strong> The forecast and observed anomaly patterns are identical.</td>
<td style="text-align: left;"><strong>Perfect Skill</strong></td>
</tr>
<tr class="even">
<td style="text-align: center;"><strong>+0.6</strong></td>
<td style="text-align: left;">Typically considered the threshold where the forecast retains useful <strong>synoptic skill</strong> (good enough for general weather prediction).</td>
<td style="text-align: left;"><strong>Useful Skill</strong></td>
</tr>
<tr class="odd">
<td style="text-align: center;"><strong>0.0</strong></td>
<td style="text-align: left;"><strong>No correlation.</strong> The forecast pattern is no better than a random pattern.</td>
<td style="text-align: left;"><strong>No Skill</strong></td>
</tr>
<tr class="even">
<td style="text-align: center;"><strong>-1.0</strong></td>
<td style="text-align: left;"><strong>Perfect negative correlation.</strong> The forecast pattern is completely opposite of the observed pattern.</td>
<td style="text-align: left;"><strong>Very Misleading Forecast</strong></td>
</tr>
</tbody>
</table>
<h3 id="key-applications">Key Applications</h3>
<ul>
<li><strong>Medium-Range Forecasts:</strong> The ACC of the <span class="math inline">\(500 \text{ hPa}\)</span> geopotential height (a proxy for the jet stream and large weather systems) is often the <strong>headline score</strong> used by major weather centers like ECMWF to track skill improvement over time.</li>
<li><strong>Forecast Horizon:</strong> ACC is commonly plotted against forecast lead-time (days) to determine the effective limit of predictability. For instance, if the ACC drops to <span class="math inline">\(0.6\)</span> at Day 10, the forecast is considered useful up to 10 days.</li>
</ul>
<h2 id="acc-vs.-other-metrics">ACC vs. Other Metrics</h2>
<p>The ACC is excellent for pattern but has limitations:</p>
<table>

<thead>
<tr class="header">
<th style="text-align: left;">Metric</th>
<th style="text-align: left;">Focus</th>
<th style="text-align: left;">Sensitivity</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;"><strong>ACC</strong></td>
<td style="text-align: left;"><strong>Pattern</strong> and Phase (Are the highs and lows in the right place?)</td>
<td style="text-align: left;"><strong>Not sensitive to bias</strong> (the difference in the mean magnitude). A forecast that is too cold everywhere but has the correct pattern will still score high.</td>
</tr>
<tr class="even">
<td style="text-align: left;"><strong>Root Mean Square Error (RMSE)</strong></td>
<td style="text-align: left;"><strong>Magnitude</strong> of error (How far off are the values in standard units?)</td>
<td style="text-align: left;">Sensitive to both pattern error and overall forecast bias.</td>
</tr>
</tbody>
</table>
<h1 id="uncentered-vs.-centered">Uncentered vs. centered</h1>
<ol type="1">
<li><a target="_blank" rel="noopener" href="https://dtcenter.org/metplus-practical-session-guide-version-5-0/basic-verification-statistics-review/continuous-forecasts/verification-statistics-continuous-forecasts#:~:text=While%20similar%20to%20the%20traditional%20correlation%20coefficient%2C%20anomaly%20correlation&amp;text=If%20it%20is%20not%20desirable%20to%20include%20the%20errors%2C%20the%20uncentered%20anomaly%20correlation">Verification Statistics for Continuous Forecasts | dtcenter</a>
<ol type="1">
<li>Anomaly Correlation</li>
<li>There are two widely used versions of anomaly correlation.
<ol type="1">
<li>The first is the <strong>centered</strong> anomaly correlation, which includes the mean error relative to the climatology. This version is calculated using</li>
<li><img src="https://dtcenter.org/sites/default/files/community-code/metplus/tutorial-images/5.0_Tutorial_stats_ANOM_CORR_eq.png" srcset="/img/loading.gif" lazyload /></li>
<li>If it is not desirable to include the errors, the <strong>uncentered</strong> anomaly correlation is the better choice:</li>
<li><img src="https://dtcenter.org/sites/default/files/community-code/metplus/tutorial-images/5.0_Tutorial_stats_ANOM_CORR_UNCNTR_eq.png" srcset="/img/loading.gif" lazyload /></li>
</ol></li>
</ol></li>
</ol>
<p>Anomaly correlation coefficient (ACC) can be defined in two slightly different ways, often called <strong>centered</strong> and <strong>uncentered</strong>; the distinction is about whether you remove the <em>sample mean of the anomalies themselves</em> before computing the correlation.</p>
<h2 id="uncentered-anomaly-correlation">Uncentered anomaly correlation</h2>
<p>The <strong>Uncentered ACC</strong> is a less common variation that measures the correspondence between the two anomaly fields <strong>without removing their spatial means</strong>.</p>
<p>This is what <strong>operational NWP centers almost always mean</strong> by <strong>“ACC”</strong>:</p>
<ul>
<li>Define anomalies relative to a <em>climatology</em> <span class="math inline">\(C\)</span>: <span class="math display">\[
F&#39;_i = F_i - C_i,\quad A&#39;_i = A_i - C_i
\]</span></li>
<li>Compute the correlation <strong>directly</strong> from these anomalies, without removing any additional mean: <span class="math display">\[
\text{ACC}_\text{uncentered}
= \frac{\sum_i w_i F&#39;_i A&#39;_i}
       {\sqrt{\sum_i w_i (F&#39;_i)^2}\,\sqrt{\sum_i w_i (A&#39;_i)^2}}
\]</span></li>
</ul>
<p>Here the only centering is the subtraction of climatology; there is no subtraction of the domain/sample mean of <span class="math inline">\(F&#39;\)</span> or <span class="math inline">\(A&#39;\)</span>.</p>
<div class="note note-primary">
            <p>This version <strong>keeps information about systematic errors relative to climatology</strong> (mean forecast anomaly vs. mean observed anomaly over the domain).</p>
          </div>
<h3 id="key-features">Key Features:</h3>
<ul>
<li><strong>No Removal of Spatial Mean:</strong> The spatial averages (<span class="math inline">\(\overline{F&#39;}\)</span> and <span class="math inline">\(\overline{A&#39;}\)</span>) are <em>not</em> subtracted.</li>
<li><strong>Sensitive to Bias:</strong> The <span class="math inline">\(\text{ACC}_{\text{uncentered}}\)</span> score is penalized if the overall spatial mean of the forecast anomaly differs significantly from the observed spatial mean anomaly. Therefore, it is sensitive to the <strong>overall bias</strong> of the forecast's anomaly field.</li>
<li><strong>Focus:</strong> It evaluates the pattern match <em>and</em> the similarity in the <strong>average magnitude</strong> of the anomalies across the domain.</li>
</ul>
<h2 id="centered-anomaly-correlation">Centered anomaly correlation</h2>
<p>The <strong>Centered ACC</strong> is the standard and most commonly used form in meteorological and climate forecast verification. It is calculated by first removing the <strong>spatial mean</strong> from both the forecast anomaly field (<span class="math inline">\(F&#39;\)</span>) and the observed anomaly field (<span class="math inline">\(A&#39;\)</span>).</p>
<p>The centered ACC is the <strong>Pearson product-moment correlation coefficient</strong> of the two anomaly fields:</p>
<p><span class="math display">\[\text{ACC}_{\text{centered}} = \frac{\sum w_i (F&#39;_i - \overline{F&#39;}) (A&#39;_i - \overline{A&#39;})}{\sqrt{\sum w_i (F&#39;_i - \overline{F&#39;})^2} \sqrt{\sum w_i (A&#39;_i - \overline{A&#39;})^2}}\]</span></p>
<p><em>Where <span class="math inline">\(F&#39;_i\)</span> is the forecast anomaly, <span class="math inline">\(A&#39;_i\)</span> is the observed anomaly, <span class="math inline">\(\overline{F&#39;}\)</span> and <span class="math inline">\(\overline{A&#39;}\)</span> are the spatial mean anomalies, and <span class="math inline">\(w_i\)</span> is the area weighting coefficient.</em></p>
<h3 id="key-features-1">Key Features:</h3>
<ul>
<li><strong>Removal of Spatial Mean:</strong> The spatial average of the anomalies (<span class="math inline">\(\overline{F&#39;}\)</span> and <span class="math inline">\(\overline{A&#39;}\)</span>) is subtracted from the respective fields before calculating the correlation.</li>
<li><strong>Insensitive to Bias:</strong> The <span class="math inline">\(\text{ACC}_{\text{centered}}\)</span> measures the similarity of the two patterns' shapes, <strong>regardless of the magnitude difference</strong> (bias) between the overall spatial mean of the forecast anomaly and the observed anomaly.</li>
<li><strong>Focus:</strong> It only evaluates the <strong>pattern match</strong> and <strong>phase agreement</strong> (i.e., whether the predicted high-pressure systems and low-pressure systems are in the correct geographical locations).</li>
</ul>
<h2 id="summary-of-the-difference">Summary of the Difference</h2>
<table>

<thead>
<tr class="header">
<th style="text-align: left;">Feature</th>
<th style="text-align: left;">Centered ACC (<span class="math inline">\(\text{ACC}_{\text{centered}}\)</span>)</th>
<th style="text-align: left;">Uncentered ACC (<span class="math inline">\(\text{ACC}_{\text{uncentered}}\)</span>)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;"><strong>Calculation</strong></td>
<td style="text-align: left;"><strong>Removes</strong> the spatial mean (<span class="math inline">\(\overline{F&#39;}\)</span> and <span class="math inline">\(\overline{A&#39;}\)</span>) from the anomaly fields.</td>
<td style="text-align: left;"><strong>Does NOT remove</strong> the spatial mean from the anomaly fields.</td>
</tr>
<tr class="even">
<td style="text-align: left;"><strong>Sensitivity</strong></td>
<td style="text-align: left;"><strong>Insensitive</strong> to the forecast's overall bias.</td>
<td style="text-align: left;"><strong>Sensitive</strong> to the forecast's overall bias.</td>
</tr>
</tbody>
</table>
<p>For example, if a model correctly predicts a cold air outbreak over North America but predicts that the air is <span class="math inline">\(2^\circ \text{C}\)</span> colder <em>on average</em> than what was observed across the domain, the <strong>Centered ACC</strong> would still be very high (due to the correct pattern), while the <strong>Uncentered ACC</strong> would be noticeably lower (penalized for the <span class="math inline">\(2^\circ \text{C}\)</span> cold bias).</p>
<h1 id="era5-for-climatological-term">ERA5 for Climatological term</h1>
<h2 id="defining-climatology-climate-normal">1. Defining Climatology (Climate Normal)</h2>
<ul>
<li>A <strong>Climatology</strong> (or <strong>Climate Normal</strong>) is the long-term average of a meteorological variable, typically calculated over a 30-year period (e.g., 1981–2010 or 1991–2020) as defined by the World Meteorological Organization (WMO).</li>
<li><strong>ERA5's Role:</strong> Since ERA5 provides consistent, continuous, gridded data for a long period (1940–present), researchers can use it to calculate climatologies for virtually any location on Earth for which ERA5 has data. For example, the mean temperature for every January 1st over the 1991–2020 period is derived directly from ERA5 data.</li>
</ul>
<h2 id="calculating-anomalies">2. Calculating Anomalies</h2>
<ul>
<li>An <strong>Anomaly</strong> is the deviation of a specific weather event or period from the climatological normal.</li>
<li><strong>ERA5's Role:</strong> By subtracting the long-term climatology (calculated from ERA5) from the <code>hourly or daily ERA5 value for a specific day, you get the anomaly</code>. This is essential for studying extreme events (e.g., a heatwave's temperature anomaly) and for climate monitoring (e.g., global temperature anomalies).</li>
</ul>
<h2 id="consistency-and-homogeneity">3. Consistency and Homogeneity</h2>
<ul>
<li>Climatological studies rely on <strong>homogeneity</strong>—the data must be comparable across the entire time series.</li>
<li><strong>ERA5's Role:</strong> It achieves this by using a <strong>single, modern, fixed numerical weather prediction model and data assimilation system</strong> to integrate all observations (satellite, ground station, etc.) from the past 80+ years. This process "fills the gaps" where observations were sparse and ensures that changes in the climate signal are due to the atmosphere, not due to changes in the measurement instruments or models over time.</li>
</ul>
<p>In summary, when a climate scientist mentions a <strong>climatological mean</strong>, <strong>anomaly</strong>, or <strong>reanalysis</strong> in the context of global data, they are most often referring to calculations derived from a product like <strong>ERA5</strong>.</p>
<h1 id="era5-download">ERA5 download</h1>
<ul>
<li>ERA5 hourly data on single levels from 1940 to present
<ul>
<li><a target="_blank" rel="noopener" href="https://cds.climate.copernicus.eu/datasets/reanalysis-era5-single-levels?tab=overview" class="uri">https://cds.climate.copernicus.eu/datasets/reanalysis-era5-single-levels?tab=overview</a></li>
</ul></li>
<li>ERA5 hourly data on pressure levels from 1940 to present
<ul>
<li><a target="_blank" rel="noopener" href="https://cds.climate.copernicus.eu/datasets/reanalysis-era5-pressure-levels?tab=overview" class="uri">https://cds.climate.copernicus.eu/datasets/reanalysis-era5-pressure-levels?tab=overview</a></li>
</ul></li>
<li>ERA5 monthly averaged data on single levels from 1940 to present
<ul>
<li><a target="_blank" rel="noopener" href="https://cds.climate.copernicus.eu/datasets/reanalysis-era5-single-levels-monthly-means?tab=overview" class="uri">https://cds.climate.copernicus.eu/datasets/reanalysis-era5-single-levels-monthly-means?tab=overview</a></li>
</ul></li>
<li>ERA5 monthly averaged data on pressure levels from 1940 to present
<ul>
<li><a target="_blank" rel="noopener" href="https://cds.climate.copernicus.eu/datasets/reanalysis-era5-pressure-levels-monthly-means?tab=download" class="uri">https://cds.climate.copernicus.eu/datasets/reanalysis-era5-pressure-levels-monthly-means?tab=download</a></li>
</ul></li>
</ul>
<h2 id="downloading-era5-single-layer-data">Downloading ERA5 Single-Layer Data</h2>
<p>This guide provides instructions for downloading single-layer atmospheric variables from the <strong>ERA5 reanalysis dataset</strong> using the <strong>ECMWF CDS API (Climate Data Store Application Programming Interface)</strong>.</p>
<h3 id="important-data-caveats">Important Data Caveats</h3>
<h4 id="daily-updates-and-preliminary-data-era5t">1. Daily Updates and Preliminary Data (ERA5T)</h4>
<ul>
<li>The ERA5 dataset is updated <strong>daily</strong> with a latency of approximately <strong>5 days</strong>.</li>
<li>The most recent data is initially released as <strong>ERA5T</strong> (T for "Timely"). This is a preliminary release.</li>
<li>In the event that serious flaws are detected in the ERA5T data, the final re-release (which occurs <strong>2 to 3 months</strong> later) may contain corrections and differ from the ERA5T version. Users are notified if such differences occur.</li>
</ul>
<h4 id="file-format-and-size">2. File Format and Size</h4>
<ul>
<li>All data downloaded via the CDS API is typically provided in <strong>GRIB format</strong>.</li>
<li>For bulk data processing or conversion to NetCDF, consider using tools like <code>grib_to_netcdf</code> (with the <code>-k 4</code> flag for large files) or Python libraries like <code>xarray</code> and <code>cfgrib</code>.</li>
</ul>
<h3 id="standard-single-layer-download">Standard Single-Layer Download</h3>
<p>Requests <strong>Mean Sea Level Pressure (msl)</strong>, <strong>2m Temperature (t2m)</strong>, and <strong>10m wind components (u10, v10)</strong> for a single day.</p>
<p>Then,</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">grib_to_netcdf -k 4 file_6h.grib -o ERA5_single_yyyy_6h.nc<span class="hljs-string">&quot;</span><br></code></pre></td></tr></table></figure>
<h3 id="downloading-era5t-real-time-data">Downloading ERA5T (Real-Time Data)</h3>
<p>If you need the very latest, most current data (the ERA5T version, which is generally available up to 5 days ago)</p>
<h2 id="pressure-level-data-download">Pressure Level Data Download</h2>
<p>Use a common subset for efficiency:</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs py">pressure_levels = [<br>    <span class="hljs-string">&#x27;200&#x27;</span>, <span class="hljs-string">&#x27;500&#x27;</span>, <span class="hljs-string">&#x27;700&#x27;</span>, <span class="hljs-string">&#x27;850&#x27;</span><br>]<br></code></pre></td></tr></table></figure>
<p>Then,</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">grib_to_netcdf -k 4 file_6h.grib -o ERA5_plevs_yyyy_6h.nc<span class="hljs-string">&quot;</span><br></code></pre></td></tr></table></figure>
<h1 id="build-the-era5-climatology-field">Build the ERA5 climatology field</h1>
<p>The goal is a mean state (climatology) <span class="math inline">\(C(t_{\text{cal}}, x)\)</span> for each calendar time and grid point, using only ERA5.</p>
<ul>
<li>Decide which ERA5 product to use (hourly, daily or monthly) and which variable, e.g. 500 hPa geopotential height, 850 hPa temperature, 2 m temperature, etc.</li>
<li>Select a long reference period, typically 30 years such as 1981–2010 or 1991–2020, so the climatology is stable.</li>
</ul>
<ol type="1">
<li>Extract ERA5 for the full reference period for your variable and pressure level.</li>
<li>Decide temporal resolution for climatology:
<ul>
<li><strong><code>Daily: all 1 Jan values across years, all 2 Jan, … (possibly smooth with a running window)</code></strong>.</li>
<li>Monthly: all Januaries, all Februaries, etc.</li>
</ul></li>
<li>For <strong>each calendar day (or month)</strong> and grid point, average across all years:<br />
<span class="math display">\[
C(d, x) = \frac{1}{N_{\text{years}}} \sum_{y=1}^{N_{\text{years}}} \text{ERA5}(y, d, x)
\]</span><br />
where <span class="math inline">\(d\)</span> is the day-of-year (or month) index and <span class="math inline">\(x\)</span> is the grid point.</li>
</ol>
<p>This yields a 3‑D array for daily climatology: <span class="math inline">\((\text{day}, \text{lat}, \text{lon})\)</span>, or <span class="math inline">\((\text{month}, \text{lat}, \text{lon})\)</span> for monthly.</p>
<h3 id="implementation-notes">Implementation notes</h3>
<ul>
<li>For daily climatology, you may use a running window <span class="math inline">\((± 7 days)\)</span> for smoother anomalies. <a target="_blank" rel="noopener" href="https://www.callendar.tech/en/post/tutorial-accessing-era5-land-reanalyses-and-calculating-a-climate-normal-with-python">link</a></li>
<li>For climate normals (monthly or annual), use monthly groupings.</li>
<li>For soil moisture or other surface variables, ERA5-Land provides higher spatial resolution.</li>
</ul>
<h2 id="align-model-forecasts-and-era5-analyses-with-climatology">Align model forecasts and ERA5 analyses with climatology</h2>
<ul>
<li>For each forecast valid time <span class="math inline">\(t\)</span>, determine its calendar day (or month) <span class="math inline">\(d\)</span>.</li>
<li>Interpolate the climatology <span class="math inline">\(C(d, x)\)</span> in time if needed, e.g. from monthly mean <span class="math inline">\(C(\text{month}, x)\)</span> to daily valid times.</li>
<li>Make sure the climatology is defined on the same grid as the forecast and analysis fields; if not, interpolate ERA5 or the model fields to a common grid first.</li>
</ul>
<h2 id="compute-anomalies">Compute anomalies</h2>
<p>For each forecast case and grid point <span class="math inline">\(x\)</span>:</p>
<ul>
<li>Forecast anomaly:<br />
<span class="math display">\[
F&#39;(t, x) = F(t, x) - C(d(t), x)
\]</span><br />
</li>
<li>Analysis (verification) anomaly using ERA5:<br />
<span class="math display">\[
A&#39;(t, x) = A(t, x) - C(d(t), x)
\]</span></li>
</ul>
<p>Using the same climatology for both is essential; <strong>do not use</strong> separate climatologies for forecast and verification when computing ACC.</p>
<h2 id="average-anomalies-over-time-cases-domain-if-desired">Average anomalies over time / cases / domain if desired</h2>
<p>Often ACC is computed for a sample of forecasts at the same lead time over many initial dates.</p>
<ul>
<li>Collect all <span class="math inline">\(F&#39;\)</span> and <span class="math inline">\(A&#39;\)</span> at a given lead time over the selected period.</li>
<li>Compute spatial means needed for correlation using that full set, e.g. subtract the spatial mean anomaly before computing covariance if using the covariance form of ACC. [be or not be]</li>
</ul>
<p><strong>This yields one ACC value per lead time (and region and variable).</strong></p>
<h1 id="era5-check-convert-gregorian-time-to-datetime">ERA5: check: convert Gregorian time to datetime</h1>
<ul>
<li>To check the validation of time of ERA5</li>
<li>To convert the time value from an ECMWF/ERA5 NetCDF file using Python's datetime and timedelta modules.</li>
</ul>

    <div class="fold">
      <div class="fold-title fold-info collapsed" data-toggle="collapse" href="#collapse-9c51fa20" role="button" aria-expanded="false" aria-controls="collapse-9c51fa20">
        <div class="fold-arrow">▶</div>convert gregorian time to datetime
      </div>
      <div class="fold-collapse collapse" id="collapse-9c51fa20">
        <div class="fold-content">
          <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> argparse<br><span class="hljs-keyword">from</span> datetime <span class="hljs-keyword">import</span> datetime, timedelta<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">convert_ecmwf_time</span>(<span class="hljs-params">ecmwf_time_value</span>):<br>    <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    Converts a time value (in hours since the epoch) from ECMWF data </span><br><span class="hljs-string">    to a Gregorian datetime object.</span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br>    <span class="hljs-comment"># Define the epoch as specified in the NetCDF &#x27;time:units&#x27; attribute</span><br>    <span class="hljs-comment"># For ECMWF data, this is commonly &#x27;1900-01-01 00:00:00.0&#x27;</span><br>    epoch_date = datetime(<span class="hljs-number">1900</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>)<br><br>    <span class="hljs-comment"># Calculate the timedelta from the epoch</span><br>    time_delta = timedelta(hours=ecmwf_time_value)<br><br>    <span class="hljs-comment"># Add the timedelta to the epoch to get the Gregorian datetime</span><br>    gregorian_datetime = epoch_date + time_delta<br><br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;--- ECMWF Time Conversion ---&quot;</span>)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;Epoch Date: <span class="hljs-subst">&#123;epoch_date&#125;</span>&quot;</span>)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;Input Time Value: <span class="hljs-subst">&#123;ecmwf_time_value&#125;</span> hours&quot;</span>)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;Time Delta: <span class="hljs-subst">&#123;time_delta&#125;</span>&quot;</span>)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;Gregorian Datetime: <span class="hljs-subst">&#123;gregorian_datetime&#125;</span>&quot;</span>)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;-----------------------------&quot;</span>)<br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&quot;__main__&quot;</span>:<br>    <span class="hljs-comment"># 1. Create the ArgumentParser object</span><br>    parser = argparse.ArgumentParser(<br>        description=<span class="hljs-string">&quot;Convert ECMWF time (hours since 1900-01-01) to a Gregorian datetime.&quot;</span><br>    )<br><br>    <span class="hljs-comment"># 2. Add the argument for the ECMWF time value</span><br>    parser.add_argument(<br>        <span class="hljs-string">&quot;ecmwf_time&quot;</span>,<br>        <span class="hljs-built_in">type</span>=<span class="hljs-built_in">int</span>,  <span class="hljs-comment"># Specify that the input should be an integer</span><br>        <span class="hljs-built_in">help</span>=<span class="hljs-string">&quot;The ECMWF time value in hours (e.g., 1000000).&quot;</span><br>    )<br><br>    <span class="hljs-comment"># 3. Parse the arguments from the command line</span><br>    args = parser.parse_args()<br><br>    <span class="hljs-comment"># 4. Call the conversion function with the parsed argument</span><br>    convert_ecmwf_time(args.ecmwf_time)<br></code></pre></td></tr></table></figure>
        </div>
      </div>
    </div>
<h1 id="grib-files-duplicate">grib files: Duplicate</h1>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs log"> $ grib_to_netcdf 580de9ac434a7edcacca1626ec12410e.grib -o ERA5_v10_1990_2010.nc<br>grib_to_netcdf: Version 2.19.1<br>grib_to_netcdf: Processing input file &#x27;580de9ac434a7edcacca1626ec12410e.grib&#x27;.<br>ECCODES ERROR   :  Wrong number of fields<br>ECCODES ERROR   :  File contains 7698 GRIBs, 7698 left in internal description, 7670 in request<br>ECCODES ERROR   :  The fields are not considered distinct!<br>ECCODES ERROR   :  Hint: This may be due to several fields having the same validity time.<br>ECCODES ERROR   :  Try using the -T option (Do not use time of validity)<br><br>$ grib_to_netcdf -T 580de9ac434a7edcacca1626ec12410e.grib -o v10.nc<br>grib_to_netcdf: Version 2.19.1<br>grib_to_netcdf: Processing input file &#x27;580de9ac434a7edcacca1626ec12410e.grib&#x27;.<br>ECCODES ERROR : Wrong number of fields<br>ECCODES ERROR : File contains 7698 GRIBs, 7698 left in internal description, 7670 in request<br>ECCODES ERROR : The fields are not considered distinct!<br>ECCODES ERROR : Hint: This may be due to several fields having the same date, time and step.<br></code></pre></td></tr></table></figure>
<ul>
<li>check duplicated terms</li>
</ul>
<figure class="highlight console"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs console">grib_ls 580de9ac434a7edcacca1626ec12410e.grib  &gt; log<br>sort log | uniq -d<br></code></pre></td></tr></table></figure>
<ul>
<li>python script</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/bin/python</span><br><span class="hljs-comment"># -*- coding: utf-8 -*-</span><br><br><span class="hljs-keyword">import</span> xarray <span class="hljs-keyword">as</span> xr<br><br><span class="hljs-comment"># 1. Define the input and output filenames</span><br>input_file = <span class="hljs-string">&#x27;580de9ac434a7edcacca1626ec12410e.grib&#x27;</span><br>output_file = <span class="hljs-string">&#x27;unique_fields.nc&#x27;</span><br><br><span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;Loading GRIB file: <span class="hljs-subst">&#123;input_file&#125;</span>...&quot;</span>)<br><br><span class="hljs-comment"># 2. Load the GRIB file into an xarray Dataset</span><br><span class="hljs-comment"># cfgrib automatically detects the unique dimensions (like time, step, level)</span><br><span class="hljs-comment"># and combines the fields. This is where the duplicates are handled.</span><br><span class="hljs-comment"># The &#x27;default&#x27; engine is cfgrib.</span><br><span class="hljs-keyword">try</span>:<br>    ds = xr.open_dataset(<br>        input_file,<br>        engine=<span class="hljs-string">&#x27;cfgrib&#x27;</span>,<br>        <span class="hljs-comment"># Set the backend_kwargs to control how cfgrib handles non-distinct fields.</span><br>        <span class="hljs-comment"># This tells cfgrib to aggressively combine fields based on keys.</span><br>        <span class="hljs-comment">#backend_kwargs=&#123;&#x27;read_keys&#x27;: [&#x27;dataDate&#x27;]&#125;</span><br>    )<br>    <br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Successfully loaded the file. Duplicates have been handled.&quot;</span>)<br>    <br>    <span class="hljs-comment"># 3. Save the resulting xarray Dataset back to a new GRIB file</span><br>    <span class="hljs-comment"># This will write out only the unique, combined fields.</span><br>    ds.to_netcdf(output_file)<br>    <br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;Clean GRIB file saved as: <span class="hljs-subst">&#123;output_file&#125;</span>&quot;</span>)<br>   <br><span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;An unexpected error occurred: <span class="hljs-subst">&#123;e&#125;</span>&quot;</span>)<br></code></pre></td></tr></table></figure>
<ul>
<li>check dimensions of .nc filenames</li>
</ul>
<figure class="highlight console"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs console">netcdf unique_fields &#123;<br>dimensions:<br>	time = 7670 ;<br>	latitude = 721 ;<br>	longitude = 1440 ;<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">Remark: correct one is</span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">netcdf ERA5_t2m_1990_2010 &#123;</span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">dimensions:</span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">	longitude = 1440 ;</span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">	latitude = 721 ;</span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">	time = 7670 ;</span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">variables:</span><br></code></pre></td></tr></table></figure>
<h1 id="proleptic_gregorian-vs-gregorian">proleptic_gregorian vs gregorian</h1>
<p>Your original time data (<code>1292630400, 1292716800, ...</code>) are large integers, suggesting units of <strong>seconds</strong> since a distant epoch (likely 1970-01-01).</p>
<p>Your target time data (<code>1060272, 1060296, ...</code>) are much smaller integers, suggesting units of <strong>hours</strong> (or days) since a more recent epoch.</p>
<p>To make this transformation, you need to use the <strong><code>cdo settime</code></strong> or <strong><code>cdo setreftime</code></strong> functions to redefine the time axis based on a new reference date and time unit.</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://code.mpimet.mpg.de/boards/2/topics/5974">cdo setreftime change the format of time units</a></li>
<li><a target="_blank" rel="noopener" href="https://code.mpimet.mpg.de/boards/2/topics/7762">Change the format of time:units</a></li>
<li><a target="_blank" rel="noopener" href="https://forum.ecmwf.int/t/new-time-format-in-era5-netcdf-files/3796">New time format in ERA5 netcdf files</a></li>
</ul>
<h2 id="method-using-cdo-to-change-time-units-and-reference">Method: Using CDO to Change Time Units and Reference</h2>
<p>The CDO command needed is <code>setreftime</code>. This operator allows you to set a new time unit and reference date for your time axis.</p>
<h3 id="determine-the-current-and-target-time-axis">1. Determine the Current and Target Time Axis</h3>
<p>You first need to inspect both files to know their current time settings.</p>
<ul>
<li><p><strong>Original File (<code>input.nc</code>):</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># Check the attributes of the time variable</span><br>ncdump -v time input.nc<br></code></pre></td></tr></table></figure>
<ul>
<li><strong>Original Units (Example):</strong> <code>seconds since 1970-01-01 00:00:00</code></li>
<li><strong>Original Calendar:</strong> <code>proleptic_gregorian</code></li>
</ul></li>
<li><p><strong>Target File (<code>target.nc</code> or desired state):</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># Check the attributes of the time variable on a file that has the desired format</span><br>ncdump -v time target.nc<br></code></pre></td></tr></table></figure>
<ul>
<li><strong>Target Units (Example):</strong> <code>hours since 1900-01-01 00:00:00</code></li>
<li><strong>Target Calendar:</strong> <code>gregorian</code></li>
</ul></li>
</ul>
<h3 id="run-the-cdo-setreftime-command">2. Run the CDO <code>setreftime</code> Command</h3>
<p>Once you know the <strong>target units</strong> and <strong>reference date</strong>, you can apply them to your input file.</p>
<p>For the example above, where you want to change from <code>seconds since 1970-01-01</code> to <code>hours since 1900-01-01</code> and change the calendar:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">cdo setreftime,1900-01-01,00:00:00,hours input.nc output.nc<br></code></pre></td></tr></table></figure>
<table>
<thead>
<tr class="header">
<th style="text-align: left;">Operator/Argument</th>
<th style="text-align: left;">Value</th>
<th style="text-align: left;">Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;"><code>setreftime</code></td>
<td style="text-align: left;"></td>
<td style="text-align: left;">The CDO operator to redefine the time reference.</td>
</tr>
<tr class="even">
<td style="text-align: left;"><strong><code>,1900-01-01</code></strong></td>
<td style="text-align: left;"></td>
<td style="text-align: left;">The new <strong>reference date</strong> (the "since" date).</td>
</tr>
<tr class="odd">
<td style="text-align: left;"><strong><code>,00:00:00</code></strong></td>
<td style="text-align: left;"></td>
<td style="text-align: left;">The new <strong>reference time</strong>.</td>
</tr>
<tr class="even">
<td style="text-align: left;"><strong><code>,hours</code></strong></td>
<td style="text-align: left;"></td>
<td style="text-align: left;">The new <strong>time unit</strong> (e.g., <code>hours</code>, <code>days</code>, <code>seconds</code>).</td>
</tr>
<tr class="odd">
<td style="text-align: left;"><strong><code>input.nc</code></strong></td>
<td style="text-align: left;"></td>
<td style="text-align: left;">Your original NetCDF file.</td>
</tr>
<tr class="even">
<td style="text-align: left;"><strong><code>output.nc</code></strong></td>
<td style="text-align: left;"></td>
<td style="text-align: left;">The new NetCDF file with the recalculated time axis.</td>
</tr>
</tbody>
</table>
<p>CDO automatically handles the calendar conversion and numerical recalculation during this process. The <code>setreftime</code> operation will:</p>
<ol type="1">
<li>Read the old time values, old units, and old reference date.</li>
<li>Calculate the absolute wall-clock time for each step.</li>
<li>Calculate the difference between the absolute time and the <strong>new reference date</strong> (<code>1900-01-01</code>).</li>
<li>Express that difference in the <strong>new units</strong> (<code>hours</code>).</li>
<li>Set the <code>calendar</code> attribute to a standard calendar (like <code>gregorian</code> or <code>standard</code>).</li>
</ol>
<h3 id="verification">3. Verification</h3>
<p>After running the command, check the new file's time variable to ensure the new values match your expected smaller integers:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">ncdump -v time output.nc<br></code></pre></td></tr></table></figure>
<p>This should show the smaller integers and the new time attributes (<code>units</code> and <code>calendar</code>).</p>
<h1 id="calculate-era5-climatology">Calculate ERA5 climatology</h1>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># variables to be verified </span><br>var_list = [<span class="hljs-string">&#x27;z&#x27;</span>, <span class="hljs-string">&#x27;t&#x27;</span>, <span class="hljs-string">&#x27;u&#x27;</span>, <span class="hljs-string">&#x27;v&#x27;</span>, <span class="hljs-string">&#x27;r&#x27;</span>, <span class="hljs-string">&#x27;msl&#x27;</span>, <span class="hljs-string">&#x27;t2m&#x27;</span>, <span class="hljs-string">&#x27;u10&#x27;</span>, <span class="hljs-string">&#x27;v10&#x27;</span>]<br>multilev_flag = [<span class="hljs-literal">True</span>, <span class="hljs-literal">True</span>, <span class="hljs-literal">True</span>, <span class="hljs-literal">True</span>, <span class="hljs-literal">True</span>, <span class="hljs-literal">False</span>, <span class="hljs-literal">False</span>, <span class="hljs-literal">False</span>, <span class="hljs-literal">False</span>] <span class="hljs-comment"># flag for whether variable is multi-level</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">calc_era5_clim</span>(<span class="hljs-params">var_list, multilev_flag</span>):<br>    <span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">    Function for calculating the climatology of a specific variable, from ERA5 reanalysis. </span><br><span class="hljs-string">    Climatology is defined in terms of day of year (366 days)</span><br><span class="hljs-string">    &#x27;&#x27;&#x27;</span><br>    data_dir = os.environ[<span class="hljs-string">&#x27;DATA_DIR&#x27;</span>]<br><br>    <span class="hljs-keyword">for</span> ivar, varname <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(var_list):<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;Extracting ERA5 climatology for varname=<span class="hljs-subst">&#123;varname&#125;</span>&#x27;</span>)<br><br>        <span class="hljs-keyword">if</span> multilev_flag[ivar]:<br>            var_nc = <span class="hljs-string">f&#x27;<span class="hljs-subst">&#123;data_dir&#125;</span>/ERA5_<span class="hljs-subst">&#123;varname&#125;</span>plevs_1990_2010.nc&#x27;</span><br>        <span class="hljs-keyword">else</span>:<br>            var_nc = <span class="hljs-string">f&#x27;<span class="hljs-subst">&#123;data_dir&#125;</span>/ERA5_<span class="hljs-subst">&#123;varname&#125;</span>_1990_2010.nc&#x27;</span><br><br>        var_da = xr.open_dataset(var_nc)[<span class="hljs-string">f&#x27;<span class="hljs-subst">&#123;varname&#125;</span>&#x27;</span>]<br>        <br>        var_clim = var_da.groupby(<span class="hljs-string">&#x27;time.dayofyear&#x27;</span>).mean(<span class="hljs-string">&#x27;time&#x27;</span>)<br><br>        <span class="hljs-keyword">if</span> ivar == <span class="hljs-number">0</span>:<br>            ds_doy = var_clim.dayofyear <br>            ds_lat = var_da.latitude<br>            ds_lon = var_da.longitude<br><br>            <span class="hljs-comment"># create empty dataset</span><br>            clim_ds = xr.Dataset(&#123;&#125;, coords=&#123;<span class="hljs-string">&quot;latitude&quot;</span>:ds_lat, <span class="hljs-string">&quot;longitude&quot;</span>:ds_lon, <span class="hljs-string">&quot;dayofyear&quot;</span>:ds_doy&#125;)<br><br>        <span class="hljs-keyword">if</span> varname == <span class="hljs-string">&#x27;z&#x27;</span>:<br>            g = <span class="hljs-number">9.80665</span><br>            var_clim /= g <span class="hljs-comment"># convert gp to gph</span><br><br>        clim_ds[<span class="hljs-string">f&#x27;<span class="hljs-subst">&#123;varname&#125;</span>&#x27;</span>] = var_clim<br>        <span class="hljs-built_in">print</span>(clim_ds)<br><br>    <span class="hljs-comment"># shift longitudes to +/-180</span><br>    clim_ds.coords[<span class="hljs-string">&#x27;longitude&#x27;</span>] = (clim_ds.coords[<span class="hljs-string">&#x27;longitude&#x27;</span>] + <span class="hljs-number">180</span>) % <span class="hljs-number">360</span> - <span class="hljs-number">180</span><br>    <span class="hljs-comment"># reindex to re-arrange in ascending order</span><br>    clim_ds = clim_ds.reindex(longitude=(np.arange(-<span class="hljs-number">180</span>,<span class="hljs-number">180</span>,<span class="hljs-number">0.25</span>)))<br><br>    clim_ds.to_netcdf(<span class="hljs-string">f&#x27;<span class="hljs-subst">&#123;data_dir&#125;</span>/ERA5_scorecard_clim_1990_2010.nc&#x27;</span>)<br><br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;ERA5 climatology file generated.&#x27;</span>)<br></code></pre></td></tr></table></figure>
<p>Result is,</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs log">dimensions:<br>	latitude = 721 ;<br>	longitude = 1440 ;<br>	dayofyear = 366 ;<br>	level = 4 ;<br></code></pre></td></tr></table></figure>
<h1 id="optional-add-levellevel">(Optional) Add <code>level(level)</code></h1>

    <div class="fold">
      <div class="fold-title fold-info collapsed" data-toggle="collapse" href="#collapse-98e16488" role="button" aria-expanded="false" aria-controls="collapse-98e16488">
        <div class="fold-arrow">▶</div>add_level_hPa.py
      </div>
      <div class="fold-collapse collapse" id="collapse-98e16488">
        <div class="fold-content">
          <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/bin/python</span><br><span class="hljs-comment"># -*- coding: utf-8 -*-</span><br><br><span class="hljs-keyword">import</span> xarray <span class="hljs-keyword">as</span> xr<br><span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np<br><br><span class="hljs-comment"># --- Configuration ---</span><br>input_file = <span class="hljs-string">&#x27;ERA5_rplevs_1990_2010.nc&#x27;</span><br>output_file = <span class="hljs-string">&#x27;ERA5_rplevs_1990_2010_final.nc&#x27;</span><br><br><span class="hljs-comment"># The values and attributes for the new coordinate variable</span><br>level_values = np.array([<span class="hljs-number">850</span>, <span class="hljs-number">700</span>, <span class="hljs-number">500</span>, <span class="hljs-number">200</span>], dtype=np.int32) <span class="hljs-comment"># Use int32 for small integers</span><br>level_attributes = &#123;<br>    <span class="hljs-string">&#x27;units&#x27;</span>: <span class="hljs-string">&#x27;millibars&#x27;</span>,<br>    <span class="hljs-string">&#x27;long_name&#x27;</span>: <span class="hljs-string">&#x27;pressure_level&#x27;</span><br>&#125;<br><br><span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;Loading file: <span class="hljs-subst">&#123;input_file&#125;</span>...&quot;</span>)<br><br><span class="hljs-keyword">try</span>:<br>    <span class="hljs-comment"># 1. Load the NetCDF file into an xarray Dataset</span><br>    <span class="hljs-comment"># Use engine=&#x27;netcdf4&#x27; for standard NetCDF files</span><br>    ds = xr.open_dataset(input_file, engine=<span class="hljs-string">&#x27;netcdf4&#x27;</span>)<br><br>    <span class="hljs-comment"># 2. Verify the dimension size (Optional but good practice)</span><br>    expected_size = <span class="hljs-built_in">len</span>(level_values)<br>    current_size = ds.dims[<span class="hljs-string">&#x27;level&#x27;</span>]<br><br>    <span class="hljs-keyword">if</span> current_size != expected_size:<br>        <span class="hljs-keyword">raise</span> ValueError(<span class="hljs-string">f&quot;Dimension &#x27;level&#x27; size (<span class="hljs-subst">&#123;current_size&#125;</span>) does not match the number of values to add (<span class="hljs-subst">&#123;expected_size&#125;</span>).&quot;</span>)<br><br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;Dimension &#x27;level&#x27; has size <span class="hljs-subst">&#123;current_size&#125;</span>. Proceeding to add coordinate variable.&quot;</span>)<br><br>    <span class="hljs-comment"># 3. Create the new coordinate variable</span><br>    <span class="hljs-comment"># We create a new DataArray that shares the name and dimension of the existing &#x27;level&#x27; dimension.</span><br>    level_coord = xr.DataArray(<br>        data=level_values,<br>        dims=<span class="hljs-string">&#x27;level&#x27;</span>,  <span class="hljs-comment"># Must match the existing dimension name</span><br>        name=<span class="hljs-string">&#x27;level&#x27;</span>,  <span class="hljs-comment"># Must match the existing dimension name</span><br>        attrs=level_attributes<br>    )<br><br>    <span class="hljs-comment"># 4. Assign the new coordinate variable to the Dataset</span><br>    <span class="hljs-comment"># This overwrites the dimension&#x27;s coordinate array if one existed, or adds it if it was missing.</span><br>    ds = ds.assign_coords(level=level_coord)<br><br>    <span class="hljs-comment"># 5. Save the modified Dataset to a new NetCDF file</span><br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;Saving modified data to: <span class="hljs-subst">&#123;output_file&#125;</span>&quot;</span>)<br>    ds.to_netcdf(output_file)<br><br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;-&quot;</span> * <span class="hljs-number">30</span>)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;✅ Success! Variable &#x27;level&#x27; added with values <span class="hljs-subst">&#123;level_values.tolist()&#125;</span> and attributes.&quot;</span>)<br><br><span class="hljs-keyword">except</span> FileNotFoundError:<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;❌ Error: Input file &#x27;<span class="hljs-subst">&#123;input_file&#125;</span>&#x27; not found.&quot;</span>)<br><span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;❌ An error occurred: <span class="hljs-subst">&#123;e&#125;</span>&quot;</span>)<br></code></pre></td></tr></table></figure>
        </div>
      </div>
    </div>
<h1 id="optional-reordered-the-level-dimension">(Optional) Reordered the <code>level</code> dimension</h1>

    <div class="fold">
      <div class="fold-title fold-info collapsed" data-toggle="collapse" href="#collapse-1607c597" role="button" aria-expanded="false" aria-controls="collapse-1607c597">
        <div class="fold-arrow">▶</div>reorder_level.py
      </div>
      <div class="fold-collapse collapse" id="collapse-1607c597">
        <div class="fold-content">
          <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/bin/python</span><br><span class="hljs-comment"># -*- coding: utf-8 -*-</span><br><br><span class="hljs-keyword">import</span> xarray <span class="hljs-keyword">as</span> xr<br><span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np<br><br><span class="hljs-comment"># --- Configuration ---</span><br>input_file = <span class="hljs-string">&#x27;ERA5_zplevs_1990_2010_final.nc&#x27;</span><br>output_file = <span class="hljs-string">&#x27;ERA5_zplevs_1990_2010_final_reordered.nc&#x27;</span><br><br><span class="hljs-keyword">try</span>:<br>    <span class="hljs-comment"># 1. Load the NetCDF file</span><br>    <span class="hljs-comment"># Ensure all data and coordinates are read</span><br>    ds = xr.open_dataset(input_file)<br>    <br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;Original &#x27;level&#x27; coordinate values: <span class="hljs-subst">&#123;ds[<span class="hljs-string">&#x27;level&#x27;</span>].values&#125;</span>&quot;</span>)<br>    <br>    <span class="hljs-comment"># 2. Check the current order and determine the sorting direction</span><br>    <span class="hljs-comment"># Sorting by &#x27;level&#x27; with ascending=False will sort the *data* so that </span><br>    <span class="hljs-comment"># the lowest value (200) is at the start (index 0).</span><br>    <span class="hljs-comment"># Since pressure levels are typically stored in descending order (highest pressure at index 0),</span><br>    <span class="hljs-comment"># but you want to sort by the coordinate values, we usually sort by ascending value.</span><br><br>    <span class="hljs-comment"># 3. Sort the Dataset by the &#x27;level&#x27; coordinate</span><br>    <span class="hljs-comment"># The sortby() function reorders all variables and coordinates along the &#x27;level&#x27; dimension.</span><br>    <span class="hljs-comment"># To get &#123;200, 500, 700, 850&#125; you sort in ascending order of value.</span><br>    ds_reordered = ds.sortby(<span class="hljs-string">&#x27;level&#x27;</span>, ascending=<span class="hljs-literal">True</span>)<br><br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;Reordered &#x27;level&#x27; coordinate values: <span class="hljs-subst">&#123;ds_reordered[<span class="hljs-string">&#x27;level&#x27;</span>].values&#125;</span>&quot;</span>)<br><br>    <span class="hljs-comment"># 4. Save the reordered Dataset to a new NetCDF file</span><br>    ds_reordered.to_netcdf(output_file)<br>    <br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;\n✅ Success! File saved to: <span class="hljs-subst">&#123;output_file&#125;</span>&quot;</span>)<br>    <br><span class="hljs-keyword">except</span> FileNotFoundError:<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;❌ Error: Input file &#x27;<span class="hljs-subst">&#123;input_file&#125;</span>&#x27; not found.&quot;</span>)<br><span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;❌ An error occurred during processing: <span class="hljs-subst">&#123;e&#125;</span>&quot;</span>)<br></code></pre></td></tr></table></figure>
        </div>
      </div>
    </div>
<h1 id="optional-how-to-average-two-nc-files-with-weighting">(Optional) how to average two nc files with weighting?</h1>
<h2 id="method-weighted-average-using-cdo-mul-and-add">Method: Weighted Average using CDO (<code>mul</code> and <code>add</code>)</h2>
<p>If you want to perform a more complex operation or if you have weighting factors stored in a separate mask file, you can use the sequential operators <code>mul</code> and <code>add</code>.</p>
<h3 id="scenario-weighting-by-a-constant-value">Scenario: Weighting by a Constant Value</h3>
<p>If you want the exact same result as Method 1 but prefer using sequential operators:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 1. Multiply each file by its constant weight</span><br>cdo mulc,0.4 file1.nc file1_weighted.nc<br>cdo mulc,0.6 file2.nc file2_weighted.nc<br><br><span class="hljs-comment"># 2. Add the two weighted files together</span><br>cdo add file1_weighted.nc file2_weighted.nc output_wavg_manual.nc<br></code></pre></td></tr></table></figure>
<ul>
<li><code>mulc,W</code>: Multiplies the entire file's data by the constant <span class="math inline">\(W\)</span>.</li>
</ul>
<h3 id="error-warning-cdfcheckvars-4-dimensional-variables-without-time-dimension-are-not-supported-skipped-variable-z">Error: Warning (cdfCheckVars): 4 dimensional variables without time dimension are not supported, skipped variable z</h3>
<ul>
<li><strong>Warning (cdfCheckVars): 4 dimensional variables without time dimension are not supported, skipped variable z</strong></li>
</ul>
<p>That warning message from <strong>CDO (Climate Data Operators)</strong>, specifically the <code>cdfCheckVars</code> function, indicates that your NetCDF file contains a four-dimensional (4D) variable named <strong><code>z</code></strong> that <strong>CDO cannot interpret correctly</strong> because it doesn't recognize the expected time dimension.</p>
<p>CDO and many climate analysis tools are designed to work with structured data where the dimensions are typically:</p>
<ol type="1">
<li><strong>Time</strong> (the first dimension)</li>
<li><strong>Level</strong> (e.g., pressure, height)</li>
<li><strong>Latitude</strong></li>
<li><strong>Longitude</strong></li>
</ol>
<p>When CDO encounters a 4D variable that doesn't follow this convention (i.e., the first dimension is not marked as <code>time</code>), it skips the variable, leading to the warning.</p>
<h4 id="how-to-resolve-this-warning">How to Resolve This Warning</h4>
<p>You have two main options:</p>
<h5 id="rename-the-dimension-to-time-recommended-fix">Rename the Dimension to <code>time</code> (Recommended Fix)</h5>
<p>If the first dimension of the variable <code>z</code> <strong>is actually a time dimension</strong>, you need to use <strong>NCO (NetCDF Operators)</strong> to rename it so CDO can recognize it.</p>
<ol type="1">
<li><p><strong>Inspect the File:</strong> Use <code>ncdump -h your_file.nc</code> to see the dimensions. Find the 4D variable <code>z</code> and look at its dimensions. Let's assume the first dimension is named <code>t_dim</code>.</p>
<ul>
<li><strong>Original:</strong> <code>z(t_dim, level, lat, lon)</code></li>
</ul></li>
<li><p><strong>Rename the Dimension:</strong> Use NCO's <code>ncrename</code> command to change the name of the first dimension to <code>time</code>.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">ncrename -d t_dim,time input.nc output.nc<br></code></pre></td></tr></table></figure>
<ul>
<li><code>-d</code>: Renames a <strong>dimension</strong>.</li>
<li><code>t_dim,time</code>: Changes the dimension named <code>t_dim</code> to <code>time</code>.</li>
</ul></li>
<li><p><strong>Check Time Variables:</strong> You might also need to rename the coordinate variable associated with that dimension (if it exists) and ensure its <code>units</code> attribute is set correctly (e.g., <code>hours since 2000-01-01</code>).</p></li>
</ol>
<h4 id="example">Example</h4>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs sh">ncrename -d dayofyear,time ../ERA5_scorecard_clim_2011_2020.nc output_ERA5_scorecard_clim_2011_2020.nc<br>ncrename -d dayofyear,time ../ERA5_scorecard_clim_1990_2010.nc output_ERA5_scorecard_clim_1990_2010.nc<br><br><span class="hljs-comment"># 1. Multiply each file by its constant weight</span><br>cdo mulc,0.323 output_ERA5_scorecard_clim_2011_2020.nc weighted_ERA5_scorecard_clim_2011_2020.nc<br>cdo mulc,0.677 output_ERA5_scorecard_clim_1990_2010.nc weighted_ERA5_scorecard_clim_1990_2010.nc<br><br><span class="hljs-comment"># 2. Add the two weighted files together</span><br>cdo add weighted_ERA5_scorecard_clim_2011_2020.nc weighted_ERA5_scorecard_clim_1990_2010.nc ERA5_scorecard_clim_1990_2020.nc<br></code></pre></td></tr></table></figure>
<h4 id="error">Error</h4>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs log">ERROR NC_EHDFERR Error at HDF5 layer<br>HINT: NC_EHDFERR errors indicate that the HDF5-backend to netCDF is unable to perform the requested task. NCO can receive this devilishly inscrutable error for a variety of possible reasons including: 1) The run-time dynamic linker attempts to resolve calls from the netCDF library to the HDF library with an HDF5 libhdf5.a that is incompatible with the version used to build NCO and netCDF. 2) The file system does not allow the HDF5 flock() function, as of HDF5 1.10.x, to enable multiple processes to open the same file for reading, a feature known as SWMR (Single Write Multiple Read). The fix is to disable the HDF5 flock() by setting an environment variable thusly: &quot;export HDF5_USE_FILE_LOCKING=FALSE&quot;. 3) An incorrect netCDF4 library implementation of a procedure (e.g., nc_rename_var()) in terms of HDF function calls (e.g., HDF5Lmove()) manifests an error or inconsistent state within the HDF5 layer. This often occurs during renaming operations (https://github.com/Unidata/netcdf-c/issues/597). 4) Attempting to compress or decompress a netCDF4 dataset with a non-standard (i.e., non-DEFLATE) filter when the requisite shared library to encode/decode that compression filter is not present in either the default location (/usr/local/hdf5/lib/plugin) or in the user-configurable location referred to by the HDF5_PLUGIN_PATH environment variable. One can determine if missing plugin libraries are the culprit by dumping the hidden attributes of the dataset with, e.g., ncks --hdn -m in.nc or ncdump -s -h in.nc. Any variables with (hidden) &quot;_Filter&quot; attributes require the corresponding shared libraries to be located in HDF5_PLUGIN_PATH. Some HDF5 implementations (at least MacOSX with MacPorts as of 20200907) may also require explicitly setting the plugin path in the environment, even for the default location! To test this, re-try your NCO command after doing this: &quot;export HDF5_PLUGIN_PATH=/usr/local/hdf5/lib/plugin&quot;. 5) Bad vibes.<br>nco_err_exit(): ERROR Short NCO-generated message (usually name of function that triggered error): nco_rename_dim()<br>nco_err_exit(): ERROR Error code is -101. Translation into English with nc_strerror(-101) is &quot;NetCDF: HDF error&quot;<br>nco_err_exit(): ERROR NCO will now exit with system call exit(EXIT_FAILURE)<br></code></pre></td></tr></table></figure>

    <div class="fold">
      <div class="fold-title fold-info collapsed" data-toggle="collapse" href="#collapse-0994800d" role="button" aria-expanded="false" aria-controls="collapse-0994800d">
        <div class="fold-arrow">▶</div>rename_dim.py
      </div>
      <div class="fold-collapse collapse" id="collapse-0994800d">
        <div class="fold-content">
          <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> xarray <span class="hljs-keyword">as</span> xr<br><span class="hljs-keyword">import</span> os<br><br><span class="hljs-comment"># --- Configuration ---</span><br>input_file = <span class="hljs-string">&#x27;new_ERA5_scorecard_clim_1990_2020.nc&#x27;</span><br>output_file = <span class="hljs-string">&#x27;test.nc&#x27;</span><br>old_dim_name = <span class="hljs-string">&#x27;time&#x27;</span><br>new_dim_name = <span class="hljs-string">&#x27;dayofyear&#x27;</span><br><br><span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;Starting dimension rename: &#x27;<span class="hljs-subst">&#123;old_dim_name&#125;</span>&#x27; -&gt; &#x27;<span class="hljs-subst">&#123;new_dim_name&#125;</span>&#x27;&quot;</span>)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;-&quot;</span> * <span class="hljs-number">30</span>)<br><br><span class="hljs-keyword">try</span>:<br>    <span class="hljs-comment"># 1. Load the NetCDF file into an xarray Dataset</span><br>    ds = xr.open_dataset(input_file)<br>    <br>    <span class="hljs-comment"># 2. Rename the dimension</span><br>    <span class="hljs-comment"># The rename_dims method handles the dimension itself.</span><br>    ds_renamed = ds.rename_dims(&#123;old_dim_name: new_dim_name&#125;)<br>    <br>    <span class="hljs-comment"># 3. Rename the associated coordinate variable (if it exists)</span><br>    <span class="hljs-comment"># This step is crucial because the coordinate variable often shares the dimension name.</span><br>    <span class="hljs-keyword">if</span> old_dim_name <span class="hljs-keyword">in</span> ds_renamed.coords:<br>        ds_renamed = ds_renamed.rename(&#123;old_dim_name: new_dim_name&#125;)<br>    <br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;Original dimensions: <span class="hljs-subst">&#123;<span class="hljs-built_in">list</span>(ds.dims)&#125;</span>&quot;</span>)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;Renamed dimensions: <span class="hljs-subst">&#123;<span class="hljs-built_in">list</span>(ds_renamed.dims)&#125;</span>&quot;</span>)<br><br>    <span class="hljs-comment"># 4. Save the modified Dataset to the new NetCDF file</span><br>    ds_renamed.to_netcdf(output_file)<br>    <br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;-&quot;</span> * <span class="hljs-number">30</span>)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;✅ Success! Dimension &#x27;<span class="hljs-subst">&#123;old_dim_name&#125;</span>&#x27; has been renamed to &#x27;<span class="hljs-subst">&#123;new_dim_name&#125;</span>&#x27;.&quot;</span>)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;New file saved as: <span class="hljs-subst">&#123;output_file&#125;</span>&quot;</span>)<br>    <br><span class="hljs-keyword">except</span> FileNotFoundError:<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;❌ Error: Input file &#x27;<span class="hljs-subst">&#123;input_file&#125;</span>&#x27; not found.&quot;</span>)<br><span class="hljs-keyword">except</span> ValueError <span class="hljs-keyword">as</span> e:<br>    <span class="hljs-comment"># Catches the error if the dimension is not found or already has the new name</span><br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;❌ An error occurred during renaming: <span class="hljs-subst">&#123;e&#125;</span>&quot;</span>)<br><span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;❌ An unexpected error occurred: <span class="hljs-subst">&#123;e&#125;</span>&quot;</span>)<br></code></pre></td></tr></table></figure>
        </div>
      </div>
    </div>
<p>But, if <code>An error occurred during renaming: Cannot rename time to dayofyear because dayofyear already exists. Try using swap_dims instead.</code></p>
<p>It means you have two distinct entities in your xarray Dataset with the name dayofyear:</p>
<ul>
<li>A data variable (or possibly a coordinate variable) named dayofyear already exists.</li>
<li>You are trying to rename the dimension/coordinate variable currently called time to dayofyear.</li>
</ul>

    <div class="fold">
      <div class="fold-title fold-info collapsed" data-toggle="collapse" href="#collapse-5a8c6cc0" role="button" aria-expanded="false" aria-controls="collapse-5a8c6cc0">
        <div class="fold-arrow">▶</div>rename_dim_swap.py
      </div>
      <div class="fold-collapse collapse" id="collapse-5a8c6cc0">
        <div class="fold-content">
          <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> xarray <span class="hljs-keyword">as</span> xr<br><span class="hljs-keyword">import</span> os<br><br>input_file = <span class="hljs-string">&#x27;new_ERA5_scorecard_clim_1990_2020.nc&#x27;</span><br>output_file = <span class="hljs-string">&#x27;test_swapped.nc&#x27;</span><br><br><span class="hljs-keyword">try</span>:<br>    <span class="hljs-comment"># 1. Load the NetCDF file</span><br>    ds = xr.open_dataset(input_file)<br>    <br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;Original Dimensions: <span class="hljs-subst">&#123;<span class="hljs-built_in">list</span>(ds.dims)&#125;</span>&quot;</span>)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;Original Coordinates: <span class="hljs-subst">&#123;<span class="hljs-built_in">list</span>(ds.coords)&#125;</span>&quot;</span>)<br><br>    <span class="hljs-comment"># 2. Swap the dimension &#x27;time&#x27; with the variable &#x27;dayofyear&#x27;</span><br>    <span class="hljs-comment"># This promotes the &#x27;dayofyear&#x27; variable to a dimension/coordinate</span><br>    <span class="hljs-comment"># and demotes the original &#x27;time&#x27; coordinate variable.</span><br>    ds_swapped = ds.swap_dims(&#123;<span class="hljs-string">&#x27;time&#x27;</span>: <span class="hljs-string">&#x27;dayofyear&#x27;</span>&#125;)<br>    <br>    <span class="hljs-comment"># 3. (Optional) Drop the original &#x27;time&#x27; coordinate variable if not needed</span><br>    <span class="hljs-comment"># ds_swapped = ds_swapped.drop_vars(&#x27;time&#x27;) </span><br>    <br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;\nSwapped Dimensions: <span class="hljs-subst">&#123;<span class="hljs-built_in">list</span>(ds_swapped.dims)&#125;</span>&quot;</span>)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;Swapped Coordinates: <span class="hljs-subst">&#123;<span class="hljs-built_in">list</span>(ds_swapped.coords)&#125;</span>&quot;</span>)<br><br>    <span class="hljs-comment"># 4. Save the modified Dataset</span><br>    ds_swapped.to_netcdf(output_file)<br>    <br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;\n✅ Success! Dimension &#x27;time&#x27; replaced by &#x27;dayofyear&#x27;.&quot;</span>)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;New file saved as: <span class="hljs-subst">&#123;output_file&#125;</span>&quot;</span>)<br>    <br><span class="hljs-keyword">except</span> FileNotFoundError:<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;❌ Error: Input file &#x27;<span class="hljs-subst">&#123;input_file&#125;</span>&#x27; not found.&quot;</span>)<br><span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;❌ An error occurred during processing: <span class="hljs-subst">&#123;e&#125;</span>&quot;</span>)<br></code></pre></td></tr></table></figure>
        </div>
      </div>
    </div>
<h1 id="optional-int-to-float">(Optional) int to float</h1>
<ul>
<li><code>int to float</code> or <code>float to int</code></li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh">ncap2 -O -s <span class="hljs-string">&#x27;dayofyear=double(dayofyear)&#x27;</span> input.nc output.nc<br>ncap2 -O -s <span class="hljs-string">&#x27;dayofyear=int(dayofyear);level=int(level)&#x27;</span> input.nc output.nc<br></code></pre></td></tr></table></figure>
<h1 id="optional-remove-var-time-and-dim-time">(Optional) Remove var "time" and dim "time"</h1>
<ul>
<li>how to remove a variable "time" first and then remove the dimension "time" from nc file?</li>
</ul>

    <div class="fold">
      <div class="fold-title fold-info collapsed" data-toggle="collapse" href="#collapse-639614a5" role="button" aria-expanded="false" aria-controls="collapse-639614a5">
        <div class="fold-arrow">▶</div>remove_var_dim.py
      </div>
      <div class="fold-collapse collapse" id="collapse-639614a5">
        <div class="fold-content">
          <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> xarray <span class="hljs-keyword">as</span> xr<br><br>input_file = <span class="hljs-string">&#x27;input.nc&#x27;</span><br>output_file = <span class="hljs-string">&#x27;output.nc&#x27;</span><br><br><span class="hljs-keyword">try</span>:<br>    <span class="hljs-comment"># 1. Load the NetCDF file</span><br>    ds = xr.open_dataset(input_file)<br>    <br>    <span class="hljs-comment"># 2. Remove the variable &#x27;time&#x27;</span><br>    <span class="hljs-comment"># This removes the variable that holds the time values/metadata.</span><br>    ds_no_var = ds.drop_vars(<span class="hljs-string">&#x27;time&#x27;</span>)<br>    <br>    <span class="hljs-comment"># 3. Remove the dimension &#x27;time&#x27;</span><br>    <span class="hljs-comment"># The drop_dims method removes a dimension. This only works if no</span><br>    <span class="hljs-comment"># other variables in the dataset are indexed by &#x27;time&#x27;.</span><br>    ds_final = ds_no_var.drop_dims(<span class="hljs-string">&#x27;time&#x27;</span>)<br><br>    <span class="hljs-comment"># 4. Save the modified Dataset</span><br>    ds_final.to_netcdf(output_file)<br>    <br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;✅ Variable and dimension &#x27;time&#x27; successfully removed. File saved as: <span class="hljs-subst">&#123;output_file&#125;</span>&quot;</span>)<br><br><span class="hljs-keyword">except</span> ValueError <span class="hljs-keyword">as</span> e:<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;❌ Error during dimension removal. Check if other variables still depend on &#x27;time&#x27;: <span class="hljs-subst">&#123;e&#125;</span>&quot;</span>)<br><span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;❌ An unexpected error occurred: <span class="hljs-subst">&#123;e&#125;</span>&quot;</span>)<br></code></pre></td></tr></table></figure>
        </div>
      </div>
    </div>
<h1 id="references">References</h1>
<ol type="1">
<li><a target="_blank" rel="noopener" href="https://journals.ametsoc.org/view/journals/clim/5/11/1520-0442_1992_005_1346_tsoere_2_0_co_2.pdf">Déqué, M. I. C. H. E. L., &amp; Royer, J. F. (1992). The skill of extended-range extratropical winter dynamical forecasts. Journal of climate, 5(11), 1346-1356.</a></li>
<li><a target="_blank" rel="noopener" href="https://www2.mmm.ucar.edu/wrf/users/tutorial/presentation_pdfs/201601/met.pdf"><strong>Model Evaluation Tools | UCAR</strong></a></li>
<li><a target="_blank" rel="noopener" href="https://www.jma.go.jp/jma/jma-eng/jma-center/nwp/outline2013-nwp/pdf/outline2013_Appendix_A.pdf">outline2013_Appendix_A.pdf | JMA</a></li>
<li><a target="_blank" rel="noopener" href="https://www.callendar.tech/en/post/tutorial-accessing-era5-land-reanalyses-and-calculating-a-climate-normal-with-python">Tutorial: Accessing ERA5-Land reanalyses and calculating a climate normal with Python</a></li>
<li><a target="_blank" rel="noopener" href="https://photino.cwa.gov.tw/rdcweb/lib/cd/cd07mb/MB/PDF/43/No.4/01.pdf">The Ensemble Forecast System of the Central Weather Bureau (1995, gov.tw)</a></li>
</ol>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/NWP/" class="category-chain-item">NWP</a>
  
  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/WRF/" class="print-no-link">#WRF</a>
      
        <a href="/tags/MPAS/" class="print-no-link">#MPAS</a>
      
        <a href="/tags/NWP/" class="print-no-link">#NWP</a>
      
        <a href="/tags/GFS/" class="print-no-link">#GFS</a>
      
        <a href="/tags/FNL/" class="print-no-link">#FNL</a>
      
        <a href="/tags/ERA5/" class="print-no-link">#ERA5</a>
      
        <a href="/tags/IFS/" class="print-no-link">#IFS</a>
      
        <a href="/tags/CMA/" class="print-no-link">#CMA</a>
      
        <a href="/tags/ACC/" class="print-no-link">#ACC</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>NWP | Anomaly Correlation Coefficient (ACC)</div>
      <div>https://waipangsze.github.io/2025/11/24/NWP-Anomaly-Correlation-Coefficient-ACC/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>Author</div>
          <div>wpsze</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>Posted on</div>
          <div>November 24, 2025</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>Updated on</div>
          <div>December 9, 2025</div>
        </div>
      
      
        <div class="license-meta-item">
          <div>Licensed under</div>
          <div>
            
              
              
                <a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - Attribution">
                    <i class="iconfont icon-cc-by"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2025/11/26/NWP-TempestExtremes-feature-detection-tracking-and-analysis/" title="NWP | TempestExtremes | feature detection, tracking, and analysis">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">NWP | TempestExtremes | feature detection, tracking, and analysis</span>
                        <span class="visible-mobile">Previous</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2025/11/10/MPAS-Eddy-dissipation-rate-EDR/" title="MPAS | Eddy dissipation rate (EDR)">
                        <span class="hidden-mobile">MPAS | Eddy dissipation rate (EDR)</span>
                        <span class="visible-mobile">Next</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>Table of Contents</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  


  
  





  <script>
  Fluid.utils.createScript('https://lib.baomitu.com/mermaid/8.14.0/mermaid.min.js', function() {
    mermaid.initialize({"theme":"default"});

    Fluid.utils.listenDOMLoaded(function() {
      Fluid.events.registerRefreshCallback(function() {
        if ('mermaid' in window) {
          mermaid.init();
        }
      });
    });
  });
</script>






<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-9HL36SZ28R"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-9HL36SZ28R');
</script>

    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">Search</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">Keyword</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">

  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
  

  <span id="sitetime"></span>
  <script language=javascript>
    function siteTime(){
      window.setTimeout("siteTime()", 1000);
      var seconds = 1000;
      var minutes = seconds * 60;
      var hours = minutes * 60;
      var days = hours * 24;
      var years = days * 365;
      var today = new Date();
      var todayYear = today.getFullYear();
      var todayMonth = today.getMonth()+1;
      var todayDate = today.getDate();
      var todayHour = today.getHours();
      var todayMinute = today.getMinutes();
      var todaySecond = today.getSeconds();
      /* Date.UTC() -- 返回date对象距世界标准时间(UTC)1970年1月1日午夜之间的毫秒数(时间戳)
      year - 作为date对象的年份，为4位年份值
      month - 0-11之间的整数，做为date对象的月份
      day - 1-31之间的整数，做为date对象的天数
      hours - 0(午夜24点)-23之间的整数，做为date对象的小时数
      minutes - 0-59之间的整数，做为date对象的分钟数
      seconds - 0-59之间的整数，做为date对象的秒数
      microseconds - 0-999之间的整数，做为date对象的毫秒数 */
      var t1 = Date.UTC(2023,04,23,00,00,00); //北京时间2018-2-13 00:00:00
      var t2 = Date.UTC(todayYear,todayMonth,todayDate,todayHour,todayMinute,todaySecond);
      var diff = t2-t1;
      var diffYears = Math.floor(diff/years);
      var diffDays = Math.floor((diff/days)-diffYears*365);
      var diffHours = Math.floor((diff-(diffYears*365+diffDays)*days)/hours);
      var diffMinutes = Math.floor((diff-(diffYears*365+diffDays)*days-diffHours*hours)/minutes);
      var diffSeconds = Math.floor((diff-(diffYears*365+diffDays)*days-diffHours*hours-diffMinutes*minutes)/seconds);
      /*document.getElementById("sitetime").innerHTML=" 已运行"+/*diffYears+" 年 "+*/diffDays+" 天 "+diffHours+" 小时 "+diffMinutes+" 分钟 "+diffSeconds+" 秒";
      document.getElementById("sitetime").innerHTML=" 已運行"+diffYears+" 年 "+diffDays+" 天 ";
    }/*因为建站时间还没有一年，就将之注释掉了。需要的可以取消*/
    siteTime();
  </script>
  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.4/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.20.1/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/5.0.0/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  
      <script>
        if (!window.MathJax) {
          window.MathJax = {
            tex    : {
              inlineMath: { '[+]': [['$', '$']] }
            },
            loader : {
              load: ['ui/lazy']
            },
            options: {
              renderActions: {
                insertedScript: [200, () => {
                  document.querySelectorAll('mjx-container').forEach(node => {
                    let target = node.parentNode;
                    if (target.nodeName.toLowerCase() === 'li') {
                      target.parentNode.classList.add('has-jax');
                    }
                  });
                }, '', false]
              }
            }
          };
        } else {
          MathJax.startup.document.state(0);
          MathJax.texReset();
          MathJax.typeset();
          MathJax.typesetPromise();
        }

        Fluid.events.registerRefreshCallback(function() {
          if ('MathJax' in window && MathJax.startup.document && typeof MathJax.startup.document.state === 'function') {
            MathJax.startup.document.state(0);
            MathJax.texReset();
            MathJax.typeset();
            MathJax.typesetPromise();
          }
        });
      </script>
    

  <script  src="https://lib.baomitu.com/mathjax/3.2.2/es5/tex-mml-chtml.js" ></script>

  <script  src="/js/local-search.js" ></script>

  <script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">Blog works best with JavaScript enabled</div>
  </noscript>
</body>
</html>
