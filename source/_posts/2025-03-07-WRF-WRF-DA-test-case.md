---
layout: post
title: WRF | WRF-DA test case
categories: [WRF]
tags: [MPAS, NWP, WRF, DA, WRFDA]
author: wpsze
date: 2025-03-07 10:50:00
math: true
mathjax: true
mathjax_autoNumber: true
mermaid: true
index_img: https://i.imgur.com/UCC2t0I.png
banner_img: https://i.imgur.com/UCC2t0I.png
---

# 3dvar test case

- Download test data
  - <https://www2.mmm.ucar.edu/wrf/users/wrfda/OnlineTutorial/3dvar/testcase.html>
  
```consle
be  
ob  
rc  
namelist.input.3dvar  
namelist.input.4dvar  
WRFDAV3.9-testdata.tar.gz
```

- **"be"** contains our background error data in a binary file named "`be.dat`". This file must be generated on a case-by-case basis. The utility used to generate background error data is known as "`gen_be`"; instructions on how to use this will be covered in the advanced tutorial.
- **"ob"** contains our observation data. This folder contains many different types of data, but the file we will be using for this basic tutorial is named "`ob.ascii`". This is an ASCII text file, and contains a number of different observation types (including balloon soundings, surface METAR, ships, and buoy observations.
- **"rc"** contains the first guess and boundary files. These files are generated by WPS and WRF; you can find more information in the User's Guide and the WRF/WPS Online Tutorial.

## Error

### This input data is not V4

```log
   This input data is not V4:  OUTPUT FROM REAL_EM V3.9pre#2 PREPROCESSOR
  File name that is causing troubles = fg
   You can try 1) ensure that the input file was created with WRF v4 pre-processors, or
   2) use force_use_old_data=T in the time_control record of the namelist.input file
-------------- FATAL CALLED ---------------
FATAL CALLED FROM FILE:  <stdin>  LINE:     329
 ---- ERROR: The input file appears to be from a pre-v4 version of WRF initialization routines
-------------------------------------------
```

- `2) use force_use_old_data=T in the time_control record of the namelist.input file`

## Output

```sh
mkdir 3dvar
cd 3dvar
cp ../WRFDA/var/test/tutorial/namelist.input .
ln -sf ../WRFDA/run/LANDUSE.TBL
ln -sf ../be/be.dat .
ln -sf ../ob/2008020512/ob.ascii .
ln -sf ../rc/2008020512/wrfinput_d01 ./fg
ln -sf ../WRFDA/var/build/da_wrfvar.exe .

#&wrfvar7
#cv_options=5,
#/

./da_wrfvar.exe >& wrfda.out
```

![](https://i.imgur.com/hijsnEh.png){width=500}

| File                | Details                                                                                                                                                                                       |
|---------------------|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| cost_fn             | Details the various components of the cost function for each outer iteration                                                                                                                  |
| grad_fn             | Details the various components of the gradient function for each outer iteration                                                                                                              |
| gts_omb_oma_01      | Detailed statistics about all observations.                                                                                                                                                   |
| gts_omb_oma_01.0000 | Detailed statistics about the observations used on each processor. For parallel runs, there will be one of these files for each processor used.                                               |
| jo                  | Cost function statistics for each observation type.                                                                                                                                           |
| namelist.output.da  | Those namelist options not specified in the "namelist.input" file will be assigned default values. This file lists ALL namelist options selected for your run, including all default options. |
| qcstat_conv_01      | Details quality control information for each individual variable for each observation type.                                                                                                   |
| rej_obs_conv_01.000 | Lists each rejected observation                                                                                                                                                               |
| statistics          | Lists useful statistics for each observation type                                                                                                                                             |
| **wrfda.out**          | This is the file where you sent WRFDA's standard output. This should contain run-time information, as well as any errors which may have occurred.                                             |
| **wrfvar_output**       | Finally, the most important file! This is the analysis produced by WRFDA in netCDF format.                                                                                                    |

# OBSPROC for 3DVAR

## Running Observation Preprocessor (OBSPROC)

The **OBSPROC** program reads observations in **LITTLE_R format** (a text-based format, in use since the MM5 era). We have provided observations for the tutorial case, but for your own applications, you will have to prepare your own observation files. Please see <http://www2.mmm.ucar.edu/wrf/users/wrfda/download/free_data.html> for the **sources of some freely-available observations**. 

A number of datasets which provide observation data and/or background atmospheric estimates for WRFDA can be downloaded directly from the [CISL Research Data Archive (RDA)](http://rda.ucar.edu/) web site. This page lists several useful datasets from that archive, as well as some other useful data sources. All data sets listed on this page are free for users to download.

- CISL RDA Background datasets
- CISL RDA Observation datasets
- Other radiance datasets

{% gi 6 3-3%}
![](https://i.imgur.com/qwGmXea.png)
![](https://i.imgur.com/U33BnJT.png)
![](https://i.imgur.com/ypKq7EP.png)
![](https://i.imgur.com/9MDx45k.png)
{% endgi%}

```sh
$ ln -s OBS:2025010100 obs.2025010100

$ ls
msfc.tbl -> /home/wpsze/WRF/WRFDA/WRFDA/var/obsproc/msfc.tbl
namelist.obsproc
OBS:2025010100
obs.2025010100 -> OBS:2025010100
obserr.txt -> /home/wpsze/WRF/WRFDA/WRFDA/var/obsproc/obserr.txt
obsproc.exe -> /home/wpsze/WRF/WRFDA/WRFDA/var/obsproc/obsproc.exe*
obsproc.out
prepbufr.gdas.2025010100.nr
run.sh -> ../../../run.sh*
```

## OBSPROC_for_3DVAR

- <https://www2.mmm.ucar.edu/wrf/users/docs/user_guide_v4/v4.4/users_guide_chap6.html#_OBSPROC_for_3DVAR>


OBSPROC requires at least 3 files to run successfully:

- A namelist file (**namelist.obsproc**)
- An observation error file (**obserr.txt**)
  - The files `obserr.txt` and `msfc.tbl` are included in the source code under `var/obsproc`.
- **One or more observation files**
- Optionally, a table for specifying the elevation information for marine observations over the US Great Lakes (msfc.tbl)

```sh
cd WRFDA/var/obsproc
cp namelist.obsproc.3dvar.wrfvar-tut namelist.obsproc
```

-  Edit the namelist file, **namelist.obsproc**, to accommodate your experiments.

If you are running the tutorial case, you should copy or **link** the sample observation file **(ob/2008020512/obs.2008020512)** to the **obsproc** directory. Alternatively, you can edit the namelist variable `obs_gts_filename` to **point to the observation fileâ€™s full path**.

To run **OBSPROC**, type

```sh
./obsproc.exe >& obsproc.out
```

- Once `obsproc.exe` has completed successfully, you will see an observation data file, with the name formatted `obs_gts_YYYY-MM-DD_HH:NN:SS.3DVAR`, in the `obsproc` directory. 
- `obs_gts_2025-01-01_00:00:00.3DVAR` is generated if sucessful
- `ln -s ob.ascii -> obs_gts_2025-01-01_00:00:00.3DVAR`

![](https://i.imgur.com/1TK81jI.png){width=500}

# useful `.ncl`

- the scripts under `WRFDA/var/scripts`