---
layout: post
title: MPAS | FDDA 
categories: [MPAS]
tags: [WRF, MPAS, FDDA, NWP]
author: wpsze
date: 2025-03-13 14:56:00
math: true
mathjax: true
mathjax_autoNumber: true
mermaid: true
index_img: https://i.imgur.com/oOsTWeD.png
banner_img: https://i.imgur.com/oOsTWeD.png
---

# Links

1. [https://mpas-dev.github.io/](https://mpas-dev.github.io/)
2. [/MPAS-Model/releases](https://github.com/MPAS-Dev/MPAS-Model/releases)
3. [MPAS-Atmosphere Users' Guide V4.0](https://www2.mmm.ucar.edu/projects/mpas/mpas_atmosphere_users_guide_4.0.pdf)
4. [MPAS-Atmosphere Users' Guide V5.3](https://www2.mmm.ucar.edu/projects/mpas/mpas_atmosphere_users_guide_5.3.pdf)
5. [MPAS-Atmosphere Users' Guide V6.3](https://www2.mmm.ucar.edu/projects/mpas/mpas_atmosphere_users_guide_6.3.pdf)
6. [MPAS-Atmosphere Users' Guide V7.0](https://www2.mmm.ucar.edu/projects/mpas/mpas_atmosphere_users_guide_7.0.pdf)
7. [MPAS-Atmosphere Users' Guide V8.2.0](https://www2.mmm.ucar.edu/projects/mpas/mpas_atmosphere_users_guide_8.2.0.pdf)
8. [Joint WRF/MPAS Users Workshop 2024](https://www.mmm.ucar.edu/events/133129/agenda)

# References

- [Bullock Jr, O. R., Foroutan, H., Gilliam, R. C., & Herwehe, J. A. (2018). Adding four-dimensional data assimilation by analysis nudging to the Model for Prediction Across Scales–Atmosphere (version 4.0). Geoscientific model development, 11(7), 2897-2922.](https://gmd.copernicus.org/articles/11/2897/2018/gmd-11-2897-2018.pdf)
  - **MPAS-A model source codes used in this study** are available in the Supplement and at <https://doi.org/10.5281/zenodo.1101204>
  - **Run scripts used to prepare FDDA target fields** are also included in the Supplement and at <https://doi.org/10.5281/zenodo.1101204>.
    ```console 
    .
    ├── gmd-11-2897-2018-supplement-title-page.pdf
    ├── Model_code_for_MPAS-A_with_FDDA
    │   ├── MPAS Copyright.txt
    │   ├── MPAS-Release-4.0_plusFDDA.tar.gz
    │   └── README.txt
    └── scripts_for_FDDA_file_preparation
        ├── prepare_FDDA_file_Jan2013.csh
        ├── prepare_FDDA_file_Jul2013.csh
        └── prepare_FDDA_file_README.txt
    ```
{% gi 4 2-2 %}
![](https://i.imgur.com/oOsTWeD.png)
![](https://i.imgur.com/paBdN3Z.png)
![](https://i.imgur.com/bowuno3.png)
![](https://i.imgur.com/8P35WuK.png)
{% endgi %}

# MPAS-Release-4.0_plusFDDA.tar.gz

- <https://doi.org/10.5281/zenodo.1101204>
- ./core_atmosphere/Registry.xml
  ```xml
  <var name="rthfddaten"/>
  <var name="rqvfddaten"/>
  <var name="rufddaten"/>
  <var name="rvfddaten"/>
  <var name="th_fdda_old"/>
  <var name="qv_fdda_old"/>
  <var name="u_fdda_old"/>
  <var name="v_fdda_old"/>
  <var name="th_fdda_new"/>
  <var name="qv_fdda_new"/>
  <var name="u_fdda_new"/>
  <var name="v_fdda_new"/>
  ```

## mpas_stream_manager.F

- MPAS_stream_mgr_get_property

{% fold info @MPAS_stream_mgr_get_property %}
```fortran
    interface MPAS_stream_mgr_get_property
        module procedure MPAS_stream_mgr_get_property_int
        module procedure MPAS_stream_mgr_get_property_char
        module procedure MPAS_stream_mgr_get_property_logical
    end interface
    
    !-----------------------------------------------------------------------
    !  routine MPAS_stream_mgr_get_property_int
    !
    !> \brief Gets a property of a stream in an MPAS stream manager.
    !> \author Michael Duda, Doug Jacobsen
    !> \date   13 June 2014
    !> \details
    !>  Retrieves the value of a stream property within an MPAS stream manager.
    !>  NOTE: This routine does not support streamID regular expressions
    !
    !-----------------------------------------------------------------------
    subroutine MPAS_stream_mgr_get_property_int(manager, streamID, propertyName, propertyValue, direction, ierr)
```
{% endfold %}

## ./core_atmosphere/physics/mpas_atmphys_fdda.F

- Author comments,
  - !>    * Modified to **only require reads of "fdda_new" data arrays**.  **"fdda_old" is initially set to initial conditions**.  At end of FDDA data interval, **"fdda_old" is set to "fdda_new" and updated "fdda_new" data comes from FDDA input stream**. By O. Russell Bullock Jr. (bullock.russell@epa.gov) / 2016-08-30.

and then,

- Assign value

```fortran
 call mpas_pool_get_array(fdda,'qv_fdda_old',qv_fdda_old)
 call mpas_pool_get_array(fdda,'th_fdda_old',th_fdda_old)
 call mpas_pool_get_array(fdda,'u_fdda_old', u_fdda_old )
 call mpas_pool_get_array(fdda,'v_fdda_old', v_fdda_old )
 call mpas_pool_get_array(fdda,'qv_fdda_new',qv_fdda_new)
 call mpas_pool_get_array(fdda,'th_fdda_new',th_fdda_new)
 call mpas_pool_get_array(fdda,'u_fdda_new', u_fdda_new )
 call mpas_pool_get_array(fdda,'v_fdda_new', v_fdda_new )
 call mpas_pool_get_array(tend_physics,'rthfddaten',rthfddaten)
 call mpas_pool_get_array(tend_physics,'rqvfddaten',rqvfddaten)
 call mpas_pool_get_array(tend_physics,'rufddaten' ,rufddaten )
 call mpas_pool_get_array(tend_physics,'rvfddaten' ,rvfddaten )
```

- No need to generate first time step and obtained FDDA value from init.nc
  
```fortran
!check to see if 'old' FDDA target values need to be defined from initial conditions
 if(first_call .and. .not. config_do_restart) then
    qv_fdda_old = qv
    th_fdda_old = theta_m / (1._RKIND + rvrd * qv)
    u_fdda_old = u
    v_fdda_old = v
    first_call = .false.
 endif
```

- define the FDDA target data interval, `tfrac`

```fortran
!calculate time fraction within FDDA target data interval
 tfrac = mod(xtime_s,fdda_int)/fdda_int
```

- take `t_target` as example,

```fortran
    case("analysis")

       DO i=its,ite
       DO k=kts,kte

          theta_p = theta_m(k,i) / (1._RKIND + rvrd * qv(k,i))

          if (fdda_t .and. k.gt.fdda_t_min_layer .and. (fdda_t_in_pbl .or. k.gt.kpbl(i))) then
             t_target = (1.0-tfrac)*th_fdda_old(k,i)+tfrac*th_fdda_new(k,i)
             rthfddaten(k,i) = fdda_t_coef * ( t_target - theta_p )
          else
             rthfddaten(k,i) = 0.
          endif
```

- update **old** by **new** if it is **on the last time step**.
  
```fortran
!check to see if this is the last time step within the current FDDA target data interval and 
!if so, save the current "new" targets as the "old" targets for the next time step
 if(mod(xtime_s+config_dt,fdda_int)/fdda_int .lt. tfrac) then
    th_fdda_old = th_fdda_new
    qv_fdda_old = qv_fdda_new
    u_fdda_old = u_fdda_new
    v_fdda_old = v_fdda_new
 endif

 write(0,*) '--- exit apply_fdda'
```

### Important issue

The value of `fdda_old` is set to `fdda_new`, and the updated `fdda_new` data is obtained from the FDDA input stream. 

At t=0, the `fdda_old` values are sourced from `init.nc`, and an additional data entry is required for `fdda_new`. One straightforward approach is to read the FDDA input file `00.nc` at t=0, which contains data for t=3 (or the next FDDA time) to serve as `fdda_new`.

### For example, 

Take FDDA time interval as 3 hours,

There is no `real` fdda.000.nc that contains FDDA data at t=0.

- t=0, `fdda_old` from init.nc and `fdda_new` from fdda.000.nc that contains FDDA value at t=3.
- t=3, `fdda_old` from fdda.000.nc and `fdda_new` from fdda.003.nc that contains FDDA value at t=6.
- t=6, `fdda_old` from fdda.003.nc and `fdda_new` from fdda.006.nc that contains FDDA value at t=9.
- t=9, `fdda_old` from fdda.006.nc and `fdda_new` from fdda.009.nc that contains FDDA value at t=12.
- ......
- and no final time step FDDA file.

Therefore, we have to prepare the **fdda.ttt.nc** with **ttt + Next FDDA time** !!!

{% note primary %}
**The purpose of this approach is to reduce storage usage.**
{% endnote %}

- The simple way is reading FDDA($t_0$) ad $t=t_0$, and no need to add time shift in code.
- Anothher way is reading FDD($t_{next fdda time}$) at $t=t_0$, and no need to mismatch FDDA files with time shift.

**Which one is better? Up to you. I like the second one la.**

# FDDA schemes

- **'off'**
- **'analysis'**
- **'scaled'**

![](https://i.imgur.com/95PEK3s.png){width=600}

# Obs FDDA?

**Any Observation FDDA in MPAS is in progress? No**

## In WRF,

![](https://i.imgur.com/6WoxlGO.png){width=400}

{% gi 5 2-3 %}
![](https://i.imgur.com/QEy2dUD.png)
![](https://i.imgur.com/S4yz9ta.png)
![](https://i.imgur.com/UOAWjvZ.png)
![](https://i.imgur.com/Zb9u08r.png)
![](https://i.imgur.com/p5JEibM.png)
{% endgi %}

# US-EPA

- [Add 3-D grid analysis nudging FDDA to MPAS-A #995 | Oct 8, 2022](https://github.com/MPAS-Dev/MPAS-Model/pull/995)
  - from `jherwehe:atmosphere/develop-EPA_FDDA`
  - This EPA_FDDA PR will add 3-D grid analysis nudging FDDA to MPAS-A as an option to assist in keeping retrospective simulations dynamically on track to improve evaluation against observations. This FDDA development for MPAS-A (Bullock et al., 2018) nudges temperature, humidity, and wind toward target values and is based on the comparable FDDA feature available in WRF, including MPAS-A versions of many of the WRF FDDA options. Enabling grid analysis nudging FDDA in MPAS-A maintains high fidelity to the reference fields while still conserving mass.
- [Add the Pleim-Xiu (P-X) LSM and FDDA to MPAS-A #1027 | Jan 26, 2023](https://github.com/MPAS-Dev/MPAS-Model/pull/1027)
  - from `jherwehe:atmosphere/develop-EPA_PXLSM_with_FDDA`
  - This EPA_PXLSM_with_FDDA PR will add the Pleim-Xiu land surface model codes ([PR #1025](https://github.com/MPAS-Dev/MPAS-Model/pull/1025)) and the 3-D grid analysis nudging FDDA codes ([PR #995](https://github.com/MPAS-Dev/MPAS-Model/pull/995)) to MPAS-A.
