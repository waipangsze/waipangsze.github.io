---
layout: post
title: "GFS/FNL dataset"
categories: [NWP]
tags: [WRF,WPS,MPAS,IC/BC,GFS,FNL,RDA,NCEP]
author: wpsze
math: true
mathjax: true
mathjax_autoNumber: true
mermaid: true
date: 2023-04-27 15:24:00
index_img: https://rda.ucar.edu/images/ds_logos/gfs4c_452_432.png
banner_img: https://rda.ucar.edu/images/ds_logos/gfs4c_452_432.png
---

# News (2024 July)

**RDA Data Services Unavailable July 30, 2024**

New setup goes to 

<https://waipangsze.github.io/2024/08/16/GFS_FNL_RDA_upgrade/>

# GFS

The Global Forecast System (GFS)[^1] is a National Centers for Environmental Prediction (NCEP) weather forecast model that generates data for dozens of atmospheric and land-soil variables, including temperatures, winds, precipitation, soil moisture, and atmospheric ozone concentration. The system couples four separate models (atmosphere, ocean model, land/soil model, and sea ice) that work together to accurately depict weather conditions.

## Specifications
The GFS[^2] [^3] is run four times a day, producing forecasts up to 16 days in advance. The forecast component uses the Finite Volume Cubed (FV3) model with a resolution of ~13 km, with the atmosphere coupled to the NCEP Global Wave Model. In the vertical, the model is divided into 127 vertical layers. It produces hourly forecast output for the first 120 hours, then 3 hourly for days 5-16. Details on the June 2019 implementation of the initial FV3 version of the GFS (GFSv15) and the March 2021 implementation of GFSv16 can be found in the links listed below. 

## Download
NCEP GFS 0.25 Degree Global Forecast Grids Historical Archive
ds084.1 | DOI: 10.5065/D65D8PWK
> https://rda.ucar.edu/datasets/ds084.1/
> The NCEP operational Global Forecast System analysis and forecast grids are on a 0.25 by 0.25 global latitude longitude grid. Grids include analysis and forecast time steps at a 3 hourly interval from 0 to 240, and a 12 hourly interval from 240 to 384. Model forecast runs occur at 00, 06, 12, and 18 UTC daily.

- https://nomads.ncep.noaa.gov/pub/data/nccf/com/gfs/prod/

```sh
#!/bin/sh
#################################################################
yyyy='2025'
mm='05'
dd='26'
hh='00'
yyyymm=${yyyy}

tmp_dir="${yyyy}${mm}/${yyyy}${mm}${dd}"
mkdir -p ${tmp_dir}
cd ${tmp_dir}
echo "Current ${tmp_dir}"

for gfsfile in $(seq 0 3 3); do # $(seq 0 3 216), Forecast time = 12, 24, 36, 48, 60, 72, 84, 96, 108, 130, 142, 154
	tmp_f3d=$(printf "%03d" ${gfsfile})
	tmp="${yyyy}/${yyyy}${mm}${dd}/"
    tmp_gfs_fname="gfs_${yyyy}${mm}${dd}_0000_0p25_${tmp_f3d}"
	echo "Now, ${tmp} ... "
    
    if [[ ! -f "${tmp_gfs_fname}" ]]; then	
		echo "Downloading ... ${tmp_gfs_fname}"
		# updated:  https://data.rda.ucar.edu/d084001/2025/20250101/gfs.0p25.2025010100.f000.grib2 
		# wget https://nomads.ncep.noaa.gov/pub/data/nccf/com/gfs/prod/gfs.20250526/00/atmos/gfs.t00z.pgrb2.0p25.f000 
		wget https://nomads.ncep.noaa.gov/pub/data/nccf/com/gfs/prod/gfs.${yyyy}${mm}${dd}/${hh}/atmos/gfs.t${hh}z.pgrb2.0p25.f${tmp_f3d} -O ${tmp_gfs_fname} 
	else
	    echo "${tmp_gfs_fname} exists ... "
    fi
done
```

- https://rda.ucar.edu/datasets/ds084.1/

```sh
#!/bin/sh
#################################################################
# Csh Script (wpsze: to sh script) to retrieve 34 online Data files of 'ds084.1',
# total 7.16G. This script uses 'wget' to download data.
#
# Highlight this script by Select All, Copy and Paste it into a file;
# make the file executable and run it on command line.
#
# You need pass in your password as a parameter to execute
# this script; or you can set an environment variable RDAPSWD
# if your Operating System supports it.
#
# Contact rdahelp@ucar.edu (RDA help desk) for further assistance.
#################################################################

wget --no-check-certificate -O \
Authentication.log --save-cookies auth.rda_ucar_edu \
--article-data="email=**xxx@gmail.com**&passwd=**xxx**&action=login" https://rda.ucar.edu/cgi-bin/login

yyyy='2023'
mm='03'
dd='19'
hh='00'
yyyymm=${yyyy}

for gfsfile in $(seq 0 3 12); do # Forecast time = 12, 24, 36, 48, 60, 72, 84, 96, 108, 130, 142, 154
	tmp=$(printf "%03d" ${gfsfile})
	tmp="${yyyy}/${yyyy}${mm}${dd}/gfs.0p25.${yyyy}${mm}${dd}${hh}.f${tmp}.grib2"
	echo ${tmp}
	
	echo "downloading ..."
	wget --no-check-certificate -N --load-cookies auth.rda_ucar_edu https://rda.ucar.edu/data/ds084.1/${tmp}
done
```

## Rename GFS files by soft-link 
If your operational process needs the format of GFS files like as 
> gfs_20170724_0000_0p25_000

```sh
#!/bin/sh

old_gfs=`ls ./*.grib2`

for eachfile in ${old_gfs}
do
   echo ${eachfile}
   echo ${eachfile:11:8}, ${eachfile:19:2}, ${eachfile:23:3}
   echo gfs_${eachfile:11:8}_00${eachfile:19:2}_0p25_${eachfile:23:3}
   ln -s ${eachfile} gfs_${eachfile:11:8}_00${eachfile:19:2}_0p25_${eachfile:23:3}
done
```

## Usage of GFS on WRF/NWP

GFS Data
> https://www2.mmm.ucar.edu/wrf/OnLineTutorial/DATA/GFS/gfs.php
> GFS (Global Forecast System) is a model product from NCEP.
> Type: GRIB1 / GRIB2 data

Resolution:
> 0.25 deg global data
> Output frequency 3 hourly
> 34 pressure levels

Availability:
> From NCAR's RDA site: https://rda.ucar.edu/datasets/ds084.1/

Vtable: **Vtable.GFS**

### namelist.wps
```sh
# Edit namelist.wps
start_date = '2019-11-29_12:00:00',
end_date = '2019-12-01_00:00:00',
interval_seconds = 10800,
prefix = 'FILE',
```

### Script
```sh
# Notes on running UNGRIB for this data
# Examine the GRIB files, e.g.,
# ./util/g2print.exe ../DATA/co_blizzard/gfs.0p25.2019112912.f000.grib2

ln -sf ungrib/Variable_Tables/Vtable.GFS Vtable
./link_grib.csh ../DATA/co_blizzard/gfs.0p25.2019

./ungrib.exe
# This will create an ungrib.log for your records.

# Examine the intermediate files, e.g.,
# ./util/rd_intermediate.exe FILE:2019-11-29_12
# ncl /util/plotfmt_ncl 'filename="FILE:2019-11-29_12"'
```

## Usage of FNL on WRF/NWP
The NCEP FNL (Final) Operational Global Analysis[^4] [^5] [^6] is on 1x1 degree grids are available every six hours. The analyses are from the NCEP Final Analyses (FNL). These were operationally prepared by NCEP, but are available for download from NCAR/RDA.

This product is from the Global Data Assimilation System (GDAS), which continuously collects observational data from the Global Telecommunications System (GTS), and other sources, for many analyses. The FNLs are made with the same model which NCEP uses in the Global Forecast System (GFS), **but the FNLs are prepared about an hour or so after the GFS is initialized. The FNLs are delayed so that more observational data can be used**. *The GFS is run earlier in support of time critical forecast needs, and uses the FNL from the previous 6 hour cycle as part of its initialization*.

FNL数据集和GFS数据集虽有联系，但在同一资料同化和预报系统中却有不同的产品。它们共享相同的基础模型和数据同化技术。它们包含相同的数据源——**但是在gfs和fnl的初始条件中吸收的“真实”数据的数量有细微的差别**。即使有ncep的巨大计算资源，运行一个全球nwp模型也需要时间。因此，他们需要尽早启动gfs来获得预报而不是后报。fnl是最终的分析结果，比gfs稍晚一些，以便能包括所有可用的观测数据。通常，fnl比gfs多摄取约10%的观察结果。虽然开始时间较晚，但仍有足够的时间，因此6小时的fnl6小时预报可作为下一个gfs资料同化周期的背景场例如，如果你想要00z的气球数据，你必须等待气球上升穿过大气层。对于能够到达平流层的大型氦气箱来说，这可能需要多达90分钟。然后气球的数据需要从世界各地传送到美国马里兰州的ncep中心。如果你想要00z的卫星数据，你必须等待卫星经过一个地面站，这样它才能下载数据。地面站然后通过陆地或海底电缆(如果有的话)传送数据，或者通过另一颗(通信)卫星传送数据。[^7]

For further information about the FNL archives at NCAR: See, http://rda.ucar.edu/datasets/ds083.2.

Type: 
> GRIB2 data

Resolution:
> 1deg global data
> Output frequency 6 hourly
> 34 pressure levels

Availability: 
> http://rda.ucar.edu/datasets/ds083.2
> Follow the tab to "Data Access -> Internet Download". You must register (it is free) to access the data.
 
Vtable: **Vtable.GFS**

### namelist.wps
```sh
Edit namelist.wps
start_date = '2019-11-25_12:00:00',
end_date = '2019-11-27_00:00:00',
interval_seconds = 21600,
prefix = 'FILE',
```

### Script
```sh
# Notes on running UNGRIB for this data
# Examine the GRIB files, e.g.,
# ./util/g2print.exe ../DATA/boulder_snow/fnl_20191125_12_00.grib2
ln -sf ungrib/Variable_Tables/Vtable.GFS Vtable

./link_grib.csh ../DATA/boulder_snow/fnl_2019

./ungrib.exe
# This will create an ungrib.log for your records.

# Examine the intermediate files, e.g.,
# ./util/rd_intermediate.exe FILE:2019-11-25_12
# ncl /util/plotfmt.ncl 'filename="FILE:2019-11-25_12"'
```

## Read and Plot grib2 files
```sh
import xarray as xr
ds = xr.open_dataset('./fnl_20191125_12_00.grib2',engine='pynio')
ds
```

# 2019年与2020年GFS资料驱动wrf的差异

- [笔记 | 2019年与2020年GFS资料驱动wrf的差异](https://mp.weixin.qq.com/s/ICJ59yUE2D3UnFlPngZRJA)
  - GFS是美国国家环境预报中心 (NCEP) 运行的全球数值天气预报系统。GFS系统会定期进行版本更新，引入新的物理过程、更高的分辨率、更多垂直层次或改进同化方案等，这些更新可能导致输出资料的格式、包含的变量或垂直层次结构发生变化。
  - GFS v15 版本于2019年6月上线，而 GFS v16 版本于2021年3月上线。因此，2019年的GFS资料主要对应 GFS v15 或之前的版本（取决于具体获取时间），而2020年的资料则主要对应 GFS v16（在v16上线前可能是v15）。WRF的前处理系统（WPS）需要正确识别和处理输入气象资料的格式和变量。GFS版本之间的差异很可能影响了WPS处理不同年份GFS资料所需的配置。特别是GFS v16相较于早期版本，在垂直分辨率等方面有所提升。
  - 2019 GFS 资料处理
    - num_metgrid_levels = 32: 指定了metgrid程序需要处理的垂直层次数量。对于2019年的GFS资料，只能设置为32。
    - sfcp_to_sfcp = .true. 和 use_surface = .true.：作者指出，2019年的GFS资料可能缺乏某些地面或近地面变量，或者其格式使得WPS难以自动识别地面信息。设置这两个参数为.true. 可以强制metgrid使用可用的地面气压（PSFC）等信息进行垂直插值和网格映射，确保地面数据的正确处理。
    - 常见错误：
      - 如果在处理2019年GFS资料时没有添加sfcp_to_sfcp = .true. 和 use_surface = .true.，WPS可能会报错
      - 这个错误提示metgrid在需要使用地面气压（PSFC）时发现sfcp_to_sfcp标志为.false.。这也印证了对于2019年数据，需要明确告诉metgrid如何处理地面气压。
      - 网上有帖子也提到，类似错误有时也可能由其他气象资料（如ECMWF数据）的地面和高空资料间隔不一致引起。
  - 2020年 GFS 资料处理
    - num_metgrid_levels = 34: 对于2020年的GFS资料，WPS期望处理的垂直层次数量为34。这可能了2020年使用的GFS版本（ likely GFS v16 data format）在输出资料中提供了更多的垂直层次。
    - sfcp_to_sfcp 和 use_surface: 这两项在处理2020年GFS资料时需要移除或设置为.false.。这说明2020年的GFS资料格式对于WPS（WRF 4.2.2版本）来说，其地面信息的组织方式使得WPS能够更顺畅地自动处理，不再需要额外的强制设置。
    - 常见错误：
      - 如果在处理2020年GFS资料时仍然沿用2019年的设置（特别是num_metgrid_levels = 32 或保留了sfcp_to_sfcp = .true. 和 use_surface = .true.），可能会遇到以下问题：
        - 层次错误： 如果num_metgrid_levels设置小于资料实际包含的层次，或者与WPS对该版本资料的期望不符，会导致错误。将num_metgrid_levels设置为34与2020年GFS资料的特性相符。
        - 边界条件相关错误： 可能出现 "Maybe this is a global domain, but the polar flag was not set in the bdy_control namelist." 这样的错误。虽然这个错误通常与全球模拟域或极区处理有关，但在本例中，可能是由于错误的数据处理参数（如保留了不必要的sfcp_to_sfcp等）干扰了WPS正确识别数据类型或进行内插，间接导致了与边界条件处理相关的逻辑错误。

# Citations

[^1]: [GFS Data Access](https://www.ncei.noaa.gov/products/weather-climate-models/global-forecast)
[^2]: [GFS home page](https://www.emc.ncep.noaa.gov/emc/pages/numerical_forecast_systems/gfs.php)
[^3]: [Global Models Verification](https://www.emc.ncep.noaa.gov/users/verification/global/)
[^4]: [FNL more](https://rda.ucar.edu/OS/web/datasets/ds083.2/docs/more.html)
[^5]: [GFS vs FNL](https://rda.ucar.edu/OS/web/datasets/ds083.2/docs/FNLvGFS.pdf)
[^6]: [Analysis,	reanalysis,	forecast—what’s	the	difference?](https://rda.ucar.edu/OS/web/datasets/ds083.2/docs/Analysis.pdf)
[^7]: [FNL再分析数据和GFS数据之间的区别和联系](http://www.ihamodel.com/?p=17426)
