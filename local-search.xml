<?xml version="1.0" encoding="utf-8"?>
<search>
  
  
  
  <entry>
    <title>NWP | MPAS | Radar Reflectivity</title>
    <link href="/2025/05/07/NWP-MPAS-Radar-Reflectivity/"/>
    <url>/2025/05/07/NWP-MPAS-Radar-Reflectivity/</url>
    
    <content type="html"><![CDATA[<h1 id="radar-reflectivity雷達回波">Radar Reflectivity(雷達回波)</h1><p>在描述雷達回波圖時，總是避免不了用到一個單位 —— <strong>dBZ</strong> 。</p><p><strong>「dBZ」 是表示雷達回波強度的物理量</strong>，可用來估算降雨和降雪強度及預測諸如冰雹、強風等災害性天氣出現的可能性。一般來說，它的數值越大，降雨、降雪的可能性越大，強度也越強。</p><ul><li>當回波強度<strong>大於或等於40dBZ</strong>時，出現雷雨天氣的可能性較大；</li><li><strong>當它的值在45dBZ或以上</strong>時，出現暴雨、冰雹、強風等強烈對流天氣的可能性較大。</li></ul><p>當然，判斷具體出現什麼天氣時，除了回波強度（dBZ）外，還要綜合考慮回波高度、回波面積、回波移動速度和方向以及演變情況等因素。 <strong>「Z」是雷達反射因子</strong>，與雨滴譜直徑的六次方成正比，單位是 <span class="math inline">\(mm^6/m^3\)</span> ；「dB」是分貝（decibel的縮寫），也可以理解為一個運算符號，<strong>dBZ和Z的換算關係是：dBZ　＝10log（Z）</strong> 。</p><h2 id="雷達反射率因子z值">雷達反射率因子Z值</h2><p>雷達反射率因子Z值的大小，<strong>只取決於雲、雨滴譜</strong>的情況，反映了氣象目標內部降水粒子的尺度和數密度，常用來表示氣象目標的強度。</p><ul><li>Z值既可透過<strong>雲霧物理觀測的方法求得</strong>，</li><li>也可以透過<strong>雷達氣象方程式推算</strong>出來。</li></ul><p>Z和粒子直徑的6次方成正比，顯示少數大水滴將提供散射回波功率的絕大部分。由於<strong>雷達反射率因子 Z 只取決於氣象目標本身而與雷達參數和距離無關</strong>，所以不同參數的雷達測得的值可以互相比較。</p><h2 id="radar-bands">Radar Bands</h2><p>Weather watch meteorological radars operate within the microwave region of the electromagnetic spectrum (around 1 – 100 GHz), though there are meteorological applications for radars outside the microwave region as shown in the table.</p><p><strong>The most commonly used radars for weather surveillance are in the 5 and 10 cm wavelengths (around 6 and 3 GHz resp.)</strong></p><ul><li>The part of the spectrum <strong>near 10cm wavelength is commonly called "S" band</strong>, and</li><li>the part <strong>around 5cm wavelength is called "C" band</strong>.</li></ul><p>Radar systems are also commercially available at <strong>X band (~3cm wavelength) that are typically used on ships, boats and aircraft</strong>. These radars are more compact because of the smaller antenna size, but suffer more from attenuation in anything over moderate precipitation.</p><figure><img src="https://i.imgur.com/qlXeo9X.png" alt="Radar band frequencies and wavelengths" width="400" /><figcaption>Radar band frequencies and wavelengths</figcaption></figure><h1 id="hko-educational-resources">HKO Educational Resources</h1><ul><li><a href="https://www.hko.gov.hk/tc/education/meteorological-instruments/weather-radar/00192-weather-radar-observations-in-hong-kong.html">天氣雷達觀測 | HKO</a><ul><li>RADAR (雷達)一詞是 RAdio Detection And Ranging 的縮寫，意思是以無線電波探測及測距。雷達發明於二次世界大戰前夕，最初用於軍事上。其後雷達應用涵蓋多個領域，其中一項重要的用途是天氣監察。透過探測大氣中的雨點，天氣雷達能非常有效地監察在香港出現的惡劣天氣，例如熱帶氣旋、雷暴和大雨。</li><li>雷達不停發出微波脈沖，經大氣中的雨點反射，通過量度這些反射回來的訊號，就能探測到大氣中的降雨。一般來說，<strong>反射回來的訊號越強，雨勢就越大</strong>。至於<strong>雨區與雷達之間的距離</strong>，則可利用微波往返雨區所需的時間而計算出來。</li><li>近年來多普勒天氣雷達越趨普及，它能夠量度<strong>雨點移近(或遠離)雷達的速度</strong>。<ul><li><img src="https://www.hko.gov.hk/tc/education/images/fig_00192_radmetc2.jpg" width="400" /></li><li><img src="https://i.imgur.com/OzcuZ10.png" width="400" /></li></ul></li></ul></li><li><a href="https://www.hko.gov.hk/tc/wxinfo/radars/radar_gallery/index.htm"><strong>天文台的雷達圖像廊</strong></a><ul><li><strong>圖像廊搜羅了在惡劣天氣下所拍攝到的雷達圖像，如熱帶氣旋、暴雨、雹暴及雷暴。</strong></li></ul></li><li><a href="https://www.hko.gov.hk/tc/education/meteorological-instruments/weather-radar/00188-on-terminal-doppler-weather-radar.html">淺談機場多普勒天氣雷達（TDWR） | 2012 | HKO</a><ul><li><strong>機場多普勒天氣雷達的任務是探測機場範圍的低空風切變</strong>，相比主要用來探測雨區發展和移動的天氣雷達其技術更為先進。<strong>機場多普勒天氣雷達利用多普勒原理，探測雷達方向的徑向風速。</strong></li><li>微下擊暴流的生命週期短，一般只維持約數分鐘。在雷暴活躍期間，雷達須作頻密掃描，以捕捉雷暴區氣流的急速變化。<ul><li><img src="https://www.hko.gov.hk/tc/education/images/fig_00188_TDWR_1.jpg" width="400" /></li><li><img src="https://www.hko.gov.hk/tc/education/images/fig_00188_TDWR_2c.jpg" width="400" /></li></ul></li></ul></li><li><a href="https://www.hko.gov.hk/tc/education/meteorological-instruments/weather-radar/00187-extraordinary-lightning-protection-system-for-weather-radar-stations.html">天氣雷達站的非一般避雷系統 | 2013 | HKO</a><ul><li><strong>天文台一直遵守天氣雷達站避雷接地電阻必須不多於1歐姆的嚴格要求</strong>，以儘量減低受雷擊而影響雷達運作的機會。除了香港天文台，國際上也採用同等標準規範天氣雷達站的設計，世界氣象組織(WMO)轄下的儀器和觀測方法委員會(CIMO)在其IOM第88號報告[3]中便指出了這項要求。</li></ul></li><li><a href="https://www.hko.gov.hk/tc/education/meteorological-instruments/weather-radar/00458-profiling-rain-areas-using-radar.html">利用雷達探測雨區的形相態 | 2015 | HKO</a><ul><li>天文台於2015年啟用新的<strong>大老山雙偏振多普勒雷達</strong>（圖二）。跟傳統的單偏振（電磁波的電場或磁場在單一平面上變化）雷達不同，新雷達能夠發射及<strong>接收水平和垂直兩個不同偏振方向的電磁波脈沖</strong>（圖三）。由於水滴的大小和冰的形態會導致不同偏振電磁波反射後的特性出現差異，利用水平和垂直偏振回波特性的差別，有助於判斷雨區的成分，以及雨量的多少。</li></ul></li><li><a href="https://www.hko.gov.hk/tc/education/meteorological-instruments/weather-radar/00522-how-to-interpret-velocity-field-from-doppler-weather-radar.html">如何解讀多普勒天氣雷達的風場 | 2019 | HKO</a><ul><li>由於雨點會被風帶動，所以這是一個估算風速值頗好的方法。可是，<strong>必須注意的是此速度是沿著雷達波束方向的風的分量，即徑向風速</strong>。若風與雷達波束平行，徑向風速的值與真實風速相等，若風與雷達波束成垂直方向，徑向風速的值會變為零。徑向風速為零的線稱為零徑速線。</li></ul></li><li><a href="https://www.hko.gov.hk/tc/education/weather/weather-phenomena/00550-hail-and-hook-echo.html">冰雹與鈎狀回波 | 2020 | HKO</a><ul><li>冰雹是強雷暴中產生的大冰粒。強雷暴出現時，大氣的垂直運動十分猛烈。由於大氣對流層的温度一般隨高度增加而下降，當較暖濕空氣上升時，空氣中的水分會遇冷凝結。<strong>由於上升氣流猛烈，水汽會被帶到凍結層以上並不斷打滾，凝結成冰粒。打滾過程冰粒不斷吸收水分，像＂雪球＂般越滾越大，最後當上升氣流不能再承托冰粒重量時，這些超重的冰粒便會跌落地面，形成落雹</strong>[1]（圖二）。<ul><li><img src="https://www.hko.gov.hk/tc/education/weather/weather-phenomena/images/fig_00550-Fig2_hailprocess.png" alt="圖二 強雷暴引致落雹的過程。" width="400" /></li></ul></li><li>天氣雷達是天文台監測冰雹的主要工具，雷達圖所顯示的回波反射率及其形狀為識別冰雹提供了重要線索。冰雹形成於強雷暴中，在雷達圖中除了有很強的回波反射率外，有時甚至會出現一種呈＂鈎＂狀的回波結構，稱為「鈎狀回波」，如2014年3月30日晚上的<strong>雷達圖便出現了清晰可見的鈎狀回波特徵</strong>（圖三）。<ul><li><img src="https://www.hko.gov.hk/tc/education/weather/weather-phenomena/images/fig_00550-Fig3_radar.png" /></li></ul></li></ul></li><li><a href="https://www.hko.gov.hk/tc/education/meteorological-instruments/weather-radar/00689-application-of-phased-array-weather-radar-in-monitoring-inclement-weather.html">應用相控陣天氣雷達監測惡劣天氣 | 2023 | HKO</a><ul><li>「相控陣天氣雷達」(Phased Array Weather Radar (PAWR)) 是「相位控制陣列天氣雷達」的簡稱，它由眾多獨立控制的小型天線收發單元組成，並排列成天線陣面，<strong>通過控制各單元發射無線電波的相位差來改變雷達波束的發射方向</strong>。相控陣雷達的優點是體積細小，可同時發射多個波束，利用機械及電子掃描方法在最短1分鐘內完成分層最高達68層的立體掃描，比現有的大帽山及大老山天氣雷達分別6分鐘和12層的掃描加密達5至6倍，可提供時間和空間上更高解像度的雷達圖像，幫助監測快速演變的中尺度惡劣天氣，如局地暴雨、冰雹和龍捲風等。</li><li>天文台位於大欖角的機場多普勒天氣雷達於2018年8月29日早上成功偵察到一個在馬灣附近發展的<strong>水龍捲</strong>。</li></ul></li><li><a href="https://www.hko.gov.hk/tc/%E6%9C%80%E6%96%B0%E6%B6%88%E6%81%AF/108809/%E3%80%8E%E6%B0%A3%E8%B1%A1%E5%86%B7%E7%9F%A5%E8%AD%98%E3%80%8F%EF%BC%9A%E6%96%B0%E5%A4%A7%E5%B8%BD%E5%B1%B1%E5%A4%A9%E6%B0%A3%E9%9B%B7%E9%81%94">『氣象冷知識』：新大帽山天氣雷達 | 2024 | HKO</a><ul><li>自1999年起服務香港24年的大帽山天氣雷達已於去年底退役，<strong>並於今年換上更先進的雙偏振S波段多普勒天氣雷達</strong>。新雷達的安裝過程橫跨冬、春二季，天文台同事及工作人員從零下兩度的寒風，到潮濕大霧的春天，均日以繼夜緊守全港最高山峰辛勤工作，最終成功在雨季來臨前完成安裝新雷達，支援天文台監測惡劣天氣。最新一集『氣象冷知識』會帶大家前往大帽山雷達重地，由科學主任和雷達機械師揭開新雷達安裝的難忘歷程。</li><li><strong>香港天文台新大帽山天氣雷達已於2024年3月完成安裝，並正式投入業務運作</strong>，提供重要的觀測數據監測各類惡劣天氣，包括雷暴、暴雨和熱帶氣旋。<strong>新雷達是香港第二台雙偏振 S 波段多普勒天氣雷達</strong>，可更精確監測冰雹和降雨率，並配備更先進的硬件和軟件，提供更高質量的雷達產品以支援天氣分析。新雷達與大老山雷達24 小時全天候協同運作來監測惡劣天氣。</li><li><iframe width="560" height="315" src="https://www.youtube.com/embed/5fthr7X0mik" title="新大帽山天氣雷達" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen></iframe></li></ul></li><li><a href="https://www.hko.gov.hk/tc/education/meteorological-instruments/weather-radar/00729-Phased-Array-Weather-Radar-and-Low-Altitude-Weather.html">相控陣天氣雷達與低空天氣 | 2025 | HKO</a><ul><li><strong>天文台於2021年在沙螺灣設置了一台相控陣天氣雷達 (Phased Array Weather Radar (PAWR))</strong>，經過3年多的運作，證實能有效探測對本港具高影響的惡劣天氣，為未來籌建掃描範圍覆蓋全港的相控陣天氣雷達網絡打下堅實的科學基礎。</li><li>沙螺灣相控陣天氣雷達可在<strong>一分鐘內完成最高達68層的立體掃描，並提供空間解像度低至30米</strong>的雷達圖像。相比之下，天文台兩台分別在<strong>大帽山和大老山的長程雷達需6分鐘完成12層立體掃描，雷達圖像空間解像度為150米</strong>。</li><li>相比大帽山和大老山的長程天氣雷達，相控陣天氣雷達可以六分之一的時間及五倍的解像度完成對大氣的立體掃描，能有效捕捉快速變化的惡劣天氣如龍捲風、冰雹、強烈雷暴及其引發的強陣風。</li></ul></li></ul><h2 id="課程">課程</h2><ul><li><a href="https://www.hko.gov.hk/en/education/edu03course/coursenotes/files/radar_satellite_notes.pdf">天氣雷達及衛星圖像基礎講座.pdf</a></li><li><a href="https://www.hko.gov.hk/en/wxinfo/radars/radar_gallery/files/Radar-50years.pdf">香港天氣雷達觀測五十周年紀念 | 1959-2009</a><ul><li><img src="https://i.imgur.com/jHCknCO.png" width="300" /></li></ul></li><li><a href="https://www.meteam.org/lecture/tutors/tutor(v1).pdf">氣象章課程 – 教導組（童軍支部）</a></li></ul><h2 id="hko-reprint">HKO Reprint</h2><ul><li><a href="https://www.hko.gov.hk/en/publica/reprint/files/r523.pdf">多普勒激光雷達在香港國際機場的應用 | 2023</a></li><li><a href="https://www.hko.gov.hk/en/publica/reprint/files/r774.pdf">Dual Doppler radar analysis of 3-dimensional winds for heavy rain events in southern China | 2008</a></li><li><a href="https://www.hko.gov.hk/hko/publica/reprint/r1339.pdf">利用 S 波段遠程天氣雷達作快速掃描監測暴雨及熱帶氣旋發展之初探 | 2018 年 1 月</a></li><li><a href="https://www.hko.gov.hk/hko/publica/reprint/r1357.pdf">利用大帽山天氣雷達快速掃瞄資料進行對流尺度循環集合同化 | 2019</a></li><li><a href="https://www.hko.gov.hk/tc/aviat/articles/files/17th_gd_hk_macao_article_2.pdf">多普勒激光雷達在熱帶氣旋方面的觀測</a></li><li><a href="https://www.hko.gov.hk/hko/publica/reprint/r368.pdf">REMOTE-SENSING THE WEATHER TO SUPPORT THE HONG KONG AIRPORT</a></li><li><a href="https://www.ecmwf.int/sites/default/files/elibrary/2009/15178-hong-kong-observatorys-operational-data-management-systems.pdf">The Hong Kong Observatory’s Operational Data Management Systems | 2009</a></li></ul><h2 id="hko-observations">HKO Observations</h2><ul><li><a href="https://www.hko.gov.hk/tc/wxinfo/radars/radar_range1.htm">HKO | 天氣雷達圖像 (64 公里範圍, 3 公里高)</a></li><li><a href="https://envf.ust.hk/dataview/hko_radar/current/">Radar Images from Hong Kong Observatory | HKUST</a></li></ul><h2 id="hko-literature-review">HKO Literature Review</h2><ul><li><a href="https://www.mdpi.com/2076-3417/15/4/2223">Chan Y-w, Chan P-w, Cheung P. Observation of Downburst Associated with Intense Thunderstorms Encountered by an Aircraft at Hong Kong International Airport. Applied Sciences. 2025; 15(4):2223. https://doi.org/10.3390/app15042223</a><ul><li>Three-dimensional wind field retrieval has been conducted from the radars, and the wind data so obtained are compared with the vertical velocity and eddy dissipation rate measured onboard the aircraft during the encountering of two <strong>microbursts</strong>.</li><li><div class="group-image-container"><div class="group-image-row"><div class="group-image-wrap"><img src="https://i.imgur.com/L1m8XkL.png" /></div><div class="group-image-wrap"><img src="https://i.imgur.com/PV1XcQV.png" /></div><div class="group-image-wrap"><img src="https://i.imgur.com/xjC2wWn.png" /></div></div><div class="group-image-row"></div></div></li></ul></li><li><a href="http://www.iapjournals.ac.cn/aas/article/doi/10.1007/s00376-024-3286-8">Yang, Z. W., P. W. Chan, Y. W. Chan, K. Zhao, H. Q. Chen, C. R. Chen, and Y. Y. Xu, 2025: Application of three-dimensional wind fields and dual-polarization signals of an X-band Phased Array Weather Radar in diagnosing vertical motion and cloud electrification in convective storms. Adv. Atmos. Sci., 42(5), 968−980, https://doi.org/10.1007/s00376-024-3286-8.</a><ul><li><strong>香港天文台于2021年在沙螺湾 (Sha Lo Wan (SLW)) 气流剖析仪站部署了一部X波段相控阵天气雷达 (X-band dual-polarization Phased Array Weather Radar (PAWR) )</strong>，以提升对香港高影响天气的监测能力。该相控阵雷达具备快速立体扫描能力，<strong>可在1分钟内完成对目标区域的扫描，空间分辨率达到30米</strong>。本研究利用沙螺湾相控阵雷达所提供的双偏振参数，包括差分反射率(<span class="math inline">\(Z_{DR}\)</span>) 、差传播相位常数（<span class="math inline">\(K_{DP}\)</span>) 及粒子相态分类产品，结合数据变分同化技术构建的三维风场，对<strong>中尺度对流风暴的垂直运动和闪电特性进行了深入分析</strong>，并验证沙螺湾相控阵雷达的观测数据。本研究选取分别发生在2022年9月18日及2023年6月17日的两个中尺度对流风暴事件作为研究个例。</li><li>In addition to the <strong>SLW PAWR</strong>, <strong>HKO’s S-band radars at Tai Mo Shan (TMS) and Tate’s Cairn (TC)</strong>, as well as the <strong>C-band Terminal Doppler Weather Radar (TDWR) at Brothers Point (BP)</strong> and the dense automatic weather station (AWS) network operated by HKO are used for analysis in the aforementioned <strong>two mesoscale convective storms (MCS) cases</strong>.<ul><li><img src="https://i.imgur.com/L1m8XkL.png" width="400" /></li><li><img src="https://i.imgur.com/o6Dh12x.png" width="400" /></li></ul></li></ul></li></ul><h1 id="wrf">WRF</h1><h2 id="wrf_dbz">wrf_dbz</h2><p>Calculates simulated equivalent radar reflectivity factor [dBZ] from WRF model output. <a href="https://www.ncl.ucar.edu/Document/Functions/Built-in/wrf_dbz.shtml">link</a></p><p>This function computes equivalent reflectivity factor [dBZ] at each model grid point assuming spherical particles of constant density, with exponential size distributions. This function is based on <strong>“dbzcalc.f” in RIP</strong>.</p><ul><li><code>dbz = wrf_user_getvar(a,"dbz",-1)</code> ; calculate dbz for all times in file</li><li><code>mdbz = wrf_user_getvar(a,"mdbz",-1)</code> ; calculate max dbz for all times in file</li></ul><h1 id="mpas">MPAS</h1><ul><li><a href="https://github.com/MPAS-Dev/MPAS-Model/blob/41e9a3fb8ca6b9250a7405209a5c60996318409f/src/core_atmosphere/physics/mpas_atmphys_driver_microphysics.F#L656">src/core_atmosphere/physics/mpas_atmphys_driver_microphysics.F#L656</a></li></ul><figure class="highlight fortran"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><code class="hljs fortran"><span class="hljs-comment">!MPAS driver for parameterization of cloud microphysics processes.</span><br><span class="hljs-comment">!Laura D. Fowler (send comments to laura@ucar.edu).</span><br><span class="hljs-comment">!2013-05-01.</span><br><span class="hljs-comment">!</span><br><span class="hljs-comment">! subroutines in mpas_atmphys_driver_microphysics:</span><br><span class="hljs-comment">! ------------------------------------------------</span><br><span class="hljs-comment">! allocate_microphysics     : allocate local arrays for parameterization of cloud microphysics.</span><br><span class="hljs-comment">! deallocate_microphysics   : deallocate local arrays for parameterization of cloud microphysics.</span><br><span class="hljs-comment">! microphysics_init         : initialization of individual cloud microphysics schemes.</span><br><span class="hljs-comment">! driver_microphysics       : main driver (called from mpas_atm_time_integration).</span><br><span class="hljs-comment">! precip_from_MPAS          : initialize timestep local arrays for precipitation.</span><br><span class="hljs-comment">! precip_to_MPAS            : copy local arrays to MPAS arrays.</span><br><span class="hljs-comment">! compute_radar_reflectivity: compute radar reflectivities.</span><br><span class="hljs-comment">! compute_relhum            : compute relative humidity.</span><br><span class="hljs-comment">!</span><br><span class="hljs-comment">! WRF physics called from microphysics_driver:</span><br><span class="hljs-comment">! --------------------------------------------</span><br><span class="hljs-comment">! * module_mp_kessler : Kessler cloud microphysics.</span><br><span class="hljs-comment">! * module_mp_thompson: Thompson cloud microphysics.</span><br><span class="hljs-comment">! * module_mp_wsm6    : WSM6 cloud microphysics.</span><br>...<br>       <span class="hljs-keyword">do</span> j = jts,jte<br>       <span class="hljs-keyword">do</span> i = its,ite<br>          <span class="hljs-keyword">do</span> k = kts,kte<br>             p1d(k) = pres_p(i,k,j)<br>             t1d(k) = th_p(i,k,j) * pi_p(i,k,j)<br>             qv1d(k)  = qv_p(i,k,j)<br>             qr1d(k)  = qr_p(i,k,j)<br>             qs1d(k)  = qs_p(i,k,j)<br>             qg1d(k)  = qg_p(i,k,j)<br>             dBZ1d(k) = -<span class="hljs-number">35._RKIND</span><br>             zp(k) = z_p(i,k,j) - z_p(i,<span class="hljs-number">1</span>,j) + <span class="hljs-number">0.5</span>*dz_p(i,k,j) <span class="hljs-comment">! height AGL</span><br>          <span class="hljs-keyword">enddo</span><br><br>          <span class="hljs-keyword">call</span> refl10cm_wsm6(qv1d,qr1d,qs1d,qg1d,t1d,p1d,dBZ1d,kts,kte)<br><br>          kp = <span class="hljs-number">1</span><br>          <span class="hljs-keyword">do</span> k = kts,kte<br>             dBZ1d(k) = <span class="hljs-built_in">max</span>(-<span class="hljs-number">35._RKIND</span>,dBZ1d(k))<br>             <span class="hljs-keyword">if</span>(zp(k) <span class="hljs-keyword">.lt.</span> <span class="hljs-number">1000.</span>) kp = k<br>          <span class="hljs-keyword">enddo</span><br>          refl10cm_max(i) = <span class="hljs-built_in">maxval</span>(dBZ1d(:))<br>          w1 = (zp(kp+<span class="hljs-number">1</span>)-<span class="hljs-number">1000.</span>)/(zp(kp+<span class="hljs-number">1</span>)-zp(kp))<br>          w2 = <span class="hljs-number">1.0</span> - w1<br>          refl10cm_1km(i) = w1*dBZ1d(kp) + w2*dBZ1d(kp+<span class="hljs-number">1</span>)<br>          refl10cm_1km_max(i) = <span class="hljs-built_in">max</span>(refl10cm_1km_max(i),refl10cm_1km(i))<br>       <span class="hljs-keyword">enddo</span><br>       <span class="hljs-keyword">enddo</span><br>...<br></code></pre></td></tr></table></figure><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">var</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;refl10cm_max&quot;</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;real&quot;</span> <span class="hljs-attr">dimensions</span>=<span class="hljs-string">&quot;nCells Time&quot;</span> <span class="hljs-attr">units</span>=<span class="hljs-string">&quot;dBZ&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">description</span>=<span class="hljs-string">&quot;10 cm maximum radar reflectivity&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">packages</span>=<span class="hljs-string">&quot;mp_thompson_in;mp_thompson_aers_in;mp_wsm6_in&quot;</span>/&gt;</span><br><br><span class="hljs-tag">&lt;<span class="hljs-name">var</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;refl10cm_1km&quot;</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;real&quot;</span> <span class="hljs-attr">dimensions</span>=<span class="hljs-string">&quot;nCells Time&quot;</span> <span class="hljs-attr">units</span>=<span class="hljs-string">&quot;dBZ&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">description</span>=<span class="hljs-string">&quot;diagnosed 10 cm radar reflectivity at 1 km AGL&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">packages</span>=<span class="hljs-string">&quot;mp_thompson_in;mp_thompson_aers_in;mp_wsm6_in&quot;</span>/&gt;</span><br><br><span class="hljs-tag">&lt;<span class="hljs-name">var</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;refl10cm_1km_max&quot;</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;real&quot;</span> <span class="hljs-attr">dimensions</span>=<span class="hljs-string">&quot;nCells Time&quot;</span> <span class="hljs-attr">units</span>=<span class="hljs-string">&quot;dBZ&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">description</span>=<span class="hljs-string">&quot;maximum diagnosed 10 cm radar reflectivity at 1 km AGL since last output time&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">packages</span>=<span class="hljs-string">&quot;mp_thompson_in;mp_thompson_aers_in;mp_wsm6_in&quot;</span>/&gt;</span><br></code></pre></td></tr></table></figure>    <div class="fold">      <div class="fold-title fold-info collapsed" data-toggle="collapse" href="#collapse-6ae3e036" role="button" aria-expanded="false" aria-controls="collapse-6ae3e036">        <div class="fold-arrow">▶</div>mpas_atmphys_driver_microphysics.F#L656      </div>      <div class="fold-collapse collapse" id="collapse-6ae3e036">        <div class="fold-content">          <figure class="highlight fortran"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br></pre></td><td class="code"><pre><code class="hljs fortran"><span class="hljs-comment">!=================================================================================================================</span><br> <span class="hljs-function"><span class="hljs-keyword">subroutine</span></span> compute_radar_reflectivity(configs,diag_physics,its,ite)<br><span class="hljs-comment">!=================================================================================================================</span><br><br><span class="hljs-comment">!input arguments:</span><br> <span class="hljs-keyword">type</span>(mpas_pool_type),<span class="hljs-keyword">intent</span>(<span class="hljs-keyword">in</span>):: configs<br> <span class="hljs-keyword">integer</span>,<span class="hljs-keyword">intent</span>(<span class="hljs-keyword">in</span>):: its,ite<br><br><span class="hljs-comment">!inout arguments:</span><br> <span class="hljs-keyword">type</span>(mpas_pool_type),<span class="hljs-keyword">intent</span>(inout):: diag_physics<br><br><span class="hljs-comment">!local pointers:</span><br> <span class="hljs-keyword">character</span>(len=StrKIND),<span class="hljs-keyword">pointer</span>:: microp_scheme<br> <span class="hljs-keyword">real</span>(<span class="hljs-keyword">kind</span>=RKIND),<span class="hljs-keyword">dimension</span>(:),<span class="hljs-keyword">pointer</span>:: refl10cm_max,refl10cm_1km,refl10cm_1km_max<br><br><span class="hljs-comment">!local variables and arrays:</span><br> <span class="hljs-keyword">integer</span>:: i,j,k,kp<br> <span class="hljs-keyword">real</span>(<span class="hljs-keyword">kind</span>=RKIND),<span class="hljs-keyword">dimension</span>(:),<span class="hljs-keyword">allocatable</span>:: qv1d,qc1d,qr1d,qs1d,qg1d,t1d,p1d,nr1d,dBZ1d,zp<br> <span class="hljs-keyword">real</span>(<span class="hljs-keyword">kind</span>=RKIND):: w1,w2<br><br><span class="hljs-comment">!-----------------------------------------------------------------------------------------------------------------</span><br><br> <span class="hljs-keyword">call</span> mpas_pool_get_config(configs,<span class="hljs-string">&#x27;config_microp_scheme&#x27;</span>,microp_scheme)<br><br> <span class="hljs-keyword">call</span> mpas_pool_get_array(diag_physics,<span class="hljs-string">&#x27;refl10cm_max&#x27;</span>,refl10cm_max)<br> <span class="hljs-keyword">call</span> mpas_pool_get_array(diag_physics,<span class="hljs-string">&#x27;refl10cm_1km&#x27;</span>,refl10cm_1km)<br> <span class="hljs-keyword">call</span> mpas_pool_get_array(diag_physics,<span class="hljs-string">&#x27;refl10cm_1km_max&#x27;</span>,refl10cm_1km_max)<br><br> microp_select: <span class="hljs-keyword">select</span> <span class="hljs-keyword">case</span>(<span class="hljs-built_in">trim</span>(microp_scheme))<br>    <span class="hljs-keyword">case</span> (<span class="hljs-string">&quot;mp_kessler&quot;</span>)<br>       <span class="hljs-keyword">call</span> physics_error_fatal(<span class="hljs-string">&#x27;--- calculation of radar reflectivity is not available&#x27;</span> // &amp;<br>                                 <span class="hljs-string">&#x27;with kessler cloud microphysics&#x27;</span>)<br><br>    <span class="hljs-keyword">case</span> (<span class="hljs-string">&quot;mp_wsm6&quot;</span>)<br>       <span class="hljs-keyword">if</span>(<span class="hljs-keyword">.not.</span><span class="hljs-built_in">allocated</span>(p1d)  ) <span class="hljs-built_in">allocate</span>(p1d(kts:kte)  )<br>       <span class="hljs-keyword">if</span>(<span class="hljs-keyword">.not.</span><span class="hljs-built_in">allocated</span>(t1d)  ) <span class="hljs-built_in">allocate</span>(t1d(kts:kte)  )<br>       <span class="hljs-keyword">if</span>(<span class="hljs-keyword">.not.</span><span class="hljs-built_in">allocated</span>(qv1d) ) <span class="hljs-built_in">allocate</span>(qv1d(kts:kte) )<br>       <span class="hljs-keyword">if</span>(<span class="hljs-keyword">.not.</span><span class="hljs-built_in">allocated</span>(qr1d) ) <span class="hljs-built_in">allocate</span>(qr1d(kts:kte) )<br>       <span class="hljs-keyword">if</span>(<span class="hljs-keyword">.not.</span><span class="hljs-built_in">allocated</span>(qs1d) ) <span class="hljs-built_in">allocate</span>(qs1d(kts:kte) )<br>       <span class="hljs-keyword">if</span>(<span class="hljs-keyword">.not.</span><span class="hljs-built_in">allocated</span>(qg1d) ) <span class="hljs-built_in">allocate</span>(qg1d(kts:kte) )<br>       <span class="hljs-keyword">if</span>(<span class="hljs-keyword">.not.</span><span class="hljs-built_in">allocated</span>(dBz1d)) <span class="hljs-built_in">allocate</span>(dBZ1d(kts:kte))<br>       <span class="hljs-keyword">if</span>(<span class="hljs-keyword">.not.</span><span class="hljs-built_in">allocated</span>(zp)   ) <span class="hljs-built_in">allocate</span>(zp(kts:kte)   )<br><br>       <span class="hljs-keyword">do</span> j = jts,jte<br>       <span class="hljs-keyword">do</span> i = its,ite<br>          <span class="hljs-keyword">do</span> k = kts,kte<br>             p1d(k) = pres_p(i,k,j)<br>             t1d(k) = th_p(i,k,j) * pi_p(i,k,j)<br>             qv1d(k)  = qv_p(i,k,j)<br>             qr1d(k)  = qr_p(i,k,j)<br>             qs1d(k)  = qs_p(i,k,j)<br>             qg1d(k)  = qg_p(i,k,j)<br>             dBZ1d(k) = -<span class="hljs-number">35._RKIND</span><br>             zp(k) = z_p(i,k,j) - z_p(i,<span class="hljs-number">1</span>,j) + <span class="hljs-number">0.5</span>*dz_p(i,k,j) <span class="hljs-comment">! height AGL</span><br>          <span class="hljs-keyword">enddo</span><br><br>          <span class="hljs-keyword">call</span> refl10cm_wsm6(qv1d,qr1d,qs1d,qg1d,t1d,p1d,dBZ1d,kts,kte)<br><br>          kp = <span class="hljs-number">1</span><br>          <span class="hljs-keyword">do</span> k = kts,kte<br>             dBZ1d(k) = <span class="hljs-built_in">max</span>(-<span class="hljs-number">35._RKIND</span>,dBZ1d(k))<br>             <span class="hljs-keyword">if</span>(zp(k) <span class="hljs-keyword">.lt.</span> <span class="hljs-number">1000.</span>) kp = k<br>          <span class="hljs-keyword">enddo</span><br>          refl10cm_max(i) = <span class="hljs-built_in">maxval</span>(dBZ1d(:))<br>          w1 = (zp(kp+<span class="hljs-number">1</span>)-<span class="hljs-number">1000.</span>)/(zp(kp+<span class="hljs-number">1</span>)-zp(kp))<br>          w2 = <span class="hljs-number">1.0</span> - w1<br>          refl10cm_1km(i) = w1*dBZ1d(kp) + w2*dBZ1d(kp+<span class="hljs-number">1</span>)<br>          refl10cm_1km_max(i) = <span class="hljs-built_in">max</span>(refl10cm_1km_max(i),refl10cm_1km(i))<br>       <span class="hljs-keyword">enddo</span><br>       <span class="hljs-keyword">enddo</span><br><br>       <span class="hljs-keyword">if</span>(<span class="hljs-built_in">allocated</span>(p1d)  ) <span class="hljs-built_in">deallocate</span>(p1d  )<br>       <span class="hljs-keyword">if</span>(<span class="hljs-built_in">allocated</span>(t1d)  ) <span class="hljs-built_in">deallocate</span>(t1d  )<br>       <span class="hljs-keyword">if</span>(<span class="hljs-built_in">allocated</span>(qv1d) ) <span class="hljs-built_in">deallocate</span>(qv1d )<br>       <span class="hljs-keyword">if</span>(<span class="hljs-built_in">allocated</span>(qr1d) ) <span class="hljs-built_in">deallocate</span>(qr1d )<br>       <span class="hljs-keyword">if</span>(<span class="hljs-built_in">allocated</span>(qs1d) ) <span class="hljs-built_in">deallocate</span>(qs1d )<br>       <span class="hljs-keyword">if</span>(<span class="hljs-built_in">allocated</span>(qg1d) ) <span class="hljs-built_in">deallocate</span>(qg1d )<br>       <span class="hljs-keyword">if</span>(<span class="hljs-built_in">allocated</span>(dBz1d)) <span class="hljs-built_in">deallocate</span>(dBZ1d)<br>       <span class="hljs-keyword">if</span>(<span class="hljs-built_in">allocated</span>(zp)   ) <span class="hljs-built_in">deallocate</span>(zp   )<br><br>    <span class="hljs-keyword">case</span> (<span class="hljs-string">&quot;mp_thompson&quot;</span>,<span class="hljs-string">&quot;mp_thompson_aerosols&quot;</span>)<br>       <span class="hljs-keyword">if</span>(<span class="hljs-keyword">.not.</span><span class="hljs-built_in">allocated</span>(p1d)  ) <span class="hljs-built_in">allocate</span>(p1d(kts:kte)  )<br>       <span class="hljs-keyword">if</span>(<span class="hljs-keyword">.not.</span><span class="hljs-built_in">allocated</span>(t1d)  ) <span class="hljs-built_in">allocate</span>(t1d(kts:kte)  )<br>       <span class="hljs-keyword">if</span>(<span class="hljs-keyword">.not.</span><span class="hljs-built_in">allocated</span>(qv1d) ) <span class="hljs-built_in">allocate</span>(qv1d(kts:kte) )<br>       <span class="hljs-keyword">if</span>(<span class="hljs-keyword">.not.</span><span class="hljs-built_in">allocated</span>(qc1d) ) <span class="hljs-built_in">allocate</span>(qc1d(kts:kte) )<br>       <span class="hljs-keyword">if</span>(<span class="hljs-keyword">.not.</span><span class="hljs-built_in">allocated</span>(qr1d) ) <span class="hljs-built_in">allocate</span>(qr1d(kts:kte) )<br>       <span class="hljs-keyword">if</span>(<span class="hljs-keyword">.not.</span><span class="hljs-built_in">allocated</span>(qs1d) ) <span class="hljs-built_in">allocate</span>(qs1d(kts:kte) )<br>       <span class="hljs-keyword">if</span>(<span class="hljs-keyword">.not.</span><span class="hljs-built_in">allocated</span>(qg1d) ) <span class="hljs-built_in">allocate</span>(qg1d(kts:kte) )<br>       <span class="hljs-keyword">if</span>(<span class="hljs-keyword">.not.</span><span class="hljs-built_in">allocated</span>(nr1d) ) <span class="hljs-built_in">allocate</span>(nr1d(kts:kte) )<br>       <span class="hljs-keyword">if</span>(<span class="hljs-keyword">.not.</span><span class="hljs-built_in">allocated</span>(dBz1d)) <span class="hljs-built_in">allocate</span>(dBZ1d(kts:kte))<br>       <span class="hljs-keyword">if</span>(<span class="hljs-keyword">.not.</span><span class="hljs-built_in">allocated</span>(zp)   ) <span class="hljs-built_in">allocate</span>(zp(kts:kte)   )<br><br>       <span class="hljs-keyword">do</span> j = jts,jte<br>       <span class="hljs-keyword">do</span> i = its,ite<br>          <span class="hljs-keyword">do</span> k = kts,kte<br>             p1d(k) = pres_p(i,k,j)<br>             t1d(k) = th_p(i,k,j) * pi_p(i,k,j)<br>             qv1d(k)  = qv_p(i,k,j)<br>             qc1d(k)  = qc_p(i,k,j)<br>             qr1d(k)  = qr_p(i,k,j)<br>             qs1d(k)  = qs_p(i,k,j)<br>             qg1d(k)  = qg_p(i,k,j)<br>             nr1d(k)  = nr_p(i,k,j)<br>             dBZ1d(k) = -<span class="hljs-number">35._RKIND</span><br>             zp(k) = z_p(i,k,j) - z_p(i,<span class="hljs-number">1</span>,j) + <span class="hljs-number">0.5</span>*dz_p(i,k,j) <span class="hljs-comment">! height AGL</span><br>          <span class="hljs-keyword">enddo</span><br><br>          <span class="hljs-keyword">call</span> calc_refl10cm(qv1d,qc1d,qr1d,nr1d,qs1d,qg1d,t1d,p1d,dBZ1d,kts,kte,i,j)<br><br>          kp = <span class="hljs-number">1</span><br>          <span class="hljs-keyword">do</span> k = kts,kte<br>             dBZ1d(k) = <span class="hljs-built_in">max</span>(-<span class="hljs-number">35._RKIND</span>,dBZ1d(k))<br>             <span class="hljs-keyword">if</span>(zp(k) <span class="hljs-keyword">.lt.</span> <span class="hljs-number">1000.</span>) kp = k<br>          <span class="hljs-keyword">enddo</span><br>          refl10cm_max(i) = <span class="hljs-built_in">maxval</span>(dBZ1d(:))<br>          w1 = (zp(kp+<span class="hljs-number">1</span>)-<span class="hljs-number">1000.</span>)/(zp(kp+<span class="hljs-number">1</span>)-zp(kp))<br>          w2 = <span class="hljs-number">1.0</span> - w1<br>          refl10cm_1km(i) = w1*dBZ1d(kp) + w2*dBZ1d(kp+<span class="hljs-number">1</span>)<br>          refl10cm_1km_max(i) = <span class="hljs-built_in">max</span>(refl10cm_1km_max(i),refl10cm_1km(i))<br>       <span class="hljs-keyword">enddo</span><br>       <span class="hljs-keyword">enddo</span><br><br>       <span class="hljs-keyword">if</span>(<span class="hljs-built_in">allocated</span>(p1d)  ) <span class="hljs-built_in">deallocate</span>(p1d  )<br>       <span class="hljs-keyword">if</span>(<span class="hljs-built_in">allocated</span>(t1d)  ) <span class="hljs-built_in">deallocate</span>(t1d  )<br>       <span class="hljs-keyword">if</span>(<span class="hljs-built_in">allocated</span>(qv1d) ) <span class="hljs-built_in">deallocate</span>(qv1d )<br>       <span class="hljs-keyword">if</span>(<span class="hljs-built_in">allocated</span>(qc1d) ) <span class="hljs-built_in">deallocate</span>(qc1d )<br>       <span class="hljs-keyword">if</span>(<span class="hljs-built_in">allocated</span>(qr1d) ) <span class="hljs-built_in">deallocate</span>(qr1d )<br>       <span class="hljs-keyword">if</span>(<span class="hljs-built_in">allocated</span>(qs1d) ) <span class="hljs-built_in">deallocate</span>(qs1d )<br>       <span class="hljs-keyword">if</span>(<span class="hljs-built_in">allocated</span>(qg1d) ) <span class="hljs-built_in">deallocate</span>(qg1d )<br>       <span class="hljs-keyword">if</span>(<span class="hljs-built_in">allocated</span>(nr1d) ) <span class="hljs-built_in">deallocate</span>(nr1d )<br>       <span class="hljs-keyword">if</span>(<span class="hljs-built_in">allocated</span>(dBz1d)) <span class="hljs-built_in">deallocate</span>(dBZ1d)<br>       <span class="hljs-keyword">if</span>(<span class="hljs-built_in">allocated</span>(zp)   ) <span class="hljs-built_in">deallocate</span>(zp   )<br><br>    <span class="hljs-keyword">case</span> <span class="hljs-keyword">default</span><br> <span class="hljs-keyword">end</span> <span class="hljs-keyword">select</span> microp_select<br><br> <span class="hljs-keyword">end</span> <span class="hljs-function"><span class="hljs-keyword">subroutine</span></span> compute_radar_reflectivity<br></code></pre></td></tr></table></figure>        </div>      </div>    </div>]]></content>
    
    
    <categories>
      
      <category>NWP</category>
      
    </categories>
    
    
    <tags>
      
      <tag>NWP</tag>
      
      <tag>WRF</tag>
      
      <tag>MPAS</tag>
      
      <tag>HKO</tag>
      
      <tag>Meteorology</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Barotropic vs. Baroclinic Atmosphere</title>
    <link href="/2025/05/03/Barotropic-vs-Baroclinic-Atmosphere/"/>
    <url>/2025/05/03/Barotropic-vs-Baroclinic-Atmosphere/</url>
    
    <content type="html"><![CDATA[<h1 id="barotropic-vs.-baroclinic-atmosphere">Barotropic vs. Baroclinic Atmosphere</h1><ul><li>Barotropic 正壓</li><li>Baroclinic 斜壓</li></ul><p>正壓與斜壓的數學差異在於等壓面與等密度面是否平行：平行為正壓，不平行為斜壓。低緯度通常平行，高緯度則有夾角。可通過判斷 <span class="math inline">\(\nabla P \times \nabla \rho\)</span> 是否為零來確認。</p><p>在大氣中討論正壓與斜壓時，通常聚焦於不穩定性，即正壓不穩定與斜壓不穩定。不穩定是指在特定環境配置下，小擾動會持續放大。</p><p><strong>正壓不穩定（水平風切）</strong>：<br />當渦度（類似角速度）變化劇烈時易發生。數學條件為存在一點，其南側渦度為負，北側為正（或相反），即渦度符號相反，反映強烈變化。<br />在熱帶，ITCZ南側風越過赤道轉為西南風，北側為東北風，形成強烈風切與渦度變化，促進小擾動成長，引發正壓不穩定。<br />熱帶氣旋（如颱風）中，眼區渦度小，眼牆渦度大，渦度變化劇烈，易形成正壓不穩定。</p><p><strong>斜壓不穩定（垂直風切）</strong>：<br />由水平溫度梯度（如南北溫差大）驅動。根據熱力風平衡，大溫差導致強垂直風切，從而引發不穩定。</p><h1 id="正壓與斜壓">正壓與斜壓</h1><p>以下是對<strong>正壓</strong>（barotropic）與<strong>斜壓</strong>（baroclinic）條件、其數學差異以及在大氣不穩定性（正壓不穩定與斜壓不穩定）中角色的更詳細闡述，特別針對熱帶氣旋的相關性進行深入探討。</p><hr /><h2 id="正壓與斜壓數學與物理上的區別"><strong>1. 正壓與斜壓：數學與物理上的區別</strong></h2><p>正壓與斜壓的區別在於<strong>等壓面</strong>（isobaric surfaces，<span class="math inline">\(P = \text{常數}\)</span>）與<strong>等密度面</strong>（isopycnal surfaces，<span class="math inline">\(\rho = \text{常數}\)</span>）是否平行。這一關係決定了大氣流動的基本動力學特性。</p><ul><li><strong>正壓條件</strong>：<ul><li><strong>定義</strong>：當等壓面與等密度面平行時，稱為正壓大氣。</li><li><strong>數學判斷</strong>：壓力梯度（<span class="math inline">\(\nabla P\)</span>）與密度梯度（<span class="math inline">\(\nabla \rho\)</span>）平行，因此它們的叉積為零： <span class="math display">\[\nabla P \times \nabla \rho = 0\]</span></li><li><strong>物理意義</strong>：在正壓大氣中，等壓面上的密度不隨位置變化，這通常出現在溫度梯度微弱的地區，如低緯度（熱帶）。此時，大氣運動近似為二維流動，動力學主要由水平風切（wind shear）和渦度（vorticity，旋轉量）主導。</li><li><strong>範例</strong>：在熱帶地區，由於溫度場較均勻，等壓面與等密度面幾乎平行，屬於正壓環境。</li></ul></li><li><strong>斜壓條件</strong>：<ul><li><strong>定義</strong>：當等壓面與等密度面不平行，彼此形成夾角時，稱為斜壓大氣。</li><li><strong>數學判斷</strong>：壓力梯度與密度梯度的叉積不為零： <span class="math display">\[\nabla P \times \nabla \rho \neq 0\]</span></li><li><strong>物理意義</strong>：斜壓條件源於水平溫度梯度，導致等壓面上的密度變化。這在溫帶和高緯度較常見，因為這些地區存在顯著的溫度對比（例如極地冷空氣與副熱帶暖空氣之間），使等密度面相對於等壓面傾斜。</li><li><strong>範例</strong>：在中緯度，急流（jet stream）與強烈的水平溫度梯度相關，導致斜壓條件和垂直風切。</li></ul></li><li><strong>地理分佈</strong>：<ul><li><strong>低緯度（熱帶）</strong>：由於水平溫度梯度較弱，大氣通常為正壓，等壓面與等密度面平行。</li><li><strong>高緯度（中至極地）</strong>：強烈的溫度梯度（例如極地冷空氣與副熱帶暖空氣之間）導致斜壓條件，等壓面與等密度面形成夾角。</li></ul></li></ul><hr /><h2 id="大氣不穩定性正壓不穩定與斜壓不穩定"><strong>2. 大氣不穩定性：正壓不穩定與斜壓不穩定</strong></h2><p>在大氣科學中，討論正壓與斜壓時，通常聚焦於<strong>不穩定性</strong>（instability），即在特定大氣配置下，小擾動（perturbations）可能指數增長，導致顯著的天氣現象，如氣旋、風暴或熱帶氣旋。不穩定性發生在滿足特定條件時，使擾動得以放大。</p><h3 id="正壓不穩定與水平風切相關"><strong>正壓不穩定（與水平風切相關）</strong></h3><ul><li><strong>定義</strong>：正壓不穩定發生在正壓大氣中，當水平風切導致<strong>渦度</strong>（vorticity，類似角速度的旋轉量）梯度強烈變化時，小擾動會放大，形成波動或渦旋。</li><li><strong>數學條件</strong>：<ul><li>正壓不穩定需要渦度梯度的符號反轉。具體來說，對東西向（緯向，zonal）氣流，絕對渦度（absolute vorticity，<span class="math inline">\(\eta = \zeta + f\)</span>，其中<span class="math inline">\(\zeta\)</span>為相對渦度，<span class="math inline">\(f\)</span>為科氏力參數）的南北向（經向，meridional）梯度必須在某處改變符號： <span class="math display">\[\frac{\partial \eta}{\partial y} = 0 \text{，且兩側符號相反}\]</span></li><li>這表示存在一個區域，北側渦度梯度為正，南側為負（或反之）。</li></ul></li><li><strong>物理機制</strong>：<ul><li>強烈的水平風切形成高渦度和低渦度的區域，例如急流或剪切區，一側渦度為正，另一側為負。</li><li>小擾動（例如波動）在這種剪切區中可從平均氣流中提取動能，導致擾動增長。</li></ul></li><li><strong>大氣中的範例</strong>：<ul><li><strong>熱帶輻合帶（ITCZ）</strong>：在熱帶，ITCZ是貿易風匯聚的區域。夏季時，ITCZ南側的風在越過赤道後因科氏力轉為西南風，北側則為東北風，形成強烈的水平風切區，伴隨顯著的渦度梯度：<ul><li>ITCZ南側：負渦度（南半球氣旋性）。</li><li>ITCZ北側：正渦度（北半球氣旋性）。</li><li>這種渦度梯度滿足正壓不穩定的條件，使小擾動（例如東風波）成長為較大的系統。</li></ul></li><li><strong>熱帶氣旋</strong>：在熱帶氣旋（如颱風）中，平靜的風眼渦度幾乎為零，而眼牆因快速旋轉具有極高渦度。這種劇烈的徑向渦度梯度為正壓不穩定提供了理想環境，小擾動（例如眼牆中的中尺度渦旋）可通過提取氣旋平均氣流的動能而增長，影響氣旋的結構或強度。</li></ul></li><li><strong>關鍵特徵</strong>：<ul><li>正壓不穩定是純水平過程，不涉及垂直運動或溫度梯度。</li><li>其能量來源是平均氣流的動能（風切），而非位能。</li></ul></li></ul><h3 id="斜壓不穩定與垂直風切相關"><strong>斜壓不穩定（與垂直風切相關）</strong></h3><ul><li><strong>定義</strong>：斜壓不穩定發生在斜壓大氣中，當強烈的水平溫度梯度導致垂直風切時，擾動通過將位能轉化為動能而增長。</li><li><strong>數學條件</strong>：<ul><li>斜壓不穩定需要顯著的經向溫度梯度（<span class="math inline">\(\frac{\partial T}{\partial y}\)</span>）及其伴隨的垂直風切，這由<strong>熱力風平衡</strong>（thermal wind balance）描述： <span class="math display">\[\frac{\partial \mathbf{v}_g}{\partial z} \propto -\frac{\partial T}{\partial y}\]</span> 其中<span class="math inline">\(\mathbf{v}_g\)</span>為地轉風，<span class="math inline">\(z\)</span>為高度。</li><li>必要條件通常通過<strong>Charney-Stern準則</strong>表達，涉及位渦（potential vorticity）梯度在溫度梯度存在時改變符號。</li></ul></li><li><strong>物理機制</strong>：<ul><li>水平溫度梯度（例如南側暖空氣，北側冷空氣）導致對流層頂傾斜和垂直風切。</li><li>擾動（例如波動）隨高度傾斜，可釋放儲存在溫度梯度中的可用位能（available potential energy），將其轉化為動能，促進擾動增長。</li><li>這是一個三維過程，涉及水平和垂直運動（例如暖空氣上升，冷空氣下沉）。</li></ul></li><li><strong>大氣中的範例</strong>：<ul><li><strong>中緯度氣旋</strong>：在中緯度，斜壓不穩定驅動溫帶氣旋的形成。極鋒（polar front）上的強溫度梯度（冷極地空氣與暖副熱帶空氣之間）在急流中產生垂直風切，促進波動增長。</li><li><strong>急流動力學</strong>：急流的垂直風切與溫度梯度相關，是斜壓不穩定的熱點，導致天氣尺度天氣系統的發展。</li></ul></li><li><strong>關鍵特徵</strong>：<ul><li>斜壓不穩定的能量來源是水平溫度梯度中的可用位能。</li><li>它涉及垂直運動，對中緯度天氣系統至關重要。</li></ul></li></ul><hr /><h2 id="熱帶氣旋的相關性"><strong>3. 熱帶氣旋的相關性</strong></h2><p>熱帶氣旋（例如颱風、颶風）是複雜的系統，受正壓和斜壓過程的共同影響，但由於熱帶地區主要為正壓環境，正壓不穩定在其形成和增強中更為關鍵。</p><ul><li><strong>熱帶氣旋中的正壓不穩定</strong>：<ul><li><strong>結構</strong>：熱帶氣旋的風眼平靜，渦度幾乎為零，而眼牆因劇烈旋轉具有高渦度。這種徑向渦度梯度的劇烈變化為正壓不穩定提供了條件。</li><li><strong>機制</strong>：小擾動（例如眼牆中的中尺度渦旋）可通過從氣旋平均氣流中提取動能而增長，導致眼牆替換週期或不對稱結構的形成。</li><li><strong>ITCZ的貢獻</strong>：ITCZ的強風切和渦度梯度為初始擾動（例如熱帶波）的發展提供了有利環境，這些擾動可通過正壓不穩定演變為熱帶氣旋。</li><li><strong>範例</strong>：大西洋的東風波在ITCZ的正壓不穩定環境中放大，常成為颶風的前身。</li></ul></li><li><strong>斜壓影響</strong>：<ul><li>雖然熱帶氣旋主要在正壓環境中形成，但斜壓效應在與中緯度系統的交互中可能發揮作用。例如：<ul><li>當熱帶氣旋向高緯移動時，可能進入斜壓區（例如中緯度鋒面），引發溫帶轉換（extratropical transition）。在此過程中，斜壓不穩定可通過引入垂直風切和溫度梯度增強氣旋的發展。</li><li>上層低壓槽（斜壓特徵）可通過增強氣旋的流出或引入垂直風切，調節熱帶氣旋的強度。</li></ul></li></ul></li></ul><hr /><h2 id="總結正壓與斜壓的關鍵差異與應用"><strong>4. 總結：正壓與斜壓的關鍵差異與應用</strong></h2><table><thead><tr class="header"><th><strong>面向</strong></th><th><strong>正壓不穩定</strong></th><th><strong>斜壓不穩定</strong></th></tr></thead><tbody><tr class="odd"><td><strong>大氣條件</strong></td><td>等壓面與等密度面平行 (<span class="math inline">\(\nabla P \times \nabla \rho = 0\)</span>)</td><td>等壓面與等密度面不平行 (<span class="math inline">\(\nabla P \times \nabla \rho \neq 0\)</span>)</td></tr><tr class="even"><td><strong>驅動因素</strong></td><td>水平風切（渦度梯度）</td><td>水平溫度梯度（垂直風切）</td></tr><tr class="odd"><td><strong>能量來源</strong></td><td>平均氣流的動能</td><td>溫度梯度中的可用位能</td></tr><tr class="even"><td><strong>主要區域</strong></td><td>熱帶（例如ITCZ、熱帶氣旋）</td><td>中高緯度（例如急流、極鋒）</td></tr><tr class="odd"><td><strong>數學條件</strong></td><td>渦度梯度改變符號 (<span class="math inline">\(\frac{\partial \eta}{\partial y} = 0\)</span>)</td><td>位渦梯度在溫度梯度存在時改變符號</td></tr><tr class="even"><td><strong>範例</strong></td><td>東風波、眼牆中尺度渦旋</td><td>溫帶氣旋、急流波動</td></tr></tbody></table><ul><li><strong>熱帶氣旋</strong>：主要由熱帶的正壓不穩定驅動，ITCZ或眼牆的渦度梯度扮演關鍵角色。斜壓不穩定在氣旋向溫帶轉換時變得重要。</li><li><strong>數學工具</strong>：<ul><li>正壓不穩定：分析渦度場（<span class="math inline">\(\zeta\)</span>）及其經向梯度。</li><li>斜壓不穩定：檢查溫度梯度（<span class="math inline">\(\frac{\partial T}{\partial y}\)</span>）和熱力風平衡下的垂直風切。</li></ul></li></ul><hr /><h2 id="補充說明"><strong>5. 補充說明</strong></h2><ul><li><strong>不穩定性的重要性</strong>：正壓和斜壓不穩定對理解天氣系統的發展至關重要。正壓不穩定主導熱帶地區的天氣現象（如熱帶波和氣旋），而斜壓不穩定則控制中緯度天氣（如風暴和鋒面）。</li><li><strong>實際應用</strong>：<ul><li><strong>天氣預報</strong>：識別易發生正壓不穩定的區域（如ITCZ剪切區）有助於預測熱帶氣旋的形成；斜壓不穩定則為中緯度風暴預報提供依據。</li><li><strong>氣候背景</strong>：溫度梯度的變化（例如因全球暖化）可能影響斜壓不穩定的頻率或強度，從而改變中緯度天氣模式。</li></ul></li></ul><p>需更深入的數學推導（例如正壓不穩定的 Rayleigh-Kuo 準則或斜壓不穩定的 Eady 模型），或針對特定面向（如熱帶氣旋動力學或中緯度風暴）的進一步探討！</p><h1 id="reference">Reference</h1><ol type="1"><li><a href="https://hackmd.io/@hchs-earthscience/ByXxg-mE5">正壓大氣vs.斜壓大氣</a></li><li><a href="https://conf.cwa.gov.tw/media/cwa_past_conferences/105/2016_ppt_all/Session/Session1/1-12-%E7%94%B1%E9%9D%9E%E5%9C%B0%E8%BD%89%E9%A2%A8%E6%95%88%E6%87%89%E6%8E%A2%E8%A8%8E%E5%8F%B0%E7%81%A3%E6%9A%A8%E6%9D%B1%E4%BA%9E%E5%9C%B0%E5%8D%80%E5%86%B7%E5%AD%A3%E4%B8%BB%E8%A6%81%E5%A4%A9%E6%B0%A3%E5%AF%A6%E5%8B%99%E7%A0%94%E7%A9%B6(105%E7%A0%94%E8%A8%8E%E6%9C%83)_%E6%9E%97%E5%AE%9A%E5%AE%9C.pdf">由非地轉風效應探討臺灣暨東亞地區冷季主要天氣實務研究 中央氣象局 預報中心 林定宜</a></li><li><a href="https://photino.cwa.gov.tw/rdcweb/lib/cd/cd07mb/MB/PDF/34/No.2/01.pdf">斜壓和正壓不穩定的介紹</a></li></ol>]]></content>
    
    
    <categories>
      
      <category>Meteorology</category>
      
    </categories>
    
    
    <tags>
      
      <tag>NWP</tag>
      
      <tag>WRF</tag>
      
      <tag>MPAS</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>MPAS | PGW Literature Review</title>
    <link href="/2025/04/29/MPAS-PGW-Literature-Review/"/>
    <url>/2025/04/29/MPAS-PGW-Literature-Review/</url>
    
    <content type="html"><![CDATA[<ul><li><a href="https://waipangsze.github.io/2024/09/30/PGW/"><strong>Pseudo-Global Warming (PGW) - Future Projection</strong></a></li><li><a href="https://waipangsze.github.io/2025/02/03/NWP-PGW-hands-on-ERA5-GFS/"><strong>NWP | Pseudo-Global-Warming (PGW) hands-on | ERA5 | GFS</strong></a></li><li><a href="https://waipangsze.github.io/2025/02/05/NWP-PGW-To-prepare-the-ERA5-GRIB-file/"><strong>NWP | PGW | To prepare the ERA5 GRIB file</strong></a></li></ul><hr /><h1 id="pgw-literature-review-on-mpas-a">PGW Literature Review on MPAS-A</h1><ul><li><a href="https://agupubs.onlinelibrary.wiley.com/doi/pdfdirect/10.1029/2024GL112341">Nunez Ocasio, Kelly M., and Erin M. Dougherty. "The effect of <strong>pseudo‐global warming</strong> on the weather‐climate system of Africa in a convection‐permitting model." Geophysical Research Letters 51.24 (2024): e2024GL112341.</a><ul><li>This study uses the <strong>pseudo‐global warming (PGW) method</strong> in convection‐permitting simulations to assess the impact of anthropogenic warming on Africa's weather‐climate system prior to and during Hurricane Helene's (2006) formation.</li><li><strong>To our knowledge, no study have used the PGW method to examine tropical precipitation with the MPAS‐A model.</strong></li><li><strong>MPAS‐A version 8.0.1 with the Limited‐Area configuration</strong></li><li><strong>A 15‐km–3‐km variable‐resolution</strong> mesh was used with the an elliptically shaped 3‐km highresolution refinement region of the mesh.<ul><li><strong>At 3 km, deep convection was explicitly resolved</strong>.</li></ul></li><li><img src="https://i.imgur.com/3h7OC3S.png" /></li><li>To simulate the period of 1200 UTC 8 September–1800 UTC 13 September 2006<ul><li>In addition to initializing the model at <strong>1200 UTC on 8 September</strong>, two other sets of experiments were completed: initializing the model at <strong>00 UTC on 5 September</strong> and initializing at <strong>00 UTC on 6 September</strong>.</li><li><strong>A limitation of the study</strong> is that it uses <em>only one future projection scenario</em> and one climate model for simulations of short integration time.</li></ul></li><li><strong>The dataset (Download)</strong><ul><li><a href="https://gdex.ucar.edu/dataset/448.html">MPAS-A pseudo-global warming (PGW) experiment with convection-permitting resolution and regional configuration using the Model for Prediction Across Scales (MPAS) version 8.0.1</a><ul><li><img src="https://i.imgur.com/KiMlEds.png" width="300" /></li></ul></li></ul></li></ul></li><li><a href="https://essopenarchive.org/doi/full/10.22541/essoar.174547926.68665522/v1">Kelly Marie Núñez Ocasio, Erin Dougherty, Zachary Moon, et al. Response of African Easterly Waves to a <strong>Warming Climate</strong>: A Convection-Permitting Approach. ESS Open Archive . April 24, 2025.</a><ul><li>The <strong>MPAS-A version 8.0.1 (Skamarock et al., 2012) regional convection-permitting data</strong> used here, as described by Nunez Ocasio and Dougherty (2024a).</li><li>The <strong>buffer region between the 15-km resolution mesh and the refined 3-km resolution area ensures smooth transitions</strong> from coarse to fine resolution while maintaining computational efficiency and effectively reducing any artificial features from the nested domain-type boundaries as in other models like WRF.</li></ul></li></ul><h1 id="african-easterly-wave-aew-tropical-cyclogenesis-tcg">African easterly wave (AEW) tropical cyclogenesis (TCG)</h1><ul><li><a href="https://agupubs.onlinelibrary.wiley.com/doi/pdfdirect/10.1029/2022MS003181">Núñez Ocasio, K. M., &amp; Rios‐Berrios, R. (2023). African easterly wave evolution and tropical cyclogenesis in a pre‐Helene (2006) Hindcast using the Model for Prediction Across Scales‐Atmosphere (MPAS‐A). Journal of Advances in Modeling Earth Systems, 15(2), e2022MS003181.</a><ul><li>Tropical cyclogenesis (TCG) remains an elusive phenomenon partly due to the limited understanding of complex water vapor-convection-wave interactions. The Model for Prediction Across Scales-Atmosphere (MPAS-A) was used to study the TCG of the African easterly wave (AEW) that became Hurricane Helene (2006). The two main objectives were:<ul><li><ol type="a"><li>evaluate the capability of MPAS-A to simulate TCG from an AEW by comparing MPAS-A—initialized with the Integrated Forecasting System (IFS) and the Global Forecast System (GFS)—with observations together with reanalysis and,</li></ol></li><li><ol start="2" type="a"><li>use the hindcast to investigate the role of moisture in the mechanisms that led to Helene's TCG.</li></ol></li></ul></li><li><strong>MPAS-A version 7.1</strong></li><li>A <strong>uniform 15-km</strong> cell-spacing global grid and 55 vertical levels</li><li>The model outputs were interpolated to a latitude and longitude <strong>grid equivalent of a 0.25° × 0.25°</strong> horizontal resolution to be comparable to ERA5</li><li>Data Availability Statement:<ul><li>Post-processed model outputs and the namelists for the MPAS-A simulations can be accessed at <a href="https://doi.org/10.5065/t224-6s94" class="uri">https://doi.org/10.5065/t224-6s94</a>. IMERG data were provided by NASA's Goddard Earth Sciences Data and Information Services Center (<a href="https://disc.gsfc.nasa.gov/" class="uri">https://disc.gsfc.nasa.gov/</a>). The ERA5 (<a href="https://rda.ucar.edu/datasets/ds633.0/" class="uri">https://rda.ucar.edu/datasets/ds633.0/</a>) and GFS (<a href="https://rda.ucar.edu/datasets/ds083.2/" class="uri">https://rda.ucar.edu/datasets/ds083.2/</a>) data were accessed via NCAR Research Data Archive through the Computational and Information Systems Laboratory (CISL). The HURDAT2 track was accessed through the NOAA NHC official page (<a href="https://www.nhc.noaa.gov/data/hurdat/hurdat2-format-atlantic.pdf" class="uri">https://www.nhc.noaa.gov/data/hurdat/hurdat2-format-atlantic.pdf</a>).</li></ul></li></ul></li><li><strong>Dr. Kelly Nuñez Ocasio</strong><ul><li>National Center for Atmospheric Research</li><li>Title: <strong>The Multiscale Nature and Moisture Dependency of Tropical Cyclone Formation</strong> (2023-02-09)</li></ul></li></ul><iframe width="560" height="315" src="https://www.youtube.com/embed/JQwKkEmRTPg" title="UW-AOS Colloquium - 2/20/2023 - Kelly Núñez Ocasio, NCAR" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen></iframe>]]></content>
    
    
    <categories>
      
      <category>MPAS</category>
      
    </categories>
    
    
    <tags>
      
      <tag>HPC</tag>
      
      <tag>NWP</tag>
      
      <tag>WRF</tag>
      
      <tag>MPAS</tag>
      
      <tag>PGW</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Linux | NWP | Google launches free IDX cloud hosting service</title>
    <link href="/2025/04/25/Linux-NWP-AI-Google-launches-free-IDX-cloud/"/>
    <url>/2025/04/25/Linux-NWP-AI-Google-launches-free-IDX-cloud/</url>
    
    <content type="html"><![CDATA[<p><strong>Google 推出了 IDX 免費雲端主機服務，其硬體配置相當出色，配備：</strong></p><ul><li><strong>16核心CPU</strong></li><li><strong>64GB記憶體</strong></li><li><strong>300GB SSD固態硬碟</strong></li><li><strong>網路頻寬最高可達2-5Gbps</strong></li></ul><hr /><p><strong>IDX（Integrated Development Experience</strong> 是Google為開發者設計的雲端開發平台。該平台提供的免費雲端主機，旨在為開發者創造便利的學習和測試環境。用戶無需進行複雜的環境設置，也不需要綁定信用卡，這大大降低了使用門檻，對於開發者來說是一個非常吸引的選擇。</p><p>不過，該雲端主機有一些限制，特別是在連線穩定性方面，通常每隔 x小時 會自動斷線。儘管如此，連線中斷並不會造成資料遺失，使用者只需重新登錄即可繼續進行開發和測試。</p><p>考慮到其免費特點和資料安全保障，這樣的使用體驗仍然具有較高的性價比，在實際應用中非常實用，因此是完全可以接受的。</p><h1 id="project-idx-現已整合至-firebase-studio">Project IDX 現已整合至 Firebase Studio</h1><ol type="1"><li><a href="https://firebase.google.com/docs/studio/idx-is-firebase-studio?hl=zh-TW">Project IDX 現已整合至 Firebase Studio</a><ol type="1"><li>Firebase Studio 是一種代理的雲端式開發環境，可讓您直接在瀏覽器中使用強大的工具和 AI 代理程式。有了 Firebase Studio，您就能在同一個位置設計原型、建構、測試、發布及迭代全端 AI 應用程式。</li></ol></li></ol><h1 id="setup">Setup</h1><div class="group-image-container"><div class="group-image-row"><div class="group-image-wrap"><img src="https://i.imgur.com/3Ujabys.png" /></div><div class="group-image-wrap"><img src="https://i.imgur.com/39GS3v0.png" /></div><div class="group-image-wrap"><img src="https://i.imgur.com/DosaRrh.png" /></div></div><div class="group-image-row"><div class="group-image-wrap"><img src="https://i.imgur.com/N8drA1Z.png" /></div><div class="group-image-wrap"><img src="https://i.imgur.com/yYqouJE.png" /></div><div class="group-image-wrap"><img src="https://i.imgur.com/VdKPFFi.png" /></div></div><div class="group-image-row"><div class="group-image-wrap"><img src="https://i.imgur.com/Z39gVTg.png" /></div></div></div><h2 id="intel-oneapi">Intel OneAPI</h2><div class="note note-primary">            <ul><li><a href="https://waipangsze.github.io/2023/05/06/Intel_OneAPI/"><strong>Intel OneAPI</strong></a></li></ul>          </div>    <div class="fold">      <div class="fold-title fold-info collapsed" data-toggle="collapse" href="#collapse-8f7bdefe" role="button" aria-expanded="false" aria-controls="collapse-8f7bdefe">        <div class="fold-arrow">▶</div>Installation location      </div>      <div class="fold-collapse collapse" id="collapse-8f7bdefe">        <div class="fold-content">          <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs log">  Installation Complete | Intel® oneAPI Base Toolkit<br>--------------------------------------------------------------------------------<br><br>  The following tools have been installed successfully:<br><br>    Intel® oneAPI Base Toolkit<br><br><br><br>  Installation location: /home/user/Documents/intel/oneapi<br><br><br>--------------------------------------------------------------------------------<br><br>  Installation Complete | Intel® oneAPI HPC Toolkit<br>--------------------------------------------------------------------------------<br><br>  The following tools have been installed successfully:<br><br>    Intel® oneAPI HPC Toolkit<br><br><br><br>  Installation location: /home/user/Documents/intel/oneapi<br></code></pre></td></tr></table></figure>        </div>      </div>    </div><div class="group-image-container"><div class="group-image-row"><div class="group-image-wrap"><img src="https://i.imgur.com/DoGxDAP.png" /></div><div class="group-image-wrap"><img src="https://i.imgur.com/GRAMHzt.png" /></div></div><div class="group-image-row"></div><div class="group-image-row"></div></div><h1 id="references">References</h1><ol type="1"><li><a href="https://mp.weixin.qq.com/s/eAOFAF2WZPYs3EbP3vucow">谷歌IDX免费云主机：16核CPU + 64GB内存 + 300GB硬盘</a></li><li><a href="https://ygkkk.blogspot.com/2025/04/google-idx-vps.html">永久免费的Google谷歌IDX VPS搭建代理节点教程：ArgoSB脚本 | Sing-box脚本 | Argo隧道 | 赛风VPN多国家分流；独家总结使用注意点与技巧 - 四月 21, 2025</a><ol type="1"><li>关于分配的本地ip地区，<strong>如果你原先代理是东半球的国家，大概率分配的都是台湾的谷歌IP</strong>，如果是西半球的国家代理，大概率分配的都是美国的谷歌IP</li><li><strong>教程仅测试关闭IDX网页后台的测试时长，仅可用1小时左右</strong>。如果一直开着IDX网页，持续时间会有多久呢？大家自测，欢迎反馈</li><li>大多数网友测试了：<strong>开着前台IDX网页，24小时可用，过后重置</strong>。</li></ol></li><li><a href="https://www.techloy.com/google-is-bringing-android-studio-app-development-to-the-web-with-project-idx/">Google is bringing Android Studio app development to the web with Project IDX | July 2024</a></li></ol>]]></content>
    
    
    <categories>
      
      <category>Linux</category>
      
    </categories>
    
    
    <tags>
      
      <tag>HPC</tag>
      
      <tag>NWP</tag>
      
      <tag>WRF</tag>
      
      <tag>MPAS</tag>
      
      <tag>Linux</tag>
      
      <tag>Google</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>MPAS | WRF | Flerchinger USEd in NEW version. Iterations=10</title>
    <link href="/2025/04/24/MPAS-WRF-Flerchinger-USEd-in-NEW-version-Iterations-10/"/>
    <url>/2025/04/24/MPAS-WRF-Flerchinger-USEd-in-NEW-version-Iterations-10/</url>
    
    <content type="html"><![CDATA[<p><strong>This print comes from the Noah surface scheme</strong>, but if you weren't using that scheme, you likely would still get a segmentation fault.</p>    <div class="fold">      <div class="fold-title fold-info collapsed" data-toggle="collapse" href="#collapse-8f7bdefe" role="button" aria-expanded="false" aria-controls="collapse-8f7bdefe">        <div class="fold-arrow">▶</div>phys/module_sf_noahlsm.F#L1572      </div>      <div class="fold-collapse collapse" id="collapse-8f7bdefe">        <div class="fold-content">          <figure class="highlight fortran"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs fortran"><span class="hljs-comment">! ----------------------------------------------------------------------</span><br><span class="hljs-comment">! OPTION 2: EXPLICIT SOLUTION FOR FLERCHINGER EQ. i.e. CK=0</span><br><span class="hljs-comment">! IN KOREN ET AL., JGR, 1999, EQN 17</span><br><span class="hljs-comment">! APPLY PHYSICAL BOUNDS TO FLERCHINGER SOLUTION</span><br><span class="hljs-comment">! ----------------------------------------------------------------------</span><br>         <span class="hljs-keyword">IF</span> (KCOUNT == <span class="hljs-number">0</span>) <span class="hljs-keyword">THEN</span><br>             <span class="hljs-built_in">PRINT</span> *,<span class="hljs-string">&#x27;Flerchinger USEd in NEW version. Iterations=&#x27;</span>,NLOG<br>                  FK = ( ( (HLICE / (GS * ( - PSIS)))*                    &amp;<br>                       ( (TKELV - T0)/ TKELV))** ( -<span class="hljs-number">1</span>/ BX))* SMCMAX<br><span class="hljs-comment">!            FRH2O = MIN (FK, SMC)</span><br>             <span class="hljs-keyword">IF</span> (FK &lt; <span class="hljs-number">0.02</span>) FK = <span class="hljs-number">0.02</span><br>             FREE = <span class="hljs-built_in">MIN</span> (FK, SMC)<br></code></pre></td></tr></table></figure>        </div>      </div>    </div><ul><li><a href="https://stupidcomputerhints.blogspot.com/2011/04/compendium-of-wrf-errors.html">A Compendium of WRF Errors | April 17, 2011</a><ul><li>Flerchinger USEd in NEW version. Iterations= 10<ul><li>Meaning: <strong>This condition (technically not an error) is thrown by the NOAH Land Surface Model module</strong>. Apparently, it involves the amount of supercooled water available if the ground is frozen. Often, this is because <strong>there is very low soil temperature in your model run</strong>.</li><li>Effect: Because this is an explicit method of solving for the supercooled water available, the model slows down by several orders of magnitude.</li><li>Solution: Unclear, but changing from the NOAH land surface model suppresses the error.</li></ul></li></ul></li><li><a href="https://bbs.06climate.com/forum.php?mod=viewthread&amp;tid=56620">wrf.exe能启动一天还没转完就报Flerchinger USEd in NEW version. Iterations= ... | 2017-10-17 15:10:41</a><ul><li>首先这个错误应该是来自路面过程，应该是Noah LSM或者NoahMP其中的一个，可能会有类似the model is losing water这样的错误，这种错误一般情况下会具体告诉你究竟爆在了哪个点，你去看看这个点是不是一个孤立的水体，对于复杂地形和复杂下垫面的情况就容易出现你碰到的这种问题，<strong>你可以尝试换一套下垫面数据，当然如果你对下垫面要求很高，那只能是自己做修改</strong>。</li><li>因为我也被这个问题困扰过，我一般都只能换下垫面。</li></ul></li><li><a href="https://forum.mmm.ucar.edu/threads/wrf-on-aws-segmentation-fault.8531/#p14695">WRF on AWS segmentation fault | Oct 16, 2019</a><ul><li><strong>This print comes from the Noah surface scheme</strong>, but if you weren't using that scheme, you likely would still get a segmentation fault. Many times this message <strong>indicates a problem with the input soil data</strong>. I notice that in the initial condition file (wrfinput_d01), <strong>the variable TSLB (soil temperature) has several spots with values of 0 K</strong>. Then later in the run (after 78 output times - or 78 hours), I see these 0 K values coming back in the same general area for T2, T, and TSLB, which I believe leads to the demise of the run. I would be curious to know whether the met_em* files also show similar values. You may need to play around with input. Take a look at this post from another WRF forum: <a href="http://forum.wrfforum.com/viewtopic.php?p=26565" class="uri">http://forum.wrfforum.com/viewtopic.php?p=26565</a>. The user ronbeag had a similar problem (theirs was related to soil moisture instead of soil temp), and perhaps may have some information that will be useful for you.</li></ul></li><li><a href="https://atmosai.github.io/2020/01/%E8%AE%B0%E4%B8%80%E6%AC%A1%E9%9D%9E%E5%B8%B8%E5%A5%87%E6%80%AA%E7%9A%84wrf-cmaq%E9%94%99%E8%AF%AF/">记一次非常奇怪的WRF-CMAQ错误 | 2020-01-13</a><ul><li>通过搜索发现可能是 <code>wrfinput_d0*</code> 文件中的 <strong>SH2O 或 SMOIS 变量存在0或负值导致</strong>。然后检查这两个变量值发现，<strong>SMOIS 中部分区域的值为0</strong>。然后更改了Vtable文件，重新运行WPS和WRF模式，结果一切正常，问题解决！</li></ul></li><li><a href="https://forum.mmm.ucar.edu/threads/segmentation-error-because-of-gaps-issue-in-the-input-data.13506/">Segmentation Error Because of gaps/issue in the input data | Jun 23, 2023</a><ul><li>So I say the thread that it can be <strong>because of 0 values in the input soil data</strong>. Also when I examined the met files I say 0 values there.</li><li>The Issue got resolved. The downloaded met data did not had all the weather parameters. <strong>I downloaded again with all weather parameters and it worked</strong></li></ul></li><li><a href="https://forum.mmm.ucar.edu/threads/using-the-era5-land-sea-mask-data-in-wrf.14449/#post-52119">Using the ERA5 land/sea mask data in WRF | Oct 31, 2023</a><ul><li><ol start="5" type="1"><li>Some (but not all) of the rsl files specific to each processor have strange repeated output:</li></ol><ul><li><strong>Flerchinger USEd in NEW version. Iterations= 10</strong></li></ul></li></ul></li><li><a href="https://forum.mmm.ucar.edu/threads/mpas-crashes-with-exit-code-174.16944/#post-41670">MPAS crashes with EXIT CODE: 174 | Apr 29, 2024</a><ul><li>I think these errors (which unfortunately do not mention the word "error") <strong>often result from problems with soil fields</strong>. Could you <strong>check the soil temperatures in your initial conditions file to verify that they are reasonable for all non-water cells?</strong></li><li>If the negative soil temperatures are only a result of the way that the soil temperature field was processed, then some adjustments to the processing workflow might help. On the other hand, if the soil temperatures in the original ERA5 files contain negative values (and assuming these should be in kelvins), then switching to a different dataset for soil fields might help.</li></ul></li><li><a href="https://forum.mmm.ucar.edu/threads/mpas-8-1-restart-issues-jobs-stopping-prematurely.18270/#post-44746">MPAS-8.1 Restart Issues: Jobs Stopping Prematurely | Jul 18, 2024</a><ul><li>Also, can you <strong>save soil data (i.e., smcrel, sh2o, smois, tslb) at the time of restarting, and compare them with the data in your restart file? I would expect that they should be same</strong>.</li></ul></li></ul>]]></content>
    
    
    <categories>
      
      <category>MPAS</category>
      
    </categories>
    
    
    <tags>
      
      <tag>HPC</tag>
      
      <tag>NWP</tag>
      
      <tag>WRF</tag>
      
      <tag>MPAS</tag>
      
      <tag>Noah surface scheme</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Hexo | Google Analytics 4</title>
    <link href="/2025/04/20/Hexo-Google-Analytics/"/>
    <url>/2025/04/20/Hexo-Google-Analytics/</url>
    
    <content type="html"><![CDATA[<h1 id="google-analytics">Google Analytics</h1><p>Google Analytics 是數百萬個網站和應用程式擁有者的首選平台，可幫助他們深入瞭解網站和應用程式的成效。</p><ul><li><a href="https://developers.google.com/analytics?hl=zh-tw">Google Analytics</a></li><li><a href="https://support.google.com/analytics/answer/10089681?hl=zh-Hant">[GA4] 新一代 Analytics 隆重登場：Google Analytics 4</a></li></ul><p>Google Analytics（谷歌分析）是一款由 Google 提供的專業數據分析工具，旨在幫助網站擁有者及商戶深入了解其網站的流量和用戶行為。它具備多項強大的功能，具體包括：</p><ol type="1"><li><strong>實時數據分析</strong>：<ul><li>能夠即時查看網站的訪問量、活躍用戶及其行為，讓商戶即時掌握網站運行狀況。</li></ul></li><li><strong>流量來源追蹤</strong>：<ul><li>分析訪客的來源，包括自然搜尋、付費廣告、社交媒體及直接訪問等，幫助商戶了解哪些渠道最有效。</li></ul></li><li><strong>用戶行為分析</strong>：<ul><li>追蹤用戶在網站上的行為，包括瀏覽的頁面、停留時間、跳出率等，這些數據有助於優化網站結構和內容。</li></ul></li><li><strong>轉換追蹤</strong>：<ul><li>設定目標並追蹤用戶完成特定行動（如填寫表單、購買產品）的情況，以評估行銷活動的成效。</li></ul></li><li><strong>受眾分析</strong>：<ul><li>提供詳細的用戶資料，包括年齡、性別、地理位置和興趣等，幫助商戶針對特定受眾制定行銷策略。</li></ul></li><li><strong>自訂報告</strong>：<ul><li>用戶可以創建自訂報告，根據特定需求分析數據，這樣能更靈活地獲取所需資訊。</li></ul></li><li><strong>電子商務分析</strong>：<ul><li>專為網上商店設計的功能，可以追蹤產品銷售、收入、交易數量及購物車放棄率等，幫助商戶優化銷售流程。</li></ul></li><li><strong>A/B 測試</strong>：<ul><li>提供測試功能，允許商戶比較不同版本的網頁表現，從而找出最佳設計和內容。</li></ul></li></ol><h1 id="google-analytics-4-ga4">Google Analytics 4 (GA4)</h1><p>GA4 同時支援手機應用程式和網頁，而非好像舊版般，只能分析網頁。其次，GA4 會根據顧客的生命週期分析數據，讓商戶從不同階段，包括商戶開發（Acquisition）、參與（Engagement）、營利（Monetization）和回訪率（Rentention），清楚了解他們的消費行為。</p><h1 id="setup">Setup</h1><div class="group-image-container"><div class="group-image-row"><div class="group-image-wrap"><img src="https://i.imgur.com/5xxIQaJ.png" /></div><div class="group-image-wrap"><img src="https://i.imgur.com/EZLrwHq.png" /></div><div class="group-image-wrap"><img src="https://i.imgur.com/LzNB76k.png" /></div></div><div class="group-image-row"></div></div><h2 id="on-hexo">on Hexo</h2><div class="note note-primary">            <ul><li>copy above code into end of each <code>.ejs</code> file</li></ul>          </div><h1 id="references">References</h1><ol type="1"><li><a href="https://www.boutir.com/zh-hk/academy/google-analytics-4-ga4-basic-setup-upgrade-steps-overview">【網絡營銷知識庫】Google Analytics 4 (GA4) 面世！一文看清基礎設定和升級步驟！</a></li><li><a href="https://ranking.works/knowledge/ga4/">GA4 是什麼？ 5分鐘看懂最完整的 GA4 全解析與新功能設定教學</a></li><li><a href="https://www.kickads.co/zh/google-analytics-4-ga4-essential-guide/">2023 實戰GA4教學：從基礎到高級設定立刻上手Google Analytics 4</a></li><li><a href="https://www.tsg.com.tw/blog-detail2-168-0-ga4.htm">GA4是什麼？Google Analytics 4基本功能介紹篇｜天矽科技客製化網頁設計</a></li></ol>]]></content>
    
    
    <categories>
      
      <category>Hexo</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Hexo</tag>
      
      <tag>github</tag>
      
      <tag>Google Analytics 4</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>MPAS | Mesh Connectivity (graph.info) file for the mesh</title>
    <link href="/2025/04/14/MPAS-Mesh-Connectivity-graph-info-file-for-the-mesh/"/>
    <url>/2025/04/14/MPAS-Mesh-Connectivity-graph-info-file-for-the-mesh/</url>
    
    <content type="html"><![CDATA[<ol type="1"><li><a href="https://mpas-dev.github.io/">https://mpas-dev.github.io/</a></li><li><a href="https://github.com/MPAS-Dev/MPAS-Model/releases">/MPAS-Model/releases</a></li><li><a href="https://www2.mmm.ucar.edu/projects/mpas/mpas_atmosphere_users_guide_4.0.pdf">MPAS-Atmosphere Users' Guide V4.0</a></li><li><a href="https://www2.mmm.ucar.edu/projects/mpas/mpas_atmosphere_users_guide_5.3.pdf">MPAS-Atmosphere Users' Guide V5.3</a></li><li><a href="https://www2.mmm.ucar.edu/projects/mpas/mpas_atmosphere_users_guide_6.3.pdf">MPAS-Atmosphere Users' Guide V6.3</a></li><li><a href="https://www2.mmm.ucar.edu/projects/mpas/mpas_atmosphere_users_guide_7.0.pdf">MPAS-Atmosphere Users' Guide V7.0</a></li><li><a href="https://www2.mmm.ucar.edu/projects/mpas/mpas_atmosphere_users_guide_8.2.0.pdf">MPAS-Atmosphere Users' Guide V8.2.0</a></li><li><a href="https://www.mmm.ucar.edu/events/133129/agenda">Joint WRF/MPAS Users Workshop 2024</a></li></ol><hr /><h1 id="mpas-atmosphere-meshes">MPAS-Atmosphere Meshes</h1><ul><li><a href="https://www2.mmm.ucar.edu/projects/mpas/site/access_code/meshes.html" class="uri">https://www2.mmm.ucar.edu/projects/mpas/site/access_code/meshes.html</a></li></ul><p>Several resolutions of quasi-uniform and refined meshes are available for download. Each mesh download provides the following:</p><ul><li>an SCVT mesh on the unit sphere</li><li><strong>the mesh connectivity (graph.info) file for the mesh</strong></li><li>partitionings of the mesh (e.g., graph.info.part.32) for various MPI task counts</li></ul><p>Additionally, for quasi-uniform meshes, “static” files using the default datasets are available. The static file downloads provide single-precision static files in CDF-5/64-bit data format and mesh connectivity files.</p><h1 id="metis">Metis</h1><p>METIS is a set of serial programs for partitioning graphs, partitioning finite element meshes, and producing fill reducing orderings for sparse matrices. The algorithms implemented in METIS are based on the multilevel recursive-bisection, multilevel k-way, and multi-constraint partitioning schemes developed in our lab.</p><p>Download: - <a href="http://glaros.dtc.umn.edu/gkhome/metis/metis/download" class="uri">http://glaros.dtc.umn.edu/gkhome/metis/metis/download</a></p><p><a href="https://waipangsze.github.io/2024/05/31/MPAS_install_metis_error/"><strong>MPAS | install Metis</strong></a></p><h2 id="gpmetis">gpmetis</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">gpmetis -minconn -contig -niter=200 graph.info &lt;num_core&gt;<br></code></pre></td></tr></table></figure><p>which num_core = 12 or ...</p><h1 id="if-generating-graph.info-for-new-mesh">If generating graph.info for new mesh</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs limited_area/mesh.py">def create_graph_file(self, graphFname):<br>    &quot;&quot;&quot; Create a graph.info file for the current mesh &quot;&quot;&quot;<br><br>    # In the limited_area program, this function will always create<br>    # a graph.info file for a regional mesh. Thus, the variables here<br>    # are not preloaded and are being read from disk<br></code></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs limited_area/limited_area.py">def create_partiton_fname(self, name, mesh, **kwargs):<br>    &quot;&quot;&quot; Generate the filename for the regional graph.info file&quot;&quot;&quot;<br>    return name+&#x27;.graph.info&#x27;<br></code></pre></td></tr></table></figure><h1 id="references">References</h1><ol type="1"><li><a href="https://forum.mmm.ucar.edu/threads/gpmetis-error.19844/#post-48136">gpmetis error | Nov 12, 2024</a><ol type="1"><li>should probably look like <code>512 513 514 509 510 511</code></li><li>Here's the part of the MPAS-Limited-Area tool that should be writing this connectivity info: <a href="https://github.com/MPAS-Dev/MPAS-Limited-Area/blob/v2.1/limited_area/mesh.py#L180-L186">MPAS-Limited-Area/limited_area/mesh.py at v2.1 · MPAS-Dev/MPAS-Limited-Area</a>.</li><li>We've merge changes to support NumPy 2.x into the <a href="https://github.com/MPAS-Dev/MPAS-Limited-Area/pull/47">MPAS-Limited-Area main branch through MPAS-Dev/MPAS-Limited-Area PR #47</a>. Thanks again for finding this issue!</li></ol></li></ol>]]></content>
    
    
    <categories>
      
      <category>MPAS</category>
      
    </categories>
    
    
    <tags>
      
      <tag>HPC</tag>
      
      <tag>NWP</tag>
      
      <tag>WRF</tag>
      
      <tag>MPAS</tag>
      
      <tag>mesh</tag>
      
      <tag>graph.info</tag>
      
      <tag>grid.nc</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>MPAS | Vertical Levels and Heights</title>
    <link href="/2025/04/10/MPAS-Vertical-Levels-and-Heights/"/>
    <url>/2025/04/10/MPAS-Vertical-Levels-and-Heights/</url>
    
    <content type="html"><![CDATA[<p><a href="https://waipangsze.github.io/2025/01/27/WRF-Vertical-Levels-and-Heights/">WRF | Vertical Levels and Heights</a></p><hr /><h1 id="mpass-user-guide">MPAS's user guide</h1><p>A description of the compressible nonhydrostatic atmospheric solver can be found in Skamarock et al, 2012. The fully compressible nonhydrostatic equations are cast in terms of a <strong>geometric-height vertical coordinate</strong>, and the solver makes use of a split-explicit time integration scheme that is described in Klemp et al, 2007. The time-integration scheme employs a 3rd-order Runge-Kutta method, and large time step, for the meteorologically significant modes and a forward-backward method with smaller time steps for the acoustic modes (See Wicker and Skamarock, 2002).</p><h2 id="mathbfc.-2-vertical-grid"><span class="math inline">\(\mathbf{C. 2}\)</span> Vertical grid</h2><p>The vertical coordinate in MPAS-Atmosphere is <span class="math inline">\(\zeta\)</span> and has units of length, where <span class="math inline">\(0\leq\zeta\leq z_{t}\)</span> and <span class="math inline">\(z_{t}\)</span> is the height of the model top. The relationship between the vertical coordinate and height in the physical domain is given as</p><p><span class="math display">\[z=\zeta+Ah_{s}(x,y,\zeta)\]</span></p><p>where <span class="math inline">\((x,y)\)</span> denotes a location on the horizontal mesh and <span class="math inline">\(\zeta\)</span> is the vertical coordinate <span class="math inline">\((\zeta\)</span> is directed radially outward from the surface of the sphere, or perpendicular to the horizontal <span class="math inline">\((x,y)\)</span> plane in a Cartesian coordinate MPAS-A configuration). MPAS-A can be configured with the traditional Gal-Chen and Somerville terrain-following coordinate by setting <span class="math inline">\(h_s(x,y,\zeta)=h(x,y)\)</span> and <span class="math inline">\(A=1-\zeta/z_t\)</span>, where <span class="math inline">\(h(x,y)\)</span> is the terrain height. Alternatively, A can be modified to allow a more rapid or less rapid transition to the constant-height upper boundary condition. Additionally, a constant-height coordinate can be specified at some intermediate <span class="math inline">\({\mathrm{height~below~}}h_{t}.\)</span></p><p>The influence of the terrain on any coordinate surface <span class="math inline">\(\zeta\)</span> can be influenced by the specification of<span class="math inline">\(h_s( x, y, \zeta ) .\)</span> Specifically<span class="math inline">\(, h_s\)</span> can be set such that <span class="math inline">\(h_s( x, y, 0) = h( x, y)\)</span> ( ie. terrain following at the sur- face), and progressively flltered fields o features in the topography are quickly filtered from the coordinate. Example MPAS-A vertical meshes are given in Figure C.4.</p><p>Further information about the vertical coordinate can be found in Klemp, J. B. (2011). A Terrain-Following Coordinate with Smoothed Coordinate Surfaces. Mon.Wea Rev. , 139, 2163$-2169. doi:10.1175/MWR-D-10-05046.1</p><h1 id="differences-between-wrf-and-mpas">Differences between WRF and MPAS</h1><table><thead><tr class="header"><th>WRF</th><th>MPAS</th></tr></thead><tbody><tr class="odd"><td><strong>Pressure-based</strong> terrain-following sigma vertical coordinate</td><td><strong>Height-based</strong> hybrid smoothed terrain-following vertical coordinate</td></tr></tbody></table><div class="group-image-container"><div class="group-image-row"><div class="group-image-wrap"><img src="https://i.imgur.com/ueKU0IE.png" /></div></div><div class="group-image-row"><div class="group-image-wrap"><img src="https://i.imgur.com/SVeBD3M.png" /></div><div class="group-image-wrap"><img src="https://i.imgur.com/Wowl0HL.png" /></div></div></div><h1 id="literature-review">Literature Review</h1><ul><li><a href="https://journals.ametsoc.org/view/journals/mwre/147/7/mwr-d-19-0043.1.xml">Skamarock, W. C., C. Snyder, J. B. Klemp, and S. Park, 2019: Vertical Resolution Requirements in Atmospheric Simulation. Mon. Wea. Rev., 147, 2641–2656, https://doi.org/10.1175/MWR-D-19-0043.1.</a></li></ul><h1 id="mpasv8.1.0">MPASv8.1.0</h1><h2 id="separate-stream-for-invariant-fields">Separate Stream for Invariant Fields</h2><p><strong>By default, the MPAS-Atmosphere model reads time-invariant fields (e.g., latCell, lonCell, areaCell, <span class="math inline">\(\mathbf{zgrid,zz,etc.)}\)</span> from the“input”and“restart" streams (for cold-start and restart runs, respectively), and it writes time-invariant fields to the “restart” stream.</strong> In the case of large ensembles, the time-invariant fields that are replicated in the restart files for all ensemble members can account for a substantial amount of storage. In principle, since these time-invariant fields do not change in time or across ensemble members, only one copy of these felds needs to be stored. <strong>MPAS-Atmosphere v8.1.0 introduces a capability to omit time-invariant fields from model restart files. When the model restarts, a new “invariant" stream may be used to read time-invariant fields from a separate file, and many ensemble members can share this file.</strong> In order to make use of the new“invariant" stream, several changes to the standard MPAS-Atmosphere workflow are needed.</p><h2 id="preparing-an-invariant-file">Preparing an Invariant File</h2><p>Through the use of the init atmosphere model program, a file containing all required time-invariant fields must be prepared. Of course, since the model initial conditions (typically referred to as the init.nc file) file contains time-invariant felds, the initial conditions file from any ensemble member may be used. If a file containing purely time-invariant fields is desired, the output from the <strong>init_atmosphere_model</strong> program after the following pre-processing stages have been run will suffice:</p><ul><li><strong>config_static_interp = true</strong></li><li><strong>config_native_gwd_static = true</strong></li><li><strong>config-vertical-grid = true</strong></li></ul><blockquote><p><strong>Note that the pre-processing stages do not need to be run all at once. It is possible, for example, to first produce a static.nc file using the first two of these pre-processing stages, and to then produce an invariant file (e.g., invariant.nc) by running the vertical grid generation stage using the static.nc file as input.</strong></p></blockquote><h2 id="activating-the-invariant-stream">Activating the Invariant Stream</h2><p>When running the model itself (atmosphere model), the use of the new invariant stream may be activated by simply defining the "invariant" immutable stream in the streams.atmosphere file as follows:</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">immutable_stream</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;invariant&quot;</span></span><br><span class="hljs-tag">                  <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;input&quot;</span></span><br><span class="hljs-tag">                  <span class="hljs-attr">filename_template</span>=<span class="hljs-string">&quot;invariant.nc&quot;</span></span><br><span class="hljs-tag">                  <span class="hljs-attr">input_interval</span>=<span class="hljs-string">&quot;initial_only&quot;</span> /&gt;</span><br></code></pre></td></tr></table></figure><p>In the definition of the <strong>"invariant" stream</strong>, the filename_template attribute should be set to the actual name of the invariant file.</p><p><strong>By the existence of the "invariant" stream in the streams.atmosphere file, the model will omit all time-invariant fields from any restart files that are written. When the model restarts, all time-invariant fields will be read from the "invariant" stream rather than from the "restart" stream.</strong></p><ul><li><strong>invariant.nc</strong></li></ul>    <div class="fold">      <div class="fold-title fold-info collapsed" data-toggle="collapse" href="#collapse-dcdac752" role="button" aria-expanded="false" aria-controls="collapse-dcdac752">        <div class="fold-arrow">▶</div>namelist.init_atmosphere      </div>      <div class="fold-collapse collapse" id="collapse-dcdac752">        <div class="fold-content">          <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs namelist.init_atmosphere">&amp;nhyd_model<br>    config_init_case = 7<br>/<br><br>&amp;dimensions<br>    config_nvertlevels = 55<br>    config_nsoillevels = 1<br>    config_nfglevels = 1<br>    config_nfgsoillevels = 1<br>/<br>&amp;data_sources<br>config_geog_data_path = &#x27;/EM/emsdm/data/geog&#x27;<br>    config_landuse_data = &#x27;MODIFIED_IGBP_MODIS_NOAH&#x27;<br>/<br><br>&amp;vertical_grid<br>    config_ztop = 30000.0<br>    config_nsmterrain = 1<br>    config_smooth_surfaces = true<br>    config_dzmin = 0.3<br>    config_nsm = 30<br>    config_tc_vertical_grid = true<br>    config_blend_bdy_terrain = false<br>    config_specified_zeta_levels = &#x27;z166m_zeta_levels.txt&#x27; !--&#x27;default_zeta_levels.txt&#x27;<br>/<br><br>&amp;interpolation_control<br>    config_extrap_airtemp = &#x27;linear&#x27;<br>/<br><br>&amp;preproc_stages<br>    config_static_interp = false<br>    config_native_gwd_static = false<br>    config_vertical_grid = true<br>    config_met_interp = false<br>    config_input_sst = false<br>    config_frac_seaice = false<br>/<br><br>&amp;io<br>    config_pio_num_iotasks = 0<br>    config_pio_stride = 1<br>/<br><br>&amp;decomposition<br>   config_block_decomp_file_prefix = &#x27;graph.info.part.&#x27;<br>/<br></code></pre></td></tr></table></figure>        </div>      </div>    </div><ul><li><strong>restart.nc</strong><ul><li>atm/streams.atmosphere</li><li>setup the restart interval</li></ul></li></ul>    <div class="fold">      <div class="fold-title fold-info collapsed" data-toggle="collapse" href="#collapse-6ae3e036" role="button" aria-expanded="false" aria-controls="collapse-6ae3e036">        <div class="fold-arrow">▶</div>streams.atmosphere      </div>      <div class="fold-collapse collapse" id="collapse-6ae3e036">        <div class="fold-content">          <figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">streams</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">immutable_stream</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;input&quot;</span></span><br><span class="hljs-tag">                  <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;input&quot;</span></span><br><span class="hljs-tag">                  <span class="hljs-attr">io_type</span>=<span class="hljs-string">&quot;pnetcdf,cdf5&quot;</span></span><br><span class="hljs-tag">                  <span class="hljs-attr">filename_template</span>=<span class="hljs-string">&quot;MPAS-120km-MPASv822_2022063000.init.nc&quot;</span></span><br><span class="hljs-tag">                  <span class="hljs-attr">input_interval</span>=<span class="hljs-string">&quot;initial_only&quot;</span> /&gt;</span><br><br><span class="hljs-tag">&lt;<span class="hljs-name">immutable_stream</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;restart&quot;</span></span><br><span class="hljs-tag">                  <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;input;output&quot;</span></span><br><span class="hljs-tag">                  <span class="hljs-attr">io_type</span>=<span class="hljs-string">&quot;pnetcdf,cdf5&quot;</span></span><br><span class="hljs-tag">                  <span class="hljs-attr">filename_template</span>=<span class="hljs-string">&quot;restart.$Y-$M-$D_$h.$m.$s.nc&quot;</span></span><br><span class="hljs-tag">                  <span class="hljs-attr">input_interval</span>=<span class="hljs-string">&quot;initial_only&quot;</span></span><br><span class="hljs-tag">                  <span class="hljs-attr">output_interval</span>=<span class="hljs-string">&quot;01:00:00&quot;</span> /&gt;</span><br><br><span class="hljs-tag">&lt;<span class="hljs-name">immutable_stream</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;invariant&quot;</span></span><br><span class="hljs-tag"><span class="hljs-attr">type</span>=<span class="hljs-string">&quot;input&quot;</span></span><br><span class="hljs-tag"><span class="hljs-attr">filename_template</span>=<span class="hljs-string">&quot;invariant.nc&quot;</span></span><br><span class="hljs-tag"><span class="hljs-attr">io_type</span>=<span class="hljs-string">&quot;pnetcdf,cdf5&quot;</span> </span><br><span class="hljs-tag"><span class="hljs-attr">input_interval</span>=<span class="hljs-string">&quot;initial_only&quot;</span> /&gt;</span><br><br><span class="hljs-tag">&lt;<span class="hljs-name">immutable_stream</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;lbc_in&quot;</span></span><br><span class="hljs-tag">                  <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;input&quot;</span></span><br><span class="hljs-tag">                  <span class="hljs-attr">io_type</span>=<span class="hljs-string">&quot;netcdf4&quot;</span></span><br><span class="hljs-tag">                  <span class="hljs-attr">filename_template</span>=<span class="hljs-string">&quot;lbc.$Y-$M-$D_$h.$m.$s.nc&quot;</span></span><br><span class="hljs-tag">                  <span class="hljs-attr">filename_interval</span>=<span class="hljs-string">&quot;input_interval&quot;</span></span><br><span class="hljs-tag">                  <span class="hljs-attr">packages</span>=<span class="hljs-string">&quot;limited_area&quot;</span></span><br><span class="hljs-tag">                  <span class="hljs-attr">input_interval</span>=<span class="hljs-string">&quot;none&quot;</span> /&gt;</span><br><br><span class="hljs-tag">&lt;<span class="hljs-name">stream</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;surface&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;input&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">io_type</span>=<span class="hljs-string">&quot;netcdf4&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">filename_template</span>=<span class="hljs-string">&quot;sst.$Y-$M-$D_$h.$m.$s.nc&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">input_interval</span>=<span class="hljs-string">&quot;none&quot;</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">file</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;stream_list.atmosphere.surface&quot;</span>/&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">stream</span>&gt;</span><br><br><span class="hljs-tag">&lt;<span class="hljs-name">stream</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;mesh&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;output&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">filename_template</span>=<span class="hljs-string">&quot;mesh.nc&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">output_interval</span>=<span class="hljs-string">&quot;initial_only&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">io_type</span>=<span class="hljs-string">&quot;pnetcdf,cdf5&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">clobber_mode</span>=<span class="hljs-string">&quot;replace_files&quot;</span> &gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">file</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;stream_list.atmosphere.mesh&quot;</span>/&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">stream</span>&gt;</span><br><br><span class="hljs-tag">&lt;<span class="hljs-name">stream</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;output&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;output&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">filename_template</span>=<span class="hljs-string">&quot;output.$Y-$M-$D_$h.$m.$s.nc&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">output_interval</span>=<span class="hljs-string">&quot;none&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">io_type</span>=<span class="hljs-string">&quot;pnetcdf,cdf5&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">clobber_mode</span>=<span class="hljs-string">&quot;replace_files&quot;</span> &gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">file</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;stream_list.atmosphere.output&quot;</span>/&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">stream</span>&gt;</span><br><br><span class="hljs-tag">&lt;<span class="hljs-name">stream</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;diagnostics&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;output&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">io_type</span>=<span class="hljs-string">&quot;pnetcdf,cdf5&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">filename_template</span>=<span class="hljs-string">&quot;diag.$Y-$M-$D_$h.$m.$s.nc&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">output_interval</span>=<span class="hljs-string">&quot;01:00:00&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">clobber_mode</span>=<span class="hljs-string">&quot;replace_files&quot;</span> &gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">file</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;stream_list.atmosphere.diagnostics&quot;</span>/&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">stream</span>&gt;</span><br><br><span class="hljs-tag">&lt;/<span class="hljs-name">streams</span>&gt;</span><br></code></pre></td></tr></table></figure>        </div>      </div>    </div><figure class="highlight console"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs console">- MPAS-120km<br><br>/static/<br>    78M static.nc<br>/invariant/<br>    230M invariant.nc<br>/init/<br>    348M init.nc (still includes zgrid...)<br>/atm/<br>    798M default_restart.nc<br>    578M restart.nc<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>MPAS</category>
      
    </categories>
    
    
    <tags>
      
      <tag>HPC</tag>
      
      <tag>NWP</tag>
      
      <tag>WRF</tag>
      
      <tag>MPAS</tag>
      
      <tag>UCM</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>NWP | Herbie | Download NWP model output (grib2) | MPAS | WRF</title>
    <link href="/2025/04/10/NWP-Herbie-Download-NWP-model-output-MPAS-WRF/"/>
    <url>/2025/04/10/NWP-Herbie-Download-NWP-model-output-MPAS-WRF/</url>
    
    <content type="html"><![CDATA[<h1 id="herbie">Herbie</h1><p>Herbie is a python package that <strong>downloads recent and archived numerical weather prediction (NWP) model output from different cloud archive sources</strong>. NWP data is distributed in GRIB2 format which Herbie reads using xarray+cfgrib. Herbie also provides some extra features to help visualize and extract data.</p><ul><li><a href="https://pypi.org/project/herbie-data/" class="uri">https://pypi.org/project/herbie-data/</a></li></ul><p>Herbie helps you discover, download, and read data from:</p><ul><li>High Resolution Rapid Refresh (HRRR) | HRRR-Alaska</li><li>Rapid Refresh (RAP)</li><li><strong>Global Forecast System (GFS)</strong></li><li><strong>Global Ensemble Forecast System (GEFS)</strong></li><li><strong>ECMWF Open Data Forecasts (IFS and AIFS)</strong></li><li><strong>Navy Global Environmental Model (NAVGEM)</strong></li><li>North American Mesoscale Model (NAM)</li><li>National Blend of Models (NBM)</li><li>Rapid Refresh Forecast System (RRFS) prototype</li><li>Real-Time/Un-Restricted Mesoscale Analysis (RTMA/URMA)</li><li>Hurricane Analysis And Forecast System (HAFS)</li><li>High Resolution Deterministic Prediction System (HRDPS)</li><li>Climate Forecast System (CFS)</li></ul><p>and more! Check out the <a href="https://herbie.readthedocs.io/en/latest/gallery/index.html">gallery</a>.</p><h1 id="installation">Installation</h1><figure class="highlight console"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs console">conda install -c conda-forge herbie-data<br></code></pre></td></tr></table></figure><h1 id="capabilities">Capabilities</h1><ul><li><strong>Search for model output</strong> from different data sources.</li><li>Download <strong>full GRIB2 files</strong>.</li><li>Download <strong>subset GRIB2 files (by grib field)</strong>.</li><li><strong>Read data with xarray.</strong></li><li>Read index file with Pandas.</li><li>Extra features (herbie xarray accessors)<ul><li>Extract data at a point</li><li>Get Cartopy coordinate references system</li><li>Plot data with Cartopy (very early development).</li></ul></li></ul><h1 id="examples">Examples</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> herbie <span class="hljs-keyword">import</span> Herbie<br><br><span class="hljs-comment"># Herbie object for the HRRR model 6-hr surface forecast product</span><br>H = Herbie(<br>  <span class="hljs-string">&#x27;2021-01-01 12:00&#x27;</span>,<br>  model=<span class="hljs-string">&#x27;hrrr&#x27;</span>,<br>  product=<span class="hljs-string">&#x27;sfc&#x27;</span>,<br>  fxx=<span class="hljs-number">6</span><br>)<br><br><span class="hljs-comment"># Look at file contents</span><br>H.inventory()<br><br><span class="hljs-comment"># Download the full GRIB2 file</span><br>H.download()<br><br><span class="hljs-comment"># Download a subset, like all fields at 500 mb</span><br>H.download(<span class="hljs-string">&quot;:500 mb&quot;</span>)<br><br><span class="hljs-comment"># Read subset with xarray, like 2-m temperature.</span><br>H.xarray(<span class="hljs-string">&quot;TMP:2 m&quot;</span>)<br></code></pre></td></tr></table></figure><h2 id="ifsaifs">IFS/AIFS</h2><ul><li><a href="https://herbie.readthedocs.io/en/latest/gallery/ecmwf_models/ecmwf.html" class="uri">https://herbie.readthedocs.io/en/latest/gallery/ecmwf_models/ecmwf.html</a></li></ul><div class="note note-primary">            <p>IFS data is only available at 0.4 degree prior to <strong>February 1, 2024. After that date, the IFS is available at 0.25 degree resolution.</strong></p>          </div><p>ECMWF provides data for two different models</p><ul><li><strong>model="ifs"</strong> ECMWF Integrated Forecast System</li><li><strong>model="aifs"</strong> ECMWF Artificial Intelligence Integrated Forecast System</li></ul><table><thead><tr class="header"><th>prioriy</th><th>Data source</th><th>Archive Duration</th></tr></thead><tbody><tr class="odd"><td>"ecmwf"</td><td>ECMWF Open Data Server</td><td>last 4 days</td></tr><tr class="even"><td>"azure"</td><td>Microsoft Azure</td><td>2022-01-21 to present</td></tr><tr class="odd"><td>"aws"</td><td>Amazon Web Services</td><td>2023-01-18 to present</td></tr></tbody></table><table><thead><tr class="header"><th>product=</th><th>Product Description</th><th>Available model runs</th></tr></thead><tbody><tr class="odd"><td>"oper"</td><td>operational high-resolution forecast, atmospheric fields</td><td>00z, 12z,</td></tr><tr class="even"><td>"wave"</td><td>wave forecasts</td><td>00z, 12z,</td></tr><tr class="odd"><td>"scda"</td><td>short cut-off high-resolution forecast, atmospheric fields (also known a high-frequency products)”,</td><td>06z, 18z</td></tr><tr class="even"><td>"scwv"</td><td>short cut-off high-resolution forecast, ocean wave fields (also known a high-frequency products)”,</td><td>06z, 18z</td></tr><tr class="odd"><td>"enfo"</td><td>ensemble forecast, atmospheric fields</td><td>00z, 06z, 12z, 18z</td></tr><tr class="even"><td>"waef"</td><td>ensemble forecast, ocean wave fields,</td><td>00z, 06z, 12z, 18z</td></tr><tr class="odd"><td>"mmsf"</td><td>multi-model seasonal forecasts fields from the ECMWF model only.</td><td>?</td></tr></tbody></table><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-meta">#!/bin/bash</span><br><br><span class="hljs-built_in">source</span> /home/wpsze/micromamba/etc/profile.d/micromamba.sh<br>micromamba activate herbie-data<br><br>time python main_herbie.py<br></code></pre></td></tr></table></figure><ul><li><code>$ time python main_herbie.py</code></li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> herbie <span class="hljs-keyword">import</span> Herbie<br><br><span class="hljs-keyword">import</span> cartopy.crs <span class="hljs-keyword">as</span> ccrs<br><span class="hljs-keyword">import</span> matplotlib.pyplot <span class="hljs-keyword">as</span> plt<br><span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np<br><br><span class="hljs-keyword">from</span> herbie <span class="hljs-keyword">import</span> paint<br><span class="hljs-keyword">from</span> herbie.toolbox <span class="hljs-keyword">import</span> EasyMap, pc<br><br><span class="hljs-keyword">from</span> datetime <span class="hljs-keyword">import</span> date, timedelta<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">daterange</span>(<span class="hljs-params">start_date: date, end_date: date</span>):<br>    days = <span class="hljs-built_in">int</span>((end_date - start_date).days)<br>    <span class="hljs-keyword">for</span> n <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(days):<br>        <span class="hljs-keyword">yield</span> start_date + timedelta(n)<br><br>start_date = date(<span class="hljs-number">2013</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>)<br>end_date = date(<span class="hljs-number">2013</span>, <span class="hljs-number">1</span>, <span class="hljs-number">6</span>)<br><span class="hljs-keyword">for</span> single_date <span class="hljs-keyword">in</span> daterange(start_date, end_date):<br>    tmp = <span class="hljs-built_in">str</span>(single_date.strftime(<span class="hljs-string">&quot;%Y-%m-%d&quot;</span>)) +<span class="hljs-string">&quot; 00:00:00&quot;</span><br>    tmp_save_fd = tmp[:<span class="hljs-number">4</span>]+tmp[<span class="hljs-number">5</span>:<span class="hljs-number">7</span>]+tmp[<span class="hljs-number">8</span>:<span class="hljs-number">10</span>]<br>    <span class="hljs-built_in">print</span>(tmp, tmp_save_fd)<br>    H = Herbie(tmp, model=<span class="hljs-string">&quot;ifs&quot;</span>, product=<span class="hljs-string">&quot;oper&quot;</span>) <span class="hljs-comment">#, fxx=12)</span><br>    H.inventory()<br>    H.inventory().param.unique()<br>    H.download(save_dir=<span class="hljs-string">&quot;/home/wpsze/mpas/IFS/herbie/&quot;</span>)<br><br><span class="hljs-comment">#H = Herbie(&quot;2024-03-01 00:00:00&quot;, model=&quot;ifs&quot;, product=&quot;oper&quot;, fxx=12)</span><br><span class="hljs-comment">#H = Herbie(&quot;2024-04-01 12:00:00&quot;, model=&quot;ifs&quot;, product=&quot;oper&quot;) #, fxx=12) # 00/12 UTC</span><br><span class="hljs-comment">#H.grib, H.idx</span><br><br><span class="hljs-comment">#-- Show the inventory</span><br><span class="hljs-comment">#H.inventory()</span><br><span class="hljs-comment">#H.inventory().param.unique()</span><br><br><span class="hljs-comment">#-- Show the search_help</span><br><span class="hljs-comment">#print(H.search_help)</span><br><br><span class="hljs-comment">#-- Show just 10-m U and V wind</span><br><span class="hljs-comment">#H.inventory(&quot;:10[u|v]:&quot;)</span><br><br><span class="hljs-comment">#-- Download the full GRIB2 file</span><br><span class="hljs-comment">#-- overwrite (bool) – If True, overwrite existing files. Default will skip downloading if the full file exists. Not applicable when when search is not None because file subsets might be unique.</span><br><span class="hljs-comment">#H.download(save_dir=&quot;/home/wpsze/mpas/IFS/herbie/&quot;)</span><br><span class="hljs-comment">#-- result: PosixPath(&#x27;/home/wpsze/mpas/IFS/herbie/ifs/20240301/20240301000000-12h-oper-fc.grib2&#x27;)</span><br><br><span class="hljs-comment">#-- Get 2-m temperature as an xarray Dataset</span><br><span class="hljs-comment">#ds = H.xarray(&quot;:2t:&quot;, verbose=True)</span><br><span class="hljs-comment">#ds.t2m.plot(cmap=&quot;Spectral_r&quot;, figsize=[8, 4])</span><br></code></pre></td></tr></table></figure><p><img src="https://i.imgur.com/o1xSqZN.png" /> <img src="https://i.imgur.com/dPlkBuU.png" /> <img src="https://i.imgur.com/vCWDYAP.png" /></p>    <div class="fold">      <div class="fold-title fold-info collapsed" data-toggle="collapse" href="#collapse-05eef982" role="button" aria-expanded="false" aria-controls="collapse-05eef982">        <div class="fold-arrow">▶</div>H.search_help      </div>      <div class="fold-collapse collapse" id="collapse-05eef982">        <div class="fold-content">          <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><code class="hljs log">Use regular expression to search for lines in the index file.<br>Here are some examples you can use for the ecCodes-style `search`<br><br>Look at the ECMWF GRIB Parameter Database<br>https://apps.ecmwf.int/codes/grib/param-db<br><br><br>product=`oper` or `enfo`<br>======================== ==============================================<br>search=                  GRIB messages that will be downloaded<br>======================== ==============================================<br>&quot;:2t:&quot;                   2-m temperature<br>&quot;:2d:&quot;                   2-m dew point temperature<br>&quot;:10u:&quot;                  10-m u wind vector<br>&quot;:10v:&quot;                  10-m v wind vector<br>&quot;:10[uv]:                10-m u and 10-m v wind<br>&quot;:[tuvr]:&quot;               Temp, u/v wind, RH (all levels)<br>&quot;:500:&quot;                  All variables on the 500 hPa level<br>&quot;:gh:500&quot;                Geopotential height only at 500 hPa<br>&quot;:gh:&quot;                   Geopotential height (all pressure levels)<br>&quot;:t:&quot;                    Temperature (all pressure levels)<br>&quot;:q:&quot;                    Specific Humidity (all pressure levels)<br>&quot;:r:&quot;                    Relative humidity (all pressure levels)<br>&quot;:v:&quot;                    v wind vector (all pressure levels)<br>&quot;:u:&quot;                    u wind vector (all pressure levels)<br>&quot;:w:&quot;                    Vertical velocity (Pascals per second)<br>&quot;:lsm:&quot;                  Land-sea mask<br>&quot;:ttr:&quot;                  Top net long-wave (thermal) radiation<br>&quot;:ssrd:&quot;                 Surface short-wave (solar) radiation downwards<br>&quot;:ssr:&quot;                  Surface net short-wave (solar) radiation<br>&quot;:strd:&quot;                 Surface long-wave (thermal) radiation downwards<br>&quot;:str:&quot;                  Surface net long-wave (thermal) radiation<br>&quot;:swvl1:&quot;                Volumetric soil water layer 1 (depth 0 meters)<br>&quot;:swvl2:&quot;                Volumetric soil water layer 2 (depth 7 meters)<br>&quot;:swvl3:&quot;                Volumetric soil water layer 3 (depth 28 meters)<br>&quot;:swvl4:&quot;                Volumetric soil water layer 4 (depth 100 meters)<br>&quot;:skt:&quot;                  Skin (surface) temperature<br>&quot;:d:&quot;                    Divergence (all levels)<br>&quot;:st:&quot;                   Soil temperature<br>&quot;:stl2:&quot;                 Soil temperature level 2 (depth 7 meters)<br>&quot;:tp:&quot;                   Total precipitation<br>&quot;:ro:&quot;                   Run-off<br>&quot;:asn:&quot;                  Snow albedo<br>&quot;:msl:&quot;                  Mean sea level pressure<br>&quot;:sp:&quot;                   Surface pressure<br>&quot;:cape:&quot;                 CAPE<br>&quot;:tcwv:&quot;                 Total column vertically integrated water vapor<br>&quot;:vo:&quot;                   Relative vorticity<br><br>product=`wave` or `waef`<br>======================== ==============================================<br>search=                  GRIB messages that will be downloaded<br>======================== ==============================================<br>&quot;:swh:&quot;                  Significant height of wind waves + swell<br>&quot;:mwp:&quot;                  Mean wave period<br>&quot;:mwd:&quot;                  Mean wave direction<br>&quot;:pp1d:&quot;                 Peak wave period<br>&quot;:mp2:&quot;                  Mean zero-crossing wave period<br><br>If you need help with regular expression, search the web or look at<br>this cheatsheet: https://www.petefreitag.com/cheatsheets/regex/.<br><br>Here is an example: https://regex101.com/r/niNjwp/1<br></code></pre></td></tr></table></figure>        </div>      </div>    </div><h3 id="problem">Problem</h3><ul><li>The grib files from <code>ecmwf.ini</code> and from <code>aws</code> are different. It will make different/debug on the <code>ungrib</code> step and <code>init_atmosphere_model</code> step.<ul><li>Not all different.</li></ul></li></ul><p>It is because,</p><ul><li><a href="https://developers.google.com/earth-engine/datasets/catalog/ECMWF_NRT_FORECAST_IFS_OPER?hl=zh-TW">ECMWF Near-Realtime IFS Atmospheric Forecasts | Earth Engine Data Catalog</a><ul><li><strong>資料集可用性 2024-11-12T12:00:00Z–2025-04-16T12:00:00Z</strong></li><li><strong>自 2024/11/12 推出Cycle 49r1 以來</strong>，Earth Engine 就會提供產品；早期產品則不包含在內。<ul><li>old one: 145 items</li><li>new one: 160 items</li></ul></li></ul></li></ul><p><img src="https://i.imgur.com/Ox9xzuB.png" alt="IFS:2024-04-26_00.nc" /> <img src="https://i.imgur.com/nr6Nkjg.png" alt="IFS:2025-03-26_00.nc" /></p><h2 id="gfs">GFS</h2><ul><li><a href="https://herbie.readthedocs.io/en/latest/gallery/noaa_models/gfs.html" class="uri">https://herbie.readthedocs.io/en/latest/gallery/noaa_models/gfs.html</a></li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> herbie <span class="hljs-keyword">import</span> Herbie<br><span class="hljs-keyword">from</span> herbie.toolbox <span class="hljs-keyword">import</span> EasyMap, pc, ccrs<br><span class="hljs-keyword">from</span> herbie <span class="hljs-keyword">import</span> paint<br><br><span class="hljs-keyword">import</span> matplotlib.pyplot <span class="hljs-keyword">as</span> plt<br><br>H = Herbie(<span class="hljs-string">&quot;2021-07-11&quot;</span>, model=<span class="hljs-string">&quot;gfs&quot;</span>, product=<span class="hljs-string">&quot;pgrb2.0p25&quot;</span>)<br><br><span class="hljs-comment"># Show all available sources</span><br>H.SOURCES<br><br><span class="hljs-comment"># Show all available products</span><br>H.PRODUCTS<br><br><span class="hljs-comment"># Download the full GRIB2 file</span><br>H.download()<br><br><span class="hljs-comment"># Plot t2m</span><br>ds = H.xarray(<span class="hljs-string">&quot;:TMP:2 m above&quot;</span>)<br><br>ax = EasyMap(crs=ds.herbie.crs, figsize=[<span class="hljs-number">10</span>, <span class="hljs-number">8</span>]).ax<br>p = ax.pcolormesh(<br>    ds.longitude,<br>    ds.latitude,<br>    ds.t2m - <span class="hljs-number">273.15</span>,<br>    transform=pc,<br>    **paint.NWSTemperature.kwargs2,<br>)<br>plt.colorbar(<br>    p, ax=ax, orientation=<span class="hljs-string">&quot;horizontal&quot;</span>, pad=<span class="hljs-number">0.05</span>, **paint.NWSTemperature.cbar_kwargs2<br>)<br><br>ax.set_title(ds.t2m.GRIB_name, loc=<span class="hljs-string">&quot;right&quot;</span>)<br>ax.set_title(<span class="hljs-string">f&quot;<span class="hljs-subst">&#123;ds.model.upper()&#125;</span>: <span class="hljs-subst">&#123;H.product_description&#125;</span>&quot;</span>, loc=<span class="hljs-string">&quot;left&quot;</span>)<br></code></pre></td></tr></table></figure><h2 id="gfs-wave-data">GFS wave data</h2><ul><li><a href="https://herbie.readthedocs.io/en/latest/gallery/noaa_models/gfs.html#GFS-wave-data" class="uri">https://herbie.readthedocs.io/en/latest/gallery/noaa_models/gfs.html#GFS-wave-data</a></li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> herbie <span class="hljs-keyword">import</span> Herbie<br><span class="hljs-keyword">from</span> herbie.toolbox <span class="hljs-keyword">import</span> EasyMap, pc, ccrs<br><span class="hljs-keyword">from</span> herbie <span class="hljs-keyword">import</span> paint<br><br><span class="hljs-keyword">import</span> matplotlib.pyplot <span class="hljs-keyword">as</span> plt<br><br>H = Herbie(<span class="hljs-string">&quot;2021-07-11&quot;</span>, model=<span class="hljs-string">&quot;gfs_wave&quot;</span>)<br><br>H.inventory()<br></code></pre></td></tr></table></figure><h2 id="gefs">GEFS</h2><ul><li><a href="https://herbie.readthedocs.io/en/latest/gallery/noaa_models/gefs.html" class="uri">https://herbie.readthedocs.io/en/latest/gallery/noaa_models/gefs.html</a></li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> herbie <span class="hljs-keyword">import</span> Herbie<br><span class="hljs-keyword">from</span> herbie.toolbox <span class="hljs-keyword">import</span> EasyMap, pc<br><span class="hljs-keyword">from</span> herbie <span class="hljs-keyword">import</span> paint<br><br><span class="hljs-keyword">import</span> matplotlib.pyplot <span class="hljs-keyword">as</span> plt<br><br>H = Herbie(<br>    <span class="hljs-string">&quot;2023-01-04 12:00&quot;</span>,<br>    model=<span class="hljs-string">&quot;gefs&quot;</span>,<br>    product=<span class="hljs-string">&quot;atmos.5&quot;</span>,<br>    member=<span class="hljs-string">&quot;mean&quot;</span>,<br>)<br><br>H<br><br><span class="hljs-comment"># Show all the available products (from the model template file)</span><br>H.PRODUCTS<br><br>df = H.inventory()<br>df<br><br>df.variable.unique()<br><br>H.inventory(<span class="hljs-string">&quot;HGT&quot;</span>)<br><br>ds = H.xarray(<span class="hljs-string">&quot;PWAT&quot;</span>)<br>ds<br><br>ds2 = H.xarray(<span class="hljs-string">&quot;HGT:500 mb&quot;</span>)<br>ds2<br><br>ax = EasyMap(<span class="hljs-string">&quot;50m&quot;</span>, crs=ds.herbie.crs, figsize=[<span class="hljs-number">10</span>, <span class="hljs-number">10</span>]).STATES().BORDERS().ax<br>p = ax.pcolormesh(<br>    ds.longitude,<br>    ds.latitude,<br>    ds.pwat,<br>    transform=pc,<br>    cmap=paint.NWSPrecipitation.cmap,<br>    vmin=<span class="hljs-number">0</span>,<br>    vmax=<span class="hljs-number">80</span>,<br>)<br>plt.colorbar(<br>    p,<br>    ax=ax,<br>    orientation=<span class="hljs-string">&quot;horizontal&quot;</span>,<br>    pad=<span class="hljs-number">0.01</span>,<br>    shrink=<span class="hljs-number">0.8</span>,<br>    label=<span class="hljs-string">f&quot;<span class="hljs-subst">&#123;ds.pwat.GRIB_name&#125;</span>(<span class="hljs-subst">&#123;ds.pwat.GRIB_units&#125;</span>)&quot;</span>,<br>)<br><br><span class="hljs-comment"># Add 500 hPa Geopotential height</span><br>ax.contour(<br>    ds2.longitude,<br>    ds2.latitude,<br>    ds2.gh,<br>    colors=<span class="hljs-string">&quot;k&quot;</span>,<br>    linewidths=<span class="hljs-number">0.5</span>,<br>    levels=<span class="hljs-built_in">range</span>(<span class="hljs-number">0</span>, <span class="hljs-number">10000</span>, <span class="hljs-number">120</span>),<br>)<br><br>ax.set_title(<br>    <span class="hljs-string">f&quot;<span class="hljs-subst">&#123;ds.model.upper()&#125;</span> ensemble mean\nValid: <span class="hljs-subst">&#123;ds.valid_time.dt.strftime(<span class="hljs-string">&#x27;%H:%M UTC %d %b %Y&#x27;</span>).item()&#125;</span>&quot;</span>,<br>    loc=<span class="hljs-string">&quot;left&quot;</span>,<br>)<br>ax.set_title(ds.pwat.GRIB_name, loc=<span class="hljs-string">&quot;right&quot;</span>)<br><br><span class="hljs-comment"># Get a specific member</span><br>H5 = Herbie(<br>    <span class="hljs-string">&quot;2022-01-01&quot;</span>,<br>    model=<span class="hljs-string">&quot;gefs&quot;</span>,<br>    product=<span class="hljs-string">&quot;atmos.5&quot;</span>,<br>    member=<span class="hljs-number">5</span>,<br>)<br>H5.xarray(<span class="hljs-string">&quot;TMP:2 m&quot;</span>)<br><br><span class="hljs-comment">## If a user wants all the members in</span><br><span class="hljs-comment">## a single Dataframe, I&#x27;ll let the user</span><br><span class="hljs-comment">## concat it themselves.</span><br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>NWP</category>
      
    </categories>
    
    
    <tags>
      
      <tag>NWP</tag>
      
      <tag>WRF</tag>
      
      <tag>WPS</tag>
      
      <tag>MPAS</tag>
      
      <tag>IFS</tag>
      
      <tag>GFS</tag>
      
      <tag>GEFS</tag>
      
      <tag>AIFS</tag>
      
      <tag>grib</tag>
      
      <tag>grib2</tag>
      
      <tag>ungrib</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>NWP | Eddy Dissipation Rate (EDR)</title>
    <link href="/2025/04/08/Eddy-Dissipation-Rate-EDR/"/>
    <url>/2025/04/08/Eddy-Dissipation-Rate-EDR/</url>
    
    <content type="html"><![CDATA[<h1 id="eddy-dissipation-rate-edr">Eddy Dissipation Rate (EDR)</h1><p><strong>Eddy Dissipation Rate (EDR)</strong> is a measure of atmospheric turbulence intensity, quantifying how quickly turbulent kinetic energy (TKE) is dissipated in the atmosphere. It is an aircraft-independent metric used by aviation to assess turbulence severity.</p><h2 id="definition-and-units">Definition and Units</h2><ul><li><strong>EDR</strong> is defined as the <strong>cube root of the dissipation rate of TKE</strong>, with units of <span class="math inline">\(m^{2/3} s^{-1}\)</span>.</li><li>However, in some contexts, EDR is expressed in <span class="math inline">\(m^2/s^3\)</span> when referring to the dissipation rate itself before taking the cube root.</li></ul><h2 id="equation-formula">Equation Formula</h2><p>The dissipation rate of TKE (<span class="math inline">\(\epsilon\)</span>) is related to EDR by: <span class="math display">\[EDR = \epsilon^{1/3} \]</span> where$ $ is the dissipation rate of TKE, typically in <span class="math inline">\(m^2/s^3\)</span>.</p><h2 id="derivation-of-dissipation-rate-epsilon">Derivation of Dissipation Rate (<span class="math inline">\(\epsilon\)</span>)</h2><p>In fluid dynamics, the dissipation rate of TKE can be related to the turbulent velocity fluctuations (<span class="math inline">\(u&#39;, v&#39;, w&#39;\)</span>) and the integral scale of turbulence (<span class="math inline">\(l_0\)</span>) through Kolmogorov's hypothesis: <span class="math display">\[\epsilon = \frac{u&#39;^3}{l_0} \]</span> However, in practical applications,<span class="math inline">\(\epsilon\)</span> <strong>is often derived from mesoscale models using TKE closure schemes</strong>.</p><h2 id="practical-interpretation">Practical Interpretation</h2><ul><li><strong>EDR Values</strong>: Range from 0 (smooth air) to 1 (intense turbulence), though actual values are often scaled for easier interpretation (e.g., multiplied by 100).</li><li><strong>Aircraft Dependence</strong>: While EDR itself is aircraft-independent, its impact on aircraft depends on the aircraft's size and weight.</li></ul><h2 id="example-calculation">Example Calculation</h2><p>Given a dissipation rate of TKE (<span class="math inline">\(\epsilon = 0.1 \, m^2/s^3\)</span>), the EDR would be: <span class="math display">\[EDR = (0.1)^{1/3} \approx 0.464 \, m^{2/3} s^{-1} \]</span></p><p>This value indicates moderate turbulence intensity, but its effect on an aircraft would depend on the aircraft's size.</p><h2 id="why-13-power">Why 1/3 power?</h2><p>The Eddy Dissipation Rate (EDR) being related to the <strong>one-third power of the energy dissipation rate</strong> <strong>emerges from scaling arguments in turbulence theory</strong>.</p><h3 id="turbulent-kinetic-energy-and-dissipation">Turbulent Kinetic Energy and Dissipation</h3><ol type="1"><li><p><strong>Energy Cascade:</strong> In turbulent flows, energy is transferred from larger scales (larger eddies) to smaller scales through a process called the energy cascade. Eventually, this energy is dissipated as heat due to viscous effects.</p></li><li><p><strong>Dissipation Rate (<span class="math inline">\(\epsilon\)</span>):</strong> The dissipation rate <span class="math inline">\(\epsilon\)</span> quantifies how much turbulent kinetic energy is converted into thermal energy per unit mass per unit time. It is typically measured in <span class="math inline">\(\text{m}^2/\text{s}^3\)</span>.</p></li></ol><h3 id="scaling-arguments">Scaling Arguments</h3><h4 id="kolmogorovs-turbulence-theory"><strong>Kolmogorov's Turbulence Theory</strong></h4><p>Kolmogorov's 1941 hypothesis states that small-scale turbulence statistics depend only on <span class="math inline">\(\epsilon\)</span> and kinematic viscosity (<span class="math inline">\(\nu\)</span>). Key scales include:</p><ul><li><strong>Velocity scale</strong>: <span class="math inline">\(v_\eta = (\nu \epsilon)^{1/4}\)</span><br /></li><li><strong>Length scale</strong>: <span class="math inline">\(\eta = (\nu^3/\epsilon)^{1/4}\)</span><br /></li><li><strong>Time scale</strong>: <span class="math inline">\(\tau_\eta = (\nu/\epsilon)^{1/2}\)</span></li></ul><p>The relation between EDR and the dissipation rate can be evaluated using <strong>dimensional analysis</strong> and <strong>turbulence scaling laws</strong>:</p><ul><li><p><strong>Turbulent Velocity (<span class="math inline">\(u&#39;\)</span>):</strong> The root mean square of turbulent velocity fluctuations scales with the energy dissipation rate as:</p><p><span class="math display">\[u&#39; \sim (\epsilon \cdot L)^{1/3}\]</span></p></li><li><p><strong>Characteristic Length Scale (<span class="math inline">\(L\)</span>):</strong> The characteristic length scale of turbulence affects how energy is distributed among eddies.</p></li></ul><h3 id="resulting-edr-expression">Resulting EDR Expression</h3><p>Putting it together, when we express the EDR in terms of these scales, we often end up with:</p><p><span class="math display">\[\text{EDR} \sim \left( \frac{u&#39;}{L^{1/3}} \right) \sim \epsilon^{1/3}\]</span></p><p>This is why the EDR can be approximated as the one-third power of the energy dissipation rate in certain contexts. It captures the relationship between the energy scale and the turbulent structures present in the flow.</p><p>(More ......)</p><h1 id="hko">HKO</h1><ul><li><a href="https://www.hko.gov.hk/tc/publica/reprint/files/r553.pdf">Performance of Eddy Dissipation Rate Estimates from Wind Profilers in Turbulence Detection | 2004</a></li><li><a href="https://my.weather.gov.hk/tc/publica/reprint/files/r718.pdf">Eddy Dissipation Rate (EDR) Profile Determined from a Minisodar in Terrain-disrupted Airflow | 2007</a></li><li><a href="https://www.hko.gov.hk/en/publica/reprint/files/r848.pdf">Estimate of Eddy Dissipation Rate Using Spectrum Width Observed by the Hong Kong TDWR Radar | 2009</a></li><li><a href="https://www.hko.gov.hk/hko/publica/reprint/r758.pdf">Performance of LIDAR-based Turbulence Detection Algorithm | 2008</a></li><li><a href="https://repository.library.noaa.gov/view/noaa/32176">Chan, P. W., P. Zhang, and R. Doviak. "Calculation and application of eddy dissipation rate map based on spectrum width data of a S-band radar in Hong Kong." Mausam 67.2 (<strong>2016</strong>): 411-422.</a><ul><li>The spectrum width data of an S-band radar in Hong Kong are used to calculate the map of eddy dissipation rate (EDR) with the objective of providing turbulence alerting service for the en-route aircraft in the Pearl River Delta region.</li><li>The calculation methodology is different from that reported in the existing literature by also removing the wind shear contribution in determining the <strong>radar-based EDR</strong>.</li><li>Time series graph for comparing <span class="math inline">\(EDR^{1/3}\)</span> between <strong>aircraft (blue) and radar (pink)</strong>. Comparison of <span class="math inline">\(EDR^{1/3}\)</span> between aircraft and radar for the second turbulence case<ul><li><img src="https://i.imgur.com/U5B7Ofi.png" alt="Time series graph for comparing EDR^{1/3} between aircraft (blue) and radar (pink). Comparison of EDR^{1/3} between aircraft and radar for the second turbulence case" width="450" /></li></ul></li></ul></li><li><a href="https://rmets.onlinelibrary.wiley.com/doi/pdf/10.1002/asl.1090">Chan, Pak Wai, Kai Kwong Lai, and Qiu Sheng Li. "High‐resolution simulation of a severe case of low‐level windshear at the Hong Kong International Airport: Turbulence intensity and sensitivity to turbulence parameterization scheme." Atmospheric Science Letters 23.7 (<strong>2022</strong>): e1090.</a><ul><li><strong>Large eddy simulations</strong> are performed for a severe windshear case of terrain-induced airflow disturbances at the Hong Kong International Airport.<ul><li><ol type="i"><li>to investigate the performance of large eddy simulation in <strong>capturing the turbulence intensity</strong> to be encountered by the aircraft; and</li></ol></li><li><ol start="2" type="i"><li>to <strong>find out the impact of the choice of turbulence parameterization scheme</strong> on the simulation results.</li></ol></li></ul></li><li>The common metric for turbulence intensity for aviation application is the cube root of eddy dissipation rate (EDR), <span class="math inline">\(EDR^{1/3}\)</span> , which is the dissipation rate of the turbulent kinetic energy.</li><li>Structure Function <div class="group-image-container"><div class="group-image-row"><div class="group-image-wrap"><img src="https://i.imgur.com/BWNsCvg.png" /></div><div class="group-image-wrap"><img src="https://i.imgur.com/cxNR0hN.png" /></div></div><div class="group-image-row"></div></div></li></ul></li></ul><h1 id="literature-review">Literature Review</h1><ul><li><a href="https://www.ecmwf.int/en/newsletter/168/meteorology/forecasting-clear-air-turbulence">Forecasting clear-air turbulence | 2021 | ecmwf</a><ul><li><strong>The eddy dissipation rate (EDR), which is the cube root of the dissipation rate of turbulent kinetic energy</strong>, and hence has units of <span class="math inline">\(m^{2/3} s^{–1}\)</span>, has become the International Civil Aviation Organization (ICAO) standard for aircraft reporting and therefore the standard measure for clear-air turbulence (CAT).</li></ul></li><li><a href="https://skybrary.aero/articles/eddy-dissipation-rate-edr">Eddy Dissipation Rate (EDR)</a><ul><li><strong>Eddy dissipation rate (EDR)</strong> is an <strong>objective, aircraft-independent, universal measure</strong> of turbulence based on the rate at which energy dissipates in the atmosphere.</li><li><strong>Pilot reports (PIREPs)</strong> on turbulence are inherently subjective. What is light turbulence to a B747 might be perceived as moderate to severe for a small single-engine aircraft. EDR provides a measurement that is not based on any particular aircraft, but its values can be referenced against aircraft size.</li></ul></li><li><a href="https://ntrs.nasa.gov/api/citations/20120000925/downloads/20120000925.pdf">Estimation of Eddy Dissipation Rates from Mesoscale Model Simulations | 2012 | NASA</a><ul><li>The Eddy Dissipation Rate is an important metric for representing the intensity of atmospheric turbulence and is used as an input parameter for predicting the decay of aircraft wake vortices. In this study, the forecasts of eddy dissipation rates obtained from the current state-of-the-art mesoscale model are evaluated for terminal area applications. The Weather Research and Forecast mesoscale model is used to simulate the planetary boundary layer at high horizontal and vertical mesh resolutions. <strong>The Bougeault-Lacarreré and the Mellor-Yamada-Janjić schemes implemented in the WRF model</strong> are evaluated against data collected during the National Aeronautics and Space Administration’s Memphis Wake Vortex Field Experiment. Comparisons with other observations are included as well.</li><li>In this paper, EDR is energy dissipation rate. If consider this <span class="math inline">\(EDR^{1/3}\)</span>, it is same as above definition.</li><li><div class="group-image-container"><div class="group-image-row"><div class="group-image-wrap"><img src="https://i.imgur.com/NtQb7zF.png" /></div></div><div class="group-image-row"><div class="group-image-wrap"><img src="https://i.imgur.com/5mkmsUh.png" /></div></div><div class="group-image-row"><div class="group-image-wrap"><img src="https://i.imgur.com/xOQr14P.png" /></div></div></div></li></ul></li><li><a href="https://fpaw.aero/sites/default/files/144/talk2-selfpresentation-meymaris-edr-implementation-tw4-2021.pdf">EDR Implementation Update Turbulence Mitigation Workshop IV | 2021 | Gregory Meymaris | NCAR/RAL</a><ul><li>Measures EDR, an atmospheric turbulence intensity metric; not aircraft dependent</li><li><strong>Energy (Eddy) Dissipation Rate</strong></li><li><div class="group-image-container"><div class="group-image-row"><div class="group-image-wrap"><img src="https://i.imgur.com/aPPNsKT.png" /></div><div class="group-image-wrap"><img src="https://i.imgur.com/6oB2eVh.png" /></div></div><div class="group-image-row"><div class="group-image-wrap"><img src="https://i.imgur.com/8kQaVMk.png" /></div><div class="group-image-wrap"><img src="https://i.imgur.com/jpAgrGZ.png" /></div></div></div></li></ul></li></ul><h1 id="measuring-the-eddy-dissipation-rate-edr">Measuring the <strong>Eddy Dissipation Rate (EDR)</strong></h1><p>Measuring the <strong>Eddy Dissipation Rate (EDR)</strong> from high-frequency wind measurements involves several techniques, each leveraging different mathematical and statistical approaches. Here's an overview of how EDR is typically measured using high-frequency data:</p><h2 id="techniques-for-measuring-edr">Techniques for Measuring EDR</h2><ol type="1"><li><strong>Second-Order Structure Function</strong>:<ul><li>This method involves analyzing the spatial or temporal differences in wind velocity components (e.g., zonal, meridional, vertical) to estimate the dissipation rate. The structure function is defined as: <span class="math display">\[D_{u}(r) = \langle [u(x + r) - u(x)]^2 \rangle\]</span></li><li>For small separations <span class="math inline">\(r\)</span>, <span class="math inline">\(D_{u}(r)\)</span> is proportional to <span class="math inline">\(r^{2/3}\)</span>, which relates to the Kolmogorov scaling law, allowing the estimation of <span class="math inline">\(\epsilon\)</span> and thus EDR <a href="https://amt.copernicus.org/articles/15/2277/2022/">link 1</a>, <a href="https://research.tudelft.nl/files/69746455/jtech_d_18_0084.1.pdf">link 2</a>.</li></ul></li><li><strong>Power Spectral Density (PSD)</strong>:<ul><li>PSD is used to analyze the distribution of turbulent kinetic energy across different frequencies. By fitting a power-law spectrum (typically <span class="math inline">\(-5/3\)</span> in the inertial subrange) to the PSD, one can estimate <span class="math inline">\(\epsilon\)</span> and subsequently EDR <a href="https://my.weather.gov.hk/tc/publica/reprint/files/r718.pdf">link 3</a>, <a href="https://ntrs.nasa.gov/api/citations/20130003224/downloads/20130003224.pdf">link 4</a>.</li><li>The relationship between PSD and <span class="math inline">\(\epsilon\)</span> is given by: <span class="math display">\[E(k) = C \epsilon^{2/3} k^{-5/3}\]</span></li><li>Here, <span class="math inline">\(C\)</span> is a constant, <span class="math inline">\(k\)</span> is the wavenumber, and <span class="math inline">\(E(k)\)</span> is the energy spectrum.</li></ul></li><li><strong>Von Kármán Wind Spectrum</strong>:<ul><li>Similar to PSD, but specifically tailored to atmospheric conditions, this method uses a more complex spectral form that accounts for both the inertial subrange and larger scales <a href="https://amt.copernicus.org/articles/15/2277/2022/">link 1</a>.</li></ul></li><li><strong>Maximum-Likelihood Method</strong>:<ul><li>This statistical approach involves fitting a model to the observed wind data to maximize the likelihood of observing the data given the model parameters, which can include <span class="math inline">\(\epsilon\)</span> or EDR <a href="https://amt.copernicus.org/articles/15/2277/2022/">link 1</a>.</li></ul></li><li><strong>Lognormal Mapping Technique and Parabolic Relationship</strong>:<ul><li>These methods involve transforming observed data (e.g., equivalent vertical gusts) into EDR estimates using predefined statistical relationships <a href="https://amt.copernicus.org/articles/15/2277/2022/">link 1</a>.</li></ul></li></ol><h2 id="high-frequency-data-sources">High-Frequency Data Sources</h2><ul><li><strong>Sonic Anemometers</strong>: Provide high-frequency measurements of wind components close to the surface.</li><li><strong>Radar Systems</strong>: Can estimate wind velocities remotely, allowing for EDR calculations over larger areas.</li><li><strong>Aircraft Data</strong>: Commercial aircraft quick access recorder (QAR) data can be used to estimate EDR during flight.</li></ul><h2 id="challenges-and-considerations">Challenges and Considerations</h2><ul><li><strong>Sampling Rate</strong>: Higher sampling rates (e.g., 20 Hz) are generally more accurate than lower rates (e.g., 1 Hz).</li><li><strong>Data Quality</strong>: Noise and gaps in data can affect EDR estimates, requiring careful data processing and interpolation.</li><li><strong>Model Assumptions</strong>: Techniques assume certain spectral behaviors (e.g., <span class="math inline">\(-5/3\)</span> power law), which may not always hold.</li></ul><h1 id="references">References</h1><ol type="1"><li><a href="https://www.weather.gov/media/zla/Jurecka_Sincavage%20Turbulence%20-%20SAWS%202023%20-%20Types%20Tips%20Mitigation.pptx.pdf">Turbulence Types, Tips, and Mitigation</a></li><li><a href="https://www.icao.int/MID/Documents/2020/MET%20SG9%20VTC/MET%20SG9%20-%20PPT8%20-%20WAFS%20training%20presentation.pdf">Improvements to the World Area Forecast System (WAFS) | 2020 | UK Met Office</a></li><li><a href="https://amt.copernicus.org/articles/17/627/2024/amt-17-627-2024.html">Schröder, Marcel, et al. "Estimating the turbulent kinetic energy dissipation rate from one-dimensional velocity measurements in time." Atmospheric Measurement Techniques 17.2 (2024): 627-657.</a></li></ol>]]></content>
    
    
    <categories>
      
      <category>NWP</category>
      
    </categories>
    
    
    <tags>
      
      <tag>NWP</tag>
      
      <tag>WRF</tag>
      
      <tag>MPAS</tag>
      
      <tag>HKO</tag>
      
      <tag>EDR</tag>
      
      <tag>aviation</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>NWP | CMA | CMA_GFS real time data</title>
    <link href="/2025/04/02/NWP-CMA-CMA_GFS-real-time-data/"/>
    <url>/2025/04/02/NWP-CMA-CMA_GFS-real-time-data/</url>
    
    <content type="html"><![CDATA[<p><strong>中國氣象局（China Meteorological Administration，縮寫：CMA）</strong>，是中華人民共和國國務院負責氣象行政管理與科學研究的副部級直屬事業單位。</p><p><strong>CMA-GFS (原名为GRAPES-GFS)</strong> 作为我国自主研发的新一代全球数值预报模式，从初始场、变分同化、模式框架等核心技术均实现了自主化。CMA-GFS全球模式从2001年开始组织数值预报团队启动研发，2016年实现业务化并面向全国下发产品。该模式每天运行4次，分别是00、06、12、18 UTC，时间分辨率为3小时，空间分辨率为0.25˚ × 0.25˚，预报时长为10天(240小时)，提供了全球基础要素场和诊断要素场，基础要素场主要包括各层次的高度场、温度场、东西风场、湿度场、比湿场、露点场及海平面气压场、10 m东西风场、2 m温度场、2 m比湿场、2 m露点场、降水量等，诊断要素场主要包括10 m阵风、能量指数、最高最低温度、云量及各层次的涡度散度、垂直速度及相当位温等。</p><ul><li><a href="http://bbs.06climate.com/forum.php?mod=viewthread&amp;tid=108570&amp;extra=page%3D1&amp;page=1">CMA-MESO 3km的模式预报场能作为WRF的初始场吗？ | 2023-8-11</a><ul><li>等压面数据用CMA MESO 预报场，地面数据用CLDAS网格产品可以吗WPS里的Vtable没有现成的选项，有考虑自己写Vtable文件</li><li>我知道<strong>GRAPES-GFS全球版本可以</strong>，中尺度版本可能与这个不同。</li><li>这是全球版本数据：<a href="http://data.wis.cma.cn/DCPC_WMC_BJ/open/nwp/" class="uri">http://data.wis.cma.cn/DCPC_WMC_BJ/open/nwp/</a></li><li><strong>CMA-GFS成功了，但是分辨率不够</strong>，我又用了CALMET降尺度，<strong>用 CMA-GFS的话 改Vtable文件 就可以</strong>，MESO数据缺很多土壤数据</li><li>不好意思，我的 Vtable文件是老师给的，不能外传，<strong>你可以用python读取grib文件信息对应修改一下，改Vtable.ECWMF就可以</strong></li></ul></li><li>Github<ul><li><a href="https://github.com/wrf-model/WPS/pull/236">Adding support for CMA-GFS in WPS | Oct 10, 2023</a></li><li>The CMA-GFS grib2 datasets is now able to be ingested by the ungrib program. The GRAPES_GFS(here in after referred to as CMA_GFS), the new generation of Global/Regional Assimilation and Prediction Enhanced System which is independently developped by China Meteorological Administration (CMA), has been put into formal operation. So we are committed to solving the problem of WPS correctly handling CMA_GFS forecast data.</li><li>one <code>Vtable files(Vtable.CMA_GFS)</code> has been created with the fields required by the WRF model. Modifications to the ungrib source code: <strong>Adding support for code 738</strong> in <code>rd_grid2.F</code> because model levels of CMA_GFS are on generalized vertical height coordinates.</li><li>The <strong>CMA_GFS real time data is here</strong>: <a href="http://data.wis.cma.cn/DCPC_WMC_BJ/open/nwp/gmf_gra/" class="uri">http://data.wis.cma.cn/DCPC_WMC_BJ/open/nwp/gmf_gra/</a></li><li><strong>I've tested the program with an Intel compiler and it passed without errors. CMA_GFS forecast data were also used to test, the results are normal.</strong></li><li>[<em>Dec 22, 2024</em>] These changes permit ungribbing of the CMA model output. <strong>Tests on derecho were successful</strong>. <strong>Note that the global CMA output files are very large and time-consuming to download</strong>.</li></ul></li><li><a href="https://mp.weixin.qq.com/s?__biz=MzI2NTk2MzU3NA==&amp;mid=2247485543&amp;idx=1&amp;sn=e4155bbc8ee16350c57dbf733e3d2386&amp;chksm=ea94193edde39028ec6ec2ecfd5095521c6d1e0a627357bcc8a67ca093c2e462d01ff4a1660e&amp;scene=178&amp;cur_album_id=2858702555684864004#rd">WRF基础 | CMA-GFS运行WRF | Jan 2025</a></li></ul>    <div class="fold">      <div class="fold-title fold-info collapsed" data-toggle="collapse" href="#collapse-8f7bdefe" role="button" aria-expanded="false" aria-controls="collapse-8f7bdefe">        <div class="fold-arrow">▶</div>rd_grib2.F      </div>      <div class="fold-collapse collapse" id="collapse-8f7bdefe">        <div class="fold-content">          <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs rd_grib2.F">line 738:  &amp;               (gfld%ipdtmpl(1) .eq. g2code(2,j)) .and.  !! Added by Dr.Haiqing SONG, 20181201<br></code></pre></td></tr></table></figure>        </div>      </div>    </div>    <div class="fold">      <div class="fold-title fold-info collapsed" data-toggle="collapse" href="#collapse-dcdac752" role="button" aria-expanded="false" aria-controls="collapse-dcdac752">        <div class="fold-arrow">▶</div>Vtable.CMA_GFS      </div>      <div class="fold-collapse collapse" id="collapse-dcdac752">        <div class="fold-content">          <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs Vtable.CMA_GFS">GRIB1| Level| From |  To  | metgrid  | metgrid | metgrid                                 |GRIB2|GRIB2|GRIB2|GRIB2|<br>Param| Type |Level1|Level2| Name     | Units   | Description                             |Discp|Catgy|Param|Level|<br>-----+------+------+------+----------+---------+-----------------------------------------+-----------------------+<br>  11 | 100  |   *  |      | TT       | K       | Temperature                             |  0  |  0  |  0  | 100 |<br>  33 | 100  |   *  |      | UU       | m s-1   | U                                       |  0  |  2  |  2  | 100 |<br>  34 | 100  |   *  |      | VV       | m s-1   | V                                       |  0  |  2  |  3  | 100 |<br>  52 | 100  |   *  |      | RH       | %       | Relative Humidity                       |  0  |  1  |  1  | 100 |<br>   7 | 100  |   *  |      | HGT      | m       | Height                                  |  0  |  3  |  5  | 100 |<br>  11 | 105  |   2  |      | TT       | K       | Temperature       at 2 m                |  0  |  0  |  0  | 103 |<br>  52 | 105  |   2  |      | RH       | %       | Relative Humidity at 2 m                |  0  |  1  |  1  | 103 |<br>  33 | 105  |  10  |      | UU       | m s-1   | U                 at 10 m               |  0  |  2  |  2  | 103 |<br>  34 | 105  |  10  |      | VV       | m s-1   | V                 at 10 m               |  0  |  2  |  3  | 103 |<br>   1 |   1  |   0  |      | PSFC     | Pa      | Surface Pressure                        |  0  |  3  |  0  |   1 |<br>   2 | 102  |   0  |      | PMSL     | Pa      | Sea-level Pressure                      |  0  |  3  |  1  | 101 |<br> 144 | 112  |   0  |  10  | SM000010 | fraction| Soil Moist 0-10 cm below grn layer (Up) |  0  |  1  |  0  | 106 |<br> 144 | 112  |  10  |  40  | SM010040 | fraction| Soil Moist 10-40 cm below grn layer     |  0  |  1  |  0  | 106 |<br> 144 | 112  |  40  | 100  | SM040100 | fraction| Soil Moist 40-100 cm below grn layer    |  0  |  1  |  0  | 106 |<br> 144 | 112  | 100  | 200  | SM100200 | fraction| Soil Moist 100-200 cm below gr layer    |  0  |  1  |  0  | 106 |<br>  85 | 112  |   0  |  10  | ST000010 | K       | T 0-10 cm below ground layer (Upper)    |  0  |  0  |  0  | 106 |<br>  85 | 112  |  10  |  40  | ST010040 | K       | T 10-40 cm below ground layer (Upper)   |  0  |  0  |  0  | 106 |<br>  85 | 112  |  40  | 100  | ST040100 | K       | T 40-100 cm below ground layer (Upper)  |  0  |  0  |  0  | 106 |<br>  85 | 112  | 100  | 200  | ST100200 | K       | T 100-200 cm below ground layer (Bottom)|  0  |  0  |  0  | 106 |<br>  11 |   1  |   0  |      | SKINTEMP | K       | Skin temperature                        |  0  |  0  |  0  |   1 |<br>   7 |   1  |   0  |      | SOILHGT  | m       | Terrain field of source analysis        |  0  |  3  |  5  |   1 |<br>  81 |   1  |   0  |      | LANDSEA  | proprtn | Land/Sea flag (1=land, 0 or 2=sea)      |  2  |  0  |  0  |   1 |<br>  65 |   1  |   0  |      | SNOW     | kg m-2  | Water equivalent snow depth             |  0  |  1  | 13  |   1 |<br>     |   1  |   0  |      | SNOWH    | m       | Physical Snow Depth                     |  0  |  1  |     |   1 |<br>  33 |   6  |   0  |      | UMAXW    | m s-1   | U                 at max wind           |  0  |  2  |  2  |   6 |<br>  34 |   6  |   0  |      | VMAXW    | m s-1   | V                 at max wind           |  0  |  2  |  3  |   6 |<br>   2 |   6  |   0  |      | PMAXW    | Pa      | Pressure of max wind level              |  0  |  3  |  0  |   6 |<br>     |   6  |   0  |      | PMAXWNN  | Pa      | PMAXW, used for nearest neighbor interp |  0  |  3  |  0  |   6 |<br>   2 |   6  |   0  |      | TMAXW    | K       | Temperature at max wind level           |  0  |  0  |  0  |   6 |<br>   7 |   6  |   0  |      | HGTMAXW  | m       | Height of max wind level                |  0  |  3  |  5  |   6 |<br>  33 |   7  |   0  |      | UTROP    | m s-1   | U                 at tropopause         |  0  |  2  |  2  |   7 |<br>  34 |   7  |   0  |      | VTROP    | m s-1   | V                 at tropopause         |  0  |  2  |  3  |   7 |<br>   2 |   7  |   0  |      | PTROP    | Pa      | Pressure of tropopause                  |  0  |  3  |  0  |   7 |<br>     |   7  |   0  |      | PTROPNN  | Pa      | PTROP, used for nearest neighbor interp |  0  |  3  |  0  |   7 |<br>   2 |   7  |   0  |      | TTROP    | K       | Temperature at tropopause               |  0  |  0  |  0  |   7 |<br>   7 |   7  |   0  |      | HGTTROP  | m       | Height of tropopause                    |  0  |  3  |  5  |   7 |<br>-----+------+------+------+----------+---------+-----------------------------------------+-----------------------+<br>#  This Vtable was created for CMA/CMA_GFS model data from the CMA server.(http://cemc.cma.cn/intro.html?idx=1)<br>#  The GRAPES_GFS(here in after referred to as CMA_GFS), the new generation of Global/Regional Assimilation and Prediction Enhanced System<br>#  which is independently developped by China Meteorological Administration (CMA), has been put into formal operation.<br>#  The data was accesed from:http://data.wis.cma.cn/DCPC_WMC_BJ/open/nwp/gmf_gra/thh00/    (note hh at end)<br>#  Developed by Dr. Haiqing SONG from Inner Mongolia Meteorological Service of China Meteorological Administration(CMA).<br>#  E-mail:haiqingsong@emails.imau.edu.cn<br>#  wgrib2 -var filename.grib2<br></code></pre></td></tr></table></figure>        </div>      </div>    </div><h1 id="cma">CMA</h1><p>数据介绍</p><p>CMA-GFS 是我国自主研发的新一代全球数值预报模式，该模式由同化分系统和全球模式分系统两部分组成，于2016年6月业务化运行，向全国实时分发产品。2018年7月四维变分同化实现业务运行。2020年CMA-GFS升级为3.0，模式水平分辨率为25km，模式层顶0.1hPa，垂直分层87层。2022年CMA-GFS升级为3.3版本。2023年CMA-GFS升级为4.0版本</p><figure><img src="https://i.imgur.com/KDTgahf.png" alt="https://data.cma.cn/data/detail/dataCode/F.0003.0008.S001.html" width="400" /><figcaption>https://data.cma.cn/data/detail/dataCode/F.0003.0008.S001.html</figcaption></figure><h2 id="httpdata.wis.cma.cndcpc_wmc_bjopennwpgmf_gra">http://data.wis.cma.cn/DCPC_WMC_BJ/open/nwp/gmf_gra/</h2><ul><li>Index of /DCPC_WMC_BJ/open/nwp/gmf_gra/</li></ul><p><img src="https://i.imgur.com/H9MM6QW.png" width="500" /></p><h1 id="grib2-file">grib2 file</h1><ul><li><code>./g2print.exe Z_NAFP_C_BABJ_20250112000000_P_NWPC-GRAPES-GFS-GLB-00000.grib2</code></li></ul>    <div class="fold">      <div class="fold-title fold-info collapsed" data-toggle="collapse" href="#collapse-6ae3e036" role="button" aria-expanded="false" aria-controls="collapse-6ae3e036">        <div class="fold-arrow">▶</div>log      </div>      <div class="fold-collapse collapse" id="collapse-6ae3e036">        <div class="fold-content">          <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br></pre></td><td class="code"><pre><code class="hljs log"> ungrib - grib edition num           2<br> reading from grib file = Z_NAFP_C_BABJ_20250112000000_P_NWPC-GRAPES-GFS-GLB-00000.grib2                                                          <br>      unknown model and orig center   <br>---------------------------------------------------------------------------------------<br> rec Prod Cat Param  Lvl    Lvl      Lvl     Prod    Name            Time          Fcst<br> num Disc     num    code   one      two     Templ                                 hour<br>---------------------------------------------------------------------------------------<br>   1   0    1  10       1       0       0       8     ACPCP    2025-01-12_00:00:00   00  PDT4.8  <br>   2   0    1   9       1       0       0       8     NCPCP    2025-01-12_00:00:00   00  PDT4.8  <br>   3   0    1   8       1       0       0       8     APCP     2025-01-12_00:00:00   00  PDT4.8  <br>   4   0    1  29       1       0       0       8     ASNOW    2025-01-12_00:00:00   00  PDT4.8  <br>   5   0    0   0       1       0       0       0     TMP      2025-01-12_00:00:00   00          <br>   6   0    5   5       1       0       0       8     UNKNOWN  2025-01-12_00:00:00   00  PDT4.8  <br>   7   0    4   9       1       0       0       8     UNKNOWN  2025-01-12_00:00:00   00  PDT4.8  <br>   8   2    0  24       1       0       0       8     UNKNOWN  2025-01-12_00:00:00   00  PDT4.8  <br>   9   0    0  10       1       0       0       8     LHTFL    2025-01-12_00:00:00   00  PDT4.8  <br>  10   0    5   4       1       0       0       8     ULWRF    2025-01-12_00:00:00   00  PDT4.8  <br>  11   0    5   4       8********       0       8     ULWRF    2025-01-12_00:00:00   00  PDT4.8  <br>  12   0    5   8       1       0       0       8     UNKNOWN  2025-01-12_00:00:00   00  PDT4.8  <br>  13   0    5 224       1       0       0       8     UNKNOWN  2025-01-12_00:00:00   00  PDT4.8  <br>  14   0    5 224       8********       0       8     UNKNOWN  2025-01-12_00:00:00   00  PDT4.8  <br>  15   0    4   8       1       0       0       8     USWRF    2025-01-12_00:00:00   00  PDT4.8  <br>  16   0    4   9       8********       0       8     UNKNOWN  2025-01-12_00:00:00   00  PDT4.8  <br>  17   0    4   8       8********       0       8     USWRF    2025-01-12_00:00:00   00  PDT4.8  <br>  18   0    4  11       1       0       0       8     UNKNOWN  2025-01-12_00:00:00   00  PDT4.8  <br>  19   0    4  53       1       0       0       8     UNKNOWN  2025-01-12_00:00:00   00  PDT4.8  <br>  20   0    4  11       8********       0       8     UNKNOWN  2025-01-12_00:00:00   00  PDT4.8  <br>  21   0    4  53       8********       0       8     UNKNOWN  2025-01-12_00:00:00   00  PDT4.8  <br>  22   0    3 228       1       0       0       0     UNKNOWN  2025-01-12_00:00:00   00          <br>  23   0    3   5       1       0       0       0     HGT      2025-01-12_00:00:00   00          <br>  24   0    1   0     103       2       0       0     SPFH     2025-01-12_00:00:00   00          <br>  25   0    0   0     103       2       0       0     TMP      2025-01-12_00:00:00   00          <br>  26   0    2   2     103      10       0       0     UGRD     2025-01-12_00:00:00   00          <br>  27   0    2   3     103      10       0       0     VGRD     2025-01-12_00:00:00   00          <br>  28   0    6   1       1       0********       0     TCDC     2025-01-12_00:00:00   00          <br>  29   0    6   3       1       0********       0     LCDC     2025-01-12_00:00:00   00          <br>  30   0    6   4       1       0********       0     MCDC     2025-01-12_00:00:00   00          <br>  31   0    6   5       1       0********       0     HCDC     2025-01-12_00:00:00   00          <br>  32   0    1  64      10********       0       0     UNKNOWN  2025-01-12_00:00:00   00          <br>  33   0    1  69      10********       0       0     UNKNOWN  2025-01-12_00:00:00   00          <br>  34   0    1  70      10********       0       0     UNKNOWN  2025-01-12_00:00:00   00          <br>  35   0    3  18       1       0       0       0     HPBL     2025-01-12_00:00:00   00          <br>  36   0    2 227       1       0       0       0     UNKNOWN  2025-01-12_00:00:00   00          <br>  37   0    2 228       1       0       0       0     UNKNOWN  2025-01-12_00:00:00   00          <br>  38   0    1  11       1       0       0       0     SNOD     2025-01-12_00:00:00   00          <br>  39   0   19   1       1       0       0       0     ALBDO    2025-01-12_00:00:00   00          <br>  40   0    0   4     103       2       0       8     TMAX     2025-01-12_00:00:00   00  PDT4.8  <br>  41   0    0   5     103       2       0       8     TMIN     2025-01-12_00:00:00   00  PDT4.8  <br>  42   0    1 231     103       2       0       8     UNKNOWN  2025-01-12_00:00:00   00  PDT4.8  <br>  43   0    1 232     103       2       0       8     UNKNOWN  2025-01-12_00:00:00   00  PDT4.8  <br>  44   0    3   0       1       0       0       0     PRES     2025-01-12_00:00:00   00          <br>  45   0    3   1     101       0       0       0     PRMSL    2025-01-12_00:00:00   00          <br>  46   0    2   2     103      30       0       0     UGRD     2025-01-12_00:00:00   00          <br>  47   0    2   2     103      50       0       0     UGRD     2025-01-12_00:00:00   00          <br>  48   0    2   2     103      70       0       0     UGRD     2025-01-12_00:00:00   00          <br>  49   0    2   2     103     100       0       0     UGRD     2025-01-12_00:00:00   00          <br>  50   0    2   2     103     120       0       0     UGRD     2025-01-12_00:00:00   00          <br>  51   0    2   2     103     140       0       0     UGRD     2025-01-12_00:00:00   00          <br>  52   0    2   2     103     160       0       0     UGRD     2025-01-12_00:00:00   00          <br>  53   0    2   2     103     180       0       0     UGRD     2025-01-12_00:00:00   00          <br>  54   0    2   2     103     200       0       0     UGRD     2025-01-12_00:00:00   00          <br>  55   0    2   3     103      30       0       0     VGRD     2025-01-12_00:00:00   00          <br>  56   0    2   3     103      50       0       0     VGRD     2025-01-12_00:00:00   00          <br>  57   0    2   3     103      70       0       0     VGRD     2025-01-12_00:00:00   00          <br>  58   0    2   3     103     100       0       0     VGRD     2025-01-12_00:00:00   00          <br>  59   0    2   3     103     120       0       0     VGRD     2025-01-12_00:00:00   00          <br>  60   0    2   3     103     140       0       0     VGRD     2025-01-12_00:00:00   00          <br>  61   0    2   3     103     160       0       0     VGRD     2025-01-12_00:00:00   00          <br>  62   0    2   3     103     180       0       0     VGRD     2025-01-12_00:00:00   00          <br>  63   0    2   3     103     200       0       0     VGRD     2025-01-12_00:00:00   00          <br>  64   0    3   5     100  100000       0       0     HGT      2025-01-12_00:00:00   00          <br>  65   0    3   5     100   97500       0       0     HGT      2025-01-12_00:00:00   00          <br>  66   0    3   5     100   95000       0       0     HGT      2025-01-12_00:00:00   00          <br>  67   0    3   5     100   92500       0       0     HGT      2025-01-12_00:00:00   00          <br>  68   0    3   5     100   90000       0       0     HGT      2025-01-12_00:00:00   00          <br>  69   0    3   5     100   85000       0       0     HGT      2025-01-12_00:00:00   00          <br>  70   0    3   5     100   80000       0       0     HGT      2025-01-12_00:00:00   00          <br>  71   0    3   5     100   75000       0       0     HGT      2025-01-12_00:00:00   00          <br>  72   0    3   5     100   70000       0       0     HGT      2025-01-12_00:00:00   00          <br>  73   0    3   5     100   65000       0       0     HGT      2025-01-12_00:00:00   00          <br>  74   0    3   5     100   60000       0       0     HGT      2025-01-12_00:00:00   00          <br>  75   0    3   5     100   55000       0       0     HGT      2025-01-12_00:00:00   00          <br>  76   0    3   5     100   50000       0       0     HGT      2025-01-12_00:00:00   00          <br>  77   0    3   5     100   45000       0       0     HGT      2025-01-12_00:00:00   00          <br>  78   0    3   5     100   40000       0       0     HGT      2025-01-12_00:00:00   00          <br>  79   0    3   5     100   35000       0       0     HGT      2025-01-12_00:00:00   00          <br>  80   0    3   5     100   30000       0       0     HGT      2025-01-12_00:00:00   00          <br>  81   0    3   5     100   27500       0       0     HGT      2025-01-12_00:00:00   00          <br>  82   0    3   5     100   25000       0       0     HGT      2025-01-12_00:00:00   00          <br>  83   0    3   5     100   22500       0       0     HGT      2025-01-12_00:00:00   00          <br>  84   0    3   5     100   20000       0       0     HGT      2025-01-12_00:00:00   00          <br>  85   0    3   5     100   17500       0       0     HGT      2025-01-12_00:00:00   00          <br>  86   0    3   5     100   15000       0       0     HGT      2025-01-12_00:00:00   00          <br>  87   0    3   5     100   12500       0       0     HGT      2025-01-12_00:00:00   00          <br>  88   0    3   5     100   10000       0       0     HGT      2025-01-12_00:00:00   00          <br>  89   0    3   5     100    7000       0       0     HGT      2025-01-12_00:00:00   00          <br>  90   0    3   5     100    5000       0       0     HGT      2025-01-12_00:00:00   00          <br>  91   0    3   5     100    3000       0       0     HGT      2025-01-12_00:00:00   00          <br>  92   0    3   5     100    2000       0       0     HGT      2025-01-12_00:00:00   00          <br>  93   0    3   5     100    1000       0       0     HGT      2025-01-12_00:00:00   00          <br>  94   0    3   5     100     700       0       0     HGT      2025-01-12_00:00:00   00          <br>  95   0    3   5     100     500       0       0     HGT      2025-01-12_00:00:00   00          <br>  96   0    3   5     100     400       0       0     HGT      2025-01-12_00:00:00   00          <br>  97   0    3   5     100     300       0       0     HGT      2025-01-12_00:00:00   00          <br>  98   0    3   5     100     200       0       0     HGT      2025-01-12_00:00:00   00          <br>  99   0    3   5     100     150       0       0     HGT      2025-01-12_00:00:00   00          <br> 100   0    3   5     100     100       0       0     HGT      2025-01-12_00:00:00   00          <br> 101   0    3   5     100      50       0       0     HGT      2025-01-12_00:00:00   00          <br> 102   0    3   5     100      20       0       0     HGT      2025-01-12_00:00:00   00          <br> 103   0    3   5     100      10       0       0     HGT      2025-01-12_00:00:00   00          <br> 104   0    0   0     100  100000       0       0     TMP      2025-01-12_00:00:00   00          <br> 105   0    0   0     100   97500       0       0     TMP      2025-01-12_00:00:00   00          <br> 106   0    0   0     100   95000       0       0     TMP      2025-01-12_00:00:00   00          <br> 107   0    0   0     100   92500       0       0     TMP      2025-01-12_00:00:00   00          <br> 108   0    0   0     100   90000       0       0     TMP      2025-01-12_00:00:00   00          <br> 109   0    0   0     100   85000       0       0     TMP      2025-01-12_00:00:00   00          <br> 110   0    0   0     100   80000       0       0     TMP      2025-01-12_00:00:00   00          <br> 111   0    0   0     100   75000       0       0     TMP      2025-01-12_00:00:00   00          <br> 112   0    0   0     100   70000       0       0     TMP      2025-01-12_00:00:00   00          <br> 113   0    0   0     100   65000       0       0     TMP      2025-01-12_00:00:00   00          <br> 114   0    0   0     100   60000       0       0     TMP      2025-01-12_00:00:00   00          <br> 115   0    0   0     100   55000       0       0     TMP      2025-01-12_00:00:00   00          <br> 116   0    0   0     100   50000       0       0     TMP      2025-01-12_00:00:00   00          <br> 117   0    0   0     100   45000       0       0     TMP      2025-01-12_00:00:00   00          <br> 118   0    0   0     100   40000       0       0     TMP      2025-01-12_00:00:00   00          <br> 119   0    0   0     100   35000       0       0     TMP      2025-01-12_00:00:00   00          <br> 120   0    0   0     100   30000       0       0     TMP      2025-01-12_00:00:00   00          <br> 121   0    0   0     100   27500       0       0     TMP      2025-01-12_00:00:00   00          <br> 122   0    0   0     100   25000       0       0     TMP      2025-01-12_00:00:00   00          <br> 123   0    0   0     100   22500       0       0     TMP      2025-01-12_00:00:00   00          <br> 124   0    0   0     100   20000       0       0     TMP      2025-01-12_00:00:00   00          <br> 125   0    0   0     100   17500       0       0     TMP      2025-01-12_00:00:00   00          <br> 126   0    0   0     100   15000       0       0     TMP      2025-01-12_00:00:00   00          <br> 127   0    0   0     100   12500       0       0     TMP      2025-01-12_00:00:00   00          <br> 128   0    0   0     100   10000       0       0     TMP      2025-01-12_00:00:00   00          <br> 129   0    0   0     100    7000       0       0     TMP      2025-01-12_00:00:00   00          <br> 130   0    0   0     100    5000       0       0     TMP      2025-01-12_00:00:00   00          <br> 131   0    0   0     100    3000       0       0     TMP      2025-01-12_00:00:00   00          <br> 132   0    0   0     100    2000       0       0     TMP      2025-01-12_00:00:00   00          <br> 133   0    0   0     100    1000       0       0     TMP      2025-01-12_00:00:00   00          <br> 134   0    0   0     100     700       0       0     TMP      2025-01-12_00:00:00   00          <br> 135   0    0   0     100     500       0       0     TMP      2025-01-12_00:00:00   00          <br> 136   0    0   0     100     400       0       0     TMP      2025-01-12_00:00:00   00          <br> 137   0    0   0     100     300       0       0     TMP      2025-01-12_00:00:00   00          <br> 138   0    0   0     100     200       0       0     TMP      2025-01-12_00:00:00   00          <br> 139   0    0   0     100     150       0       0     TMP      2025-01-12_00:00:00   00          <br> 140   0    0   0     100     100       0       0     TMP      2025-01-12_00:00:00   00          <br> 141   0    0   0     100      50       0       0     TMP      2025-01-12_00:00:00   00          <br> 142   0    0   0     100      20       0       0     TMP      2025-01-12_00:00:00   00          <br> 143   0    0   0     100      10       0       0     TMP      2025-01-12_00:00:00   00 <br> ......<br> 852   0   19   0       1       0       0       0     VIS      2025-01-12_00:00:00   00          <br> 853   0   19 224       1       0       0       0     UNKNOWN  2025-01-12_00:00:00   00          <br> 854   0   19 225       1       0       0       0     UNKNOWN  2025-01-12_00:00:00   00          <br> 855   0    2  22     103      10       0       0     GUST     2025-01-12_00:00:00   00          <br> 856   0    1  19       1       0       0       0     UNKNOWN  2025-01-12_00:00:00   00          <br> 857   0    6  12       1       0       0       0     UNKNOWN  2025-01-12_00:00:00   00          <br> 858   0    6  11       1       0       0       0     UNKNOWN  2025-01-12_00:00:00   00          <br> 859   0    6  13       1       0       0       0     CEIL     2025-01-12_00:00:00   00          <br> 860   0    4 228       1       0       0       0     UNKNOWN  2025-01-12_00:00:00   00          <br> 861   0    4 227       1       0       0       0     UNKNOWN  2025-01-12_00:00:00   00          <br>   Successful completion of g2print  <br></code></pre></td></tr></table></figure>        </div>      </div>    </div><h2 id="pressure-level">Pressure level</h2><p>There are <strong>40</strong> pressure levels, <strong>1000hPa up to 0.1hPa (~30km)</strong></p><h2 id="land-sea-mask">Land sea mask</h2><ul><li><code>./g2print.exe final_cma_lsm.grib2</code> &lt;--- <strong>Land sea mask</strong></li></ul>    <div class="fold">      <div class="fold-title fold-info collapsed" data-toggle="collapse" href="#collapse-9c51fa20" role="button" aria-expanded="false" aria-controls="collapse-9c51fa20">        <div class="fold-arrow">▶</div>Land sea mask      </div>      <div class="fold-collapse collapse" id="collapse-9c51fa20">        <div class="fold-content">          <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs log"> ungrib - grib edition num           2<br> reading from grib file = final_cma_lsm.grib2                                                                                                    <br>      unknown model and orig center   <br>---------------------------------------------------------------------------------------<br> rec Prod Cat Param  Lvl    Lvl      Lvl     Prod    Name            Time          Fcst<br> num Disc     num    code   one      two     Templ                                 hour<br>---------------------------------------------------------------------------------------<br>   1   2    0   0       1       0       0       0     LAND     2025-01-12_00:00:00   00          <br>  <br>  <br>   Successful completion of g2print  <br></code></pre></td></tr></table></figure>        </div>      </div>    </div><h1 id="ungrib">ungrib</h1><ul><li><del>re-compile <strong>WPS</strong> (<strong>WRFv450-CMA-GFS</strong>)</del></li></ul><figure class="highlight tap"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs tap">-rw-rw-r--<span class="hljs-number"> 1 </span>wpsze wpsze 3.2G Apr <span class="hljs-number"> 2 </span>16:56 CMA:2025-01-12_00<br>lrwxrwxrwx<span class="hljs-number"> 1 </span>wpsze wpsze  <span class="hljs-number"> 62 </span>Apr <span class="hljs-number"> 2 </span>16:50 GRIBFILE.AAA -&gt; Z_NAFP_C_BABJ_20250112000000_P_NWPC-GRAPES-GFS-GLB-00000.grib2<br>-rw-rw-r--<span class="hljs-number"> 1 </span>wpsze wpsze <span class="hljs-number"> 272 </span>Apr <span class="hljs-number"> 2 </span>16:50 namelist.wps<br>-rwxrwxr-x<span class="hljs-number"> 1 </span>wpsze wpsze 1.7K Apr <span class="hljs-number"> 2 </span>16:51 run_ungrid.sh*<br>lrwxrwxrwx<span class="hljs-number"> 1 </span>wpsze wpsze  <span class="hljs-number"> 67 </span>Apr <span class="hljs-number"> 2 </span>16:51 ungrib.exe -&gt; /home/wpsze/WRF/WRFv450-CMA-GFS/wrf_install/WPS-4.5/ungrib/ungrib.exe*<br>-rw-rw-r--<span class="hljs-number"> 1 </span>wpsze wpsze  30K Apr <span class="hljs-number"> 2 </span>16:57 ungrib.log<br>lrwxrwxrwx<span class="hljs-number"> 1 </span>wpsze wpsze  <span class="hljs-number"> 14 </span>Apr <span class="hljs-number"> 2 </span>16:51 Vtable -&gt; Vtable.CMA_GFS<br>lrwxrwxrwx<span class="hljs-number"> 1 </span>wpsze wpsze  <span class="hljs-number"> 87 </span>Apr <span class="hljs-number"> 2 </span>16:49 Vtable.CMA_GFS -&gt; /home/wpsze/WRF/WRFv450-CMA-GFS/wrf_install/WPS-4.5/ungrib/Variable_Tables/Vtable.CMA_GFS<br>lrwxrwxrwx<span class="hljs-number"> 1 </span>wpsze wpsze  <span class="hljs-number"> 81 </span>Apr <span class="hljs-number"> 2 </span>16:49 Z_NAFP_C_BABJ_20250112000000_P_NWPC-GRAPES-GFS-GLB-00000.grib2 -&gt; ../202501/20250112/Z_NAFP_C_BABJ_20250112000000_P_NWPC-GRAPES-GFS-GLB-00000.grib2<br></code></pre></td></tr></table></figure><p><em>[2025-04-09]</em> After create a land-sea mask field for CMA_GFS (see below section), <strong>GRIBFILE.AAB</strong>,</p><ul><li>re-compile <strong>WPS</strong> (<strong>WRFv450-CMA-GFS</strong>)</li></ul><figure class="highlight tap"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs tap">-rw-rw-r--<span class="hljs-number"> 1 </span>wpsze wpsze 3.2G Apr <span class="hljs-number"> 2 </span>16:56 CMA:2025-01-12_00<br>lrwxrwxrwx<span class="hljs-number"> 1 </span>wpsze wpsze  <span class="hljs-number"> 62 </span>Apr <span class="hljs-number"> 2 </span>16:50 GRIBFILE.AAA -&gt; Z_NAFP_C_BABJ_20250112000000_P_NWPC-GRAPES-GFS-GLB-00000.grib2<br>lrwxrwxrwx<span class="hljs-number"> 1 </span>wpsze wpsze  <span class="hljs-number"> 20 </span>Apr <span class="hljs-number"> 8 </span>18:01 GRIBFILE.AAB -&gt; final_cma_lsm.grib2<br>-rw-rw-r--<span class="hljs-number"> 1 </span>wpsze wpsze <span class="hljs-number"> 272 </span>Apr <span class="hljs-number"> 2 </span>16:50 namelist.wps<br>-rwxrwxr-x<span class="hljs-number"> 1 </span>wpsze wpsze 1.7K Apr <span class="hljs-number"> 2 </span>16:51 run_ungrid.sh*<br>lrwxrwxrwx<span class="hljs-number"> 1 </span>wpsze wpsze  <span class="hljs-number"> 67 </span>Apr <span class="hljs-number"> 2 </span>16:51 ungrib.exe -&gt; /home/wpsze/WRF/WRFv450-CMA-GFS/wrf_install/WPS-4.5/ungrib/ungrib.exe*<br>-rw-rw-r--<span class="hljs-number"> 1 </span>wpsze wpsze  30K Apr <span class="hljs-number"> 2 </span>16:57 ungrib.log<br>lrwxrwxrwx<span class="hljs-number"> 1 </span>wpsze wpsze  <span class="hljs-number"> 14 </span>Apr <span class="hljs-number"> 2 </span>16:51 Vtable -&gt; Vtable.CMA_GFS<br>lrwxrwxrwx<span class="hljs-number"> 1 </span>wpsze wpsze  <span class="hljs-number"> 87 </span>Apr <span class="hljs-number"> 2 </span>16:49 Vtable.CMA_GFS -&gt; /home/wpsze/WRF/WRFv450-CMA-GFS/wrf_install/WPS-4.5/ungrib/Variable_Tables/Vtable.CMA_GFS<br>lrwxrwxrwx<span class="hljs-number"> 1 </span>wpsze wpsze  <span class="hljs-number"> 81 </span>Apr <span class="hljs-number"> 2 </span>16:49 Z_NAFP_C_BABJ_20250112000000_P_NWPC-GRAPES-GFS-GLB-00000.grib2 -&gt; ../202501/20250112/Z_NAFP_C_BABJ_20250112000000_P_NWPC-GRAPES-GFS-GLB-00000.grib2<br></code></pre></td></tr></table></figure><h1 id="wrf">WRF</h1><ul><li>geogrid<ul><li><code>LANDMASK</code> is added here. <figure class="highlight console"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs console">  float LANDMASK(Time, south_north, west_east) ;<br>LANDMASK:FieldType = 104 ;<br>LANDMASK:MemoryOrder = &quot;XY &quot; ;<br>LANDMASK:units = &quot;none&quot; ;<br>LANDMASK:description = &quot;Landmask : 1=land, 0=water&quot; ;<br>LANDMASK:stagger = &quot;M&quot; ;<br>LANDMASK:sr_x = 1 ;<br>LANDMASK:sr_y = 1 ;<br></code></pre></td></tr></table></figure></li></ul></li><li>ungrib.exe<ul><li>We have to update the <strong>LANDMASK</strong> for CMA_GFS (see below section)</li><li><strong>final_cma_lsm.grib2</strong><ul><li>ungrib this grib2 individually and generate a intermediate file <strong>CMA_GFS_landmask</strong></li><li>CMA_GFS_landmask is <strong>constant field</strong>.</li></ul></li></ul></li><li>metgrib.exe<ul><li>namelist.wps <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs namelist.wps">&amp;metgrid<br>fg_name = &#x27;CMA_GFS&#x27;,<br>io_form_metgrid = 2, <br>constants_name = &#x27;CMA_GFS_landmask&#x27;,<br>opt_metgrid_tbl_path = &#x27;./&#x27;<br>/<br></code></pre></td></tr></table></figure></li><li><strong>! Successful completion of metgrid. !</strong>     <div class="fold">      <div class="fold-title fold-info collapsed" data-toggle="collapse" href="#collapse-5d5d193e" role="button" aria-expanded="false" aria-controls="collapse-5d5d193e">        <div class="fold-arrow">▶</div>log      </div>      <div class="fold-collapse collapse" id="collapse-5d5d193e">        <div class="fold-content">          <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs log">Processing domain 1 of 2<br>    CMA_GFS_landmask<br>Processing 2025-01-12_00<br>    CMA_GFS<br>Processing 2025-01-12_03<br>    CMA_GFS<br>Processing 2025-01-12_06<br>    CMA_GFS<br>Processing domain 2 of 2<br>    CMA_GFS_landmask<br>Processing 2025-01-12_00<br>    CMA_GFS<br>Processing 2025-01-12_03<br>    CMA_GFS<br>Processing 2025-01-12_06<br>    CMA_GFS<br>!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!<br>!  Successful completion of metgrid.  !<br>!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!<br></code></pre></td></tr></table></figure>        </div>      </div>    </div></li></ul></li><li>real.exe<ul><li><strong>real_em: SUCCESS COMPLETE REAL_EM INIT</strong></li></ul></li><li>wrf.exe<ul><li><strong>wrf: SUCCESS COMPLETE WRF</strong></li></ul></li></ul><h1 id="mpas">MPAS</h1><h2 id="mpasv7.3">MPASv7.3</h2><h3 id="init_atmosphere_model">init_atmosphere_model</h3><h4 id="error-1">Error 1</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs log">ERROR: ********************************************************************************<br>ERROR: LANDSEA field not found in meteorological data file CMA:2025-01-12_00<br>CRITICAL ERROR: ********************************************************************************<br></code></pre></td></tr></table></figure><ul><li>seems CMA_GFS doesn't contain <code>LANDSEA</code></li></ul><p>But, in <strong>static.nc</strong>, landmask is included. So, why does init_atmosphere_model have to check <strong>LANDSEA</strong>?</p><figure class="highlight console"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs console">int landmask(nCells) ;<br>landmask:units = &quot;unitless&quot; ;<br>landmask:long_name = &quot;land-ocean mask (1=land ; 0=ocean)&quot; ;<br></code></pre></td></tr></table></figure><ul><li><a href="https://forum.mmm.ucar.edu/threads/error-while-running-ungrib-exe-with-ifs-global-data.14439/#post-38395">Error while running ungrib.exe with IFS global data | Oct 28, 2023</a><ul><li>I tried removing all the fields that do not work with the new namelist record. <strong>However, MPAS needs the LANDSEA mask to work but I don't know how to add it in the Intermediate Files</strong>.</li><li>Landsea mask values in ECMWF data lie between 0 and 1, which is different to WRF static data that have values of either 0 (grid box is fully covered by water) or 1 (grid box is fully covered with land). Please see the website below that describes landsea mask in ECMWRF: <a href="https://confluence.ecmwf.int/display/FUG/Section+2.1.3.1+Land-Sea+Mask" class="uri">https://confluence.ecmwf.int/display/FUG/Section+2.1.3.1+Land-Sea+Mask</a></li><li><strong>I am suspicious that Landsea mask values in IFS global data follow the rule of ECMWF data, i.e., its values could be between 0 and 1. This might give rise to troubles when we run MPAS initialization</strong>.</li></ul></li><li><a href="https://forum.mmm.ucar.edu/threads/generating-initial-files-in-2-separate-stages.20522/">generating initial files in 2 separate stages | Jan 2025</a><ul><li>for instance, I found that landsea mask is a necessary parameter for processing pressure level data.</li></ul></li></ul><h5 id="take-ifss-land-sea-mask-wrong">Take IFS's land sea mask (Wrong!!)</h5><ul><li><code>./extract_landseamask.sh</code></li></ul><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-meta">#!/bin/bash</span><br><br>cdo selname,lsm 20250401000000-0h-oper-fc.grib2 lsm_nan.nc<br><br>cdo setmissval,-999 lsm_nan.nc lsm.nc<br><br>cdo -f grb2 copy lsm.nc lsm.grib<br><br>cdo showname lsm.grib<br><br>grib_set -s centre=babj,dataDate=20250112,dataTime=0000,shortName=lsm,typeOfLevel=surface,level=0 lsm.grib lsm_final.grib<br><br>cdo showname lsm_final.grib<br><br><span class="hljs-built_in">rm</span> lsm_nan.nc lsm.nc <br></code></pre></td></tr></table></figure><ul><li>ungrib step<ul><li><code>ln -s lsm.grib GRIBFILE.AAB</code> # the CMA_GFS.grib2 is GRIBFILE.AAA<ul><li>Error: <code>gb_info: can only decode GRIB edition 2.</code><ul><li>check: <code>$ grib_ls lsm.grib</code> <figure class="highlight console"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs console">edition      centre       typeOfLevel  level        dataDate     stepRange    shortName    packingType  gridType     <br>1         ecmf         surface      0            20250401     0            unknown      grid_simple  regular_ll  <br></code></pre></td></tr></table></figure></li><li>check: <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh">$ wgrib2 -var lsm.grib <br>1:0:LAND<br></code></pre></td></tr></table></figure></li></ul></li><li>Solution: <code>cdo -f grb2 copy lsm.nc lsm.grib</code> on <code>extract_landseamask.sh</code><ul><li>check: <code>$ grib_ls lsm.grib</code> <figure class="highlight console"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs console">edition      centre       date         dataType     gridType     stepRange    typeOfLevel  level        shortName    packingType  <br>2            ecmf         20250401     fc           regular_ll   0            surface      0            lsm          grid_simple <br></code></pre></td></tr></table></figure></li></ul></li></ul></li><li>But <code>init_atmosphere_model</code> still exists: <code>ERROR: LANDSEA field not found in meteorological data file CMA:2025-01-12_00</code></li><li>[not yet] Done and check: <code>$ ncl plotfmt.ncl 'filename="CMA:2025-01-12_00"'</code></li></ul></li></ul><h4 id="error-2">Error 2</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs log">CRITICAL ERROR: Error in interpolation of st_fg to MPAS grid: num_st = 18<br></code></pre></td></tr></table></figure><ul><li><a href="https://forum.mmm.ucar.edu/threads/error-creating-initial-conditions-with-ncep-fnl-ds083-2.17113/">Error creating initial conditions with NCEP FNL ds083.2 | May 8, 2024</a><ul><li>I'm trying to create the initial conditions file for MPAS (v8.1) using data obtained from the NCEP FNL ds083.2</li><li>Just had to change <code>config_nfgsoillevels</code> to <strong>2</strong> and <code>config_extrap_airtemp</code> to <strong>linear</strong> in <code>namelist.init_atmosphere</code>. Once those two modifications were made <code>init_atmosphere_model</code> and <code>atmosphere_model</code> ran without issues.</li><li>Note that <strong>FNL data only contains 2-level of soil information</strong>, which is why we need to set <strong>config_nfgsoillevels=2</strong>. <strong>The top of the FNL data is 10 hpa, and therefore extrapolation is needed if MPAS top level is above 10 hpa</strong>.</li><li>For the option of <code>config_extrap_airtemp</code>, would you please let me know what is the model top of your MPAS run? Thanks.</li></ul></li><li><a href="https://forum.mmm.ucar.edu/threads/initial-condition-critical-error-error-in-interpolation-of-st_fg-to-mpas.15807/">Initial condition CRITICAL ERROR: Error in interpolation of st_fg to MPAS | Feb 16, 2024</a></li><li><a href="https://forum.mmm.ucar.edu/threads/error-in-interpolation-of-st_fg-to-mpas-grid-with-variable-resolution-mesh-simulation.9387/">'Error in interpolation of st_fg to MPAS grid' with variable-resolution mesh simulation | Jul 23, 2020</a><ul><li><strong>The error message generally indicates that there are grid cells that have a soil temperature value less than or equal to zero.</strong></li><li>I solved the problem by downloading the "Vtable from the RDR page/WRF" and using WPS version 4.0 or higher.</li></ul></li><li><a href="https://forum.mmm.ucar.edu/threads/critical-error-error-in-interpolation-of-st_fg-to-mpas-grid.5382/">CRITICAL ERROR: Error in interpolation of st_fg to MPAS grid | Start dateMay 3, 2019</a><ul><li>This error message is an indication that there were one or more points in the MPAS mesh that received a zero or negative value for soil temperature.</li><li>Can you also verify that there are soil moisture and soil temperature fields in your WPS intermediate file, and that the number of soil levels in your intermediate files matches the value of the config_nfgsoillevels in your namelist.init_atmosphere file?</li></ul></li><li><a href="https://forum.mmm.ucar.edu/threads/critical-error-error-in-interpolation-of-st_fg-to-mpas-grid-num_st-18642.12857/">CRITICAL ERROR: Error in interpolation of st_fg to MPAS grid: num_st = 18642 | Apr 12, 2023</a><ul><li><strong>MPAS can only process soil data at specific levels with specific field names. If your input soil data are on levels or with names unrecognized by MPAS, then it won't work</strong>.</li><li>Please take a look at the code <strong>"mpas_init_atm_cases.F"</strong>, and the lines 3908 - 4118 process soil temperature data. This might give you some idea how MPAS works.</li></ul></li><li><a href="https://forum.mmm.ucar.edu/threads/trying-to-use-rap-as-ic-bc.5549/">Trying to Use RAP as IC/BC | Start dateJun 26, 2019</a><ul><li>The message "Error in interpolation of st_fg to MPAS grid: num_st = XXXX" is <strong>generally indicative of an issue with the soil temperature</strong>. Would it be possible to use some of the utilities that come with the WRF Pre-processing System (WPS) to check that there are valid soil temperature data in your intermediate file? Specifically, you could use the "<code>rd_intermediate</code>" utility to check that there are fields named, e.g., ST000010, and you could use the "<code>int2nc</code>" utility to convert the intermediate file to netCDF format, where it would be easier to view the soil fields with, e.g., <code>ncview</code>.</li></ul></li></ul><h5 id="check-grib2-file">check grib2 file</h5><p>In general, <strong>GFS/ERA5/IFS 0.25 deg grib files</strong> show</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs log"># Earth assumed spherical with radius of 6 371 229.0 m  (grib2/tables/25/3.2.table)                 <br>shapeOfTheEarth = 6;                                                                                <br>Ni = 1440;                                                                                          <br>Nj = 721;                                                                                        <br></code></pre></td></tr></table></figure><p>But, in CMA_GFS grib file, it has shown</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs log">#==============   MESSAGE 1 ( length=205 )                 ==============  <br>GRIB &#123;                                                                     <br>  # Meteorological products (grib2/tables/4/0.0.table)                     <br>  discipline = 0;                                                          <br>  editionNumber = 2;                                                       <br>  # Beijing  (RSMC)  (common/c-11.table)                                   <br>  centre = 38;                                                             <br>  subCentre = 0;                                                           <br>  # Analysis (grib2/tables/4/1.2.table)                                    <br>  significanceOfReferenceTime = 0;                                         <br>  dataDate = 20250112;                                                     <br>  dataTime = 0;    <br>......<br># Earth assumed spherical with radius of 6,371,229.0 m (grib2/tables/4/3.2.table)                  <br>shapeOfTheEarth = 6;                                                                               <br>Ni = 2880;                                                                                         <br>Nj = 1440;<br></code></pre></td></tr></table></figure><p>which <strong>is not 0.25 deg but 0.125 deg</strong>. Therefore, <code>LANDSEA</code> of IFS can not be used for CMA_GFS.</p><h4 id="take-gfss-land-sea-mask-wrong">Take GFS's land sea mask (Wrong!!)</h4><div class="note note-primary">            <p>The GFS land mask is not suitable for use with CMA_GFS.</p>          </div><h4 id="solution-successful">Solution (Successful)</h4><p>Move to next section <strong>"CMA_GFS Land Sea Mask"</strong></p><p>For MPASv7.3, it is <strong>Successful</strong>.</p><ul><li><strong>Successful completion of program ungrib.exe</strong></li><li><strong>Finished running the init_atmosphere core</strong></li><li><strong>Finished running the atmosphere core</strong></li></ul><div class="group-image-container"><div class="group-image-row"><div class="group-image-wrap"><img src="https://i.imgur.com/pdB6QnM.png" /></div><div class="group-image-wrap"><img src="https://i.imgur.com/f4xvs04.png" /></div><div class="group-image-wrap"><img src="https://i.imgur.com/lyWsoLX.png" /></div></div><div class="group-image-row"></div></div><h3 id="atmosphere_model">atmosphere_model</h3><ul><li><strong>Finished running the atmosphere core</strong></li></ul><h1 id="cma_gfs-land-sea-mask">CMA_GFS Land Sea Mask</h1><div class="note note-primary">            <p>If the GFS land mask is not suitable for use with CMA_GFS, the presence of 0K values could lead to problems. Is it possible for us to utilize this information to create a land-sea mask specifically for CMA_GFS from CMA_GFS?</p>          </div><h2 id="check-grib2s-soil-temperature">check grib2's soil temperature</h2><div class="group-image-container"><div class="group-image-row"><div class="group-image-wrap"><img src="https://i.imgur.com/So0DDy5.png" /></div><div class="group-image-wrap"><img src="https://i.imgur.com/JuV2vgI.png" /></div><div class="group-image-wrap"><img src="https://i.imgur.com/GbUafcp.png" /></div></div><div class="group-image-row"><div class="group-image-wrap"><img src="https://i.imgur.com/ZVtQcM4.png" /></div></div></div><h2 id="solution">Solution</h2><ul><li>We are required to <strong>create a land mask using the same source data as CMA_GFS to ensure consistency in our results</strong>. In this case, I will utilize the soil temperature data at depths of 1-2 meters, as this data shows a value of 0 in ocean areas.</li></ul><h3 id="wgrib2">wgrib2</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs log">$ wgrib2 Z_NAFP_C_BABJ_20250112000000_P_NWPC-GRAPES-GFS-GLB-00000.grib2<br><br>464:416263005:d=2025011200:TMP:0-0.1 m below ground:anl:<br>465:418796241:d=2025011200:TMP:0.1-0.4 m below ground:anl:<br>466:421201726:d=2025011200:TMP:0.4-1 m below ground:anl:<br>467:423468299:d=2025011200:TMP:1-2 m below ground:anl:<br>468:424559640:d=2025011200:SPFH:0-0.1 m below ground:anl:<br>469:426189296:d=2025011200:SPFH:0.1-0.4 m below ground:anl:<br>470:427793124:d=2025011200:SPFH:0.4-1 m below ground:anl:<br>471:429405783:d=2025011200:SPFH:1-2 m below ground:anl:<br></code></pre></td></tr></table></figure><ul><li><code>467:423468299:d=2025011200:TMP:1-2 m below ground:anl:</code> is our target.</li></ul><h3 id="extract-and-generate-new-grib2-for-landmask">extract and generate new grib2 for landmask</h3><ol type="1"><li>convert grib2 to nc file,</li></ol><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sh">wgrib2 Z_NAFP_C_BABJ_20250112000000_P_NWPC-GRAPES-GFS-GLB-00000.grib2 -match <span class="hljs-string">&#x27;:TMP:1-2 m below ground:&#x27;</span> -grib TMP_1_2m.grib2<br><br>grib_to_netcdf TMP_1_2m.grib2 -o TMP_1_2m.nc<br></code></pre></td></tr></table></figure><ol start="2" type="1"><li>modify/create landmask field for CMA_GFS,</li></ol><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> os<br><span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np<br><span class="hljs-keyword">import</span> xarray <span class="hljs-keyword">as</span> xr<br><span class="hljs-keyword">import</span> matplotlib.pyplot <span class="hljs-keyword">as</span> plt<br><br>TMP_1_2m_file = <span class="hljs-string">&quot;/home/wpsze/mpas/CMA_GFS/test/ungrib/TMP_1_2m.nc&quot;</span><br>TMP_1_2m_nc = xr.open_dataset(TMP_1_2m_file)<br><br><span class="hljs-comment"># plt.imshow(TMP_1_2m_nc[&#x27;t&#x27;][0,:,:])</span><br><br><span class="hljs-comment"># Check for non-zero values and assign them to 1</span><br>TMP_1_2m_nc[<span class="hljs-string">&#x27;t&#x27;</span>] = TMP_1_2m_nc[<span class="hljs-string">&#x27;t&#x27;</span>].where(TMP_1_2m_nc[<span class="hljs-string">&#x27;t&#x27;</span>] == <span class="hljs-number">0</span>, <span class="hljs-number">1</span>)<br><br><span class="hljs-comment"># plt.imshow(TMP_1_2m_nc[&#x27;t&#x27;][0,:,:])</span><br><br>TMP_1_2m_nc = TMP_1_2m_nc.rename(&#123;<span class="hljs-string">&#x27;t&#x27;</span>: <span class="hljs-string">&#x27;lsm&#x27;</span>&#125;)<br>TMP_1_2m_nc[<span class="hljs-string">&#x27;lsm&#x27;</span>] = TMP_1_2m_nc[<span class="hljs-string">&#x27;lsm&#x27;</span>].assign_attrs(<br>                standard_name = <span class="hljs-string">&quot;land_binary_mask&quot;</span>,<br>        long_name = <span class="hljs-string">&quot;Land-sea mask&quot;</span>,<br>        units = <span class="hljs-string">&quot;(0 - 1)&quot;</span>)<br><br><span class="hljs-comment">#================== Save =================================================</span><br><span class="hljs-comment"># Save the result to a new NetCDF file</span><br>TMP_1_2m_nc.to_netcdf(<span class="hljs-string">f&#x27;/home/wpsze/mpas/CMA_GFS/test/ungrib/new_TMP_1_2m.nc&#x27;</span>, <span class="hljs-built_in">format</span>=<span class="hljs-string">&#x27;NETCDF4&#x27;</span>)<br></code></pre></td></tr></table></figure><ul><li>Left: original soil temperature; Right: our created Land sea mask field for CMA_GFS</li></ul><div class="group-image-container"><div class="group-image-row"><div class="group-image-wrap"><img src="https://i.imgur.com/5O95DVb.png" /></div><div class="group-image-wrap"><img src="https://i.imgur.com/r01Obgx.png" /></div></div><div class="group-image-row"></div></div><ol start="3" type="1"><li>convert landmask nc file to grib2</li></ol><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs sh">cdo -f grb2 copy new_TMP_1_2m.nc new_TMP_1_2m.grib2<br><br><span class="hljs-comment"># check</span><br>grib_ls new_TMP_1_2m.grib2<br>wgrib2 new_TMP_1_2m.grib2<br><br>grib_set -r -w packingType=grid_ieee -s centre=babj,shortName=lsm,typeOfLevel=surface,level=0,dataType=an,packingType=grid_jpeg new_TMP_1_2m.grib2 final_TMP_1_2m.grib2<br><br><span class="hljs-built_in">mv</span> final_TMP_1_2m.grib2 final_cma_lsm.grib2<br></code></pre></td></tr></table></figure><ul><li>Make sure the <strong>datetime is updated with your run</strong>.</li></ul><blockquote><p><strong>grib_set -r -w packingType=grid_ieee -s centre=babj,shortName=lsm,typeOfLevel=surface,level=0,dataType=an,packingType=grid_jpeg,dataDate=20250416,dataTime=0000 new_TMP_1_2m.grib2 final_TMP_1_2m.grib2</strong></p></blockquote><ul><li><code>./g2print.exe final_cma_lsm.grib2</code></li><li><code>2 0 0 1</code> here correpsonds to <code>Vtable.CMA_GFS</code><ul><li><strong>LANDSEA</strong></li><li><code>| LANDSEA  | proprtn | Land/Sea flag (1=land, 0 or 2=sea)      |  2  |  0  |  0  |   1 |</code></li></ul></li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs log"> ungrib - grib edition num           2<br> reading from grib file = final_cma_lsm.grib2                                                                                                    <br>      unknown model and orig center   <br>---------------------------------------------------------------------------------------<br> rec Prod Cat Param  Lvl    Lvl      Lvl     Prod    Name            Time          Fcst<br> num Disc     num    code   one      two     Templ                                 hour<br>---------------------------------------------------------------------------------------<br>   1   2    0   0       1       0       0       0     LAND     2025-01-12_00:00:00   00          <br>  <br>  <br>   Successful completion of g2print  <br></code></pre></td></tr></table></figure><h1 id="cronjob">cronjob</h1>    <div class="fold">      <div class="fold-title fold-info collapsed" data-toggle="collapse" href="#collapse-639614a5" role="button" aria-expanded="false" aria-controls="collapse-639614a5">        <div class="fold-arrow">▶</div>wpsze_download_CMA_GFS-cronjob-00z.sh      </div>      <div class="fold-collapse collapse" id="collapse-639614a5">        <div class="fold-content">          <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-meta">#!/bin/sh</span><br><span class="hljs-comment">#################################################################</span><br><span class="hljs-comment"># http://data.wis.cma.cn/DCPC_WMC_BJ/open/nwp/gmf_gra/t0000/f0_f240_6h/Z_NAFP_C_BABJ_20250401000000_P_NWPC-GRAPES-GFS-GLB-00000.grib2</span><br><span class="hljs-comment">#################################################################</span><br><span class="hljs-built_in">source</span> /home/wpsze/micromamba/etc/profile.d/micromamba.sh<br>micromamba activate venv<br><br>BASE_DIR=$(<span class="hljs-built_in">pwd</span>)<br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;Base Dir = <span class="hljs-variable">$&#123;BASE_DIR&#125;</span>&quot;</span><br><br><span class="hljs-keyword">for</span> ifsday <span class="hljs-keyword">in</span> $(<span class="hljs-built_in">seq</span> 0 1 1); <span class="hljs-keyword">do</span> <span class="hljs-comment"># day-shift = 0, 1</span><br><br>    YYYYMMDDHH=$(<span class="hljs-built_in">date</span> -d <span class="hljs-string">&quot;today - <span class="hljs-variable">$&#123;ifsday&#125;</span> day&quot;</span> +%Y%m%d00)<br><br>    yyyy=<span class="hljs-variable">$&#123;YYYYMMDDHH:0:4&#125;</span><br>    mm=<span class="hljs-variable">$&#123;YYYYMMDDHH:4:2&#125;</span><br>    <span class="hljs-built_in">dd</span>=<span class="hljs-variable">$&#123;YYYYMMDDHH:6:2&#125;</span><br>    hh=<span class="hljs-variable">$&#123;YYYYMMDDHH:8:2&#125;</span><br><br>    yyyymm=<span class="hljs-variable">$&#123;yyyy&#125;</span><span class="hljs-variable">$&#123;mm&#125;</span><br>    yyyymmdd=<span class="hljs-variable">$&#123;yyyy&#125;</span><span class="hljs-variable">$&#123;mm&#125;</span><span class="hljs-variable">$&#123;dd&#125;</span><br><br>    tmp_dir=<span class="hljs-string">&quot;./<span class="hljs-variable">$&#123;yyyy&#125;</span><span class="hljs-variable">$&#123;mm&#125;</span>/<span class="hljs-variable">$&#123;yyyy&#125;</span><span class="hljs-variable">$&#123;mm&#125;</span><span class="hljs-variable">$&#123;dd&#125;</span>&quot;</span><br>    <span class="hljs-built_in">mkdir</span> -p <span class="hljs-variable">$&#123;tmp_dir&#125;</span><br>    <span class="hljs-built_in">cd</span> <span class="hljs-variable">$&#123;tmp_dir&#125;</span><br>    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;Current Dir: <span class="hljs-subst">$(pwd)</span>&quot;</span><br><br>    limit_cpu_core=15<br>    count_cpu_core=1<br><br>    <span class="hljs-comment">#============== 00z ===================================</span><br>    tmp_cma_gfs_fname=<span class="hljs-string">&quot;Z_NAFP_C_BABJ_<span class="hljs-variable">$&#123;YYYYMMDDHH&#125;</span>0000_P_NWPC-GRAPES-GFS-GLB-00000.grib2&quot;</span><br><br>    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;Now, <span class="hljs-variable">$&#123;tmp_cma_gfs_fname&#125;</span> ... &quot;</span><br><br>    <span class="hljs-keyword">if</span> [[ ! -f <span class="hljs-string">&quot;<span class="hljs-variable">$&#123;tmp_cma_gfs_fname&#125;</span>&quot;</span> ]]; <span class="hljs-keyword">then</span><br>    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;Downloading ... <span class="hljs-variable">$&#123;tmp_cma_gfs_fname&#125;</span>&quot;</span><br>    <span class="hljs-comment">#wget --no-check-certificate http://data.wis.cma.cn/DCPC_WMC_BJ/open/nwp/gmf_gra/t0000/f0_f240_6h/Z_NAFP_C_BABJ_20250401000000_P_NWPC-GRAPES-GFS-GLB-00000.grib2</span><br>    wget --no-check-certificate http://data.wis.cma.cn/DCPC_WMC_BJ/open/nwp/gmf_gra/t0000/f0_f240_6h/<span class="hljs-variable">$&#123;tmp_cma_gfs_fname&#125;</span><br>    <span class="hljs-keyword">else</span><br>        <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;<span class="hljs-variable">$&#123;tmp_cma_gfs_fname&#125;</span> exists ... &quot;</span><br>    <span class="hljs-keyword">fi</span><br><br>    res=$(( <span class="hljs-variable">$&#123;count_cpu_core&#125;</span> % <span class="hljs-variable">$&#123;limit_cpu_core&#125;</span> ))<br>    <span class="hljs-keyword">if</span> [[ <span class="hljs-variable">$&#123;res&#125;</span> == 0 ]]; <span class="hljs-keyword">then</span><br>    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;please wait <span class="hljs-variable">$&#123;tmp_cma_gfs_fname&#125;</span>, <span class="hljs-variable">$&#123;count_cpu_core&#125;</span>, <span class="hljs-variable">$&#123;res&#125;</span>.&quot;</span><br>    <span class="hljs-built_in">wait</span><br>    <span class="hljs-keyword">fi</span><br>    <br>    <span class="hljs-built_in">cd</span> <span class="hljs-variable">$&#123;BASE_DIR&#125;</span><br><span class="hljs-keyword">done</span>    <br></code></pre></td></tr></table></figure>        </div>      </div>    </div><ul><li><strong>HKT = UTC + 8</strong></li><li>How to set the crontab: <code>$ crontab -e</code></li></ul><figure class="highlight console"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs console"><span class="hljs-meta prompt_">$ </span><span class="language-bash">crontab -l</span><br>00 16 * * * cd /home/wpsze/mpas/CMA_GFS; sh wpsze_download_CMA_GFS-cronjob-00z.sh<br>00 16 * * * cd /home/wpsze/mpas/CMA_GFS; sh wpsze_download_CMA_GFS-cronjob-12z.sh<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>NWP</category>
      
    </categories>
    
    
    <tags>
      
      <tag>NWP</tag>
      
      <tag>WRF</tag>
      
      <tag>MPAS</tag>
      
      <tag>CMA</tag>
      
      <tag>CMA_GFS</tag>
      
      <tag>Land-sea mask</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>NWP | DA | Kalman Filter</title>
    <link href="/2025/04/02/NWP-DA-Kalman-Filter/"/>
    <url>/2025/04/02/NWP-DA-Kalman-Filter/</url>
    
    <content type="html"><![CDATA[<p><strong>Optimal Interpolation (OI), 3D-Variational Assimilation (3DVar), and the Kalman Filter (KF) share foundational mathematical objectives</strong> but differ in implementation and error covariance treatment. Below is a formulation of their core equations and key comparisons.</p><hr /><h2 id="mathematical-formulations">Mathematical Formulations</h2><h3 id="optimal-interpolation-oi"><strong>Optimal Interpolation (OI)</strong></h3><p><span class="math display">\[\mathbf{x}^a = \mathbf{x}^b + \mathbf{W}\left(\mathbf{y}^o - \mathbf{H}\mathbf{x}^b\right)\]</span> - <strong>Weights</strong>: <span class="math inline">\(\mathbf{W} = \mathbf{B}\mathbf{H}^T\left(\mathbf{H}\mathbf{B}\mathbf{H}^T + \mathbf{R}\right)^{-1}\)</span><br />- <strong>Static Covariances</strong>: Background (<span class="math inline">\(\mathbf{B}\)</span>) and observation (<span class="math inline">\(\mathbf{R}\)</span>) error covariances are predefined and stationary.</p><div class="note note-primary">            <p><a href="https://waipangsze.github.io/2025/04/02/NWP-DA-Optimal-weight-matrix-W/"><strong>NWP | DA | Optimal weight matrix W</strong></a></p>          </div><hr /><h3 id="d-variational-assimilation-3dvar"><strong>3D-Variational Assimilation (3DVar)</strong></h3><p><span class="math display">\[J(\mathbf{x}) = \frac{1}{2}(\mathbf{x}-\mathbf{x}^b)^T\mathbf{B}^{-1}(\mathbf{x}-\mathbf{x}^b) + \frac{1}{2}(\mathbf{y}^o-\mathbf{H}\mathbf{x})^T\mathbf{R}^{-1}(\mathbf{y}^o-\mathbf{H}\mathbf{x})\]</span> - Minimizes <span class="math inline">\(J(\mathbf{x})\)</span> to find <span class="math inline">\(\mathbf{x}^a\)</span>. - <strong>Equivalence to OI</strong>: For linear <span class="math inline">\(\mathbf{H}\)</span> and Gaussian errors, 3DVar and OI yield identical solutions.</p><hr /><h3 id="kalman-filter-kf"><strong>Kalman Filter (KF)</strong></h3><p><strong>Predict Step</strong>: <span class="math display">\[\begin{aligned}\mathbf{\hat{x}}_{k|k-1} &amp;= \mathbf{F}\mathbf{\hat{x}}_{k-1|k-1} \quad &amp;\text{(State prediction)} \\\mathbf{P}_{k|k-1} &amp;= \mathbf{F}\mathbf{P}_{k-1|k-1}\mathbf{F}^T + \mathbf{Q} \quad &amp;\text{(Covariance prediction)}\end{aligned}\]</span> <strong>Update Step</strong>: <span class="math display">\[\begin{aligned}\mathbf{K}_k &amp;= \mathbf{P}_{k|k-1}\mathbf{H}^T\left(\mathbf{H}\mathbf{P}_{k|k-1}\mathbf{H}^T + \mathbf{R}\right)^{-1} \quad &amp;\text{(Kalman gain)} \\\mathbf{\hat{x}}_{k|k} &amp;= \mathbf{\hat{x}}_{k|k-1} + \mathbf{K}_k\left(\mathbf{y}^o - \mathbf{H}\mathbf{\hat{x}}_{k|k-1}\right) \quad &amp;\text{(State update)} \\\mathbf{P}_{k|k} &amp;= (\mathbf{I} - \mathbf{K}_k\mathbf{H})\mathbf{P}_{k|k-1} \quad &amp;\text{(Covariance update)}\end{aligned}\]</span> - <strong>Dynamic Covariances</strong>: <span class="math inline">\(\mathbf{P}\)</span> evolves with time, capturing flow-dependent errors.</p><p><img src="https://i.imgur.com/ChQMBeV.png" /></p><hr /><h2 id="key-similarities">Key Similarities</h2><ol type="1"><li><strong>Objective</strong>: Minimize analysis error via <span class="math inline">\(\mathbf{y}^o\)</span> and <span class="math inline">\(\mathbf{x}^b\)</span>.</li><li><strong>Linear-Gaussian Assumption</strong>: All methods assume linear observation operators (<span class="math inline">\(\mathbf{H}\)</span>) and Gaussian errors for optimality.</li><li><strong>Weighting</strong>: Use inverse error covariances (<span class="math inline">\(\mathbf{B}^{-1}\)</span>, <span class="math inline">\(\mathbf{R}^{-1}\)</span>) to balance observations and background.</li></ol><hr /><h2 id="critical-differences">Critical Differences</h2><table><thead><tr class="header"><th>Aspect</th><th><strong>OI</strong></th><th><strong>3DVar</strong></th><th><strong>Kalman Filter</strong></th></tr></thead><tbody><tr class="odd"><td><strong>Covariance</strong></td><td>Static <span class="math inline">\(\mathbf{B}\)</span></td><td>Static <span class="math inline">\(\mathbf{B}\)</span></td><td>Dynamic <span class="math inline">\(\mathbf{P}_{k\|k}\)</span></td></tr><tr class="even"><td><strong>Computation</strong></td><td>Direct matrix inversion</td><td>Gradient-based minimization</td><td>Recursive covariance updates</td></tr><tr class="odd"><td><strong>Error Propagation</strong></td><td>None (stationary)</td><td>None (stationary)</td><td>Model-derived (<span class="math inline">\(\mathbf{F}\)</span>)</td></tr><tr class="even"><td><strong>Cost</strong></td><td>Low</td><td>Moderate</td><td>High (ensemble/recursive)</td></tr><tr class="odd"><td><strong>Typical Use</strong></td><td>Historical systems</td><td>Operational NWP</td><td>Adaptive systems, AI models</td></tr></tbody></table><hr /><h3 id="hybrid-methods-e.g.-3denvar">Hybrid Methods (e.g., 3DEnVar)</h3><p>Combine static <span class="math inline">\(\mathbf{B}\)</span> (from 3DVar) with ensemble-derived covariances (from EnKF) for flow-dependent updates. Example: <span class="math display">\[\mathbf{B}_{\text{hybrid}} = \alpha \mathbf{B}_{\text{static}} + \beta \mathbf{B}_{\text{ensemble}}\]</span></p><h1 id="references">References</h1><ol type="1"><li><a href="https://mp.weixin.qq.com/s?__biz=MzkxNjczOTc3Nw==&amp;mid=2247486030&amp;idx=1&amp;sn=327f7931f068c47c416decfba2be0bbd&amp;">用最少的公式讲解几种传统数据同化方法的发展路径 | 2025</a><ol type="1"><li>但凡提到传统同化方法的不足，我们言必及“<strong>线性-高斯分布假设</strong>”，然而我们在EKF中就已经适用非线性模式了，这个”线性-高斯分布假设“到底说的是什么呢？</li><li>一个根本性的问题，不确定性是否等价于误差协方差矩阵的大小？在自然界中，高斯分布（正态分布）是一个完美的分布，因为它仅使用均值和方差这两个关键参数就可以完全确定其形状和位置。</li><li>事实上，只有高斯分布才能只用协方差矩阵就完全确定其概率分布。<strong>所以在同化算法中默认用协方差矩阵表示不确定性其实已经默认了对象的分布是高斯分布</strong>。</li><li>在此情况下公式(3)显然是包含高斯分布假设的，所以一切卡尔曼滤波方法都含有高斯分布假设。至于线性假设更容易说明：高斯分布的随机变量经过非线性变换后，通常不会保持高斯分布，非线性模式积分会改变状态变量的分布特征，使其偏离原始的高斯分布。所以如果假设数据一直符合高斯分布的话，那必然还默认了模式是线性的。</li><li>线性-高斯分布假设是卡尔曼滤波算法的先天不足，且四维变分方法也无法幸免。<strong>因为只要是只用协方差矩阵来代表状态不确定性的算法，毫无疑问都可以说它受限于”线性-高斯分布假设“</strong>。</li></ol></li></ol>]]></content>
    
    
    <categories>
      
      <category>NWP</category>
      
    </categories>
    
    
    <tags>
      
      <tag>NWP</tag>
      
      <tag>WRF</tag>
      
      <tag>MPAS</tag>
      
      <tag>DA</tag>
      
      <tag>KF</tag>
      
      <tag>EKF</tag>
      
      <tag>EnKF</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>NWP | DA | Optimal weight matrix W</title>
    <link href="/2025/04/02/NWP-DA-Optimal-weight-matrix-W/"/>
    <url>/2025/04/02/NWP-DA-Optimal-weight-matrix-W/</url>
    
    <content type="html"><![CDATA[<ul><li><a href="https://waipangsze.github.io/2024/09/24/DA-intro/"><strong>Data assimilation (DA)</strong></a></li><li><a href="https://waipangsze.github.io/2025/04/02/NWP-DA-Kalman-Filter/"><strong>NWP | DA | Kalman Filter</strong></a></li><li><a href="https://waipangsze.github.io/2025/03/20/NWP-DA-4Dvar/"><strong>NWP | DA | 4D-Var</strong></a></li></ul><hr /><p>To derive the <strong>optimal weight matrix</strong> $ $in DA, we follow a minimum variance approach to combine background (model) and observation data. Here’s a step-by-step mathematical formulation:</p><hr /><h1 id="step-1-define-analysis-and-errors">Step 1: Define Analysis and Errors</h1><ul><li><strong>Analysis</strong>: <span class="math inline">\(\mathbf{x}^a = \mathbf{x}^b + \mathbf{W}(\mathbf{y}^o - \mathbf{H}\mathbf{x}^b)\)</span></li><li><strong>Analysis error</strong>: <span class="math inline">\(\mathbf{\epsilon}^a = \mathbf{x}^a - \mathbf{x}^t = \mathbf{\epsilon}^b - \mathbf{W}(\mathbf{H}\mathbf{\epsilon}^b + \mathbf{\epsilon}^o)\)</span><ul><li><span class="math inline">\(\mathbf{x}^t\)</span>: True state</li><li><span class="math inline">\(\mathbf{\epsilon}^b\)</span>: Background error (<span class="math inline">\(\mathbf{x}^b - \mathbf{x}^t\)</span>)</li><li><span class="math inline">\(\mathbf{\epsilon}^o\)</span>: Observation error (<span class="math inline">\(\mathbf{y}^o - \mathbf{H}\mathbf{x}^t\)</span>)</li></ul></li></ul><hr /><h1 id="step-2-analysis-error-covariance-matrix">Step 2: Analysis Error Covariance Matrix</h1><p>The covariance matrix of the analysis error is: <span class="math display">\[\mathbf{P}^a = \mathbb{E}[\mathbf{\epsilon}^a (\mathbf{\epsilon}^a)^T] = (\mathbf{I} - \mathbf{W}\mathbf{H})\mathbf{B}(\mathbf{I} - \mathbf{W}\mathbf{H})^T + \mathbf{W}\mathbf{R}\mathbf{W}^T\]</span> - <span class="math inline">\(\mathbf{B} = \mathbb{E}[\mathbf{\epsilon}^b (\mathbf{\epsilon}^b)^T]\)</span>: Background error covariance - <span class="math inline">\(\mathbf{R} = \mathbb{E}[\mathbf{\epsilon}^o (\mathbf{\epsilon}^o)^T]\)</span>: Observation error covariance</p><hr /><h1 id="step-3-minimize-analysis-error-variance">Step 3: Minimize Analysis Error Variance</h1><p>Minimize the <strong>trace</strong> of $^a $(total analysis error variance) with respect to <span class="math inline">\(\mathbf{W}\)</span>: <span class="math display">\[\frac{\partial \, \text{tr}(\mathbf{P}^a)}{\partial \mathbf{W}} = -2(\mathbf{I} - \mathbf{W}\mathbf{H})\mathbf{B}\mathbf{H}^T + 2\mathbf{W}\mathbf{R} = 0\]</span></p><hr /><h1 id="step-4-solve-for-mathbfw">Step 4: Solve for <span class="math inline">\(\mathbf{W}\)</span></h1><p>Rearrange the derivative equation: <span class="math display">\[(\mathbf{I} - \mathbf{W}\mathbf{H})\mathbf{B}\mathbf{H}^T = \mathbf{W}\mathbf{R}\]</span> Expand and solve: <span class="math display">\[\mathbf{B}\mathbf{H}^T = \mathbf{W}(\mathbf{H}\mathbf{B}\mathbf{H}^T + \mathbf{R})\]</span> <strong>Optimal Weight Matrix</strong>: <span class="math display">\[\mathbf{W} = \mathbf{B}\mathbf{H}^T (\mathbf{H}\mathbf{B}\mathbf{H}^T + \mathbf{R})^{-1}\]</span></p><hr /><h2 id="key-insights">Key Insights</h2><ol type="1"><li><strong>Structure of <span class="math inline">\(\mathbf{W}\)</span></strong>:<ul><li><span class="math inline">\(\mathbf{B}\mathbf{H}^T\)</span>: Covariance between background and observation spaces.</li><li><span class="math inline">\((\mathbf{H}\mathbf{B}\mathbf{H}^T + \mathbf{R})^{-1}\)</span>: Normalizes by total uncertainty (background + observation errors).</li></ul></li><li><strong>Assumptions</strong>:<ul><li>Background and observation errors are <strong>uncorrelated</strong>: <span class="math inline">\(\mathbb{E}[\mathbf{\epsilon}^b (\mathbf{\epsilon}^o)^T] = 0\)</span>.</li><li>Linear observation operator <span class="math inline">\(\mathbf{H}\)</span>.</li></ul></li></ol><hr /><h1 id="comparison-to-3d-var-and-kalman-filter">Comparison to 3D-Var and Kalman Filter</h1><table><thead><tr class="header"><th>Method</th><th>Weight Equation</th><th>Covariance Treatment</th></tr></thead><tbody><tr class="odd"><td><strong>OI</strong></td><td><span class="math inline">\(\mathbf{W} = \mathbf{B}\mathbf{H}^T (\mathbf{H}\mathbf{B}\mathbf{H}^T + \mathbf{R})^{-1}\)</span></td><td>Static <span class="math inline">\(\mathbf{B}\)</span>, <span class="math inline">\(\mathbf{R}\)</span></td></tr><tr class="even"><td><strong>3D-Var</strong></td><td>Implicit via cost function minimization</td><td>Static <span class="math inline">\(\mathbf{B}\)</span></td></tr><tr class="odd"><td><strong>Kalman</strong></td><td><span class="math inline">\(\mathbf{K}_k = \mathbf{P}_{k\|k-1}\mathbf{H}^T (\mathbf{H}\mathbf{P}_{k\|k-1}\mathbf{H}^T + \mathbf{R})^{-1}\)</span></td><td>Dynamic <span class="math inline">\(\mathbf{P}_{k\|k}\)</span></td></tr></tbody></table><hr /><h1 id="practical-example">Practical Example</h1><p>For a <strong>2-observation system</strong> (simplified from[3]): - Background error variance: <span class="math inline">\((\sigma^b)^2\)</span> - Observation error variance: <span class="math inline">\((\sigma^o)^2\)</span> - Correlation coefficients: <span class="math inline">\(\rho_{10}, \rho_{20}, \rho_{12}\)</span> - Weights: <span class="math display">\[  w_1 = \frac{\rho_{10}(1 + \alpha) - \rho_{12}\rho_{20}}{(1 + \alpha)^2 - \rho_{12}^2}, \quad w_2 = \frac{\rho_{20}(1 + \alpha) - \rho_{12}\rho_{10}}{(1 + \alpha)^2 - \rho_{12}^2} \]</span> where <span class="math inline">\(\alpha = (\sigma^o)^2 / (\sigma^b)^2\)</span>.</p><p>This ensures observations with smaller errors (<span class="math inline">\(\sigma^o\)</span>) or higher correlation (<span class="math inline">\(\rho\)</span>) receive greater weight.</p><h1 id="rerferences">Rerferences</h1><ol type="1"><li><a href="https://dspace.library.uu.nl/bitstream/1874/580/16/c4.pdf" class="uri">https://dspace.library.uu.nl/bitstream/1874/580/16/c4.pdf</a></li><li><a href="http://psc.apl.washington.edu/nonwp_projects/PHC/oi.html" class="uri">http://psc.apl.washington.edu/nonwp_projects/PHC/oi.html</a></li><li><a href="https://www.atmosp.physics.utoronto.ca/PHY2509/ch3.pdf" class="uri">https://www.atmosp.physics.utoronto.ca/PHY2509/ch3.pdf</a></li><li><a href="https://twister.caps.ou.edu/OBAN2019/3DVAR.pdf" class="uri">https://twister.caps.ou.edu/OBAN2019/3DVAR.pdf</a></li><li><a href="https://maths.ucd.ie/~plynch/LECTURE-NOTES/NWP-2004/NWP-CH05-4-1.pdf" class="uri">https://maths.ucd.ie/~plynch/LECTURE-NOTES/NWP-2004/NWP-CH05-4-1.pdf</a></li><li><a href="https://people.duke.edu/~hpgavin/Risk/interpolation.pdf" class="uri">https://people.duke.edu/~hpgavin/Risk/interpolation.pdf</a></li><li><a href="https://pro.arcgis.com/en/pro-app/latest/tool-reference/image-analyst/learn-more-about-optimal-interpolation.htm" class="uri">https://pro.arcgis.com/en/pro-app/latest/tool-reference/image-analyst/learn-more-about-optimal-interpolation.htm</a></li><li><a href="https://twister.caps.ou.edu/OBAN2019/METR5303_Lecture14.pdf" class="uri">https://twister.caps.ou.edu/OBAN2019/METR5303_Lecture14.pdf</a></li></ol>]]></content>
    
    
    <categories>
      
      <category>NWP</category>
      
    </categories>
    
    
    <tags>
      
      <tag>NWP</tag>
      
      <tag>WRF</tag>
      
      <tag>MPAS</tag>
      
      <tag>DA</tag>
      
      <tag>KF</tag>
      
      <tag>EKF</tag>
      
      <tag>EnKF</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>NWP | DA | 4D-Var</title>
    <link href="/2025/03/20/NWP-DA-4Dvar/"/>
    <url>/2025/03/20/NWP-DA-4Dvar/</url>
    
    <content type="html"><![CDATA[<ul><li><a href="https://waipangsze.github.io/2024/09/24/DA-intro/"><strong>Data assimilation (DA)</strong></a></li></ul><hr /><ul><li><a href="https://gmao.gsfc.nasa.gov/events/adjoint_workshop-8/present/Sunday/Kepert1.pdf">4D-Var for Dummies | 2009</a></li><li><a href="https://www.ecmwf.int/en/newsletter/175/earth-system-science/linearised-physics-heart-ecmwfs-4d-var">Linearised physics: the heart of ECMWF’s 4D-Var | 2023</a></li><li><a href="http://mopl.as.ntu.edu.tw/web/ASJ/46/46-4-1.pdf">WRF 多重解析度四維變分資料同化方法之研究 | 劉志權 | 2019</a></li><li><a href="https://www.ecmwf.int/en/about/media-centre/news/2022/25-years-4d-var-how-machine-learning-can-improve-use-observations">25 years of 4D-Var: how machine learning can improve the use of observations | EMCWF | 2022</a></li><li><a href="https://www2.atmos.umd.edu/~ekalnay/pubs/4DVarEnKFKalnaySAMSI.ppt.pdf">The Future of Data Assimilation: 4D-Var or Ensemble Kalman Filter?4D-Var or Ensemble Kalman Filter</a></li><li><a href="https://www.myroms.org/wiki/4DVar_Tutorial_Introduction">ROMS 4D-Var data assimilation algorithms</a></li></ul>]]></content>
    
    
    <categories>
      
      <category>NWP</category>
      
    </categories>
    
    
    <tags>
      
      <tag>NWP</tag>
      
      <tag>WRF</tag>
      
      <tag>MPAS</tag>
      
      <tag>DA</tag>
      
      <tag>4Dvar</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>NWP | Spectral Method</title>
    <link href="/2025/03/20/NWP-Spectral-Method/"/>
    <url>/2025/03/20/NWP-Spectral-Method/</url>
    
    <content type="html"><![CDATA[<h1 id="spectral-methods">Spectral methods</h1><p><strong>Spectral methods</strong> in numerical weather prediction (NWP) are advanced computational techniques that use global basis functions to solve the atmospheric governing equations with high accuracy. These methods are particularly effective for simulating large-scale weather patterns due to their exponential convergence properties when solutions are smooth. Here's a detailed breakdown:</p><h2 id="core-concept-of-spectral-methods">Core Concept of Spectral Methods</h2><p>Spectral methods approximate meteorological variables (e.g., wind, temperature) by expanding them into series of orthogonal basis functions, such as <strong>spherical harmonics</strong> for global atmospheric models. For example, a variable <span class="math display">\[ u(x,t) \]</span> might be written as:<br /><span class="math display">\[u(x,t) = \sum_{n=0}^N a_n(t) \phi_n(x)\]</span><br />where <span class="math inline">\(\phi_n(x)\)</span> are <strong>pre-defined basis functions</strong> (e.g., <strong>Fourier modes or Chebyshev polynomials</strong>), and <span class="math inline">\(a_n(t)\)</span> are time-dependent coefficients. Derivatives are computed analytically using the properties of these functions, avoiding the numerical errors common in finite-difference approximations.</p><h3 id="ecmwf-spherical-harmonics">ECMWF: Spherical harmonics</h3><p><strong>Spherical harmonics</strong> are a set of orthogonal basis functions defined on the surface of a sphere. They are used to represent atmospheric variables such as wind, temperature, and pressure in terms of a series expansion.</p><p><img src="https://i.imgur.com/vziet9g.png" alt="Some ECMWF data produced by the IFS is stored in GRIB with gridType=sh to indicate that the values are stored as spherical harmonic coefficients." /> <img src="https://i.imgur.com/ZQvmeDV.png" alt="The figure depicts the spherical harmonic (n, m) wave number space for a triangular truncation, T." /></p><div class="group-image-container"><div class="group-image-row"><div class="group-image-wrap"><img src="https://i.imgur.com/jpNOHrs.png" /></div><div class="group-image-wrap"><img src="https://i.imgur.com/zplgjZO.png" /></div><div class="group-image-wrap"><img src="https://i.imgur.com/aG9HKx7.png" /></div></div><div class="group-image-row"><div class="group-image-wrap"><img src="https://i.imgur.com/kCsOEPO.png" /></div><div class="group-image-wrap"><img src="https://i.imgur.com/Wny2y5F.png" /></div><div class="group-image-wrap"><img src="https://i.imgur.com/Bfpm51t.png" /></div></div></div><h4 id="how-to-find-the-resolution-of-a-spherical-harmonic-field-in-grib"><a href="https://confluence.ecmwf.int/display/UDOC/How+to+find+the+resolution+of+a+spherical+harmonic+field+in+GRIB+-+ecCodes+GRIB+FAQ">How to find the resolution of a spherical harmonic field in GRIB</a></h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh">$ grib_get -p J t1000.grib<br>1279<br></code></pre></td></tr></table></figure><p>In this case, the value of <code>J=1279</code> indicates the triangular truncation used is <code>T1279</code>.</p><p>It is not possible to relate the resolution of the spherical harmonic data directly to the resolution of the corresponding grid as this depends on the specific relationship between the spectral representation and the Gaussian grid used by the IFS. Three different relationships have been used by ECMWF over the years. For <strong>a triangular truncation of T</strong>, the corresponding Gaussian grid resolutions are:</p><table><thead><tr class="header"><th>Relationship</th><th>Gaussian grid resoluion</th></tr></thead><tbody><tr class="odd"><td>linear grid: the shortest wavelength is represented by 2 grid point</td><td>N = (T + 1) / 2</td></tr><tr class="even"><td>quadratic grid: the shortest wavelength is represented by 3 grid points</td><td>N = 3 (T+1) / 4</td></tr><tr class="odd"><td>cubic grid: the shortest wavelength is represented by 4 grid points</td><td>N = T + 1</td></tr></tbody></table><p>where <strong>N</strong> corresponds to the number of latitude lines between the poles and the equator. However, to determine which relationship was used when the data were produced requires interrogation of a corresponding grid point field.</p><p><img src="https://i.imgur.com/p6IPoiG.png" /></p><h2 id="gridpoint-equivalency-of-spectral-resolution">Gridpoint Equivalency of Spectral Resolution</h2><ul><li><a href="https://lyqx.sinaapp.com/wfiles/mstructure_dynamics/navmenu.php_tab_1_page_7_3_0_type_flash.htm">Gridpoint Equivalency of Spectral Resolution</a></li></ul><p>It takes about five to seven grid points to get reasonable approximations of most weather features. Still more points per wave feature are often necessary to get a good forecast. Because spectral and gridpoint models preserve information in different ways, no precise equivalent grid spacing can be given for a spectral model resolution.</p><p>The approximate grid spacing with the same accuracy as a spectral model can then be represented as <span class="math inline">\(\Delta X \sim 360° / 3N\)</span>; where <span class="math inline">\(N\)</span> is the number of waves.</p><p><span class="math display">\[\Delta X \sim 360° / 3N\]</span></p><p>For a <code>T80</code> model, this results in <strong>maximum grid spacing</strong> for equivalent accuracy of about 1.5° ~ 160 km (assuming 1° ~ 111 km).</p><p>We can approximate the grid spacing to obtain equivalent accuracy to a spectral model with a fixed number of waves using a simple approach. <strong>First, we assume that three grid points are sufficient to capture the information contained in each of a series of continuous waves</strong>.</p><p>The dynamics of spectral models retain far better wave representation than gridpoint models with this grid spacing. <strong>However, the spectral model physics is calculated on a grid, with about three times as many grid lengths as number of waves used to represent the data.</strong> Since it takes five to seven grid points to represent 'wavy' data well and even more for features that include discontinuities, the resolution of the physics is poorer than the above formulation indicates and degrades the quality of the spectral model forecast.</p><h2 id="txxlyy">TxxLyy</h2><p>For example, <strong>T42L9</strong> refers to a specific configuration of a global spectral model used in numerical weather prediction (NWP). Here's a breakdown of what each part means:</p><ul><li><p><strong>T42</strong>: This indicates the <strong>triangular truncation</strong> of the spectral model. In this case, the maximum wavenumber (or degree) is 42. This means that the model includes spherical harmonics up to degree 42, which corresponds to a horizontal resolution of <strong>approximately 2.8 degrees (about 300 km)</strong> at the equator.</p></li><li><p><strong>L9</strong>: This denotes the <strong>vertical resolution</strong> of the model. In this case, the model has 9 vertical layers. The vertical layers are typically defined by a set of levels in the atmosphere, often using a hybrid coordinate system that combines pressure and height coordinates.</p></li></ul><p>The <strong>T42L9</strong> model is a relatively low-resolution model compared to modern standards, which often use higher resolutions like T1279L91 (used by ECMWF's IFS) or T574L64 (used by some versions of the GFS). However, the T42L9 model can still be useful for research purposes or as a dynamic kernel in simpler forecasting systems, such as the self-memorial T42 model (SMT42) mentioned in some studies.</p><h2 id="advantages-in-nwp">Advantages in NWP</h2><ul><li><strong>Exponential Convergence</strong>: For smooth solutions, spectral methods <strong>achieve errors decreasing faster than any polynomial of the grid size</strong>, making them highly efficient for large-scale simulations.<br /></li><li><strong>Global Representation</strong>: Unlike finite-element or finite-volume methods, which approximate solutions locally, <strong>spectral methods inherently model atmospheric waves (e.g., Rossby waves) across the entire domain, crucial for global weather prediction</strong>.<br /></li><li><strong>Computational Efficiency</strong>: Operations like differentiation are performed in spectral space <strong>via transforms (e.g., Fast Fourier Transforms), reducing computational cost</strong> compared to traditional grid-based methods.</li></ul><h2 id="implementation-in-nwp-models">Implementation in NWP Models</h2><p>Most global NWP models (e.g., <em>ECMWF’s IFS</em>) use spectral methods for <strong>horizontal discretization</strong>, combined with finite-difference or finite-volume techniques in the vertical direction. The process involves:</p><ol type="1"><li><strong>Transform</strong>: Convert grid-point data to spectral coefficients using spherical harmonic transforms.<br /></li><li><strong>Spectral Computation</strong>: Solve dynamical equations (e.g., momentum, continuity) in spectral space.<br /></li><li><strong>Inverse Transform</strong>: Convert results back to physical space for parameterizations (e.g., cloud physics).</li></ol><p>For example, the <strong>PEAK model</strong> (Primitive-Equation Atmospheric Research Model Kernel) demonstrates how spectral discretization handles the shallow-water equations and primitive equations, balancing accuracy and computational cost.</p><h2 id="limitations">Limitations</h2><ul><li><strong>Localized Features</strong>: <strong>Sharp gradients (e.g., thunderstorms) are poorly resolved due to the global nature of basis functions</strong>, often requiring hybrid approaches.<br /></li><li><strong>Spectral Truncation</strong>: Retaining only a finite number of basis functions introduces aliasing errors in nonlinear terms, mitigated via techniques like dealiasing.</li></ul><h2 id="comparison-to-finite-methods">Comparison to Finite Methods</h2><table><thead><tr class="header"><th><strong>Aspect</strong></th><th><strong>Spectral Methods</strong></th><th><strong>Finite-Difference/Volume</strong></th></tr></thead><tbody><tr class="odd"><td><strong>Accuracy</strong></td><td>Exponential for smooth solutions</td><td>Polynomial (e.g., <span class="math inline">\(O(h^2)\)</span>)</td></tr><tr class="even"><td><strong>Domain Handling</strong></td><td>Global</td><td>Local</td></tr><tr class="odd"><td><strong>Computational Cost</strong></td><td>Lower for high accuracy</td><td>Higher for equivalent resolution</td></tr><tr class="even"><td><strong>Shock Capture</strong></td><td>Poor (no built-in dissipation)</td><td>Better with flux limiters</td></tr></tbody></table><h2 id="applications">Applications</h2><p>Spectral methods dominate <strong>global NWP</strong> due to their efficiency in simulating planetary-scale dynamics. Regional models, which require localized precision, often prefer finite-volume methods. In summary, <strong>spectral methods excel in global NWP by leveraging smooth basis functions for accurate, efficient simulations of large-scale atmospheric behavior</strong>, <strong>while hybrid models address their limitations in resolving localized phenomena</strong>.</p><h1 id="tl639l60全球模式简称t639">TL639L60全球模式简称T639</h1><ul><li><a href="https://data.cma.cn/article/getLeft/id/319/keyIndex/3.html" class="uri">https://data.cma.cn/article/getLeft/id/319/keyIndex/3.html</a></li></ul><p>TL639L60全球模式简称T639,是通过对T213L31模式进行性能升级发展而来。T639是全球谱模式，T代表模式可分辨的最大水平波数，波数越高对应的模式水平分辨率越高，T639可分辨率639个波。L代表模式垂直层次，T639采用地形追随-等压面混合坐标，垂直方向有60层，模式顶到达0.1百帕。T639南北方向采用了线性高斯格点，相当于用两个格点分辨一个波，在字符T后面小写的L表示线性的意思（Linear）。T639模式有1280′640个格点，相当于水平30公里分辨率。T639全球模式（台风）1-15天集合预报系统2014年8月5日正式投入业务运行。采用了增长模繁殖法（BGM）初值扰动，增加了物理过程扰动。同时基于BGM扰动背景场特点，设计了台风集合预报涡旋初始化方案和流程；实现了集合预报以及台风集合预报一体化运行。</p><h1 id="references">References</h1><ol type="1"><li><a href="https://sites.google.com/view/spectralnwpmodels">Ehrendorfer, Martin. Spectral numerical weather prediction models. Society for Industrial and Applied Mathematics, 2011.</a></li><li><a href="https://www.ecmwf.int/sites/default/files/elibrary/2016/17262-new-grid-ifs.pdf">A new grid for the IFS | 2016</a><ol type="1"><li><a href="https://www.ecmwf.int/en/newsletter/152/computing/new-ecmwf-interpolation-package-mir">The new ECMWF interpolation package MIR | 2017</a></li></ol></li><li><a href="https://confluence.ecmwf.int/display/UDOC/How+to+access+the+data+values+of+a+spherical+harmonic+field+in+GRIB+-+ecCodes+GRIB+FAQ">How to access the data values of a <strong>spherical harmonic field</strong> in GRIB | 2023</a></li><li><a href="https://journals.ametsoc.org/downloadpdf/view/journals/mwre/141/10/mwr-d-13-00016.1.pdf">Wedi, Nils P., Mats Hamrud, and George Mozdzynski. "<strong>A fast spherical harmonics transform</strong> for global NWP and climate models." Monthly Weather Review 141.10 (2013): 3450-3461. | ECMEF</a></li><li><a href="https://www.ecmwf.int/sites/default/files/elibrary/1983/10253-spectral-technique.pdf">The spectral technique | Reading | 1983 | M. Jarraud and A.J. Simmons</a></li><li><a href="https://journals.ametsoc.org/downloadpdf/view/journals/mwre/129/1/1520-0493_2001_129_0152_cbwtah_2.0.co_2.pdf">Chu, Peter C., Xiong-Shan Chen, and Chenwu Fan. "Comparison between wavenumber truncation and horizontal diffusion methods in spectral models." Monthly weather review 129.1 (2001): 152-158.</a></li><li><a href="https://imdpune.gov.in/training/training%20notes/07_10_21_Lecture%20Notes%20on_Spectral%20Modelling_%20RKrishnan.pdf">Spectral Technique in Atmospheric Modelling | 07 October, 2021</a></li><li><a href="https://photino.cwa.gov.tw/rdcweb/lib/cd/cd01conf/dissertation/1993-1/58.pdf">中央氣象局第二代全球波譜模式之介紹 | 1993</a></li><li><a href="https://www.zgbk.com/ecph/words?SiteID=1&amp;ID=48405&amp;SubID=76732">截谱模式 | 《中国⼤百科全书》第三版⽹络版 | 2022</a></li><li><a href="http://qxqk.nmc.cn/html/2010/7/20100707.html">国家气象中心业务数值预报发展的回顾与展望 | 2010</a><ol type="1"><li><strong>从T42L9到T213L31</strong>，中期预报模式从建立到逐步发展完善，模式在分辨率的提高，物理过程的改进、完善，数值计算技术及计算机应用技术等方面都取得了明显的进步，客观分析、初值化、资料同化方法及资料的有效利用技术等也有所提高，模式的有效预报时效明显延长，降水落区预报的可用性明显改善。</li><li>目前，国家气象中心的业务数值预报已建立起比较完整的数值天气预报业务体系，中期预报模式已由<strong>T213L31 (水平分辨率约为60 km)</strong>升级为<strong>TL639L60 (水平分辨率约为28 km)</strong>；区域预报模式已由我国自行研制的 <strong>GRAPES-MESO</strong> 中尺度预报模式(水平分辨率为0.15°×0.15°)取代了原区域预报模式HLAFS；<ol type="1"><li><span class="math inline">\((360°/213/3)*111km \sim 62.5km\)</span></li></ol></li></ol></li><li><a href="http://qxqk.nmc.cn/html/2021/6/20210601.html">中央气象台全球中期数值预报业务系统的发展 | 2021 | 沈学顺</a></li></ol>]]></content>
    
    
    <categories>
      
      <category>NWP</category>
      
    </categories>
    
    
    <tags>
      
      <tag>NWP</tag>
      
      <tag>ECMWF</tag>
      
      <tag>spherical harmonics</tag>
      
      <tag>Truncation for wave numbers</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Precipitation minus Evaporation (P-E)</title>
    <link href="/2025/03/20/Precipitation-minus-Evaporation/"/>
    <url>/2025/03/20/Precipitation-minus-Evaporation/</url>
    
    <content type="html"><![CDATA[<h1 id="precipitation-minus-evaporation-p-e">Precipitation minus Evaporation (P-E)</h1><p>To calculate <strong>Precipitation minus Evaporation (P-E)</strong> in numerical weather simulations using mixing ratio, the process involves analyzing atmospheric moisture fluxes and thermodynamic relationships.</p><p><strong>地表可用水量 (降水減蒸發，P-E)</strong> 是反映氣候乾濕程度的關鍵指標，對區域水資源、農業生產和生態系統穩定性有重要影響。熱力學理論指出，隨著全球變暖，大氣中水汽含量上升，水汽輸送增強，這會促使乾燥的地區/季節變得更乾，而濕的地區/季節變得更濕。地表可用水量季節變率增強將使得水資源在年內分配更不均衡，導致濕季更容易出現洪澇災害，而乾季更容易發生乾旱事件，給區域水資源管理和調度帶來嚴峻挑戰和壓力</p><ul><li><strong>Definition</strong>: P-E is the difference between the amount of precipitation (P) and evaporation (E) over a given area and time period. It represents the net supply of freshwater available for runoff, infiltration, and other hydrological processes.</li><li><strong>Role in Hydrology</strong>: P-E is crucial for understanding water availability, as it influences surface water and groundwater recharge. A positive P-E indicates a surplus of water, potentially leading to increased runoff and flooding, while a negative P-E suggests a deficit, often associated with drought conditions.</li></ul><p>To calculate P-E, you need data on both precipitation and evaporation. Here's a general approach:</p><ol type="1"><li><p><strong>Precipitation Data</strong>: Obtain precipitation data from sources like rain gauges, satellite imagery, or reanalysis datasets (e.g., ERA5).</p></li><li><p><strong>Evaporation Data</strong>: Evaporation can be estimated using models that incorporate factors like temperature, humidity, wind speed, and solar radiation. Common methods include the Penman-Monteith equation or using reanalysis datasets.</p></li><li><p><strong>Compute P-E</strong>: Subtract the evaporation from the precipitation over the desired time period (e.g., monthly or annually). <span class="math display">\[P - E = \text{Precipitation} - \text{Evaporation}\]</span></p></li></ol><h2 id="another-calculation-methods">Another Calculation Methods</h2><h3 id="moisture-budget-equation">1. <strong>Moisture Budget Equation</strong></h3><p>The fundamental relationship in atmospheric water balance is: <span class="math display">\[P - E = -\left(\frac{\partial q}{\partial t} + \nabla \cdot (\mathbf{v}q)\right)\]</span></p><p>Where:</p><ul><li><span class="math inline">\(q\)</span> = mixing ratio (kg water vapor/kg dry air)</li><li><span class="math inline">\(\mathbf{v}\)</span> = horizontal wind vector</li><li><span class="math inline">\(\frac{\partial q}{\partial t}\)</span> = local moisture tendency</li><li><span class="math inline">\(\nabla \cdot (\mathbf{v}q)\)</span> = horizontal moisture advection</li></ul><p>This residual method calculates <strong>P-E</strong> as the <strong>negative sum</strong> of:</p><ul><li>Local moisture changes over time</li><li>Net horizontal moisture flux divergence</li></ul><p><img src="https://i.imgur.com/6YfNHLN.png" alt="Trenberth, Kevin E., and Christian J. Guillemot. &quot;Evaluation of the global atmospheric moisture budget as seen from analyses.&quot; Journal of Climate 8.9 (1995): 2255-2272." width="500" /> <img src="https://i.imgur.com/zlMe2hX.png" alt="Seager, Richard, and Naomi Henderson. &quot;Diagnostic computation of moisture budgets in the ERA-Interim reanalysis with reference to analysis of CMIP-archived atmospheric model data.&quot; Journal of Climate 26.20 (2013): 7876-7901." width="500" /></p><h3 id="direct-surface-flux-approach">2. <strong>Direct Surface Flux Approach</strong></h3><p>For evaporation calculation using mixing ratio: <span class="math display">\[E = \rho_{air} \cdot C_E \cdot |\mathbf{v}| \cdot (q_{sat} - q_{air})\]</span> Where:</p><ul><li><span class="math inline">\(\rho_{air}\)</span> = air density</li><li><span class="math inline">\(C_E\)</span> = bulk transfer coefficient (~1.5×10⁻³ over water)</li><li><span class="math inline">\(q_{sat}\)</span> = saturation mixing ratio at surface temperature</li><li><span class="math inline">\(q_{air}\)</span> = actual near-surface mixing ratio</li></ul><p><strong>Precipitation (P)</strong> is typically output from <strong>microphysics parameterizations</strong> in the model.</p><h2 id="key-implementation-steps">Key Implementation Steps</h2><p><strong>Step 1: Compute Saturation Mixing Ratio</strong><br />Use Tetens formula for saturation vapor pressure: <span class="math display">\[e_s = 6.112 \exp\left(\frac{17.67T}{T + 243.5}\right) \quad [\text{hPa}]\]</span></p><p>Then calculate:</p><p><span class="math display">\[q_{sat} = \frac{\varepsilon e_s}{P - e_s} \quad (\varepsilon = 0.622)\]</span></p><p><strong>Step 2: Vertical Integration</strong><br />For column-integrated P-E: <span class="math display">\[P - E = -\frac{1}{g} \int_{sfc}^{top} \left(\frac{\partial q}{\partial t} + \nabla \cdot (\mathbf{v} q)\right) dp\]</span></p><p><strong>Step 3: Numerical Implementation</strong><br />In finite difference models:</p><ul><li>Calculate moisture tendency between time steps</li><li>Use centered differencing for advection terms</li><li>Apply mass-corrected transport schemes to prevent numerical dispersion</li></ul><h2 id="practical-considerations">Practical Considerations</h2><p><strong>Data Requirements</strong></p><ul><li>3D fields of mixing ratio and winds at model levels</li><li>Surface pressure and temperature</li><li>Precipitation outputs from convective/resolved schemes</li></ul><p><strong>Validation</strong><br />Compare results against:</p><ol type="1"><li>Direct surface flux measurements</li><li>Reanalysis-derived P-E products</li><li>River basin water balance estimates</li></ol><p>The moisture budget method generally shows &lt;10% error for monthly means in midlatitudes but requires careful handling of tropical convection systems<sup id="fnref:3" class="footnote-ref"><a href="#fn:3" rel="footnote"><span class="hint--top hint--rounded" data-aria-label="">[3]</span></a></sup><sup id="fnref:5" class="footnote-ref"><a href="#fn:5" rel="footnote"><span class="hint--top hint--rounded" data-aria-label="">[5]</span></a></sup>. Recent NWP systems like ECMWF's IFS and NASA's GEOS use hybrid approaches combining both methods<sup id="fnref:1" class="footnote-ref"><a href="#fn:1" rel="footnote"><span class="hint--top hint--rounded" data-aria-label="">[1]</span></a></sup><sup id="fnref:7" class="footnote-ref"><a href="#fn:7" rel="footnote"><span class="hint--top hint--rounded" data-aria-label="">[7]</span></a></sup>.</p><h1 id="mpas-registry.xml">MPAS: Registry.xml</h1><p>About mixing ratio,</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">var_array</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;scalars&quot;</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;real&quot;</span> <span class="hljs-attr">dimensions</span>=<span class="hljs-string">&quot;nVertLevels nCells Time&quot;</span> <span class="hljs-attr">packages</span>=<span class="hljs-string">&quot;met_stage_out&quot;</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">var</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;qv&quot;</span> <span class="hljs-attr">array_group</span>=<span class="hljs-string">&quot;moist&quot;</span> <span class="hljs-attr">units</span>=<span class="hljs-string">&quot;kg kg^&#123;-1&#125;&quot;</span></span><br><span class="hljs-tag">                <span class="hljs-attr">description</span>=<span class="hljs-string">&quot;Water vapor mixing ratio&quot;</span>/&gt;</span><br><br>        <span class="hljs-tag">&lt;<span class="hljs-name">var</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;qc&quot;</span> <span class="hljs-attr">array_group</span>=<span class="hljs-string">&quot;moist&quot;</span> <span class="hljs-attr">units</span>=<span class="hljs-string">&quot;kg kg^&#123;-1&#125;&quot;</span></span><br><span class="hljs-tag">                <span class="hljs-attr">description</span>=<span class="hljs-string">&quot;Cloud water mixing ratio&quot;</span>/&gt;</span><br><br>        <span class="hljs-tag">&lt;<span class="hljs-name">var</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;qr&quot;</span> <span class="hljs-attr">array_group</span>=<span class="hljs-string">&quot;moist&quot;</span> <span class="hljs-attr">units</span>=<span class="hljs-string">&quot;kg kg^&#123;-1&#125;&quot;</span></span><br><span class="hljs-tag">                <span class="hljs-attr">description</span>=<span class="hljs-string">&quot;Rain water mixing ratio&quot;</span>/&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">var_array</span>&gt;</span><br></code></pre></td></tr></table></figure><h1 id="nwp-ai">NWP-AI</h1><h2 id="neuralgcm">NeuralGCM</h2><ul><li><a href="https://waipangsze.github.io/2025/03/18/NWP-AI-NeuralGCM/"><strong>NWP | AI | NeuralGCM</strong></a></li></ul><hr /><ul><li><strong>To diagnose precipitation minus evaporation rate (P − E)</strong></li><li>In this work, <strong>we only diagnosed precipitation minus evaporation from NeuralGCM</strong>. However, in future work, <strong>we plan to develop a scheme to reformulate NeuralGCM to predict precipitation and evaporation separately</strong>. This could be achieved, for example, by using conventional parameterization to estimate evaporation (and then calculating precipitation by adding it to P-E). Another approach could involve training a neural network (NN) specifically to predict evaporation, potentially optimized to predict the same fluxes as those in ERA5 data.</li></ul><h1 id="references">References</h1><ol type="1"><li><a href="https://www.met.reading.ac.uk/~sgs02rpa/TALKS/Allan_Seminar23.pdf">GLOBAL CHANGES IN <strong>PRECIPITATION MINUS EVAPORATION</strong> | 2023</a></li><li><a href="https://ntrs.nasa.gov/api/citations/19770012769/downloads/19770012769.pdf">Scott, Robert W., and James R. Scoggins. The <strong>moisture budget</strong> in relation to convection. No. M-216. 1977.</a></li><li><a href="https://journals.ametsoc.org/view/journals/clim/8/9/1520-0442_1995_008_2255_eotgam_2_0_co_2.pdf">Trenberth, Kevin E., and Christian J. Guillemot. "<strong>Evaluation of the global atmospheric moisture budget as</strong> seen from analyses." Journal of Climate 8.9 (1995): 2255-2272. (<strong>Recommand</strong>)</a></li><li><a href="https://ocp.ldeo.columbia.edu/res/div/ocp/pub/seager/Seager_Henderson_mb.pdf">Seager, Richard, and Naomi Henderson. "<strong>Diagnostic computation of moisture budget</strong>s in the ERA-Interim reanalysis with reference to analysis of CMIP-archived atmospheric model data." Journal of Climate 26.20 (2013): 7876-7901.</a></li><li><a href="https://www.ictp.it/sites/default/files/%5Bteaching-materials%5D/lecture_notes_AD_section12.pdf"><strong>Moisture budget equation</strong> and application to Sahel Drought</a></li></ol><section class="footnotes"><div class="footnote-list"><ol><li><span id="fn:1" class="footnote-text"><span><a href="https://www.osti.gov/servlets/purl/6807588" class="uri">https://www.osti.gov/servlets/purl/6807588</a> <a href="#fnref:1" rev="footnote" class="footnote-backref"> ↩</a></span></span></li><li><span id="fn:2" class="footnote-text"><span><a href="https://www.eoas.ubc.ca/books/Practical_Meteorology/prmet/Ch04-Moist.pdf" class="uri">https://www.eoas.ubc.ca/books/Practical_Meteorology/prmet/Ch04-Moist.pdf</a> <a href="#fnref:2" rev="footnote" class="footnote-backref"> ↩</a></span></span></li><li><span id="fn:3" class="footnote-text"><span><a href="https://journals.ametsoc.org/downloadpdf/journals/clim/28/20/jcli-d-15-0369.1.pdf" class="uri">https://journals.ametsoc.org/downloadpdf/journals/clim/28/20/jcli-d-15-0369.1.pdf</a> <a href="#fnref:3" rev="footnote" class="footnote-backref"> ↩</a></span></span></li><li><span id="fn:4" class="footnote-text"><span><a href="https://weather.cod.edu/notes/materials/1110/Unit2_1110.pdf" class="uri">https://weather.cod.edu/notes/materials/1110/Unit2_1110.pdf</a> <a href="#fnref:4" rev="footnote" class="footnote-backref"> ↩</a></span></span></li><li><span id="fn:5" class="footnote-text"><span><a href="https://agupubs.onlinelibrary.wiley.com/doi/full/10.1029/2022GL097725" class="uri">https://agupubs.onlinelibrary.wiley.com/doi/full/10.1029/2022GL097725</a> <a href="#fnref:5" rev="footnote" class="footnote-backref"> ↩</a></span></span></li><li><span id="fn:6" class="footnote-text"><span><a href="https://www.weather.gov/epz/wxcalc_mixingratio" class="uri">https://www.weather.gov/epz/wxcalc_mixingratio</a> <a href="#fnref:6" rev="footnote" class="footnote-backref"> ↩</a></span></span></li><li><span id="fn:7" class="footnote-text"><span><a href="https://atmos.uw.edu/~dennis/321/321_Lecture_15.pdf" class="uri">https://atmos.uw.edu/~dennis/321/321_Lecture_15.pdf</a> <a href="#fnref:7" rev="footnote" class="footnote-backref"> ↩</a></span></span></li><li><span id="fn:8" class="footnote-text"><span><a href="https://www.inscc.utah.edu/~krueger/5130/precip_rate.pdf" class="uri">https://www.inscc.utah.edu/~krueger/5130/precip_rate.pdf</a> <a href="#fnref:8" rev="footnote" class="footnote-backref"> ↩</a></span></span></li></ol></div></section>]]></content>
    
    
    <categories>
      
      <category>Meteorology</category>
      
    </categories>
    
    
    <tags>
      
      <tag>NWP</tag>
      
      <tag>WRF</tag>
      
      <tag>MPAS</tag>
      
      <tag>Precipitation</tag>
      
      <tag>Evaporation</tag>
      
      <tag>Hydrology</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>NWP | AI | NeuralGCM</title>
    <link href="/2025/03/18/NWP-AI-NeuralGCM/"/>
    <url>/2025/03/18/NWP-AI-NeuralGCM/</url>
    
    <content type="html"><![CDATA[<ul><li><a href="https://waipangsze.github.io/2024/10/09/AI-for-Numerical-Weather-Prediction-NWP/">NWP | AI for Numerical Weather Prediction (NWP)</a></li></ul><hr /><p><strong>NeuralGCM</strong> is trained through a sophisticated process that combines differentiable physical modeling with machine learning optimization techniques. Here's a breakdown of its training methodology:</p><h1 id="core-training-components">Core Training Components</h1><h2 id="hybrid-architecture-integration"><strong>1. Hybrid Architecture Integration</strong></h2><ul><li>Combines a <strong>differentiable dynamical core</strong> (handling large-scale atmospheric physics) with a <strong>neural network physics module</strong> (modeling unresolved processes like cloud formation).</li><li>The dynamical core <strong>solves discretized governing equations using JAX-based solvers</strong>, while neural networks parameterize subgrid-scale phenomena.<ul><li>A key innovation of <code>NeuralGCM</code> is that we rewrote the <a href="https://github.com/google-research/dinosaur"><strong>numerical solver for large-scale processes</strong></a> from scratch in <a href="https://docs.jax.dev/en/latest/advanced-autodiff.html"><strong>JAX</strong></a>.<ul><li><strong>JAX’s autodiff makes it easy to compute higher-order derivatives</strong>, because the functions that compute derivatives are themselves differentiable. Thus, higher-order derivatives are as easy as stacking transformations. <img src="https://i.imgur.com/nyZhlkE.png" width="400" /></li></ul></li><li>This allowed us to use gradient-based optimization to tune the behavior of the <strong>coupled system “online”</strong> over many time-steps.</li><li><strong>Another bonus of writing the entire model in JAX is that it runs efficiently on TPUs and GPUs</strong>, in contrast to traditional climate models that mostly run on CPUs.</li></ul></li><li><a href="https://github.com/neuralgcm/dinosaur"><strong>Dinosaur: Differentiable Dynamics for Global Atmospheric Modeling</strong></a><ul><li><strong>Dinosaur</strong> is an old-fashioned (some might say prehistoric) dynamical core for global atmospheric modeling, <strong>re-written in JAX</strong> to meet the needs of modern AI weather/climate models:<ul><li><strong>Dynamics</strong>: Dinosaur uses <em>spectral methods</em> to solve the shallow water equations and the primitive equations (moist and dry) on <em>sigma coordinates</em>.</li><li><strong>Auto-diff</strong>: Dinosaur supports both forward- and backward-mode automatic differentiation in JAX. <strong>This enables "online training" of hybrid AI/physics models</strong>.</li><li><strong>Acceleration</strong>: Dinosaur is designed to <strong>run efficiently on modern accelerator hardware (GPU/TPU)</strong>, including parallelization across multiple devices.</li></ul></li></ul></li></ul><h3 id="structure-of-the-neuralgcm-model">Structure of the NeuralGCM model</h3><figure><img src="https://i.imgur.com/gLe27TW.png" alt="Structure of the NeuralGCM model." /><figcaption>Structure of the NeuralGCM model.</figcaption></figure><p><img src="https://i.imgur.com/MmzCDhv.png" /> <img src="https://i.imgur.com/wgfMkyu.png" /></p><ol type="1"><li>Implemented in JAX, a library for highperformance code in Python that supports automatic differentiation.</li><li>Our learned physics module uses the single-column approach of GCMs, whereby information only from a single atmospheric column is used to predict the impact of unresolved processes occurring within that column.</li></ol><p><img src="https://i.imgur.com/qyqI8z9.png" /></p><p><span class="math display">\[\begin{align}\widetilde{X}_{t+1} &amp; = \widetilde{X}_{t} + \Delta t [ \Phi(\widetilde{X}_{t}) + \Psi (\widetilde{X}_{t})]\\\Psi (\widetilde{X}_{t}) &amp; = NN(\widetilde{X}_{t})\end{align}\]</span></p><p>which are in <span class="math inline">\(k\)</span>-space.</p><ul><li><strong>Tendency Calculation</strong><ul><li>Neural network outputs scaled tendencies:<br /><span class="math display">\[\frac{\partial \mathbf{X}}{\partial t} = \mathcal{N}(\mathbf{X}, \nabla\mathbf{X}, \text{forcing}) \cdot \sigma_X\]</span> where <span class="math inline">\(\sigma_X\)</span> is variable-specific scaling</li></ul></li></ul><h3 id="grid-spacing-and-time-step">Grid spacing and Time step</h3><p>We train a range of NeuralGCM models at horizontal resolutions with grid spacing of <span class="math inline">\(2.8\deg\)</span> (~ 310.8km), <span class="math inline">\(1.4\deg\)</span> (~ 155.4km), and <span class="math inline">\(0.7\deg\)</span> (~ 77.7km), corresponding to truncated linear Gaussian grids TL63, TL127, TL255, and each utilizing <span class="math inline">\(32\)</span> evenly spaced vertical levels on sigma coordinates.</p><div class="group-image-container"><div class="group-image-row"><div class="group-image-wrap"><img src="https://i.imgur.com/EZU8eEU.png" /></div><div class="group-image-wrap"><img src="https://i.imgur.com/9MsH68G.png" /></div></div><div class="group-image-row"><div class="group-image-wrap"><img src="https://i.imgur.com/2zWwbbn.png" /></div><div class="group-image-wrap"><img src="https://i.imgur.com/YSSR09Z.png" /></div></div></div><ul><li>Integration time step varies with resolution. This results in iterative updates to the model state <strong>every 4-30 minutes</strong>, depending on model resolution.</li><li>Throughout time integration, dynamical core tendenciesare computedat every time step, while learned physics tendencies are only recomputed once <strong>every 60minutes for our lowest resolution(<span class="math inline">\(2.8\deg\)</span>)</strong> model and <strong>every 30minutes for all others</strong>. This is done to avoid excessive backpropagation through the neural networks in learned physics.</li><li>The time-step size of the ODE solver is limited by the CFL condition on dynamics, and can be small relative to the time-scale of atmospheric change. Evaluating learned physics is approximately 1.5 × as expensive as a time step of the dynamical core. Accordingly, following the typical practice for GCMs, <strong>we hold learned physics tendencies constant for multiple ODE time-steps to reduce computational expense, typically corresponding to 30 minutes of simulation time</strong>.</li></ul><figure><img src="https://i.imgur.com/O6gyFxx.png" alt="My understanding: To hold learned physics tendencies constant for multiple ODE time-steps to reduce computational expense, typically corresponding to 30 minutes of simulation time." /><figcaption>My understanding: To hold learned physics tendencies constant for multiple ODE time-steps to reduce computational expense, typically corresponding to 30 minutes of simulation time.</figcaption></figure><ul><li><a href="https://stanford.edu/~shervine/teaching/cs-230/cheatsheet-recurrent-neural-networks" class="uri">https://stanford.edu/~shervine/teaching/cs-230/cheatsheet-recurrent-neural-networks</a><ul><li>Recurrent neural networks, also known as RNNs, are a class of neural networks that allow previous outputs to be used as inputs while having hidden states.</li><li>NeuralGCM NN part, it is <strong>recurrent</strong>. <img src="https://i.imgur.com/VVuAWBk.png" width="500" /></li></ul></li><li>We <strong>gradually increased the rollout length from 6 hours to 5 days</strong>, which we found to be critical because our models are not accurate for multi-day prediction early in training.</li></ul><h2 id="end-to-end-online-training"><strong>2. End-to-End Online Training</strong></h2><ul><li>Uses <strong>stochastic gradient descent (SGD)</strong> to optimize both physical and neural components simultaneously.<ul><li>The time-step size of the ODE solver is <strong>limited by the CFL condition on dynamics</strong>, and can be small relative to the time-scale of atmospheric change. <strong>Evaluating learned physics is approximately 1.5 × as expensive as a time step of the dynamical core</strong>. Accordingly, following the typical practice for GCMs, <strong>we hold learned physics tendencies constant for multiple ODE time-steps to reduce computational expense, typically corresponding to 30 minutes of simulation time</strong>.</li><li>The differentiable dynamical core in NeuralGCM allows an end-to-end training approach, whereby <strong>we advance the model multiple time steps before employing stochastic gradient descent (SGD) to minimize discrepancies between model predictions and conservatively regridded ERA5 data</strong>.</li></ul></li><li>Implements extended backpropagation through hundreds of simulation steps (up to 5-day weather trajectories).</li><li>Gradually increases rollout length during training:<ul><li>Starts with 6-hour forecasts</li><li>Progressively extends to 5-day predictions</li></ul></li></ul><h2 id="data-integration-loss-optimization"><strong>3. Data Integration &amp; Loss Optimization</strong></h2><ul><li>Trained on ERA5 reanalysis data for atmospheric variables</li><li>Incorporates satellite precipitation data from IMERG V07 using:<ul><li>Continuous Ranked Probability Score (CRPS) minimization</li><li>Physical consistency preservation techniques</li></ul></li><li>Loss function compares model outputs with observational ground truth</li></ul><h2 id="key-optimization-features">Key Optimization Features</h2><p><strong>Stochastic Gradient Descent Implementation</strong></p><ul><li>Updates model parameters using randomly selected data batches</li><li>Balances computational efficiency with convergence stability through:<ul><li>Learning rate scheduling</li><li>Data shuffling between epochs</li><li>Mini-batch processing</li></ul></li></ul><p><strong>Training Protocol</strong></p><ul><li><strong>Deterministic models</strong>: Focus on single trajectory optimization</li><li><strong>Stochastic models</strong>: Incorporate uncertainty quantification</li><li>Employs checkpointing for model persistence and analysis</li></ul><h2 id="performance-enhancements">Performance Enhancements</h2><ul><li>Achieves <strong>2-15 day forecast accuracy</strong> surpassing ECMWF ensembles</li><li>Reduces climate simulation errors by 10-20% compared to traditional GCMs</li><li>Enables laptop-scale climate modeling through computational efficiency gains</li></ul><p>This training approach enables NeuralGCM to maintain physical consistency while learning from observational data, resulting in improved forecasting capability and computational efficiency compared to conventional climate models.</p><h1 id="training-resources">Training resources</h1><p><img src="https://i.imgur.com/wh6zgKn.png" /></p><h1 id="references">References</h1><ol type="1"><li><a href="https://www.nature.com/articles/s41586-024-07744-y">Kochkov, Dmitrii, et al. "Neural general circulation models for weather and climate." Nature 632.8027 (2024): 1060-1066.</a></li><li><a href="https://arxiv.org/abs/2311.07222">Neural General Circulation Models for Weather and Climate | arxiv</a></li><li><a href="https://research.google/blog/fast-accurate-climate-modeling-with-neuralgcm/">Fast, accurate climate modeling with NeuralGCM (<strong>Recommend</strong>)</a></li><li><a href="https://mp.weixin.qq.com/s/wgJHpQ0Ww_IjoTPcuoDrbQ">NeuralGCM：大活来了，AI天气预报进入下半场？ | 2023-12</a></li><li><a href="https://livebook.manning.com/book/deep-learning-with-jax/chapter-1/">When and why to use JAX</a></li></ol>]]></content>
    
    
    <categories>
      
      <category>NWP</category>
      
    </categories>
    
    
    <tags>
      
      <tag>NWP</tag>
      
      <tag>AI</tag>
      
      <tag>ML</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>MPAS | LBC</title>
    <link href="/2025/03/14/MPAS-LBC/"/>
    <url>/2025/03/14/MPAS-LBC/</url>
    
    <content type="html"><![CDATA[<h1 id="links">Links</h1><ol type="1"><li><a href="https://mpas-dev.github.io/">https://mpas-dev.github.io/</a></li><li><a href="https://github.com/MPAS-Dev/MPAS-Model/releases">/MPAS-Model/releases</a></li><li><a href="https://www2.mmm.ucar.edu/projects/mpas/mpas_atmosphere_users_guide_4.0.pdf">MPAS-Atmosphere Users' Guide V4.0</a></li><li><a href="https://www2.mmm.ucar.edu/projects/mpas/mpas_atmosphere_users_guide_5.3.pdf">MPAS-Atmosphere Users' Guide V5.3</a></li><li><a href="https://www2.mmm.ucar.edu/projects/mpas/mpas_atmosphere_users_guide_6.3.pdf">MPAS-Atmosphere Users' Guide V6.3</a></li><li><a href="https://www2.mmm.ucar.edu/projects/mpas/mpas_atmosphere_users_guide_7.0.pdf">MPAS-Atmosphere Users' Guide V7.0</a></li><li><a href="https://www2.mmm.ucar.edu/projects/mpas/mpas_atmosphere_users_guide_8.2.0.pdf">MPAS-Atmosphere Users' Guide V8.2.0</a></li><li><a href="https://www.mmm.ucar.edu/events/133129/agenda">Joint WRF/MPAS Users Workshop 2024</a></li></ol><h1 id="references">References</h1><ul><li><strong>MPAS-Atmosphere Version 7.0</strong>, 8 June 2019<ul><li><strong>The capability to perform limited-area simulations on the surface of the sphere.</strong></li></ul></li><li><a href="https://www2.mmm.ucar.edu/projects/mpas/tutorial/Howard2024/index.html">Running limited-area simulations | MPAS tutorial practice guide</a><ul><li>Having prepared a region definition file, we can use the <strong>create_region</strong> tool to create a subset of an existing global "<code>static</code>" file for our specified region.</li><li>The interpolation of lateral boundary conditions for a regional simulation domain is conceptually similar to the interpolation of initial conditions: the key differences are:<ul><li><ol type="1"><li>fields are <strong>interpolated</strong> at several time periods, and</li></ol></li><li><ol start="2" type="1"><li>the set of fields to be <strong>interpolated</strong> is a subset of those required for initial conditions (this subset includes: <strong>theta, rho, u, w, and moisture species</strong>).</li></ol></li></ul></li></ul></li></ul><h1 id="code">Code</h1><h2 id="mpas_stream_manager.f">mpas_stream_manager.F</h2><ul><li>MPAS_stream_mgr_get_property</li></ul>    <div class="fold">      <div class="fold-title fold-info collapsed" data-toggle="collapse" href="#collapse-8f7bdefe" role="button" aria-expanded="false" aria-controls="collapse-8f7bdefe">        <div class="fold-arrow">▶</div>MPAS_stream_mgr_get_property      </div>      <div class="fold-collapse collapse" id="collapse-8f7bdefe">        <div class="fold-content">          <figure class="highlight fortran"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs fortran"><span class="hljs-keyword">interface</span> MPAS_stream_mgr_get_property<br>    <span class="hljs-keyword">module</span> <span class="hljs-keyword">procedure</span> MPAS_stream_mgr_get_property_int<br>    <span class="hljs-keyword">module</span> <span class="hljs-keyword">procedure</span> MPAS_stream_mgr_get_property_char<br>    <span class="hljs-keyword">module</span> <span class="hljs-keyword">procedure</span> MPAS_stream_mgr_get_property_logical<br><span class="hljs-keyword">end</span> <span class="hljs-keyword">interface</span><br><br><span class="hljs-comment">!-----------------------------------------------------------------------</span><br><span class="hljs-comment">!  routine MPAS_stream_mgr_get_property_int</span><br><span class="hljs-comment">!</span><br><span class="hljs-comment">!&gt; \brief Gets a property of a stream in an MPAS stream manager.</span><br><span class="hljs-comment">!&gt; \author Michael Duda, Doug Jacobsen</span><br><span class="hljs-comment">!&gt; \date   13 June 2014</span><br><span class="hljs-comment">!&gt; \details</span><br><span class="hljs-comment">!&gt;  Retrieves the value of a stream property within an MPAS stream manager.</span><br><span class="hljs-comment">!&gt;  <span class="hljs-doctag">NOTE:</span> This routine does not support streamID regular expressions</span><br><span class="hljs-comment">!</span><br><span class="hljs-comment">!-----------------------------------------------------------------------</span><br><span class="hljs-function"><span class="hljs-keyword">subroutine</span></span> MPAS_stream_mgr_get_property_int(manager, streamID, propertyName, propertyValue, direction, ierr)<br></code></pre></td></tr></table></figure>        </div>      </div>    </div><h2 id="core_init_atmosphere">core_init_atmosphere</h2><ul><li><code>src/core_init_atmosphere/Registry.xml</code>     <div class="fold">      <div class="fold-title fold-info collapsed" data-toggle="collapse" href="#collapse-dcdac752" role="button" aria-expanded="false" aria-controls="collapse-dcdac752">        <div class="fold-arrow">▶</div>src/core_init_atmosphere/Registry.xml      </div>      <div class="fold-collapse collapse" id="collapse-dcdac752">        <div class="fold-content">          <figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">package</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;lbcs&quot;</span> <span class="hljs-attr">description</span>=<span class="hljs-string">&quot;Active when lateral boundary conditions are interpolated and written.…</span></span><br><span class="hljs-string"><span class="hljs-tag">&lt;stream name=&quot;</span><span class="hljs-attr">lbc</span>&quot;</span><br><span class="hljs-tag">                <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;output&quot;</span></span><br><span class="hljs-tag">                <span class="hljs-attr">filename_template</span>=<span class="hljs-string">&quot;lbc.$Y-$M-$D_$h.$m.$s.nc&quot;</span></span><br><span class="hljs-tag">                <span class="hljs-attr">output_interval</span>=<span class="hljs-string">&quot;3:00:00&quot;</span></span><br><span class="hljs-tag">                <span class="hljs-attr">packages</span>=<span class="hljs-string">&quot;lbcs&quot;</span></span><br><span class="hljs-tag">&lt;<span class="hljs-attr">var_struct</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;lbc_state&quot;</span>/&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">var_struct</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;lbc_state&quot;</span> <span class="hljs-attr">time_levs</span>=<span class="hljs-string">&quot;1&quot;</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">var</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;lbc_u&quot;</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;real&quot;</span> <span class="hljs-attr">dimensions</span>=<span class="hljs-string">&quot;nVertLevels nEdges Time&quot;</span> <span class="hljs-attr">packages</span>=<span class="hljs-string">&quot;lbcs&quot;</span></span><br><span class="hljs-tag">        &lt;<span class="hljs-attr">var</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;lbc_w&quot;</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;real&quot;</span> <span class="hljs-attr">dimensions</span>=<span class="hljs-string">&quot;nVertLevelsP1 nCells Time&quot;</span> <span class="hljs-attr">packages</span>=<span class="hljs-string">&quot;lbcs&quot;</span></span><br><span class="hljs-tag">                <span class="hljs-attr">units</span>=<span class="hljs-string">&quot;m s^&#123;-1&#125;&quot;</span></span><br><span class="hljs-tag">        &lt;<span class="hljs-attr">var</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;lbc_rho&quot;</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;real&quot;</span> <span class="hljs-attr">dimensions</span>=<span class="hljs-string">&quot;nVertLevels nCells Time&quot;</span> <span class="hljs-attr">packages</span>=<span class="hljs-string">&quot;lbcs&quot;</span></span><br><span class="hljs-tag">        &lt;<span class="hljs-attr">var</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;lbc_theta&quot;</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;real&quot;</span> <span class="hljs-attr">dimensions</span>=<span class="hljs-string">&quot;nVertLevels nCells Time&quot;</span> <span class="hljs-attr">packages</span>=<span class="hljs-string">&quot;lbcs&quot;</span></span><br><span class="hljs-tag">        &lt;<span class="hljs-attr">var_array</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;lbc_scalars&quot;</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;real&quot;</span> <span class="hljs-attr">dimensions</span>=<span class="hljs-string">&quot;nVertLevels nCells Time&quot;</span> <span class="hljs-attr">packages</span>=<span class="hljs-string">&quot;lbcs&quot;</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">var</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;lbc_qv&quot;</span> <span class="hljs-attr">array_group</span>=<span class="hljs-string">&quot;moist&quot;</span> <span class="hljs-attr">units</span>=<span class="hljs-string">&quot;kg kg^&#123;-1&#125;&quot;</span></span><br><span class="hljs-tag">                &lt;<span class="hljs-attr">var</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;lbc_qc&quot;</span> <span class="hljs-attr">array_group</span>=<span class="hljs-string">&quot;moist&quot;</span> <span class="hljs-attr">units</span>=<span class="hljs-string">&quot;kg kg^&#123;-1&#125;&quot;</span></span><br><span class="hljs-tag">                &lt;<span class="hljs-attr">var</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;lbc_qr&quot;</span> <span class="hljs-attr">array_group</span>=<span class="hljs-string">&quot;moist&quot;</span> <span class="hljs-attr">units</span>=<span class="hljs-string">&quot;kg kg^&#123;-1&#125;&quot;</span></span><br><span class="hljs-tag">                &lt;<span class="hljs-attr">var</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;lbc_nifa&quot;</span> <span class="hljs-attr">array_group</span>=<span class="hljs-string">&quot;number&quot;</span> <span class="hljs-attr">units</span>=<span class="hljs-string">&quot;nb kg^&#123;-1&#125;&quot;</span></span><br><span class="hljs-tag">                &lt;<span class="hljs-attr">var</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;lbc_nwfa&quot;</span> <span class="hljs-attr">array_group</span>=<span class="hljs-string">&quot;number&quot;</span> <span class="hljs-attr">units</span>=<span class="hljs-string">&quot;nb kg^&#123;-1&#125;&quot;</span></span><br></code></pre></td></tr></table></figure>        </div>      </div>    </div></li><li><code>/src/core_init_atmosphere/mpas_init_atm_core_interface.F</code>     <div class="fold">      <div class="fold-title fold-info collapsed" data-toggle="collapse" href="#collapse-6ae3e036" role="button" aria-expanded="false" aria-controls="collapse-6ae3e036">        <div class="fold-arrow">▶</div>src/core_init_atmosphere/mpas_init_atm_core_interface.F      </div>      <div class="fold-collapse collapse" id="collapse-6ae3e036">        <div class="fold-content">          <figure class="highlight fortran"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs fortran"><span class="hljs-comment">!</span><br><span class="hljs-comment">! When interpolating LBC fields, we need all inputs that would be needed for the interpolation</span><br><span class="hljs-comment">! of ICs, so met_stage_in = .true.</span><br><span class="hljs-comment">!</span><br><span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (config_init_case == <span class="hljs-number">9</span>) <span class="hljs-keyword">then</span><br>    gwd_stage_in = <span class="hljs-literal">.false.</span><br>    gwd_stage_out = <span class="hljs-literal">.false.</span><br>    vertical_stage_in = <span class="hljs-literal">.false.</span><br>    vertical_stage_out = <span class="hljs-literal">.false.</span><br>    met_stage_in = <span class="hljs-literal">.true.</span><br>    met_stage_out = <span class="hljs-literal">.true.</span><br><br>    mp_thompson_aers_in = <span class="hljs-literal">.false.</span><br>    inquire(<span class="hljs-keyword">file</span>=<span class="hljs-string">&quot;QNWFA_QNIFA_SIGMA_MONTHLY.dat&quot;</span>,<span class="hljs-keyword">exist</span>=lexist)<br>    <span class="hljs-keyword">if</span>((lexist <span class="hljs-keyword">.and.</span> met_stage_out) <span class="hljs-keyword">.or.</span> (lexist <span class="hljs-keyword">.and.</span> met_stage_in)) mp_thompson_aers_in = <span class="hljs-literal">.true.</span><br><br>    initial_conds = <span class="hljs-literal">.false.</span>   <span class="hljs-comment">! Also, turn off the initial_conds package to avoid writing the IC &quot;output&quot; stream</span><br></code></pre></td></tr></table></figure>        </div>      </div>    </div></li><li><code>src/core_init_atmosphere/mpas_init_atm_cases.F</code>     <div class="fold">      <div class="fold-title fold-info collapsed" data-toggle="collapse" href="#collapse-13005088" role="button" aria-expanded="false" aria-controls="collapse-13005088">        <div class="fold-arrow">▶</div>src/core_init_atmosphere/mpas_init_atm_cases.F      </div>      <div class="fold-collapse collapse" id="collapse-13005088">        <div class="fold-content">          <figure class="highlight fortran"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs fortran">    <span class="hljs-comment">!-----------------------------------------------------------------------</span><br><span class="hljs-comment">!  routine init_atm_case_lbc</span><br><span class="hljs-comment">!</span><br><span class="hljs-comment">!&gt; \brief Computes lbc_&#123;rho,theta,u,w,qx&#125; fields for lateral boundary conditions</span><br><span class="hljs-comment">!&gt; \author Michael Duda</span><br><span class="hljs-comment">!&gt; \date   22 April 2019</span><br><span class="hljs-comment">!&gt; \details</span><br><span class="hljs-comment">!&gt;  This routine is similar to the init_atm_case_gfs routine in that it reads</span><br><span class="hljs-comment">!&gt;  atmospheric fields from &quot;intermediate&quot; files and horizontally and vertically</span><br><span class="hljs-comment">!&gt;  interpolates them to an MPAS mesh. However, rather than producing model</span><br><span class="hljs-comment">!&gt;  initial conditions, this routine is responsible for producing only those</span><br><span class="hljs-comment">!&gt;  fields that are needed as model lateral boundary conditions.</span><br><span class="hljs-comment">!</span><br><span class="hljs-comment">!-----------------------------------------------------------------------</span><br><span class="hljs-function"><span class="hljs-keyword">subroutine</span></span> init_atm_case_lbc(timestamp, <span class="hljs-keyword">block</span>, mesh, nCells, nEdges, nVertLevels, fg, state, diag, lbc_state, dims, configs)<br>.....<br></code></pre></td></tr></table></figure>        </div>      </div>    </div></li></ul><h2 id="core_atmosphere">core_atmosphere</h2><ul><li><code>src/core_atmosphere/dynamics/mpas_atm_boundaries.F</code> <figure class="highlight fortran"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><code class="hljs fortran"><span class="hljs-comment">!***********************************************************************</span><br><span class="hljs-comment">!</span><br><span class="hljs-comment">!  routine mpas_atm_update_bdy_tend</span><br><span class="hljs-comment">!</span><br><span class="hljs-comment">!&gt; \brief   Reads new boundary data and updates the LBC tendencies</span><br><span class="hljs-comment">!&gt; \author  Michael Duda</span><br><span class="hljs-comment">!&gt; \date    27 September 2016</span><br><span class="hljs-comment">!&gt; \details </span><br><span class="hljs-comment">!&gt;  This routine reads from the &#x27;lbc_in&#x27; stream all variables in the &#x27;lbc&#x27;</span><br><span class="hljs-comment">!&gt;  pool. When called with firstCall=.true., the latest time before the</span><br><span class="hljs-comment">!&gt;  present is read into time level 2 of the lbc pool; otherwise, the</span><br><span class="hljs-comment">!&gt;  contents of time level 2 are shifted to time level 1, the earliest</span><br><span class="hljs-comment">!&gt;  time strictly later than the present is read into time level 2, and</span><br><span class="hljs-comment">!&gt;  the tendencies for all fields in the lbc pool are computed and stored</span><br><span class="hljs-comment">!&gt;  in time level 1.</span><br><span class="hljs-comment">!</span><br><span class="hljs-comment">!-----------------------------------------------------------------------</span><br>......<br><span class="hljs-keyword">call</span> mpas_set_time(currTime, dateTimeString=<span class="hljs-built_in">trim</span>(read_time))<br>......<br><span class="hljs-comment">!</span><br><span class="hljs-comment">! Compute any derived fields from those that were read from the lbc_in stream</span><br><span class="hljs-comment">!</span><br><span class="hljs-keyword">call</span> mpas_pool_get_array(lbc, <span class="hljs-string">&#x27;lbc_u&#x27;</span>, u, <span class="hljs-number">2</span>)<br><span class="hljs-keyword">call</span> mpas_pool_get_array(lbc, <span class="hljs-string">&#x27;lbc_ru&#x27;</span>, ru, <span class="hljs-number">2</span>)<br><span class="hljs-keyword">call</span> mpas_pool_get_array(lbc, <span class="hljs-string">&#x27;lbc_rho_edge&#x27;</span>, rho_edge, <span class="hljs-number">2</span>)<br><span class="hljs-keyword">call</span> mpas_pool_get_array(lbc, <span class="hljs-string">&#x27;lbc_theta&#x27;</span>, theta, <span class="hljs-number">2</span>)<br><span class="hljs-keyword">call</span> mpas_pool_get_array(lbc, <span class="hljs-string">&#x27;lbc_rtheta_m&#x27;</span>, rtheta_m, <span class="hljs-number">2</span>)<br><span class="hljs-keyword">call</span> mpas_pool_get_array(lbc, <span class="hljs-string">&#x27;lbc_rho_zz&#x27;</span>, rho_zz, <span class="hljs-number">2</span>)<br><span class="hljs-keyword">call</span> mpas_pool_get_array(lbc, <span class="hljs-string">&#x27;lbc_rho&#x27;</span>, rho, <span class="hljs-number">2</span>)<br><span class="hljs-keyword">call</span> mpas_pool_get_array(lbc, <span class="hljs-string">&#x27;lbc_scalars&#x27;</span>, scalars, <span class="hljs-number">2</span>)<br>......<br><span class="hljs-keyword">if</span> (<span class="hljs-keyword">.not.</span> firstCall) <span class="hljs-keyword">then</span><br>    lbc_interval = currTime - LBC_intv_end<br>    <span class="hljs-keyword">call</span> mpas_get_timeInterval(interval=lbc_interval, DD=dd_intv, S=s_intv, S_n=sn_intv, S_d=sd_intv, ierr=ierr)<br>    dt = <span class="hljs-number">86400.0_RKIND</span> * <span class="hljs-keyword">real</span>(dd_intv, <span class="hljs-keyword">kind</span>=RKIND) + <span class="hljs-keyword">real</span>(s_intv, <span class="hljs-keyword">kind</span>=RKIND) &amp;<br>            + (<span class="hljs-keyword">real</span>(sn_intv, <span class="hljs-keyword">kind</span>=RKIND) / <span class="hljs-keyword">real</span>(sd_intv, <span class="hljs-keyword">kind</span>=RKIND))<br>    ......  <br>    <span class="hljs-keyword">call</span> mpas_pool_get_array(lbc, <span class="hljs-string">&#x27;lbc_u&#x27;</span>, u, <span class="hljs-number">2</span>)<br>    <span class="hljs-keyword">call</span> mpas_pool_get_array(lbc, <span class="hljs-string">&#x27;lbc_u&#x27;</span>, lbc_tend_u, <span class="hljs-number">1</span>)<br>    dt = <span class="hljs-number">1.0_RKIND</span> / dt<br>    lbc_tend_u(:,:) = (u(:,:) - lbc_tend_u(:,:)) * dt<br>    <span class="hljs-comment">!</span><br>    <span class="hljs-comment">! Logging the lbc start and end times appears to be backwards, but</span><br>    <span class="hljs-comment">! until the end of this function, LBC_intv_end == the last interval</span><br>    <span class="hljs-comment">! time and currTime == the next interval time.</span><br>    <span class="hljs-comment">!</span><br>    .......<br></code></pre></td></tr></table></figure></li></ul><div class="note note-primary">            <p><code>lbc_tend_u(:,:) = (u(:,:) - lbc_tend_u(:,:)) * dt</code> ==&gt; has shown the linear interpolation between two time LBCs intervals.</p>          </div><h4 id="srcframeworkmpas_pool_routines.f">src/framework/mpas_pool_routines.F</h4><h5 id="mpas_pool_get_array">mpas_pool_get_array</h5><ul><li>mpas_pool_get_array(inPool, key, scalar, timeLevel)<ul><li>mpas_pool_get_field_0d_real(inPool, key, field, timeLevel)<ul><li>mem =&gt; pool_get_member(inPool, key, MPAS_POOL_FIELD)</li><li>field =&gt; mem % r0 if mem % contentsTimeLevs == 1</li><li>field =&gt; mem % r0a(local_timeLevel) mem % contentsTimeLevs != 1<ul><li>In Fortran, when dealing with classes (specifically in the context of object-oriented programming introduced in Fortran 2003), the <code>%</code> operator is used to access components (like variables or methods) of a derived type (which is similar to a class in other programming languages).</li></ul></li></ul></li></ul></li></ul>    <div class="fold">      <div class="fold-title fold-info collapsed" data-toggle="collapse" href="#collapse-90469042" role="button" aria-expanded="false" aria-controls="collapse-90469042">        <div class="fold-arrow">▶</div>mpas_pool_get_array      </div>      <div class="fold-collapse collapse" id="collapse-90469042">        <div class="fold-content">          <figure class="highlight fortran"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><code class="hljs fortran"><span class="hljs-keyword">interface</span> mpas_pool_get_array<br>  <span class="hljs-keyword">module</span> <span class="hljs-keyword">procedure</span> mpas_pool_get_array_0d_real<br>  <span class="hljs-keyword">module</span> <span class="hljs-keyword">procedure</span> mpas_pool_get_array_1d_real<br>  <span class="hljs-keyword">module</span> <span class="hljs-keyword">procedure</span> mpas_pool_get_array_2d_real<br>  <span class="hljs-keyword">module</span> <span class="hljs-keyword">procedure</span> mpas_pool_get_array_3d_real<br>  <span class="hljs-keyword">module</span> <span class="hljs-keyword">procedure</span> mpas_pool_get_array_4d_real<br>  <span class="hljs-keyword">module</span> <span class="hljs-keyword">procedure</span> mpas_pool_get_array_5d_real<br>  <span class="hljs-keyword">module</span> <span class="hljs-keyword">procedure</span> mpas_pool_get_array_0d_int<br>  <span class="hljs-keyword">module</span> <span class="hljs-keyword">procedure</span> mpas_pool_get_array_1d_int<br>  <span class="hljs-keyword">module</span> <span class="hljs-keyword">procedure</span> mpas_pool_get_array_2d_int<br>  <span class="hljs-keyword">module</span> <span class="hljs-keyword">procedure</span> mpas_pool_get_array_3d_int<br>  <span class="hljs-keyword">module</span> <span class="hljs-keyword">procedure</span> mpas_pool_get_array_0d_char<br>  <span class="hljs-keyword">module</span> <span class="hljs-keyword">procedure</span> mpas_pool_get_array_1d_char<br><span class="hljs-keyword">end</span> <span class="hljs-keyword">interface</span><br><br><span class="hljs-comment">!-----------------------------------------------------------------------</span><br><span class="hljs-comment">!  subroutine mpas_pool_get_array_0d_real</span><br><span class="hljs-comment">!</span><br><span class="hljs-comment">!&gt; \brief MPAS Pool 0D Real field get subroutine</span><br><span class="hljs-comment">!&gt; \author Michael Duda, Doug Jacobsen</span><br><span class="hljs-comment">!&gt; \date   03/27/2014</span><br><span class="hljs-comment">!&gt; \details</span><br><span class="hljs-comment">!&gt; This subroutine returns a pointer to the array associated with key in inPool.</span><br><span class="hljs-comment">!</span><br><span class="hljs-comment">!-----------------------------------------------------------------------</span><br>   <span class="hljs-function"><span class="hljs-keyword">subroutine</span></span> mpas_pool_get_array_0d_real(inPool, key, scalar, timeLevel)<br><br>      <span class="hljs-keyword">implicit</span> <span class="hljs-keyword">none</span><br><br>      <span class="hljs-keyword">type</span> (mpas_pool_type), <span class="hljs-keyword">intent</span>(<span class="hljs-keyword">in</span>) :: inPool<br>      <span class="hljs-keyword">character</span> (len=*), <span class="hljs-keyword">intent</span>(<span class="hljs-keyword">in</span>) :: key<br>      <span class="hljs-keyword">real</span> (<span class="hljs-keyword">kind</span>=RKIND), <span class="hljs-keyword">pointer</span> :: scalar<br>      <span class="hljs-keyword">integer</span>, <span class="hljs-keyword">intent</span>(<span class="hljs-keyword">in</span>), <span class="hljs-keyword">optional</span> :: timeLevel<br><br>      <span class="hljs-keyword">type</span> (field0DReal), <span class="hljs-keyword">pointer</span> :: field<br><br><br>      <span class="hljs-keyword">call</span> mpas_pool_get_field_0d_real(inPool, key, field, timeLevel)<br><br>      <span class="hljs-built_in">nullify</span>(scalar)<br>      <span class="hljs-keyword">if</span> (<span class="hljs-built_in">associated</span>(field)) scalar =&gt; field % scalar<br><br>   <span class="hljs-keyword">end</span> <span class="hljs-function"><span class="hljs-keyword">subroutine</span></span> mpas_pool_get_array_0d_real<br>   <br>   <br><span class="hljs-comment">!-----------------------------------------------------------------------</span><br><span class="hljs-comment">!  subroutine mpas_pool_get_field_0d_real</span><br><span class="hljs-comment">!</span><br><span class="hljs-comment">!&gt; \brief MPAS Pool 0D Real field get subroutine</span><br><span class="hljs-comment">!&gt; \author Michael Duda, Doug Jacobsen</span><br><span class="hljs-comment">!&gt; \date   03/27/2014</span><br><span class="hljs-comment">!&gt; \details</span><br><span class="hljs-comment">!&gt; This subroutine returns a pointer to the field associated with key in inPool.</span><br><span class="hljs-comment">!</span><br><span class="hljs-comment">!-----------------------------------------------------------------------</span><br>   <span class="hljs-function"><span class="hljs-keyword">subroutine</span></span> mpas_pool_get_field_0d_real(inPool, key, field, timeLevel)<br><br>      <span class="hljs-keyword">implicit</span> <span class="hljs-keyword">none</span><br><br>      <span class="hljs-keyword">type</span> (mpas_pool_type), <span class="hljs-keyword">intent</span>(<span class="hljs-keyword">in</span>) :: inPool<br>      <span class="hljs-keyword">character</span> (len=*), <span class="hljs-keyword">intent</span>(<span class="hljs-keyword">in</span>) :: key<br>      <span class="hljs-keyword">type</span> (field0DReal), <span class="hljs-keyword">pointer</span> :: field<br>      <span class="hljs-keyword">integer</span>, <span class="hljs-keyword">intent</span>(<span class="hljs-keyword">in</span>), <span class="hljs-keyword">optional</span> :: timeLevel<br><br>      <span class="hljs-keyword">type</span> (mpas_pool_data_type), <span class="hljs-keyword">pointer</span> :: mem<br>      <span class="hljs-keyword">integer</span> :: local_timeLevel<br><br><br>      <span class="hljs-keyword">if</span> (<span class="hljs-built_in">present</span>(timeLevel)) <span class="hljs-keyword">then</span><br>         local_timeLevel = timeLevel<br>      <span class="hljs-keyword">else</span><br>         local_timeLevel = <span class="hljs-number">1</span><br>      <span class="hljs-keyword">end</span> <span class="hljs-keyword">if</span><br>      <br>      ......<br>      <br>      mem =&gt; pool_get_member(inPool, key, MPAS_POOL_FIELD)<br>      <br>         <span class="hljs-keyword">if</span> (mem % contentsTimeLevs == <span class="hljs-number">1</span>) <span class="hljs-keyword">then</span><br>            field =&gt; mem % r0<br>         <span class="hljs-keyword">else</span><br>            field =&gt; mem % r0a(local_timeLevel)<br>         <span class="hljs-keyword">end</span> <span class="hljs-keyword">if</span><br></code></pre></td></tr></table></figure>        </div>      </div>    </div><h1 id="prepared-lbc.nc-files">Prepared lbc.nc files</h1><ul><li><a href="https://www2.mmm.ucar.edu/projects/mpas/tutorial/Howard2024/index.html">Running limited-area simulations | MPAS tutorial practice guide</a></li><li>Each <code>lbc.ttt.nc</code> contains LBC values at <strong>T=ttt</strong>.</li></ul>]]></content>
    
    
    <categories>
      
      <category>MPAS</category>
      
    </categories>
    
    
    <tags>
      
      <tag>NWP</tag>
      
      <tag>WRF</tag>
      
      <tag>MPAS</tag>
      
      <tag>IC</tag>
      
      <tag>LBC</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>MPAS | FDDA</title>
    <link href="/2025/03/13/MPAS-FDDA/"/>
    <url>/2025/03/13/MPAS-FDDA/</url>
    
    <content type="html"><![CDATA[<h1 id="links">Links</h1><ol type="1"><li><a href="https://mpas-dev.github.io/">https://mpas-dev.github.io/</a></li><li><a href="https://github.com/MPAS-Dev/MPAS-Model/releases">/MPAS-Model/releases</a></li><li><a href="https://www2.mmm.ucar.edu/projects/mpas/mpas_atmosphere_users_guide_4.0.pdf">MPAS-Atmosphere Users' Guide V4.0</a></li><li><a href="https://www2.mmm.ucar.edu/projects/mpas/mpas_atmosphere_users_guide_5.3.pdf">MPAS-Atmosphere Users' Guide V5.3</a></li><li><a href="https://www2.mmm.ucar.edu/projects/mpas/mpas_atmosphere_users_guide_6.3.pdf">MPAS-Atmosphere Users' Guide V6.3</a></li><li><a href="https://www2.mmm.ucar.edu/projects/mpas/mpas_atmosphere_users_guide_7.0.pdf">MPAS-Atmosphere Users' Guide V7.0</a></li><li><a href="https://www2.mmm.ucar.edu/projects/mpas/mpas_atmosphere_users_guide_8.2.0.pdf">MPAS-Atmosphere Users' Guide V8.2.0</a></li><li><a href="https://www.mmm.ucar.edu/events/133129/agenda">Joint WRF/MPAS Users Workshop 2024</a></li></ol><h1 id="references">References</h1><ul><li><a href="https://gmd.copernicus.org/articles/11/2897/2018/gmd-11-2897-2018.pdf">Bullock Jr, O. R., Foroutan, H., Gilliam, R. C., &amp; Herwehe, J. A. (2018). Adding four-dimensional data assimilation by analysis nudging to the Model for Prediction Across Scales–Atmosphere (version 4.0). Geoscientific model development, 11(7), 2897-2922.</a><ul><li><strong>MPAS-A model source codes used in this study</strong> are available in the Supplement and at <a href="https://doi.org/10.5281/zenodo.1101204" class="uri">https://doi.org/10.5281/zenodo.1101204</a></li><li><strong>Run scripts used to prepare FDDA target fields</strong> are also included in the Supplement and at <a href="https://doi.org/10.5281/zenodo.1101204" class="uri">https://doi.org/10.5281/zenodo.1101204</a>. <figure class="highlight console"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs console">.<br>├── gmd-11-2897-2018-supplement-title-page.pdf<br>├── Model_code_for_MPAS-A_with_FDDA<br>│   ├── MPAS Copyright.txt<br>│   ├── MPAS-Release-4.0_plusFDDA.tar.gz<br>│   └── README.txt<br>└── scripts_for_FDDA_file_preparation<br>    ├── prepare_FDDA_file_Jan2013.csh<br>    ├── prepare_FDDA_file_Jul2013.csh<br>    └── prepare_FDDA_file_README.txt<br></code></pre></td></tr></table></figure> <div class="group-image-container"><div class="group-image-row"><div class="group-image-wrap"><img src="https://i.imgur.com/oOsTWeD.png" /></div><div class="group-image-wrap"><img src="https://i.imgur.com/paBdN3Z.png" /></div></div><div class="group-image-row"><div class="group-image-wrap"><img src="https://i.imgur.com/bowuno3.png" /></div><div class="group-image-wrap"><img src="https://i.imgur.com/8P35WuK.png" /></div></div></div></li></ul></li></ul><h1 id="mpas-release-4.0_plusfdda.tar.gz">MPAS-Release-4.0_plusFDDA.tar.gz</h1><ul><li><a href="https://doi.org/10.5281/zenodo.1101204" class="uri">https://doi.org/10.5281/zenodo.1101204</a></li><li>./core_atmosphere/Registry.xml <figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">var</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;rthfddaten&quot;</span>/&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">var</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;rqvfddaten&quot;</span>/&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">var</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;rufddaten&quot;</span>/&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">var</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;rvfddaten&quot;</span>/&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">var</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;th_fdda_old&quot;</span>/&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">var</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;qv_fdda_old&quot;</span>/&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">var</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;u_fdda_old&quot;</span>/&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">var</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;v_fdda_old&quot;</span>/&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">var</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;th_fdda_new&quot;</span>/&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">var</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;qv_fdda_new&quot;</span>/&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">var</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;u_fdda_new&quot;</span>/&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">var</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;v_fdda_new&quot;</span>/&gt;</span><br></code></pre></td></tr></table></figure></li></ul><h2 id="mpas_stream_manager.f">mpas_stream_manager.F</h2><ul><li>MPAS_stream_mgr_get_property</li></ul>    <div class="fold">      <div class="fold-title fold-info collapsed" data-toggle="collapse" href="#collapse-6ae3e036" role="button" aria-expanded="false" aria-controls="collapse-6ae3e036">        <div class="fold-arrow">▶</div>MPAS_stream_mgr_get_property      </div>      <div class="fold-collapse collapse" id="collapse-6ae3e036">        <div class="fold-content">          <figure class="highlight fortran"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs fortran"><span class="hljs-keyword">interface</span> MPAS_stream_mgr_get_property<br>    <span class="hljs-keyword">module</span> <span class="hljs-keyword">procedure</span> MPAS_stream_mgr_get_property_int<br>    <span class="hljs-keyword">module</span> <span class="hljs-keyword">procedure</span> MPAS_stream_mgr_get_property_char<br>    <span class="hljs-keyword">module</span> <span class="hljs-keyword">procedure</span> MPAS_stream_mgr_get_property_logical<br><span class="hljs-keyword">end</span> <span class="hljs-keyword">interface</span><br><br><span class="hljs-comment">!-----------------------------------------------------------------------</span><br><span class="hljs-comment">!  routine MPAS_stream_mgr_get_property_int</span><br><span class="hljs-comment">!</span><br><span class="hljs-comment">!&gt; \brief Gets a property of a stream in an MPAS stream manager.</span><br><span class="hljs-comment">!&gt; \author Michael Duda, Doug Jacobsen</span><br><span class="hljs-comment">!&gt; \date   13 June 2014</span><br><span class="hljs-comment">!&gt; \details</span><br><span class="hljs-comment">!&gt;  Retrieves the value of a stream property within an MPAS stream manager.</span><br><span class="hljs-comment">!&gt;  <span class="hljs-doctag">NOTE:</span> This routine does not support streamID regular expressions</span><br><span class="hljs-comment">!</span><br><span class="hljs-comment">!-----------------------------------------------------------------------</span><br><span class="hljs-function"><span class="hljs-keyword">subroutine</span></span> MPAS_stream_mgr_get_property_int(manager, streamID, propertyName, propertyValue, direction, ierr)<br></code></pre></td></tr></table></figure>        </div>      </div>    </div><h2 id="core_atmospherephysicsmpas_atmphys_fdda.f">./core_atmosphere/physics/mpas_atmphys_fdda.F</h2><ul><li>Author comments,<ul><li>!&gt; * Modified to <strong>only require reads of "fdda_new" data arrays</strong>. <strong>"fdda_old" is initially set to initial conditions</strong>. At end of FDDA data interval, <strong>"fdda_old" is set to "fdda_new" and updated "fdda_new" data comes from FDDA input stream</strong>. By O. Russell Bullock Jr. (bullock.russell@epa.gov) / 2016-08-30.</li></ul></li></ul><p>and then,</p><ul><li>Assign value</li></ul><figure class="highlight fortran"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs fortran"><span class="hljs-keyword">call</span> mpas_pool_get_array(fdda,<span class="hljs-string">&#x27;qv_fdda_old&#x27;</span>,qv_fdda_old)<br><span class="hljs-keyword">call</span> mpas_pool_get_array(fdda,<span class="hljs-string">&#x27;th_fdda_old&#x27;</span>,th_fdda_old)<br><span class="hljs-keyword">call</span> mpas_pool_get_array(fdda,<span class="hljs-string">&#x27;u_fdda_old&#x27;</span>, u_fdda_old )<br><span class="hljs-keyword">call</span> mpas_pool_get_array(fdda,<span class="hljs-string">&#x27;v_fdda_old&#x27;</span>, v_fdda_old )<br><span class="hljs-keyword">call</span> mpas_pool_get_array(fdda,<span class="hljs-string">&#x27;qv_fdda_new&#x27;</span>,qv_fdda_new)<br><span class="hljs-keyword">call</span> mpas_pool_get_array(fdda,<span class="hljs-string">&#x27;th_fdda_new&#x27;</span>,th_fdda_new)<br><span class="hljs-keyword">call</span> mpas_pool_get_array(fdda,<span class="hljs-string">&#x27;u_fdda_new&#x27;</span>, u_fdda_new )<br><span class="hljs-keyword">call</span> mpas_pool_get_array(fdda,<span class="hljs-string">&#x27;v_fdda_new&#x27;</span>, v_fdda_new )<br><span class="hljs-keyword">call</span> mpas_pool_get_array(tend_physics,<span class="hljs-string">&#x27;rthfddaten&#x27;</span>,rthfddaten)<br><span class="hljs-keyword">call</span> mpas_pool_get_array(tend_physics,<span class="hljs-string">&#x27;rqvfddaten&#x27;</span>,rqvfddaten)<br><span class="hljs-keyword">call</span> mpas_pool_get_array(tend_physics,<span class="hljs-string">&#x27;rufddaten&#x27;</span> ,rufddaten )<br><span class="hljs-keyword">call</span> mpas_pool_get_array(tend_physics,<span class="hljs-string">&#x27;rvfddaten&#x27;</span> ,rvfddaten )<br></code></pre></td></tr></table></figure><ul><li>No need to generate first time step and obtained FDDA value from init.nc</li></ul><figure class="highlight fortran"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs fortran"><span class="hljs-comment">!check to see if &#x27;old&#x27; FDDA target values need to be defined from initial conditions</span><br> <span class="hljs-keyword">if</span>(first_call <span class="hljs-keyword">.and.</span> <span class="hljs-keyword">.not.</span> config_do_restart) <span class="hljs-keyword">then</span><br>    qv_fdda_old = qv<br>    th_fdda_old = theta_m / (<span class="hljs-number">1._RKIND</span> + rvrd * qv)<br>    u_fdda_old = u<br>    v_fdda_old = v<br>    first_call = <span class="hljs-literal">.false.</span><br> <span class="hljs-keyword">endif</span><br></code></pre></td></tr></table></figure><ul><li>define the FDDA target data interval, <code>tfrac</code></li></ul><figure class="highlight fortran"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs fortran"><span class="hljs-comment">!calculate time fraction within FDDA target data interval</span><br> tfrac = <span class="hljs-built_in">mod</span>(xtime_s,fdda_int)/fdda_int<br></code></pre></td></tr></table></figure><ul><li>take <code>t_target</code> as example,</li></ul><figure class="highlight fortran"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs fortran"><span class="hljs-keyword">case</span>(<span class="hljs-string">&quot;analysis&quot;</span>)<br><br>   <span class="hljs-keyword">DO</span> i=its,ite<br>   <span class="hljs-keyword">DO</span> k=kts,kte<br><br>      theta_p = theta_m(k,i) / (<span class="hljs-number">1._RKIND</span> + rvrd * qv(k,i))<br><br>      <span class="hljs-keyword">if</span> (fdda_t <span class="hljs-keyword">.and.</span> k<span class="hljs-keyword">.gt.</span>fdda_t_min_layer <span class="hljs-keyword">.and.</span> (fdda_t_in_pbl <span class="hljs-keyword">.or.</span> k<span class="hljs-keyword">.gt.</span>kpbl(i))) <span class="hljs-keyword">then</span><br>         t_target = (<span class="hljs-number">1.0</span>-tfrac)*th_fdda_old(k,i)+tfrac*th_fdda_new(k,i)<br>         rthfddaten(k,i) = fdda_t_coef * ( t_target - theta_p )<br>      <span class="hljs-keyword">else</span><br>         rthfddaten(k,i) = <span class="hljs-number">0.</span><br>      <span class="hljs-keyword">endif</span><br></code></pre></td></tr></table></figure><ul><li>update <strong>old</strong> by <strong>new</strong> if it is <strong>on the last time step</strong>.</li></ul><figure class="highlight fortran"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs fortran"><span class="hljs-comment">!check to see if this is the last time step within the current FDDA target data interval and </span><br><span class="hljs-comment">!if so, save the current &quot;new&quot; targets as the &quot;old&quot; targets for the next time step</span><br> <span class="hljs-keyword">if</span>(<span class="hljs-built_in">mod</span>(xtime_s+config_dt,fdda_int)/fdda_int <span class="hljs-keyword">.lt.</span> tfrac) <span class="hljs-keyword">then</span><br>    th_fdda_old = th_fdda_new<br>    qv_fdda_old = qv_fdda_new<br>    u_fdda_old = u_fdda_new<br>    v_fdda_old = v_fdda_new<br> <span class="hljs-keyword">endif</span><br><br> <span class="hljs-built_in">write</span>(<span class="hljs-number">0</span>,*) <span class="hljs-string">&#x27;--- exit apply_fdda&#x27;</span><br></code></pre></td></tr></table></figure><h3 id="important-issue">Important issue</h3><p>The value of <code>fdda_old</code> is set to <code>fdda_new</code>, and the updated <code>fdda_new</code> data is obtained from the FDDA input stream.</p><p>At t=0, the <code>fdda_old</code> values are sourced from <code>init.nc</code>, and an additional data entry is required for <code>fdda_new</code>. One straightforward approach is to read the FDDA input file <code>00.nc</code> at t=0, which contains data for t=3 (or the next FDDA time) to serve as <code>fdda_new</code>.</p><h3 id="for-example">For example,</h3><p>Take FDDA time interval as 3 hours,</p><p>There is no <code>real</code> fdda.000.nc that contains FDDA data at t=0.</p><ul><li>t=0, <code>fdda_old</code> from init.nc and <code>fdda_new</code> from fdda.000.nc that contains FDDA value at t=3.</li><li>t=3, <code>fdda_old</code> from fdda.000.nc and <code>fdda_new</code> from fdda.003.nc that contains FDDA value at t=6.</li><li>t=6, <code>fdda_old</code> from fdda.003.nc and <code>fdda_new</code> from fdda.006.nc that contains FDDA value at t=9.</li><li>t=9, <code>fdda_old</code> from fdda.006.nc and <code>fdda_new</code> from fdda.009.nc that contains FDDA value at t=12.</li><li>......</li><li>and no final time step FDDA file.</li></ul><p>Therefore, we have to prepare the <strong>fdda.ttt.nc</strong> with <strong>ttt + Next FDDA time</strong> !!!</p><div class="note note-primary">            <p><strong>The purpose of this approach is to reduce storage usage.</strong></p>          </div><ul><li>The simple way is reading FDDA(<span class="math inline">\(t_0\)</span>) ad <span class="math inline">\(t=t_0\)</span>, and no need to add time shift in code.</li><li>Anothher way is reading FDD(<span class="math inline">\(t_{next fdda time}\)</span>) at <span class="math inline">\(t=t_0\)</span>, and no need to mismatch FDDA files with time shift.</li></ul><p><strong>Which one is better? Up to you. I like the second one la.</strong></p><h1 id="fdda-schemes">FDDA schemes</h1><ul><li><strong>'off'</strong></li><li><strong>'analysis'</strong></li><li><strong>'scaled'</strong></li></ul><p><img src="https://i.imgur.com/95PEK3s.png" width="600" /></p><h1 id="obs-fdda">Obs FDDA?</h1><p><strong>Any Observation FDDA in MPAS is in progress? No</strong></p><h2 id="in-wrf">In WRF,</h2><p><img src="https://i.imgur.com/6WoxlGO.png" width="400" /></p><div class="group-image-container"><div class="group-image-row"><div class="group-image-wrap"><img src="https://i.imgur.com/QEy2dUD.png" /></div><div class="group-image-wrap"><img src="https://i.imgur.com/S4yz9ta.png" /></div></div><div class="group-image-row"><div class="group-image-wrap"><img src="https://i.imgur.com/UOAWjvZ.png" /></div><div class="group-image-wrap"><img src="https://i.imgur.com/Zb9u08r.png" /></div><div class="group-image-wrap"><img src="https://i.imgur.com/p5JEibM.png" /></div></div></div><h1 id="us-epa">US-EPA</h1><ul><li><a href="https://github.com/MPAS-Dev/MPAS-Model/pull/995">Add 3-D grid analysis nudging FDDA to MPAS-A #995 | Oct 8, 2022</a><ul><li>from <code>jherwehe:atmosphere/develop-EPA_FDDA</code></li><li>This EPA_FDDA PR will add 3-D grid analysis nudging FDDA to MPAS-A as an option to assist in keeping retrospective simulations dynamically on track to improve evaluation against observations. This FDDA development for MPAS-A (Bullock et al., 2018) nudges temperature, humidity, and wind toward target values and is based on the comparable FDDA feature available in WRF, including MPAS-A versions of many of the WRF FDDA options. Enabling grid analysis nudging FDDA in MPAS-A maintains high fidelity to the reference fields while still conserving mass.</li></ul></li><li><a href="https://github.com/MPAS-Dev/MPAS-Model/pull/1027">Add the Pleim-Xiu (P-X) LSM and FDDA to MPAS-A #1027 | Jan 26, 2023</a><ul><li>from <code>jherwehe:atmosphere/develop-EPA_PXLSM_with_FDDA</code></li><li>This EPA_PXLSM_with_FDDA PR will add the Pleim-Xiu land surface model codes (<a href="https://github.com/MPAS-Dev/MPAS-Model/pull/1025">PR #1025</a>) and the 3-D grid analysis nudging FDDA codes (<a href="https://github.com/MPAS-Dev/MPAS-Model/pull/995">PR #995</a>) to MPAS-A.</li></ul></li></ul>]]></content>
    
    
    <categories>
      
      <category>MPAS</category>
      
    </categories>
    
    
    <tags>
      
      <tag>NWP</tag>
      
      <tag>WRF</tag>
      
      <tag>MPAS</tag>
      
      <tag>FDDA</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>MPAS | Convert LCZs into static.nc</title>
    <link href="/2025/03/11/MPAS-Convert-LCZs-into-static-nc/"/>
    <url>/2025/03/11/MPAS-Convert-LCZs-into-static-nc/</url>
    
    <content type="html"><![CDATA[<ul><li><a href="https://waipangsze.github.io/2024/10/07/Global-LCZ-for-Urban/"><strong>Map of Local Climate Zones (LCZs)</strong></a></li></ul><h1 id="lczs-source">LCZs source</h1><ul><li>Fast and easy Local Climate Zone mapping<ul><li>My example: <a href="https://waipangsze.github.io/2024/10/07/Global-LCZ-for-Urban/#some-regional-lcz-datasets" class="uri">https://waipangsze.github.io/2024/10/07/Global-LCZ-for-Urban/#some-regional-lcz-datasets</a></li><li><code>tiff</code> file</li></ul></li></ul><h2 id="convert-tif-to-netcdf">Convert tif to netcdf</h2><ul><li>My Code: <a href="https://waipangsze.github.io/2024/10/07/Global-LCZ-for-Urban/#convert-tif-to-netcdf" class="uri">https://waipangsze.github.io/2024/10/07/Global-LCZ-for-Urban/#convert-tif-to-netcdf</a></li></ul><h1 id="convert-lczs-into-mpas">Convert LCZs into MPAS</h1>    <div class="fold">      <div class="fold-title fold-info collapsed" data-toggle="collapse" href="#collapse-8f7bdefe" role="button" aria-expanded="false" aria-controls="collapse-8f7bdefe">        <div class="fold-arrow">▶</div>convert2LCZ.py      </div>      <div class="fold-collapse collapse" id="collapse-8f7bdefe">        <div class="fold-content">          <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> os, math, time, sys, glob, logging<br><span class="hljs-keyword">import</span> xarray <span class="hljs-keyword">as</span> xr<br><span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np<br><span class="hljs-keyword">from</span> scipy <span class="hljs-keyword">import</span> stats <span class="hljs-keyword">as</span> st<br><br>logging.basicConfig(level=logging.WARNING) <span class="hljs-comment"># DEBUG, INFO, WARNING</span><br><br>in_static = xr.open_dataset(<span class="hljs-string">&quot;in_static.nc&quot;</span>)<br>lcz_dataset = xr.open_dataset(<span class="hljs-string">&quot;lcz.nc&quot;</span>)<br><br><span class="hljs-built_in">print</span>(in_static)<br><span class="hljs-built_in">print</span>(lcz_dataset)<br><br>latCell = in_static[<span class="hljs-string">&quot;latCell&quot;</span>][:].values*<span class="hljs-number">57.2957795</span><br>lonCell = in_static[<span class="hljs-string">&quot;lonCell&quot;</span>][:].values*<span class="hljs-number">57.2957795</span><br>nCells  = latCell.shape[<span class="hljs-number">0</span>]<br>dcEdge = in_static[<span class="hljs-string">&quot;dcEdge&quot;</span>][:].values <span class="hljs-comment"># meter</span><br>edgesOnCell = in_static[<span class="hljs-string">&quot;edgesOnCell&quot;</span>][:].values<br>nEdges = dcEdge.shape[<span class="hljs-number">0</span>]<br>maxEdges = edgesOnCell.shape[<span class="hljs-number">1</span>]<br>ivgtyp = in_static[<span class="hljs-string">&quot;ivgtyp&quot;</span>][:].values<br><br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;=&quot;</span>*<span class="hljs-number">40</span>)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;nCells, nEdges, maxEdges = &quot;</span>, nCells, nEdges, maxEdges)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;latCell     = &quot;</span>, latCell.shape)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;lonCell     = &quot;</span>, lonCell.shape)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;dcEdge      = &quot;</span>, dcEdge.shape)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;edgesOnCell = &quot;</span>, edgesOnCell.shape)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;ivgtyp      = &quot;</span>, ivgtyp.shape)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;min/max     = &quot;</span>, np.<span class="hljs-built_in">min</span>(latCell), np.<span class="hljs-built_in">max</span>(latCell), np.<span class="hljs-built_in">min</span>(lonCell), np.<span class="hljs-built_in">max</span>(lonCell))<br><br>lat = lcz_dataset[<span class="hljs-string">&quot;lat&quot;</span>][:].values<br>lon = lcz_dataset[<span class="hljs-string">&quot;lon&quot;</span>][:].values<br>Band2 = lcz_dataset[<span class="hljs-string">&quot;Band2&quot;</span>][:].values<br>nlat = lat.shape[<span class="hljs-number">0</span>]<br>nlon = lon.shape[<span class="hljs-number">0</span>]<br><br>min_lat, max_lat = np.<span class="hljs-built_in">min</span>(lat), np.<span class="hljs-built_in">max</span>(lat)<br>min_lon, max_lon = np.<span class="hljs-built_in">min</span>(lon), np.<span class="hljs-built_in">max</span>(lon)<br>dlatlon = np.<span class="hljs-built_in">abs</span>(lat[<span class="hljs-number">1</span>] - lat[<span class="hljs-number">0</span>])*<span class="hljs-number">111</span> <span class="hljs-comment"># deg to km</span><br><br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;=&quot;</span>*<span class="hljs-number">40</span>)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;nlat, nlon = &quot;</span>, nlat, nlon)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;lat        = &quot;</span>, lat.shape)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;lon        = &quot;</span>, lon.shape)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;min_lat, max_lat  = &quot;</span>, min_lat, max_lat)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;min_lon, max_lon  = &quot;</span>, min_lon, max_lon)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;diff lat/lon = &quot;</span>, lat[<span class="hljs-number">1</span>:<span class="hljs-number">5</span>]-lat[<span class="hljs-number">0</span>:<span class="hljs-number">4</span>], lon[<span class="hljs-number">1</span>:<span class="hljs-number">5</span>]-lon[<span class="hljs-number">0</span>:<span class="hljs-number">4</span>])<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Band2      = &quot;</span>, Band2.shape)<br><br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;=&quot;</span>*<span class="hljs-number">40</span>)<br><span class="hljs-comment">#radius = 1km</span><br>tmp_count_urban = <span class="hljs-number">0</span><br>tmp_count_urban_change = <span class="hljs-number">0</span><br><span class="hljs-comment">##</span><br><span class="hljs-keyword">for</span> px <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(nCells): <span class="hljs-comment"># nCells</span><br><span class="hljs-keyword">if</span>(px%<span class="hljs-number">5000</span> == <span class="hljs-number">0</span>):<br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">round</span>(px/nCells*<span class="hljs-number">100</span>), <span class="hljs-string">&quot; %&quot;</span>)<br><br><span class="hljs-keyword">if</span>(ivgtyp[px] == <span class="hljs-number">13</span> <span class="hljs-keyword">or</span> ivgtyp[px] == <span class="hljs-number">32</span>): <span class="hljs-comment"># 13 is urban or 32 is urban</span><br>tmp_count_urban = tmp_count_urban + <span class="hljs-number">1</span><br><span class="hljs-keyword">if</span>( (min_lat &lt;= latCell[px]) <span class="hljs-keyword">and</span> (max_lat &gt;= latCell[px]) <span class="hljs-keyword">and</span> (min_lon &lt;= lonCell[px]) <span class="hljs-keyword">and</span> (max_lon &gt;= lonCell[px]) ): <span class="hljs-comment"># within LCZ dataset</span><br>index_lat = np.argmin(np.<span class="hljs-built_in">abs</span>(lat - latCell[px]))<br>index_lon = np.argmin(np.<span class="hljs-built_in">abs</span>(lon - lonCell[px]))<br>tmp_info = <span class="hljs-built_in">str</span>(latCell[px] - lat[index_lat]) +<span class="hljs-string">&quot; &quot;</span>+ <span class="hljs-built_in">str</span>(lonCell[px] - lon[index_lon]) +<span class="hljs-string">&quot; &quot;</span>+ <span class="hljs-built_in">str</span>(Band2[index_lat, index_lon])<br>logging.info(tmp_info)<br>tmp_count_urban_change = tmp_count_urban_change +<span class="hljs-number">1</span><br><br><span class="hljs-comment">#</span><br><span class="hljs-comment"># LCZ: 1 to 17 </span><br><span class="hljs-comment"># Only 1 to 11 are used and corresponding to 31 (LCZ1) to 41 (LCZE = LCZ11, index = 15)</span><br><span class="hljs-comment"># LCZ E (LCZ 11): Rock and paved;</span><br><span class="hljs-comment">#</span><br><span class="hljs-keyword">if</span> ( Band2[index_lat, index_lon] &lt; <span class="hljs-number">11</span> <span class="hljs-keyword">or</span> Band2[index_lat, index_lon] == <span class="hljs-number">15</span> ):<br><span class="hljs-comment">#</span><br><span class="hljs-comment"># For select from nearest cell,</span><br><span class="hljs-comment"># in_static[&quot;ivgtyp&quot;][px] = Band2[index_lat, index_lon] + 30</span><br><span class="hljs-comment">#</span><br>tmp_dx = np.<span class="hljs-built_in">min</span>(dcEdge[edgesOnCell[px,:]])/<span class="hljs-number">1000</span>   <span class="hljs-comment"># meter to km</span><br>tmp_num_cell = <span class="hljs-built_in">round</span>((tmp_dx/dlatlon)/<span class="hljs-number">2</span>)          <span class="hljs-comment"># count and take half</span><br><br><span class="hljs-comment">#</span><br><span class="hljs-comment"># For take mode, may check the boundary of Band2</span><br><span class="hljs-comment"># 1) remove 11,12,13,14,16,17</span><br><span class="hljs-comment">#</span><br><br>tmp_ar1 = Band2[index_lat-tmp_num_cell:index_lat+tmp_num_cell, index_lon-tmp_num_cell:index_lon+tmp_num_cell].flatten()<br>tmp_ar2 = tmp_ar1<br><br><span class="hljs-comment"># only 1-10 and 15(LCZ11) are our needs on LCZ dataset.</span><br><span class="hljs-comment"># then, remove the test.</span><br><span class="hljs-keyword">for</span> py <span class="hljs-keyword">in</span> [<span class="hljs-number">11</span>,<span class="hljs-number">12</span>,<span class="hljs-number">13</span>,<span class="hljs-number">14</span>,<span class="hljs-number">16</span>,<span class="hljs-number">17</span>]:<br><span class="hljs-keyword">if</span> np.where(tmp_ar2 == py)[<span class="hljs-number">0</span>].size != <span class="hljs-number">0</span>: <span class="hljs-comment"># if not empyt array</span><br>tmp_ar2 = np.delete(tmp_ar2, np.where(tmp_ar2 == py)[<span class="hljs-number">0</span>][:])<br><br>tmp_array = tmp_ar2 + <span class="hljs-number">30</span><br>tmp = st.mode(tmp_array)[<span class="hljs-number">0</span>] <span class="hljs-comment"># stats. mode. Compute the mode (most common value) along an axis of an array.</span><br><br><span class="hljs-comment"># To check wehther LCZ dataset is None value?</span><br><span class="hljs-comment"># Some LCZ datasets has 0 that is nothing.</span><br><span class="hljs-keyword">if</span> (<span class="hljs-built_in">len</span>(tmp) == <span class="hljs-number">0</span>):<br><span class="hljs-keyword">continue</span><br>        <br><span class="hljs-keyword">if</span> (<span class="hljs-built_in">int</span>(tmp[<span class="hljs-number">0</span>]) == <span class="hljs-number">45</span>):<br>in_static[<span class="hljs-string">&quot;ivgtyp&quot;</span>][px] = <span class="hljs-number">41</span><br><span class="hljs-keyword">else</span>:<br>in_static[<span class="hljs-string">&quot;ivgtyp&quot;</span>][px] = <span class="hljs-built_in">int</span>(tmp[<span class="hljs-number">0</span>])<br><br><span class="hljs-keyword">else</span>:<br>in_static[<span class="hljs-string">&quot;ivgtyp&quot;</span>][px] = <span class="hljs-number">32</span><br><span class="hljs-keyword">else</span>:<br>in_static[<span class="hljs-string">&quot;ivgtyp&quot;</span>][px] = <span class="hljs-number">32</span><br><br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Total urban in MPAS mesh  = &quot;</span>, tmp_count_urban)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Change urban in MPAS mesh = &quot;</span>, tmp_count_urban_change)<br><span class="hljs-comment">#in_static[&quot;ivgtyp&quot;][:] = 31/32/33</span><br>in_static.to_netcdf(<span class="hljs-string">&quot;out_static.nc&quot;</span>)<br></code></pre></td></tr></table></figure>        </div>      </div>    </div><h2 id="example">Example</h2><p>A test case:</p><ul><li>GBA</li><li>Tokyo</li><li>Houston</li></ul>    <div class="fold">      <div class="fold-title fold-info collapsed" data-toggle="collapse" href="#collapse-dcdac752" role="button" aria-expanded="false" aria-controls="collapse-dcdac752">        <div class="fold-arrow">▶</div>Example      </div>      <div class="fold-collapse collapse" id="collapse-dcdac752">        <div class="fold-content">          <figure class="highlight console"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><code class="hljs console">├── convert2LCZ.py<br>├── final_static.nc -&gt; final-process/step3/out_static.nc<br>├── GBA<br>│   ├── arcgis_lcz_colormap.clr<br>│   ├── c672ca892c88d1e078a81e7a085913396172f81c_factsheet.html<br>│   ├── c672ca892c88d1e078a81e7a085913396172f81c.kmz<br>│   ├── c672ca892c88d1e078a81e7a085913396172f81c.tif<br>│   ├── data<br>│   ├── factsheet_files<br>│   ├── figures<br>│   ├── GBA.nc -&gt; lcz_filter_v3.nc<br>│   ├── lcz_filter_v3.nc<br>│   ├── lcz_filter_v3.tif -&gt; c672ca892c88d1e078a81e7a085913396172f81c.tif<br>│   ├── log.log<br>│   ├── qgis_lcz_colormap.txt<br>│   └── run_tif2nc.sh -&gt; ../run_tif2nc.sh<br>├── final-process<br>│   ├── convert2LCZ.py -&gt; ../convert2LCZ.py<br>│   ├── lcz_filter_v3.nc -&gt; ../lcz_filter_v3.nc<br>│   ├── run_nc2LCZ.sh -&gt; ../run_nc2LCZ.sh<br>│   ├── static.nc -&gt; /home/wpsze/static.nc<br>│   ├── step1<br>│   │   ├── convert2LCZ.py -&gt; ../convert2LCZ.py<br>│   │   ├── GBA.nc -&gt; ../../../GBA/GBA.nc<br>│   │   ├── in_static.nc -&gt; static.nc<br>│   │   ├── lcz.nc -&gt; GBA.nc<br>│   │   ├── out_static.nc<br>│   │   ├── run_nc2LCZ.sh -&gt; ../run_nc2LCZ.sh<br>│   │   └── static.nc -&gt; ../static.nc<br>│   ├── step2<br>│   │   ├── convert2LCZ.py -&gt; ../../convert2LCZ.py<br>│   │   ├── in_static.nc -&gt; ../step1/out_static.nc<br>│   │   ├── lcz.nc -&gt; Tokyo.nc<br>│   │   ├── out_static.nc<br>│   │   ├── run_nc2LCZ.sh -&gt; ../run_nc2LCZ.sh<br>│   │   └── Tokyo.nc -&gt; ../../../Tokyo/Tokyo.nc<br>│   └── step3<br>│       ├── convert2LCZ.py -&gt; ../convert2LCZ.py<br>│       ├── Houston.nc -&gt; ../../../Houston/map/Houston.nc<br>│       ├── in_static.nc -&gt; ../step2/out_static.nc<br>│       ├── lcz.nc -&gt; Houston.nc<br>│       ├── out_static.nc<br>│       └── run_nc2LCZ.sh -&gt; ../run_nc2LCZ.sh<br>├── Houston<br>│   ├── 037c80744fc1034b8472f594d829c53ce1cccfa7.zip<br>│   ├── 67a3371158ad3ac12d720fde089622c259e8e400.zip<br>│   └── map<br>├── lcz_filter_v3.nc<br>├── lcz_filter_v3.tif<br>├── run_nc2LCZ.sh<br>├── run_tif2nc.sh<br>└── Tokyo<br>    ├── 67a3371158ad3ac12d720fde089622c259e8e400_factsheet.html<br>    ├── 67a3371158ad3ac12d720fde089622c259e8e400.kmz<br>    ├── 67a3371158ad3ac12d720fde089622c259e8e400.tif<br>    ├── arcgis_lcz_colormap.clr<br>    ├── data<br>    ├── factsheet_files<br>    ├── figures<br>    ├── lcz_filter_v3.nc<br>    ├── lcz_filter_v3.tif -&gt; 67a3371158ad3ac12d720fde089622c259e8e400.tif<br>    ├── log.log<br>    ├── qgis_lcz_colormap.txt<br>    ├── run_tif2nc.sh -&gt; ../run_tif2nc.sh<br>    └── Tokyo.nc -&gt; lcz_filter_v3.nc<br></code></pre></td></tr></table></figure>        </div>      </div>    </div>    <div class="fold">      <div class="fold-title fold-info collapsed" data-toggle="collapse" href="#collapse-6ae3e036" role="button" aria-expanded="false" aria-controls="collapse-6ae3e036">        <div class="fold-arrow">▶</div>run_tif2nc.sh      </div>      <div class="fold-collapse collapse" id="collapse-6ae3e036">        <div class="fold-content">          <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-meta">#!/bin/bash</span><br><br><span class="hljs-built_in">source</span> /home/wpsze/micromamba/etc/profile.d/micromamba.sh<br>micromamba activate gdal<br><br>whereis gdal_translate<br><br><span class="hljs-comment"># for checking</span><br>gdal_translate --long-usage<br><br><span class="hljs-comment"># gdal_translate -of netCDF -co &quot;FOMRAT=NC4&quot; ia.tif ia.nc</span><br><br><span class="hljs-comment"># ln -s lcz_filter_v3.nc output.nc</span><br><br>gdal_translate -of netCDF -co <span class="hljs-string">&quot;FOMRAT=NC4&quot;</span> lcz_filter_v3.tif lcz_filter_v3.nc <br></code></pre></td></tr></table></figure>        </div>      </div>    </div>]]></content>
    
    
    <categories>
      
      <category>MPAS</category>
      
    </categories>
    
    
    <tags>
      
      <tag>WRF</tag>
      
      <tag>MPAS</tag>
      
      <tag>Urban</tag>
      
      <tag>UCM</tag>
      
      <tag>LCZs</tag>
      
      <tag>UCPs</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>MPAS-CMAQ | SMOKE | Emission Inventory processing data</title>
    <link href="/2025/03/10/MPAS-CMAQ-SMOKE-Emission-Inventory-processing-data/"/>
    <url>/2025/03/10/MPAS-CMAQ-SMOKE-Emission-Inventory-processing-data/</url>
    
    <content type="html"><![CDATA[<ul><li><a href="https://github.com/CEMPD/SMOKE/wiki/Running-SMOKE-using-EPA&#39;s-Emissions-Modeling-Platforms">SMOKE github</a></li><li><a href="https://www.cmascenter.org/smoke/documentation/5.1/html/ch01.html">SMOKE documentation</a></li></ul><h1 id="the-sparse-matrix-operator-kernel-emissions-smoke-modeling-system">The Sparse Matrix Operator Kernel Emissions (SMOKE) Modeling System</h1><p>The MCNC Environmental Modeling Center (EMC) created the Sparse Matrix Operator Kernel Emissions (SMOKE) Modeling System to <strong>allow emissions data processing methods to integrate high-performance-computing (HPC) sparse-matrix algorithms</strong>. The SMOKE system is a significant addition to the available resources for decision-making about emissions controls for both urban and regional applications. The SMOKE prototype, available since 1996, was an effective tool for emissions processing in a number of regional air quality modeling applications. In 1998 and 1999, SMOKE was redesigned and improved with the support of the U.S. Environmental Protection Agency (EPA)</p><p>SMOKE can process criteria gaseous pollutants such as <strong>carbon monoxide (CO), nitrogen oxides (NOx), volatile organic compounds (VOC), ammonia (NH3), sulfur dioxide (SO2); particulate matter (PM) pollutants such as PM 2.5 microns or less (PM2.5) and PM less than 10 microns (PM10)</strong>; as well as a large array of <strong>toxic pollutants</strong>, such as <strong>mercury, cadmium, benzene, and formaldehyde</strong>. In fact, SMOKE has no limitation regarding the number or types of pollutants it can process.</p><p>The purpose of SMOKE (or any emissions processor) is</p><ul><li><strong>to convert the resolution of the emission inventory data to the resolution needed by an air quality model (AQM)</strong>.</li></ul><p>Emission inventories are typically available with an annual-total emissions value for each emissions source, or perhaps with an average-day emissions value. The AQMs, however, typically require emissions data on an hourly basis, for each model grid cell (and perhaps model layer), and for each model species.</p><ul><li>SMOKE 主要是一個排放處理系統，旨在<strong>創建網格化、物種化、每小時排放量</strong>，以輸入各種空氣品質模型，例如 CMAQ、REMSAD、CAMX 和 UAM。 SMOKE 支援區域、生物源、移動（道路和非道路）和點源排放處理，以處理標準、顆粒物和有毒污染物。對於生物源排放建模，SMOKE 使用生物源排放清單系統。</li><li>SMOKE 還與道路排放模型 MOVES 整合。SMOKE 模式是應用最為廣泛的排放源處理模式，現為美國 EPA 源排放處理的官方模型，<strong>該模型中採用稀疏矩陣方法進行運算，直接為模式系統提供網格化的排放源</strong>。SMOKE 模型可以為<strong>多種空氣質量模型提供輸入，考慮了面源、點源及移動源 3 部分</strong>，針對不同類型排放源的<strong>空間分佈屬性、時間變化規律，設置不同比時空分配曲線，更合理地反映不同類型排放的時空特徵</strong>。此外，還可根據用戶選擇的化學機制對排放數據進行化學分裂。</li></ul><h1 id="香港排放清單報告-hkepd">香港排放清單報告-HKEPD</h1><ul><li><a href="https://www.epd.gov.hk/epd/sites/default/files/2020EIRC_15082022.pdf">2020年香港排放清單報告</a></li></ul><h1 id="tw-行政院環境保護署">TW-行政院環境保護署</h1><ul><li><a href="https://aqmc.moenv.gov.tw/download/CMAQ/%E9%99%84%E4%BB%B6%E4%BA%8C%20%E6%96%B0%E5%A2%9E%E6%B1%A1%E6%9F%93%E6%BA%90%E8%99%95%E7%90%86%E7%A8%8B%E5%BA%8F%E6%8E%92%E6%94%BE%E6%AA%94%E8%A3%BD%E4%BD%9C.pdf">附件二 新增污染源處理程序排放檔製作</a></li></ul>]]></content>
    
    
    <categories>
      
      <category>MPAS</category>
      
    </categories>
    
    
    <tags>
      
      <tag>NWP</tag>
      
      <tag>WRF</tag>
      
      <tag>MPAS</tag>
      
      <tag>ERA5</tag>
      
      <tag>GFS</tag>
      
      <tag>CMAQ</tag>
      
      <tag>SMOKE</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>MPAS | WRF | precipitation calculation</title>
    <link href="/2025/03/10/MPAS-WRF-precipitation-calculation/"/>
    <url>/2025/03/10/MPAS-WRF-precipitation-calculation/</url>
    
    <content type="html"><![CDATA[<h1 id="precipitation-variables">Precipitation variables</h1><ul><li><strong>rainc</strong>: accumulated total cumulus precipitation</li><li><strong>rainsh</strong>: accumulated shallow cumulus precipitation</li><li><strong>rainnc</strong>: accumulated total grid scale precipitation</li><li><strong>snownc</strong>: accumulated total grid scale snow and ice</li><li><strong>graupelnc</strong>: accumulated total grid scale graupel</li><li><strong>hailnc</strong>: accumulated total grid scale hail</li></ul><div class="note note-primary">            <ul><li><code>rainc</code>: rainfall from a cumulus scheme (mm) from <strong>cu_physics/cumulus scheme precipitation</strong></li><li><code>rainnc</code>: rainfall from an explicit scheme (mm) from <strong>microphysics</strong></li></ul>          </div><div class="note note-primary">            <ul><li><strong>Convective</strong> Precip ---&gt; rain<strong>c</strong></li><li><strong>Non-convective</strong> Precip ---&gt; rain<strong>nc</strong></li></ul>          </div><ul><li><a href="https://forum.mmm.ucar.edu/threads/wrf-precipitation-calculation.12798/#post-30917">WRF precipitation calculation | Apr 4, 2023</a><ul><li><strong>Total accumulated precipitation is always "rainc + rainnc"</strong>. Other items are included in rainc and rainnc calculation.</li><li>In fact, <strong>shallow convection</strong> produces little precipitation.</li></ul></li><li><a href="https://forum.mmm.ucar.edu/threads/rainc-rainnc.16696/#post-41178">rainc, rainnc | 2024</a><ul><li><strong>Rainc is cumulative convective precipitation</strong></li><li><strong>Rainnc is cumulative non convective precipitation</strong></li></ul></li><li><a href="https://forum.mmm.ucar.edu/threads/wrf-rainfall-visualisation.17086/#post-41902">wrf rainfall visualisation | 2024</a><ul><li><code>rainc</code> and <code>rainnc</code> are <strong>convective</strong> and <strong>large-scale precipitation</strong>, respectively.</li><li>Both are accumulated variables, which means they are accumulated from the beginning of the model run. Total precipitation is rainc + rainnc.</li></ul></li></ul><h1 id="cumulative-variables">cumulative variables</h1><p>The variables <code>RAINC</code> and <code>RAINNC</code> are <strong>cumulative variables</strong>. To get the values at any particular point in time, you would need to calculate that. For e.g. if you are interested in <strong>daily values</strong> for 2017-11-05,</p><ul><li>RAINC = RAINC (at time 2017-11-06_00:00:00) - RAINC (at time 2017-11-05_00:00:00).</li></ul><h1 id="rainfall-only-liquid-precipitation">Rainfall only (Liquid precipitation)</h1><ul><li>phys/module_diag_trad_fields.F</li></ul><figure class="highlight fortran"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs fortran"><span class="hljs-comment">! Total rainfall</span><br>    rain(i,j) =   rainc(i,j) + rainnc(i,j)<br>    <span class="hljs-comment">! Total liquid rainfall</span><br>    liqrain(i,j) =   rainc(i,j) + rainnc(i,j) - snownc(i,j) - graupelnc(i,j) - hailnc(i,j)<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>MPAS</category>
      
    </categories>
    
    
    <tags>
      
      <tag>NWP</tag>
      
      <tag>WRF</tag>
      
      <tag>MPAS</tag>
      
      <tag>ERA5</tag>
      
      <tag>GFS</tag>
      
      <tag>rainc</tag>
      
      <tag>rainnc</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>WRF | WRF-DA test case</title>
    <link href="/2025/03/07/WRF-WRF-DA-test-case/"/>
    <url>/2025/03/07/WRF-WRF-DA-test-case/</url>
    
    <content type="html"><![CDATA[<h1 id="dvar-test-case">3dvar test case</h1><ul><li>Download test data<ul><li><a href="https://www2.mmm.ucar.edu/wrf/users/wrfda/OnlineTutorial/3dvar/testcase.html" class="uri">https://www2.mmm.ucar.edu/wrf/users/wrfda/OnlineTutorial/3dvar/testcase.html</a></li></ul></li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs consle">be  <br>ob  <br>rc  <br>namelist.input.3dvar  <br>namelist.input.4dvar  <br>WRFDAV3.9-testdata.tar.gz<br></code></pre></td></tr></table></figure><ul><li><strong>"be"</strong> contains our background error data in a binary file named "<code>be.dat</code>". This file must be generated on a case-by-case basis. The utility used to generate background error data is known as "<code>gen_be</code>"; instructions on how to use this will be covered in the advanced tutorial.</li><li><strong>"ob"</strong> contains our observation data. This folder contains many different types of data, but the file we will be using for this basic tutorial is named "<code>ob.ascii</code>". This is an ASCII text file, and contains a number of different observation types (including balloon soundings, surface METAR, ships, and buoy observations.</li><li><strong>"rc"</strong> contains the first guess and boundary files. These files are generated by WPS and WRF; you can find more information in the User's Guide and the WRF/WPS Online Tutorial.</li></ul><h2 id="error">Error</h2><h3 id="this-input-data-is-not-v4">This input data is not V4</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs log">   This input data is not V4:  OUTPUT FROM REAL_EM V3.9pre#2 PREPROCESSOR<br>  File name that is causing troubles = fg<br>   You can try 1) ensure that the input file was created with WRF v4 pre-processors, or<br>   2) use force_use_old_data=T in the time_control record of the namelist.input file<br>-------------- FATAL CALLED ---------------<br>FATAL CALLED FROM FILE:  &lt;stdin&gt;  LINE:     329<br> ---- ERROR: The input file appears to be from a pre-v4 version of WRF initialization routines<br>-------------------------------------------<br></code></pre></td></tr></table></figure><ul><li><code>2) use force_use_old_data=T in the time_control record of the namelist.input file</code></li></ul><h2 id="output">Output</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-built_in">mkdir</span> 3dvar<br><span class="hljs-built_in">cd</span> 3dvar<br><span class="hljs-built_in">cp</span> ../WRFDA/var/test/tutorial/namelist.input .<br><span class="hljs-built_in">ln</span> -sf ../WRFDA/run/LANDUSE.TBL<br><span class="hljs-built_in">ln</span> -sf ../be/be.dat .<br><span class="hljs-built_in">ln</span> -sf ../ob/2008020512/ob.ascii .<br><span class="hljs-built_in">ln</span> -sf ../rc/2008020512/wrfinput_d01 ./fg<br><span class="hljs-built_in">ln</span> -sf ../WRFDA/var/build/da_wrfvar.exe .<br><br><span class="hljs-comment">#&amp;wrfvar7</span><br><span class="hljs-comment">#cv_options=5,</span><br><span class="hljs-comment">#/</span><br><br>./da_wrfvar.exe &gt;&amp; wrfda.out<br></code></pre></td></tr></table></figure><p><img src="https://i.imgur.com/hijsnEh.png" width="500" /></p><table><thead><tr class="header"><th>File</th><th>Details</th></tr></thead><tbody><tr class="odd"><td>cost_fn</td><td>Details the various components of the cost function for each outer iteration</td></tr><tr class="even"><td>grad_fn</td><td>Details the various components of the gradient function for each outer iteration</td></tr><tr class="odd"><td>gts_omb_oma_01</td><td>Detailed statistics about all observations.</td></tr><tr class="even"><td>gts_omb_oma_01.0000</td><td>Detailed statistics about the observations used on each processor. For parallel runs, there will be one of these files for each processor used.</td></tr><tr class="odd"><td>jo</td><td>Cost function statistics for each observation type.</td></tr><tr class="even"><td>namelist.output.da</td><td>Those namelist options not specified in the "namelist.input" file will be assigned default values. This file lists ALL namelist options selected for your run, including all default options.</td></tr><tr class="odd"><td>qcstat_conv_01</td><td>Details quality control information for each individual variable for each observation type.</td></tr><tr class="even"><td>rej_obs_conv_01.000</td><td>Lists each rejected observation</td></tr><tr class="odd"><td>statistics</td><td>Lists useful statistics for each observation type</td></tr><tr class="even"><td><strong>wrfda.out</strong></td><td>This is the file where you sent WRFDA's standard output. This should contain run-time information, as well as any errors which may have occurred.</td></tr><tr class="odd"><td><strong>wrfvar_output</strong></td><td>Finally, the most important file! This is the analysis produced by WRFDA in netCDF format.</td></tr></tbody></table><h1 id="obsproc-for-3dvar">OBSPROC for 3DVAR</h1><h2 id="running-observation-preprocessor-obsproc">Running Observation Preprocessor (OBSPROC)</h2><p>The <strong>OBSPROC</strong> program reads observations in <strong>LITTLE_R format</strong> (a text-based format, in use since the MM5 era). We have provided observations for the tutorial case, but for your own applications, you will have to prepare your own observation files. Please see <a href="http://www2.mmm.ucar.edu/wrf/users/wrfda/download/free_data.html" class="uri">http://www2.mmm.ucar.edu/wrf/users/wrfda/download/free_data.html</a> for the <strong>sources of some freely-available observations</strong>.</p><p>A number of datasets which provide observation data and/or background atmospheric estimates for WRFDA can be downloaded directly from the <a href="http://rda.ucar.edu/">CISL Research Data Archive (RDA)</a> web site. This page lists several useful datasets from that archive, as well as some other useful data sources. All data sets listed on this page are free for users to download.</p><ul><li>CISL RDA Background datasets</li><li>CISL RDA Observation datasets</li><li>Other radiance datasets</li></ul><div class="group-image-container"><div class="group-image-row"><div class="group-image-wrap"><img src="https://i.imgur.com/qwGmXea.png" /></div><div class="group-image-wrap"><img src="https://i.imgur.com/U33BnJT.png" /></div><div class="group-image-wrap"><img src="https://i.imgur.com/ypKq7EP.png" /></div></div><div class="group-image-row"><div class="group-image-wrap"><img src="https://i.imgur.com/9MDx45k.png" /></div></div></div><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs sh">$ <span class="hljs-built_in">ln</span> -s OBS:2025010100 obs.2025010100<br><br>$ <span class="hljs-built_in">ls</span><br>msfc.tbl -&gt; /home/wpsze/WRF/WRFDA/WRFDA/var/obsproc/msfc.tbl<br>namelist.obsproc<br>OBS:2025010100<br>obs.2025010100 -&gt; OBS:2025010100<br>obserr.txt -&gt; /home/wpsze/WRF/WRFDA/WRFDA/var/obsproc/obserr.txt<br>obsproc.exe -&gt; /home/wpsze/WRF/WRFDA/WRFDA/var/obsproc/obsproc.exe*<br>obsproc.out<br>prepbufr.gdas.2025010100.nr<br>run.sh -&gt; ../../../run.sh*<br></code></pre></td></tr></table></figure><h2 id="obsproc_for_3dvar">OBSPROC_for_3DVAR</h2><ul><li><a href="https://www2.mmm.ucar.edu/wrf/users/docs/user_guide_v4/v4.4/users_guide_chap6.html#_OBSPROC_for_3DVAR" class="uri">https://www2.mmm.ucar.edu/wrf/users/docs/user_guide_v4/v4.4/users_guide_chap6.html#_OBSPROC_for_3DVAR</a></li></ul><p>OBSPROC requires at least 3 files to run successfully:</p><ul><li>A namelist file (<strong>namelist.obsproc</strong>)</li><li>An observation error file (<strong>obserr.txt</strong>)<ul><li>The files <code>obserr.txt</code> and <code>msfc.tbl</code> are included in the source code under <code>var/obsproc</code>.</li></ul></li><li><strong>One or more observation files</strong></li><li>Optionally, a table for specifying the elevation information for marine observations over the US Great Lakes (msfc.tbl)</li></ul><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-built_in">cd</span> WRFDA/var/obsproc<br><span class="hljs-built_in">cp</span> namelist.obsproc.3dvar.wrfvar-tut namelist.obsproc<br></code></pre></td></tr></table></figure><ul><li>Edit the namelist file, <strong>namelist.obsproc</strong>, to accommodate your experiments.</li></ul><p>If you are running the tutorial case, you should copy or <strong>link</strong> the sample observation file <strong>(ob/2008020512/obs.2008020512)</strong> to the <strong>obsproc</strong> directory. Alternatively, you can edit the namelist variable <code>obs_gts_filename</code> to <strong>point to the observation file’s full path</strong>.</p><p>To run <strong>OBSPROC</strong>, type</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">./obsproc.exe &gt;&amp; obsproc.out<br></code></pre></td></tr></table></figure><ul><li>Once <code>obsproc.exe</code> has completed successfully, you will see an observation data file, with the name formatted <code>obs_gts_YYYY-MM-DD_HH:NN:SS.3DVAR</code>, in the <code>obsproc</code> directory.</li><li><code>obs_gts_2025-01-01_00:00:00.3DVAR</code> is generated if sucessful</li><li><code>ln -s ob.ascii -&gt; obs_gts_2025-01-01_00:00:00.3DVAR</code></li></ul><p><img src="https://i.imgur.com/1TK81jI.png" width="500" /></p><h1 id="useful-.ncl">useful <code>.ncl</code></h1><ul><li>the scripts under <code>WRFDA/var/scripts</code></li></ul>]]></content>
    
    
    <categories>
      
      <category>WRF</category>
      
    </categories>
    
    
    <tags>
      
      <tag>NWP</tag>
      
      <tag>WRF</tag>
      
      <tag>MPAS</tag>
      
      <tag>DA</tag>
      
      <tag>WRFDA</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Relative Humidity and the Dewpoint Temperature</title>
    <link href="/2025/03/06/Relative-Humidity-and-the-Dewpoint-Temperature/"/>
    <url>/2025/03/06/Relative-Humidity-and-the-Dewpoint-Temperature/</url>
    
    <content type="html"><![CDATA[<p>Key words: Relative Humidity (rh), Dewpoint Temperature (dewpoint), Water Vapor Mixing Ratio (qv)</p><ul><li><a href="https://journals.ametsoc.org/view/journals/mwre/108/7/1520-0493_1980_108_1046_tcoept_2_0_co_2.xml">Bolton, D. (1980). The computation of equivalent potential temperature. Monthly weather review, 108(7), 1046-1053.</a></li><li><a href="https://journals.ametsoc.org/view/journals/bams/86/2/bams-86-2-225.xml">Lawrence, M. G. (2005). The relationship between relative humidity and the dewpoint temperature in moist air: A simple conversion and applications. Bulletin of the American Meteorological Society, 86(2), 225-234.</a><ul><li>How are the dewpoint temperature and relative humidity related, and is there an easy and sufficiently accurate way to convert between them without using a calculator?</li></ul></li></ul><h1 id="water-vapor">Water vapor</h1><p><strong>Water vapor is the gaseous state of water</strong> (<span class="math inline">\(\text{H}_2\text{O}\)</span>) existing below its boiling point, formed through vaporization or sublimation. It remains invisible unless water droplets are suspended within it (e.g., steam, fog). Its chemical formula is <span class="math inline">\(\text{H}_2\text{O}_{(g)}\)</span>, with molecules existing as dimers or trimers in the vapor phase.</p><h2 id="key-humidity-metrics">Key Humidity Metrics</h2><p><strong>1. Water Vapor Mixing Ratio</strong><br />- <strong>Definition</strong>: Mass of water vapor (<span class="math inline">\(m_v\)</span>) per unit mass of dry air (<span class="math inline">\(m_d\)</span>):<br /><span class="math display">\[  w = \frac{m_v}{m_d} \quad (\text{units: g/kg or kg/kg})  \]</span><br />- Differs from specific humidity by &lt;3% at typical atmospheric levels.<br />- Used in meteorological diagrams (e.g., skew-T) to analyze air parcels.</p><p><strong>2. Absolute Humidity</strong><br />- <strong>Definition</strong>: Mass of water vapor per unit volume of air:<br /><span class="math display">\[  \rho_v = \frac{m_v}{V} \quad (\text{units: g/m}^3\text{)}  \]</span><br />- Varies with temperature and pressure, making it less reliable for dynamic conditions.<br />- Maximum values near 30 g/m³ in saturated tropical air.</p><p><strong>3. Specific Humidity</strong><br />- <strong>Definition</strong>: Mass of water vapor (<span class="math inline">\(m_v\)</span>) per total mass of moist air (<span class="math inline">\(m_v + m_d\)</span>):<br /><span class="math display">\[  q = \frac{m_v}{m_v + m_d} \quad (\text{units: g/kg})  \]</span><br />- Remains constant during temperature/pressure changes unless moisture is added/removed.<br />- Key for tracking air masses due to its stability.</p><p><strong>4. Relative Humidity (RH)</strong><br />- <strong>Definition</strong>: Ratio of actual vapor pressure (<span class="math inline">\(e\)</span>) to saturation vapor pressure (<span class="math inline">\(e_s\)</span>) at air temperature:<br /><span class="math display">\[  \text{RH} = \frac{e}{e_s} \times 100\%   \]</span><br />- Temperature-dependent: Warm air can hold more moisture, lowering RH at constant <span class="math inline">\(e\)</span>.<br />- At 100% RH, dew forms via condensation.</p><h1 id="saturation-vapor-pressure-svp">Saturation vapor pressure (SVP)</h1><p>Saturation vapor pressure (SVP) is the equilibrium pressure exerted by water vapor in air that is fully saturated (unable to hold more moisture) at a given temperature. It is a critical parameter for understanding humidity, cloud formation, and weather processes. Below are the key concepts and formulas:</p><hr /><h2 id="key-equations"><strong>Key Equations</strong></h2><h3 id="clausius-clapeyron-equation-theoretical-basis">1. Clausius-Clapeyron Equation (Theoretical Basis)</h3><p>Describes the temperature dependence of SVP:<br /><span class="math display">\[\frac{d e_s}{d T} \approx \frac{L_v \cdot e_s}{\Re_v \cdot T^2}\]</span></p><ul><li><span class="math inline">\(e_s\)</span>: Saturation vapor pressure<br /></li><li><span class="math inline">\(L_v\)</span>: Latent heat of vaporization (<span class="math inline">\(2.5 \times 10^3 \, \text{J/g}\)</span> for water, <span class="math inline">\(2.824 \times 10^3 \, \text{J/g}\)</span> for ice)<br /></li><li><span class="math inline">\(\Re_v\)</span>: Gas constant for water vapor (<span class="math inline">\(461.5 \, \text{J/kg·K}\)</span>)<br /></li><li><span class="math inline">\(T\)</span>: Temperature (K)</li></ul><p>This differential equation shows SVP increases exponentially with temperature.</p><h3 id="arden-buck-equation-empirical">2. Arden Buck Equation (Empirical)</h3><p>Widely used in meteorology for calculating SVP over liquid water and ice:</p><p><strong>Over liquid water</strong> (<span class="math inline">\(T &gt; 0^\circ \text{C}\)</span>):<br /><span class="math display">\[e_s(T) = 6.1121 \exp\left(\left(18.678 - \frac{T}{234.5}\right) \cdot \frac{T}{257.14 + T}\right) \, \text{(hPa)}\]</span></p><p><strong>Over ice</strong> (<span class="math inline">\(T &lt; 0^\circ \text{C}\)</span>):<br /><span class="math display">\[e_s(T) = 6.1115 \exp\left(\left(23.036 - \frac{T}{333.7}\right) \cdot \frac{T}{279.82 + T}\right) \, \text{(hPa)}\]</span><br />- Valid for <span class="math inline">\(-80^\circ \text{C} &lt; T &lt; 50^\circ \text{C}\)</span> with errors &lt; 0.5%.</p><h3 id="simplified-magnus-formula">3. Simplified Magnus Formula</h3><p>For quick approximations over water (<span class="math inline">\(0^\circ \text{C} &lt; T &lt; 100^\circ \text{C}\)</span>):<br /><span class="math display">\[e_s(T) = 6.112 \exp\left(\frac{17.67 \cdot T}{T + 243.5}\right) \, \text{(hPa)}\]</span><br />- <span class="math inline">\(T\)</span> in <span class="math inline">\(^\circ \text{C}\)</span>.</p><h3 id="temperature-dependence"><strong>Temperature Dependence</strong></h3><p>SVP doubles approximately every <span class="math inline">\(10^\circ \text{C}\)</span> (or <span class="math inline">\(20^\circ \text{F}\)</span>) temperature increase. For example:<br />- At <span class="math inline">\(0^\circ \text{C}\)</span>: <span class="math inline">\(6.11 \, \text{hPa}\)</span><br />- At <span class="math inline">\(20^\circ \text{C}\)</span>: <span class="math inline">\(23.4 \, \text{hPa}\)</span><br />- At <span class="math inline">\(30^\circ \text{C}\)</span>: <span class="math inline">\(42.4 \, \text{hPa}\)</span>.</p><h3 id="applications"><strong>Applications</strong></h3><ol type="1"><li><p><strong>Relative Humidity (RH)</strong>:<br /><span class="math display">\[\text{RH} = \frac{\text{Actual Vapor Pressure}}{e_s(T)} \times 100\%\]</span><br />Indicates air’s moisture content relative to its capacity.</p></li><li><p><strong>Dewpoint</strong>: Temperature at which air becomes saturated (<span class="math inline">\(RH = 100\%\)</span>). Calculated iteratively using <span class="math inline">\(e = e_s(T_d)\)</span>.</p></li><li><p><strong>Weather Prediction</strong>: Used in thermodynamic diagrams (e.g., skew-T) to assess cloud formation and storm potential.</p></li></ol><h1 id="wrf">WRF</h1><ul><li><a href="https://forum.mmm.ucar.edu/threads/relative-humidity.9134/">relative humidity | 2020</a><ul><li>The Relative Humidity (RH) is simply the mixing ratio divided by the saturation mixing ratio. wrfout files include mixing ratio and T, from which you can easily obtain RH.</li><li>Here is a small piece of Fortran to calculate relative humidity from mixing ratio: <figure class="highlight fortran"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs fortran"><span class="hljs-keyword">real</span>, <span class="hljs-keyword">parameter</span> :: svp1=<span class="hljs-number">611.2</span><br><span class="hljs-keyword">real</span>, <span class="hljs-keyword">parameter</span> :: svp2=<span class="hljs-number">17.67</span><br><span class="hljs-keyword">real</span>, <span class="hljs-keyword">parameter</span> :: svp3=<span class="hljs-number">29.65</span><br><span class="hljs-keyword">real</span>, <span class="hljs-keyword">parameter</span> :: svpt0=<span class="hljs-number">273.15</span><br><span class="hljs-keyword">real</span>, <span class="hljs-keyword">parameter</span> :: eps = <span class="hljs-number">0.622</span><br>rh = <span class="hljs-number">1.E2</span> * (p*q/(q*(<span class="hljs-number">1.</span>-eps) + eps))/(svp1*<span class="hljs-built_in">exp</span>(svp2*(t-svpt0)/(T-svp3)))<br></code></pre></td></tr></table></figure></li><li>Note that <strong>t (temperature), p (pressure) and q (mixing ratio)</strong> are output variables in wrfout.</li></ul></li><li><a href="https://forum.mmm.ucar.edu/threads/how-to-derive-specific-humidity-from-wrf-output.16403/">How to derive Specific Humidity from WRF output ? | 2024</a><ul><li>You're right, that specific humidity is not a variable that is available to output with wrf. It looks like there is one (called QLEV_URB3D) if you happen to be using an urban parameterization scheme. Otherwise, you may have to calculate it during post-processing. I would recommend using either NCL or python to try to get the output you want.</li></ul></li></ul>]]></content>
    
    
    <categories>
      
      <category>Meteorology</category>
      
    </categories>
    
    
    <tags>
      
      <tag>NWP</tag>
      
      <tag>WRF</tag>
      
      <tag>MPAS</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>MPAS | WRF | GFS-Wave GRIB files</title>
    <link href="/2025/02/28/MPAS-WRF-GFS-Wave-GRIB-files/"/>
    <url>/2025/02/28/MPAS-WRF-GFS-Wave-GRIB-files/</url>
    
    <content type="html"><![CDATA[<ul><li>Read <a href="https://waipangsze.github.io/2025/02/19/MPAS-WRF-Extract-GFS-GRIB-files/"><strong>MPAS | WRF | Extract subset of GFS GRIB files</strong></a></li></ul><h1 id="gfs-wave-model-forecast">GFS Wave Model Forecast</h1><ul><li>These models are based on the <strong>3rd generation wave model WAVEWATCH III</strong> using operational NCEP products as input.</li><li><a href="https://polar.ncep.noaa.gov/waves/validation/">WAVEWATCH III® Production Multigrid: July 2013 to present</a><ul><li>The multigrid production uses the multi-grid spectral wave model WAVEWATCH III® with operational NCEP winds and ice fields as input forcing fields. No wave data assimilation is performed. The model is run four times a day, with all available data. Validation data is available from July 2013 through to the present.</li><li>Model output<ul><li>Field output in grib2 format, available every 3 hours<ul><li>.wind. = U-component of 10m wind, V-component of 10m wind (m/s)</li><li>.hs. = significant height of combined wind waves and swell (m)</li><li>.tp. = primary wave mean period (s)</li><li>.dp. = primary wave direction (degrees true, i.e. 0 deg =&gt; coming from North; 90 deg =&gt; coming from East)</li></ul></li></ul></li></ul></li></ul><h2 id="grib2-output-parameters">GRiB2 Output Parameters</h2><p>From <a href="https://polar.ncep.noaa.gov/waves/Model_Description.pdf" class="uri">https://polar.ncep.noaa.gov/waves/Model_Description.pdf</a>,</p><ul><li>Significant Height of Combined Wind Waves and Swell (HTSGW)</li><li>Direction of Combined Wind Waves and Swell (DIRPW)</li><li>Mean Period of Combined Wind Waves and Swell (PERPW)</li><li>Significant Height of Wind Waves (WVHGT)</li><li>Mean Period of Wind Waves (WVPER)</li><li>Direction of Wind Waves (WVDIR)</li><li>Significant wave height of first swell partition (SWELL: 1 in sequence)</li><li>Mean wave period of first swell partition (SWPER: 1 in sequence)</li><li>Mean wave direction of first swell partition (SWDIR: 1 in sequence)</li><li>Significant wave height of second swell partition (SWELL: 2 in sequence)</li><li>Mean wave period of second swell partition (SWPER: 2 in sequence)</li><li>Mean wave direction of second swell partition (SWDIR: 2 in sequence)</li><li>Significant wave height of third swell partition (SWELL: 3 in sequence)</li><li>Mean wave period of third swell partition (SWPER: 3 in sequence)</li><li>Mean wave direction of third swell partition (SWDIR: 3 in sequence)</li><li>Wind Speed (WIND)</li><li>Wind Direction (WDIR)</li><li>U-component of wind (UGRD)</li><li>V-component of wind (VGRD)</li></ul><p>The multi_1 deterministic wave model is now unified with the Global Forecast System (GFS). The WAVEWATCH III wave model is one-way coupled with the atmospheric forecast model. The wave model uses three native computational grids:</p><ul><li>Arctic Polar 9km resolution from 50N to 90N,</li><li>Global Core 10min resolution from 15S to 52N and</li><li>Southern Ocean 15min resolution from 10.5S to 79.5S.</li></ul><p>There are <strong>4 post-processed grids</strong>: <strong>West Coast, Eastern Pacific, Atlantic Ocean all with 0.16deg resolution</strong> and <strong>a Global grid with 0.25 deg of resolution</strong>.</p><ul><li><strong>The unification into GFS allows for an increase in frequency of the wind forcing from 3 hours to 30 minutes</strong>. In addition, <strong>ocean</strong> currents from the <code>RTOFS</code> model are included as input to the wave model. The system runs four cycles per day (00, 06, 12 and 18Z) and the wave forecast has been extended from 180 hours to 384 hours. The wave model produces <strong>hourly forecasts from 000 to 120 hours and every 3 hours from 120 to 384 hrs</strong>.</li></ul><h1 id="gfs-wave-subset-download">GFS-Wave subset download</h1><h2 id="nomads-data-at-ncep">NOMADS Data at NCEP</h2><ul><li><a href="https://nomads.ncep.noaa.gov/" class="uri">https://nomads.ncep.noaa.gov/</a></li><li><a href="https://nomads.ncep.noaa.gov/gribfilter.php?ds=gfswave" class="uri">https://nomads.ncep.noaa.gov/gribfilter.php?ds=gfswave</a></li><li>Example: <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs URL">https://nomads.ncep.noaa.gov/cgi-bin/filter_gfswave.pl?dir=%2Fgfs.20250228%2F00%2Fwave%2Fgridded&amp;file=gfswave.t00z.global.0p16.f048.grib2&amp;var_DIRPW=on&amp;var_HTSGW=on&amp;var_PERPW=on&amp;var_SWDIR=on&amp;var_SWELL=on&amp;var_SWPER=on&amp;var_UGRD=on&amp;var_VGRD=on&amp;var_WDIR=on&amp;var_WIND=on&amp;var_WVDIR=on&amp;var_WVHGT=on&amp;var_WVPER=on&amp;lev_1_in_sequence=on&amp;lev_2_in_sequence=on&amp;lev_3_in_sequence=on&amp;lev_surface=on<br></code></pre></td></tr></table></figure></li><li>Dowload script:     <div class="fold">      <div class="fold-title fold-info collapsed" data-toggle="collapse" href="#collapse-dcdac752" role="button" aria-expanded="false" aria-controls="collapse-dcdac752">        <div class="fold-arrow">▶</div>download_gfs_wave.sh      </div>      <div class="fold-collapse collapse" id="collapse-dcdac752">        <div class="fold-content">          <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-meta">#!/bin/bash</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment"># define URL</span><br><span class="hljs-comment">#</span><br>workdir=/home/wpsze/mpas/GFS/GFS_Wave/<br>hr=00<br><span class="hljs-comment">#date_st=20240920</span><br>date_st=$(<span class="hljs-built_in">date</span> -d <span class="hljs-string">&quot;today -1 days&quot;</span> +%Y%m%d)<br><br><span class="hljs-comment">#wget </span><br><br><span class="hljs-keyword">for</span> iday <span class="hljs-keyword">in</span> &#123;0..0..1&#125;; <span class="hljs-keyword">do</span><br>    <br>    idate=$(<span class="hljs-built_in">date</span> -d <span class="hljs-string">&quot;<span class="hljs-variable">$date_st</span> + <span class="hljs-variable">$iday</span> days&quot;</span> +%Y%m%d)<br>    <span class="hljs-built_in">echo</span> <span class="hljs-variable">$date_st</span> <span class="hljs-variable">$idate</span><br><span class="hljs-keyword">for</span> fhr <span class="hljs-keyword">in</span> &#123;000..120..1&#125;; <span class="hljs-keyword">do</span><br><span class="hljs-comment">#for fhr in &#123;076..76..1&#125;; do</span><br><br><br>URL=<span class="hljs-string">&quot;https://nomads.ncep.noaa.gov/cgi-bin/filter_gfswave.pl?\</span><br><span class="hljs-string">dir=%2Fgfs.<span class="hljs-variable">$&#123;idate&#125;</span>%2F<span class="hljs-variable">$&#123;hr&#125;</span>%2Fwave%2Fgridded&amp;\</span><br><span class="hljs-string">file=gfswave.t<span class="hljs-variable">$&#123;hr&#125;</span>z.global.0p16.f<span class="hljs-variable">$&#123;fhr&#125;</span>.grib2\</span><br><span class="hljs-string">&amp;var_DIRPW=on&amp;var_HTSGW=on&amp;var_PERPW=on&amp;var_SWDIR=on&amp;\</span><br><span class="hljs-string">var_SWELL=on&amp;var_SWPER=on&amp;var_UGRD=on&amp;var_VGRD=on&amp;\</span><br><span class="hljs-string">var_WDIR=on&amp;var_WIND=on&amp;var_WVDIR=on&amp;var_WVHGT=on&amp;\</span><br><span class="hljs-string">var_WVPER=on&amp;lev_1_in_sequence=on&amp;lev_2_in_sequence=on\</span><br><span class="hljs-string">&amp;lev_3_in_sequence=on&amp;lev_surface=on&quot;</span><br><br>yyyymm=<span class="hljs-variable">$&#123;idate:0:6&#125;</span><br>datapath=<span class="hljs-variable">$workdir</span>/0p25/<span class="hljs-variable">$yyyymm</span>/<span class="hljs-variable">$idate</span>/<br><span class="hljs-built_in">mkdir</span> -p <span class="hljs-variable">$datapath</span><br><br><span class="hljs-comment"># download file</span><br><span class="hljs-comment">#curl &quot;$URL&quot; -o download_test$fhr.grb</span><br>wget <span class="hljs-string">&quot;<span class="hljs-variable">$URL</span>&quot;</span> -O <span class="hljs-variable">$datapath</span>/gfs.t<span class="hljs-variable">$&#123;hr&#125;</span>z.global.0p16.f<span class="hljs-variable">$&#123;fhr&#125;</span>.grib2<br><span class="hljs-comment"># add a sleep to prevent a denial of service in case of missing file</span><br><span class="hljs-built_in">sleep</span> 3<br><span class="hljs-keyword">done</span><br><span class="hljs-keyword">done</span><br></code></pre></td></tr></table></figure>        </div>      </div>    </div></li></ul><figure><img src="https://i.imgur.com/dBuFGe4.png" alt="https://nomads.ncep.noaa.gov/gribfilter.php?ds=gfswave" width="600" /><figcaption>https://nomads.ncep.noaa.gov/gribfilter.php?ds=gfswave</figcaption></figure><h1 id="grib-checking">grib checking</h1><ul><li><code>grib_ls gfs.t00z.global.0p16.f000.grib2</code>     <div class="fold">      <div class="fold-title fold-info collapsed" data-toggle="collapse" href="#collapse-6ae3e036" role="button" aria-expanded="false" aria-controls="collapse-6ae3e036">        <div class="fold-arrow">▶</div>gfs.t00z.global.0p16.f000.grib2      </div>      <div class="fold-collapse collapse" id="collapse-6ae3e036">        <div class="fold-content">          <figure class="highlight console"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs console">gfs.t00z.global.0p16.f000.grib2<br>edition      centre       date         dataType     gridType     stepRange    typeOfLevel  level        shortName    packingType  <br>2            kwbc         20250227     fc           regular_ll   0            surface      1            ws           grid_jpeg   <br>2            kwbc         20250227     fc           regular_ll   0            surface      1            wdir         grid_jpeg   <br>2            kwbc         20250227     fc           regular_ll   0            surface      1            u            grid_jpeg   <br>2            kwbc         20250227     fc           regular_ll   0            surface      1            v            grid_jpeg   <br>2            kwbc         20250227     fc           regular_ll   0            surface      1            swh          grid_jpeg   <br>2            kwbc         20250227     fc           regular_ll   0            surface      1            perpw        grid_jpeg   <br>2            kwbc         20250227     fc           regular_ll   0            surface      1            dirpw        grid_jpeg   <br>2            kwbc         20250227     fc           regular_ll   0            surface      1            shww         grid_jpeg   <br>2            kwbc         20250227     fc           regular_ll   0            orderedSequenceData  1            swell        grid_jpeg   <br>2            kwbc         20250227     fc           regular_ll   0            orderedSequenceData  2            swell        grid_jpeg   <br>2            kwbc         20250227     fc           regular_ll   0            orderedSequenceData  3            swell        grid_jpeg   <br>2            kwbc         20250227     fc           regular_ll   0            surface      1            mpww         grid_jpeg   <br>2            kwbc         20250227     fc           regular_ll   0            orderedSequenceData  1            swper        grid_jpeg   <br>2            kwbc         20250227     fc           regular_ll   0            orderedSequenceData  2            swper        grid_jpeg   <br>2            kwbc         20250227     fc           regular_ll   0            orderedSequenceData  3            swper        grid_jpeg   <br>2            kwbc         20250227     fc           regular_ll   0            surface      1            wvdir        grid_jpeg   <br>2            kwbc         20250227     fc           regular_ll   0            orderedSequenceData  1            swdir        grid_jpeg   <br>2            kwbc         20250227     fc           regular_ll   0            orderedSequenceData  2            swdir        grid_jpeg   <br>2            kwbc         20250227     fc           regular_ll   0            orderedSequenceData  3            swdir        grid_jpeg   <br>19 of 19 messages in gfs.t00z.global.0p16.f000.grib2<br><br>19 of 19 total messages in 1 files<br></code></pre></td></tr></table></figure>        </div>      </div>    </div></li><li>re-download dataset that only contains surface variables.</li><li><code>grib_to_netcdf gfs.t00z.global.0p16.f000.grib2 -o test.nc</code></li><li><code>ncvis/ncview test.nc</code></li></ul><div class="group-image-container"><div class="group-image-row"><div class="group-image-wrap"><img src="https://i.imgur.com/lflKrCy.png" /></div><div class="group-image-wrap"><img src="https://i.imgur.com/PBF8xwC.png" /></div></div></div><div class="group-image-container"><div class="group-image-row"><div class="group-image-wrap"><img src="https://i.imgur.com/qQ6P9fx.png" /></div><div class="group-image-wrap"><img src="https://i.imgur.com/HKGKoVg.png" /></div><div class="group-image-wrap"><img src="https://i.imgur.com/5svtQWO.png" /></div><div class="group-image-wrap"><img src="https://i.imgur.com/1YftA55.png" /></div></div><div class="group-image-row"><div class="group-image-wrap"><img src="https://i.imgur.com/s7kzxk9.png" /></div><div class="group-image-wrap"><img src="https://i.imgur.com/qvL4hpP.png" /></div><div class="group-image-wrap"><img src="https://i.imgur.com/Y0gEygu.png" /></div></div></div><h1 id="reading">Reading</h1><ul><li><a href="https://www.hko.gov.hk/hko/publica/reprint/r136.pdf">兩個海波數值模式的比較 | HKO</a></li><li><a href="https://photino.cwa.gov.tw/rdcweb/lib/cd/cd01conf/dissertation/1994%20Sea/11.pdf">WAM 模式之評介 | 交通部中央氣象署</a></li><li><a href="https://www.comc.ncku.edu.tw/wordpress/wp-content/uploads/2023/02/100%E5%B9%B4%E5%BA%A6-%E5%8F%B0%E7%81%A3%E6%B5%B7%E5%9F%9F%E4%BD%9C%E6%A5%AD%E5%8C%96WAVEWATCH-III%E6%B9%A7%E6%B5%AA%E6%95%B8%E5%80%BC%E9%A0%90%E5%A0%B1%E5%BB%BA%E7%BD%AE.pdf">台灣海域作業化 WAVEWATCH III 湧浪數值預報建置 | 2011</a><ul><li><img src="https://i.imgur.com/esFWqXd.png" width="500" /></li></ul></li></ul><h1 id="literature-review">Literature review</h1><ul><li><a href="https://journals.ametsoc.org/downloadpdf/view/journals/phoc/49/2/jpo-d-18-0137.1.pdf">Liu, Qingxiang, et al. "Observation-based source terms in the third-generation wave model WAVEWATCH III: Updates and verification." Journal of Physical Oceanography 49.2 (2019): 489-517.</a></li><li><a href="https://html.rhhz.net/ZGHYDXXBZRKXB/html/a972b1fe-e8d2-4f30-aa37-0d825e44073e.htm">曹赛超, 高志一, 赵栋梁. WAVEWATCH Ⅲ第三代海浪数值模式在中国东海的应用和改进[J]. 中国海洋大学学报(自然科学版), 2023, 53(8): 8-15.</a></li><li><a href="https://www.airitilibrary.com/Article/Detail/P20231229001-N202411060008-00006">林幼淳、林鼎傑、許泰文（2024）。以數值模式為基礎探討颱風季的波浪潛能。海岸及海洋工程學刊，20(1&amp;2)，75-84。https://doi.org/10.6266/JOCOE.202411_20(1_2).0006</a></li><li><a href="https://www.comc.ncku.edu.tw/wordpress/wp-content/uploads/2023/02/106%E5%B9%B4%E5%BA%A6-WAVEWATCH-III-%E5%A4%9A%E9%87%8D%E7%B6%B2%E6%A0%BC%E6%A8%A1%E5%BC%8F%E6%87%89%E7%94%A8%E6%96%BC%E9%A2%B1%E9%A2%A8%E6%B3%A2%E6%B5%AA%E6%8E%A8%E7%AE%97%E4%B9%8B%E7%A0%94%E7%A9%B6.pdf">WAVEWATCH III 多重網格模式應用於颱風波浪推算之研究 | 2017</a></li></ul>]]></content>
    
    
    <categories>
      
      <category>MPAS</category>
      
    </categories>
    
    
    <tags>
      
      <tag>NWP</tag>
      
      <tag>WRF</tag>
      
      <tag>MPAS</tag>
      
      <tag>ERA5</tag>
      
      <tag>GFS</tag>
      
      <tag>Wave</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>MPAS | MPAS-CMAQ | US EPA</title>
    <link href="/2025/02/27/MPAS-MPAS-CMAQ-US-EPA/"/>
    <url>/2025/02/27/MPAS-MPAS-CMAQ-US-EPA/</url>
    
    <content type="html"><![CDATA[<h1 id="mpas-cmaq">MPAS-CMAQ</h1><ul><li><a href="https://www.epa.gov/cmaq/next-generation-air-quality-model">The Next-Generation Air Quality Model | US-EPA | Motivation for Improving Combined Meteorological and Air Quality Models</a><ul><li>New meteorological models have been developed that include seamless mesh refinement from global to local scales. These are the future of multi-scale global air quality models. Such mesh structures are ideal for air quality modeling since they cover the entire globe with a coarse mesh, but can resolve areas of interest like the United States with a much finer mesh.</li></ul></li><li><a href="https://www.epa.gov/cmaq">CMAQ: The Community Multiscale Air Quality Modeling System | US-EPA</a></li><li><a href="https://www2.mmm.ucar.edu/wrf/users/workshops/WS2024/presentations/day1/7_Willison.pdf">The 2024 Release of MPAS-CMAQ</a><ul><li>MPAS-CMAQ Design<ul><li>Unified coupler approach allows for coupling of CMAQ with either WRF or MPAS</li><li>New Model I/O (MIO)</li><li>CMAQ is treated as a column model when coupled with MPAS; horizontal transport handled in MPAS.</li></ul></li><li>MPAS Updates<ul><li>Added US EPA physics routines to MPAS</li><li>Implemented analysis FDDA as in WRF</li><li>Implemented indirect soil moisture data assimilation in PX LSM</li><li>Meteorological Evaluation</li></ul></li></ul></li><li><a href="https://forum.cmascenter.org/c/mpas-cmaq/99">CMAS Forum | MPAS-CMAQ</a></li><li><a href="https://github.com/USEPA/CMAQ/tree/MPAS_CMAQ">MPAS-CMAQ github</a><ul><li><a href="https://github.com/USEPA/CMAQ/blob/MPAS_CMAQ/DOCS/Users_Guide/PDF/MPAS_CMAQ_guide.pdf">MPAS_CMAQ_guide.pdf</a></li><li>The coupled system has been evaluated for global domains across several years (Wong et al. 2024, preprint: <a href="https://gmd.copernicus.org/preprints/gmd-2024-52/gmd-2024-52.pdf" class="uri">https://gmd.copernicus.org/preprints/gmd-2024-52/gmd-2024-52.pdf</a>).</li><li>Unified Coupler<ul><li>In this work, we adopted a simpler approach tailored for our specific application. For both the WRF-CMAQ and the MPASCMAQ coupled models, <strong>CMAQ inherits the domain structure from either WRF or MPAS</strong>, and therefore, the coupler inherits the map projection, grid alignment, and grid spacing seamlessly. For simplicity, we just need a straightforward mechanism for data exchange between the two model.</li></ul></li><li><strong>Meteorological data is made available to drive the CMAQ model, and subsequently aerosol information is passed back to the meteorological model so that it can affect the radiation calculations (aerosol radiative direct effect).</strong></li><li>The unified coupler design addresses two major characteristic differences among the WRF-CMAQ and MPAS-CMAQ coupled models.<ul><li>Firstly, the WRF model decomposes the horizonal domain with rectangular grids and stores information using a 2-D data structure. In contrast, the MPAS model decomposes the horizonal domain with an unstructured mesh and stores information using a 1-D data structure.</li><li>Secondly, in the WRF-CMAQ coupled model, the WRF time step could be sub-divided by the advection time step algorithm on the CMAQ side. In addition, two time steps of meteorological data are required and stored in a circular buffer to support interpolation. With the MPAS-CMAQ coupled model, the transport is handled in MPAS and the time step in CMAQ is fully synchronized with MPAS.</li></ul></li><li>The preliminary results show the MPAS-CMAQ coupled model performed reasonably well with respect to ozone and PM2.5 for North America, where the fine mesh is located, as well as the rest of the world. For future work, we will implement the aerosol radiative direct effect in this coupled model with a robust and flexible method to handle different CMAQ chemical mechanisms. We will also implement a switch so the aerosol radiative direct effect can be turned on or off at run time.</li><li>Code and data availability<ul><li>Entire MPAS-CMAQ with internal version CMAQ 5.4 is available at Zenodo (10.5281/zenodo.10982420).</li><li>MIO is available at Zenodo (10.5281/zenodo.10994279).</li><li><strong>data which was used in generating Figure 4 - 9, is available at Zenodo (10.5281/zenodo.10994244).</strong></li><li><code>$ ncdump -h mpas_July_avg.nc |head -n 40</code>     <div class="fold">      <div class="fold-title fold-info collapsed" data-toggle="collapse" href="#collapse-8f7bdefe" role="button" aria-expanded="false" aria-controls="collapse-8f7bdefe">        <div class="fold-arrow">▶</div>mpas_July_avg.nc      </div>      <div class="fold-collapse collapse" id="collapse-8f7bdefe">        <div class="fold-content">          <figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs dts">netcdf <span class="hljs-title class_">mpas_July_avg</span> <span class="hljs-punctuation">&#123;</span><br><span class="hljs-symbol">dimensions:</span><br>  T<span class="hljs-attr">ime</span> <span class="hljs-operator">=</span> UNLIMITED <span class="hljs-punctuation">;</span> <span class="hljs-comment">// (1 currently)</span><br>  nC<span class="hljs-attr">ells</span> <span class="hljs-operator">=</span> <span class="hljs-number">40962</span> <span class="hljs-punctuation">;</span><br>  nVertL<span class="hljs-attr">evels</span> <span class="hljs-operator">=</span> <span class="hljs-number">50</span> <span class="hljs-punctuation">;</span><br>  nV<span class="hljs-attr">ertices</span> <span class="hljs-operator">=</span> <span class="hljs-number">81920</span> <span class="hljs-punctuation">;</span><br>  maxE<span class="hljs-attr">dges</span> <span class="hljs-operator">=</span> <span class="hljs-number">10</span> <span class="hljs-punctuation">;</span><br>  StrL<span class="hljs-attr">en</span> <span class="hljs-operator">=</span> <span class="hljs-number">64</span> <span class="hljs-punctuation">;</span><br>  nVertLevelsP1 = <span class="hljs-number">51</span> <span class="hljs-punctuation">;</span><br><span class="hljs-symbol">variables:</span><br>  float O3(Time, nCells, nVertLevels) <span class="hljs-punctuation">;</span><br><span class="hljs-symbol">    O3:</span>long_<span class="hljs-attr">name</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;O3 concentration&quot;</span> <span class="hljs-punctuation">;</span><br><span class="hljs-symbol">    O3:</span><span class="hljs-attr">units</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;ppmV&quot;</span> <span class="hljs-punctuation">;</span><br><span class="hljs-symbol">    O3:</span>cell_<span class="hljs-attr">methods</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;Time: mean&quot;</span> <span class="hljs-punctuation">;</span><br>  float hpbl(Time, nCells) <span class="hljs-punctuation">;</span><br><span class="hljs-symbol">    hpbl:</span><span class="hljs-attr">units</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;m&quot;</span> <span class="hljs-punctuation">;</span><br><span class="hljs-symbol">    hpbl:</span>long_<span class="hljs-attr">name</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;Planetary Boundary Layer (PBL) height&quot;</span> <span class="hljs-punctuation">;</span><br><span class="hljs-symbol">    hpbl:</span>cell_<span class="hljs-attr">methods</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;Time: mean&quot;</span> <span class="hljs-punctuation">;</span><br></code></pre></td></tr></table></figure>        </div>      </div>    </div></li><li><div class="group-image-container"><div class="group-image-row"><div class="group-image-wrap"><img src="https://i.imgur.com/SpkDS9P.png" /></div><div class="group-image-wrap"><img src="https://i.imgur.com/NhUWaaO.png" /></div></div><div class="group-image-row"><div class="group-image-wrap"><img src="https://i.imgur.com/6Spm7oN.png" /></div><div class="group-image-wrap"><img src="https://i.imgur.com/90b9mzX.png" /></div></div></div></li></ul></li></ul></li><li><a href="https://ral.ucar.edu/sites/default/files/docs//jon-willisonetalams2023mpasams.pdf">Recent advancement of EPA’s global air quality modeling system: MPAS-CMAQ | 2023 | US-EPA</a><ul><li><div class="group-image-container"><div class="group-image-row"><div class="group-image-wrap"><img src="https://i.imgur.com/s85kXsR.png" /></div><div class="group-image-wrap"><img src="https://i.imgur.com/bMwDQDX.png" /></div></div><div class="group-image-row"><div class="group-image-wrap"><img src="https://i.imgur.com/stNlI2P.png" /></div><div class="group-image-wrap"><img src="https://i.imgur.com/hFDPHpm.png" /></div></div></div></li></ul></li></ul><h1 id="mpas-cmaq-compilation">MPAS-CMAQ compilation</h1><ul><li><a href="https://forum.mmm.ucar.edu/threads/encounter-an-error-during-mpas-compilation.20474/">Encounter an error during MPAS compilation | Lan 2025</a></li></ul><p>vim bldit_project.csh set CMAQ_HOME =/home/wpsze/CMAQ/CMAQ-MPAS_CMAQ/CMAQ_5.5 ##改成自己的路径</p><p>./bldit_project.csh intel cd /home/wpsze/CMAQ/CMAQ-MPAS_CMAQ/CMAQ_5.5</p><p>vim config_cmaq.csh</p><h1 id="cmaq">CMAQ</h1><p>CMAQ（Community Multiscale Air Quality 通用多尺度空氣品質）模型，是美國環保署開發的第三代空氣品質預報和評估系統（Models-3）的核心組成之一。是一套<strong>三維歐拉網格化的大氣化學和傳輸模擬系統</strong>，能夠模擬整個對流層的臭氧、酸沉降、能見度和細顆粒物。<strong>整個模式遵循「一個大氣」概念，可以同時處理從局部到半球的不同空間尺度的多個複雜的空氣品質問題</strong>，作為一個有效的第三代空氣品質模型與評估工具，其能夠支持從策略分析到大氣科學研究的各類空氣品質模擬應用。</p><ul><li><strong>三維歐拉網格化的大氣化學和傳輸模擬系統</strong>，其根據來自WRF的氣象資訊及場域內的污染排放清單，基於物理和化學反應原理模擬污染物等的變化過程，繼而得到具體時間點或時間段的預報結果</li><li>模式可預報多種污染物，其種類可達80多種。</li><li>CMAQ可模擬的空間尺度以及時間尺度都跨越了數個數量級。對模式選擇不同的時間尺度，既可用於評估長時間（每年至數年）的污染大氣學，也可用於模擬短時間內（數週至數月）的污染源擴散情況，選擇不同的空間尺度，可用於城市或特定區域的模擬。 CMAQ也具有在不同尺度下同時處理多種污染的能力。</li><li>CMAQ包含了以下的處理和化學傳遞模組：<ul><li>大氣-化學交接處理模組（MCIP）</li><li>JPROC</li><li>初始條件模組（ICON）/ 邊界模組 (BCON)<ul><li>ICON則是一開始整體領域空間的污染物初始濃度的建置</li><li>BCON則是從邊界傳輸到模擬領域的污染物濃度</li><li>BCON 與 ICON 均有兩種情境，分別是固定排放與變動排放</li></ul></li><li>化學傳輸模組（CCTM, CMAQ Chemistry-Transport Model）</li><li>排放量資料(smoke)</li></ul></li><li>CMAQ 主程式所需要的輸入資料，主要有如下幾個必須要事先準備的輸入資料：<ul><li>來自WRF大氣模式的MCIP輸出</li><li>參考MCIP大氣資料而計算的SMOKE排放量處理模組</li><li>來自最外層固定的、或上一層執行後所產生的初始資料與邊界資料</li></ul></li><li>每個排放資料均為單一的化學物質，例如平均濃度小時值的輸出檔當中，懸浮微粒相關的物種濃度有ASO4I, ASO4J, ANH4I, ANH4J, ANO3I, ANO3J, AECI, AECJ, AOTHRI, AOTHRJ…，此類物種需要與兩種懸浮微粒波峰比例進行加總之後，方可得到PM2.5與PM10的濃度值。因此，CMAQ之CCTM模式執行完畢後，尚須使用 combine模組進行污染物整合。</li></ul><p><img src="https://i.imgur.com/EKYGIut.jpeg" alt="The framework for the WRF-SMOKE-CMAQ modeling system. From Yang, Xiaochun, et al. &quot;New method for evaluating winter air quality: PM2. 5 assessment using Community Multi-Scale Air Quality Modeling (CMAQ) in Xi&#39;an.&quot; Atmospheric Environment 211 (2019): 18-28." width="500" /> <img src="https://i.imgur.com/BQmCiOd.png" width="500" /> <img src="https://i.imgur.com/g3DB0G8.png" width="500" /> <img src="https://i.imgur.com/aK64IsW.png" width="500" /></p><h1 id="空氣品質模式簡介">空氣品質模式簡介</h1><ul><li><a href="https://linux.vbird.org/enve/illustration.php#">空氣品質模式簡介與操作 - 概說</a><ul><li>空氣污染物</li><li>排放量分析</li><li>空氣品質的定義</li><li>擴散模式 - 非化學反應</li><li>軌跡模式 - 非化學反應</li><li>箱模式 - 簡單化學模式</li><li>網格模式 - 複雜化學模式</li></ul></li></ul><h1 id="臭氧">臭氧</h1><p>臭氧的生成過程複雜，主要是由工廠、汽機車等所排放的廢氣之中含有具<strong>揮發性的有機物 (VOCs, 揮發性有機化合物是指含碳的任何揮發性化合物)</strong>、<strong>氮氧化物 (NOx)</strong> 等前驅物，在太陽光的照射下產生明顯的日變化，因此當有足夠的累積條件及陽光強度時，就會生成高濃度的臭氧。臭氧是最難控制的污染物之一，因為它不是人類活動直接排放的。取而代之的是，從車輛，發電廠，垃圾堆填區以及其他生物質和化石燃料燃燒設施中釋放出的危險化合物和一氧化二氮與陽光發生反應，形成這種二次污染物。根據香港環境保護署2019年的空氣質量監測結果，儘管政府努力減排和改善空氣質素，令整體空氣質量和其他主要污染物的水平在穩步改善，但過去20年來平均臭氧水平一直在上升，沒有下降的跡象。</p><ul><li><a href="https://www.legco.gov.hk/yr2022/chinese/panels/ea/papers/ea20220523cb1-271-2-c.pdf">區域性臭氧</a><ul><li>臭氧是一個複雜的區域性空氣污染問題。臭氧並非從污染源直接排出，<strong>而是經不同的空氣中的氮氧化物和揮發性有機化合物（ VOCs）在陽光下經光化學反應形成</strong>。鄰近區域形成的臭氧，亦可以隨著風向傳輸到本地。因此，<strong>減少臭氧是一個區域性問題，需要整個較廣區域的共同合作和努力</strong>。</li><li>另一方面，大氣中的臭氧會與其他氣體產生化學反應而被消耗，令臭氧水平下降，當中包括車輛排放的一氧化氮。然而，<strong>近年本地車輛排放的一氧化氮逐步減少，同時亦減少一氧化氮與臭氧的化學反應</strong>。如同不少主要國際城市的經驗，<strong>這是整體改善空氣質素過程中可預見會間接導致路邊及市區臭氧濃度上升的過渡情況</strong>。</li><li>根據一些歐美地區的空氣污染管制經驗，減少從光化學反應所. <strong>形成的臭氧常出現上述滯後現象</strong>。所以，與不少主要國際城市處理臭氧問題一樣，<strong>香港的臭氧水平相信會先略為增加，到達峰頂後才開始下降</strong>。然而，<strong>持續減少臭氧前驅物（即氮氧化物和 VOCs）的排放長遠可改善臭氧的水平。</strong></li></ul></li><li><a href="https://www.info.gov.hk/gia/general/202001/20/P2020012000747.htm">環保署公布二○一九年香港空氣質素監測結果</a><ul><li>臭氧是複雜的空氣污染問題，亦是區域性問題。它不是從污染源直接排出，而是由空氣中的氮氧化物（NOx）及揮發性有機化合物（VOCs）在陽光下經光化學反應形成。近年本港臭氧濃度上升，除了因區域背景臭氧水平偏高外，本地車輛減少氮氧化物的排放，亦會間接導致路邊及市區的平均臭氧水平上升（<strong>主要是因為少了一氧化氮與臭氧作化學反應，因而減少臭氧的消耗，令較多臭氧存在空氣中</strong>）。</li><li>歐美其他地區改善空氣污染的經驗也常有臭氧問題滯後的現象，因為複雜的光化學原因，煙霧問題和氮氧化物改善的初期常會突出臭氧問題，<strong>當減排工作再持續一段時間後，臭氧濃度才開始下降</strong>。</li></ul></li><li><a href="https://www.info.gov.hk/gia/general/201901/30/P2019013000777p.htm">立法會二十二題：空氣中臭氧濃度 | 2019</a><ul><li>臭氧是一個複雜的區域性空氣污染問題。臭氧並非從污染源直接排出，而是經不同的空氣污染物在大氣中的化學反應所產生。<strong>臭氧主要是氮氧化物（包括一氧化氮和二氧化氮及揮發性有機化合物在陽光下經光化學反應而形成</strong>；而另一方面，<strong>一氧化氮亦會與臭氧產生化學反應而把臭氧消耗及轉化成二氧化氮</strong>。近年本地推行的車輛減排措施有效減少車輛氮氧化物（主要為一氧化氮，亦有二氧化氮） 的排放，但亦因此減少市區及路邊臭氧的消耗，導致臭氧有所上升，情況亦與很多其他城市在處理空氣污染物的經驗相似。要持續降低本港的臭氧濃度，整個區域包括香港必須共同持續減少氮氧化物及揮發性有機化合物的排放。</li><li>至於針對臭氧的政策，政府正雙管齊下，一方面致力<strong>減少本地形成臭氧的前驅污染物（即氮氧化物和揮發性有機化合物）</strong>；另一方面則<strong>加強區域性合作</strong>。</li></ul></li><li><a href="https://www.aqhi.gov.hk/common/api_history/tc_chi/report/files/AQR2022c_final.pdf">2022 年 香港空氣質素</a><ul><li>臭氧是光化學煙霧的主要成分。臭氧並非從污染源直接排出，而是由氮氧化物及揮發性有機化合物（VOCs）在陽光下經光化學反應形成。由於光化學反應需要幾個小時才能完成，所以某地方錄得的臭氧可能源自遠處排放的氮氧化物及揮發性有機化合物。因此，<strong>臭氧主要是區域性的空氣污染問題</strong>。</li><li><strong>臭氧是強烈的氧化劑，即使低濃度的臭氧也能刺激眼睛、鼻和咽喉。高水平臭氧更可增加人體感染呼吸系統疾病的機會，亦可令哮喘病等呼吸系統疾病患者的病情惡化</strong>。</li><li>在香港，高臭氧空氣污染日子多數於粵港澳大灣區（大灣區）天氣炎熱、晴朗和無風時出現，這種天氣有利於臭氧經光化學反應而形成和積聚。這類天氣情況多出現於夏秋兩季，特別是當有熱帶氣旋在台灣或菲律賓附近時，外圍下沉氣流會影響香港和大灣區。</li><li>臭氧是複雜的區域性空氣污染問題。臭氧由氮氧化物和揮發性有機化合物等前驅物在陽光下進行複雜光化學反應形成，可以遠距離傳輸並影響下風區域。<strong>另一方面，臭氧可與某些污染物（例如車輛等燃燒源排放的一氧化氮）發生化學反應並被消耗</strong>。因此，在某一地方錄得的臭氧濃度受區域臭氧背景水平、在該地方產生的臭氧及其消耗情況影響。</li><li><strong>車輛排放的一氧化氮會與臭氧產生化學反應並消耗臭氧，因此交通繁忙地區的臭氧水平通常較車流量低的地區低</strong>。</li><li>自2000年代初開始，郊區的臭氧水平呈溫和上升趨勢，新市鎮和市區的上升趨勢則較為明顯。<strong>本港（特別是新市鎮和市區）的臭氧水平上升趨勢主要是由背景區域臭氧的溫和增加及本地車輛排放減少導致，後者令大氣中的一氧化氮減少，因此減少通過化學反應而消耗臭氧</strong>。</li></ul></li><li><a href="https://www.info.gov.hk/gia/general/202005/20/P2020052000477.htm">立法會十三題：空氣中的臭氧濃度 | 2020</a><ul><li><strong>臭氧會與空氣中的一些污染物（例如一氧化氮（NO））產生化學反應而被消耗</strong>。<strong>本港臭氧濃度上升幅度遠較背景水平大的主因是本地車輛減少了NOx排放，導致少了NO與臭氧反應，因而減少臭氧的消耗，令更多臭氧存在空氣中，做成量度到的臭氧濃度有較大升幅</strong>。但因為NOx及VOCs是臭氧的前驅污染物，持續減少NOx排放不但能令本港的二氧化氮水平降低，長遠更將會有助降低區域內及本港整體的臭氧濃度及超標情況。</li></ul></li><li><a href="https://sthj.sh.gov.cn/hbzhywpt6040/hbzhywpt6066/20220727/3c05ccec7b334fb1b6302c0f11b9efed.html">大气中臭氧的产生、耗损与健康危害 | 2022</a><ul><li>氮氧化物（NOx=NO+NO2）是形成臭氧的主要前驅污染物之一，而臭氧與NOx有快速的光化學循環過程，是對流層臭氧產生和耗損的主要驅動力。 NO2在紫外光照射下發生光解產生NO和基態氧原子O(3P)，氧原子與空氣中的氧氣反應生成臭氧；<strong>而NO可以透過與臭氧發生還原反應生成NO2和O2來消耗臭氧</strong>。上述反應為快速循環過程，反應平衡主要依賴UV強度和NOx濃度。</li><li>揮發性有機化合物（VOCs）也是形成臭氧的主要前驅污染物之一，因為VOCs氧化過程中形成的大氣烷基過氧自由基（RO2）或過氧羥基自由基（HO2）是將NO氧化為NO2的氧化劑。 VOCs的自由基氧化鏈是由與羥基自由基（OH）的反應引發的，水蒸氣存在下紫外線對臭氧的光解是對流層中OH的主要來源。在污染地區，醛類（如HCHO）、亞硝酸（HONO）和過氧化氫（H2O2）的光解也可能是OH或HO2自由基的重要來源。上述過程也伴隨著OH和NO2反應生成硝酸（HN臭氧），以及過氧基之間相互反應生成過氧化氫，這些反應都會逐步減少生成臭氧過程中催化劑的數量。大氣中VOCs包括生物來源和人為來源，對臭氧光化學形成有重要作用的VOCs類別有烷烴、烯烴、芳香烴、羰基化合物（如醛和酮）、醇、有機過氧化物和鹵化有機化合物（如鹵代烷）。</li><li>雖然臭氧的光化學生成受到前驅物的濃度限制，但<strong>臭氧與NOx、VOCs 間不是簡單的線性依賴關係，而是非線性變化的</strong>。</li><li>在典型的環境大氣顆粒物濃度水準下，臭氧和大氣顆粒的直接反應很慢，無法顯著減少臭氧的形成。此外，Cl自由基對碳氫化合物的氧化可導致過氧自由基的快速形成，並在特定的沿海環境中提高臭氧的生成速率。</li><li>偏遠大陸地區和城市中心下風處的農村和郊區，NOx濃度較低，臭氧的淨產量隨著NOx的增加而增加。而市中心，特別是在繁忙街道和高速公路附近以及在電廠羽流中，<strong>NOx濃度較高，在「滴定效應（NO+O3→NO2+O2）」作用下，臭氧因與NO反應耗損致使其濃度降低</strong>。</li><li><strong>研究發現，新冠疫情期間，世界各地大氣中的臭氧濃度都升高。這是由於採取了管控措施，交通廢氣排放減少，相應氮氧化物排放減少，在「滴定效應」影響下，城市臭氧濃度自然而然升高了</strong>。</li><li>近地面臭氧濃度與太陽輻射和氣溫有很好的相關性，<strong>太陽輻射強、氣溫高有利於臭氧生成</strong>相關的大氣化學或光化學過程，故臭氧濃度較高</li></ul></li></ul><h2 id="消耗臭氧的反應">消耗臭氧的反應</h2><p>一氧化氮（NO）與臭氧（O3）之間的反應是重要的化學過程，特別是在大氣化學中。當NO與臭氧反應時，會產生二氧化氮（NO₂）和氧氣（O₂）。這個反應的化學方程式可以表示為：</p><p><span class="math display">\[\text{NO} + \text{O}_3 \rightarrow \text{NO}_2 + \text{O}_2 \]</span></p><p>這個反應對於空氣品質有重要影響，因為NO是一種污染物，通常來自於汽車排放和工業活動，而O3則是一種主要的地面臭氧污染物。這些反應有助於減少大氣中的臭氧濃度，但同時也會產生NO₂，這也是一種有害的空氣污染物。</p><div class="group-image-container"><div class="group-image-row"><div class="group-image-wrap"><img src="https://i.imgur.com/SOd6pGr.png" /></div><div class="group-image-wrap"><img src="https://i.imgur.com/ctiahcF.png" /></div></div><div class="group-image-row"><div class="group-image-wrap"><img src="https://i.imgur.com/xUFhGT3.png" /></div></div></div><h1 id="tw-行政院環境保護署">TW-行政院環境保護署</h1><ul><li><a href="https://aqmc.moenv.gov.tw/airquality_3.html">網格類模式的簡要描述</a></li><li><a href="https://aqmc.moenv.gov.tw/datasheetlist_3.html">公告模式 CMAQ 使用方式指引</a><ul><li>網格類公告模式CMAQ技術文件</li><li>公告模式CMAQ排放量工具（SMOKE）使用國網方式指引</li><li>附件二 新增污染源處理程序排放檔製作</li><li>附件四 空氣品質模式訓練教材</li></ul></li></ul><h1 id="hk-epd">HK-EPD</h1><h2 id="path-data-download">PATH Data Download</h2><ul><li><a href="https://path.epd.gov.hk/download.html">PATH v3.0 Data Download</a><ul><li>Air Quality Module<br /></li><li>Meteorology Input</li><li>Emission Input</li><li>Initial and Boundary Conditions</li><li>Emission Editor and Extractor</li><li>Standard Hourly Pollutant Output</li></ul></li><li><a href="https://path.epd.gov.hk/doc/Briefing%20on%20the%20release%20of%20updated%20PATH%2020210622%20(Final_Clean).pdf">Briefing on the release of updated PATH modelling system and air quality modelling guidelines</a></li></ul><h2 id="改善珠三角空氣質素的pm2.5研究-研究摘要"><a href="https://www.epd.gov.hk/epd/sites/default/files/epd/tc_chi/environmentinhk/air/studyrpts/files/PM2.5_study_improve_prd_chi.pdf">改善珠三角空氣質素的PM2.5研究 – 研究摘要</a></h2><ul><li>本研究以 2015 年 2 月（冬季）、7 月（颱風）、10 月（夏秋季過渡）和 12 月作為四個具代表性的月份，綜合分析其中四個典型嚴重污染事故和分析四個政策情景，探討氣象條件促成污染的比重和評估假設控制方案之成效，並根據分析結果提出相關的政策建議。</li><li>對嚴重污染事故影響最大的氣象條件，是位於珠三角地區東、東南或東北的熱帶氣旋所導致較穩定的地區性氣流。空氣污染物在此條件下快速積聚，特別在吹微弱北風或西北風時，香港及珠三角地區的南部沿海城市的污染物濃度快速升高，導致可長達一星期的高污染物水平（在夏季或秋季）。</li><li>除熱帶氣旋外，華南地區在夏季或秋季亦會有弱風情況，導致污染物積聚。當轉吹西北風，被困的污染物有機會傳到香港，往往令香港污染物的濃度上升。</li><li>在香港，空氣污染物水平在冬季亦會短暫上升，通常與增強的北或西北氣流有關。當較弱的東北風成為主導風向，加上較低溫度（即更穩定邊界層）和地表弱風，華南內陸的污染物會慢慢大量積聚。</li></ul><h1 id="wrf和cmaq-垂直層sigma座標設定">WRF和CMAQ 垂直層sigma座標設定</h1><ul><li><a href="https://aqmc.moenv.gov.tw/download/CMAQ/%E7%B6%B2%E6%A0%BC%E9%A1%9E%E5%85%AC%E5%91%8A%E6%A8%A1%E5%BC%8FCMAQ%E6%8A%80%E8%A1%93%E6%96%87%E4%BB%B6.pdf">網格類公告模式CMAQ 技術文件</a><ul><li>表1.3-3 WRF和CMAQ 垂直層sigma座標設定</li></ul></li></ul><table><thead><tr class="header"><th>LEVEL</th><th>SIGMA</th><th>氣壓(Pa)</th><th>Full LevelHeight (m)</th><th>Half LevelHeight (m)</th></tr></thead><tbody><tr class="odd"><td></td><td>1.000</td><td>100000</td><td>0</td><td></td></tr><tr class="even"><td>1</td><td>0.995</td><td>99550</td><td>38</td><td>19</td></tr><tr class="odd"><td>2</td><td>0.990</td><td>99100</td><td>76</td><td>57</td></tr><tr class="even"><td>3</td><td>0.980</td><td>98200</td><td>153</td><td>115</td></tr><tr class="odd"><td>4</td><td>0.960</td><td>96400</td><td>309</td><td>231</td></tr><tr class="even"><td>5</td><td>0.930</td><td>93700</td><td>548</td><td>429</td></tr><tr class="odd"><td>6</td><td>0.890</td><td>90100</td><td>878</td><td>713</td></tr><tr class="even"><td>7</td><td>0.850</td><td>86500</td><td>1221</td><td>1050</td></tr><tr class="odd"><td>8</td><td>0.800</td><td>82000</td><td>1671</td><td>1446</td></tr><tr class="even"><td>9</td><td>0.750</td><td>77500</td><td>2146</td><td>1909</td></tr><tr class="odd"><td>10</td><td>0.700</td><td>73000</td><td>2649</td><td>2398</td></tr><tr class="even"><td>11</td><td>0.650</td><td>68500</td><td>3185</td><td>2917</td></tr><tr class="odd"><td>12</td><td>0.600</td><td>64000</td><td>3757</td><td>3471</td></tr><tr class="even"><td>13</td><td>0.550</td><td>59500</td><td>4371</td><td>4064</td></tr><tr class="odd"><td>14</td><td>0.500</td><td>55000</td><td>5033</td><td>4702</td></tr><tr class="even"><td>15</td><td>0.450</td><td>50500</td><td>5751</td><td>5392</td></tr><tr class="odd"><td>16</td><td>0.400</td><td>46000</td><td>6537</td><td>6144</td></tr><tr class="even"><td>17</td><td>0.350</td><td>41500</td><td>7404</td><td>6971</td></tr><tr class="odd"><td>18</td><td>0.300</td><td>37000</td><td>8370</td><td>7887</td></tr><tr class="even"><td>19</td><td>0.250</td><td>32500</td><td>9462</td><td>8916</td></tr><tr class="odd"><td>20</td><td>0.200</td><td>28000</td><td>10716</td><td>10089</td></tr><tr class="even"><td>21</td><td>0.150</td><td>23500</td><td>12191</td><td>11454</td></tr><tr class="odd"><td>22</td><td>0.100</td><td>19000</td><td>13981</td><td>13086</td></tr><tr class="even"><td>23</td><td>0.050</td><td>14500</td><td>16256</td><td>15119</td></tr><tr class="odd"><td>24</td><td>0.000</td><td>10000</td><td>19384</td><td>17820</td></tr></tbody></table>]]></content>
    
    
    <categories>
      
      <category>MPAS</category>
      
    </categories>
    
    
    <tags>
      
      <tag>NWP</tag>
      
      <tag>WRF</tag>
      
      <tag>MPAS</tag>
      
      <tag>ERA5</tag>
      
      <tag>GFS</tag>
      
      <tag>CMAQ</tag>
      
      <tag>US EPA</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>MPAS | MPAS Version 8</title>
    <link href="/2025/02/26/MPAS-MPAS-Version-8/"/>
    <url>/2025/02/26/MPAS-MPAS-Version-8/</url>
    
    <content type="html"><![CDATA[<h1 id="timeline">Timeline</h1><ul><li>MPAS-Atmosphere Version 8.2.2 | 20 September 2024</li><li>MPAS-Atmosphere Version 8.2.1 | 7 August 2024</li><li>MPAS-Atmosphere Version 8.2.0 | 27 June 2024</li><li>MPAS-Atmosphere Version 8.1.0 | 18 April 2024</li><li>MPAS-Atmosphere Version 8.0.2 | 26 March 2024</li><li>MPAS-Atmosphere Version 8.0.1 | 6 July 2023</li><li>MPAS-Atmosphere Version 8.0.0 | 16 June 2023</li></ul><h1 id="links">Links</h1><ol type="1"><li><a href="https://mpas-dev.github.io/">https://mpas-dev.github.io/</a></li><li><a href="https://github.com/MPAS-Dev/MPAS-Model/releases">/MPAS-Model/releases</a></li><li><a href="https://www2.mmm.ucar.edu/projects/mpas/mpas_atmosphere_users_guide_4.0.pdf">MPAS-Atmosphere Users' Guide V4.0</a></li><li><a href="https://www2.mmm.ucar.edu/projects/mpas/mpas_atmosphere_users_guide_5.3.pdf">MPAS-Atmosphere Users' Guide V5.3</a></li><li><a href="https://www2.mmm.ucar.edu/projects/mpas/mpas_atmosphere_users_guide_6.3.pdf">MPAS-Atmosphere Users' Guide V6.3</a></li><li><a href="https://www2.mmm.ucar.edu/projects/mpas/mpas_atmosphere_users_guide_7.0.pdf">MPAS-Atmosphere Users' Guide V7.0</a></li><li><a href="https://www2.mmm.ucar.edu/projects/mpas/mpas_atmosphere_users_guide_8.2.0.pdf">MPAS-Atmosphere Users' Guide V8.2.0</a></li><li><a href="https://www.mmm.ucar.edu/events/133129/agenda">Joint WRF/MPAS Users Workshop 2024</a></li></ol><h1 id="mpas-atmosphere-version-8.0.0">MPAS-Atmosphere Version 8.0.0</h1><ul><li>Changes to the initialization include:<ul><li><strong>Enable parallel remapping of static fields</strong> with arbitrary graph partition files; special CVT partition files are no longer required.<ul><li><del>Run init atmosphere model with <strong>only one MPI task</strong> specified to create static.nc</del></li><li><del>Note that it is critical for this step that the initialization core is <strong>run serially</strong>;</del></li><li><strong>Can parallel run ! But keep in mind that memory issue because NCAR they just set each core real all geo-dataset instead of needed partittion.</strong></li></ul></li><li>Reset the default for the lower air-temperature extrapolation <strong>(config_extrap_airtemp) from 'linear' to 'lapse-rate' in the namelist</strong>. This applies to initialization and to lateral boundary condition generation for MPAS-A.</li><li>Set the condition for the lower extrapolation of the horizontal velocity such that it <strong>returns the lowest analysis level value</strong> instead of a linear extrapolation when the requested level is below the analysis level.</li><li>Create a new init case (13) for creating 3-d CAM-MPAS grids.</li></ul></li><li>Changes to the physics include:<ul><li>Update the <strong>Noah land surface scheme to the WRF 4.5</strong> release.</li><li>Update the <strong>MM5 surface layer scheme to the WRF 4.5</strong> release.</li><li>Implemented the <strong>CCPP-compliant version</strong> of:<ul><li>the revised MM5 surface layer scheme;</li><li>the parameterization of the gravity-wave drag over orography;</li><li>the YSU Planetary Boundary Layer scheme;</li><li>the scale-aware nTiedtke parameterization of convection; and</li><li>the WSM6 cloud microphysics parameterization.</li></ul></li><li>Correct the initialization of the <strong>maximum snow albedo over sea ice points (now set to 0.75</strong> instead of 0).</li><li>Fix the option that defines the surface albedo over sea ice points. The default option is now set to zero and the default value for <strong>the surface albedo over sea ice points is set to 0.65</strong>.</li><li>In the dynamics, rework the computation of the advective tendency of potential temperature needed as forcing in the <strong>nTiedtke</strong> and <strong>Grell-Freitas</strong> parameterizations of deep convection. The advective tendency of potential temperature is <strong>now computed the same way</strong> for the nTiedtke and Grell-Freitas convection schemes.</li></ul></li></ul><div class="note note-primary">            <p>IMPORTANT NOTE: The updated physics schemes require new look-up tables, in particular, for the Noah land-surface model. The <strong>checkout_data_files.sh</strong> script that is run at build time should correctly update these tables, but tables in other run directories will need to be manually updated.</p>          </div><ul><li>Include changes to the initialization and to MPAS-A such that this release can be <strong>directly used in CESM/CAM</strong>.</li></ul><h1 id="enable-parallel-remapping-of-static-fields">Enable parallel remapping of static fields</h1><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment">##-- For spack init, (it takes longer startup time !!)</span><br>. /home/wpsze/spack/share/spack/setup-env.sh<br><span class="hljs-built_in">source</span> /home/wpsze/MPAS-A/intel/mpas_env_intel.sh<br><span class="hljs-comment">#ln -sf /home/wpsze/MPAS-A/intel/mpasv821/MPASv821/init_atmosphere_model</span><br><span class="hljs-built_in">ln</span> -sf /home/wpsze/MPAS-A/intel/mpasv822/MPASv822/init_atmosphere_model<br><br><span class="hljs-comment"># soft-link graph.info.part.3</span><br>mpirun -n 3 ./init_atmosphere_model<br></code></pre></td></tr></table></figure><p>and, add below in namelist.init_atmosphere</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs namelist.init_atmosphere">&amp;decomposition<br>   config_block_decomp_file_prefix = &#x27;graph.info.part.&#x27;<br>/<br></code></pre></td></tr></table></figure>    <div class="fold">      <div class="fold-title fold-info collapsed" data-toggle="collapse" href="#collapse-6ae3e036" role="button" aria-expanded="false" aria-controls="collapse-6ae3e036">        <div class="fold-arrow">▶</div>namelist.init_atmosphere      </div>      <div class="fold-collapse collapse" id="collapse-6ae3e036">        <div class="fold-content">          <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs namelist.init_atmosphere">&amp;nhyd_model<br>    config_init_case = 7<br>/<br>&amp;dimensions<br>    config_nvertlevels = 1<br>    config_nsoillevels = 1<br>    config_nfglevels = 1<br>    config_nfgsoillevels = 1<br>/<br>&amp;data_sources<br>    config_geog_data_path = &#x27;/home/wpsze/WRF/wrf_geog/WRF/WPS_GEOG/&#x27;<br>    config_landuse_data = &#x27;MODIFIED_IGBP_MODIS_NOAH&#x27;<br>    config_topo_data = &#x27;GMTED2010&#x27;<br>    config_vegfrac_data = &#x27;MODIS&#x27;<br>    config_albedo_data = &#x27;MODIS&#x27;<br>    config_maxsnowalbedo_data = &#x27;MODIS&#x27;<br>    config_supersample_factor = 3<br>    config_use_spechumd = false<br>/<br>&amp;preproc_stages<br>    config_static_interp = true<br>    config_native_gwd_static = true<br>    config_vertical_grid = false<br>    config_met_interp = false<br>    config_input_sst = false<br>    config_frac_seaice = false<br>/<br><br>&amp;decomposition<br>   config_block_decomp_file_prefix = &#x27;graph.info.part.&#x27;<br>/<br></code></pre></td></tr></table></figure>        </div>      </div>    </div><h1 id="error">Error</h1><h2 id="array-global_list-above-upper-bound">array 'global_list' above upper bound</h2><ul><li>Only encounter after <code>MPASv8.2.0</code></li></ul>    <div class="fold">      <div class="fold-title fold-info collapsed" data-toggle="collapse" href="#collapse-9c51fa20" role="button" aria-expanded="false" aria-controls="collapse-9c51fa20">        <div class="fold-arrow">▶</div>log.init_atmosphere.0000.out      </div>      <div class="fold-collapse collapse" id="collapse-9c51fa20">        <div class="fold-content">          <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs log">----------------------------------------------------------------------<br>Beginning MPAS-init_atmosphere Output Log File for task       0 of       6<br>    Opened at 2025/03/05 15:54:12<br>----------------------------------------------------------------------<br><br> <br> MPAS Init-Atmosphere Version 8.2.2<br> <br> <br> Output from &#x27;git describe --dirty&#x27;: unknown<br> <br> Compile-time options:<br>   Build target: gfortran<br>   OpenMP support: no<br>   OpenACC support: no<br>   Default real precision: single<br>   Compiler flags: debug<br>   I/O layer: PIO 2.x<br> <br> Run-time settings:<br>   MPI task count: 6<br> <br> Reading namelist from file namelist.init_atmosphere<br> *** Encountered an issue while attempting to read namelist record physics<br>     The following values will be used for variables in this record:<br> <br>         config_tsk_seaice_threshold = 100.000<br> <br> *** Encountered an issue while attempting to read namelist record io<br>     The following values will be used for variables in this record:<br> <br>         config_pio_num_iotasks = 0<br>         config_pio_stride = 1<br> <br> <br> ----- I/O task configuration: -----<br> <br>     I/O task count  = 6<br>     I/O task stride = 1<br> <br> Initializing MPAS_streamInfo from file streams.init_atmosphere<br> Reading streams configuration from file streams.init_atmosphere<br> Found mesh stream with filename template static.nc<br> Using io_type Parallel-NetCDF (CDF-5, large variable support) for mesh stream<br>  ** Attempting to bootstrap MPAS framework using stream: input<br> Bootstrapping framework with mesh fields from input file &#x27;static.nc&#x27;<br></code></pre></td></tr></table></figure>        </div>      </div>    </div>    <div class="fold">      <div class="fold-title fold-info collapsed" data-toggle="collapse" href="#collapse-05eef982" role="button" aria-expanded="false" aria-controls="collapse-05eef982">        <div class="fold-arrow">▶</div>log_error      </div>      <div class="fold-collapse collapse" id="collapse-05eef982">        <div class="fold-content">          <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs log">MPASv8.1.0/8.2.0<br>free(): invalid next size (normal)<br><br>Running init_atmosphere in directory: <br>At line 183 of file mpas_block_decomp.F<br>Fortran runtime error: Index &#x27;30210&#x27; of dimension 1 of array &#x27;global_list&#x27; above upper bound of 30209<br><br>Running init_atmosphere<br>init_atmosphere_model: malloc.c:4106: _int_malloc: Assertion `(unsigned long) (size) &gt;= (unsigned long) (nb)&#x27; failed.<br><br>Running init_atmosphere<br>munmap_chunk(): invalid pointer<br></code></pre></td></tr></table></figure>        </div>      </div>    </div><ul><li><a href="https://forum.mmm.ucar.edu/threads/errors-when-running-the-baroclinic-wave-case-for-mpas-a.17200/">errors when running the baroclinic wave case for MPAS-A</a><ul><li><code>At line 183 of file mpas_block_decomp.F: Fortran runtime error: Index '40962' of dimension 1 of array 'global_list' above upper bound of 40961</code></li><li>This is because with the clobber_mode = "'never_modify", the output file cannot be overwritten. Please delete the file 'x1.40962.init.nc' from your previous run and rerun your case.</li><li>I am not sure yet what caused this issue. Please rerun this case with the fix of the 1st issue and let me know if you still get the same error.</li><li>Your suggestion fixed the issue. I have also use the <strong>"overwrite" option</strong>, that works as well.</li></ul></li></ul><h2 id="nsoilcomps-in-static.nc"><code>nSoilComps</code> in static.nc</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs log">ERROR: At least one fields to be read from the &#x27;input&#x27; stream is dimensioned<br>ERROR: by &#x27;nSoilComps&#x27;, but the &#x27;nSoilComps&#x27; dimension is not defined<br>ERROR: in the file static.nc<br>CRITICAL ERROR: Please check the input file(s) to be read by the &#x27;input&#x27; input stream.<br></code></pre></td></tr></table></figure>    <div class="fold">      <div class="fold-title fold-info collapsed" data-toggle="collapse" href="#collapse-738764b7" role="button" aria-expanded="false" aria-controls="collapse-738764b7">        <div class="fold-arrow">▶</div>src/core_init_atmosphere/Registry.xml      </div>      <div class="fold-collapse collapse" id="collapse-738764b7">        <div class="fold-content">          <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs src/core_init_atmosphere/Registry.xml">description=&quot;The number of atmospheric levels, always one more than the number of layers&quot;/&gt;<br>&lt;dim name=&quot;nSoilComps&quot; definition=&quot;8&quot;<br>description=&quot;The number of soil textures as needed as input in the NOAH-MP land surface model&quot;/&gt;<br><br>&lt;!-- SOIL COMPOSITION fields needed for the NOAH-MP land surface scheme --&gt;<br>&lt;var name=&quot;soilcomp&quot; type=&quot;real&quot; dimensions=&quot;nSoilComps nCells&quot; units=&quot;percent&quot;<br>description=&quot;soil composition needed as input in the NOAH-MP land surface model&quot;/&gt;<br></code></pre></td></tr></table></figure>        </div>      </div>    </div>    <div class="fold">      <div class="fold-title fold-info collapsed" data-toggle="collapse" href="#collapse-dfb167e8" role="button" aria-expanded="false" aria-controls="collapse-dfb167e8">        <div class="fold-arrow">▶</div>src/core_atmosphere/physics/Registry_noahmp.xml      </div>      <div class="fold-collapse collapse" id="collapse-dfb167e8">        <div class="fold-content">          <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs src/core_atmosphere/physics/Registry_noahmp.xml">&lt;dim name=&quot;nSoilComps&quot; definition=&quot;8&quot;<br>description=&quot;The number of soil textures as needed as input in the NOAH-MP land surface model&quot;/&gt;<br><br>&lt;var name=&quot;soilcomp&quot; type=&quot;real&quot; dimensions=&quot;nSoilComps nCells&quot; units=&quot;unitless&quot;<br>description=&quot;soil composition needed as input in the NOAH-MP land surface model&quot;<br></code></pre></td></tr></table></figure>        </div>      </div>    </div><ul><li><a href="https://github.com/MPAS-Dev/MPAS-Model/commit/d4a1c7f57288c6fff287a914fb98135aca391467">Commit d4a1c7f on May 31, 2024</a><ul><li><ul><li>In ./src/core_init_atmosphere, added the initialization of the static variables <strong>soilcomp, soilcl1, soilcl2, soilcl3, and soilcl4</strong> needed to run the Noah-MP land surface scheme.</li></ul></li></ul></li></ul><div class="note note-primary">            <p>The <strong>static.nc</strong> is different after <strong>Noah-MP</strong> is applied. (<strong>v8.2.2 ... v8.2.0</strong>). And, re-generate static.nc</p>          </div><ul><li><a href="https://forum.mmm.ucar.edu/threads/error-while-trying-to-create-static-nc.19776/">Error while trying to create static.nc | Nov 6, 2024</a><ul><li>Even if you don't intend to use the Noah-MP LSM in your simulations, <strong>the MPAS v8.2 release still requires the five new Noah-MP static fields</strong> <code>soilcomp, soilcl1, soilcl2, soilcl3, and soilcl4</code> to be processed along with other static fields in the init_atmosphere core. Downloading updated static geographical datasets from <a href="https://www2.mmm.ucar.edu/projects/mpas/mpas_static.tar.bz2" class="uri">https://www2.mmm.ucar.edu/projects/mpas/mpas_static.tar.bz2</a> and referring to those with the <code>config_geog_data_path</code> namelist option in your <code>namelist.init_atmosphere</code> file should resolve the error you're seeing.</li></ul></li></ul><h2 id="solution">Solution</h2><ul><li><strong>Fail</strong> if using <code>gfortran</code> (v9.3.0) complier.</li><li><strong>Sucessfull</strong> if using <code>intel-mpi</code> complier.</li></ul>    <div class="fold">      <div class="fold-title fold-info collapsed" data-toggle="collapse" href="#collapse-5d5d193e" role="button" aria-expanded="false" aria-controls="collapse-5d5d193e">        <div class="fold-arrow">▶</div>gfortran: log      </div>      <div class="fold-collapse collapse" id="collapse-5d5d193e">        <div class="fold-content">          <figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs applescript"><span class="hljs-comment">----------------------------------------------------------------------</span><br>Beginning MPAS-init_atmosphere Output Log File <span class="hljs-keyword">for</span> task       <span class="hljs-number">0</span> <span class="hljs-keyword">of</span>       <span class="hljs-number">6</span><br>    Opened <span class="hljs-keyword">at</span> <span class="hljs-number">2025</span>/<span class="hljs-number">03</span>/<span class="hljs-number">06</span> <span class="hljs-number">15</span>:<span class="hljs-number">23</span>:<span class="hljs-number">51</span><br><span class="hljs-comment">----------------------------------------------------------------------</span><br><br> <br> MPAS Init-Atmosphere Version <span class="hljs-number">8.2</span><span class="hljs-number">.2</span><br> <br> <br> Output <span class="hljs-keyword">from</span> &#x27;git describe <span class="hljs-comment">--dirty&#x27;: unknown</span><br> <br> Compile-<span class="hljs-built_in">time</span> options:<br>   Build target: gfortran<br>   OpenMP support: no<br>   OpenACC support: no<br>   Default <span class="hljs-built_in">real</span> precision: single<br>   Compiler flags: debug<br>   I/O layer: PIO <span class="hljs-number">2.</span>x<br> <br> Run-<span class="hljs-built_in">time</span> settings:<br>   MPI task <span class="hljs-built_in">count</span>: <span class="hljs-number">6</span><br> <br> Reading namelist <span class="hljs-keyword">from</span> <span class="hljs-built_in">file</span> namelist.init_atmosphere<br> *** Encountered an issue <span class="hljs-keyword">while</span> attempting <span class="hljs-keyword">to</span> <span class="hljs-built_in">read</span> namelist <span class="hljs-built_in">record</span> physics<br>     The following values will be used <span class="hljs-keyword">for</span> variables <span class="hljs-keyword">in</span> this <span class="hljs-built_in">record</span>:<br> <br>         config_tsk_seaice_threshold = <span class="hljs-number">100.000</span><br> <br> *** Encountered an issue <span class="hljs-keyword">while</span> attempting <span class="hljs-keyword">to</span> <span class="hljs-built_in">read</span> namelist <span class="hljs-built_in">record</span> io<br>     The following values will be used <span class="hljs-keyword">for</span> variables <span class="hljs-keyword">in</span> this <span class="hljs-built_in">record</span>:<br> <br>         config_pio_num_iotasks = <span class="hljs-number">0</span><br>         config_pio_stride = <span class="hljs-number">1</span><br> <br> <br> <span class="hljs-comment">----- I/O task configuration: -----</span><br> <br>     I/O task <span class="hljs-built_in">count</span>  = <span class="hljs-number">6</span><br>     I/O task stride = <span class="hljs-number">1</span><br> <br> Initializing MPAS_streamInfo <span class="hljs-keyword">from</span> <span class="hljs-built_in">file</span> streams.init_atmosphere<br> Reading streams configuration <span class="hljs-keyword">from</span> <span class="hljs-built_in">file</span> streams.init_atmosphere<br> Found mesh stream <span class="hljs-keyword">with</span> filename template static.nc<br> Using io_type Parallel-NetCDF (CDF<span class="hljs-number">-5</span>, large variable support) <span class="hljs-keyword">for</span> mesh stream<br>  ** Attempting <span class="hljs-keyword">to</span> bootstrap MPAS framework using stream: input<br> Bootstrapping framework <span class="hljs-keyword">with</span> mesh fields <span class="hljs-keyword">from</span> input <span class="hljs-built_in">file</span> &#x27;static.nc&#x27;<br></code></pre></td></tr></table></figure>        </div>      </div>    </div>    <div class="fold">      <div class="fold-title fold-info collapsed" data-toggle="collapse" href="#collapse-8bbf6858" role="button" aria-expanded="false" aria-controls="collapse-8bbf6858">        <div class="fold-arrow">▶</div>intel-mpi: log      </div>      <div class="fold-collapse collapse" id="collapse-8bbf6858">        <div class="fold-content">          <figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><code class="hljs livecodeserver"><span class="hljs-comment">----------------------------------------------------------------------</span><br>Beginning MPAS-init_atmosphere Output Log File <span class="hljs-keyword">for</span> task       <span class="hljs-number">0</span> <span class="hljs-keyword">of</span>       <span class="hljs-number">6</span><br>    Opened <span class="hljs-keyword">at</span> <span class="hljs-number">2025</span>/<span class="hljs-number">03</span>/<span class="hljs-number">06</span> <span class="hljs-number">17</span>:<span class="hljs-number">08</span>:<span class="hljs-number">04</span><br><span class="hljs-comment">----------------------------------------------------------------------</span><br><br> <br> MPAS Init-Atmosphere Version <span class="hljs-number">8.2</span><span class="hljs-number">.2</span><br> <br> <br> Output <span class="hljs-built_in">from</span> <span class="hljs-string">&#x27;git describe --dirty&#x27;</span>: unknown<br> <br> Compile-<span class="hljs-built_in">time</span> options:<br>   Build target: intel-mpi<br>   OpenMP support: no<br>   OpenACC support: no<br>   Default real precision: single<br>   Compiler flags: optimize<br>   I/O layer: PIO <span class="hljs-number">2.</span>x<br> <br> Run-<span class="hljs-built_in">time</span> settings:<br>   MPI task count: <span class="hljs-number">6</span><br> <br> Reading namelist <span class="hljs-built_in">from</span> <span class="hljs-built_in">file</span> namelist.init_atmosphere<br> *** Encountered <span class="hljs-keyword">an</span> issue <span class="hljs-keyword">while</span> attempting <span class="hljs-built_in">to</span> <span class="hljs-built_in">read</span> namelist record physics<br>     The following values will be used <span class="hljs-keyword">for</span> variables <span class="hljs-keyword">in</span> this record:<br> <br>         config_tsk_seaice_threshold = <span class="hljs-number">100.000</span><br> <br> *** Encountered <span class="hljs-keyword">an</span> issue <span class="hljs-keyword">while</span> attempting <span class="hljs-built_in">to</span> <span class="hljs-built_in">read</span> namelist record io<br>     The following values will be used <span class="hljs-keyword">for</span> variables <span class="hljs-keyword">in</span> this record:<br> <br>         config_pio_num_iotasks = <span class="hljs-number">0</span><br>         config_pio_stride = <span class="hljs-number">1</span><br> <br> <br> <span class="hljs-comment">----- I/O task configuration: -----</span><br> <br>     I/O task count  = <span class="hljs-number">6</span><br>     I/O task stride = <span class="hljs-number">1</span><br><br>......<br><br> <span class="hljs-comment">--- isice_lu   = 15</span><br> <span class="hljs-comment">--- config_frac_seaice      : F</span><br> <span class="hljs-comment">--- xice_threshold          : 0.500000</span><br> <span class="hljs-comment">--- tsk_seaice_threshold    : 100.000</span><br> <br> <span class="hljs-built_in">number</span> <span class="hljs-keyword">of</span> seaice cells converted <span class="hljs-built_in">to</span> land cells <span class="hljs-number">2</span> =         <span class="hljs-number">210</span><br> <br> ********************************************************<br>    Finished running <span class="hljs-keyword">the</span> init_atmosphere core<br> ********************************************************<br> <br> <br>  Timer information:<br>     Globals are computed across all threads <span class="hljs-keyword">and</span> processors<br> <br>  Columns:<br>     total <span class="hljs-built_in">time</span>: Global <span class="hljs-built_in">max</span> <span class="hljs-keyword">of</span> accumulated <span class="hljs-built_in">time</span> spent <span class="hljs-keyword">in</span> timer<br>     calls: Total <span class="hljs-built_in">number</span> <span class="hljs-keyword">of</span> times this timer was started / stopped.<br>     <span class="hljs-built_in">min</span>: Global <span class="hljs-built_in">min</span> <span class="hljs-keyword">of</span> <span class="hljs-built_in">time</span> spent <span class="hljs-keyword">in</span> <span class="hljs-keyword">a</span> single <span class="hljs-built_in">start</span> / <span class="hljs-built_in">stop</span><br>     <span class="hljs-built_in">max</span>: Global <span class="hljs-built_in">max</span> <span class="hljs-keyword">of</span> <span class="hljs-built_in">time</span> spent <span class="hljs-keyword">in</span> <span class="hljs-keyword">a</span> single <span class="hljs-built_in">start</span> / <span class="hljs-built_in">stop</span><br>     <span class="hljs-built_in">avg</span>: Global <span class="hljs-built_in">max</span> <span class="hljs-keyword">of</span> <span class="hljs-built_in">average</span> <span class="hljs-built_in">time</span> spent <span class="hljs-keyword">in</span> <span class="hljs-keyword">a</span> single <span class="hljs-built_in">start</span> / <span class="hljs-built_in">stop</span><br>     pct_tot: Percent <span class="hljs-keyword">of</span> <span class="hljs-keyword">the</span> timer <span class="hljs-keyword">at</span> level <span class="hljs-number">1</span><br>     pct_par: Percent <span class="hljs-keyword">of</span> <span class="hljs-keyword">the</span> parent timer (<span class="hljs-literal">one</span> level up)<br>     par_eff: Parallel efficiency, <span class="hljs-built_in">global</span> <span class="hljs-built_in">average</span> total <span class="hljs-built_in">time</span> / <span class="hljs-built_in">global</span> <span class="hljs-built_in">max</span> total <span class="hljs-built_in">time</span><br> <br> <br>    timer_name                                            total       calls        <span class="hljs-built_in">min</span>            <span class="hljs-built_in">max</span>            <span class="hljs-built_in">avg</span>      pct_tot   pct_par     par_eff<br>  <span class="hljs-number">1</span> total <span class="hljs-built_in">time</span>                                           <span class="hljs-number">9.53601</span>         <span class="hljs-number">1</span>        <span class="hljs-number">9.53588</span>        <span class="hljs-number">9.53601</span>        <span class="hljs-number">9.53594</span>   <span class="hljs-number">100.00</span>       <span class="hljs-number">0.00</span>       <span class="hljs-number">1.00</span><br>  <span class="hljs-number">2</span>  initialize                                          <span class="hljs-number">0.85724</span>         <span class="hljs-number">1</span>        <span class="hljs-number">0.85061</span>        <span class="hljs-number">0.85724</span>        <span class="hljs-number">0.85206</span>     <span class="hljs-number">8.99</span>       <span class="hljs-number">8.99</span>       <span class="hljs-number">0.99</span><br> <br> <span class="hljs-comment">-----------------------------------------</span><br> Total <span class="hljs-built_in">log</span> messages printed:<br>    Output messages =                  <span class="hljs-number">522</span><br>    Warning messages =                   <span class="hljs-number">1</span><br>    Error messages =                     <span class="hljs-number">0</span><br>    Critical error messages =            <span class="hljs-number">0</span><br> <span class="hljs-comment">-----------------------------------------</span><br> Logging complete.  Closing <span class="hljs-built_in">file</span> <span class="hljs-keyword">at</span> <span class="hljs-number">2025</span>/<span class="hljs-number">03</span>/<span class="hljs-number">06</span> <span class="hljs-number">17</span>:<span class="hljs-number">08</span>:<span class="hljs-number">14</span><br></code></pre></td></tr></table></figure>        </div>      </div>    </div><h1 id="an-aerosol-climatology-file-qnwfa_qnifa_sigma_monthly.dat">An aerosol climatology file <code>QNWFA_QNIFA_SIGMA_MONTHLY.dat</code></h1><h2 id="mpas-version-8.2.0">MPAS Version 8.2.0</h2><ul><li>The <strong>aerosol-aware Thompson microphysics (as in WRF v4.1.4)</strong> is available by setting <code>config_microp_scheme = 'mp_thompson_aerosols'</code> in the <code>&amp;physics</code> namelist group.</li><li>An aerosol climatology file <strong>(QNWFA_QNIFA_SIGMA_MONTHLY.dat)</strong> is used when running the <code>init_atmosphere_model</code> program to produce initial and lateral boundary conditions for <code>nifa</code> and <code>nwfa</code>.</li><li>download: <a href="https://mpas-dev.github.io/" class="uri">https://mpas-dev.github.io/</a></li></ul><h1 id="mpi_f08"><code>mpi_f08</code></h1><p><code>mpi_f08</code> 是一種用於 Fortran 2008 的 MPI（Message Passing Interface）模組介面。 MPI 是一種用於平行運算的標準化訊息傳遞庫，廣泛用於高效能運算環境中。 <code>mpi_f08</code> 模組提供了一個現代化的接口，允許 Fortran 2008 程式使用 MPI 進行平行計算。</p><p>在 Fortran 2008 中，<code>mpi_f08</code> 模組支援新的 Fortran 語言特性，並提供了更好的與現代 Fortran 編譯器的兼容性。相較之下，傳統的 <code>mpi</code> 模組可能不支援所有 Fortran 2008 的特性，因此在支援 <code>mpi_f08</code> 的環境中，優先使用 <code>mpi_f08</code> 可以提高程式碼的可移植性和相容性。</p><p>例如，在 MPAS 模型中，如果偵測到 <code>mpi_f08</code> 模組，則會優先使用它來呼叫 Fortran MPI例程，而不是使用舊的 <code>mpi</code> 模組介面。</p><p><code>mpi_f08</code> 和 <code>mpif90</code> 是兩個不同的概念，分別與 MPI（Message Passing Interface）和 Fortran 編譯器相關。</p><h2 id="mpi_f08-1"><code>mpi_f08</code></h2><ul><li><strong>定義</strong>：<code>mpi_f08</code> 是一種用於 Fortran 2008 的 MPI 模組介面。它提供了一個現代化的接口，支援 Fortran 2008 的新特性，如非同步操作和假設類型參數。</li><li><strong>優點</strong>：<code>mpi_f08</code> 提供了更好的類型檢查和非阻塞調用支持，且與 Fortran 2008 標準完全兼容。</li><li><strong>應用</strong>：推薦用於所有新的 MPI Fortran 應用程序，因為它提供了更強的類型安全性和更好的性能優化。</li></ul><h2 id="mpif90"><code>mpif90</code></h2><ul><li><strong>定義</strong>：<code>mpif90</code> 是一種用於編譯 Fortran 90 MPI 程式的編譯器包裝器。它通常與 OpenMPI 等 MPI 實作一起使用。</li><li><strong>狀態</strong>：在 OpenMPI v1.7 中，<code>mpif90</code> 已被標記為過時，建議使用 <code>mpifort</code> 取代。</li><li><strong>應用</strong>：雖然仍然支援 <code>mpif90</code>，但建議使用 <code>mpifort</code> 來編譯所有版本的 Fortran MPI 應用程序，因為 <code>mpifort</code> 更加通用和現代化。</li></ul><p>總之，<code>mpi_f08</code> 是一個現代化的 MPI Fortran 接口，而 <code>mpif90</code> 是一個較老的編譯器包裝器，已經被 <code>mpifort</code> 所取代。</p><h1 id="referecnes">Referecnes</h1><ol type="1"><li><a href="https://forum.mmm.ucar.edu/threads/mpas-v8-2-fails-to-compile-gnu-13-2-linux64.17999/">MPAS v8.2 fails to compile GNU 13.2 Linux64 | Jul 2, 2024</a></li></ol>]]></content>
    
    
    <categories>
      
      <category>MPAS</category>
      
    </categories>
    
    
    <tags>
      
      <tag>NWP</tag>
      
      <tag>WRF</tag>
      
      <tag>MPAS</tag>
      
      <tag>ERA5</tag>
      
      <tag>GFS</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ML | NVIDIA Modulus</title>
    <link href="/2025/02/21/ML-NVIDIA-Modulus/"/>
    <url>/2025/02/21/ML-NVIDIA-Modulus/</url>
    
    <content type="html"><![CDATA[<h1 id="nvidia-modulus">NVIDIA Modulus</h1><p>Modulus is an open source deep-learning framework for building, training, and fine-tuning deep learning models using state-of-the-art <strong>Physics-ML methods</strong>.</p><p>Whether you are exploring the use of Neural operators like <strong>Fourier Neural Operators</strong> or interested in <strong>Physics informed Neural Networks</strong> or a hybrid approach in between, Modulus provides you with the optimized stack that will enable you to train your models at real world scale.</p><p>Modulus code is open source and packaged in a modular fashion into two repos - <strong>Modulus Core</strong> and <strong>Modulus Sym</strong>.</p><ul><li><strong>Modulus Core</strong> provides a pytorch like experience for those proficient with python for AI. It includes all the core algorithms, network architectures and utilities to cover the broad spectrum of physics-constrained and data-driven workflows to suit the diversity of use cases in the science and engineering disciplines.</li><li><strong>Modulus Symbolic (Modulus Sym)</strong> provides pythonic APIs, algorithms and utilities to be used with Modulus core, to explicitly physics inform the model training. This includes <strong>symbolic APIs for PDEs, domain sampling and PDE-based residuals</strong>. It also provides higher level abstraction to compose a training loop from specification of the <strong>geometry, PDEs and constraints like boundary conditions using simple symbolic APIs</strong>.</li></ul><p>We also package the entire Modulus source in a single container image to simplify the ease of use and is freely available on NGC. The container does not include the reference applications due to their size and we recommend you to download the examples directly from Github source.</p><h1 id="modulus-with-docker-image---singularity">Modulus with Docker Image - Singularity</h1><p>Once you have installed <code>Singularity</code>, to build and <strong>run Modulus Docker image</strong> with <code>Singularity</code>:</p><figure class="highlight console"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs console">singularity build Modulus.sif docker://nvcr.io/nvidia/modulus/modulus:&lt;tag&gt;<br>singularity run --writable --nv Modulus.sif<br></code></pre></td></tr></table></figure><ul><li><a href="https://github.com/NVIDIA/modulus/releases" class="uri">https://github.com/NVIDIA/modulus/releases</a></li><li><strong>tag</strong><ul><li><a href="https://catalog.ngc.nvidia.com/orgs/nvidia/teams/modulus/containers/modulus/tags" class="uri">https://catalog.ngc.nvidia.com/orgs/nvidia/teams/modulus/containers/modulus/tags</a></li><li>up to 24.12 (2025-02-21)</li><li>consider <code>singularity build Modulus.sif docker://nvcr.io/nvidia/modulus/modulus:23.08</code><ul><li>10/04/2023 2:35 AM, 11.24 GB, 1 Architecture</li><li><code>9.5G Feb 21 17:19 Modulus.sif</code></li></ul></li></ul></li></ul><p>But,</p><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc"><span class="hljs-code"> $ singularity run --writable --nv Modulus.sif</span><br>INFO:    Could not find any nv files on this host!<br><span class="hljs-symbol">WARNING: </span>Could not find any nv libraries on this host!<br><span class="hljs-symbol">WARNING: </span>You may need to manually edit /home/wpsze/micromamba/envs/singularity/etc/singularity/nvliblist.conf<br>INFO:    Converting SIF file to temporary sandbox...<br><span class="hljs-symbol">WARNING: </span>Skipping mount /etc/localtime [binds]: /etc/localtime doesn&#x27;t exist in container<br><span class="hljs-symbol">WARNING: </span>By using --writable, Singularity can&#x27;t create /HOME destination automatically without overlay or underlay<br>INFO:    Cleaning up image...<br>FATAL:   container creation failed: mount /home/wpsze/micromamba/envs/singularity/var/singularity/mnt/session/HOME-&gt;/HOME error: while mounting /home/wpsze/micromamba/envs/singularity/var/singularity/mnt/session/HOME: destination /HOME doesn&#x27;t exist in container<br></code></pre></td></tr></table></figure><ul><li><a href="https://www.nas.nasa.gov/hecc/support/kb/running-a-singularity-container-image-on-pleiades_638.html">Running a Singularity Container Image on Pleiades | NASA</a><ul><li><code>WARNING: By using --writable, Singularity can't create /homeX destination ......</code></li><li><strong>Note</strong>: If you encounter the following warning message, <code>cd</code> to <code>your_image_sandbox</code> and use the <code>mkdir</code> command to create <code>homeX</code> before you retry the commands above. (The X in <code>homeX</code> represents the actual value (X=1-7) of your $HOME directory on Pleiades.)</li></ul></li></ul><h2 id="can-modulus-run-on-cpu">Can Modulus run on CPU?</h2><ul><li>Modulus is built on top of PyTorch, which supports both CPU and GPU execution. By default, Modulus will attempt to use a GPU if available, but it can fall back to CPU execution if no GPU is detected or if explicitly configured.</li><li>Running on a CPU is feasible for smaller models or prototyping, but large-scale training or complex simulations may be impractical due to performance constraints.</li></ul><p>By default, the Modulus container is optimized for GPU use and assumes CUDA availability. To run it on CPU:</p><ul><li>Avoid passing GPU resources to Singularity (e.g., no <code>--nv</code> flag).</li><li>Launch the container interactively or with a script.</li></ul><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs routeros">$ singularity <span class="hljs-built_in">run</span> Modulus.sif<br></code></pre></td></tr></table></figure><p>and, <strong>Importantly</strong>, add on <code>conf/config.yaml</code></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">device:</span> <span class="hljs-string">cpu</span><br><span class="hljs-attr">cuda_graphs:</span> <span class="hljs-literal">False</span><br></code></pre></td></tr></table></figure><p>like, on <code>three_fin_2d/heat_sink</code> case,</p><ul><li>$ cat /home/wpsze/ML/NVIDIA-Modulus/modulus-sym/examples/three_fin_2d/conf/config.yaml</li></ul>    <div class="fold">      <div class="fold-title fold-info collapsed" data-toggle="collapse" href="#collapse-05eef982" role="button" aria-expanded="false" aria-controls="collapse-05eef982">        <div class="fold-arrow">▶</div>config.yaml      </div>      <div class="fold-collapse collapse" id="collapse-05eef982">        <div class="fold-content">          <figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-comment"># SPDX-FileCopyrightText: Copyright (c) 2023 - 2024 NVIDIA CORPORATION &amp; AFFILIATES.</span><br><span class="hljs-comment"># SPDX-FileCopyrightText: All rights reserved.</span><br><span class="hljs-comment"># SPDX-License-Identifier: Apache-2.0</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment"># Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span><br><span class="hljs-comment"># you may not use this file except in compliance with the License.</span><br><span class="hljs-comment"># You may obtain a copy of the License at</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment">#     http://www.apache.org/licenses/LICENSE-2.0</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment"># Unless required by applicable law or agreed to in writing, software</span><br><span class="hljs-comment"># distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span><br><span class="hljs-comment"># WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span><br><span class="hljs-comment"># See the License for the specific language governing permissions and</span><br><span class="hljs-comment"># limitations under the License.</span><br><br><span class="hljs-attr">defaults :</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">modulus_default</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">arch:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">fully_connected</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">optimizer :</span> <span class="hljs-string">adam</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">scheduler :</span> <span class="hljs-string">tf_exponential_lr</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">loss :</span> <span class="hljs-string">sum</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">_self_</span><br><br><span class="hljs-attr">jit:</span> <span class="hljs-literal">false</span><br><br><span class="hljs-attr">device:</span> <span class="hljs-string">cpu</span><br><span class="hljs-attr">cuda_graphs:</span> <span class="hljs-literal">False</span><br><br><span class="hljs-attr">scheduler:</span><br>  <span class="hljs-attr">decay_rate:</span> <span class="hljs-number">0.95</span><br>  <span class="hljs-attr">decay_steps:</span> <span class="hljs-number">5000</span><br><br><span class="hljs-attr">training:</span> <br>  <span class="hljs-attr">rec_validation_freq:</span> <span class="hljs-number">1000</span><br>  <span class="hljs-attr">rec_inference_freq:</span> <span class="hljs-number">1000</span><br>  <span class="hljs-attr">rec_monitor_freq:</span> <span class="hljs-number">1000</span><br>  <span class="hljs-attr">rec_constraint_freq:</span> <span class="hljs-number">2000</span><br>  <span class="hljs-attr">max_steps:</span> <span class="hljs-number">500000</span><br><br><span class="hljs-attr">batch_size:</span><br>  <span class="hljs-attr">inlet:</span> <span class="hljs-number">64</span><br>  <span class="hljs-attr">outlet:</span> <span class="hljs-number">64</span><br>  <span class="hljs-attr">hs_wall:</span> <span class="hljs-number">500</span><br>  <span class="hljs-attr">channel_wall:</span> <span class="hljs-number">2500</span><br>  <span class="hljs-attr">interior_flow:</span> <span class="hljs-number">4800</span><br>  <span class="hljs-attr">interior_heat:</span> <span class="hljs-number">4800</span><br>  <span class="hljs-attr">integral_continuity:</span> <span class="hljs-number">128</span><br>  <span class="hljs-attr">num_integral_continuity:</span> <span class="hljs-number">4</span><br></code></pre></td></tr></table></figure>        </div>      </div>    </div><h2 id="bug">Bug</h2><h3 id="root-filesystem-extraction-failed-failed-to-copy-content-in-staging-file-write-tmprootfs">root filesystem extraction failed: failed to copy content in staging file: write /tmp/rootfs</h3><ul><li><a href="https://github.com/apptainer/singularity/issues/5711">root filesystem extraction failed: command error: while getting library dependencies: exit status 127</a></li><li><a href="https://docs.sylabs.io/guides/3.7/user-guide/build_env.html#temporary-folders">Temporary Folders</a><ul><li>The location for temporary directories defaults to <code>/tmp</code>. Singularity will also respect the environment variable <code>TMPDIR</code>, and both of these locations can be overridden by setting the environment variable <code>SINGULARITY_TMPDIR</code>.</li><li>The temporary directory used during a build must be on a filesystem that has <strong>enough space to hold the entire container image</strong>, uncompressed, including any temporary files that are created and later removed during the build.</li><li>You may need to set <code>SINGULARITY_TMPDIR</code> when building a large container on a system which has a small <code>/tmp</code> filesystem.</li><li><code>$ ls -a /tmp</code></li><li>cleanup: <code>rm -r rootfs*</code></li></ul></li><li>try to add<ul><li><code>export SINGULARITY_TMPDIR="/home/wpsze/ML/NVIDIA-Modulus/singularity_tmp"</code></li><li><code>-B $SINGULARITY_TMPDIR:/tmp</code></li></ul></li></ul><h2 id="running-examples">Running Examples</h2><figure class="highlight console"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs console">223M./modulus<br>9.5G./Modulus.sif<br>926M./modulus-sym<br></code></pre></td></tr></table></figure><h3 id="modulus-examples">Modulus Examples</h3><p>Clone the Modulus repository in your working directory using:</p><figure class="highlight console"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs console">git clone https://github.com/NVIDIA/modulus.git<br></code></pre></td></tr></table></figure><p>To verify the examples run correctly, run these commands:</p><figure class="highlight console"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs console">cd ./modulus/examples/cfd/darcy_fno/<br>pip install warp-lang<br>python train_fno_darcy.py<br></code></pre></td></tr></table></figure><p>If you see the <code>outputs/</code> directory created after the execution of the command (~5 min), the installation is successful.</p><h3 id="modulus-sym-examples">Modulus Sym examples</h3><ul><li>The modulus-sym repository has <strong>Git LFS</strong> enabled. You will need to have <strong>Git LFS</strong> installed for the clone to work correctly.</li></ul><p>Clone the Modulus Sym repository in your working directory using:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">git <span class="hljs-built_in">clone</span> https://github.com/NVIDIA/modulus-sym.git<br></code></pre></td></tr></table></figure><p>To verify the examples run correctly, run these commands:</p><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs vim"><span class="hljs-keyword">cd</span> ./modulus-sym/examples/helmholtz/<br><span class="hljs-keyword">python</span> helmholtz.<span class="hljs-keyword">py</span><br></code></pre></td></tr></table></figure><p>If you see the <code>outputs/</code> directory created after the execution of the command (~5 min), the installation is successful.</p><h4 id="examples">Examples</h4><ol type="1"><li><a href="https://docs.nvidia.com/deeplearning/modulus/modulus-sym-v120/user_guide/foundational/scalar_transport.html">Scalar Transport: 2D Advection Diffusion</a><ol type="1"><li><code>examples/three_fin_2d/heat_sink.py</code></li></ol></li><li><a href="https://docs.nvidia.com/deeplearning/modulus/modulus-sym/user_guide/advanced/2d_heat_transfer.html">Heat Transfer with High Thermal Conductivity | 2d_heat_transfer</a><ol type="1"><li><code>examples/limerock/limerock_hFTB</code></li></ol></li><li><a href="https://docs.nvidia.com/deeplearning/modulus/modulus-sym/user_guide/advanced/parametrized_simulations.html">Parameterized 3D Heat Sink</a></li></ol><h2 id="post-processing-in-modulus">Post Processing in Modulus</h2><ol type="1"><li><a href="https://docs.nvidia.com/deeplearning/modulus/modulus-v2209/user_guide/features/post_processing.html">Post Processing in Modulus</a><ol type="1"><li>var_to_polyvtk(save_var, "./test_file")</li><li>grid_to_vtk(save_var, "./test_file", batch_index=1)</li></ol></li><li><a href="https://docs.nvidia.com/deeplearning/modulus/modulus-core/tutorials/simple_training_example.html">Simple Training and Inference recipe</a></li></ol><h2 id="load-model">Load model</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-built_in">export</span> SINGULARITY_BIND=<span class="hljs-string">&quot;/home/wpsze/ML/NVIDIA-Modulus&quot;</span><br>singularity shell Modulus.sif<br></code></pre></td></tr></table></figure><h1 id="references">References</h1><ol type="1"><li><a href="https://docs.nvidia.com/deeplearning/modulus/getting-started/index.html">NVIDIA Modulus Getting Started</a></li><li><a href="https://indico.ihep.ac.cn/event/17357/sessions/3811/attachments/62339/72133/AI%20For%20Science%20Framework%20modulus.pdf">AI FOR SCIENCE FRAMEWORK: MODULUS</a></li></ol>]]></content>
    
    
    <categories>
      
      <category>ML</category>
      
    </categories>
    
    
    <tags>
      
      <tag>NWP</tag>
      
      <tag>WRF</tag>
      
      <tag>MPAS</tag>
      
      <tag>AI</tag>
      
      <tag>PINN</tag>
      
      <tag>DeepONet</tag>
      
      <tag>ML</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>MPAS | WRF | Atmospheric radiative transfer</title>
    <link href="/2025/02/20/MPAS-WRF-Atmospheric-radiative-transfer/"/>
    <url>/2025/02/20/MPAS-WRF-Atmospheric-radiative-transfer/</url>
    
    <content type="html"><![CDATA[<ul><li>Read <a href="https://waipangsze.github.io/2025/02/12/MPAS-WRF-Solar-Energy/"><strong>MPAS |WRF | Solar Energy</strong></a></li></ul><h1 id="radiative-transfer">Radiative transfer</h1><p><strong>Radiative transfer</strong> (also called <strong>radiation transport</strong>) is the physical phenomenon of energy transfer in the form of electromagnetic radiation. The propagation of radiation through a medium is affected by <em>absorption, emission, and scattering processes</em>. The equation of radiative transfer describes these interactions mathematically.</p><h2 id="intensity">Intensity</h2><p>In physics and many other areas of science and engineering the <strong>intensity</strong> or <strong>flux of radiant energy</strong> is the <em>power</em> transferred per <em>unit area</em>, where the area is measured on the plane perpendicular to the direction of propagation of the energy. In the SI system, it has units watts per square metre (<strong>W/m2</strong>).</p><p>If a point source is radiating energy in all directions (producing a spherical wave), and no energy is absorbed or scattered by the medium, then the intensity decreases in proportion to the distance from the object squared. This is an example of the inverse-square law.</p><p>Applying the law of conservation of energy, if the net power emanating is constant,</p><p><span class="math display">\[P = \int \mathbf{I} \cdot d\mathbf{A},\]</span></p><p>where</p><ul><li><span class="math inline">\(P\)</span> is the net power (Watts) radiated;</li><li><span class="math inline">\(\mathbf{I}\)</span> is the intensity vector as a function of position;</li><li>the magnitude <span class="math inline">\(|\mathbf{I}|\)</span> is the intensity as a function of position;</li><li><span class="math inline">\(d\mathbf{A}\)</span> is a differential element of a closed surface that contains the source.</li></ul><h2 id="intensity-as-a-function-of-position-on-earths-surface">Intensity as a Function of Position on Earth’s Surface</h2><h3 id="understand-the-power-output-of-the-sun-luminosity"><strong>Understand the Power Output of the Sun (Luminosity)</strong></h3><p>The total power (or luminosity) of the Sun, <span class="math inline">\(P_{\text{Sun}}\)</span> , represents the total energy it emits per unit time across all wavelengths and directions. This is a well-known value in astrophysics, and as of my latest knowledge update, the Sun’s luminosity is approximately:</p><p><span class="math display">\[\begin{align}P/A &amp;= \sigma T^4 \\\sigma &amp;= 5.67×10^{-8}\\R_{\text{Sun}} &amp;= 695500×1000 m \\T_{\text{Sun}} &amp;= 5778 K \\P_{\text{Sun}} &amp;\approx 3.828 \times 10^{26} \, \text{W} \, (\text{watts})\end{align}\tag{1}\]</span></p><p>This is the net power radiated by the Sun into space, assuming it behaves as a <strong>near-perfect blackbody emitter</strong> at a <em>surface temperature</em> of about <span class="math inline">\(5,778 K\)</span>.</p><h3 id="earths-distance-from-the-sun">Earth’s Distance from the Sun:</h3><p>The average distance from the Sun to Earth is:</p><p><span class="math display">\[r \approx 1 \, \text{AU} = 1.496 \times 10^{11} \, \text{m}\]</span></p><p>Now, calculate <span class="math inline">\(r^2\)</span>:</p><p><span class="math display">\[r^2 = (1.496 \times 10^{11})^2 = 2.238 \times 10^{22} \, \text{m}^2\]</span></p><p>Calculate <span class="math inline">\(4 \pi r^2\)</span>:</p><p><span class="math display">\[4 \pi r^2 \approx 4 \times 3.1416 \times 2.238 \times 10^{22} \approx 2.813 \times 10^{23} \, \text{m}^2\]</span></p><p>Now, compute the intensity at Earth’s distance (top of the atmosphere, assuming no atmospheric effects):</p><p><span class="math display">\[I = \frac{3.828 \times 10^{26}}{2.813 \times 10^{23}} \approx 1,361 \, \text{W/m}^2\]</span></p><h3 id="geometry-of-earths-surface"><strong>Geometry of Earth’s Surface</strong></h3><p>Earth is a sphere with a radius <span class="math inline">\(R_{\text{Earth}} \approx 6,371 \, \text{km} = 6.371 \times 10^6 \, \text{m}\)</span>. The intensity (flux) at the top of the atmosphere <span class="math inline">\((1,361 W/m²)\)</span> is the incident flux perpendicular to the Sun’s rays. However, on Earth’s surface, the intensity varies due to:</p><ul><li>The angle of incidence (cosine effect): The flux decreases as <span class="math inline">\(\cos\theta\)</span>, where <span class="math inline">\(\theta\)</span> is the zenith angle (angle from the vertical).</li><li>The curvature of Earth: Only a portion of Earth’s surface is illuminated at any time, and the flux spreads over the illuminated hemisphere.</li></ul><h3 id="assuming-perpendicular-incidence-at-the-sub-solar-point"><strong>Assuming Perpendicular Incidence at the Sub-Solar Point</strong></h3><p>At the sub-solar point (directly under the Sun, where <span class="math inline">\(\theta = 0\)</span>), the intensity on Earth’s surface (ignoring atmospheric effects, as per the image) would still be <span class="math inline">\(1,361 W/m²\)</span>, because no energy is absorbed or scattered.</p><p>Across the rest of the illuminated hemisphere, the intensity decreases with <span class="math inline">\(\cos\theta\)</span>. For a point on Earth’s surface at zenith angle <span class="math inline">\(\theta\)</span>, the flux is:</p><p><span class="math display">\[I_{\text{surface}} = I \cdot \cos\theta = 1,361 \cdot \cos\theta \, \text{W/m}^2\]</span></p><p>The differential area element on a sphere is <span class="math inline">\(dA = R_{\text{Earth}}^2 \sin\theta \, d\theta \, d\phi\)</span>, where <span class="math inline">\(\theta\)</span> is the zenith angle (0 to <span class="math inline">\(\pi/2\)</span> for the illuminated hemisphere) and <span class="math inline">\(\phi\)</span> is the azimuthal angle (0 to <span class="math inline">\(2\pi\)</span>).</p><p>The intensity at angle <span class="math inline">\(\theta\)</span> is <span class="math inline">\(I \cdot \cos\theta\)</span>. The power <span class="math inline">\(dP\)</span> through a differential area <span class="math inline">\(dA\)</span> is:</p><p><span class="math display">\[dP = I \cdot \cos\theta \cdot dA = (1,361 \cdot \cos\theta) \cdot (R_{\text{Earth}}^2 \sin\theta \, d\theta \, d\phi)\]</span></p><p>Integrate over <span class="math inline">\(\theta\)</span> from 0 to <span class="math inline">\(\pi/2\)</span> and <span class="math inline">\(\phi\)</span> from 0 to <span class="math inline">\(2\pi\)</span>:</p><p><span class="math display">\[P_{\text{Earth}} = \int_0^{2\pi} \int_0^{\pi/2} (1,361 \cdot \cos\theta) \cdot (R_{\text{Earth}}^2 \sin\theta) \, d\theta \, d\phi\]</span></p><p>First, integrate over <span class="math inline">\(\phi\)</span>:</p><p><span class="math display">\[\int_0^{2\pi} d\phi = 2\pi\]</span></p><p>Now, integrate over <span class="math inline">\(\theta\)</span>:</p><p><span class="math display">\[\int_0^{\pi/2} (1,361 \cdot \cos\theta) \cdot (\sin\theta) \, d\theta = 1,361 \cdot R_{\text{Earth}}^2 \int_0^{\pi/2} \sin\theta \cos\theta \, d\theta\]</span></p><p>Use the substitution <span class="math inline">\(u = \sin\theta\)</span>, so <span class="math inline">\(du = \cos\theta \, d\theta\)</span>. The limits change from <span class="math inline">\(\theta = 0\)</span> to <span class="math inline">\(\pi/2\)</span> (i.e., <span class="math inline">\(u = 0\)</span> to 1):</p><p><span class="math display">\[\int_0^{\pi/2} \sin\theta \cos\theta \, d\theta = \int_0^1 u \, du = \left[ \frac{u^2}{2} \right]_0^1 = \frac{1}{2}\]</span></p><p>So:</p><p><span class="math display">\[P_{\text{Earth}} = 1,361 \cdot R_{\text{Earth}}^2 \cdot 2\pi \cdot \frac{1}{2} = 1,361 \cdot \pi \cdot R_{\text{Earth}}^2\]</span></p><p>Substitute <span class="math inline">\(R_{\text{Earth}} = 6.371 \times 10^6 \, \text{m}\)</span>:</p><p><span class="math display">\[R_{\text{Earth}}^2 = (6.371 \times 10^6)^2 = 4.059 \times 10^{13} \, \text{m}^2\]</span></p><p><span class="math display">\[P_{\text{Earth}} = 1,361 \cdot \pi \cdot 4.059 \times 10^{13}\]</span></p><p><span class="math display">\[P_{\text{Earth}} \approx 4,276 \cdot 4.059 \times 10^{13} \approx 1.736 \times 10^{17} \, \text{W}\]</span></p><p>This is the total power received by Earth’s illuminated hemisphere, ignoring atmospheric effects. However, note that the actual power received at the surface is less due to atmospheric absorption and scattering.</p><h1 id="more">More</h1><h2 id="solutions-to-the-equation-of-radiative-transfer">Solutions to the equation of radiative transfer</h2><p>Solutions to the equation of radiative transfer form an enormous body of work. The differences however, are essentially due to the various forms for the emission and absorption coefficients. If scattering is ignored, then a general steady state solution in terms of the emission and absorption coefficients may be written:</p><p><span class="math display">\[I_\nu(s)=I_\nu(s_0)e^{-\tau_\nu(s_0,s)}+\int_{s_0}^s j_\nu(s&#39;)e^{-\tau_\nu(s&#39;,s)}\,ds&#39;\]</span></p><p>where <span class="math inline">\(\tau_\nu(s_1,s_2)\)</span> is the <strong>optical depth</strong> of the medium between positions <span class="math inline">\(s_1\)</span> and <span class="math inline">\(s_2\)</span>:</p><p><span class="math display">\[\tau_\nu(s_1,s_2) \ \stackrel{\mathrm{def}}{=}\ \int_{s_1}^{s_2} \alpha_\nu(s)\,ds\]</span></p><h2 id="radiance-發射率">radiance 發射率</h2><p>光源的 <code>輻射率</code> 或 <code>輻亮度</code> <strong>(radiance)</strong>，是描述非點光源時光源單位面積強度的物理量，定義為在指定方向上的單位<strong>立體角</strong>和垂直此方向的單位<strong>面積</strong>上的<strong>輻射通量</strong>，記為<strong>L</strong>。</p><p>In radiometry, radiance is the radiant flux emitted, reflected, transmitted or received <strong>by a given surface</strong>, per unit solid angle per unit projected area. Radiance is used to characterize diffuse emission and reflection of electromagnetic radiation, and to quantify emission of neutrinos and other particles. The SI unit of radiance is the watt per steradian per square metre <span class="math inline">\((W sr^{−1} m^{−2})\)</span>. It is a directional quantity: the radiance of a surface depends on the direction from which it is being observed.</p><p>The related quantity spectral radiance is the radiance of a surface per unit frequency or wavelength, depending on whether the spectrum is taken as a function of frequency or of wavelength.</p><p>Historically, radiance was called "<strong>intensity</strong>" and spectral radiance was called "<strong>specific intensity</strong>". Many fields still use this nomenclature. It is especially dominant in heat transfer, astrophysics and astronomy. "Intensity" has many other meanings in physics, with the most common being power per unit area (<strong>so the radiance is the intensity per solid angle in this case</strong>).</p><p><span class="math display">\[L=\frac{\partial^2 \Phi}{\cos \theta \partial A \partial \Omega}\]</span></p><p>其中：<strong><span class="math inline">\(\Phi\)</span></strong> 是<strong>輻射通量</strong>，單位<strong>瓦特</strong>（W）；<strong><span class="math inline">\(\Omega\)</span></strong>是<strong>立體角</strong>，單位<strong>球面度</strong> <strong>(sr)</strong>。</p><div class="group-image-container"><div class="group-image-row"><div class="group-image-wrap"><img src="https://i.imgur.com/GzqyGa8.png" /></div><div class="group-image-wrap"><img src="https://i.imgur.com/6KeXzXp.png" /></div><div class="group-image-wrap"><img src="https://i.imgur.com/PdvPtL0.png" /></div></div><div class="group-image-row"><div class="group-image-wrap"><img src="https://i.imgur.com/R2hipMd.png" /></div></div></div><h1 id="references">References</h1><ol type="1"><li><a href="https://en.wikipedia.org/wiki/Atmospheric_radiative_transfer_codes">Atmospheric radiative transfer codes</a></li><li><a href="https://www.ess.uci.edu/~yu/class/ess200a/lecture.2.global.pdf">lecture.2.global.pdf</a></li><li><a href="https://www.cv.nrao.edu/~sransom/web/Ch2.html">Radiation Fundamentals</a></li><li><a href="https://pages.mtu.edu/~scarn/teaching/GE4250/radiation_lecture_slides.pdf">Properties of Radiation</a></li><li><a href="https://labs.phys.utk.edu/mbreinig/phys421/modules/m5/Radiometry.html">Radiometry and Photometry (<strong>Recommend</strong>)</a><ol type="1"><li>To specify the amount of energy emitted by a source, we use the quantities.<ol type="1"><li>Energy</li><li>Power</li><li>Power per unit area</li><li>Power per unit solid angle</li><li>Power per unit solid angle per unit projected area</li></ol></li><li>To specify the amount of energy received by a detector, we use one quantity.<ol type="1"><li>Power per unit area</li></ol></li></ol></li><li><a href="https://www.ulethbridge.ca/phy/naylor/documents/pdf/btram.pdf">Chapman, I. M., Naylor, D. A., Gom, B., Querel, R. R., &amp; Davis-Imhof, P. (2010). Btram: An interactive atmospheric radiative transfer model. In 30th Canadian Symposium.</a></li></ol>]]></content>
    
    
    <categories>
      
      <category>MPAS</category>
      
    </categories>
    
    
    <tags>
      
      <tag>NWP</tag>
      
      <tag>WRF</tag>
      
      <tag>MPAS</tag>
      
      <tag>ERA5</tag>
      
      <tag>GFS</tag>
      
      <tag>RRTM</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>MPAS | WRF | Extract subset of GFS GRIB files</title>
    <link href="/2025/02/19/MPAS-WRF-Extract-GFS-GRIB-files/"/>
    <url>/2025/02/19/MPAS-WRF-Extract-GFS-GRIB-files/</url>
    
    <content type="html"><![CDATA[<h1 id="gfs-subset-download">GFS subset download</h1><h2 id="nomads-data-at-ncep">NOMADS Data at NCEP</h2><ul><li><a href="https://nomads.ncep.noaa.gov/" class="uri">https://nomads.ncep.noaa.gov/</a></li><li><a href="https://nomads.ncep.noaa.gov/gribfilter.php?ds=gfs_0p25_1hr" class="uri">https://nomads.ncep.noaa.gov/gribfilter.php?ds=gfs_0p25_1hr</a></li><li>Example: <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs URL">https://nomads.ncep.noaa.gov/cgi-bin/filter_gfs_0p25_1hr.pl?dir=%2Fgfs.20250228%2F00%2Fatmos&amp;file=gfs.t00z.pgrb2.0p25.anl&amp;var_TMP=on&amp;var_U-GWD=on&amp;var_V-GWD=on&amp;all_lev=on<br></code></pre></td></tr></table></figure></li><li>Dowload script:     <div class="fold">      <div class="fold-title fold-info collapsed" data-toggle="collapse" href="#collapse-dcdac752" role="button" aria-expanded="false" aria-controls="collapse-dcdac752">        <div class="fold-arrow">▶</div>download_gfs.sh      </div>      <div class="fold-collapse collapse" id="collapse-dcdac752">        <div class="fold-content">          <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-meta">#!/bin/bash</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment"># define URL</span><br><span class="hljs-comment">#</span><br>workdir=/home/wpsze/mpas/GFS/<br>hr=00<br><span class="hljs-comment">#date_st=20240920</span><br>date_st=$(<span class="hljs-built_in">date</span> -d <span class="hljs-string">&quot;today -1 days&quot;</span> +%Y%m%d)<br><br><span class="hljs-comment">#wget </span><br><br><span class="hljs-keyword">for</span> iday <span class="hljs-keyword">in</span> &#123;0..0..1&#125;; <span class="hljs-keyword">do</span><br>    <br>    idate=$(<span class="hljs-built_in">date</span> -d <span class="hljs-string">&quot;<span class="hljs-variable">$date_st</span> + <span class="hljs-variable">$iday</span> days&quot;</span> +%Y%m%d)<br>    <span class="hljs-built_in">echo</span> <span class="hljs-variable">$date_st</span> <span class="hljs-variable">$idate</span><br><span class="hljs-keyword">for</span> fhr <span class="hljs-keyword">in</span> &#123;000..120..1&#125;; <span class="hljs-keyword">do</span><br><span class="hljs-comment">#for fhr in &#123;076..76..1&#125;; do</span><br><br><br>URL=<span class="hljs-string">&quot;https://nomads.ncep.noaa.gov/cgi-bin/filter_gfs_0p25_1hr.pl?\</span><br><span class="hljs-string">dir=%2Fgfs.<span class="hljs-variable">$&#123;idate&#125;</span>%2F<span class="hljs-variable">$&#123;hr&#125;</span>%2Fatmos&amp;\</span><br><span class="hljs-string">file=gfs.t<span class="hljs-variable">$&#123;hr&#125;</span>z.pgrb2.0p25.f<span class="hljs-variable">$&#123;fhr&#125;</span>&amp;\</span><br><span class="hljs-string">var_HGT=on&amp;var_PRATE=on&amp;var_PRES=on&amp;var_PRMSL=on&amp;var_RH=on&amp;var_TMP=on&amp;var_UGRD=on&amp;var_VGRD=on&amp;\</span><br><span class="hljs-string">lev_2_m_above_ground=on&amp;lev_10_m_above_ground=on&amp;lev_80_m_above_ground=on&amp;lev_100_m_above_ground=on&amp;\</span><br><span class="hljs-string">lev_1000_m_above_ground=on&amp;lev_4000_m_above_ground=on&amp;lev_1000_mb=on&amp;lev_975_mb=on&amp;lev_950_mb=on&amp;\</span><br><span class="hljs-string">lev_925_mb=on&amp;lev_900_mb=on&amp;lev_850_mb=on&amp;lev_700_mb=on&amp;lev_600_mb=on&amp;lev_500_mb=on&amp;lev_surface=on&amp;lev_mean_sea_level=on&amp;\</span><br><span class="hljs-string">subregion=&amp;toplat=65&amp;leftlon=70&amp;rightlon=140&amp;bottomlat=10&quot;</span><br><br>yyyymm=<span class="hljs-variable">$&#123;idate:0:6&#125;</span><br>datapath=<span class="hljs-variable">$workdir</span>/0p25/<span class="hljs-variable">$yyyymm</span>/<span class="hljs-variable">$idate</span>/<br><span class="hljs-built_in">mkdir</span> -p <span class="hljs-variable">$datapath</span><br><br><span class="hljs-comment"># download file</span><br><span class="hljs-comment">#curl &quot;$URL&quot; -o download_test$fhr.grb</span><br>wget <span class="hljs-string">&quot;<span class="hljs-variable">$URL</span>&quot;</span> -O <span class="hljs-variable">$datapath</span>/gfs.t<span class="hljs-variable">$&#123;hr&#125;</span>z.pgrb2.0p25.f<span class="hljs-variable">$&#123;fhr&#125;</span>.grb<br><span class="hljs-comment"># add a sleep to prevent a denial of service in case of missing file</span><br><span class="hljs-built_in">sleep</span> 3<br><span class="hljs-keyword">done</span><br><span class="hljs-keyword">done</span><br></code></pre></td></tr></table></figure>        </div>      </div>    </div></li></ul><figure><img src="https://i.imgur.com/uC0QDnd.png" alt="NCEP GFS Forecasts (0.25 degree grid)" width="500" /><figcaption>NCEP GFS Forecasts (0.25 degree grid)</figcaption></figure><h2 id="rda.ucar.edu">rda.ucar.edu</h2><ul><li><a href="https://rda.ucar.edu/datasets/d084001/dataaccess/#" class="uri">https://rda.ucar.edu/datasets/d084001/dataaccess/#</a><ul><li>Sign up with orcid</li><li>Customizable Data Requests &gt; Subsetting</li><li>Waiting for completion</li><li>csh/python scripts are provided</li></ul></li></ul><div class="group-image-container"><div class="group-image-row"><div class="group-image-wrap"><img src="https://i.imgur.com/GO7mmRR.png" /></div></div><div class="group-image-row"><div class="group-image-wrap"><img src="https://i.imgur.com/gyRwXFJ.png" /></div><div class="group-image-wrap"><img src="https://i.imgur.com/HDtKiPl.png" /></div></div></div>    <div class="fold">      <div class="fold-title fold-info collapsed" data-toggle="collapse" href="#collapse-6ae3e036" role="button" aria-expanded="false" aria-controls="collapse-6ae3e036">        <div class="fold-arrow">▶</div>rda-download.csh      </div>      <div class="fold-collapse collapse" id="collapse-6ae3e036">        <div class="fold-content">          <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-meta">#!/usr/bin/env csh</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment"># c-shell script to download selected files from rda.ucar.edu using Wget</span><br><span class="hljs-comment"># NOTE: if you want to run under a different shell, make sure you change</span><br><span class="hljs-comment">#       the &#x27;set&#x27; commands according to your shell&#x27;s syntax</span><br><span class="hljs-comment"># after you save the file, don&#x27;t forget to make it executable</span><br><span class="hljs-comment">#   i.e. - &quot;chmod 755 &lt;name_of_script&gt;&quot;</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment"># Experienced Wget Users: add additional command-line flags to &#x27;opts&#x27; here</span><br><span class="hljs-comment">#   Use the -r (--recursive) option with care</span><br><span class="hljs-comment">#   Do NOT use the -b (--background) option - simultaneous file downloads</span><br><span class="hljs-comment">#       can cause your data access to be blocked</span><br><span class="hljs-built_in">set</span> opts = <span class="hljs-string">&quot;-N&quot;</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment"># Check wget version.  Set the --no-check-certificate option </span><br><span class="hljs-comment"># if wget version is 1.10 or higher</span><br><span class="hljs-built_in">set</span> v = `wget -V |grep <span class="hljs-string">&#x27;GNU Wget &#x27;</span> | <span class="hljs-built_in">cut</span> -d <span class="hljs-string">&#x27; &#x27;</span> -f 3`<br><span class="hljs-built_in">set</span> a = `<span class="hljs-built_in">echo</span> <span class="hljs-variable">$v</span> | <span class="hljs-built_in">cut</span> -d <span class="hljs-string">&#x27;.&#x27;</span> -f 1`<br><span class="hljs-built_in">set</span> b = `<span class="hljs-built_in">echo</span> <span class="hljs-variable">$v</span> | <span class="hljs-built_in">cut</span> -d <span class="hljs-string">&#x27;.&#x27;</span> -f 2`<br><span class="hljs-keyword">if</span>(100 * <span class="hljs-variable">$a</span> + <span class="hljs-variable">$b</span> &gt; 109) <span class="hljs-keyword">then</span><br>  <span class="hljs-built_in">set</span> cert_opt = <span class="hljs-string">&quot;--no-check-certificate&quot;</span><br><span class="hljs-keyword">else</span><br>  <span class="hljs-built_in">set</span> cert_opt = <span class="hljs-string">&quot;&quot;</span><br>endif<br><br><span class="hljs-built_in">set</span> filelist= ( \<br>  https://request.rda.ucar.edu/dsrqst/SZE782753/TarFiles/gfs.0p25.2024123000.f384-25.2025011200.f195.grib2.tar \<br>  https://request.rda.ucar.edu/dsrqst/SZE782753/TarFiles/gfs.0p25.2025011200.f198-25.2025011618.f135.grib2.tar \<br>  https://request.rda.ucar.edu/dsrqst/SZE782753/TarFiles/gfs.0p25.2025011618.f138-25.2025012100.f360.grib2.tar \<br>  https://request.rda.ucar.edu/dsrqst/SZE782753/TarFiles/gfs.0p25.2025012100.f366-25.2025012512.f129.grib2.tar \<br>  https://request.rda.ucar.edu/dsrqst/SZE782753/TarFiles/gfs.0p25.2025012512.f132-25.2025012918.f330.grib2.tar \<br>  https://request.rda.ucar.edu/dsrqst/SZE782753/TarFiles/gfs.0p25.2025012918.f336-25.2025020306.f105.grib2.tar \<br>  https://request.rda.ucar.edu/dsrqst/SZE782753/TarFiles/gfs.0p25.2025020306.f108-25.2025020712.f228.grib2.tar \<br>  https://request.rda.ucar.edu/dsrqst/SZE782753/TarFiles/gfs.0p25.2025020712.f231-25.2025021200.f003.grib2.tar \<br>  https://request.rda.ucar.edu/dsrqst/SZE782753/TarFiles/gfs.0p25.2025021200.f006-25.2025021606.f084.grib2.tar \<br>  https://request.rda.ucar.edu/dsrqst/SZE782753/TarFiles/gfs.0p25.2025021606.f087-25.2025021712.f384.grib2.tar \<br>)<br><span class="hljs-keyword">while</span>(<span class="hljs-variable">$#filelist</span> &gt; 0)<br>  <span class="hljs-built_in">set</span> syscmd = <span class="hljs-string">&quot;wget <span class="hljs-variable">$cert_opt</span> <span class="hljs-variable">$opts</span> <span class="hljs-variable">$filelist</span>[1]&quot;</span><br>  <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;<span class="hljs-variable">$syscmd</span> ...&quot;</span><br>  <span class="hljs-variable">$syscmd</span><br>  <span class="hljs-built_in">shift</span> filelist<br>end<br></code></pre></td></tr></table></figure>        </div>      </div>    </div>    <div class="fold">      <div class="fold-title fold-info collapsed" data-toggle="collapse" href="#collapse-9c51fa20" role="button" aria-expanded="false" aria-controls="collapse-9c51fa20">        <div class="fold-arrow">▶</div>rda-download.py      </div>      <div class="fold-collapse collapse" id="collapse-9c51fa20">        <div class="fold-content">          <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/env python</span><br><span class="hljs-string">&quot;&quot;&quot; </span><br><span class="hljs-string">Python script to download selected files from rda.ucar.edu.</span><br><span class="hljs-string">After you save the file, don&#x27;t forget to make it executable</span><br><span class="hljs-string">i.e. - &quot;chmod 755 &lt;name_of_script&gt;&quot;</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-keyword">import</span> sys, os<br><span class="hljs-keyword">from</span> urllib.request <span class="hljs-keyword">import</span> build_opener<br><br>opener = build_opener()<br><br>filelist = [<br>  <span class="hljs-string">&#x27;https://request.rda.ucar.edu/dsrqst/SZE782753/TarFiles/gfs.0p25.2024123000.f384-25.2025011200.f195.grib2.tar&#x27;</span>,<br>  <span class="hljs-string">&#x27;https://request.rda.ucar.edu/dsrqst/SZE782753/TarFiles/gfs.0p25.2025011200.f198-25.2025011618.f135.grib2.tar&#x27;</span>,<br>  <span class="hljs-string">&#x27;https://request.rda.ucar.edu/dsrqst/SZE782753/TarFiles/gfs.0p25.2025011618.f138-25.2025012100.f360.grib2.tar&#x27;</span>,<br>  <span class="hljs-string">&#x27;https://request.rda.ucar.edu/dsrqst/SZE782753/TarFiles/gfs.0p25.2025012100.f366-25.2025012512.f129.grib2.tar&#x27;</span>,<br>  <span class="hljs-string">&#x27;https://request.rda.ucar.edu/dsrqst/SZE782753/TarFiles/gfs.0p25.2025012512.f132-25.2025012918.f330.grib2.tar&#x27;</span>,<br>  <span class="hljs-string">&#x27;https://request.rda.ucar.edu/dsrqst/SZE782753/TarFiles/gfs.0p25.2025012918.f336-25.2025020306.f105.grib2.tar&#x27;</span>,<br>  <span class="hljs-string">&#x27;https://request.rda.ucar.edu/dsrqst/SZE782753/TarFiles/gfs.0p25.2025020306.f108-25.2025020712.f228.grib2.tar&#x27;</span>,<br>  <span class="hljs-string">&#x27;https://request.rda.ucar.edu/dsrqst/SZE782753/TarFiles/gfs.0p25.2025020712.f231-25.2025021200.f003.grib2.tar&#x27;</span>,<br>  <span class="hljs-string">&#x27;https://request.rda.ucar.edu/dsrqst/SZE782753/TarFiles/gfs.0p25.2025021200.f006-25.2025021606.f084.grib2.tar&#x27;</span>,<br>  <span class="hljs-string">&#x27;https://request.rda.ucar.edu/dsrqst/SZE782753/TarFiles/gfs.0p25.2025021606.f087-25.2025021712.f384.grib2.tar&#x27;</span><br>]<br><br><span class="hljs-keyword">for</span> file <span class="hljs-keyword">in</span> filelist:<br>    ofile = os.path.basename(file)<br>    sys.stdout.write(<span class="hljs-string">&quot;downloading &quot;</span> + ofile + <span class="hljs-string">&quot; ... &quot;</span>)<br>    sys.stdout.flush()<br>    infile = opener.<span class="hljs-built_in">open</span>(file)<br>    outfile = <span class="hljs-built_in">open</span>(ofile, <span class="hljs-string">&quot;wb&quot;</span>)<br>    outfile.write(infile.read())<br>    outfile.close()<br>    sys.stdout.write(<span class="hljs-string">&quot;done\n&quot;</span>)<br></code></pre></td></tr></table></figure>        </div>      </div>    </div><h1 id="micromamba-env-setup">Micromamba env setup</h1><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs yml"> <span class="hljs-string">$</span> <span class="hljs-string">cat</span> <span class="hljs-string">list.yml</span> <br><span class="hljs-attr">name:</span> <span class="hljs-string">PGW</span><br><span class="hljs-attr">channels:</span><br><span class="hljs-bullet">-</span> <span class="hljs-string">anaconda</span><br><span class="hljs-bullet">-</span> <span class="hljs-string">conda-forge</span><br><span class="hljs-attr">dependencies:</span><br><span class="hljs-bullet">-</span> <span class="hljs-string">conda-forge::cdo</span><br><span class="hljs-bullet">-</span> <span class="hljs-string">conda-forge::dask</span><br><span class="hljs-bullet">-</span> <span class="hljs-string">matplotlib</span><br><span class="hljs-bullet">-</span> <span class="hljs-string">python=3.11</span><br><span class="hljs-bullet">-</span> <span class="hljs-string">scipy</span><br><span class="hljs-bullet">-</span> <span class="hljs-string">conda-forge::wgrib</span><br></code></pre></td></tr></table></figure><h1 id="grib-checking">grib checking</h1><p>take GFS-wave model as example,</p><ul><li><code>grib_ls gfs.t00z.global.0p16.f000.grib2</code>     <div class="fold">      <div class="fold-title fold-info collapsed" data-toggle="collapse" href="#collapse-90469042" role="button" aria-expanded="false" aria-controls="collapse-90469042">        <div class="fold-arrow">▶</div>gfs.t00z.global.0p16.f000.grib2      </div>      <div class="fold-collapse collapse" id="collapse-90469042">        <div class="fold-content">          <figure class="highlight console"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs console">gfs.t00z.global.0p16.f000.grib2<br>edition      centre       date         dataType     gridType     stepRange    typeOfLevel  level        shortName    packingType  <br>2            kwbc         20250227     fc           regular_ll   0            surface      1            ws           grid_jpeg   <br>2            kwbc         20250227     fc           regular_ll   0            surface      1            wdir         grid_jpeg   <br>2            kwbc         20250227     fc           regular_ll   0            surface      1            u            grid_jpeg   <br>2            kwbc         20250227     fc           regular_ll   0            surface      1            v            grid_jpeg   <br>2            kwbc         20250227     fc           regular_ll   0            surface      1            swh          grid_jpeg   <br>2            kwbc         20250227     fc           regular_ll   0            surface      1            perpw        grid_jpeg   <br>2            kwbc         20250227     fc           regular_ll   0            surface      1            dirpw        grid_jpeg   <br>2            kwbc         20250227     fc           regular_ll   0            surface      1            shww         grid_jpeg   <br>2            kwbc         20250227     fc           regular_ll   0            orderedSequenceData  1            swell        grid_jpeg   <br>2            kwbc         20250227     fc           regular_ll   0            orderedSequenceData  2            swell        grid_jpeg   <br>2            kwbc         20250227     fc           regular_ll   0            orderedSequenceData  3            swell        grid_jpeg   <br>2            kwbc         20250227     fc           regular_ll   0            surface      1            mpww         grid_jpeg   <br>2            kwbc         20250227     fc           regular_ll   0            orderedSequenceData  1            swper        grid_jpeg   <br>2            kwbc         20250227     fc           regular_ll   0            orderedSequenceData  2            swper        grid_jpeg   <br>2            kwbc         20250227     fc           regular_ll   0            orderedSequenceData  3            swper        grid_jpeg   <br>2            kwbc         20250227     fc           regular_ll   0            surface      1            wvdir        grid_jpeg   <br>2            kwbc         20250227     fc           regular_ll   0            orderedSequenceData  1            swdir        grid_jpeg   <br>2            kwbc         20250227     fc           regular_ll   0            orderedSequenceData  2            swdir        grid_jpeg   <br>2            kwbc         20250227     fc           regular_ll   0            orderedSequenceData  3            swdir        grid_jpeg   <br>19 of 19 messages in gfs.t00z.global.0p16.f000.grib2<br><br>19 of 19 total messages in 1 files<br></code></pre></td></tr></table></figure>        </div>      </div>    </div></li><li>re-download dataset that only contains surface variables.</li><li><code>grib_to_netcdf gfs.t00z.global.0p16.f000.grib2 -o test.nc</code></li><li><code>ncvis/ncview test.nc</code></li></ul><h1 id="read-gfs-grib2-files">Read GFS grib2 files</h1><p>To process a CSV file containing station information (latitude and longitude) and extract weather data from GFS GRIB files, you can follow the steps below. This example assumes you have a CSV file named <code>stations.csv</code> with columns for station names, latitude, and longitude.</p><figure class="highlight console"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs console"><span class="hljs-meta prompt_"> $ </span><span class="language-bash">grib_ls ./subset-GFS/gfs.0p25.2025021200.f006.grib2</span><br>./subset-GFS/gfs.0p25.2025021200.f006.grib2<br>edition      centre       date         dataType     gridType     typeOfLevel  level        stepRange    shortName    packingType  <br>2            kwbc         20250212     fc           regular_ll   surface      0            0-6          dswrf        grid_complex_spatial_differencing <br>1 of 1 messages in ./subset-GFS/gfs.0p25.2025021200.f006.grib2<br></code></pre></td></tr></table></figure><h2 id="step-1-prepare-your-csv-file">Step 1: Prepare Your CSV File</h2><p>Ensure your <code>stations.csv</code> has the following structure:</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">station</span>,latitude,longitude<br><span class="hljs-attribute">Station1</span>,<span class="hljs-number">22</span>.<span class="hljs-number">3</span>,<span class="hljs-number">114</span>.<span class="hljs-number">2</span><br><span class="hljs-attribute">Station2</span>,<span class="hljs-number">22</span>.<span class="hljs-number">6</span>,<span class="hljs-number">114</span>.<span class="hljs-number">6</span><br></code></pre></td></tr></table></figure><h2 id="step-2-code-to-extract-data-and-save-to-csv">Step 2: Code to Extract Data and Save to CSV</h2><p>Here's a complete Python script that reads the station information, extracts the required data from the GRIB files, and writes the results to a new CSV file.</p>    <div class="fold">      <div class="fold-title fold-info collapsed" data-toggle="collapse" href="#collapse-5d5d193e" role="button" aria-expanded="false" aria-controls="collapse-5d5d193e">        <div class="fold-arrow">▶</div>extract_GFS.py      </div>      <div class="fold-collapse collapse" id="collapse-5d5d193e">        <div class="fold-content">          <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/bin/python</span><br><span class="hljs-keyword">import</span> xarray <span class="hljs-keyword">as</span> xr<br><span class="hljs-keyword">import</span> pandas <span class="hljs-keyword">as</span> pd<br><br><span class="hljs-comment"># Step 1: Load the station data</span><br>stations = pd.read_csv(<span class="hljs-string">&#x27;station.csv&#x27;</span>)<br><br><span class="hljs-comment"># Step 2: Initialize an empty list to store results</span><br>results = []<br><br><span class="hljs-comment"># Step 3: Load GFS GRIB files</span><br><span class="hljs-comment"># Replace &#x27;path_to_grib_files/*.grib&#x27; with your actual path to the GRIB files</span><br>grib_files = <span class="hljs-string">&#x27;./subset-GFS/gfs.0p25.2025021200.f006.grib2&#x27;</span><br><br><span class="hljs-comment"># Step 4: Open the GRIB files using xarray</span><br><span class="hljs-comment"># ds = xr.open_mfdataset(grib_files, engine=&#x27;cfgrib&#x27;, combine=&#x27;by_coords&#x27;)</span><br>ds = xr.open_dataset(grib_files, engine=<span class="hljs-string">&#x27;cfgrib&#x27;</span>) <span class="hljs-comment">#,backend_kwargs=&#123;&#x27;filter_by_keys&#x27;: &#123;&#x27;typeOfLevel&#x27;: &#x27;isobaricInhPa&#x27;&#125;&#125;)</span><br><br><span class="hljs-comment"># Print the names of the variables</span><br><span class="hljs-built_in">print</span>(ds)<br><br><span class="hljs-comment"># Step 5: Extract data for each station</span><br><span class="hljs-keyword">for</span> index, row <span class="hljs-keyword">in</span> stations.iterrows():<br>    lat = row[<span class="hljs-string">&#x27;latitude&#x27;</span>]<br>    lon = row[<span class="hljs-string">&#x27;longitude&#x27;</span>]<br>    <br>    <span class="hljs-comment"># Step 6: Interpolate the data using bilinear interpolation</span><br>    <span class="hljs-comment"># t2m = ds[&#x27;t2m&#x27;].interp(latitude=lat, longitude=lon, method=&#x27;linear&#x27;).values</span><br>    <span class="hljs-comment"># u10 = ds[&#x27;u10&#x27;].interp(latitude=lat, longitude=lon, method=&#x27;linear&#x27;).values</span><br>    <span class="hljs-comment"># v10 = ds[&#x27;v10&#x27;].interp(latitude=lat, longitude=lon, method=&#x27;linear&#x27;).values</span><br>    <span class="hljs-comment"># rh2m = ds[&#x27;rh2m&#x27;].interp(latitude=lat, longitude=lon, method=&#x27;linear&#x27;).values</span><br>    sdswrf = ds[<span class="hljs-string">&#x27;sdswrf&#x27;</span>].interp(latitude=lat, longitude=lon, method=<span class="hljs-string">&#x27;linear&#x27;</span>).values<br>    <br>    <span class="hljs-comment"># Step 7: Append the results</span><br>    results.append(&#123;<br>        <span class="hljs-string">&#x27;station&#x27;</span>: row[<span class="hljs-string">&#x27;station&#x27;</span>],<br>        <span class="hljs-string">&#x27;sdswrf&#x27;</span>: sdswrf<br>        <span class="hljs-comment"># &#x27;t2m&#x27;: t2m,</span><br>        <span class="hljs-comment"># &#x27;u10&#x27;: u10,</span><br>        <span class="hljs-comment"># &#x27;v10&#x27;: v10,</span><br>        <span class="hljs-comment"># &#x27;rh2m&#x27;: rh2m</span><br>    &#125;)<br><br><span class="hljs-comment"># Step 8: Create a DataFrame from the results</span><br>output_df = pd.DataFrame(results)<br><br><span class="hljs-comment"># Step 9: Save the results to a CSV file</span><br>output_df.to_csv(<span class="hljs-string">&#x27;output.csv&#x27;</span>, index=<span class="hljs-literal">False</span>)<br></code></pre></td></tr></table></figure>        </div>      </div>    </div><h2 id="step-3-run-the-script">Step 3: Run the Script</h2><ol type="1"><li>Make sure to replace <code>'path_to_your_file.grib2'</code> with the actual path to your GRIB file.</li><li>Save the script to a <code>.py</code> file and run it using Python.</li></ol><h2 id="output">Output</h2><p>The output will be a CSV file named <code>output.csv</code> with the following columns:</p><ul><li><code>station</code></li><li><code>t2m</code> (Temperature at 2m)</li><li><code>u10</code> (U-component of wind at 10m)</li><li><code>v10</code> (V-component of wind at 10m)</li><li><code>rh2m</code> (Relative humidity at 2m)</li><li><code>sdswrf</code> (The surface downward shortwave radiation flux)</li></ul><figure class="highlight console"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs console"><span class="hljs-meta prompt_"> $ </span><span class="language-bash"><span class="hljs-built_in">cat</span> output.csv</span> <br>station,sdswrf<br>Station1,52.232960662841684<br>Station2,47.779839172363275<br></code></pre></td></tr></table></figure><h2 id="note">Note</h2><ul><li>Ensure that the indices for <code>t2m</code>, <code>u10</code>, <code>v10</code>, <code>rh2m</code>, and <code>sdswrf</code> are correctly set according to how your GRIB data is structured.</li><li>You may need to adjust the extraction logic based on the specific GRIB messages you are working with.</li></ul><h1 id="read-multiple-gfs-grib-files">Read Multiple GFS grib files</h1><h2 id="code-to-extract-data-and-save-to-csv">Code to Extract Data and Save to CSV</h2>    <div class="fold">      <div class="fold-title fold-info collapsed" data-toggle="collapse" href="#collapse-8e159bd8" role="button" aria-expanded="false" aria-controls="collapse-8e159bd8">        <div class="fold-arrow">▶</div>extract_GFS_multiple.py      </div>      <div class="fold-collapse collapse" id="collapse-8e159bd8">        <div class="fold-content">          <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/bin/python</span><br><br><span class="hljs-comment">#------------------------------------------------#</span><br><span class="hljs-comment">#Author:         wpsze</span><br><span class="hljs-comment">#Email：         wpsze</span><br><span class="hljs-comment">#date:           2025-02-19 14:29:21</span><br><span class="hljs-comment">#Version:        0.0 </span><br><span class="hljs-comment">#Description:    The purpose of the script</span><br><span class="hljs-comment">#Copyright (C)： 2025 All rights reserved</span><br><span class="hljs-comment">#------------------------------------------------#</span><br><br><span class="hljs-keyword">import</span> xarray <span class="hljs-keyword">as</span> xr<br><span class="hljs-keyword">import</span> pandas <span class="hljs-keyword">as</span> pd<br><span class="hljs-keyword">import</span> glob<br><br><span class="hljs-comment"># Step 1: Load the station data</span><br>stations = pd.read_csv(<span class="hljs-string">&#x27;station.csv&#x27;</span>)<br><br><span class="hljs-comment"># Step 2: Get and sort the list of GFS GRIB files</span><br>grib_files = <span class="hljs-built_in">sorted</span>(glob.glob(<span class="hljs-string">&#x27;./subset-GFS/gfs.0p25.2025021200.f*.grib2&#x27;</span>) )  <span class="hljs-comment"># Adjust the path and pattern</span><br><br><span class="hljs-comment"># Step 3: Interpolate data for each station across all GRIB files</span><br>results = []<br><br><span class="hljs-comment"># GFS grib file</span><br><span class="hljs-comment"># Coordinates:</span><br><span class="hljs-comment"># * time        (time) datetime64[ns] 824B 2025-02-12 2025-02-12 ... 2025-02-12</span><br><span class="hljs-comment"># step        (time) timedelta64[ns] 824B 0 days 06:00:00 ... 16 days 00:00:00</span><br><span class="hljs-comment"># surface     float64 8B 0.0</span><br><span class="hljs-comment"># * latitude    (latitude) float64 6kB 90.0 89.75 89.5 ... -89.5 -89.75 -90.0</span><br><span class="hljs-comment"># * longitude   (longitude) float64 12kB 0.0 0.25 0.5 0.75 ... 359.2 359.5 359.8</span><br><span class="hljs-comment"># valid_time  (time) datetime64[ns] 824B 2025-02-12T06:00:00 ... 2025-02-28</span><br><br><br><span class="hljs-keyword">for</span> grib_file <span class="hljs-keyword">in</span> grib_files:<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;Processing: <span class="hljs-subst">&#123;grib_file&#125;</span>&quot;</span>)<br><br>    <span class="hljs-comment"># Step 4: Open the GRIB files using xarray</span><br>    <span class="hljs-comment"># ds = xr.open_mfdataset(grib_files, engine=&#x27;cfgrib&#x27;, combine=&#x27;by_coords&#x27;) #combine=&#x27;nested&#x27;, concat_dim=&quot;time&quot;) # combine=&#x27;by_coords&#x27;)</span><br>    ds = xr.open_dataset(grib_file, engine=<span class="hljs-string">&#x27;cfgrib&#x27;</span>, decode_timedelta=<span class="hljs-literal">True</span>) <span class="hljs-comment">#,backend_kwargs=&#123;&#x27;filter_by_keys&#x27;: &#123;&#x27;typeOfLevel&#x27;: &#x27;isobaricInhPa&#x27;&#125;&#125;)</span><br><br>    <span class="hljs-comment">## Print the names of the variables</span><br>    <span class="hljs-comment"># print(ds)</span><br>    <span class="hljs-comment"># selected_time = ds.time.values # It is initial time!!</span><br>    selected_time = ds.valid_time.values <span class="hljs-comment"># It is valid time</span><br>    <span class="hljs-comment">## Assuming selected_time_utc is in numpy datetime64 format</span><br>    selected_time_utc = pd.to_datetime(selected_time)  <span class="hljs-comment"># Convert to pandas datetime</span><br>    selected_time_utc_plus_8 = selected_time_utc + pd.Timedelta(hours=<span class="hljs-number">8</span>)  <span class="hljs-comment"># Add 8 hours</span><br><br>    <span class="hljs-built_in">print</span>(selected_time)<br><br>    <span class="hljs-comment"># Step 5: Extract data for each station</span><br>    <span class="hljs-keyword">for</span> index, row <span class="hljs-keyword">in</span> stations.iterrows():<br>        lat = row[<span class="hljs-string">&#x27;latitude&#x27;</span>]<br>        lon = row[<span class="hljs-string">&#x27;longitude&#x27;</span>]<br>        <br>        <span class="hljs-comment"># Step 6: Interpolate the data using bilinear interpolation</span><br>        <span class="hljs-comment"># t2m = ds[&#x27;t2m&#x27;].interp(latitude=lat, longitude=lon, method=&#x27;linear&#x27;).values</span><br>        <span class="hljs-comment"># u10 = ds[&#x27;u10&#x27;].interp(latitude=lat, longitude=lon, method=&#x27;linear&#x27;).values</span><br>        <span class="hljs-comment"># v10 = ds[&#x27;v10&#x27;].interp(latitude=lat, longitude=lon, method=&#x27;linear&#x27;).values</span><br>        <span class="hljs-comment"># rh2m = ds[&#x27;rh2m&#x27;].interp(latitude=lat, longitude=lon, method=&#x27;linear&#x27;).values</span><br>        sdswrf = ds[<span class="hljs-string">&#x27;sdswrf&#x27;</span>].interp(latitude=lat, longitude=lon, method=<span class="hljs-string">&#x27;linear&#x27;</span>).values<br>        <br>        <span class="hljs-comment"># Step 7: Append the results</span><br>        results.append(&#123;<br>            <span class="hljs-string">&#x27;station&#x27;</span>: row[<span class="hljs-string">&#x27;station&#x27;</span>],<br>            <span class="hljs-string">&#x27;datetime&#x27;</span>: selected_time,<br>            <span class="hljs-string">&#x27;sdswrf&#x27;</span>: sdswrf<br>            <span class="hljs-comment"># &#x27;t2m&#x27;: t2m,</span><br>            <span class="hljs-comment"># &#x27;u10&#x27;: u10,</span><br>            <span class="hljs-comment"># &#x27;v10&#x27;: v10,</span><br>            <span class="hljs-comment"># &#x27;rh2m&#x27;: rh2m</span><br>        &#125;)<br><br><span class="hljs-comment"># Step 8: Create a DataFrame from the results</span><br>output_df = pd.DataFrame(results)<br><br><span class="hljs-comment"># Step 9: Save the results to a CSV file</span><br>output_df.to_csv(<span class="hljs-string">&#x27;output_multiple.csv&#x27;</span>, index=<span class="hljs-literal">False</span>)<br></code></pre></td></tr></table></figure>        </div>      </div>    </div><h2 id="output-1">Output</h2>    <div class="fold">      <div class="fold-title fold-info collapsed" data-toggle="collapse" href="#collapse-42d133e0" role="button" aria-expanded="false" aria-controls="collapse-42d133e0">        <div class="fold-arrow">▶</div>output_multiple.csv      </div>      <div class="fold-collapse collapse" id="collapse-42d133e0">        <div class="fold-content">          <figure class="highlight console"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs console">station,datetime[UTC],datetime[BJT],sdswrf<br>Station1,2025-02-12 06:00:00,2025-02-12 14:00:00,52.232960662841684<br>Station2,2025-02-12 06:00:00,2025-02-12 14:00:00,47.779839172363275<br>Station1,2025-02-12 09:00:00,2025-02-12 17:00:00,62.86639785766609<br>Station2,2025-02-12 09:00:00,2025-02-12 17:00:00,40.13679992675776<br>Station1,2025-02-12 12:00:00,2025-02-12 20:00:00,33.28959899902347<br>Station2,2025-02-12 12:00:00,2025-02-12 20:00:00,22.780800170898374<br>Station1,2025-02-12 15:00:00,2025-02-12 23:00:00,0.0<br>Station2,2025-02-12 15:00:00,2025-02-12 23:00:00,0.0<br>Station1,2025-02-12 18:00:00,2025-02-13 02:00:00,0.0<br>Station2,2025-02-12 18:00:00,2025-02-13 02:00:00,0.0<br>Station1,2025-02-12 21:00:00,2025-02-13 05:00:00,0.0<br>Station2,2025-02-12 21:00:00,2025-02-13 05:00:00,0.0<br>Station1,2025-02-13 00:00:00,2025-02-13 08:00:00,2.2220799827575504<br>Station2,2025-02-13 00:00:00,2025-02-13 08:00:00,3.2377599430084407<br>Station1,2025-02-13 03:00:00,2025-02-13 11:00:00,146.60479980468722<br>Station2,2025-02-13 03:00:00,2025-02-13 11:00:00,215.17280273437623<br>Station1,2025-02-13 06:00:00,2025-02-13 14:00:00,154.97856079101527<br>Station2,2025-02-13 06:00:00,2025-02-13 14:00:00,259.47327941894736<br>Station1,2025-02-13 09:00:00,2025-02-13 17:00:00,137.50800354003917<br>......<br></code></pre></td></tr></table></figure>        </div>      </div>    </div><h1 id="xarrays-interp-method-with-the-linear-option-on-a-2d-array"><code>xarray</code>'s <code>interp</code> method with the <code>"linear"</code> option on a 2D array</h1><p>When using <code>xarray</code>'s <code>interp</code> method with the <code>"linear"</code> option on a 2D array, the method performs linear interpolation along the specified dimensions. This allows you to compute interpolated values at new coordinate points based on existing data in two dimensions.</p><h3 id="how-it-works-for-2d-arrays">How It Works for 2D Arrays</h3><ol type="1"><li><strong>Data Structure</strong>: A 2D array in <code>xarray</code> is typically represented as a <code>DataArray</code> or a <code>Dataset</code>, where you have two dimensions (e.g., latitude and longitude, or time and another variable).</li><li><strong>Linear Interpolation</strong>: The <code>"linear"</code> method calculates the interpolated values by creating linear relationships between existing data points. For each new coordinate point specified, it finds the nearest surrounding points in both dimensions and computes the interpolated value based on the linear ratio of the distances.</li></ol><ul><li>For each new coordinate:<ul><li>The method identifies the surrounding points in the original 2D array.</li><li>It calculates the interpolated value based on the linear relationship between the values at these surrounding points.</li><li>The interpolation is done separately for each dimension, effectively creating a <strong>bilinear interpolation effect</strong>.</li></ul></li><li><strong>2D Linear Interpolation</strong>: The <code>"linear"</code> method allows you to compute intermediate values smoothly between known data points in a 2D grid.</li><li><strong>Applications</strong>: This is useful in various fields such as geospatial analysis, climate modeling, and any scenario where a grid of values needs to be estimated at non-integer coordinates.</li></ul><p>Using <code>xarray</code>'s <code>interp</code> method in this way enables effective handling of multi-dimensional datasets, ensuring accurate and smooth transitions between data points.</p>]]></content>
    
    
    <categories>
      
      <category>MPAS</category>
      
    </categories>
    
    
    <tags>
      
      <tag>NWP</tag>
      
      <tag>WRF</tag>
      
      <tag>MPAS</tag>
      
      <tag>ERA5</tag>
      
      <tag>GFS</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>WRF | MPAS | UCM Urban canopy parameters (UCPs)</title>
    <link href="/2025/02/18/WRF-MPAS-UCM-Urban-canopy-parameters-UCPs/"/>
    <url>/2025/02/18/WRF-MPAS-UCM-Urban-canopy-parameters-UCPs/</url>
    
    <content type="html"><![CDATA[<h1 id="urban-canopy-parameters-ucps">Urban canopy parameters (UCPs)</h1><p>UCPs指的是都市地表參數，包括像地表粗糙度、植被覆蓋、建築密度等指標。這些參數在NWP模型中非常重要，因為它們會影響天氣模型對城市區域的天氣狀況模擬，例如溫度、濕度、風速等。</p><p>接下來，我得解釋UCPs如何影響NWP模擬。這可能包括以下幾個面向：地表粗糙度會影響大氣層的摩擦，進而影響風的傳播和速度。植被覆蓋會影響輻射的吸收，改變熱平衡，進而影響溫度分佈。建築密度和形狀可能影響熱島效應，導致溫度升高等。</p><p>此外，UCPs的準確性對模擬結果也很關鍵。如果UCPs的數據不準確或不完整，模型可能會低估或高估城市區域的某些天氣變量，導致預測誤差。</p><p>Urban canopy parameters (UCPs) are variables used in numerical weather prediction (NWP) models to describe the characteristics of the urban surface, such as roughness, vegetation, and building density. These parameters influence how the atmosphere interacts with urban areas, affecting weather phenomena like temperature, humidity, and wind. They help the models better simulate urban microclimates, which are crucial for accurate weather forecasting in cities.</p><h1 id="literature-review">Literature Review</h1><p>Here are some papers and datasets related to <strong>Global Urban Canopy Parameters (UCPs)</strong>, particularly focusing on the <strong>GloUCP</strong> dataset:</p><ol type="1"><li><strong>GloUCP: A Global 1 km Spatially Continuous Urban Canopy Parameters for the WRF Model</strong>:<ul><li>This paper introduces the GloUCP dataset, which provides a comprehensive global urban canopy parameter dataset at a 1 km resolution. The dataset includes building heights, footprints, and other urban morphology parameters essential for improving urban climate simulations. It highlights the dataset's superior accuracy and spatial coverage compared to existing datasets, especially in key urban regions like the Guangdong-Hong Kong-Macao Greater Bay Area.</li><li>Liao, Weilin, et al. "GloUCP: A global 1 km spatially continuous urban canopy parameters for the WRF model." Earth System Science Data Discussions <strong>2024</strong> (2024): 1-21.</li><li><a href="https://essd.copernicus.org/preprints/essd-2024-408/">Read the paper here</a> or <a href="https://essd.copernicus.org/preprints/essd-2024-408/essd-2024-408.pdf">access the PDF</a>.</li><li>The GloUCP dataset, converted to WRF binary file format, is available for download at <a href="https://doi.org/10.6084/m9.figshare.27011491" class="uri">https://doi.org/10.6084/m9.figshare.27011491</a></li></ul></li><li><strong>GLObal Building Heights for Urban Studies (UT-GLOBUS)</strong>:<ul><li>This dataset includes building heights and urban canopy parameters for over 1,200 cities worldwide. It utilizes machine learning models combined with spaceborne altimetry data to estimate building-level information. The dataset is designed for modeling applications and includes UCPs in a format compatible with WRF.</li><li>Kamath, Harsh G., et al. "GLObal Building heights for Urban Studies (UT-GLOBUS) for city-and street-scale urban simulations: development and first applications." Scientific Data 11.1 (<strong>2024</strong>): 886.</li><li>More details can be found <a href="https://gee-community-catalog.org/projects/utglobus/">here</a>.</li><li>Earth Engine App: <a href="https://sat-io.earthengine.app/view/ut-globus" class="uri">https://sat-io.earthengine.app/view/ut-globus</a></li></ul></li><li><strong>High Resolution 1m Global Canopy Height Maps</strong>:<ul><li>Although primarily focused on tree canopy heights, this dataset provides insights into vegetation structure that can complement urban canopy studies. It offers detailed information on tree canopy presence and height derived from satellite imagery.</li><li><a href="https://gee-community-catalog.org/projects/meta_trees/">Access the dataset</a>.</li></ul></li><li><strong>Global 30m Landsat Tree Canopy Version 4</strong>:<ul><li>This version of the tree canopy cover product offers improved estimates of tree cover globally, which may be useful in conjunction with UCPs for understanding urban vegetation dynamics.</li><li><a href="https://lcluc.umd.edu/metadata/global-30m-landsat-tree-canopy-version-4">More information is available</a>.</li></ul></li></ol><hr />]]></content>
    
    
    <categories>
      
      <category>WRF</category>
      
    </categories>
    
    
    <tags>
      
      <tag>HPC</tag>
      
      <tag>NWP</tag>
      
      <tag>WRF</tag>
      
      <tag>MPAS</tag>
      
      <tag>HKO</tag>
      
      <tag>UCM</tag>
      
      <tag>LCZs</tag>
      
      <tag>UCPs</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>MPAS | Variable-resolution mesh generation</title>
    <link href="/2025/02/17/MPAS-Variable-resolution-mesh-generation/"/>
    <url>/2025/02/17/MPAS-Variable-resolution-mesh-generation/</url>
    
    <content type="html"><![CDATA[<h1 id="mpas-variable-resolution-mesh-generation">MPAS variable-resolution mesh generation</h1><ul><li><a href="http://www.gpsarc.ncu.edu.tw/MPAS2023/slide/MPAS_A/14-Mesh%20generation.pdf">MPAS-Atmosphere Mesh Generation | Michael G. Duda | NCAR/MMM | MPAS-A and MPAS-JEDI Tutorials, 23-26 October 2023, Taiwan</a><ul><li>we employ Lloyd’s Method (Originally developed by Stuart Lloyd at Bell Labs for optimal signal quantization)</li><li>Density function: the key to refinement</li><li>generating a mesh is still very slow</li><li>Can take several months on a single multi-core desktop for high-resolution meshes</li><li>Even with 24 threads on the desktop in my office, generating a 15-3 km mesh with ~6.5 M cells still took months!</li></ul></li><li><a href="https://forum.mmm.ucar.edu/threads/mpas-variable-resolution-mesh-generation.12535/">MPAS variable-resolution mesh generation | Feb 2023</a><ul><li>we don't yet support (or even make available) the software that we use internally to generate MPAS-A meshes</li><li>Also, note that the lead time to generate this mesh will likely be several months</li><li>The generation of an SCVT can be viewed as an optimization problem, and the method that we use to perform this optimization -- Lloyd's method -- requires a very large number of iterations (typically O(10^6)), and each iteration can take several seconds. Part of each iteration can be parallelized, but there is still a part that is done in serial with our current software</li></ul></li><li><a href="https://forum.mmm.ucar.edu/threads/20-km-benchmark-case.11528/#post-25917">20-km benchmark case | March 2022</a><ul><li>At present we don't have a 20-km benchmark case, and in order to generate this yourself you would need a 20-km mesh. While we don't actually have a 20-km quasi-uniform mesh at present, we could generate one and make it available on the mesh download page in the near future. I'll follow up in this thread once the 20-km mesh is available.</li><li>We don't currently provide software for generating new meshes, so generating a 20-km mesh is something that we will do for you.</li><li>We haven't made our mesh generation software publicly available, so once I have generated the 20-km mesh, I'll follow up here to let you know that the mesh is available.</li></ul></li></ul><div class="note note-primary">            <p>The generation of an SCVT can be viewed as an optimization problem, and the method that we use to perform this optimization -- Lloyd's method -- requires a very large number of iterations (typically O(10^6)), and each iteration can take several seconds. Part of each iteration can be parallelized, but there is still a part that is done in serial with our current software</p>          </div>]]></content>
    
    
    <categories>
      
      <category>MPAS</category>
      
    </categories>
    
    
    <tags>
      
      <tag>NWP</tag>
      
      <tag>WRF</tag>
      
      <tag>MPAS</tag>
      
      <tag>mesh generation</tag>
      
      <tag>Lloyd iteration</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>MPAS | ERA5| Update SST and sea-ice fraction</title>
    <link href="/2025/02/14/MPAS-ERA5-Update-SST-and-sea-ice-fraction/"/>
    <url>/2025/02/14/MPAS-ERA5-Update-SST-and-sea-ice-fraction/</url>
    
    <content type="html"><![CDATA[<h1 id="generating-sst-and-sea-ice-update-files">Generating SST and sea-ice update files</h1><ul><li><a href="https://www2.mmm.ucar.edu/projects/mpas/tutorial/Howard2024/index.html" class="uri">https://www2.mmm.ucar.edu/projects/mpas/tutorial/Howard2024/index.html</a></li><li><a href="https://ftp.cptec.inpe.br/pesquisa/das/MPAS-Tutorial-NCAR-2023/mpas_tutorial/">MPAS-Tutorial-NCAR-2023/mpas_tutorial | ftp</a></li></ul><p>Because MPAS-Atmosphere — at least, when run as a stand-alone model — does not contain prognostic equations for the SST and sea-ice fraction, these fields would remain constant if not updated from an external source; this is, of course, not realistic, and it will generally impact the quality of longer model simulations. Consequently, for MPAS-Atmosphere simulations longer than roughly a week, it is typically necessary to periodically update the sea-surface temperature (SST) field in the model. For real-time simulations, this is generally not an option, but it is feasible for retrospective simulations, where we have observed SST analyses available to us.</p><div class="note note-primary">            <p>Prepare <strong>intermediate files containing SST and sea-ice analyses</strong></p>          </div><h1 id="for-era5">For ERA5</h1><h2 id="intermediate-files">Intermediate files</h2><ul><li><a href="https://www2.mmm.ucar.edu/wrf/users/tutorial/presentation_pdfs/202101/werner_data_util_pp.pdf">Fortran script to convert netCDF to Intermediate format</a><ul><li>Convert netCDF to Intermediate: <a href="https://www2.mmm.ucar.edu/wrf/src/netcdf-to-intermediate.f">netcdf-to-intermediate.f</a></li></ul></li></ul><h3 id="reading-intermediate-files">Reading intermediate files</h3><ul><li><a href="https://github.com/hanschen/WPS/blob/master/util/src/rd_intermediate.F">WPS/util/src/rd_intermediate.F</a></li><li><code>WPS/util/rd_intermediate.exe</code></li><li>USAGE: <code>rd_intermediate.exe &lt;filename&gt;</code></li></ul><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-meta">#!/bin/bash</span><br><span class="hljs-built_in">source</span> /home/wpsze/WRF/WRFv440/wrf_env.sh<br><span class="hljs-built_in">ln</span> -sf /home/wpsze/WRF/WRFv440/wrf_install/WPS-4.4/bin/rd_intermediate.exe<br><span class="hljs-built_in">ln</span> -sf /home/wpsze/WRF/WRFv440/wrf_install/WPS-4.4/util/plotfmt.ncl<br>./rd_intermediate.exe <span class="hljs-variable">$1</span><br>ncl plotfmt.ncl <span class="hljs-variable">$1</span><br></code></pre></td></tr></table></figure><p>and, on termianl,</p><figure class="highlight console"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs console"><span class="hljs-meta prompt_">$ </span><span class="language-bash">./read_int.sh ERA5:2022-06-30_00</span><br>......<br>================================================<br>FIELD = SEAICE<br>UNITS = fraction DESCRIPTION = Sea-Ice Fraction<br>DATE = 2022-06-30_00:00:00 FCST = 0.000000<br>SOURCE = ECMWF<br>LEVEL = 200100.000000<br>I,J DIMS = 1440, 721<br>IPROJ = 0  PROJECTION = LAT LON<br>  REF_X, REF_Y = 1.000000, 1.000000<br>  REF_LAT, REF_LON = 90.000008, 0.000000<br>  DLAT, DLON = -0.250000, 0.250000<br>  EARTH_RADIUS = 6367.470215<br>DATA(1,1)=0.927246<br><br>================================================<br>FIELD = SST<br>UNITS = K DESCRIPTION = Sea-Surface Temperature<br>DATE = 2022-06-30_00:00:00 FCST = 0.000000<br>SOURCE = ECMWF<br>LEVEL = 200100.000000<br>I,J DIMS = 1440, 721<br>IPROJ = 0  PROJECTION = LAT LON<br>  REF_X, REF_Y = 1.000000, 1.000000<br>  REF_LAT, REF_LON = 90.000008, 0.000000<br>  DLAT, DLON = -0.250000, 0.250000<br>  EARTH_RADIUS = 6367.470215<br>DATA(1,1)=271.459961<br>================================================<br>......<br></code></pre></td></tr></table></figure><h3 id="plotting-intermediate-files-plotfmt.ncl">Plotting Intermediate Files: plotfmt.ncl</h3><p>Plots the fields in the ungribbed intermediate files</p><blockquote><p>$ ncl plotfmt.ncl 'filename="FNL:2007-09-15_00"'</p></blockquote><p>See above shell script.</p><div class="group-image-container"><div class="group-image-row"><div class="group-image-wrap"><img src="https://i.imgur.com/Z3OysPt.png" /></div><div class="group-image-wrap"><img src="https://i.imgur.com/IuCdgnU.png" /></div><div class="group-image-wrap"><img src="https://i.imgur.com/698XQfv.png" /></div></div><div class="group-image-row"><div class="group-image-wrap"><img src="https://i.imgur.com/oZwecqP.png" /></div><div class="group-image-wrap"><img src="https://i.imgur.com/vSVNCUn.png" /></div><div class="group-image-wrap"><img src="https://i.imgur.com/EPqOweu.png" /></div></div></div><h2 id="skintemp-skt-vs-sst">skintemp (skt) vs sst</h2><p>Consider <code>skt - sst</code> form ERA5 grib file, they are different but why?</p><ul><li>ERA5-0p25-SL-2022063000.grib</li><li>ERA5 grib: skt - sst</li></ul><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs sh">ncvis ERA5-0p25-SL-2022063000.nc<br>cdo selname,sst ERA5-0p25-SL-2022063000.nc sst.nc<br>cdo selname,skt ERA5-0p25-SL-2022063000.nc skt.nc<br>cdo chname,skt,sst skt.nc skt-sst.nc<br>ncdiff skt-sst.nc sst.nc diff.nc<br>ncvis/ncview diff.nc <br></code></pre></td></tr></table></figure><figure><img src="https://i.imgur.com/WoSHTOP.png" alt="ERA5 grib | skt - sst |" width="500" /><figcaption>ERA5 grib | skt - sst |</figcaption></figure><h3 id="solutions">Solutions</h3><ul><li><a href="https://forum.mmm.ucar.edu/threads/sst-input-resolution-and-landmask.15850/">SST input resolution and LANDMASK | Feb 2024</a><ul><li><strong>SST in ERA5 only has valid values over the ocean</strong>. When metgrid conducts horizontal interpolation, it may result in some discontinuity.</li><li><strong>TSK is skin temperature predicted by land model (over the ocean without sst update, it remains as skintemp at the initial time. if sst_update =1, tsk is updated by SST.</strong>)</li><li>I am suspicious that SST is somehow not continuous over the coast, which affects tsk later.</li><li>To overcome this problem, <strong>please use skintemp as SST</strong>. You cam simply delete the line for SST in Vtable.ECMWF , then rerun ungrib and metgrid.</li><li>I would like to confirm that in ERA5, SKINTEMP and SST over the ocean are same. This will justify that we can use SKINTEMP to replace SST.</li></ul></li><li><a href="https://forum.mmm.ucar.edu/threads/metgrid-sst-interpolation-artifacts.14755/">Metgrid SST interpolation artifacts | Nov 2023</a><ul><li>One quick fix of the unrealistic SST along coastal areas is to <strong>replace SST by SKINTEMP</strong>. <strong>Please delete the line below from Vtable.ECMWF</strong>, then rerun ungrib.exe.</li><li><code>34 | 1 | 0 | | SST | K | Sea-Surface Temperature |</code></li><li>In this case SST will not be extracted from ERA5 and SKINTEMP will be used as SST. <strong>We believe this is reasonable because SST and SKINTEMP is almost the same over ocean</strong>.</li><li>In the case you attempt to use external SST instead of ERA5 SST, you need to provide landmask specifically for the external SST data, then modify METGRID.TBL so that metgrid.exe will know what landmask is used for horizontal interpolation.<ul><li>A detailed explanation can be found at <a href="https://www2.mmm.ucar.edu/wrf/users/tutorial/presentation_pdfs/201907/duda_wps_advanced.pdf" class="uri">https://www2.mmm.ucar.edu/wrf/users/tutorial/presentation_pdfs/201907/duda_wps_advanced.pdf</a>, and the slides 47-58 give an example how to process external soil data. The same approach is also applied to external SST.</li><li>the default fill-values overland is 0K (as in -273.15ºC). If you're running in high res, the interpolation of SST leads to some wonky numbers around the landmask. Probably you can set fill_missing = 285. or some other value to remedy the problem.</li></ul></li><li><a href="https://forum.mmm.ucar.edu/threads/does-wrf-needs-tsk-from-global-data.9751/">does WRF needs TSK from global data | Nov 2020</a></li><li><a href="https://forum.mmm.ucar.edu/threads/strong-non-smooth-temperature-pattern-over-snow-ice-water-land-categories.10793/">Strong non-smooth temperature pattern over snow/ice/water land categories | Sep 2021</a><ul><li>I see you're using sst_update. Are you using a separate SST input data than the ERA5 data? If so, is it possible that the landsea mask for the two data types is inconsistent? Otherwise, there is a particular process necessary for processing landsea for ERA5 data.</li><li><strong>One suggestion is to use SKINTEMP only (instead of SST)</strong></li></ul></li></ul></li><li><a href="https://forum.mmm.ucar.edu/threads/issue-with-era5-sst-fields.12525/">Issue with ERA5 SST fields | Feb 2023</a><ul><li>This is an old issue. If you <strong>replace the SST by the skin temperature</strong> you will have unrealistic warm waters near the coast in summer.</li></ul></li><li><a href="https://forum.mmm.ucar.edu/threads/wrf-regional-climate-simulation.10726/">WRF regional climate simulation | Sep 2021</a><ul><li>This will potentially lead to problem in WRF simulation, especially for long term climate simulation with sst_update.</li><li>To solve this issue, <strong>please use skintemp to replace SST</strong> following the steps below:<ul><li><ol type="1"><li>in Vtable.ERA-I, <strong>delete</strong> the line below:</li></ol><ul><li><code>34 | 1 | 0 | | SST | K | Sea-Surface Temperature |</code></li></ul></li><li><ol start="2" type="1"><li>rerun ungrib.exe and metgrid.exe</li></ol></li><li><ol start="3" type="1"><li>run real.exe and wrf.exe</li></ol></li></ul></li></ul></li><li><a href="https://forum.mmm.ucar.edu/threads/merge-vtable-gfs-and-vtable-sst.9973/">Merge Vtable.GFS and Vtable.SST | Jan 2021</a><ul><li>It is perfectly fine that the <strong>SST field is derived from SKINTEMP</strong>; however, if you are not using high-resolution time-varying SST data input, there really is no need to use the sst_update option. If you are only running for 4 days, it shouldn't be necessary.</li></ul></li><li><a href="https://forum.mmm.ucar.edu/threads/ungrib-error-not-reading-sst.12318/">Ungrib error: not reading SST | Dec 2022</a><ul><li>This means the code is not familiar with a level code of 160, and if you want to use that one, you'll need to modify the ungrib/src/rd_grib2.F file to allow it to work. You can search for that part of the code by looking for "Rd_grib2 does not know" in that file. After you make any modifications, you'll need to recompile ungrib.exe.</li></ul></li></ul><h2 id="summary">Summary</h2><div class="note note-primary">            <p>The ERA5.grib can be <strong>IC, LBC, FDDA</strong> and <strong>SST/Sea-Ice updated</strong> as well.</p><p>And, <strong>ERA5 corresponding interemediate file</strong> can be used.</p>          </div><h1 id="vtable">Vtable</h1><ul><li>Vtable.GFS<ul><li>Skin temperature (can use for SST also)     <div class="fold">      <div class="fold-title fold-info collapsed" data-toggle="collapse" href="#collapse-9c51fa20" role="button" aria-expanded="false" aria-controls="collapse-9c51fa20">        <div class="fold-arrow">▶</div>Vtable.GFS      </div>      <div class="fold-collapse collapse" id="collapse-9c51fa20">        <div class="fold-content">          <figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs gherkin">GRIB1|<span class="hljs-string"> Level</span>|<span class="hljs-string"> From </span>|<span class="hljs-string">  To  </span>|<span class="hljs-string"> metgrid  </span>|<span class="hljs-string"> metgrid </span>|<span class="hljs-string"> metgrid                                 </span>|<span class="hljs-string">GRIB2</span>|<span class="hljs-string">GRIB2</span>|<span class="hljs-string">GRIB2</span>|<span class="hljs-string">GRIB2</span>|<br>Param|<span class="hljs-string"> Type </span>|<span class="hljs-string">Level1</span>|<span class="hljs-string">Level2</span>|<span class="hljs-string"> Name     </span>|<span class="hljs-string"> Units   </span>|<span class="hljs-string"> Description                             </span>|<span class="hljs-string">Discp</span>|<span class="hljs-string">Catgy</span>|<span class="hljs-string">Param</span>|<span class="hljs-string">Level</span>|<br>-----+------+------+------+----------+---------+-----------------------------------------+-----------------------+<br>  91 |<span class="hljs-string">   1  </span>|<span class="hljs-string">   0  </span>|<span class="hljs-string">      </span>|<span class="hljs-string"> SEAICE   </span>|<span class="hljs-string"> proprtn </span>|<span class="hljs-string"> Ice flag                                </span>|<span class="hljs-string"> 10  </span>|<span class="hljs-string">  2  </span>|<span class="hljs-string">  0  </span>|<span class="hljs-string">   1 </span>|<br>  81 |<span class="hljs-string">   1  </span>|<span class="hljs-string">   0  </span>|<span class="hljs-string">      </span>|<span class="hljs-string"> LANDSEA  </span>|<span class="hljs-string"> proprtn </span>|<span class="hljs-string"> Land/Sea flag (1=land, 0 or 2=sea)      </span>|<span class="hljs-string">  2  </span>|<span class="hljs-string">  0  </span>|<span class="hljs-string">  0  </span>|<span class="hljs-string">   1 </span>|<br>  81 |<span class="hljs-string">   1  </span>|<span class="hljs-string">   0  </span>|<span class="hljs-string">      </span>|<span class="hljs-string"> LANDN    </span>|<span class="hljs-string"> proprtn </span>|<span class="hljs-string">                                         </span>|<span class="hljs-string">  2  </span>|<span class="hljs-string">  0  </span>|<span class="hljs-string"> 218 </span>|<span class="hljs-string">   1 </span>|<br>   7 |<span class="hljs-string">   1  </span>|<span class="hljs-string">   0  </span>|<span class="hljs-string">      </span>|<span class="hljs-string"> SOILHGT  </span>|<span class="hljs-string"> m       </span>|<span class="hljs-string"> Terrain field of source analysis        </span>|<span class="hljs-string">  0  </span>|<span class="hljs-string">  3  </span>|<span class="hljs-string">  5  </span>|<span class="hljs-string">   1 </span>|<br>  11 |<span class="hljs-string">   1  </span>|<span class="hljs-string">   0  </span>|<span class="hljs-string">      </span>|<span class="hljs-string"> SKINTEMP </span>|<span class="hljs-string"> K       </span>|<span class="hljs-string"> Skin temperature                        </span>|<span class="hljs-string">  0  </span>|<span class="hljs-string">  0  </span>|<span class="hljs-string">  0  </span>|<span class="hljs-string">   1 </span>|<br>......<br></code></pre></td></tr></table></figure>        </div>      </div>    </div></li></ul></li><li><p>Vtable.ERA-interim.pl     <div class="fold">      <div class="fold-title fold-info collapsed" data-toggle="collapse" href="#collapse-05eef982" role="button" aria-expanded="false" aria-controls="collapse-05eef982">        <div class="fold-arrow">▶</div>Vtable.ERA-interim.pl      </div>      <div class="fold-collapse collapse" id="collapse-05eef982">        <div class="fold-content">          <figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs gherkin">GRIB |<span class="hljs-string"> Level</span>|<span class="hljs-string"> Level</span>|<span class="hljs-string"> Level</span>|<span class="hljs-string"> metgrid  </span>|<span class="hljs-string">  metgrid </span>|<span class="hljs-string"> metgrid                                  </span>|<br>Code |<span class="hljs-string"> Code </span>|<span class="hljs-string">   1  </span>|<span class="hljs-string">   2  </span>|<span class="hljs-string"> Name     </span>|<span class="hljs-string">  Units   </span>|<span class="hljs-string"> Description                              </span>|<br>-----+------+------+------+----------+----------+------------------------------------------+<br> 235 |<span class="hljs-string">  1   </span>|<span class="hljs-string">   0  </span>|<span class="hljs-string">      </span>|<span class="hljs-string"> SKINTEMP </span>|<span class="hljs-string"> K        </span>|<span class="hljs-string"> Sea-Surface Temperature                  </span>|<br>  31 |<span class="hljs-string">  1   </span>|<span class="hljs-string">   0  </span>|<span class="hljs-string">      </span>|<span class="hljs-string"> SEAICE   </span>|<span class="hljs-string"> fraction </span>|<span class="hljs-string"> Sea-Ice Fraction                         </span>|<br>  34 |<span class="hljs-string">  1   </span>|<span class="hljs-string">   0  </span>|<span class="hljs-string">      </span>|<span class="hljs-string"> SST      </span>|<span class="hljs-string"> K        </span>|<span class="hljs-string"> Sea-Surface Temperature                  </span>|<br>......<br></code></pre></td></tr></table></figure>        </div>      </div>    </div></p></li><li><p>Vtable.SST     <div class="fold">      <div class="fold-title fold-info collapsed" data-toggle="collapse" href="#collapse-90469042" role="button" aria-expanded="false" aria-controls="collapse-90469042">        <div class="fold-arrow">▶</div>Vtable.SST      </div>      <div class="fold-collapse collapse" id="collapse-90469042">        <div class="fold-content">          <figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs gherkin">GRIB |<span class="hljs-string"> Level</span>|<span class="hljs-string"> Level</span>|<span class="hljs-string"> Level</span>|<span class="hljs-string"> metgrid  </span>|<span class="hljs-string">  metgrid </span>|<span class="hljs-string"> metgrid                                  </span>|<br>Code |<span class="hljs-string"> Code </span>|<span class="hljs-string">   1  </span>|<span class="hljs-string">   2  </span>|<span class="hljs-string"> Name     </span>|<span class="hljs-string">  Units   </span>|<span class="hljs-string"> Description                              </span>|<br>-----+------+------+------+----------+----------+------------------------------------------+<br> 172 |<span class="hljs-string">  1   </span>|<span class="hljs-string">   0  </span>|<span class="hljs-string">      </span>|<span class="hljs-string"> LANDSEA  </span>|<span class="hljs-string"> 0/1 Flag </span>|<span class="hljs-string"> Land/Sea flag                            </span>|<br> 235 |<span class="hljs-string">  1   </span>|<span class="hljs-string">   0  </span>|<span class="hljs-string">      </span>|<span class="hljs-string"> SKINTEMP </span>|<span class="hljs-string"> K        </span>|<span class="hljs-string"> Sea-Surface Temperature                  </span>|<br>  31 |<span class="hljs-string">  1   </span>|<span class="hljs-string">   0  </span>|<span class="hljs-string">      </span>|<span class="hljs-string"> SEAICE   </span>|<span class="hljs-string"> fraction </span>|<span class="hljs-string"> Sea-Ice Fraction                         </span>|<br>-----+------+------+------+----------+----------+------------------------------------------+<br></code></pre></td></tr></table></figure>        </div>      </div>    </div></p></li></ul><h2 id="for-sst-skintemp">For <code>sst = skintemp</code></h2><ul><li><code>Vtable.ERA-interim.pl</code> is modified as <code>Vtable.ERA5</code></li><li><strong>replace the SST by the skin temperature !!</strong></li><li><strong>Remove</strong> the row : <code>34 |  1   |   0  |      | SST      | K        | Sea-Surface Temperature                  |</code></li></ul><h2 id="for-using-era5-as-sst-source">For using ERA5 as SST source</h2><ul><li>use ERA5's <code>skintemp</code> as SST source instead of <code>sst</code> itself</li><li>modify <code>Vtable.SST</code> with replace <code>11</code> by <code>235</code></li><li><p>try to keep three varibles (not only SST and SEAICE)</p></li><li><p>Vtable.ERA5.SST     <div class="fold">      <div class="fold-title fold-info collapsed" data-toggle="collapse" href="#collapse-738764b7" role="button" aria-expanded="false" aria-controls="collapse-738764b7">        <div class="fold-arrow">▶</div>Vtable.ERA5.SST      </div>      <div class="fold-collapse collapse" id="collapse-738764b7">        <div class="fold-content">          <figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs gherkin">GRIB |<span class="hljs-string"> Level</span>|<span class="hljs-string"> Level</span>|<span class="hljs-string"> Level</span>|<span class="hljs-string"> metgrid  </span>|<span class="hljs-string">  metgrid </span>|<span class="hljs-string"> metgrid                                  </span>|<br>Code |<span class="hljs-string"> Code </span>|<span class="hljs-string">   1  </span>|<span class="hljs-string">   2  </span>|<span class="hljs-string"> Name     </span>|<span class="hljs-string">  Units   </span>|<span class="hljs-string"> Description                              </span>|<br>-----+------+------+------+----------+----------+------------------------------------------+<br> 235 |<span class="hljs-string">  1   </span>|<span class="hljs-string">   0  </span>|<span class="hljs-string">      </span>|<span class="hljs-string"> SKINTEMP </span>|<span class="hljs-string"> K        </span>|<span class="hljs-string"> Sea-Surface Temperature                  </span>|<br>  31 |<span class="hljs-string">  1   </span>|<span class="hljs-string">   0  </span>|<span class="hljs-string">      </span>|<span class="hljs-string"> SEAICE   </span>|<span class="hljs-string"> fraction </span>|<span class="hljs-string"> Sea-Ice Fraction                         </span>|<br> 235 |<span class="hljs-string">  1   </span>|<span class="hljs-string">   0  </span>|<span class="hljs-string">      </span>|<span class="hljs-string"> SST      </span>|<span class="hljs-string"> K        </span>|<span class="hljs-string"> Sea-Surface Temperature                  </span>|<br></code></pre></td></tr></table></figure>        </div>      </div>    </div></p></li></ul><div class="note note-primary">            <p>ln -sf ${TEMPLATE_DIR}/Variable_Tables/Vtable.ERA5.SST Vtable</p>          </div><h1 id="for-mpas">For MPAS</h1><h2 id="code">code</h2><h3 id="mpas_stream_manager.f">mpas_stream_manager.F</h3><ul><li>MPAS_stream_mgr_get_property</li></ul>    <div class="fold">      <div class="fold-title fold-info collapsed" data-toggle="collapse" href="#collapse-dfb167e8" role="button" aria-expanded="false" aria-controls="collapse-dfb167e8">        <div class="fold-arrow">▶</div>MPAS_stream_mgr_get_property      </div>      <div class="fold-collapse collapse" id="collapse-dfb167e8">        <div class="fold-content">          <figure class="highlight fortran"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs fortran"><span class="hljs-keyword">interface</span> MPAS_stream_mgr_get_property<br>    <span class="hljs-keyword">module</span> <span class="hljs-keyword">procedure</span> MPAS_stream_mgr_get_property_int<br>    <span class="hljs-keyword">module</span> <span class="hljs-keyword">procedure</span> MPAS_stream_mgr_get_property_char<br>    <span class="hljs-keyword">module</span> <span class="hljs-keyword">procedure</span> MPAS_stream_mgr_get_property_logical<br><span class="hljs-keyword">end</span> <span class="hljs-keyword">interface</span><br><br><span class="hljs-comment">!-----------------------------------------------------------------------</span><br><span class="hljs-comment">!  routine MPAS_stream_mgr_get_property_int</span><br><span class="hljs-comment">!</span><br><span class="hljs-comment">!&gt; \brief Gets a property of a stream in an MPAS stream manager.</span><br><span class="hljs-comment">!&gt; \author Michael Duda, Doug Jacobsen</span><br><span class="hljs-comment">!&gt; \date   13 June 2014</span><br><span class="hljs-comment">!&gt; \details</span><br><span class="hljs-comment">!&gt;  Retrieves the value of a stream property within an MPAS stream manager.</span><br><span class="hljs-comment">!&gt;  <span class="hljs-doctag">NOTE:</span> This routine does not support streamID regular expressions</span><br><span class="hljs-comment">!</span><br><span class="hljs-comment">!-----------------------------------------------------------------------</span><br><span class="hljs-function"><span class="hljs-keyword">subroutine</span></span> MPAS_stream_mgr_get_property_int(manager, streamID, propertyName, propertyValue, direction, ierr)<br></code></pre></td></tr></table></figure>        </div>      </div>    </div><h3 id="mpas-init.nc-sst-issue">MPAS init.nc SST issue</h3><ul><li><code>sst = skintemp</code> that sst values is from skintemp.</li><li><code>src/core_init_atmosphere/mpas_init_atm_cases.F</code></li></ul><figure class="highlight vbnet"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs vbnet"><span class="hljs-keyword">if</span> (config_met_interp) <span class="hljs-keyword">then</span><br><br>!ldf (<span class="hljs-number">2011</span>-<span class="hljs-number">11</span>-<span class="hljs-number">19</span>): added initialization <span class="hljs-keyword">of</span> the sea-surface temperature, seaice fraction, <span class="hljs-built_in">and</span><br>!seaice flag:<br>  sst = <span class="hljs-number">0.0</span><br>  xice = <span class="hljs-number">0.0</span><br>  seaice = <span class="hljs-number">0.0</span><br>!ldf <span class="hljs-keyword">end</span>.<br><br>! <span class="hljs-keyword">Set</span> SST based <span class="hljs-keyword">on</span> SKINTEMP field <span class="hljs-keyword">if</span> it wasn<span class="hljs-comment">&#x27;t found in input data</span><br><span class="hljs-keyword">if</span> (minval(sst) == <span class="hljs-number">0.0</span> .<span class="hljs-built_in">and</span>. maxval(sst) == <span class="hljs-number">0.0</span>) <span class="hljs-keyword">then</span><br>    <span class="hljs-keyword">call</span> mpas_log_write(<span class="hljs-comment">&#x27;Setting SST from SKINTEMP&#x27;)</span><br>    !<span class="hljs-keyword">where</span> (landmask == <span class="hljs-number">0</span>) sst = skintemp<br>    sst = skintemp<br><span class="hljs-keyword">end</span> <span class="hljs-keyword">if</span><br></code></pre></td></tr></table></figure><p>But, ERA5's skintemp and sst are different as above.</p><p><img src="https://i.imgur.com/EIkck30.png" alt="Left) init.nc, Right) sst.nc" /> <img src="https://i.imgur.com/YHSha1w.png" alt="init.nc - sst.nc, and same as above figure of ERA5 grib file" width="500" /> <img src="https://i.imgur.com/Fwn5ZjU.png" alt="It is init.nc: skintemp - sst that has shown sst is same as skintemp in init_atmosphere step in MPAS." width="500" /></p><h3 id="core_atmosphere">core_atmosphere</h3><ul><li><code>src/core_atmosphere/physics/mpas_atmphys_manager.F</code></li><li>read sfc input <figure class="highlight fortran"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs fortran"><span class="hljs-keyword">type</span>(mpas_pool_type),<span class="hljs-keyword">pointer</span>:: sfc_input<br><span class="hljs-keyword">block</span> =&gt; domain % blocklist<br><span class="hljs-keyword">call</span> mpas_pool_get_subpool(<span class="hljs-keyword">block</span>%structs,<span class="hljs-string">&#x27;sfc_input&#x27;</span>   ,sfc_input   )<br></code></pre></td></tr></table></figure></li><li><p>physics_update_sst <figure class="highlight fortran"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs fortran"><span class="hljs-comment">!update surface boundary conditions with input sea-surface temperatures and fractional</span><br><span class="hljs-comment">!sea-ice coverage:</span><br><span class="hljs-keyword">if</span>(mpas_is_alarm_ringing(clock,sfcbdyAlarmID,ierr=ierr)) <span class="hljs-keyword">then</span><br>    <span class="hljs-keyword">call</span> mpas_reset_clock_alarm(clock,sfcbdyAlarmID,ierr=ierr)<br>    <span class="hljs-keyword">if</span>(config_sst_update) &amp;<br>      <span class="hljs-keyword">call</span> physics_update_sst(domain%dminfo,config_frac_seaice,mesh,sfc_input,diag_physics)<br><span class="hljs-keyword">endif</span><br></code></pre></td></tr></table></figure></p></li><li><p><strong>MPAS_stream_mgr_get_property</strong> read sst.nc files</p></li></ul><figure class="highlight fortran"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs fortran"><span class="hljs-comment">!set alarm for updating the surface boundary conditions:</span><br> <span class="hljs-keyword">if</span> (config_sst_update) <span class="hljs-keyword">then</span><br>    <span class="hljs-keyword">call</span> MPAS_stream_mgr_get_property(stream_manager, <span class="hljs-string">&#x27;surface&#x27;</span>, MPAS_STREAM_PROPERTY_RECORD_INTV, stream_interval, &amp;<br>                                      direction=MPAS_STREAM_INPUT, ierr=ierr)<br>    <span class="hljs-keyword">call</span> mpas_set_timeInterval(alarmTimeStep,timeString=stream_interval,ierr=ierr)<br>    alarmStartTime = startTime<br>    <span class="hljs-keyword">call</span> mpas_add_clock_alarm(clock,sfcbdyAlarmID,alarmStartTime,alarmTimeStep,ierr=ierr)<br>    <span class="hljs-keyword">if</span>(ierr /= <span class="hljs-number">0</span>) &amp;<br>       <span class="hljs-keyword">call</span> physics_error_fatal(<span class="hljs-string">&#x27;subroutine physics_init: error creating alarm sfcbdy&#x27;</span>)<br> <span class="hljs-keyword">endif</span><br></code></pre></td></tr></table></figure><ul><li><code>src/core_atmosphere/Registry.xml</code> <figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">var_struct</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;sfc_input&quot;</span> <span class="hljs-attr">time_levs</span>=<span class="hljs-string">&quot;1&quot;</span>&gt;</span><br></code></pre></td></tr></table></figure></li></ul><h4 id="update-sst-on-mpas-time-step">Update SST on MPAS time-step,</h4><ul><li>For uptated interval = 3 hour,<ul><li>T=0, from SST(T=0) of init.nc</li><li>T=0 to T=3, are same as SST(T=0)</li><li>T&gt;3 to T=6, are same as SST(T=3)</li><li>T&gt;6 to T=9, are same as SST(T=6)</li></ul></li><li>For uptated interval = 6 hour,<ul><li>T=0, from SST(T=0) of init.nc</li><li>T=0 to T=6, are same as SST(T=0)</li><li>T&gt;6 to T=12, are same as SST(T=6)</li><li>T&gt;12 to T=18, are same as SST(T=12)</li></ul></li></ul><h2 id="srccore_init_atmosphereregistry.xml">src/core_init_atmosphere/Registry.xml</h2><ul><li><a href="https://github.com/MPAS-Dev/MPAS-Model/blob/41e9a3fb8ca6b9250a7405209a5c60996318409f/src/core_init_atmosphere/Registry.xml#L347">MPAS-Model/src/core_init_atmosphere/Registry.xml</a></li></ul><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">package</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;sfc_update&quot;</span> <span class="hljs-attr">description</span>=<span class="hljs-string">&quot;Used by test cases that produce surface updates.&quot;</span>/&gt;</span><br><br><span class="hljs-tag">&lt;<span class="hljs-name">nml_option</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;config_input_sst&quot;</span>             <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;logical&quot;</span>       <span class="hljs-attr">default_value</span>=<span class="hljs-string">&quot;false&quot;</span></span><br><span class="hljs-tag">      <span class="hljs-attr">units</span>=<span class="hljs-string">&quot;-&quot;</span></span><br><span class="hljs-tag">      <span class="hljs-attr">description</span>=<span class="hljs-string">&quot;Whether to re-compute SST and sea-ice fields from surface input data set; should be set to .true. when running case 8&quot;</span></span><br><span class="hljs-tag">      <span class="hljs-attr">possible_values</span>=<span class="hljs-string">&quot;true or false&quot;</span>/&gt;</span><br><br><span class="hljs-tag">&lt;<span class="hljs-name">var</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;sst&quot;</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;real&quot;</span> <span class="hljs-attr">dimensions</span>=<span class="hljs-string">&quot;nCells Time&quot;</span> <span class="hljs-attr">units</span>=<span class="hljs-string">&quot;K&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">description</span>=<span class="hljs-string">&quot;sea-surface temperature&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">packages</span>=<span class="hljs-string">&quot;met_stage_out;sfc_update&quot;</span>/&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">var</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;xice&quot;</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;real&quot;</span> <span class="hljs-attr">dimensions</span>=<span class="hljs-string">&quot;nCells Time&quot;</span> <span class="hljs-attr">units</span>=<span class="hljs-string">&quot;unitless&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">description</span>=<span class="hljs-string">&quot;fractional area coverage of sea-ice&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">packages</span>=<span class="hljs-string">&quot;met_stage_out;sfc_update&quot;</span>/&gt;</span><br></code></pre></td></tr></table></figure><h2 id="namelist.init_atmosphere">namelist.init_atmosphere</h2><p>The key namelist options that must be set are shown below; other options can be ignored.</p><p>Note in particular that we have set the <code>config_init_case</code> <strong>variable to 8!</strong> This is the initialization case used to create surface update files, instead of real-data initial conditions files.</p>    <div class="fold">      <div class="fold-title fold-info collapsed" data-toggle="collapse" href="#collapse-98e16488" role="button" aria-expanded="false" aria-controls="collapse-98e16488">        <div class="fold-arrow">▶</div>namelist.init_atmosphere      </div>      <div class="fold-collapse collapse" id="collapse-98e16488">        <div class="fold-content">          <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs namelist.init_atmosphere">&amp;nhyd_model<br>    config_init_case = 8<br>    config_start_time = &#x27;2014-09-10_00:00:00&#x27;<br>    config_stop_time = &#x27;2014-09-20_00:00:00&#x27;<br>/<br><br>&amp;data_sources<br>    config_sfc_prefix = &#x27;SST&#x27; # SST or ERA5: the prefix of the intermediate data files containing SST and sea-ice<br>    config_fg_interval = 86400<br>/<br><br>&amp;preproc_stages<br>    config_static_interp = false<br>    config_native_gwd_static = false<br>    config_vertical_grid = false<br>    config_met_interp = false<br>    config_input_sst = true<br>    config_frac_seaice = true<br>/<br>&amp;decomposition<br>    config_block_decomp_file_prefix = &#x27;x1.10242.graph.info.part.&#x27;<br>/<br></code></pre></td></tr></table></figure>        </div>      </div>    </div><h2 id="streams.init_atmosphere">streams.init_atmosphere</h2><p>We have set both the <code>filename_template</code> and output_interval attributes of the "<code>surface</code>" stream. The <code>output_interval</code> should match the interval specified in the namelist for the <code>config_fg_interval</code> variable. The other streams ("<code>input</code>", "<code>output</code>", and "<code>lbc</code>") can remain unchanged — the input file should still be set to the name of the static file.</p><ul><li>Noted: can set <code>filename_template="sst.$Y-$M-$D_$h.$m.$s.nc"</code></li></ul>    <div class="fold">      <div class="fold-title fold-info collapsed" data-toggle="collapse" href="#collapse-1607c597" role="button" aria-expanded="false" aria-controls="collapse-1607c597">        <div class="fold-arrow">▶</div>streams.init_atmosphere      </div>      <div class="fold-collapse collapse" id="collapse-1607c597">        <div class="fold-content">          <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs streams.init_atmosphere">&lt;immutable_stream name=&quot;surface&quot;<br>                  type=&quot;output&quot;<br>                  filename_template=&quot;x1.10242.sfc_update.nc&quot;<br>                  filename_interval=&quot;none&quot;<br>                  packages=&quot;sfc_update&quot;<br>                  output_interval=&quot;86400&quot;/&gt;<br></code></pre></td></tr></table></figure>        </div>      </div>    </div><h2 id="results">results</h2>    <div class="fold">      <div class="fold-title fold-info collapsed" data-toggle="collapse" href="#collapse-4f34dce5" role="button" aria-expanded="false" aria-controls="collapse-4f34dce5">        <div class="fold-arrow">▶</div>ncdump -h sst.2022-06-30_00.00.00.nc      </div>      <div class="fold-collapse collapse" id="collapse-4f34dce5">        <div class="fold-content">          <figure class="highlight console"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs console"><span class="hljs-meta prompt_"> $ </span><span class="language-bash">ncdump -h sst.2022-06-30_00.00.00.nc</span><br>netcdf sst.2022-06-30_00.00.00 &#123;<br>dimensions:<br>StrLen = 64 ;<br>Time = UNLIMITED ; // (1 currently)<br>nCells = 40962 ;<br>variables:<br>char xtime(Time, StrLen) ;<br>xtime:units = &quot;YYYY-MM-DD_hh:mm:ss&quot; ;<br>xtime:long_name = &quot;Model valid time&quot; ;<br>float sst(Time, nCells) ;<br>sst:units = &quot;K&quot; ;<br>sst:long_name = &quot;sea-surface temperature&quot; ;<br>float xice(Time, nCells) ;<br>xice:units = &quot;unitless&quot; ;<br>xice:long_name = &quot;fractional area coverage of sea-ice&quot; ;<br></code></pre></td></tr></table></figure>        </div>      </div>    </div><h3 id="plot">Plot</h3><ul><li><a href="https://ftp.cptec.inpe.br/pesquisa/das/MPAS-Tutorial-NCAR-2023/mpas_tutorial/240km_uniform/plot_delta_sst.py" class="uri">https://ftp.cptec.inpe.br/pesquisa/das/MPAS-Tutorial-NCAR-2023/mpas_tutorial/240km_uniform/plot_delta_sst.py</a></li><li><code>./plot_delta_sst.py x1.10242.static.nc x1.10242.sfc_update.nc</code></li><li>In this plot, we have masked out the SST differences over land, since the values of the field over land are not representative of actual SST differences, but may represent differences in, e.g., skin temperature or 2-m air temperature, depending on the source of the SST analyses.</li></ul>    <div class="fold">      <div class="fold-title fold-info collapsed" data-toggle="collapse" href="#collapse-05b78603" role="button" aria-expanded="false" aria-controls="collapse-05b78603">        <div class="fold-arrow">▶</div>plot_delta_sst.py      </div>      <div class="fold-collapse collapse" id="collapse-05b78603">        <div class="fold-content">          <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/env python</span><br><br><span class="hljs-keyword">import</span> Ngl<br><span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np<br><span class="hljs-keyword">from</span> netCDF4 <span class="hljs-keyword">import</span> Dataset<br><span class="hljs-keyword">import</span> math<br><span class="hljs-keyword">import</span> sys<br><br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&quot;__main__&quot;</span>:<br><br>    <span class="hljs-comment">#</span><br>    <span class="hljs-comment"># Get the name of the file containing the static information</span><br>    <span class="hljs-comment">#</span><br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(sys.argv) &lt; <span class="hljs-number">2</span> <span class="hljs-keyword">or</span> <span class="hljs-built_in">len</span>(sys.argv) &gt; <span class="hljs-number">3</span>:<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;&#x27;</span>)<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;Usage: &#x27;</span>+sys.argv[<span class="hljs-number">0</span>]+<span class="hljs-string">&#x27; [mesh filename] &lt;field filename&gt;&#x27;</span>)<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;&#x27;</span>)<br>        exit(<span class="hljs-number">0</span>)<br><br>    <span class="hljs-comment">#</span><br>    <span class="hljs-comment"># The (lat,lon) the plot is to be centered over</span><br>    <span class="hljs-comment">#</span><br>    cenLat   = <span class="hljs-number">0.0</span><br>    cenLon   = <span class="hljs-number">0.0</span><br><br>    <span class="hljs-comment">#</span><br>    <span class="hljs-comment"># Projection to use for plot</span><br>    <span class="hljs-comment">#</span><br>    projection = <span class="hljs-string">&#x27;CylindricalEquidistant&#x27;</span><br><br><br>    r2d = <span class="hljs-number">180.0</span> / math.pi             <span class="hljs-comment"># radians to degrees</span><br><br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(sys.argv) == <span class="hljs-number">2</span>:<br>        f = Dataset(sys.argv[<span class="hljs-number">1</span>])<br>        g = f<br>    <span class="hljs-keyword">elif</span> <span class="hljs-built_in">len</span>(sys.argv) == <span class="hljs-number">3</span>:<br>        f = Dataset(sys.argv[<span class="hljs-number">2</span>])<br>        g = Dataset(sys.argv[<span class="hljs-number">1</span>])<br><br>    rlist = Ngl.Resources()<br><span class="hljs-comment">#    rlist.wkWidth = 1200</span><br><span class="hljs-comment">#    rlist.wkHeight = 1200</span><br><br>    rlist.wkColorMap = <span class="hljs-string">&#x27;gui_default&#x27;</span><br><br>    wks_type = <span class="hljs-string">&#x27;png&#x27;</span><br>    wks = Ngl.open_wks(wks_type, <span class="hljs-string">&#x27;delta_sst&#x27;</span>, rlist)<br><br>    lonCell = g.variables[<span class="hljs-string">&#x27;lonCell&#x27;</span>][:] * r2d<br>    latCell = g.variables[<span class="hljs-string">&#x27;latCell&#x27;</span>][:] * r2d<br><br>    res = Ngl.Resources()<br><br>    res.sfXArray             = lonCell<br>    res.sfYArray             = latCell<br><br>    res.cnFillMode           = <span class="hljs-string">&#x27;AreaFill&#x27;</span><br><br>    res.cnFillOn             = <span class="hljs-literal">True</span><br>    res.cnLinesOn            = <span class="hljs-literal">False</span><br>    res.cnLineLabelsOn       = <span class="hljs-literal">False</span><br><br>    res.cnInfoLabelOn        = <span class="hljs-literal">True</span><br><br>    res.lbLabelAutoStride    = <span class="hljs-literal">True</span><br>    res.lbBoxLinesOn         = <span class="hljs-literal">False</span><br><br>    res.mpProjection      = projection<br>    res.mpDataBaseVersion = <span class="hljs-string">&#x27;MediumRes&#x27;</span><br>    res.mpCenterLatF      = cenLat<br>    res.mpCenterLonF      = cenLon<br>    res.mpGridAndLimbOn   = <span class="hljs-literal">True</span><br>    res.mpGridAndLimbDrawOrder = <span class="hljs-string">&#x27;PreDraw&#x27;</span><br>    res.mpGridLineColor   = <span class="hljs-string">&#x27;Background&#x27;</span><br>    res.mpOutlineOn       = <span class="hljs-literal">True</span><br>    res.mpDataBaseVersion = <span class="hljs-string">&#x27;Ncarg4_1&#x27;</span><br>    res.mpDataSetName     = <span class="hljs-string">&#x27;Earth..3&#x27;</span><br>    res.mpOutlineBoundarySets = <span class="hljs-string">&#x27;Geophysical&#x27;</span><br>    res.mpPerimOn         = <span class="hljs-literal">True</span><br>    res.mpLimitMode = <span class="hljs-string">&#x27;LatLon&#x27;</span><br>    res.mpMinLonF = -<span class="hljs-number">180.0</span><br>    res.mpMaxLonF = <span class="hljs-number">180.0</span><br>    res.mpMinLatF = -<span class="hljs-number">90.0</span><br>    res.mpMaxLatF = <span class="hljs-number">90.0</span><br><br>    res.cnLevelSelectionMode = <span class="hljs-string">&#x27;ManualLevels&#x27;</span><br>    res.cnMinLevelValF = -<span class="hljs-number">2.0</span><br>    res.cnMaxLevelValF = <span class="hljs-number">2.0</span><br>    res.cnLevelSpacingF = <span class="hljs-number">0.10</span><br>    res.lbAutoManage = <span class="hljs-literal">False</span><br>    res.lbOrientation = <span class="hljs-string">&#x27;Horizontal&#x27;</span><br>    res.lbBoxEndCapStyle = <span class="hljs-string">&#x27;TriangleBothEnds&#x27;</span><br>    res.lbLabelAngleF = <span class="hljs-number">90.0</span><br>    res.lbLabelFontHeightF = <span class="hljs-number">0.01</span><br><br>    res.mpFillOn              = <span class="hljs-literal">True</span>            <span class="hljs-comment"># Turn on map fill.</span><br>    res.mpFillAreaSpecifiers  = [<span class="hljs-string">&#x27;Land&#x27;</span>]<br>    res.mpSpecifiedFillColors = [<span class="hljs-number">0</span>]<br>    res.mpAreaMaskingOn       = <span class="hljs-literal">True</span>            <span class="hljs-comment"># Indicate we want to </span><br>    res.mpMaskAreaSpecifiers  = [<span class="hljs-string">&#x27;Water&#x27;</span>]<br>    res.cnFillDrawOrder       = <span class="hljs-string">&#x27;Predraw&#x27;</span>       <span class="hljs-comment"># Draw contours first.</span><br><br>    fld = f.variables[<span class="hljs-string">&#x27;sst&#x27;</span>][<span class="hljs-number">10</span>,:] - f.variables[<span class="hljs-string">&#x27;sst&#x27;</span>][<span class="hljs-number">0</span>,:]<br>    <span class="hljs-built_in">map</span> = Ngl.contour_map(wks, fld, res)<br><br>    Ngl.end()<br></code></pre></td></tr></table></figure>        </div>      </div>    </div><p><img src="https://i.imgur.com/Gs7ezqA.png" width="400" /></p><ul><li>or <code>$ ncdiff sst.nc init.nc diff-sst.nc</code></li></ul><h2 id="srccore_atmosphereregistry.xml">src/core_atmosphere/Registry.xml</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">nml_option</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;config_sst_update&quot;</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;logical&quot;</span> <span class="hljs-attr">default_value</span>=<span class="hljs-string">&quot;false&quot;</span></span><br><span class="hljs-tag">      <span class="hljs-attr">units</span>=<span class="hljs-string">&quot;-&quot;</span></span><br><span class="hljs-tag">      <span class="hljs-attr">description</span>=<span class="hljs-string">&quot;logical for configuration of sea-surface temperature&quot;</span></span><br><span class="hljs-tag">      <span class="hljs-attr">possible_values</span>=<span class="hljs-string">&quot;.true. for time-varying sea-surface temperatures; .false., otherwise&quot;</span>/&gt;</span><br></code></pre></td></tr></table></figure><h2 id="streams.atmosphere">streams.atmosphere</h2><ul><li>stream_list.atmosphere.surface</li></ul>    <div class="fold">      <div class="fold-title fold-info collapsed" data-toggle="collapse" href="#collapse-90f62c9b" role="button" aria-expanded="false" aria-controls="collapse-90f62c9b">        <div class="fold-arrow">▶</div>streams.atmosphere      </div>      <div class="fold-collapse collapse" id="collapse-90f62c9b">        <div class="fold-content">          <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs streams.atmosphere">&lt;stream name=&quot;surface&quot;<br>        type=&quot;input&quot;<br>        filename_template=&quot;x1.10242.sfc_update.nc&quot;<br>        filename_interval=&quot;none&quot;<br>        input_interval=&quot;86400&quot;&gt;<br><br>    &lt;file name=&quot;stream_list.atmosphere.surface&quot;/&gt;<br><br>&lt;/stream&gt;<br></code></pre></td></tr></table></figure>        </div>      </div>    </div><h2 id="namelist.atmosphere">namelist.atmosphere</h2>    <div class="fold">      <div class="fold-title fold-info collapsed" data-toggle="collapse" href="#collapse-0994800d" role="button" aria-expanded="false" aria-controls="collapse-0994800d">        <div class="fold-arrow">▶</div>namelist.atmosphere      </div>      <div class="fold-collapse collapse" id="collapse-0994800d">        <div class="fold-content">          <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs namelist.atmosphere">&amp;physics<br>    config_sst_update = true<br></code></pre></td></tr></table></figure>        </div>      </div>    </div><h2 id="plot-diff">Plot diff</h2><p><img src="https://i.imgur.com/7shbwIg.png" width="400" /></p><h1 id="for-wrf">For WRF</h1><ul><li><a href="http://www2.mmm.ucar.edu/wrf/OnLineTutorial/CASES/SST/index.php">Input SST Data into the Model | SST Example from our WRF Online Tutorial</a></li></ul><p>The WRF model physics <strong>do not predict</strong> sea-surface temperature, vegetation fraction, albedo or sea ice. For long simulations, the model provides an alternative to read-in the time-varying data and update these fields (the sst_update option). In order to use this option, one must have access to time-varying SST and sea ice fields. Twelve monthly values of vegetation fraction and albedo are available from the geogrid program. Once these fields are processed via WPS, one may activate the sst_update option within the namelist.input file.</p><p>You will need to input your SST data during the WPS process. Take a look at the <a href="http://www2.mmm.ucar.edu/wrf/OnLineTutorial/CASES/SST/index.php">SST Example from our WRF Online Tutorial</a> for information on how to do this. Because your SST data are in <strong>netcdf format</strong>, however, you will need to write them to intermediate format in order for metgrid to incorporate the data. To do so, you can follow the instructions in <a href="http://www2.mmm.ucar.edu/wrf/users/docs/user_guide_v4/v4.1/users_guide_chap3.html#_Writing_Meteorological_Data">Chapter 3 of the WRF Users' Guide</a>. You can also find an example <a href="http://www2.mmm.ucar.edu/wrf/users/special_code.html">script for writing a netcdf file to intermediate format here</a>. Just note that this script was provided to us from a user who wrote it specifically for their application, so you will need to make modifications for your own use.</p><ul><li>SST's are typically added to the model:<ul><li><ol type="a"><li>Use the SST at the initial time as a constant field for all time periods (this is good for short runs, like real-time runs, where SST is not updated during the WRF model run)</li></ol></li><li><ol start="2" type="a"><li>As an extra input <strong>at each model input time</strong> (this is good for long-months-model runs)</li></ol></li><li><ol start="3" type="a"><li><strong>SST:* intermediate files</strong> generated from the SST input data (if you do not have these files, first run ungrib.exe)</li></ol><ul><li><code>ln -sf ungrib/Variable_Tables/Vtable.SST Vtable</code></li></ul></li></ul></li></ul><h3 id="interpolate-the-input-data-onto-our-model-domain-metgrid.exe">Interpolate the input data onto our model domain (metgrid.exe)</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs namelist">start_date = &#x27;2016-10-06_00:00:00&#x27;,<br>end_date = &#x27;2016-10-08_00:00:00&#x27;,<br>interval_seconds = 21600,<br>fg_name = &#x27;FILE&#x27;, &#x27;SST&#x27;,<br></code></pre></td></tr></table></figure><ul><li><code>./metgrid.exe</code></li><li>generate <code>met_em.d01.xxx.nc</code></li></ul><h3 id="run-model">Run model</h3><ul><li>Run <code>real.exe</code></li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs namelist">&amp;time_control<br>auxinput4_inname = &quot;wrflowinp_d&lt;domain&gt;&quot;,<br>auxinput4_interval = 360,<br>io_form_auxinput4 = 2<br> <br>&amp;physics<br>sst_update = 1,<br></code></pre></td></tr></table></figure><p><strong>Note</strong>: Do not change the syntax "wrflowinp_d&lt;domain&gt;", to "wrflowinp_d01". The syntax should be left exactly as above. Input interval is in minutes.</p><ul><li>generate one more file as <code>wrflowinp_d01</code> that contains <code>SST</code>, <code>VEGFRA</code>, <code>ALBBCK</code> and <code>SEAICE</code> (if available) for each input time.</li><li>Run <code>wrf.exe</code></li><li>To check if <code>SST</code> is updated in the model, look at field <code>TSK</code> over water.</li></ul><h1 id="wrfmpas-a-support-forum">WRF&amp;MPAS-A Support Forum</h1><ul><li><a href="https://forum.mmm.ucar.edu/threads/mpas-tutorial-questions-about-ungrid-and-sst-data.13510/">MPAS tutorial questions about ungrid and SST data | Jun 2023</a><ul><li><ol type="1"><li>Starting from WPSV4.3, a configure option, --nowrf, has been added to allow for configuration of the WPS without reference to a compiled WRF model. if you only need the ungrib component of the WPS, you can compile WPS with this option.</li></ol></li><li><ol start="2" type="1"><li>Most of the reanalysis products like GFS, ERA5 etc include SST. When you run ungrib to extract variables from the reanalysis data, SST will be included in the intermediate file.</li></ol></li></ul></li><li><a href="https://forum.mmm.ucar.edu/threads/sst-update-on-the-lakes.13717/">SST update on the lakes | Jul 2023</a><ul><li>SST_UPDATE only works over water points, i.e., those grid points where landmask =0. Those points with lakemask =1 should correspond to points with landmask=0, and thus sst_update should apply to such points.</li></ul></li><li><a href="https://forum.mmm.ucar.edu/threads/mpas-sst-update-file.8874/">MPAS SST update file | Feb 2020</a></li><li><a href="https://forum.mmm.ucar.edu/threads/updating-sst-not-working.200/">Updating SST not working | Sep 2018</a><ul><li>forrtl: severe (64): input conversion error, unit -5, file Internal List-Directed Read</li><li>The issue seems to be that parts of the timestamp string ('xtime') that are read from input files contain garbage, which confuses the parsing code in the timekeeping module.</li></ul></li></ul>]]></content>
    
    
    <categories>
      
      <category>MPAS</category>
      
    </categories>
    
    
    <tags>
      
      <tag>NWP</tag>
      
      <tag>WRF</tag>
      
      <tag>MPAS</tag>
      
      <tag>ERA5</tag>
      
      <tag>PGW</tag>
      
      <tag>GFS</tag>
      
      <tag>GRIB</tag>
      
      <tag>NetCDF</tag>
      
      <tag>CMIP6</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>MPAS | WRF | Solar Energy</title>
    <link href="/2025/02/12/MPAS-WRF-Solar-Energy/"/>
    <url>/2025/02/12/MPAS-WRF-Solar-Energy/</url>
    
    <content type="html"><![CDATA[<h1 id="太陽輻射">太陽輻射</h1><ul><li>陽光從太陽到達地球表面的過程中，有部分直接穿越大氣層到達地面，稱為<strong>太陽直接輻射</strong>。</li><li>其餘的太陽光因被大氣中的空氣分子、水蒸氣及塵粒所散射或反射，而以間接的路徑抵達地面，稱為<strong>太陽漫射輻射</strong>。</li><li><strong>總太陽輻射</strong>是指所有到達地面的太陽光，即太陽直接輻射及太陽漫射輻射的總和。</li><li>Units: W/m2</li><li>在晴天，海平面上的最大正常全天空日射約為 <span class="math inline">\(1000 W/m^{2}\)</span></li></ul><p>太陽能是最充裕的再生能源，故此有需要多加了解它的強度。科學界普遍認為如果我們能收集所有到達地面的太陽能一個小時，便能滿足全球一年的能源需要。為減少對石化燃料的依賴，開發高效的太陽能技術，並將太陽能轉化為可用電能，已迅速成為全球為未來發展清潔能源的方向。太陽直接輻射及太陽漫射輻射的資料有助設計及製造高能源效益的裝置，減少對大型空氣調節設備，如冷氣機或暖氣機等的依賴。</p><p>香港天文台自一九五八年開始量度總太陽輻射，現時天文台分別在京士柏氣象站和西貢的滘西洲太陽輻射站量度太陽直接輻射及太陽漫射輻射數據。太陽漫射輻射是利用一部能遮蔽太陽直射的總日射表來量度，而太陽直接輻射則利用安裝在太陽自動追蹤裝置上，並對準太陽的直接日射表來量度。</p><ul><li>Global Horizontal Irradiance (GHI, Units: W/m2)<ul><li>Global horizontal irradiance is the total solar radiation per unit area measured at a <strong>horizontal surface on the earth</strong>. It is typically presented in W/m2 and can be broken down into two components: direct normal irradiance (DNI) and diffuse horizontal irradiance (DHI)</li><li>The solar zenith angle of the Sun z</li><li><span class="math display">\[ \text{GHI} = \text{DHI} + \text{DNI} \times \cos (z) \]</span></li></ul></li><li>Direct Normal Irradiance (DNI)</li><li>Diffuse Horizontal Irradiance (DIF or DHI)</li><li>Clear-Sky Irradiance<ul><li>Irradiance calculated prior to taking cloud cover into consideration. Clear-sky irradiance is calculated based on solar geometry, elevation, water vapor, ozone, albedo, aerosol optical depth, wind speed and temperature.</li><li>Clear-sky irradiance data is helpful when using solar resource data to analyze PV system performance. It helps in differentiating between cloudy conditions and other circumstances that may be affecting plant performance, such as equipment failure or losses due to snow cover or soiling.</li></ul></li></ul><div class="group-image-container"><div class="group-image-row"><div class="group-image-wrap"><img src="https://i.imgur.com/gXPusJ6.png" /></div><div class="group-image-wrap"><img src="https://i.imgur.com/fAEkJgV.png" /></div></div><div class="group-image-row"></div></div><p><img src="https://i.imgur.com/GlRJZm8.png" /></p><h2 id="τhe-absorption-bands-of-earths-atmosphere">Τhe absorption bands of Earth's atmosphere</h2><p>Τhe absorption bands of Earth's atmosphere (grey colour) delimit its atmospheric windows (middle panel) and the effect they have on both downgoing solar radiation and upgoing thermal radiation emitted near the surface is shown in the top panel. The individual absorption spectra of major greenhouse gases plus Rayleigh scattering are shown in the lower panel.</p><p><img src="https://upload.wikimedia.org/wikipedia/commons/thumb/5/55/Atmospheric_Transmission.svg/614px-Atmospheric_Transmission.svg.png" /></p><h1 id="ecmwf-ifs-era5-ssrd">ECMWF | IFS | ERA5 : SSRD</h1><ul><li><a href="https://confluence.ecmwf.int/pages/viewpage.action?pageId=111155332">What are the definitions of the radiation fields?</a><ul><li><code>"Surface solar radiation downwards" (SSRD)</code> is the incident solar (shortwave) radiation and <code>"surface solar radiation" (SSR)</code> is the net solar radiation (the fraction of solar radiation not reflected by the surface). <code>"Surface net solar radiation, clear sky" (SSRC)</code> is a hypothetical field of net solar radiation assuming no clouds.</li><li><code>"Surface thermal radiation downwards" (STRD)</code> is the incident thermal (longwave) radiation and <code>"surface thermal radiation" (STR)</code> is the net thermal radiation. <code>"Surface net thermal radiation, clear sky" (STRC)</code> is a hypothetical field of net thermal radiation assuming no clouds.</li><li>"Top solar radiation" is the net solar (shortwave) radiation at the top of the atmosphere (TOA). "Top net solar radiation, clear sky" is a hypothetical field assuming no clouds.</li><li>"Top thermal radiation" is the net thermal (longwave) radiation at the top of the atmosphere. "Top net thermal radiation, clear sky" is a hypothetical field assuming no clouds.</li></ul></li></ul><p><strong>Additional details on radiation parameters can be found here</strong>: <a href="https://www.ecmwf.int/sites/default/files/elibrary/2015/18490-radiation-quantities-ecmwf-model-and-mars.pdf">Radiation-quantities-ecmwf-model-and-mars.pdf (document correct as of Cycle 41R1)</a></p><h2 id="details-of-the-variable">Details of the Variable:</h2><ul><li><strong>Name</strong>: Surface Solar Radiation Downwards (SSRD)</li><li><strong>GRIB Parameter ID</strong>: 169 (in GRIB format, as used by ECMWF)</li><li><strong>Units</strong>: J/m² (accumulated over a time step, typically hourly or 3-hourly depending on the dataset)</li><li><strong>Description</strong>: This is the amount of solar radiation (shortwave) reaching the surface of the Earth, integrated over a specified time period. To convert it to an average irradiance in W/m², you divide the accumulated value (J/m²) by the time step in seconds (e.g., 3600 seconds for hourly data).</li></ul><h3 id="notes">Notes:</h3><ol type="1"><li><strong>Availability</strong>: SSRD is available in many ECMWF IFS outputs, including the high-resolution deterministic forecast (HRES), ensemble forecasts (ENS), and reanalysis products like ERA5.</li><li><strong>Direct vs. Diffuse</strong>: SSRD includes both direct and diffuse radiation. If you specifically need <strong>Direct Normal Irradiance (DNI)</strong> or diffuse components, these are not directly provided as separate variables in standard IFS outputs. However, they can sometimes be derived using additional post-processing or from specialized datasets (e.g., CAMS radiation services, which use IFS data).</li></ol><h3 id="practical-example">Practical Example:</h3><p>If you retrieve SSRD from an hourly ERA5 dataset and the value is 720,000 J/m² over a 1-hour period, the average irradiance is:</p><p><span class="math display">\[720,000 \text{J/m² ÷} 3600 \text{s} = 200 \text{W/m²}\]</span></p><h2 id="radiation-quantities">** Radiation Quantities</h2><h3 id="conventions">Conventions</h3><p>The following conventions are employed in the storage of fluxes by the ECMWF model:</p><ol type="1"><li>Archived fluxes are either <strong>downward</strong> or <strong>net</strong>. Energy entering the Earth's atmosphere-surface system is taken as a positive quantity, and therefore downward fluxes are positive and net flux refers to the downward flux minus the upward flux. To obtain the upward flux (<span class="math inline">\(F^{up}\)</span>) from the downward flux (<span class="math inline">\(F^{dn}\)</span>) and net flux (<span class="math inline">\(F^{net}\)</span>), use <span class="math inline">\(F^{up} = F^{dn} - F^{net}\)</span>.</li><li>Physical fluxes archived by the ECMWF model are <strong>accumulated</strong> since the start of the relevant forecast, and therefore in <strong>units of J m⁻² (or W m⁻² s)</strong>. Thus, a daily mean (in W m⁻²) is obtained by retrieving the accumulated fluxes at <span class="math inline">\(t_1 = t\)</span> and <span class="math inline">\(t_2 = t + 24\)</span> hours (where <span class="math inline">\(t\)</span> is the time of the start of the average), taking the difference and dividing by <span class="math inline">\(86400\)</span>, the number of seconds in a day.</li><li><strong>Clear-sky</strong> quantities are computed for exactly the same atmospheric conditions of temperature, humidity, ozone, trace gases and aerosol, but assuming that <em>the clouds are not there</em>.<ol type="1"><li><strong>Clear-sky irradiance</strong> represents the solar energy reaching the Earth's surface at a specific location and time, assuming there are no clouds present. It's the <em>theoretical maximum irradiance</em>, which is reduced by cloud cover in real-world conditions. Clear-sky irradiance is influenced by factors such as the Earth-Sun distance and their relative positions.</li><li><strong>All-sky irradiance</strong> considers all scattering and absorption by gases, aerosols, and clouds. It is another name for <strong>"global horizontal irradiance" (GHI)</strong>, which is the total solar irradiance (direct plus diffuse) incident on a horizontal surface. Semi-empirical models produce all-sky irradiance as a final output, accounting for all atmospheric factors, including cloud cover.</li></ol></li><li><strong>Solar</strong> or <strong>short-wave</strong> refers to radiation emitted by the Sun, then scattered, absorbed or transmitted by the atmosphere and reflected or absorbed by the surface. It corresponds roughly to the <span class="math inline">\(0.2-4 \mu m\)</span> or <span class="math inline">\(50,000–2600 cm^{-1}\)</span> part of the spectrum. Thermal, <strong>terrestrial</strong> or <strong>long-wave</strong> refers to radiation emitted and absorbed by the surface or by gases, clouds and particles within the atmosphere. It corresponds roughly to the <span class="math inline">\(4–100 \mu m\)</span> or <span class="math inline">\(2600–10 cm^{-1}\)</span> part of the spectrum. Note that there is some spectral overlap between the two, which is fully represented in the model, so the division between solar and thermal radiation should not be thought of as simply radiation with a wavelength shorter or longer than <span class="math inline">\(4 \mu m\)</span>, but rather as radiation originating from the sun versus originating from emission by the Earth or its atmosphere.</li></ol><div class="group-image-container"><div class="group-image-row"><div class="group-image-wrap"><img src="https://i.imgur.com/pjyvEAB.png" /></div><div class="group-image-wrap"><img src="https://i.imgur.com/cHjHFhO.png" /></div></div><div class="group-image-row"><div class="group-image-wrap"><img src="https://i.imgur.com/e49unoQ.png" /></div><div class="group-image-wrap"><img src="https://i.imgur.com/5NVZC7h.png" /></div></div><div class="group-image-row"></div></div><h3 id="earths-energy-budget-diagram">Earth's Energy Budget Diagram</h3><p>In its orbit around the Sun, the part of Earth that faces the Sun receives approximately <span class="math inline">\(1,371 W/m2\)</span> of energy. Averaged over the area of Earth's full sphere, the energy from sunlight coming to the top of the atmosphere is approximately <span class="math inline">\(340 W/m2\)</span>.</p><figure><img src="https://i.imgur.com/QhR1rAk.png" alt="Scientists have been able to document global incoming and outgoing radiation averages, which provide an understanding of how energy is absorbed, reflected, and released by Earth&#39;s atmosphere, clouds, and surface. The numbers in parentheses represent the uncertainty range, or variability, associated with these averages. IPCC, WG1, 2021" width="500" /><figcaption>Scientists have been able to document global incoming and outgoing radiation averages, which provide an understanding of how energy is absorbed, reflected, and released by Earth's atmosphere, clouds, and surface. The numbers in parentheses represent the uncertainty range, or variability, associated with these averages. IPCC, WG1, 2021</figcaption></figure><hr /><h1 id="gfs-dswrf">GFS: DSWRF</h1><p>The Global Forecast System (GFS) model is used to predict solar power generation by forecasting various weather parameters, including downward short-wave radiation flux (DSWRF). The GFS model is run daily at 00, 06, 12, and 18 UTC, providing hourly forecasts for up to 120 hours.</p><p>Here's how the GFS model and DSWRF are used in solar energy predictions:</p><ul><li><strong>DSWRF Parameter:</strong> GFS uses the DSWRF parameter, labeled as a "0-3 hour ave".</li><li><strong>NWP Variables:</strong> The GFS model uses nine Numerical Weather Prediction (NWP) variables to predict solar generation at a site. These include shortwave radiation, cloud cover, air temperature, wind speed, and precipitation.</li><li><strong>Inputs for Models:</strong> The parameters derived from GFS are used as inputs for solar irradiance models.</li><li><strong>Calibration:</strong> GFS solar irradiation forecasts can be calibrated to improve accuracy.</li><li><strong>Bias Correction:</strong> Correcting cloud cover bias in GFS-derived cloud forecasts can improve energy forecasts.</li></ul><hr /><h1 id="wrf">WRF</h1><p>WRF can output the following variables that meet your need:</p><ul><li><code>GHI</code> should be in the output. It is a variable called <code>SWDOWN</code>. <a href="https://forum.mmm.ucar.edu/threads/solar_diagnostics-output-variables-not-showing-in-wrfout.10871/">link</a><ul><li>The direct normal irradiance (<code>DNI</code>) and the diffuse irradiance are exposed via the Registry. You need to edit the file <code>Registry.EM_COMMON</code> and add the variables <code>SWDDNI</code> and <code>SWDDIF</code> to the WRF output by adding a <code>h</code> in the IO part of the table for these variables.</li><li>Please <strong>recompile WRF</strong> after you change Registry. Remember to type <code>./clean -a</code> before recompile the codes.</li></ul></li><li><code>SWDDIR</code> "Shortwave surface downward direct irradiance" "W m-2" ""</li><li><code>SWDDIF</code> "Shortwave surface downward diffuse irradiance" "W m-2" ""</li></ul><h1 id="wrf-solar">WRF-Solar</h1><ul><li><a href="https://ral.ucar.edu/solutions/products/wrf-solar" class="uri">https://ral.ucar.edu/solutions/products/wrf-solar</a></li><li><a href="https://forum.mmm.ucar.edu/threads/problem-with-wrf-solar-output-swddni-and-swddif.11345/">Problem With WRF-Solar Output SWDDNI and SWDDIF.</a></li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs Registry.EM_Common">state real swddir ij misc 1 - rhd &quot;SWDDIR&quot; &quot;Shortwave surface downward direct irradiance&quot; &quot;W m-2&quot; &quot;&quot;<br>state real swddir2 ij misc 1 - rhd &quot;SWDDIR2&quot; &quot;Shortwave surface downward direct irradiance from FARMS&quot; &quot;W m-2&quot; &quot;&quot;<br>state real swddirc ij misc 1 - rhd &quot;SWDDIRC&quot; &quot;Clear-sky Shortwave surface downward direct irradiance&quot; &quot;W m-2&quot; &quot;&quot;<br>state real swddni ij misc 1 - rhd &quot;SWDDNI&quot; &quot;Shortwave surface downward direct normal irradiance&quot; &quot;W m-2&quot; &quot;&quot;<br>state real swddni2 ij misc 1 - rhd &quot;SWDDNI2&quot; &quot;Shortwave surface downward direct normal irradiance from FARMS&quot; &quot;W m-2&quot; &quot;&quot;<br>state real swddnic ij misc 1 - rhd &quot;SWDDNIC&quot; &quot;Clear-sky Shortwave surface downward direct normal irradiance&quot; &quot;W m-2&quot; &quot;&quot;<br>state real swddnic2 ij misc 1 - rhd &quot;SWDDNIC2&quot; &quot;Clear-sky Shortwave surface downward direct normal irradiance from FARMS&quot; &quot;W/m^2&quot; &quot;&quot;<br>state real swddif ij misc 1 - rhd &quot;SWDDIF&quot; &quot;Shortwave surface downward diffuse irradiance&quot; &quot;W m-2&quot; &quot;&quot;<br>state real swddif2 ij misc 1 - rhd &quot;SWDDIF2&quot; &quot;Shortwave surface downward diffuse irradiance from FARMS&quot; &quot;W m-2&quot; &quot;&quot;<br></code></pre></td></tr></table></figure><ul><li>雲和氣溶膠對太陽輻射的模擬影響最大，在簡單的WRF模式中，要充分考慮氣溶膠的化學過程，導致陰雨天太陽輻射的不良可信度散射，可用性不高。</li><li>WRF-SOLAR積分模式考慮了氣溶膠對輻射的回饋和淺積分雲對輻射的回饋，很大程度上提高了太陽輻射的得分。</li><li>WRF-Solar可以輸出直接輻射（直接法向輻照度，DNI）和散射輻射（漫射輻照度，DNI）。</li><li>WRF-4.2以後的版本改進了相關的實體參數化方案，官方建議使用4.2.2或以上的版本。</li></ul><h1 id="mpas">MPAS</h1><ul><li><strong>MPAS v8.0.0</strong></li><li>In ./src/core_atmosphere/physics, added the variables swddir, swddni, and swddif. All three variables are output from rrtmg_swrad and input to the updated Noah land surface scheme. <a href="https://github.com/MPAS-Dev/MPAS-Model/commit/54d934448a62f65971218bd554e7db5343b7c750">Commit 54d9344</a></li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs src/core_atmosphere/Registry.xml">&lt;var name=&quot;swddir&quot; type=&quot;real&quot; dimensions=&quot;nCells Time&quot; units=&quot;W m^&#123;-2&#125;&quot;<br>        description=&quot;shortwave surface downward direct irradiance&quot;/&gt;<br><br>&lt;var name=&quot;swddni&quot; type=&quot;real&quot; dimensions=&quot;nCells Time&quot; units=&quot;W m^&#123;-2&#125;&quot;<br>        description=&quot;shortwave surface downward direct normal irradiance&quot;/&gt;<br><br>&lt;var name=&quot;swddif&quot; type=&quot;real&quot; dimensions=&quot;nCells Time&quot; units=&quot;W m^&#123;-2&#125;&quot;<br>        description=&quot;shortwave surface downward diffuse irradiance&quot;/&gt;<br></code></pre></td></tr></table></figure><h1 id="references">References</h1><ol type="1"><li><a href="https://www.hko.gov.hk/tc/wxinfo/ts/display_element_solar.htm">太陽輻射量的二十四小時時間序列 | HKO</a></li><li><a href="https://www.hko.gov.hk/tc/radiation/tidbit/201003/solar.htm">輻射小知識 - 太陽輻射 | HKO</a></li><li><a href="https://www.cma.gov.cn/zfxxgk/gknr/flfgbz/bz/202209/P020220921561224172396.pdf">中华人民共和国国家标准 | 太阳总辐射辐照量划分 | 2014</a></li><li><a href="https://www.liuchunhua.me/post/industry/utility_wrfonaws/wrfonaws/">[能源] WRF on AWS | 2021</a></li><li><a href="https://www.nusc.gov.tw/share/file/information/fl-Tg5gcH6VoFxiLPkPRGA__.pdf">行政院原子能委員會委託研究計畫研究報告 | 2016</a></li><li><a href="https://epjournal.csee.org.cn/tyn/cn/article/pdf/preview/10.19911/j.1003-0417.tyn20220121.02.pdf">太阳辐射预报方法分类与评述 | 2023</a></li><li><a href="https://zhuanlan.zhihu.com/p/557953099">光伏发电预测——WRF-Solar</a></li><li><a href="https://solar-energy-connection.com/what-is-the-clear-sky-irradiance/">What is the clear sky irradiance?</a></li></ol>]]></content>
    
    
    <categories>
      
      <category>MPAS</category>
      
    </categories>
    
    
    <tags>
      
      <tag>NWP</tag>
      
      <tag>WRF</tag>
      
      <tag>MPAS</tag>
      
      <tag>ERA5</tag>
      
      <tag>GFS</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>MPAS | Physics and Physics Configurations, Profiling computing time</title>
    <link href="/2025/02/11/MPAS-Physics-and-Physics-Configurations/"/>
    <url>/2025/02/11/MPAS-Physics-and-Physics-Configurations/</url>
    
    <content type="html"><![CDATA[<h1 id="physics-and-physics-configurations">Physics and Physics Configurations</h1><div class="group-image-container"><div class="group-image-row"><div class="group-image-wrap"><img src="https://i.imgur.com/siMEUS9.png" /></div><div class="group-image-wrap"><img src="https://i.imgur.com/BO0rB71.png" /></div><div class="group-image-wrap"><img src="https://i.imgur.com/rc5XBgi.png" /></div></div><div class="group-image-row"><div class="group-image-wrap"><img src="https://i.imgur.com/ABJTiRl.png" /></div></div></div><h1 id="profiling-computing-time-of-mpas">Profiling computing time of MPAS</h1><p>the timer information that is printed at the bottom of the log.atmosphere.0000.out file.</p><p>The total runtime for a simulation includes time not spent in initialization or counted as time integration; for example, time spent writing output files isn't counted as "time integration".</p><p>The "parallel efficiency" is defined as the average time for a region across all MPI tasks divided by the maximum time for that region across all tasks.</p><p>Hopefully this helps, and if you have any additional questions about timers, please feel free to follow up in this thread.</p><div class="group-image-container"><div class="group-image-row"><div class="group-image-wrap"><img src="https://i.imgur.com/TJAfYme.png" /></div><div class="group-image-wrap"><img src="https://i.imgur.com/wtb6Ilv.png" /></div></div><div class="group-image-row"></div></div><figure class="highlight console"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs console">Timer information:<br>   Globals are computed across all threads and processors<br> <br>Columns:<br>   total time: Global max of accumulated time spent in timer<br>   calls: Total number of times this timer was started / stopped.<br>   min: Global min of time spent in a single start / stop<br>   max: Global max of time spent in a single start / stop<br>   avg: Global max of average time spent in a single start / stop<br>   pct_tot: Percent of the timer at level 1<br>   pct_par: Percent of the parent timer (one level up)<br>   par_eff: Parallel efficiency, global average total time / global max total time<br></code></pre></td></tr></table></figure><h1 id="references">References</h1><ol type="1"><li><a href="http://www.gpsarc.ncu.edu.tw/MPAS2023/slide/MPAS_A/6-MPAS_physics_202310.pdf">Physics and Physics Configurations in MPAS| Wei Wang | NCAR/MMM MPAS-A and MPAS-JEDI Tutorials, 23-26 October 2023, Taiwan</a></li><li><a href="https://www.sciencedirect.com/science/article/pii/S0098300420306051">Kim, Jae Youp, Ji-Sun Kang, and Minsu Joh. "GPU acceleration of MPAS microphysics WSM6 using OpenACC directives: Performance and verification." Computers &amp; Geosciences 146 (2021): 104627.</a><ol type="1"><li><a href="https://www.cisl.ucar.edu/sites/default/files/2021-10/KISTI%20-%20Joh%2C%20Kang%2C%20%26%20Kim.pdf">PPT</a><ol type="1"><li><strong>Profiling computing time of MPAS</strong></li></ol></li></ol></li><li><a href="https://www.sciencedirect.com/science/article/am/pii/S0021999121007130">Capodaglio, G., &amp; Petersen, M. (2022). Local time stepping for the shallow water equations in MPAS. Journal of Computational Physics, 449, 110818.</a></li></ol>]]></content>
    
    
    <categories>
      
      <category>MPAS</category>
      
    </categories>
    
    
    <tags>
      
      <tag>NWP</tag>
      
      <tag>WRF</tag>
      
      <tag>MPAS</tag>
      
      <tag>ERA5</tag>
      
      <tag>GFS</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>NWP | Pressure Altitude Calculator</title>
    <link href="/2025/02/07/NWP-Pressure-Altitude-Calculator/"/>
    <url>/2025/02/07/NWP-Pressure-Altitude-Calculator/</url>
    
    <content type="html"><![CDATA[<h1 id="pressure-altitude-calculator">Pressure Altitude Calculator</h1><p>Pressure Altitude</p><ul><li><a href="https://www.weather.gov/epz/wxcalc_pressurealtitude">Pressure Altitude Calculator | NOAA</a></li><li><a href="https://www.weather.gov/epz/wxcalc_pressurealtitude">What is the formula for the pressure altitude script?</a></li></ul><p>From the user, a station pressure (<span class="math inline">\(P_{sta}\)</span>) is given. To calculate the pressure altitude, the station pressure must be in units of millibars (mb). To see how to convert station pressure to millibars see the link below: Pressure Conversion Then, the pressure altitude (<span class="math inline">\(h_{alt}\)</span>) can be calculated using the equation below:</p><p><span class="math display">\[h_{alt} = \left(1 - \left(\frac{P_{sta}}{1013.25}\right)^{0.190284}\right) × 145366.45\]</span></p><p>The answer will be in units of feet. To convert the answer to units of meters, see the equation below:</p><p><span class="math display">\[hm = 0.3048 × h_{alt}\]</span></p>]]></content>
    
    
    <categories>
      
      <category>NWP</category>
      
    </categories>
    
    
    <tags>
      
      <tag>NWP</tag>
      
      <tag>WRF</tag>
      
      <tag>MPAS</tag>
      
      <tag>ERA5</tag>
      
      <tag>PGW</tag>
      
      <tag>GFS</tag>
      
      <tag>GRIB</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>NWP | PGW | Order of Pressure levels of GRIB file</title>
    <link href="/2025/02/06/NWP-PGW-Order-of-Pressure-levels-of-GRIB-file/"/>
    <url>/2025/02/06/NWP-PGW-Order-of-Pressure-levels-of-GRIB-file/</url>
    
    <content type="html"><![CDATA[<div class="note note-primary">            <p><a href="https://waipangsze.github.io/2025/02/03/NWP-PGW-hands-on-ERA5-GFS/"><strong>NWP | Pseudo-Global-Warming (PGW) hands-on | ERA5 | GFS</strong></a></p>          </div><div class="note note-primary">            <p><a href="https://waipangsze.github.io/2025/02/05/NWP-ERA5-GRIB1-GRIB2/"><strong>NWP | ERA5 | GRIB1 and GRIB2</strong></a></p>          </div><p>In GRIB files, the order of pressure levels is important because many tools expect them to be sorted either in ascending (from surface to top of the atmosphere) or descending (from top of the atmosphere to surface) order. Here's how you can <strong>ensure the order of pressure levels</strong> and <strong>reverse them</strong> using tools like <code>cdo</code> or <code>grib_set</code>.</p><hr /><h3 id="step-1-check-the-current-order-of-pressure-levels"><strong>Step 1: Check the Current Order of Pressure Levels</strong></h3><p>To inspect the order of pressure levels in the GRIB file, use the following commands:</p><ol type="1"><li><p><strong>Using <code>grib_ls</code></strong>: <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">grib_ls -p level era5_with_signal.grib<br></code></pre></td></tr></table></figure> This lists the levels (<code>level</code>) in the GRIB file. Check if they are in ascending or descending order.</p></li><li><p><strong>Using <code>cdo</code></strong>: <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">cdo showlevel era5_with_signal.grib<br></code></pre></td></tr></table></figure> This outputs the pressure levels in the order they appear in the file.</p></li></ol><hr /><h3 id="step-2-ensure-ascending-or-descending-order"><strong>Step 2: Ensure Ascending or Descending Order</strong></h3><p>If the pressure levels are not in the desired order, you can reorder them using <code>cdo</code>.</p><h4 id="ensure-ascending-order-surface-to-top-of-atmosphere"><strong>Ensure Ascending Order (Surface to Top of Atmosphere)</strong></h4><p>To reorder pressure levels in ascending order (e.g., 1000 hPa → 850 hPa → ... → 10 hPa):</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">cdo vertsort era5_with_signal.grib era5_sorted_ascending.grib<br></code></pre></td></tr></table></figure><p>The <code>vertsort</code> operation ensures that the levels are sorted in ascending order.</p><hr /><h4 id="ensure-descending-order-top-of-atmosphere-to-surface"><strong>Ensure Descending Order (Top of Atmosphere to Surface)</strong></h4><p>To reorder pressure levels in descending order (e.g., 10 hPa → 100 hPa → ... → 1000 hPa), use the <code>vertsort</code> operation and then reverse the order:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">cdo invertlev era5_with_signal.grib era5_sorted_descending.grib<br></code></pre></td></tr></table></figure><p>The <code>invertlev</code> operation reverses the order of the vertical levels.</p><hr /><h3 id="step-3-verify-the-new-order"><strong>Step 3: Verify the New Order</strong></h3><p>After reordering the levels, verify the result:</p><ol type="1"><li><p><strong>Using <code>grib_ls</code></strong>: <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">grib_ls -p level era5_sorted_ascending.grib<br>grib_ls -p level era5_sorted_descending.grib<br></code></pre></td></tr></table></figure></p></li><li><p><strong>Using <code>cdo</code></strong>: <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">cdo showlevel era5_sorted_ascending.grib<br>cdo showlevel era5_sorted_descending.grib<br></code></pre></td></tr></table></figure></p></li></ol><p>Ensure that the levels are in the desired order.</p><hr /><h3 id="step-4-for-netcdf-files"><strong>Step 4: For NetCDF Files</strong></h3><p>If you are working with a NetCDF file (<code>era5_with_signal.nc</code>) and need to reorder the pressure levels:</p><h4 id="ascending-order"><strong>Ascending Order</strong></h4><p>Use <code>cdo vertsort</code> for NetCDF files as well:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">cdo vertsort era5_with_signal.nc era5_sorted_ascending.nc<br></code></pre></td></tr></table></figure><h4 id="descending-order"><strong>Descending Order</strong></h4><p>Use <code>cdo invertlev</code> to reverse the order:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">cdo invertlev era5_with_signal.nc era5_sorted_descending.nc<br></code></pre></td></tr></table></figure><hr /><h3 id="additional-tips">Additional Tips:</h3><ol type="1"><li><p><strong>Regrid if Necessary</strong>: If the pressure levels are missing or inconsistent, you can interpolate them to a standard set using <code>cdo intlevel</code>. For example:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">cdo intlevel,1000,850,500,250 era5_with_signal.nc era5_regridded_levels.nc<br></code></pre></td></tr></table></figure></li><li><p><strong>Metadata Consistency</strong>: Ensure that the <code>typeOfLevel</code> (e.g., <code>isobaricInhPa</code>) is correctly set, especially after reordering or interpolating levels. Use <code>grib_set</code> if needed:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">grib_set -s typeOfLevel=isobaricInhPa era5_sorted_ascending.grib era5_final.grib<br></code></pre></td></tr></table></figure></li></ol><hr /><h3 id="summary-of-commands">Summary of Commands:</h3><ol type="1"><li><p><strong>Check the current order of levels</strong>: <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">grib_ls -p level era5_with_signal.grib<br>cdo showlevel era5_with_signal.grib<br></code></pre></td></tr></table></figure></p></li><li><p><strong>Ensure ascending order (surface to top)</strong>: <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">cdo vertsort era5_with_signal.grib era5_sorted_ascending.grib<br></code></pre></td></tr></table></figure></p></li><li><p><strong>Ensure descending order (top to surface)</strong>: <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">cdo invertlev era5_with_signal.grib era5_sorted_descending.grib<br></code></pre></td></tr></table></figure></p></li><li><p><strong>Verify the new order</strong>: <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">grib_ls -p level era5_sorted_ascending.grib<br>cdo showlevel era5_sorted_ascending.grib<br></code></pre></td></tr></table></figure></p></li><li><p><strong>For NetCDF files</strong>: <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">cdo vertsort era5_with_signal.nc era5_sorted_ascending.nc<br>cdo invertlev era5_with_signal.nc era5_sorted_descending.nc<br></code></pre></td></tr></table></figure></p></li></ol><h1 id="references">References</h1><ol type="1"><li><a href="https://code.mpimet.mpg.de/projects/cdo/wiki/tutorial#Basic-Usage">Climate Data Operators (CDO) Tutorial (<strong>recommend</strong>)</a></li></ol>]]></content>
    
    
    <categories>
      
      <category>NWP</category>
      
    </categories>
    
    
    <tags>
      
      <tag>NWP</tag>
      
      <tag>WRF</tag>
      
      <tag>MPAS</tag>
      
      <tag>ERA5</tag>
      
      <tag>PGW</tag>
      
      <tag>GFS</tag>
      
      <tag>GRIB</tag>
      
      <tag>NetCDF</tag>
      
      <tag>CMIP6</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>NWP | ERA5 | GRIB1 and GRIB2</title>
    <link href="/2025/02/05/NWP-ERA5-GRIB1-GRIB2/"/>
    <url>/2025/02/05/NWP-ERA5-GRIB1-GRIB2/</url>
    
    <content type="html"><![CDATA[<div class="note note-primary">            <p><a href="https://waipangsze.github.io/2023/05/06/GRIB1_GRIB2_NetCDF/"><strong>WRF | GRIB1, GRIB2, NetCDF</strong></a></p>          </div><div class="note note-primary">            <p><a href="https://waipangsze.github.io/2024/08/16/ERA5-2024-upgrade/"><strong>ERA5 CDS upgrade (2024 Sep)</strong></a></p>          </div><hr /><h1 id="grib">GRIB</h1><p>GRIB is a WMO format for gridded data. GRIB is used by the operational meteorological centers for storage and the exchange of gridded fields. GRIB's major advantages are files are typically 1/2 to 1/3 of the size of normal binary files (floats), the fields are self describing, and GRIB is an open, international standard.</p><p>GRIB stands for "General Regularly distributed Information in Binary form" and is a WMO (World Meteorological Organisation) standard format for archiving and exchanging gridded data. GRIB is a binary format, and the data is packed to increase storage efficiency. GRIB messages are often concatenated together to form a GRIB file. GRIB files usually have the extension .grib, .grb or .gb.</p><p>Currently there are two different coding standards: GRIB edition 1 (commonly referred to as GRIB1) and GRIB edition 2 (GRIB2). The major differences are in the structure of the messages; in GRIB2, several variables are defined with more precision (e.g. in GRIB1, latitudes and longitudes are in milli-degrees while in GRIB2, they are in micro-degrees). Also in GRIB2, longitude values must lie between 0 and 360 degrees), the encoding of the parameter is very different, and in GRIB2 the description of the data is template/table based. Note that a GRIB file can contain a mix of GRIB1 and GRIB2 messages.</p><p>The ECMWF model (the Integrated Forecasting System, IFS) currently outputs model-level fields in GRIB2 while pressure and surface level outputs are produced in GRIB1. For example,ERA-Interim (a climate reanalysis dataset provided by ECMWF) is produced in the GRIB edition 1 format. The ERA-Interim data is then made available for download in its native GRIB format.</p><blockquote><p>In some cases, data is also available in NetCDF format as the result of the conversion of the GRIB file to NetCDF. Note that due to this conversion, not all the information in the GRIB file will be included in the NetCDF version, and his is particularly true for the GRIB file metadata. As a result, care should be taken when using these files. At this time, the NetCDF format is not formally supported by ECMWF.</p></blockquote><p>ECMWF provides and supports <a href="https://confluence.ecmwf.int/display/ECC/ecCodes+Home">ecCodes</a>. This software package has an Application Program Interface which makes ECMWF GRIB1 and GRIB2 files accessible from C, FORTRAN and Python programmes.</p><ul><li><strong>ecCodes</strong> by ECMWF<ul><li><a href="https://confluence.ecmwf.int/display/ECC/GRIB+tools" class="uri">https://confluence.ecmwf.int/display/ECC/GRIB+tools</a></li><li>Supports GRIB to NetCDF conversion (<code>grib_to_netcdf -o netcdf_file grib_file</code>)</li><li>Supports GRIB to JSON (<code>grib_dump -j &lt;gribfile&gt;</code>)</li><li><code>grib_ls</code>: List content of GRIB files printing values of some keys. It does not fail when a key is not found.</li><li><code>grib_dump</code>: Dump the content of a GRIB file in different formats.</li><li><a href="https://www.google.com/search?q=eccodes-grib-tools2-2016.pdf&amp;oq=eccodes-grib-tools2-2016.pdf&amp;gs_lcrp=EgZjaHJvbWUyBggAEEUYOTIGCAEQRRg80gEHMzUxajBqN6gCALACAA&amp;sourceid=chrome&amp;ie=UTF-8#:~:text=Using%20the%20ecCodes%20GRIB%20Tools"><strong>Using the ecCodes GRIB Tools</strong></a></li></ul></li></ul><blockquote><p>Please be aware that when reading GRIB files where the range of valid data values includes '9999' that some software may incorrectly indicate that these data points are missing. This is because 9999 is the default missing value indicator.</p></blockquote><ul><li><p><a href="https://confluence.ecmwf.int/display/METV/Metview">Metview</a> is a software tool from ECMWF which allows users to read, process and visualise GRIB 1 and GRIB 2 data (see Metview documentation).</p></li><li><p><a href="https://www.cpc.ncep.noaa.gov/products/wesley/wgrib.html">WGRIB</a> is a program to manipulate, inventory and decode GRIB files. The program is known to work on machines ranging from 486s to Cray supercomputers. (One fellow even ported it to a 286!) The program is Y2K friendly (NCO Y2K testing procedure).</p></li><li><a href="https://www2.mmm.ucar.edu/wrf/users/tutorial/presentation_pdfs/202101/werner_data_util_pp.pdf">WPS | ungrib | util</a><ul><li><code>$ ./g1print.exe GFS.grib</code> and <code>$ ./g2print.exe ERA5.grib</code></li><li><code>$ ./int2nc.exe FILE:yyyy-mm-dd_hh</code> for intermediate file</li><li><code>$ ncl plotfmt.ncl ‘filename=“FNL:2007-09-15_00”’</code> for intermediate file</li><li><code>$ ./rd_intermediate.exe FILE:yyyy-mm-dd_hh</code> for read these data you created and examine whether they are in correct format <a href="https://www2.mmm.ucar.edu/wrf/users/docs/user_guide_v4/v4.4/users_guide_chap3.html#_Writing_Meteorological_Data">Link</a></li></ul></li></ul><h1 id="examples">Examples</h1><ul><li><code>./g1print.exe ERA5.grib</code><ul><li><strong>ERA5: 37 pressure levels (from 100hPa to 0.1hPa)</strong></li></ul></li></ul>    <div class="fold">      <div class="fold-title fold-info collapsed" data-toggle="collapse" href="#collapse-8f7bdefe" role="button" aria-expanded="false" aria-controls="collapse-8f7bdefe">        <div class="fold-arrow">▶</div>./g1print.exe ERA5.grib      </div>      <div class="fold-collapse collapse" id="collapse-8f7bdefe">        <div class="fold-content">          <figure class="highlight console"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs console">Copen: File = /home/wpsze/mpas/ERA5/202404/20240423/ERA5.grib                                                             <br>Fortran Unit = 0<br>UNIX File descriptor: 3<br><br>----------------------------------------------------<br> rec GRIB GRIB  Lvl  Lvl  Lvl         Time      Fcst<br> Num Code name  Code one  two                   hour<br>----------------------------------------------------<br>   1 129 Z        100    1    0  2024-04-23_00:00 + 00<br>   2 157 R        100    1    0  2024-04-23_00:00 + 00<br>   3 133 Q        100    1    0  2024-04-23_00:00 + 00<br>   4 130 T        100    1    0  2024-04-23_00:00 + 00<br>   5 131 U        100    1    0  2024-04-23_00:00 + 00<br>   6 132 V        100    1    0  2024-04-23_00:00 + 00  <br>......<br> 221 131 U        100 1000    0  2024-04-23_00:00 + 00<br> 222 132 V        100 1000    0  2024-04-23_00:00 + 00<br>***** End-Of-File on C unit   3<br></code></pre></td></tr></table></figure>        </div>      </div>    </div><ul><li><code>./g2print.exe GFS.grib</code><ul><li><strong>GFS: 41 pressure levels (from 100hPa to 1hPa)</strong></li></ul></li></ul>    <div class="fold">      <div class="fold-title fold-info collapsed" data-toggle="collapse" href="#collapse-dcdac752" role="button" aria-expanded="false" aria-controls="collapse-dcdac752">        <div class="fold-arrow">▶</div>./g2print.exe GFS.grib      </div>      <div class="fold-collapse collapse" id="collapse-dcdac752">        <div class="fold-content">          <figure class="highlight console"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs console"> ungrib - grib edition num           2<br> reading from grib file = /home/wpsze/mpas/GFS/202504/20250409/GFS.grib                                                                <br>      NCEP GFS Analysis               <br>---------------------------------------------------------------------------------------<br> rec Prod Cat Param  Lvl    Lvl      Lvl     Prod    Name            Time          Fcst<br> num Disc     num    code   one      two     Templ                                 hour<br>---------------------------------------------------------------------------------------<br>   1   0    3   1     101       0       0       0     PRMSL    2025-04-09_00:00:00   00          <br>   2   0    1  22     105       1       0       0     CLMR     2025-04-09_00:00:00   00          <br>   3   0    1  23     105       1       0       0     ICMR     2025-04-09_00:00:00   00          <br>   4   0    1  24     105       1       0       0     RWMR     2025-04-09_00:00:00   00          <br>   5   0    1  25     105       1       0       0     SNMR     2025-04-09_00:00:00   00    <br>......<br> 696   0    2 192     109       0       0       0     VWSH     2025-04-09_00:00:00   00          <br>   Successful completion of g2print <br></code></pre></td></tr></table></figure>        </div>      </div>    </div><ul><li><code>./rd_intermediate.exe ERA5:2022-06-30_00</code></li></ul>    <div class="fold">      <div class="fold-title fold-info collapsed" data-toggle="collapse" href="#collapse-6ae3e036" role="button" aria-expanded="false" aria-controls="collapse-6ae3e036">        <div class="fold-arrow">▶</div>./rd_intermediate.exe ERA5:2022-06-30_00      </div>      <div class="fold-collapse collapse" id="collapse-6ae3e036">        <div class="fold-content">          <figure class="highlight console"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs console">================================================<br>FIELD = TT<br>UNITS = K DESCRIPTION = Temperature<br>DATE = 2022-06-30_00:00:00 FCST = 0.000000<br>SOURCE = ECMWF<br>LEVEL = 200100.000000<br>I,J DIMS = 1440, 721<br>IPROJ = 0  PROJECTION = LAT LON<br>  REF_X, REF_Y = 1.000000, 1.000000<br>  REF_LAT, REF_LON = 90.000008, 0.000000<br>  DLAT, DLON = -0.250000, 0.250000<br>  EARTH_RADIUS = 6367.470215<br>DATA(1,1)=274.108765<br>================================================<br>......<br>================================================<br>FIELD = LANDSEA<br>UNITS = 0/1 Flag DESCRIPTION = Land/Sea flag<br>DATE = 2022-06-30_00:00:00 FCST = 0.000000<br>SOURCE = ECMWF<br>LEVEL = 200100.000000<br>I,J DIMS = 1440, 721<br>IPROJ = 0  PROJECTION = LAT LON<br>  REF_X, REF_Y = 1.000000, 1.000000<br>  REF_LAT, REF_LON = 90.000008, 0.000000<br>  DLAT, DLON = -0.250000, 0.250000<br>  EARTH_RADIUS = 6367.470215<br>DATA(1,1)=0.000000<br><br>================================================<br>......<br>SUCCESSFUL COMPLETION OF PROGRAM RD_INTERMEDIATE<br></code></pre></td></tr></table></figure>        </div>      </div>    </div>    <div class="fold">      <div class="fold-title fold-info collapsed" data-toggle="collapse" href="#collapse-9c51fa20" role="button" aria-expanded="false" aria-controls="collapse-9c51fa20">        <div class="fold-arrow">▶</div>cdo showname      </div>      <div class="fold-collapse collapse" id="collapse-9c51fa20">        <div class="fold-content">          <figure class="highlight console"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs console"><span class="hljs-meta prompt_"> $ </span><span class="language-bash">cdo showname ERA5-SL-0p25-2024071400.grib</span><br> var165 var166 var168 var167 var172 var151 var31 var34 var235 var33<br> var141 var139 var170 var183 var236 var134 var39 var40 var41 var42<br> var129<br>cdo    showname: Processed 21 variables [0.05s 26MB].<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"> $ </span><span class="language-bash">cdo showname ERA5-PL-0p25-2024071400.grib</span><br> var129 var157 var133 var130 var131 var132<br>cdo    showname: Processed 6 variables [0.47s 23MB].<br></code></pre></td></tr></table></figure>        </div>      </div>    </div>    <div class="fold">      <div class="fold-title fold-info collapsed" data-toggle="collapse" href="#collapse-05eef982" role="button" aria-expanded="false" aria-controls="collapse-05eef982">        <div class="fold-arrow">▶</div>grib_ls *.grib      </div>      <div class="fold-collapse collapse" id="collapse-05eef982">        <div class="fold-content">          <figure class="highlight console"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br></pre></td><td class="code"><pre><code class="hljs console"><span class="hljs-meta prompt_"> $ </span><span class="language-bash">grib_ls ERA5-SL-0p25-2024071400.grib</span><br>ERA5-SL-0p25-2024071400.grib<br>edition      centre       typeOfLevel  level        dataDate     stepRange    dataType     shortName    packingType  gridType     <br>1            ecmf         surface      0            20240714     0            an           10u          grid_simple  regular_ll  <br>1            ecmf         surface      0            20240714     0            an           10v          grid_simple  regular_ll  <br>1            ecmf         surface      0            20240714     0            an           2d           grid_simple  regular_ll  <br>1            ecmf         surface      0            20240714     0            an           2t           grid_simple  regular_ll  <br>1            ecmf         surface      0            20240714     0            an           lsm          grid_simple  regular_ll  <br>1            ecmf         surface      0            20240714     0            an           msl          grid_simple  regular_ll  <br>1            ecmf         surface      0            20240714     0            an           ci           grid_simple  regular_ll  <br>1            ecmf         surface      0            20240714     0            an           sst          grid_simple  regular_ll  <br>1            ecmf         surface      0            20240714     0            an           skt          grid_simple  regular_ll  <br>1            ecmf         surface      0            20240714     0            an           rsn          grid_simple  regular_ll  <br>1            ecmf         surface      0            20240714     0            an           sd           grid_simple  regular_ll  <br>1            ecmf         depthBelowLandLayer  0            20240714     0            an           stl1         grid_simple  regular_ll  <br>1            ecmf         depthBelowLandLayer  7            20240714     0            an           stl2         grid_simple  regular_ll  <br>1            ecmf         depthBelowLandLayer  28           20240714     0            an           stl3         grid_simple  regular_ll  <br>1            ecmf         depthBelowLandLayer  100          20240714     0            an           stl4         grid_simple  regular_ll  <br>1            ecmf         surface      0            20240714     0            an           sp           grid_simple  regular_ll  <br>1            ecmf         depthBelowLandLayer  0            20240714     0            an           swvl1        grid_simple  regular_ll  <br>1            ecmf         depthBelowLandLayer  7            20240714     0            an           swvl2        grid_simple  regular_ll  <br>1            ecmf         depthBelowLandLayer  28           20240714     0            an           swvl3        grid_simple  regular_ll  <br>1            ecmf         depthBelowLandLayer  100          20240714     0            an           swvl4        grid_simple  regular_ll  <br>1            ecmf         surface      0            20240714     0            an           z            grid_simple  regular_ll  <br>21 of 21 messages in ERA5-SL-0p25-2024071400.grib<br><br>21 of 21 total messages in 1 files<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"> $ </span><span class="language-bash">grib_ls ERA5-PL-0p25-2024071400.grib</span><br>ERA5-PL-0p25-2024071400.grib<br>edition      centre       typeOfLevel  level        dataDate     stepRange    dataType     shortName    packingType  gridType     <br>1            ecmf         isobaricInhPa  1            20240714     0            an           z            grid_simple  regular_ll  <br>1            ecmf         isobaricInhPa  1            20240714     0            an           r            grid_simple  regular_ll  <br>1            ecmf         isobaricInhPa  1            20240714     0            an           q            grid_simple  regular_ll  <br>1            ecmf         isobaricInhPa  1            20240714     0            an           t            grid_simple  regular_ll  <br>1            ecmf         isobaricInhPa  1            20240714     0            an           u            grid_simple  regular_ll  <br>1            ecmf         isobaricInhPa  1            20240714     0            an           v            grid_simple  regular_ll  <br>1            ecmf         isobaricInhPa  2            20240714     0            an           z            grid_simple  regular_ll  <br>1            ecmf         isobaricInhPa  2            20240714     0            an           r            grid_simple  regular_ll  <br>1            ecmf         isobaricInhPa  2            20240714     0            an           q            grid_simple  regular_ll  <br>1            ecmf         isobaricInhPa  2            20240714     0            an           t            grid_simple  regular_ll  <br>1            ecmf         isobaricInhPa  2            20240714     0            an           u            grid_simple  regular_ll  <br>1            ecmf         isobaricInhPa  2            20240714     0            an           v            grid_simple  regular_ll  <br>1            ecmf         isobaricInhPa  3            20240714     0            an           z            grid_simple  regular_ll  <br>1            ecmf         isobaricInhPa  3            20240714     0            an           r            grid_simple  regular_ll  <br>1            ecmf         isobaricInhPa  3            20240714     0            an           q            grid_simple  regular_ll  <br>1            ecmf         isobaricInhPa  3            20240714     0            an           t            grid_simple  regular_ll  <br>1            ecmf         isobaricInhPa  3            20240714     0            an           u            grid_simple  regular_ll  <br>1            ecmf         isobaricInhPa  3            20240714     0            an           v            grid_simple  regular_ll  <br>1            ecmf         isobaricInhPa  5            20240714     0            an           z            grid_simple  regular_ll  <br>1            ecmf         isobaricInhPa  5            20240714     0            an           r            grid_simple  regular_ll  <br>1            ecmf         isobaricInhPa  5            20240714     0            an           q            grid_simple  regular_ll  <br>1            ecmf         isobaricInhPa  5            20240714     0            an           t            grid_simple  regular_ll  <br>1            ecmf         isobaricInhPa  5            20240714     0            an           u            grid_simple  regular_ll  <br>1            ecmf         isobaricInhPa  5            20240714     0            an           v            grid_simple  regular_ll  <br>1            ecmf         isobaricInhPa  7            20240714     0            an           z            grid_simple  regular_ll  <br>1            ecmf         isobaricInhPa  7            20240714     0            an           r            grid_simple  regular_ll  <br>1            ecmf         isobaricInhPa  7            20240714     0            an           q            grid_simple  regular_ll  <br>1            ecmf         isobaricInhPa  7            20240714     0            an           t            grid_simple  regular_ll  <br>1            ecmf         isobaricInhPa  7            20240714     0            an           u            grid_simple  regular_ll  <br>1            ecmf         isobaricInhPa  7            20240714     0            an           v            grid_simple  regular_ll  <br>1            ecmf         isobaricInhPa  10           20240714     0            an           z            grid_simple  regular_ll  <br>1            ecmf         isobaricInhPa  10           20240714     0            an           r            grid_simple  regular_ll  <br>1            ecmf         isobaricInhPa  10           20240714     0            an           q            grid_simple  regular_ll  <br>1            ecmf         isobaricInhPa  10           20240714     0            an           t            grid_simple  regular_ll  <br>1            ecmf         isobaricInhPa  10           20240714     0            an           u            grid_simple  regular_ll  <br>1            ecmf         isobaricInhPa  10           20240714     0            an           v            grid_simple  regular_ll  <br>1            ecmf         isobaricInhPa  20           20240714     0            an           z            grid_simple  regular_ll  <br>1            ecmf         isobaricInhPa  20           20240714     0            an           r            grid_simple  regular_ll  <br>1            ecmf         isobaricInhPa  20           20240714     0            an           q            grid_simple  regular_ll  <br>1            ecmf         isobaricInhPa  20           20240714     0            an           t            grid_simple  regular_ll  <br>1            ecmf         isobaricInhPa  20           20240714     0            an           u            grid_simple  regular_ll  <br>1            ecmf         isobaricInhPa  20           20240714     0            an           v            grid_simple  regular_ll  <br>1            ecmf         isobaricInhPa  30           20240714     0            an           z            grid_simple  regular_ll  <br>1            ecmf         isobaricInhPa  30           20240714     0            an           r            grid_simple  regular_ll  <br>1            ecmf         isobaricInhPa  30           20240714     0            an           q            grid_simple  regular_ll  <br>1            ecmf         isobaricInhPa  30           20240714     0            an           t            grid_simple  regular_ll  <br>1            ecmf         isobaricInhPa  30           20240714     0            an           u            grid_simple  regular_ll  <br>1            ecmf         isobaricInhPa  30           20240714     0            an           v            grid_simple  regular_ll  <br>1            ecmf         isobaricInhPa  50           20240714     0            an           z            grid_simple  regular_ll  <br>1            ecmf         isobaricInhPa  50           20240714     0            an           r            grid_simple  regular_ll  <br>1            ecmf         isobaricInhPa  50           20240714     0            an           q            grid_simple  regular_ll  <br>1            ecmf         isobaricInhPa  50           20240714     0            an           t            grid_simple  regular_ll  <br>1            ecmf         isobaricInhPa  50           20240714     0            an           u            grid_simple  regular_ll  <br>1            ecmf         isobaricInhPa  50           20240714     0            an           v            grid_simple  regular_ll  <br>1            ecmf         isobaricInhPa  70           20240714     0            an           z            grid_simple  regular_ll  <br>1            ecmf         isobaricInhPa  70           20240714     0            an           r            grid_simple  regular_ll  <br>1            ecmf         isobaricInhPa  70           20240714     0            an           q            grid_simple  regular_ll  <br>1            ecmf         isobaricInhPa  70           20240714     0            an           t            grid_simple  regular_ll  <br>1            ecmf         isobaricInhPa  70           20240714     0            an           u            grid_simple  regular_ll  <br>1            ecmf         isobaricInhPa  70           20240714     0            an           v            grid_simple  regular_ll  <br>1            ecmf         isobaricInhPa  100          20240714     0            an           z            grid_simple  regular_ll  <br>1            ecmf         isobaricInhPa  100          20240714     0            an           r            grid_simple  regular_ll  <br>1            ecmf         isobaricInhPa  100          20240714     0            an           q            grid_simple  regular_ll  <br>1            ecmf         isobaricInhPa  100          20240714     0            an           t            grid_simple  regular_ll  <br>1            ecmf         isobaricInhPa  100          20240714     0            an           u            grid_simple  regular_ll  <br>1            ecmf         isobaricInhPa  100          20240714     0            an           v            grid_simple  regular_ll  <br>1            ecmf         isobaricInhPa  125          20240714     0            an           z            grid_simple  regular_ll  <br>1            ecmf         isobaricInhPa  125          20240714     0            an           r            grid_simple  regular_ll  <br>1            ecmf         isobaricInhPa  125          20240714     0            an           q            grid_simple  regular_ll  <br>1            ecmf         isobaricInhPa  125          20240714     0            an           t            grid_simple  regular_ll  <br>1            ecmf         isobaricInhPa  125          20240714     0            an           u            grid_simple  regular_ll  <br>1            ecmf         isobaricInhPa  125          20240714     0            an           v            grid_simple  regular_ll  <br>1            ecmf         isobaricInhPa  150          20240714     0            an           z            grid_simple  regular_ll  <br>1            ecmf         isobaricInhPa  150          20240714     0            an           r            grid_simple  regular_ll  <br>1            ecmf         isobaricInhPa  150          20240714     0            an           q            grid_simple  regular_ll  <br>1            ecmf         isobaricInhPa  150          20240714     0            an           t            grid_simple  regular_ll  <br>1            ecmf         isobaricInhPa  150          20240714     0            an           u            grid_simple  regular_ll  <br>1            ecmf         isobaricInhPa  150          20240714     0            an           v            grid_simple  regular_ll  <br>1            ecmf         isobaricInhPa  175          20240714     0            an           z            grid_simple  regular_ll  <br>1            ecmf         isobaricInhPa  175          20240714     0            an           r            grid_simple  regular_ll  <br>1            ecmf         isobaricInhPa  175          20240714     0            an           q            grid_simple  regular_ll  <br>1            ecmf         isobaricInhPa  175          20240714     0            an           t            grid_simple  regular_ll  <br>1            ecmf         isobaricInhPa  175          20240714     0            an           u            grid_simple  regular_ll  <br>1            ecmf         isobaricInhPa  175          20240714     0            an           v            grid_simple  regular_ll  <br>1            ecmf         isobaricInhPa  200          20240714     0            an           z            grid_simple  regular_ll  <br>1            ecmf         isobaricInhPa  200          20240714     0            an           r            grid_simple  regular_ll  <br>1            ecmf         isobaricInhPa  200          20240714     0            an           q            grid_simple  regular_ll  <br>1            ecmf         isobaricInhPa  200          20240714     0            an           t            grid_simple  regular_ll  <br>1            ecmf         isobaricInhPa  200          20240714     0            an           u            grid_simple  regular_ll  <br>1            ecmf         isobaricInhPa  200          20240714     0            an           v            grid_simple  regular_ll  <br>1            ecmf         isobaricInhPa  225          20240714     0            an           z            grid_simple  regular_ll  <br>1            ecmf         isobaricInhPa  225          20240714     0            an           r            grid_simple  regular_ll  <br>1            ecmf         isobaricInhPa  225          20240714     0            an           q            grid_simple  regular_ll  <br>1            ecmf         isobaricInhPa  225          20240714     0            an           t            grid_simple  regular_ll  <br>1            ecmf         isobaricInhPa  225          20240714     0            an           u            grid_simple  regular_ll  <br>1            ecmf         isobaricInhPa  225          20240714     0            an           v            grid_simple  regular_ll  <br>1            ecmf         isobaricInhPa  250          20240714     0            an           z            grid_simple  regular_ll  <br>1            ecmf         isobaricInhPa  250          20240714     0            an           r            grid_simple  regular_ll  <br>1            ecmf         isobaricInhPa  250          20240714     0            an           q            grid_simple  regular_ll  <br>1            ecmf         isobaricInhPa  250          20240714     0            an           t            grid_simple  regular_ll  <br>1            ecmf         isobaricInhPa  250          20240714     0            an           u            grid_simple  regular_ll  <br>1            ecmf         isobaricInhPa  250          20240714     0            an           v            grid_simple  regular_ll  <br>1            ecmf         isobaricInhPa  300          20240714     0            an           z            grid_simple  regular_ll  <br>1            ecmf         isobaricInhPa  300          20240714     0            an           r            grid_simple  regular_ll  <br>1            ecmf         isobaricInhPa  300          20240714     0            an           q            grid_simple  regular_ll  <br>1            ecmf         isobaricInhPa  300          20240714     0            an           t            grid_simple  regular_ll  <br>1            ecmf         isobaricInhPa  300          20240714     0            an           u            grid_simple  regular_ll  <br>1            ecmf         isobaricInhPa  300          20240714     0            an           v            grid_simple  regular_ll  <br>1            ecmf         isobaricInhPa  350          20240714     0            an           z            grid_simple  regular_ll  <br>1            ecmf         isobaricInhPa  350          20240714     0            an           r            grid_simple  regular_ll  <br>1            ecmf         isobaricInhPa  350          20240714     0            an           q            grid_simple  regular_ll  <br>1            ecmf         isobaricInhPa  350          20240714     0            an           t            grid_simple  regular_ll  <br>1            ecmf         isobaricInhPa  350          20240714     0            an           u            grid_simple  regular_ll  <br>1            ecmf         isobaricInhPa  350          20240714     0            an           v            grid_simple  regular_ll  <br>1            ecmf         isobaricInhPa  400          20240714     0            an           z            grid_simple  regular_ll  <br>1            ecmf         isobaricInhPa  400          20240714     0            an           r            grid_simple  regular_ll  <br>1            ecmf         isobaricInhPa  400          20240714     0            an           q            grid_simple  regular_ll  <br>1            ecmf         isobaricInhPa  400          20240714     0            an           t            grid_simple  regular_ll  <br>1            ecmf         isobaricInhPa  400          20240714     0            an           u            grid_simple  regular_ll  <br>1            ecmf         isobaricInhPa  400          20240714     0            an           v            grid_simple  regular_ll  <br>1            ecmf         isobaricInhPa  450          20240714     0            an           z            grid_simple  regular_ll  <br>1            ecmf         isobaricInhPa  450          20240714     0            an           r            grid_simple  regular_ll  <br>1            ecmf         isobaricInhPa  450          20240714     0            an           q            grid_simple  regular_ll  <br>1            ecmf         isobaricInhPa  450          20240714     0            an           t            grid_simple  regular_ll  <br>1            ecmf         isobaricInhPa  450          20240714     0            an           u            grid_simple  regular_ll  <br>1            ecmf         isobaricInhPa  450          20240714     0            an           v            grid_simple  regular_ll  <br>1            ecmf         isobaricInhPa  500          20240714     0            an           z            grid_simple  regular_ll  <br>1            ecmf         isobaricInhPa  500          20240714     0            an           r            grid_simple  regular_ll  <br>1            ecmf         isobaricInhPa  500          20240714     0            an           q            grid_simple  regular_ll  <br>1            ecmf         isobaricInhPa  500          20240714     0            an           t            grid_simple  regular_ll  <br>1            ecmf         isobaricInhPa  500          20240714     0            an           u            grid_simple  regular_ll  <br>1            ecmf         isobaricInhPa  500          20240714     0            an           v            grid_simple  regular_ll  <br>1            ecmf         isobaricInhPa  550          20240714     0            an           z            grid_simple  regular_ll  <br>1            ecmf         isobaricInhPa  550          20240714     0            an           r            grid_simple  regular_ll  <br>1            ecmf         isobaricInhPa  550          20240714     0            an           q            grid_simple  regular_ll  <br>1            ecmf         isobaricInhPa  550          20240714     0            an           t            grid_simple  regular_ll  <br>1            ecmf         isobaricInhPa  550          20240714     0            an           u            grid_simple  regular_ll  <br>1            ecmf         isobaricInhPa  550          20240714     0            an           v            grid_simple  regular_ll  <br>1            ecmf         isobaricInhPa  600          20240714     0            an           z            grid_simple  regular_ll  <br>1            ecmf         isobaricInhPa  600          20240714     0            an           r            grid_simple  regular_ll  <br>1            ecmf         isobaricInhPa  600          20240714     0            an           q            grid_simple  regular_ll  <br>1            ecmf         isobaricInhPa  600          20240714     0            an           t            grid_simple  regular_ll  <br>1            ecmf         isobaricInhPa  600          20240714     0            an           u            grid_simple  regular_ll  <br>1            ecmf         isobaricInhPa  600          20240714     0            an           v            grid_simple  regular_ll  <br>1            ecmf         isobaricInhPa  650          20240714     0            an           z            grid_simple  regular_ll  <br>1            ecmf         isobaricInhPa  650          20240714     0            an           r            grid_simple  regular_ll  <br>1            ecmf         isobaricInhPa  650          20240714     0            an           q            grid_simple  regular_ll  <br>1            ecmf         isobaricInhPa  650          20240714     0            an           t            grid_simple  regular_ll  <br>1            ecmf         isobaricInhPa  650          20240714     0            an           u            grid_simple  regular_ll  <br>1            ecmf         isobaricInhPa  650          20240714     0            an           v            grid_simple  regular_ll  <br>1            ecmf         isobaricInhPa  700          20240714     0            an           z            grid_simple  regular_ll  <br>1            ecmf         isobaricInhPa  700          20240714     0            an           r            grid_simple  regular_ll  <br>1            ecmf         isobaricInhPa  700          20240714     0            an           q            grid_simple  regular_ll  <br>1            ecmf         isobaricInhPa  700          20240714     0            an           t            grid_simple  regular_ll  <br>1            ecmf         isobaricInhPa  700          20240714     0            an           u            grid_simple  regular_ll  <br>1            ecmf         isobaricInhPa  700          20240714     0            an           v            grid_simple  regular_ll  <br>1            ecmf         isobaricInhPa  750          20240714     0            an           z            grid_simple  regular_ll  <br>1            ecmf         isobaricInhPa  750          20240714     0            an           r            grid_simple  regular_ll  <br>1            ecmf         isobaricInhPa  750          20240714     0            an           q            grid_simple  regular_ll  <br>1            ecmf         isobaricInhPa  750          20240714     0            an           t            grid_simple  regular_ll  <br>1            ecmf         isobaricInhPa  750          20240714     0            an           u            grid_simple  regular_ll  <br>1            ecmf         isobaricInhPa  750          20240714     0            an           v            grid_simple  regular_ll  <br>1            ecmf         isobaricInhPa  775          20240714     0            an           z            grid_simple  regular_ll  <br>1            ecmf         isobaricInhPa  775          20240714     0            an           r            grid_simple  regular_ll  <br>1            ecmf         isobaricInhPa  775          20240714     0            an           q            grid_simple  regular_ll  <br>1            ecmf         isobaricInhPa  775          20240714     0            an           t            grid_simple  regular_ll  <br>1            ecmf         isobaricInhPa  775          20240714     0            an           u            grid_simple  regular_ll  <br>1            ecmf         isobaricInhPa  775          20240714     0            an           v            grid_simple  regular_ll  <br>1            ecmf         isobaricInhPa  800          20240714     0            an           z            grid_simple  regular_ll  <br>1            ecmf         isobaricInhPa  800          20240714     0            an           r            grid_simple  regular_ll  <br>1            ecmf         isobaricInhPa  800          20240714     0            an           q            grid_simple  regular_ll  <br>1            ecmf         isobaricInhPa  800          20240714     0            an           t            grid_simple  regular_ll  <br>1            ecmf         isobaricInhPa  800          20240714     0            an           u            grid_simple  regular_ll  <br>1            ecmf         isobaricInhPa  800          20240714     0            an           v            grid_simple  regular_ll  <br>1            ecmf         isobaricInhPa  825          20240714     0            an           z            grid_simple  regular_ll  <br>1            ecmf         isobaricInhPa  825          20240714     0            an           r            grid_simple  regular_ll  <br>1            ecmf         isobaricInhPa  825          20240714     0            an           q            grid_simple  regular_ll  <br>1            ecmf         isobaricInhPa  825          20240714     0            an           t            grid_simple  regular_ll  <br>1            ecmf         isobaricInhPa  825          20240714     0            an           u            grid_simple  regular_ll  <br>1            ecmf         isobaricInhPa  825          20240714     0            an           v            grid_simple  regular_ll  <br>1            ecmf         isobaricInhPa  850          20240714     0            an           z            grid_simple  regular_ll  <br>1            ecmf         isobaricInhPa  850          20240714     0            an           r            grid_simple  regular_ll  <br>1            ecmf         isobaricInhPa  850          20240714     0            an           q            grid_simple  regular_ll  <br>1            ecmf         isobaricInhPa  850          20240714     0            an           t            grid_simple  regular_ll  <br>1            ecmf         isobaricInhPa  850          20240714     0            an           u            grid_simple  regular_ll  <br>1            ecmf         isobaricInhPa  850          20240714     0            an           v            grid_simple  regular_ll  <br>1            ecmf         isobaricInhPa  875          20240714     0            an           z            grid_simple  regular_ll  <br>1            ecmf         isobaricInhPa  875          20240714     0            an           r            grid_simple  regular_ll  <br>1            ecmf         isobaricInhPa  875          20240714     0            an           q            grid_simple  regular_ll  <br>1            ecmf         isobaricInhPa  875          20240714     0            an           t            grid_simple  regular_ll  <br>1            ecmf         isobaricInhPa  875          20240714     0            an           u            grid_simple  regular_ll  <br>1            ecmf         isobaricInhPa  875          20240714     0            an           v            grid_simple  regular_ll  <br>1            ecmf         isobaricInhPa  900          20240714     0            an           z            grid_simple  regular_ll  <br>1            ecmf         isobaricInhPa  900          20240714     0            an           r            grid_simple  regular_ll  <br>1            ecmf         isobaricInhPa  900          20240714     0            an           q            grid_simple  regular_ll  <br>1            ecmf         isobaricInhPa  900          20240714     0            an           t            grid_simple  regular_ll  <br>1            ecmf         isobaricInhPa  900          20240714     0            an           u            grid_simple  regular_ll  <br>1            ecmf         isobaricInhPa  900          20240714     0            an           v            grid_simple  regular_ll  <br>1            ecmf         isobaricInhPa  925          20240714     0            an           z            grid_simple  regular_ll  <br>1            ecmf         isobaricInhPa  925          20240714     0            an           r            grid_simple  regular_ll  <br>1            ecmf         isobaricInhPa  925          20240714     0            an           q            grid_simple  regular_ll  <br>1            ecmf         isobaricInhPa  925          20240714     0            an           t            grid_simple  regular_ll  <br>1            ecmf         isobaricInhPa  925          20240714     0            an           u            grid_simple  regular_ll  <br>1            ecmf         isobaricInhPa  925          20240714     0            an           v            grid_simple  regular_ll  <br>1            ecmf         isobaricInhPa  950          20240714     0            an           z            grid_simple  regular_ll  <br>1            ecmf         isobaricInhPa  950          20240714     0            an           r            grid_simple  regular_ll  <br>1            ecmf         isobaricInhPa  950          20240714     0            an           q            grid_simple  regular_ll  <br>1            ecmf         isobaricInhPa  950          20240714     0            an           t            grid_simple  regular_ll  <br>1            ecmf         isobaricInhPa  950          20240714     0            an           u            grid_simple  regular_ll  <br>1            ecmf         isobaricInhPa  950          20240714     0            an           v            grid_simple  regular_ll  <br>1            ecmf         isobaricInhPa  975          20240714     0            an           z            grid_simple  regular_ll  <br>1            ecmf         isobaricInhPa  975          20240714     0            an           r            grid_simple  regular_ll  <br>1            ecmf         isobaricInhPa  975          20240714     0            an           q            grid_simple  regular_ll  <br>1            ecmf         isobaricInhPa  975          20240714     0            an           t            grid_simple  regular_ll  <br>1            ecmf         isobaricInhPa  975          20240714     0            an           u            grid_simple  regular_ll  <br>1            ecmf         isobaricInhPa  975          20240714     0            an           v            grid_simple  regular_ll  <br>1            ecmf         isobaricInhPa  1000         20240714     0            an           z            grid_simple  regular_ll  <br>1            ecmf         isobaricInhPa  1000         20240714     0            an           r            grid_simple  regular_ll  <br>1            ecmf         isobaricInhPa  1000         20240714     0            an           q            grid_simple  regular_ll  <br>1            ecmf         isobaricInhPa  1000         20240714     0            an           t            grid_simple  regular_ll  <br>1            ecmf         isobaricInhPa  1000         20240714     0            an           u            grid_simple  regular_ll  <br>1            ecmf         isobaricInhPa  1000         20240714     0            an           v            grid_simple  regular_ll  <br>222 of 222 messages in ERA5-PL-0p25-2024071400.grib<br><br>222 of 222 total messages in 1 files<br></code></pre></td></tr></table></figure>        </div>      </div>    </div><ul><li>Vtable.Vtable.ERA-interim.pl has GRIB1 format.</li></ul>    <div class="fold">      <div class="fold-title fold-info collapsed" data-toggle="collapse" href="#collapse-90469042" role="button" aria-expanded="false" aria-controls="collapse-90469042">        <div class="fold-arrow">▶</div>Vtable.ERA-interim.pl      </div>      <div class="fold-collapse collapse" id="collapse-90469042">        <div class="fold-content">          <figure class="highlight console"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs console">GRIB | Level| Level| Level| metgrid  |  metgrid | metgrid                                  |<br>Code | Code |   1  |   2  | Name     |  Units   | Description                              |<br>-----+------+------+------+----------+----------+------------------------------------------+<br> 129 | 100  |   *  |      | GEOPT    | m2 s-2   |                                          | <br>     | 100  |   *  |      | HGT      | m        | Height                                   |<br> 130 | 100  |   *  |      | TT       | K        | Temperature                              |<br> 131 | 100  |   *  |      | UU       | m s-1    | U                                        |<br> 132 | 100  |   *  |      | VV       | m s-1    | V                                        |<br> 157 | 100  |   *  |      | RH       | %        | Relative Humidity                        |<br> 165 |  1   |   0  |      | UU       | m s-1    | U                                        | At 10 m<br> 166 |  1   |   0  |      | VV       | m s-1    | V                                        | At 10 m<br> 167 |  1   |   0  |      | TT       | K        | Temperature                              | At 2 m<br> 168 |  1   |   0  |      | DEWPT    | K        |                                          | At 2 m<br>     |  1   |   0  |      | RH       | %        | Relative Humidity                        | At 2 m<br> 172 |  1   |   0  |      | LANDSEA  | 0/1 Flag | Land/Sea flag                            |<br> 129 |  1   |   0  |      | SOILGEO  | m2 s-2   |                                          |<br>     |  1   |   0  |      | SOILHGT  | m        | Terrain field of source analysis         |<br> 134 |  1   |   0  |      | PSFC     | Pa       | Surface Pressure                         |<br> 151 |  1   |   0  |      | PMSL     | Pa       | Sea-level Pressure                       |<br> 235 |  1   |   0  |      | SKINTEMP | K        | Sea-Surface Temperature                  |<br>  31 |  1   |   0  |      | SEAICE   | fraction | Sea-Ice Fraction                         |<br>  34 |  1   |   0  |      | SST      | K        | Sea-Surface Temperature                  |<br>  33 |  1   |   0  |      | SNOW_DEN | kg m-3   |                                          |<br> 141 |  1   |   0  |      | SNOW_EC  | m        |                                          |<br>     |  1   |   0  |      | SNOW     | kg m-2   |Water Equivalent of Accumulated Snow Depth|<br>     |  1   |   0  |      | SNOWH    | m        | Physical Snow Depth                      |<br> 139 | 112  |   0  |   7  | ST000007 | K        | T of 0-7 cm ground layer                 |<br> 170 | 112  |   7  |  28  | ST007028 | K        | T of 7-28 cm ground layer                |<br> 183 | 112  |  28  | 100  | ST028100 | K        | T of 28-100 cm ground layer              |<br> 236 | 112  | 100  | 255  | ST100289 | K        | T of 100-289 cm ground layer             |<br>  39 | 112  |   0  |   7  | SM000007 | m3 m-3   | Soil moisture of 0-7 cm ground layer     |<br>  40 | 112  |   7  |  28  | SM007028 | m3 m-3   | Soil moisture of 7-28 cm ground layer    |<br>  41 | 112  |  28  | 100  | SM028100 | m3 m-3   | Soil moisture of 28-100 cm ground layer  |<br>  42 | 112  | 100  | 255  | SM100289 | m3 m-3   | Soil moisture of 100-289 cm ground layer |<br>-----+------+------+------+----------+----------+------------------------------------------+<br><span class="hljs-meta prompt_">#</span><span class="language-bash"></span><br><span class="language-bash"><span class="hljs-comment">#  For use with ERA-interim pressure-level output.</span></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash"></span><br><span class="language-bash"><span class="hljs-comment">#  Grib codes are from Table 128</span></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash"> http://www.ecmwf.int/services/archive/d/parameters/order=grib_parameter/table=128/</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash"> </span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">snow depth is converted to the proper units <span class="hljs-keyword">in</span> rrpr.F</span><br><span class="hljs-meta prompt_">#</span><span class="language-bash"></span><br><span class="language-bash"><span class="hljs-comment">#  For ERA-interim data at NCAR, use the pl (sc and uv) and sfc sc files.</span></span> <br></code></pre></td></tr></table></figure>        </div>      </div>    </div><ul><li>Vtable.ECMWF has GRIB2 format.</li></ul>    <div class="fold">      <div class="fold-title fold-info collapsed" data-toggle="collapse" href="#collapse-738764b7" role="button" aria-expanded="false" aria-controls="collapse-738764b7">        <div class="fold-arrow">▶</div>Vtable.ECMWF      </div>      <div class="fold-collapse collapse" id="collapse-738764b7">        <div class="fold-content">          <figure class="highlight console"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs console">GRIB1| Level| From |  To  | metgrid  | metgrid  | metgrid                                  |GRIB2|GRIB2|GRIB2|GRIB2|<br>Param| Type |Level1|Level2| Name     | Units    | Description                              |Discp|Catgy|Param|Level|<br>-----+------+------+------+----------+----------+------------------------------------------+-----------------------+<br> 129 | 100  |   *  |      | GEOPT    | m2 s-2   |                                          |  0  |  0  |     | 100 |<br> 156 | 100  |   *  |      | HGT      | m        | Height                                   |  0  |  3  |  5  | 100 |  <br> 130 | 100  |   *  |      | TT       | K        | Temperature                              |  0  |  0  |  0  | 100 |<br> 131 | 100  |   *  |      | UU       | m s-1    | U                                        |  0  |  2  |  2  | 100 |<br> 132 | 100  |   *  |      | VV       | m s-1    | V                                        |  0  |  2  |  3  | 100 |<br> 157 | 100  |   *  |      | RH       | %        | Relative Humidity                        |  0  |  1  |  1  | 100 |<br> 165 |  1   |   0  |      | UU       | m s-1    | U                    At 10 m             |  0  |  2  |  2  | 103 | <br> 166 |  1   |   0  |      | VV       | m s-1    | V                    At 10 m             |  0  |  2  |  3  | 103 | <br> 167 |  1   |   0  |      | TT       | K        | Temperature          At  2 m             |  0  |  0  |  0  | 103 |<br> 168 |  1   |   0  |      | DEWPT    | K        |                                          |  0  |  0  |  6  | 103 |<br>     |  1   |   0  |      | RH       | %        | Relative Humidity    At  2 m             |  0  |  0  |     | 103 | <br> 172 |  1   |   0  |      | LANDSEA  | 0/1 Flag | Land/Sea flag                            |  2  |  0  |  0  |  1  | <br> 129 |  1   |   0  |      | SOILGEO  | m2 s-2   |                                          |  0  |  0  |     | 103 | <br> 156 |  1   |   0  |      | SOILHGT  | m        | Terrain field of source analysis         |  0  |  0  |     | 106 | <br> 134 |  1   |   0  |      | PSFC     | Pa       | Surface Pressure                         |  0  |  3  |  0  |  1  |<br> 151 |  1   |   0  |      | PMSL     | Pa       | Sea-level Pressure                       |  0  |  3  |  0  | 101 |<br> 235 |  1   |   0  |      | SKINTEMP | K        | Sea-Surface Temperature                  |  0  |  3  |     | 101 |<br>  31 |  1   |   0  |      | SEAICE   | 0/1 Flag | Sea-Ice-Flag                             |  0  |  3  |     | 101 |<br>  34 |  1   |   0  |      | SST      | K        | Sea-Surface Temperature                  |  0  |  3  |     | 101 |<br> 141 |  1   |   0  |      | SNOW_EC  | m        |                                          |  0  |  3  |     | 101 |<br>     |  1   |   0  |      | SNOW     | kg m-2   |Water Equivalent of Accumulated Snow Depth|  0  |  3  |     | 101 |<br> 139 | 112  |   0  |   7  | ST000007 | K        | T of 0-7 cm ground layer                 |  2  |  0  |  2  | 106 | <br> 170 | 112  |   7  |  28  | ST007028 | K        | T of 7-28 cm ground layer                | 192 | 128 | 170 | 106 | <br> 183 | 112  |  28  | 100  | ST028100 | K        | T of 28-100 cm ground layer              | 192 | 128 | 183 | 106 | <br> 236 | 112  | 100  | 255  | ST100289 | K        | T of 100-289 cm ground layer             | 192 | 128 | 236 | 106 | <br>  39 | 112  |   0  |   7  | SM000007 | fraction | Soil moisture of 0-7 cm ground layer     | 192 | 128 | 39  | 106 | <br>  40 | 112  |   7  |  28  | SM007028 | fraction | Soil moisture of 7-28 cm ground layer    | 192 | 128 | 40  | 106 | <br>  41 | 112  |  28  | 100  | SM028100 | fraction | Soil moisture of 28-100 cm ground layer  | 192 | 128 | 41  | 106 | <br>  42 | 112  | 100  | 255  | SM100289 | fraction | Soil moisture of 100-289 cm ground layer | 192 | 128 | 42  | 106 | <br>-----+------+------+------+----------+----------+------------------------------------------+-----+-----+-----+-----+<br><span class="hljs-meta prompt_">#</span><span class="language-bash"></span><br><span class="language-bash"><span class="hljs-comment">#  Grib codes are from Table 128</span></span> <br><span class="hljs-meta prompt_"># </span><span class="language-bash"> http://old.ecmwf.int/publications/manuals/d/gribapi/param/filter=grib1/order=paramId/order_type=asc/p=1/table=128/</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash"> </span><br><span class="hljs-meta prompt_"># </span><span class="language-bash"> snow depth is converted to the proper units <span class="hljs-keyword">in</span> rrpr.F</span><br><span class="hljs-meta prompt_">#</span><span class="language-bash"></span><br><span class="language-bash"><span class="hljs-comment">#  Tested on NCAR/RDA ds113.0 dataset. http://rda.ucar.edu/datasets/ds113.0/</span></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash"> Note that <span class="hljs-keyword">for</span> ds113.0 there is one surface data file per day and 4 pressure-level files per day.</span><br></code></pre></td></tr></table></figure>        </div>      </div>    </div>    <div class="fold">      <div class="fold-title fold-info collapsed" data-toggle="collapse" href="#collapse-dfb167e8" role="button" aria-expanded="false" aria-controls="collapse-dfb167e8">        <div class="fold-arrow">▶</div>ECMWF user-defined parameter table (#128)      </div>      <div class="fold-collapse collapse" id="collapse-dfb167e8">        <div class="fold-content">          <figure class="highlight console"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br></pre></td><td class="code"><pre><code class="hljs console">0:var0:undefined<br>1:STRF:Stream function [m**2 s**-1]<br>2:VPOT:Velocity potential [m**2 s**-1]<br>3:PT:Potential temperature [K]<br>4:EQPT:Equivalent potential temperature [K]<br>5:SEPT:Saturated equivalent potential temperature [K]<br>6:var6:Reserved for Metview<br>7:var7:Reserved for Metview<br>8:var8:Reserved for Metview<br>9:var9:Reserved for Metview<br>10:var10:Reserved for Metview<br>11:UDVW:U component of divergent wind [m s**-1]<br>12:VDVW:V component of divergent wind [m s**-1]<br>13:URTW:U component of rotational wind [m s**-1]<br>14:VRTW:V component of rotational wind [m s**-1]<br>15:var15:Reserved for Metview<br>16:var16:Reserved for Metview<br>17:var17:Reserved for Metview<br>18:var18:Reserved for Metview<br>19:var19:Reserved for Metview<br>20:var20:Reserved for Metview<br>21:UCTP:Unbalanced component of temperature [K]<br>22:UCLN:Unbalanced component of logarithm of surface pressure<br>23:UCDV:Unbalanced component of divergence [s**-1]<br>24:var24:Reserved for future unbalanced components<br>25:var25:Reserved for future unbalanced components<br>26:CL:Lake cover [(0-1)]<br>27:CVL:Low vegetation cover [(0-1)]<br>28:CVH:High vegetation cover [(0-1)]<br>29:TVL:Type of low vegetation<br>30:TVH:Type of high vegetation<br>31:CI:Sea-ice cover [(0-1)]<br>32:ASN:Snow albedo [(0-1)]<br>33:RSN:Snow density [kg m**-3]<br>34:SSTK:Sea surface temperature [K]<br>35:ISTL1:Ice surface temperature layer 1 [K]<br>36:ISTL2:Ice surface temperature layer 2 [K]<br>37:ISTL3:Ice surface temperature layer 3 [K]<br>38:ISTL4:Ice surface temperature layer 4 [K]<br>39:SWVL1:Volumetric soil water layer 1 [m**3 m**-3]<br>40:SWVL2:Volumetric soil water layer 2 [m**3 m**-3]<br>41:SWVL3:Volumetric soil water layer 3 [m**3 m**-3]<br>42:SWVL4:Volumetric soil water layer 4 [m**3 m**-3]<br>43:SLT:Soil type<br>44:ES:Snow evaporation [m of water]<br>45:SMLT:Snowmelt [m of water]<br>46:SDUR:Solar duration [s]<br>47:DSRP:Direct solar radiation [w m**-2]<br>48:MAGSS:Magnitude of surface stress [N m**-2 s]<br>49:10FG:Wind gust at 10 metres [m s**-1]<br>50:LSPF:Large-scale precipitation fraction [s]<br>51:MX2T24:Maximum 2 metre temperature [K]<br>52:MN2T24:Minimum 2 metre temperature [K]<br>53:MONT:Montgomery potential [m**2 s**-2]<br>54:PRES:Pressure [Pa]<br>55:var55:undefined<br>56:var56:undefined<br>57:var57:undefined<br>58:var58:undefined<br>59:var59:undefined<br>60:PV:Potential vorticity [K m**2 kg**-1 s**-1]<br>78:TCLW:Total column liquid water [kg m**-2]<br>79:TCIW:Total column ice water [kg m**-2]<br>100:100:Experimental product [Undefined]<br>101:101:Experimental product [Undefined]<br>102:102:Experimental product [Undefined]<br>103:103:Experimental product [Undefined]<br>104:104:Experimental product [Undefined]<br>105:105:Experimental product [Undefined]<br>106:106:Experimental product [Undefined]<br>107:107:Experimental product [Undefined]<br>108:108:Experimental product [Undefined]<br>109:109:Experimental product [Undefined]<br>110:110:Experimental product [Undefined]<br>111:111:Experimental product [Undefined]<br>112:112:Experimental product [Undefined]<br>113:113:Experimental product [Undefined]<br>114:114:Experimental product [Undefined]<br>115:115:Experimental product [Undefined]<br>116:116:Experimental product [Undefined]<br>117:117:Experimental product [Undefined]<br>118:118:Experimental product [Undefined]<br>119:119:Experimental product [Undefined]<br>120:120:Experimental product [Undefined]<br>121:var121:undefined<br>122:var122:undefined<br>123:var123:undefined<br>124:var124:undefined<br>125:var125:undefined<br>126:var126:undefined<br>127:AT:Atmospheric tide<br>128:BV:Budget values<br>129:Z:Geopotential [m**2 s**-2]<br>130:T:Temperature [K]<br>131:U:U velocity [m s**-1]<br>132:V:V velocity [m s**-1]<br>133:Q:Specific humidity [kg kg**-1]<br>134:SP:Surface pressure [Pa]<br>135:W:Vertical velocity [Pa s**-1]<br>136:TCW:Total column water [kg m**-2]<br>137:TCWV:Total column water vapour [kg m**-2]<br>138:VO:Vorticity (relative) [s**-1]<br>139:STL1:Soil temperature level 1 [K]<br>140:SWL1:Soil wetness level 1 [m of water]<br>141:SD:Snow depth [m of water equivalent]<br>142:LSP:Stratiform precipitation [m]<br>143:CP:Convective precipitation [m]<br>144:SF:Snowfall (convective + stratiform) [m of water equivalent]<br>145:BLD:Boundary layer dissipation [W m**-2 s]<br>146:SSHF:Surface sensible heat flux [W m**-2 s]<br>147:SLHF:Surface latent heat flux [W m**-2 s]<br>148:CHNK:Charnock<br>149:SNR:Surface net radiation [W m**-2 s]<br>150:TNR:Top net radiation<br>151:MSL:Mean sea-level pressure [Pa]<br>152:LNSP:Logarithm of surface pressure<br>153:SWHR:Short-wave heating rate [K]<br>154:LWHR:Long-wave heating rate [K]<br>155:D:Divergence [s**-1]<br>156:GH:Height [m]<br>157:R:Relative humidity [%]<br>158:TSP:Tendency of surface pressure [Pa s**-1]<br>159:BLH:Boundary layer height [m]<br>160:SDOR:Standard deviation of orography<br>161:ISOR:Anisotropy of sub-gridscale orography<br>162:ANOR:Angle of sub-gridscale orography [rad]<br>163:SLOR:Slope of sub-gridscale orography<br>164:TCC:Total cloud cover [(0 - 1)]<br>165:10U:10 metre U wind component [m s**-1]<br>166:10V:10 metre V wind component [m s**-1]<br>167:2T:2 metre temperature [K]<br>168:2D:2 metre dewpoint temperature [K]<br>169:SSRD:Surface solar radiation downwards [W m**-2 s]<br>170:STL2:Soil temperature level 2 [K]<br>171:SWL2:Soil wetness level 2 [m of water]<br>172:LSM:Land/sea mask [(0, 1)]<br>173:SR:Surface roughness [m]<br>174:AL:Albedo [(0 - 1)]<br>175:STRD:Surface thermal radiation downwards [W m**-2 s]<br>176:SSR:Surface solar radiation [W m**-2 s]<br>177:STR:Surface thermal radiation [W m**-2 s]<br>178:TSR:Top solar radiation [W m**-2 s]<br>179:TTR:Top thermal radiation [W m**-2 s]<br>180:EWSS:East/West surface stress [N m**-2 s]<br>181:NSSS:North/South surface stress [N m**-2 s]<br>182:E:Evaporation [m of water]<br>183:STL3:Soil temperature level 3 [K]<br>184:SWL3:Soil wetness level 3 [m of water]<br>185:CCC:Convective cloud cover [(0 - 1)]<br>186:LCC:Low cloud cover [(0 - 1)]<br>187:MCC:Medium cloud cover [(0 - 1)]<br>188:HCC:High cloud cover [(0 - 1)]<br>189:SUND:Sunshine duration [s]<br>190:EWOV:EW component of subgrid orographic variance [m**2]<br>191:NSOV:NS component of subgrid orographic variance [m**2]<br>192:NWOV:NWSE component of subgrid orographic variance [m**2]<br>193:NEOV:NESW component of subgrid orographic variance [m**2]<br>194:BTMP:Brightness temperature [K]<br>195:LGWS:Lat. component of gravity wave stress [N m**-2 s]<br>196:MGWS:Meridional component of gravity wave stress [N m**-2 s]<br>197:GWD:Gravity wave dissipation [W m**-2 s]<br>198:SRC:Skin reservoir content [m of water]<br>199:VEG:Vegetation fraction [(0 - 1)]<br>200:VSO:Variance of sub-gridscale orography [m**2]<br>201:MX2T:Maximum 2 metre temperature since previous post-processing [K]<br>202:MN2T:Minimum 2 metre temperature since previous post-processing [K]<br>203:O3:Ozone mass mixing ratio [kg kg**-1]<br>204:PAW:Precipiation analysis weights<br>205:RO:Runoff [m]<br>206:TCO3:Total column ozone [Dobson]<br>207:10SI:10 meter windspeed [m s**-1]<br>208:TSRC:Top net solar radiation, clear sky [W m**-2]<br>209:TTRC:Top net thermal radiation, clear sky [W m**-2]<br>210:SSRC:Surface net solar radiation, clear sky [W m**-2]<br>211:STRC:Surface net thermal radiation, clear sky [W m**-2]<br>212:SI:Solar insolation [W m**-2]<br>213:var213:undefined<br>214:DHR:Diabatic heating by radiation [K]<br>215:DHVD:Diabatic heating by vertical diffusion [K]<br>216:DHCC:Diabatic heating by cumulus convection [K]<br>217:DHLC:Diabatic heating large-scale condensation [K]<br>218:VDZW:Vertical diffusion of zonal wind [m s**-1]<br>219:VDMW:Vertical diffusion of meridional wind [m s**-1]<br>220:EWGD:EW gravity wave drag tendency [m s**-1]<br>221:NSGD:NS gravity wave drag tendency [m s**-1]<br>222:CTZW:Convective tendency of zonal wind [m s**-1]<br>223:CTMW:Convective tendency of meridional wind [m s**-1]<br>224:VDH:Vertical diffusion of humidity [kg kg**-1]<br>225:HTCC:Humidity tendency by cumulus convection [kg kg**-1]<br>226:HTLC:Humidity tendency large-scale condensation [kg kg**-1]<br>227:CRNH:Change from removing negative humidity [kg kg**-1]<br>228:TP:Total precipitation [m]<br>229:IEWS:Instantaneous X surface stress [N m**-2]<br>230:INSS:Instantaneous Y surface stress [N m**-2]<br>231:ISHF:Instantaneous surface heat flux [W m**-2]<br>232:IE:Instantaneous moisture flux [kg m**-2 s]<br>233:ASQ:Apparent surface humidity [kg kg**-1]<br>234:LSRH:Logarithm of surface roughness length for heat<br>235:SKT:Skin temperature [K]<br>236:STL4:Soil temperature level 4 [K]<br>237:SWL4:Soil wetness level 4 [m]<br>238:TSN:Temperature of snow layer [K]<br>239:CSF:Convective snowfall [m of water equivalent]<br>240:LSF:Large-scale snowfall [m of water equivalent]<br>241:ACF:Accumulated cloud fraction tendency [(-1 to 1)]<br>242:ALW:Accumulated liquid water tendency [(-1 to 1)]<br>243:FAL:Forecast albedo [(0 - 1)]<br>244:FSR:Forecast surface roughness [m]<br>245:FLSR:Forecast log of surface roughness for heat<br>246:CLWC:Cloud liquid water content [kg kg**-1]<br>247:CIWC:Cloud ice water content [kg kg**-1]<br>248:CC:Cloud cover [(0 - 1)]<br>249:AIW:Accumulated ice water tendency [(-1 to 1)]<br>250:ICE:Ice age [1,0]<br>251:ATTE:Adiabatic tendency of temperature [K]<br>252:ATHE:Adiabatic tendency of humidity [kg kg**-1]<br>253:ATZE:Adiabatic tendency of zonal wind [m s**-1]<br>254:ATMW:Adiabatic tendency of meridional wind [m s**-1]<br>255:var255:undefined<br></code></pre></td></tr></table></figure>        </div>      </div>    </div><h1 id="references">References</h1><ol type="1"><li><a href="https://code.mpimet.mpg.de/projects/cdo/wiki/tutorial#Basic-Usage">Climate Data Operators (CDO) Tutorial (<strong>recommend</strong>)</a></li><li><a href="https://www.cpc.ncep.noaa.gov/products/wesley/reading_grib.html">Reading GRIB Files | NCEP</a></li><li><a href="https://www.cpc.ncep.noaa.gov/products/wesley/wgrib2">wgrib2: wgrib for GRIB-2 files</a></li><li><a href="https://confluence.ecmwf.int/display/CKB/What+are+GRIB+files+and+how+can+I+read+them">What are GRIB files and how can I read them</a></li><li><a href="https://old.wmo.int/extranet/pages/prog/www/WMOCodes/Guides/GRIB/Introduction_GRIB1-GRIB2.pdf">Please see the WMO "Introduction to GRIB Edition 1 and GRIB Edition 2" documentation for further details.</a></li><li><a href="https://perillaroc.github.io/eccodes-tutorial-cn/01-introduction/">GRIB格式介绍 (<strong>推薦</strong>)</a><ol type="1"><li>GRIB 格式是面向二进制的数据交换格式，无法直接阅读，需要使用软件进行解码和编码。</li><li>使用16进制编辑器打开 GRIB 文件的示例，除了最开始4个字节外，其余部分都无法解析成文本。 后面将会看到前4个字节对应的 ASCII 编码内容 GRIB 正是 GRIB 文件的标志。</li></ol></li><li><a href="https://blog.perillaroc.wang/post/2024/10/2024-10-19-grib-notebook-load-speed-with-different-grib2-packing-type/">GRIB2文件不同打包方式的加载速度对比 | November 07, 2024</a><ol type="1"><li>不同中心生成的 GRIB2 数据使用不同的打包方式：<ol type="1"><li>CMA 天气预报模式：JPEG2000 压缩 (grid_jpeg)</li><li>ECMWF 公开数据：CCSDS 无损压缩 (grid_ccsds)</li><li>NCEP GFS：复杂打包 (grid_complex_spatial_differencing)</li></ol></li></ol></li></ol>]]></content>
    
    
    <categories>
      
      <category>NWP</category>
      
    </categories>
    
    
    <tags>
      
      <tag>NWP</tag>
      
      <tag>WRF</tag>
      
      <tag>MPAS</tag>
      
      <tag>ERA5</tag>
      
      <tag>PGW</tag>
      
      <tag>GFS</tag>
      
      <tag>NetCDF</tag>
      
      <tag>CMIP6</tag>
      
      <tag>GRIB1</tag>
      
      <tag>GRIB2</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>NWP | PGW | To prepare the ERA5 GRIB file</title>
    <link href="/2025/02/05/NWP-PGW-To-prepare-the-ERA5-GRIB-file/"/>
    <url>/2025/02/05/NWP-PGW-To-prepare-the-ERA5-GRIB-file/</url>
    
    <content type="html"><![CDATA[<div class="note note-primary">            <p><a href="https://waipangsze.github.io/2025/02/03/NWP-PGW-hands-on-ERA5-GFS/"><strong>NWP | Pseudo-Global-Warming (PGW) hands-on | ERA5 | GFS</strong></a></p>          </div><div class="note note-primary">            <p><a href="https://waipangsze.github.io/2025/02/05/NWP-ERA5-GRIB1-GRIB2/"><strong>NWP | ERA5 | GRIB1 and GRIB2</strong></a></p>          </div><p>To prepare the <code>ERA5</code> GRIB file from the modified <code>era5_with_signal.nc</code>, you need to specify GRIB metadata such as <code>dataDate</code>, <code>shortName</code>, <code>level</code>, <code>dataType</code>, and <code>typeOfLevel</code> when converting <code>era5_with_signal.nc</code> back to GRIB format. The process involves using <strong><code>cdo</code></strong> and <strong><code>grib_set</code></strong> from ecCodes to properly define these GRIB headers.</p><p>Below is the detailed step-by-step guide:</p><hr /><h3 id="step-1-check-metadata-of-the-original-grib-file"><strong>Step 1: Check Metadata of the Original GRIB File</strong></h3><p>Inspect the original <code>ERA5</code> GRIB file (<code>era5.grib</code>) to understand the required metadata.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">grib_ls era5.grib<br></code></pre></td></tr></table></figure><p>This will give you information about: - <code>dataDate</code>: The date of the data (e.g., 20250101 for January 1, 2025). - <code>shortName</code>: The short name of the variable (e.g., <code>t2m</code> for 2-meter temperature). - <code>level</code>: The model level, pressure level, or surface (e.g., <code>2</code> for surface data). - <code>dataType</code>: The type of data, such as <code>an</code> (analysis) or <code>fc</code> (forecast). - <code>typeOfLevel</code>: Specifies the level type (e.g., <code>surface</code>, <code>isobaricInhPa</code>, etc.).</p><p>Ensure you note these details.</p><hr /><h3 id="step-2-convert-era5_with_signal.nc-to-grib-format"><strong>Step 2: Convert <code>era5_with_signal.nc</code> to GRIB Format</strong></h3><p>Use <strong><code>cdo</code></strong> to convert the modified NetCDF file to GRIB format. You can specify metadata such as short names, levels, and GRIB options directly.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">cdo -f grb copy era5_with_signal.nc era5_with_signal.grib<br></code></pre></td></tr></table></figure><p>This creates a basic GRIB file, but it may not yet have all the required metadata (e.g., <code>dataDate</code>, <code>shortName</code>, <code>typeOfLevel</code>). You can fix those in the next steps.</p><hr /><h3 id="step-3-assign-grib-metadata"><strong>Step 3: Assign GRIB Metadata</strong></h3><p>Use <strong><code>grib_set</code></strong> to modify GRIB metadata. First, inspect the GRIB file to see the current metadata:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">grib_ls era5_with_signal.grib<br></code></pre></td></tr></table></figure><p>If metadata like <code>dataDate</code>, <code>shortName</code>, or <code>typeOfLevel</code> is incorrect or missing, update them as follows:</p><h4 id="example-1-set-datadate-and-shortname">Example 1: Set <code>dataDate</code> and <code>shortName</code></h4><p>Set the date and variable short name (e.g., for <code>2-meter temperature</code>):</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">grib_set -s dataDate=20250101,dataTime=<span class="hljs-variable">$&#123;hh&#125;</span>00,shortName=t2m era5_with_signal.grib era5_with_signal_updated.grib<br></code></pre></td></tr></table></figure><h4 id="example-2-set-typeoflevel-and-level">Example 2: Set <code>typeOfLevel</code> and <code>level</code></h4><p>If the <code>typeOfLevel</code> (e.g., <code>surface</code>) or <code>level</code> (e.g., <code>2</code>) is missing or incorrect, set them:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">grib_set -s typeOfLevel=surface,level=2 era5_with_signal_updated.grib era5_with_signal_final.grib<br></code></pre></td></tr></table></figure><hr /><h3 id="step-4-verify-the-final-grib-file"><strong>Step 4: Verify the Final GRIB File</strong></h3><p>After updating the metadata, verify the contents of the resulting GRIB file:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">grib_ls era5_with_signal_final.grib<br></code></pre></td></tr></table></figure><p>Check that all metadata (e.g., <code>dataDate</code>, <code>shortName</code>, <code>level</code>, etc.) matches the desired values.</p><hr /><h3 id="step-5-automate-metadata-assignment-optional"><strong>Step 5: Automate Metadata Assignment (Optional)</strong></h3><p>If you need to assign multiple metadata fields at once, you can use a configuration file with <code>grib_set</code> or write a script to automate the process.</p><h4 id="example-bulk-metadata-update-script">Example: Bulk Metadata Update Script</h4><p>Create a script to set multiple fields:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-meta">#!/bin/bash</span><br><br>INPUT_GRIB=<span class="hljs-string">&quot;era5_with_signal.grib&quot;</span><br>OUTPUT_GRIB=<span class="hljs-string">&quot;era5_with_signal_final.grib&quot;</span><br><br><span class="hljs-comment"># Update metadata</span><br>grib_set -s dataDate=20250101,dataTime=<span class="hljs-variable">$&#123;hh&#125;</span>00,shortName=t2m,typeOfLevel=surface,level=2 <span class="hljs-variable">$INPUT_GRIB</span> <span class="hljs-variable">$OUTPUT_GRIB</span><br><br><span class="hljs-comment"># Verify metadata</span><br>grib_ls <span class="hljs-variable">$OUTPUT_GRIB</span><br></code></pre></td></tr></table></figure><p>Save this as <code>update_grib_metadata.sh</code>, make it executable, and run it:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">chmod</span> +x update_grib_metadata.sh<br>./update_grib_metadata.sh<br></code></pre></td></tr></table></figure><hr /><h3 id="step-6-handling-multiple-variables"><strong>Step 6: Handling Multiple Variables</strong></h3><p>If your <code>era5_with_signal.nc</code> contains multiple variables (e.g., temperature <code>t2m</code>, wind speed <code>u10</code>, etc.), you need to split the file by variable, assign correct metadata, and merge them back into one GRIB file.</p><h4 id="split-by-variable">Split by Variable:</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">cdo selname,t2m era5_with_signal.nc t2m.nc<br>cdo selname,u10 era5_with_signal.nc u10.nc<br></code></pre></td></tr></table></figure><h4 id="convert-each-variable-to-grib">Convert Each Variable to GRIB:</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">cdo -f grb copy t2m.nc t2m.grib<br>cdo -f grb copy u10.nc u10.grib<br></code></pre></td></tr></table></figure><h4 id="set-metadata-for-each-grib-file">Set Metadata for Each GRIB File:</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">grib_set -s dataDate=20250101,dataTime=<span class="hljs-variable">$&#123;hh&#125;</span>00,shortName=t2m,typeOfLevel=surface,level=2 t2m.grib t2m_final.grib<br>grib_set -s dataDate=20250101,dataTime=<span class="hljs-variable">$&#123;hh&#125;</span>00,shortName=u10,typeOfLevel=surface,level=10 u10.grib u10_final.grib<br></code></pre></td></tr></table></figure><h4 id="merge-the-grib-files">Merge the GRIB Files:</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">cdo merge t2m_final.grib u10_final.grib era5_with_signal_final.grib<br></code></pre></td></tr></table></figure><hr /><h3 id="summary-of-commands"><strong>Summary of Commands</strong></h3><ol type="1"><li><p>Convert NetCDF to GRIB: <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">cdo -f grb copy era5_with_signal.nc era5_with_signal.grib<br></code></pre></td></tr></table></figure></p></li><li><p>Assign GRIB metadata: <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">grib_set -s dataDate=YYYYMMDD,dataTime=<span class="hljs-variable">$&#123;hh&#125;</span>00,shortName=VAR,typeOfLevel=LEVEL_TYPE,level=LEVEL era5_with_signal.grib era5_with_signal_final.grib<br></code></pre></td></tr></table></figure></p></li><li><p>Verify the final GRIB file: <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">grib_ls era5_with_signal_final.grib<br></code></pre></td></tr></table></figure></p></li></ol><p>This process ensures that your modified ERA5 file is correctly formatted with all necessary GRIB metadata. Let me know if you encounter any issues!</p><h1 id="hands-on-wpsze">** Hands-on: wpsze</h1>    <div class="fold">      <div class="fold-title fold-info collapsed" data-toggle="collapse" href="#collapse-1607c597" role="button" aria-expanded="false" aria-controls="collapse-1607c597">        <div class="fold-arrow">▶</div>netcdf2grid.sh      </div>      <div class="fold-collapse collapse" id="collapse-1607c597">        <div class="fold-content">          <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><code class="hljs ssh">#!/bin/bash<br>#------------------------------------------------#<br>#Author:         wpsze<br>#Email：         wpsze<br>#date:           2025-02-06 08:41:43<br>#Version:        0.0 <br>#Description:    The purpose of the script<br>#Copyright (C)： 2025 All rights reserved<br>#------------------------------------------------#<br><br>#================= SL ====================================<br>cdo selname,sst new_ERA5-0p25-SL-$&#123;yyyymmddhh&#125;.nc sst_nan.nc<br>cdo selname,skt new_ERA5-0p25-SL-$&#123;yyyymmddhh&#125;.nc skt_nan.nc<br><br>cdo setmissval,-999 sst_nan.nc sst.nc<br>cdo setmissval,-999 skt_nan.nc skt.nc<br><br># cdo pack sst.nc sst_test.nc<br># cdo pack skt.nc skt_test.nc<br><br>cdo -f grb copy sst.nc sst.grib<br>cdo -f grb copy skt.nc skt.grib<br><br>cdo showname sst.grib<br>cdo showname skt.grib<br><br>grib_set -s dataDate=$&#123;yyyymmdd&#125;,dataTime=$&#123;hh&#125;00,shortName=sst,typeOfLevel=surface,level=0 sst.grib sst_final.grib<br>grib_set -s dataDate=$&#123;yyyymmdd&#125;,dataTime=$&#123;hh&#125;00,shortName=skt,typeOfLevel=surface,level=0 skt.grib skt_final.grib<br><br>cdo showname sst_final.grib<br>cdo showname skt_final.grib<br><br>cdo delname,var34,var235 original-SL.grib original-SL_without_vars.grib<br><br>rm new_ERA5-0p25-SL-$&#123;yyyymmddhh&#125;.grib<br>cdo merge sst_final.grib skt_final.grib original-SL_without_vars.grib new_ERA5-0p25-SL-$&#123;yyyymmddhh&#125;.grib<br><br>cdo showname new_ERA5-0p25-SL-$&#123;yyyymmddhh&#125;.grib<br><br>#================= PL: t ====================================<br>cdo selname,t new_ERA5-0p25-PL-$&#123;yyyymmddhh&#125;.nc t_nan.nc<br><br>cdo setmissval,-999 t_nan.nc t.nc<br><br># cdo pack t.nc t_test.nc<br><br># How to ensure the order of levels<br># encodeBMS_float   : Missing value = NaN is unsupported!<br>cdo -f grb copy t.nc t_lev.grib<br>cdo invertlev t_lev.grib t.grib<br><br>cdo showname t.grib<br><br>grib_set -s dataDate=$&#123;yyyymmdd&#125;,dataTime=$&#123;hh&#125;00,shortName=t,typeOfLevel=isobaricInhPa t.grib t_final.grib<br><br>cdo showname t_final.grib<br><br>##cdo delname,var130,var157 original-PL.grib original-PL_without_vars.grib<br>##cdo merge t_final.grib original-PL_without_vars.grib era5_with_signal_final_PL.grib<br>##cdo showname era5_with_signal_final_PL.grib<br><br>#================= PL: r ====================================<br>cdo selname,r new_ERA5-0p25-PL-$&#123;yyyymmddhh&#125;.nc r_nan.nc<br><br>cdo setmissval,-999 r_nan.nc r.nc<br><br># cdo pack r.nc r_test.nc<br><br># How to ensure the order of levels<br># encodeBMS_float   : Missing value = NaN is unsupported!<br>cdo -f grb copy r.nc r_lev.grib<br>cdo invertlev r_lev.grib r.grib<br><br>cdo showname r.grib<br><br>grib_set -s dataDate=$&#123;yyyymmdd&#125;,dataTime=$&#123;hh&#125;00,shortName=r,typeOfLevel=isobaricInhPa r.grib r_final.grib<br><br>cdo showname r_final.grib<br><br>#================= PL: combine t, r ====================================<br>cdo delname,var130,var157 original-PL.grib original-PL_without_vars.grib<br><br>rm new_ERA5-0p25-PL-$&#123;yyyymmddhh&#125;.grib<br>cdo merge t_final.grib r_final.grib original-PL_without_vars.grib new_ERA5-0p25-PL-$&#123;yyyymmddhh&#125;.grib<br><br>cdo showname new_ERA5-0p25-PL-$&#123;yyyymmddhh&#125;.grib<br></code></pre></td></tr></table></figure>        </div>      </div>    </div>    <div class="fold">      <div class="fold-title fold-info collapsed" data-toggle="collapse" href="#collapse-4f34dce5" role="button" aria-expanded="false" aria-controls="collapse-4f34dce5">        <div class="fold-arrow">▶</div>netcdf2grib_with_uv.sh      </div>      <div class="fold-collapse collapse" id="collapse-4f34dce5">        <div class="fold-content">          <figure class="highlight console"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br></pre></td><td class="code"><pre><code class="hljs console"><span class="hljs-meta prompt_">#</span><span class="language-bash">!/bin/bash</span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">------------------------------------------------#</span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">Author:         wpsze</span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">Email：         wpsze</span><br><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-built_in">date</span>:           2025-02-06 08:41:43</span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">Version:        0.0</span> <br><span class="hljs-meta prompt_">#</span><span class="language-bash">Description:    The purpose of the script</span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">Copyright (C)： 2025 All rights reserved</span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">------------------------------------------------#</span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">================= SL ====================================</span><br>cdo selname,sst new_ERA5-0p25-SL-$&#123;yyyymmddhh&#125;.nc sst_nan.nc<br>cdo selname,skt new_ERA5-0p25-SL-$&#123;yyyymmddhh&#125;.nc skt_nan.nc<br><br>cdo setmissval,-999 sst_nan.nc sst.nc<br>cdo setmissval,-999 skt_nan.nc skt.nc<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">cdo pack sst.nc sst_test.nc</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">cdo pack skt.nc skt_test.nc</span><br><br>cdo -f grb copy sst.nc sst.grib<br>cdo -f grb copy skt.nc skt.grib<br><br>cdo showname sst.grib<br>cdo showname skt.grib<br><br>grib_set -s dataDate=$&#123;yyyymmdd&#125;,dataTime=$&#123;hh&#125;00,shortName=sst,typeOfLevel=surface,level=0 sst.grib sst_final.grib<br>grib_set -s dataDate=$&#123;yyyymmdd&#125;,dataTime=$&#123;hh&#125;00,shortName=skt,typeOfLevel=surface,level=0 skt.grib skt_final.grib<br><br>cdo showname sst_final.grib<br>cdo showname skt_final.grib<br><br>cdo delname,var34,var235 original-SL.grib original-SL_without_vars.grib<br><br>rm new_ERA5-0p25-SL-$&#123;yyyymmddhh&#125;.grib<br>cdo merge sst_final.grib skt_final.grib original-SL_without_vars.grib new_ERA5-0p25-SL-$&#123;yyyymmddhh&#125;.grib<br><br>cdo showname new_ERA5-0p25-SL-$&#123;yyyymmddhh&#125;.grib<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">================= PL: t ====================================</span><br>cdo selname,t new_ERA5-0p25-PL-$&#123;yyyymmddhh&#125;.nc t_nan.nc<br><br>cdo setmissval,-999 t_nan.nc t.nc<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">cdo pack t.nc t_test.nc</span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">How to ensure the order of levels</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">encodeBMS_float   : Missing value = NaN is unsupported!</span><br>cdo -f grb copy t.nc t_lev.grib<br>cdo invertlev t_lev.grib t.grib<br><br>cdo showname t.grib<br><br>grib_set -s dataDate=$&#123;yyyymmdd&#125;,dataTime=$&#123;hh&#125;00,shortName=t,typeOfLevel=isobaricInhPa t.grib t_final.grib<br><br>cdo showname t_final.grib<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-comment">#cdo delname,var130,var157 original-PL.grib original-PL_without_vars.grib</span></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-comment">#cdo merge t_final.grib original-PL_without_vars.grib era5_with_signal_final_PL.grib</span></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-comment">#cdo showname era5_with_signal_final_PL.grib</span></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">================= PL: r ====================================</span><br>cdo selname,r new_ERA5-0p25-PL-$&#123;yyyymmddhh&#125;.nc r_nan.nc<br><br>cdo setmissval,-999 r_nan.nc r.nc<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">cdo pack r.nc r_test.nc</span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">How to ensure the order of levels</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">encodeBMS_float   : Missing value = NaN is unsupported!</span><br>cdo -f grb copy r.nc r_lev.grib<br>cdo invertlev r_lev.grib r.grib<br><br>cdo showname r.grib<br><br>grib_set -s dataDate=$&#123;yyyymmdd&#125;,dataTime=$&#123;hh&#125;00,shortName=r,typeOfLevel=isobaricInhPa r.grib r_final.grib<br><br>cdo showname r_final.grib<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">================= PL: u ====================================</span><br>cdo selname,u new_ERA5-0p25-PL-$&#123;yyyymmddhh&#125;.nc u_nan.nc<br><br>cdo setmissval,-999 u_nan.nc u.nc<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">cdo pack u.nc u_test.nc</span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">How to ensure the order of levels</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">encodeBMS_float   : Missing value = NaN is unsupported!</span><br>cdo -f grb copy u.nc u_lev.grib<br>cdo invertlev u_lev.grib u.grib<br><br>cdo showname u.grib<br><br>grib_set -s dataDate=$&#123;yyyymmdd&#125;,dataTime=$&#123;hh&#125;00,shortName=u,typeOfLevel=isobaricInhPa u.grib u_final.grib<br><br>cdo showname u_final.grib<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">================= PL: v ====================================</span><br>cdo selname,v new_ERA5-0p25-PL-$&#123;yyyymmddhh&#125;.nc v_nan.nc<br><br>cdo setmissval,-999 v_nan.nc v.nc<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">cdo pack v.nc v_test.nc</span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">How to ensure the order of levels</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">encodeBMS_float   : Missing value = NaN is unsupported!</span><br>cdo -f grb copy v.nc v_lev.grib<br>cdo invertlev v_lev.grib v.grib<br><br>cdo showname v.grib<br><br>grib_set -s dataDate=$&#123;yyyymmdd&#125;,dataTime=$&#123;hh&#125;00,shortName=v,typeOfLevel=isobaricInhPa v.grib v_final.grib<br><br>cdo showname v_final.grib<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">================= PL: combine t, r, u, v ====================================</span><br>cdo delname,var130,var157,var131,var132 original-PL.grib original-PL_without_vars.grib<br><br>rm new_ERA5-0p25-PL-$&#123;yyyymmddhh&#125;.grib<br>cdo merge t_final.grib r_final.grib u_final.grib v_final.grib original-PL_without_vars.grib new_ERA5-0p25-PL-$&#123;yyyymmddhh&#125;.grib<br><br>cdo showname new_ERA5-0p25-PL-$&#123;yyyymmddhh&#125;.grib<br></code></pre></td></tr></table></figure>        </div>      </div>    </div><h2 id="debug">Debug</h2><h3 id="encodebms_double-missing-value-nan-is-unsupported">encodeBMS_double : Missing value = NaN is unsupported!</h3><ul><li><a href="https://code.mpimet.mpg.de/boards/1/topics/1628">CDO NetCDF to Grib files | 2013</a></li></ul><p><strong>NaN is not allowed in the grib standard,</strong> but you can change it with cdo:</p><figure class="highlight console"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs console">[ram@thingol:~/tar/downloads]cdo setmissval,-9.e38 oscar_vel7403.nc t.nc<br>cdo setmissval: Processed 2310724 values from 4 variables over 1 timestep ( 0.12s )<br></code></pre></td></tr></table></figure><p>and then convert it to grib,</p><figure class="highlight console"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs console">[ram@thingol:~/tar/downloads]cdo -f grb copy t.nc oscar_vel7403.grb            <br>cgribexDefLevel    : Changed zaxis type from generic to pressure<br>cdo copy: Processed 2310724 values from 4 variables over 1 timestep ( 0.09s )<br></code></pre></td></tr></table></figure><p>Some lines on grib and netcdf:</p><p>GRIB1/GRIB2 are international standards for climate data sets defined by the WMO. Every data set has to have some identifiers (mostly integers), which describe what the data is (physical variable,unit,...). See here for a docu on the definitions. For example, NaN is not allowed for a missing value in the GRIB1 standard. In contrast to this Netcdf is self-explanatory: The user can defined, which name, unit or other (freely definable) attributes a certain variable should have. That's why it's not always possible to convert netcdf to grib.</p><h3 id="netcdf-numeric-conversion-not-representable">NetCDF: Numeric conversion not representable</h3><figure class="highlight console"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs console"><span class="hljs-meta prompt_"> $ </span><span class="language-bash">ncview sst.nc</span><br>Ncview 2.1.7 David W. Pierce  29 March 2016<br>http://meteora.ucsd.edu:80/~pierce/ncview_home_page.html<br>Copyright (C) 1993 through 2015, David W. Pierce<br>Ncview comes with ABSOLUTELY NO WARRANTY; for details type `ncview -w&#x27;.<br>This is free software licensed under the Gnu General Public License version 3; type `ncview -c&#x27; for redistribution details.<br><br>Note: no Ncview app-defaults file found, using internal defaults<br>netcdf_fi_get_data: error on nc_get_vara_float call<br>cdfid=65536   variable=sst<br>start, count:<br>[0]: 0  721<br>[1]: 0  1440<br>NetCDF: Numeric conversion not representable<br></code></pre></td></tr></table></figure><ul><li><a href="https://code.mpimet.mpg.de/boards/1/topics/165">NetCDF: Numeric conversion not representable</a></li><li><a href="https://code.mpimet.mpg.de/projects/cdo/wiki#netCDF-with-packed-data">netCDF with packed data</a><ul><li>Packing reduces the data volume by reducing the precision of the stored numbers. In NetCDF it is implemented using the attributes add_offset and scale_factor. CDO supports NetCDF files with packed data but can not automatically repack the data. That means the attributes add_offset and scale_factor are never changed. If you are using a CDO operator which change the range of the data you also have to take care that the modified data can be packed with the same add_offset and scale_factor. Otherwise the result could be wrong. You will get the following error message if some data values are out of the range of the packed datatype:</li><li><code>Error (cdf_put_vara_double) : NetCDF: Numeric conversion not representable</code></li><li>In this case you have to change the data type to <strong>single or double precision floating-point.</strong> This can be done with the CDO option <code>-b F32</code> or <code>-b F64</code>.</li><li>As of CDO release 2.3.0, NetCDF data is always written out unpacked if the operator changes the range of the data. Use the new operator pack to repack the data if required:</li><li><code>cdo pack -&lt;operator&gt;  infile outfile</code></li></ul></li></ul><figure class="highlight console"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs console"><span class="hljs-meta prompt_"> $ </span><span class="language-bash">cdo pack sst.nc sst_test.nc</span><br>cdo    pack: Processed 1038240 values from 1 variable over 1 timestep [0.29s 54MB].<br><br>-rw-rw-r-- 1 wpsze wpsze 8.0M Feb  6 11:16 sst.nc<br>-rw-rw-r-- 1 wpsze wpsze 2.1M Feb  6 11:51 sst_test.nc<br></code></pre></td></tr></table></figure><blockquote><ul><li>Packing reduces the data volume by reducing the precision of the stored numbers</li><li>It reduces the precision, so not apply <code>cdo pack</code></li></ul></blockquote>    <div class="fold">      <div class="fold-title fold-info collapsed" data-toggle="collapse" href="#collapse-5a8c6cc0" role="button" aria-expanded="false" aria-controls="collapse-5a8c6cc0">        <div class="fold-arrow">▶</div>ncdump -h sst*.nc      </div>      <div class="fold-collapse collapse" id="collapse-5a8c6cc0">        <div class="fold-content">          <figure class="highlight console"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs console"><span class="hljs-meta prompt_"> $ </span><span class="language-bash">ncdump -h sst.nc</span><br>netcdf sst &#123;<br>dimensions:<br>longitude = 1440 ;<br>latitude = 721 ;<br>variables:<br>double sst(latitude, longitude) ;<br>sst:coordinates = &quot;depthBelowLandLayer&quot; ;<br>sst:_FillValue = -Infinity ;<br>sst:missing_value = -Infinity ;<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"> $ </span><span class="language-bash">ncdump -h sst_test.nc</span> <br>netcdf sst_test &#123;<br>dimensions:<br>longitude = 1440 ;<br>latitude = 721 ;<br>variables:<br>short sst(latitude, longitude) ;<br>sst:coordinates = &quot;depthBelowLandLayer&quot; ;<br>sst:add_offset = 294.354168667848 ;<br>sst:scale_factor = 0.000648260007869365 ;<br>sst:_FillValue = -32767s ;<br>sst:missing_value = -32767s ;<br></code></pre></td></tr></table></figure>        </div>      </div>    </div><p>then, <code>ncview sst_test.nc</code> is successful.</p><h1 id="references">References</h1><ol type="1"><li><a href="https://code.mpimet.mpg.de/projects/cdo/wiki/tutorial#Basic-Usage">Climate Data Operators (CDO) Tutorial (<strong>recommend</strong>)</a></li></ol>]]></content>
    
    
    <categories>
      
      <category>NWP</category>
      
    </categories>
    
    
    <tags>
      
      <tag>NWP</tag>
      
      <tag>WRF</tag>
      
      <tag>MPAS</tag>
      
      <tag>ERA5</tag>
      
      <tag>PGW</tag>
      
      <tag>GFS</tag>
      
      <tag>GRIB</tag>
      
      <tag>NetCDF</tag>
      
      <tag>CMIP6</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ML | AnythingLLM + Ollama</title>
    <link href="/2025/02/04/ML-AnythingLLM-Ollama/"/>
    <url>/2025/02/04/ML-AnythingLLM-Ollama/</url>
    
    <content type="html"><![CDATA[<h1 id="what-is-anythingllm">What is AnythingLLM?</h1><ul><li><a href="https://docs.useanything.com/introduction" class="uri">https://docs.useanything.com/introduction</a></li></ul><p><strong>AnythingLLM</strong> is the easiest to use, all-in-one AI application that can do RAG, AI Agents, and much more with no code or infrastructure headaches.</p><p>AnythingLLM is built by <em>Mintplex Labs</em>, Inc - founded by Timothy Carambat and went through <em>YCombinator</em> Summer 2022.</p><div class="note note-primary">            <ul><li>You want a <strong>zero-setup, private, and all-in-one AI application for local LLMs, RAG, and AI Agents all in one place without painful developer-required set up</strong>.</li><li>用Ollama &amp; AnythingLLM建構AI知識庫</li></ul>          </div><ul><li>多用戶支持：無論是團隊合作還是個人使用，AnythingLLM 都能夠輕鬆管理多用戶的權限和操作。</li><li>靈活的 LLM 和向量資料庫選擇：用戶可以根據需求選擇合適的 LLM 和向量資料庫，滿足不同的應用場景。</li><li>高效的文件管理：支持多種文件類型，如 PDF、TXT、DOCX 等，並通過簡單的 UI 進行管理。（目前不支援DOC格式）</li><li>自定義聊天小工具：可將聊天功能嵌入網站，提升互動體驗。</li><li>兩種聊天模式：在保留上下文的會話模式(平常使用，沒資料就直接根據LLM的知識回應)和問答的查詢模式(較嚴格，查詢到資料才回答，更減低幻覺發生)之間靈活切換。</li></ul><div class="group-image-container"><div class="group-image-row"><div class="group-image-wrap"><img src="https://i.imgur.com/mhEGKtT.png" /></div></div><div class="group-image-row"><div class="group-image-wrap"><img src="https://i.imgur.com/YIN7Uls.png" /></div><div class="group-image-wrap"><img src="https://i.imgur.com/CdkwoT9.png" /></div><div class="group-image-wrap"><img src="https://i.imgur.com/W0WcgyK.png" /></div></div><div class="group-image-row"></div></div><h2 id="rag">RAG</h2><p>RAG (Retrieval-Augmented Generation) 可以想像成是一個小抄或字典，透過向量資料庫檢索出來的資料跟使用者的問題一併告訴語言模型，讓語言模型能夠減低幻覺，根據資料回答問題。</p><h2 id="ollama">Ollama</h2><ul><li>7B模型至少要8G內存，13B的要16G，想玩70B的大傢伙，那得有64G</li></ul><h1 id="installation">Installation</h1><h2 id="macos">MacOS</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">brew install --cask anythingllm<br></code></pre></td></tr></table></figure><p>Once installed, you will find AnythingLLM in your Applications folder as well as you can use <code>cmd + spacebar</code> and type in <code>AnythingLLM</code> to run.</p><h3 id="ollama-setup">ollama setup</h3><ul><li>URL: http://127.0.0.1:11434<ul><li>No slash / at the end of URL</li></ul></li><li>updated workspace</li></ul><div class="group-image-container"><div class="group-image-row"><div class="group-image-wrap"><img src="https://i.imgur.com/06uxnHS.png" /></div><div class="group-image-wrap"><img src="https://i.imgur.com/6F8l0Ml.png" /></div><div class="group-image-wrap"><img src="https://i.imgur.com/ScdOVxc.png" /></div></div><div class="group-image-row"></div></div><h3 id="upload-pdf">upload PDF</h3><div class="group-image-container"><div class="group-image-row"><div class="group-image-wrap"><img src="https://i.imgur.com/Bdx3d7w.png" /></div><div class="group-image-wrap"><img src="https://i.imgur.com/RWEbIjz.png" /></div><div class="group-image-wrap"><img src="https://i.imgur.com/6VWZ55T.png" /></div></div><div class="group-image-row"><div class="group-image-wrap"><img src="https://i.imgur.com/6lib4wr.png" /></div><div class="group-image-wrap"><img src="https://i.imgur.com/PuYMkhw.png" /></div><div class="group-image-wrap"><img src="https://i.imgur.com/QgsPU6h.png" /></div></div></div><h1 id="comments">Comments</h1><ul><li><a href="https://arxiv.org/html/2401.05856v1">Seven Failure Points When Engineering a Retrieval Augmented Generation System</a></li><li><a href="https://www.zhihu.com/question/2818756749/answer/20825040322">LLM RAG值得做吗？ - 小五哥的回答 - 知乎</a><ul><li>1、不值得。RAG是增强检索，本质上是语义近似检索，LLM只是对检索条目的总结，重点是在检索，而不是在大模型。</li><li>2、RAG对计算资源需求不高，向量库和向量模型对GPU的需求很低，甚至CPU也能跑，大模型用Ollama装量化模型，也不需要GPU，当然用CPU性能差些。</li><li>3、我个人认为，RAG中是个算力不足、无法实践微调的临时过渡方案，没有前景。</li><li>4、RAG的核心是文本分段策略，是数据层面的，非技术层面的。论文方面，两段检索、二次排名这些能出点成果。</li></ul></li><li><a href="https://www.zhihu.com/question/2818756749/answer/52312494601">LLM RAG值得做吗？ - 程序锅的回答 - 知乎</a><ul><li>如果大模型你不会做RAG，那你还能做什么？大模型训练门槛极高、大模型微调效果不佳，老板让你做一个LLM应用，输出结果全靠提示工程？</li><li>我的观点是大模型最近几年真正落地，都需要RAG来缓解幻觉问题。所以用好RAG以及掌握它的原理是很重要的</li></ul></li><li><a href="https://zhuanlan.zhihu.com/p/939571291">AnythingLLM 个人知识库局限性 - TroyLiu的文章 - 知乎</a></li></ul><h1 id="references">References</h1><ol type="1"><li><a href="https://anythingllm.com/">AnythingLLM</a></li><li><a href="https://medium.com/@pang2258/anythingllm-ollama%E8%BC%95%E9%AC%86%E6%9E%B6%E8%A8%AD%E5%A4%9A%E4%BA%BA%E7%94%A8%E7%9A%84%E5%AE%A2%E8%A3%BD%E5%8C%96-rag-2d05954bf771">AnythingLLM + Ollama輕鬆架設多人用的客製化 RAG</a></li><li><a href="https://www.cnblogs.com/jokingremarks/p/18151827">使用ollama + AnythingLLM快速且简单的在本地部署llama3</a></li></ol>]]></content>
    
    
    <categories>
      
      <category>ML</category>
      
    </categories>
    
    
    <tags>
      
      <tag>AI</tag>
      
      <tag>ML</tag>
      
      <tag>Ollama</tag>
      
      <tag>AnythingLLM</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>NWP | Pseudo-Global-Warming (PGW) hands-on | ERA5 | GFS</title>
    <link href="/2025/02/03/NWP-PGW-hands-on-ERA5-GFS/"/>
    <url>/2025/02/03/NWP-PGW-hands-on-ERA5-GFS/</url>
    
    <content type="html"><![CDATA[<h1 id="introduction">Introduction</h1><p>Keywords:</p><ul><li>The Pseudo-Global-Warming (<strong>PGW</strong>) approach</li><li><strong>CMIP6</strong></li><li>how to convert <strong>ERA5</strong> <strong>GRIB</strong> files to NetCDF format</li><li>GRIB files are the file format used at <strong>ECMWF</strong>. GRIB is a WMO standard and consists of GRIB Edition 1 and Edition 2</li></ul><p>The ERA5 dataset, produced by the European Centre for Medium-Range Weather Forecasts (ECMWF), provides a wealth of climate and weather data. However, the data is often distributed in the GRIB format, which can be less user-friendly than the NetCDF format, commonly used in scientific computing. This blog post will walk you through the process of converting ERA5 GRIB files to NetCDF.</p><div class="note note-primary">            <p>Read <a href="https://waipangsze.github.io/2024/09/30/PGW/"><strong>Pseudo-Global Warming (PGW) - Future Projection</strong></a></p>          </div><h1 id="motivation">Motivation</h1><p>Climate change is one of the most pressing issues of our time, and understanding its impacts requires access to high-quality climate data. The ERA5 dataset provides crucial information on past and present climate conditions, helping researchers analyze trends and signals related to climate change. However, the ERA5 data is often stored in GRIB format, which can be challenging to work with. By converting ERA5 GRIB files to NetCDF format, we can more easily integrate climate change signals into ERA5.</p><p>By applying the Pseudo-Global-Warming (PGW) approach, you can use the CMIP6 climate change signals to generate a difference and then add this to the initial conditions, such as those provided by ERA5.</p><h1 id="main-script">Main Script</h1>    <div class="fold">      <div class="fold-title fold-info collapsed" data-toggle="collapse" href="#collapse-8f7bdefe" role="button" aria-expanded="false" aria-controls="collapse-8f7bdefe">        <div class="fold-arrow">▶</div>loop.sh      </div>      <div class="fold-collapse collapse" id="collapse-8f7bdefe">        <div class="fold-content">          <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-meta">#!/bin/bash</span><br><br>ym=<span class="hljs-string">&quot;20220630&quot;</span><br><br><span class="hljs-keyword">for</span> iday <span class="hljs-keyword">in</span> &#123;0..360..3&#125;; <span class="hljs-keyword">do</span><br>    <span class="hljs-comment"># Next_day=$(date +%Y-%m-%d_%H:%M:%S -d &quot;$YYYYMMDD + 1 hour&quot;)</span><br>    <span class="hljs-built_in">export</span> ERA5_datetime=$(<span class="hljs-built_in">date</span> +%Y%m%d%H -d <span class="hljs-string">&quot;<span class="hljs-variable">$ym</span> + <span class="hljs-variable">$iday</span> hour&quot;</span>)<br>    <span class="hljs-built_in">echo</span> <span class="hljs-variable">$&#123;ERA5_datetime&#125;</span><br><br>    ./PGW_main.sh<br><span class="hljs-keyword">done</span><br></code></pre></td></tr></table></figure>        </div>      </div>    </div>    <div class="fold">      <div class="fold-title fold-info collapsed" data-toggle="collapse" href="#collapse-dcdac752" role="button" aria-expanded="false" aria-controls="collapse-dcdac752">        <div class="fold-arrow">▶</div>PGW_main.sh      </div>      <div class="fold-collapse collapse" id="collapse-dcdac752">        <div class="fold-content">          <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-meta">#!/bin/bash</span><br><br><span class="hljs-comment">#------------------------------------------------#</span><br><span class="hljs-comment">#Author:         wpsze</span><br><span class="hljs-comment">#Email：         wpsze</span><br><span class="hljs-comment">#date:           2025-02-10 09:45:06</span><br><span class="hljs-comment">#Version:        0.0 </span><br><span class="hljs-comment">#Description:    The purpose of the script</span><br><span class="hljs-comment">#Copyright (C)： 2025 All rights reserved</span><br><span class="hljs-comment">#------------------------------------------------#</span><br><br><span class="hljs-built_in">export</span> ERA5_datetime=<span class="hljs-variable">$&#123;ERA5_datetime:-&quot;2022063000&quot;&#125;</span><br><span class="hljs-built_in">export</span> ERA5_path=<span class="hljs-variable">$&#123;ERA5_path:-&quot;/home/wpsze/ERA5/&quot;&#125;</span><br><span class="hljs-built_in">export</span> PGW_ERA5_path=<span class="hljs-variable">$&#123;PGW_ERA5_path:-&quot;/home/wpsze/PGW/ERA5/&quot;&#125;</span>              <span class="hljs-comment"># save future projection of ERA5 IC</span><br><span class="hljs-built_in">export</span> PGW_script_path=<span class="hljs-variable">$&#123;PGW_script_path:-&quot;/home/wpsze/PGW/&quot;&#125;</span><br><br><span class="hljs-built_in">export</span> cmip6_signal_file=<span class="hljs-variable">$&#123;cmip6_signal_file:-&quot;/home/wpsze/CMIP6_gw_signal_difference_data/diff_ssp585far-hist_07.nc&quot;&#125;</span><br><br><span class="hljs-built_in">export</span> yyyymmddhh=<span class="hljs-string">&quot;<span class="hljs-variable">$&#123;ERA5_datetime&#125;</span>&quot;</span><br><span class="hljs-built_in">export</span> yyyymm=<span class="hljs-string">&quot;<span class="hljs-variable">$&#123;ERA5_datetime:0:6&#125;</span>&quot;</span><br><span class="hljs-built_in">export</span> yyyymmdd=<span class="hljs-string">&quot;<span class="hljs-variable">$&#123;ERA5_datetime:0:8&#125;</span>&quot;</span><br><span class="hljs-built_in">export</span> hh=<span class="hljs-string">&quot;<span class="hljs-variable">$&#123;ERA5_datetime:8:2&#125;</span>&quot;</span><br><br><span class="hljs-built_in">source</span> /home/wpsze/micromamba/etc/profile.d/micromamba.sh<br>micromamba activate PGW<br><br><span class="hljs-built_in">mkdir</span> -p tmp<br><span class="hljs-built_in">cd</span> tmp<br><br><span class="hljs-built_in">rm</span> *idx<br><span class="hljs-built_in">ln</span> -sf <span class="hljs-variable">$&#123;ERA5_path&#125;</span>/<span class="hljs-variable">$&#123;yyyymm&#125;</span>/<span class="hljs-variable">$&#123;yyyymmdd&#125;</span>/ERA5-0p25-PL-<span class="hljs-variable">$&#123;yyyymmddhh&#125;</span>.grib<br><span class="hljs-built_in">ln</span> -sf <span class="hljs-variable">$&#123;ERA5_path&#125;</span>/<span class="hljs-variable">$&#123;yyyymm&#125;</span>/<span class="hljs-variable">$&#123;yyyymmdd&#125;</span>/ERA5-0p25-SL-<span class="hljs-variable">$&#123;yyyymmddhh&#125;</span>.grib<br><br><span class="hljs-comment"># Convert ERA5.grib to .nc</span><br><span class="hljs-keyword">if</span> [[ ! -f <span class="hljs-string">&quot;ERA5-0p25-SL-<span class="hljs-variable">$&#123;yyyymmddhh&#125;</span>.nc&quot;</span> ]]; <span class="hljs-keyword">then</span><br>    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;ERA5-0p25-SL/PL-<span class="hljs-variable">$&#123;yyyymmddhh&#125;</span>.nc doesn&#x27;t exist, generating them ... &quot;</span><br>    time python3 <span class="hljs-variable">$&#123;PGW_script_path&#125;</span>/grib2netcdf.py<br><span class="hljs-keyword">else</span><br>    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;ERA5-0p25-SL/PL-<span class="hljs-variable">$&#123;yyyymmddhh&#125;</span>.nc exist.&quot;</span><br><span class="hljs-keyword">fi</span><br><br><span class="hljs-comment"># rename/rebuild singal.nc</span><br><span class="hljs-keyword">if</span> [[ ! -f <span class="hljs-string">&quot;signal.nc&quot;</span> ]]; <span class="hljs-keyword">then</span><br>    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;singal.nc doesn&#x27;t exits, soft-link and rebuild ...&quot;</span><br>    <span class="hljs-built_in">ln</span> -sf <span class="hljs-variable">$&#123;cmip6_signal_file&#125;</span> original-signal.nc<br>    time python3 <span class="hljs-variable">$&#123;PGW_script_path&#125;</span>/rename_signal.py<br><span class="hljs-keyword">else</span> <br>    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;signal.nc exists.&quot;</span><br><span class="hljs-keyword">fi</span><br><br><span class="hljs-comment"># regrid signal.nc (1.25deg) to 0.25deg </span><br><span class="hljs-keyword">if</span> [[ ! -f <span class="hljs-string">&quot;signal_0p25.nc&quot;</span> ]]; <span class="hljs-keyword">then</span><br>    cdo remapbil,r1440x721 signal.nc signal_0p25.nc<br><span class="hljs-keyword">else</span><br>    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;signal_0p25.nc exists.&quot;</span><br><span class="hljs-keyword">fi</span><br><br><span class="hljs-comment"># Add singal.nc into ERA5.nc</span><br>time python3 <span class="hljs-variable">$&#123;PGW_script_path&#125;</span>/2d_interp.py<br>time python3 <span class="hljs-variable">$&#123;PGW_script_path&#125;</span>/3d_interp.py<br><span class="hljs-comment"># time python3 $&#123;PGW_script_path&#125;/3d_interp_with_uv.py</span><br><br><span class="hljs-comment"># Convert nc file to grib file</span><br><span class="hljs-built_in">cp</span> ERA5-0p25-SL-<span class="hljs-variable">$&#123;yyyymmddhh&#125;</span>.grib original-SL.grib<br><span class="hljs-built_in">cp</span> ERA5-0p25-PL-<span class="hljs-variable">$&#123;yyyymmddhh&#125;</span>.grib original-PL.grib<br>time sh <span class="hljs-variable">$&#123;PGW_script_path&#125;</span>/netcdf2grib.sh<br><span class="hljs-comment"># time sh $&#123;PGW_script_path&#125;/netcdf2grib_with_uv.sh</span><br><br><span class="hljs-comment"># cleanup</span><br><span class="hljs-built_in">rm</span> original-SL.grib original-PL.grib<br><span class="hljs-built_in">rm</span> original-SL_without_vars.grib original-PL_without_vars.grib<br><span class="hljs-built_in">rm</span> skt_final.grib skt.grib skt_nan.nc skt.nc <br><span class="hljs-built_in">rm</span> sst_final.grib sst.grib sst_nan.nc sst.nc<br><span class="hljs-built_in">rm</span> t_final.grib t.grib t_lev.grib t_nan.nc t.nc<br><span class="hljs-built_in">rm</span> r_final.grib r.grib r_lev.grib r_nan.nc r.nc<br><span class="hljs-built_in">rm</span> *idx<br><br><span class="hljs-comment"># soft-link (Finally, have to move all girb to there!)</span><br><span class="hljs-built_in">mkdir</span> -p <span class="hljs-variable">$&#123;PGW_ERA5_path&#125;</span>/<span class="hljs-variable">$&#123;yyyymm&#125;</span>/<span class="hljs-variable">$&#123;yyyymmdd&#125;</span>/<br>current_dir=$(<span class="hljs-built_in">pwd</span>)<br><span class="hljs-built_in">ln</span> -sf <span class="hljs-variable">$&#123;current_dir&#125;</span>/new_ERA5-0p25-SL-<span class="hljs-variable">$&#123;yyyymmddhh&#125;</span>.grib <span class="hljs-variable">$&#123;PGW_ERA5_path&#125;</span>/<span class="hljs-variable">$&#123;yyyymm&#125;</span>/<span class="hljs-variable">$&#123;yyyymmdd&#125;</span>/ERA5-0p25-SL-<span class="hljs-variable">$&#123;yyyymmddhh&#125;</span>.grib<br><span class="hljs-built_in">ln</span> -sf <span class="hljs-variable">$&#123;current_dir&#125;</span>/new_ERA5-0p25-PL-<span class="hljs-variable">$&#123;yyyymmddhh&#125;</span>.grib <span class="hljs-variable">$&#123;PGW_ERA5_path&#125;</span>/<span class="hljs-variable">$&#123;yyyymm&#125;</span>/<span class="hljs-variable">$&#123;yyyymmdd&#125;</span>/ERA5-0p25-PL-<span class="hljs-variable">$&#123;yyyymmddhh&#125;</span>.grib<br></code></pre></td></tr></table></figure>        </div>      </div>    </div><h1 id="converting-era5-grib-to-netcdf-a-step-by-step-guide">Converting ERA5 GRIB to NetCDF: A Step-by-Step Guide</h1><h2 id="what-you-need">What You Need</h2><p>Before we begin, ensure you have the following:</p><ol type="1"><li><strong>Python</strong>: A popular programming language for data manipulation.</li><li><p><strong>Libraries</strong>: You will need <code>xarray</code>, <code>cfgrib</code>, and <code>netCDF4</code>. You can install them using pip:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs bash">micromamba <span class="hljs-built_in">env</span> create -n PGW<br>micromamba activate PGW<br>micromamba install python=3.11 -y<br>pip install xarray cfgrib netCDF4<br>micromamba install scipy -y<br>micromamba install conda-forge::cdo -y<br>micromamba install conda-forge::wgrib -y<br>micromamba install matplotlib -y<br></code></pre></td></tr></table></figure></li><li><strong>ERA5 GRIB File</strong>: Download your desired ERA5 dataset in GRIB format from the ECMWF website.</li><li>New tool (seems fine or for checking): <a href="https://confluence.ecmwf.int/display/OIFS/How+to+convert+GRIB+to+netCDF">Convert GRIB file to netCDF</a><ol type="1"><li><code>grib_to_netcdf ICMGG_hybrid.grb -o ICMGG_hybrid.nc</code></li><li><code>micromamba install conda-forge::eccodes -y</code></li></ol></li></ol><h2 id="steps-to-convert-grib-to-netcdf">Steps to Convert GRIB to NetCDF</h2>    <div class="fold">      <div class="fold-title fold-info collapsed" data-toggle="collapse" href="#collapse-9c51fa20" role="button" aria-expanded="false" aria-controls="collapse-9c51fa20">        <div class="fold-arrow">▶</div>grib2netcdf.py      </div>      <div class="fold-collapse collapse" id="collapse-9c51fa20">        <div class="fold-content">          <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/bin/python</span><br><br><span class="hljs-comment">#------------------------------------------------#</span><br><span class="hljs-comment">#Author:         wpsze</span><br><span class="hljs-comment">#Email：         wpsze</span><br><span class="hljs-comment">#date:           2025-02-03 17:26:38</span><br><span class="hljs-comment">#Version:        0.0 </span><br><span class="hljs-comment">#Description:    The purpose of the script</span><br><span class="hljs-comment">#Copyright (C)： 2025 All rights reserved</span><br><span class="hljs-comment">#------------------------------------------------#</span><br><span class="hljs-keyword">import</span> os<br><span class="hljs-keyword">import</span> xarray <span class="hljs-keyword">as</span> xr<br><br><span class="hljs-comment"># environment variable </span><br>yyyymmddhh = os.environ[<span class="hljs-string">&#x27;yyyymmddhh&#x27;</span>] <br><br><span class="hljs-comment">#============== SL =============================</span><br>grib_file = <span class="hljs-string">f&#x27;ERA5-0p25-SL-<span class="hljs-subst">&#123;yyyymmddhh&#125;</span>.grib&#x27;</span><br>ds = xr.open_dataset(grib_file, engine=<span class="hljs-string">&#x27;cfgrib&#x27;</span>)<br><br><span class="hljs-built_in">print</span>(ds)<br><br>output_file = <span class="hljs-string">f&#x27;ERA5-0p25-SL-<span class="hljs-subst">&#123;yyyymmddhh&#125;</span>.nc&#x27;</span><br>ds.to_netcdf(output_file)<br><br><span class="hljs-comment">#============== PL =============================</span><br>grib_file = <span class="hljs-string">f&#x27;ERA5-0p25-PL-<span class="hljs-subst">&#123;yyyymmddhh&#125;</span>.grib&#x27;</span><br>ds = xr.open_dataset(grib_file, engine=<span class="hljs-string">&#x27;cfgrib&#x27;</span>)<br><br><span class="hljs-built_in">print</span>(ds)<br><br>output_file = <span class="hljs-string">f&#x27;ERA5-0p25-PL-<span class="hljs-subst">&#123;yyyymmddhh&#125;</span>.nc&#x27;</span><br>ds.to_netcdf(output_file)<br></code></pre></td></tr></table></figure>        </div>      </div>    </div><h2 id="verify-the-conversion">Verify the Conversion</h2><p>To ensure that the conversion was successful, you can reopen the NetCDF file and inspect its contents.</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs python">ds_netcdf = xr.open_dataset(output_file)<br><span class="hljs-built_in">print</span>(ds_netcdf)<br></code></pre></td></tr></table></figure><h2 id="output">Output</h2>    <div class="fold">      <div class="fold-title fold-info collapsed" data-toggle="collapse" href="#collapse-90469042" role="button" aria-expanded="false" aria-controls="collapse-90469042">        <div class="fold-arrow">▶</div>ERA5-SL.nc (Surface level)      </div>      <div class="fold-collapse collapse" id="collapse-90469042">        <div class="fold-content">          <figure class="highlight console"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><code class="hljs console">&lt;xarray.Dataset&gt; Size: 62MB<br>Dimensions:              (latitude: 721, longitude: 1440)<br>Coordinates:<br>    number               int64 8B ...<br>    time                 datetime64[ns] 8B ...<br>    step                 timedelta64[ns] 8B ...<br>    surface              float64 8B ...<br>  * latitude             (latitude) float64 6kB 90.0 89.75 89.5 ... -89.75 -90.0<br>  * longitude            (longitude) float64 12kB 0.0 0.25 0.5 ... 359.5 359.8<br>    valid_time           datetime64[ns] 8B ...<br>    depthBelowLandLayer  float64 8B ...<br>Data variables: (12/15)<br>    u10                  (latitude, longitude) float32 4MB ...<br>    v10                  (latitude, longitude) float32 4MB ...<br>    d2m                  (latitude, longitude) float32 4MB ...<br>    t2m                  (latitude, longitude) float32 4MB ...<br>    lsm                  (latitude, longitude) float32 4MB ...<br>    msl                  (latitude, longitude) float32 4MB ...<br>    ...                   ...<br>    rsn                  (latitude, longitude) float32 4MB ...<br>    sd                   (latitude, longitude) float32 4MB ...<br>    stl1                 (latitude, longitude) float32 4MB ...<br>    sp                   (latitude, longitude) float32 4MB ...<br>    swvl1                (latitude, longitude) float32 4MB ...<br>    z                    (latitude, longitude) float32 4MB ...<br>Attributes:<br>    GRIB_edition:            1<br>    GRIB_centre:             ecmf<br>    GRIB_centreDescription:  European Centre for Medium-Range Weather Forecasts<br>    GRIB_subCentre:          0<br>    Conventions:             CF-1.7<br>    institution:             European Centre for Medium-Range Weather Forecasts<br>    history:                 2025-02-05T09:50 GRIB to CDM+CF via cfgrib-0.9.1...<br><br>netcdf ERA5 &#123;<br>dimensions:<br>latitude = 721 ;<br>longitude = 1440 ;<br>variables:<br>int64 number ;<br>number:long_name = &quot;ensemble member numerical id&quot; ;<br>number:standard_name = &quot;realization&quot; ;<br>int64 time ;<br>time:long_name = &quot;initial time of forecast&quot; ;<br>time:standard_name = &quot;forecast_reference_time&quot; ;<br>double step ;<br>step:long_name = &quot;time since forecast_reference_time&quot; ;<br>step:standard_name = &quot;forecast_period&quot; ;<br>double surface ;<br>surface:long_name = &quot;original GRIB coordinate for key: level(surface)&quot; ;<br>double latitude(latitude) ;<br>latitude:standard_name = &quot;latitude&quot; ;<br>latitude:long_name = &quot;latitude&quot; ;<br>double longitude(longitude) ;<br>longitude:standard_name = &quot;longitude&quot; ;<br>longitude:long_name = &quot;longitude&quot; ;<br>double valid_time ;<br>valid_time:standard_name = &quot;time&quot; ;<br>valid_time:long_name = &quot;time&quot; ;<br>float u10(latitude, longitude) ;<br>u10:long_name = &quot;10 metre U wind component&quot; ;<br>u10:standard_name = &quot;unknown&quot; ;<br>float v10(latitude, longitude) ;<br>v10:long_name = &quot;10 metre V wind component&quot; ;<br>v10:standard_name = &quot;unknown&quot; ;<br>float d2m(latitude, longitude) ;<br>d2m:long_name = &quot;2 metre dewpoint temperature&quot; ;<br>d2m:standard_name = &quot;unknown&quot; ;<br>float t2m(latitude, longitude) ;<br>t2m:long_name = &quot;2 metre temperature&quot; ;<br>t2m:standard_name = &quot;unknown&quot; ;<br>float lsm(latitude, longitude) ;<br>lsm:long_name = &quot;Land-sea mask&quot; ;<br>lsm:standard_name = &quot;land_binary_mask&quot; ;<br>float msl(latitude, longitude) ;<br>msl:long_name = &quot;Mean sea level pressure&quot; ;<br>msl:standard_name = &quot;air_pressure_at_mean_sea_level&quot; ;<br>float siconc(latitude, longitude) ;<br>siconc:long_name = &quot;Sea ice area fraction&quot; ;<br>siconc:standard_name = &quot;sea_ice_area_fraction&quot; ;<br>float sst(latitude, longitude) ;<br>sst:long_name = &quot;Sea surface temperature&quot; ;<br>sst:standard_name = &quot;unknown&quot; ;<br>float skt(latitude, longitude) ;<br>skt:long_name = &quot;Skin temperature&quot; ;<br>skt:standard_name = &quot;unknown&quot; ;<br>float rsn(latitude, longitude) ;<br>rsn:long_name = &quot;Snow density&quot; ;<br>rsn:standard_name = &quot;unknown&quot; ;<br>float sd(latitude, longitude) ;<br>sd:long_name = &quot;Snow depth&quot; ;<br>sd:standard_name = &quot;lwe_thickness_of_surface_snow_amount&quot; ;<br>double depthBelowLandLayer ;<br>depthBelowLandLayer:long_name = &quot;soil depth&quot; ;<br>depthBelowLandLayer:standard_name = &quot;depth&quot; ;<br>float stl1(latitude, longitude) ;<br>stl1:long_name = &quot;Soil temperature level 1&quot; ;<br>stl1:standard_name = &quot;surface_temperature&quot; ;<br>float sp(latitude, longitude) ;<br>sp:long_name = &quot;Surface pressure&quot; ;<br>sp:standard_name = &quot;surface_air_pressure&quot; ;<br>float swvl1(latitude, longitude) ;<br>swvl1:long_name = &quot;Volumetric soil water layer 1&quot; ;<br>swvl1:standard_name = &quot;unknown&quot; ;<br>float z(latitude, longitude) ;<br>z:long_name = &quot;Geopotential&quot; ;<br>z:standard_name = &quot;geopotential&quot; ;<br></code></pre></td></tr></table></figure>        </div>      </div>    </div>    <div class="fold">      <div class="fold-title fold-info collapsed" data-toggle="collapse" href="#collapse-738764b7" role="button" aria-expanded="false" aria-controls="collapse-738764b7">        <div class="fold-arrow">▶</div>ERA5-PL.nc (Pressure level)      </div>      <div class="fold-collapse collapse" id="collapse-738764b7">        <div class="fold-content">          <figure class="highlight console"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><code class="hljs console">&lt;xarray.Dataset&gt; Size: 922MB<br>Dimensions:        (isobaricInhPa: 37, latitude: 721, longitude: 1440)<br>Coordinates:<br>    number         int64 8B ...<br>    time           datetime64[ns] 8B ...<br>    step           timedelta64[ns] 8B ...<br>  * isobaricInhPa  (isobaricInhPa) float64 296B 1e+03 975.0 950.0 ... 2.0 1.0<br>  * latitude       (latitude) float64 6kB 90.0 89.75 89.5 ... -89.5 -89.75 -90.0<br>  * longitude      (longitude) float64 12kB 0.0 0.25 0.5 ... 359.2 359.5 359.8<br>    valid_time     datetime64[ns] 8B ...<br>Data variables:<br>    z              (isobaricInhPa, latitude, longitude) float32 154MB ...<br>    r              (isobaricInhPa, latitude, longitude) float32 154MB ...<br>    q              (isobaricInhPa, latitude, longitude) float32 154MB ...<br>    t              (isobaricInhPa, latitude, longitude) float32 154MB ...<br>    u              (isobaricInhPa, latitude, longitude) float32 154MB ...<br>    v              (isobaricInhPa, latitude, longitude) float32 154MB ...<br>Attributes:<br>    GRIB_edition:            1<br>    GRIB_centre:             ecmf<br>    GRIB_centreDescription:  European Centre for Medium-Range Weather Forecasts<br>    GRIB_subCentre:          0<br>    Conventions:             CF-1.7<br>    institution:             European Centre for Medium-Range Weather Forecasts<br>    history:                 2025-02-05T09:45 GRIB to CDM+CF via cfgrib-0.9.1...<br><br>netcdf ERA5-PL &#123;<br>dimensions:<br>isobaricInhPa = 37 ;<br>latitude = 721 ;<br>longitude = 1440 ;<br>variables:<br>int64 number ;<br>number:long_name = &quot;ensemble member numerical id&quot; ;<br>number:standard_name = &quot;realization&quot; ;<br>int64 time ;<br>time:long_name = &quot;initial time of forecast&quot; ;<br>time:standard_name = &quot;forecast_reference_time&quot; ;<br>double step ;<br>step:long_name = &quot;time since forecast_reference_time&quot; ;<br>step:standard_name = &quot;forecast_period&quot; ;<br>double isobaricInhPa(isobaricInhPa) ;<br>isobaricInhPa:long_name = &quot;pressure&quot; ;<br>isobaricInhPa:standard_name = &quot;air_pressure&quot; ;<br>double latitude(latitude) ;<br>latitude:standard_name = &quot;latitude&quot; ;<br>latitude:long_name = &quot;latitude&quot; ;<br>double longitude(longitude) ;<br>longitude:standard_name = &quot;longitude&quot; ;<br>longitude:long_name = &quot;longitude&quot; ;<br>double valid_time ;<br>valid_time:standard_name = &quot;time&quot; ;<br>valid_time:long_name = &quot;time&quot; ;<br>float z(isobaricInhPa, latitude, longitude) ;<br>z:long_name = &quot;Geopotential&quot; ;<br>z:standard_name = &quot;geopotential&quot; ;<br>float r(isobaricInhPa, latitude, longitude) ;<br>r:long_name = &quot;Relative humidity&quot; ;<br>r:standard_name = &quot;relative_humidity&quot; ;<br>float q(isobaricInhPa, latitude, longitude) ;<br>q:long_name = &quot;Specific humidity&quot; ;<br>q:standard_name = &quot;specific_humidity&quot; ;<br>float t(isobaricInhPa, latitude, longitude) ;<br>t:long_name = &quot;Temperature&quot; ;<br>t:standard_name = &quot;air_temperature&quot; ;<br>float u(isobaricInhPa, latitude, longitude) ;<br>u:long_name = &quot;U component of wind&quot; ;<br>u:standard_name = &quot;eastward_wind&quot; ;<br>float v(isobaricInhPa, latitude, longitude) ;<br>v:long_name = &quot;V component of wind&quot; ;<br>v:standard_name = &quot;northward_wind&quot; ;<br></code></pre></td></tr></table></figure>        </div>      </div>    </div><h2 id="additional-resources">Additional Resources</h2><ul><li><a href="https://docs.xarray.dev/en/stable/">xarray Documentation</a></li><li><a href="https://cfgrib.readthedocs.io/en/latest/">cfgrib Documentation</a></li><li><a href="https://www.ecmwf.int/en/forecasts/datasets/reanalysis-datasets/era5">ERA5 Data Access</a></li></ul><hr /><h1 id="interpolating-2d-sstskt-from-signal-netcdf-to-era5-netcdf">Interpolating 2D SST/SKT from Signal NetCDF to ERA5 NetCDF</h1><p>Here’s a Python script for interpolating Sea Surface Temperature (SST) and Surface Skin Temperature (SKT) from a signal NetCDF file to match the ERA5 grid. This process involves horizontal interpolation to ensure that the temperatures align accurately with the finer resolution of the ERA5 dataset. Accurate temperature data is crucial for climate modeling and analysis. By interpolating these temperatures, we can effectively integrate them into broader climate studies.</p><h2 id="manipulate-signal.nc">Manipulate signal.nc</h2><div class="note note-primary">            <p>Modify <code>signal.nc</code> because the original signal.nc is not properly defined in a format recognized by CDO, making it impossible to apply CDO command tools.</p>          </div>    <div class="fold">      <div class="fold-title fold-info collapsed" data-toggle="collapse" href="#collapse-dfb167e8" role="button" aria-expanded="false" aria-controls="collapse-dfb167e8">        <div class="fold-arrow">▶</div>signal.nc      </div>      <div class="fold-collapse collapse" id="collapse-dfb167e8">        <div class="fold-content">          <figure class="highlight console"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs console">netcdf signal &#123;<br>dimensions:<br>ncl0 = 14 ;<br>ncl1 = 145 ;<br>ncl2 = 288 ;<br>ncl3 = 145 ;<br>ncl4 = 288 ;<br>ncl5 = 14 ;<br>ncl6 = 145 ;<br>ncl7 = 288 ;<br>ncl8 = 14 ;<br>ncl9 = 145 ;<br>ncl10 = 288 ;<br>ncl11 = 14 ;<br>ncl12 = 145 ;<br>ncl13 = 288 ;<br>ncl14 = 14 ;<br>ncl15 = 145 ;<br>ncl16 = 288 ;<br>variables:<br>float diff_ta(ncl0, ncl1, ncl2) ;<br>float diff_ts(ncl3, ncl4) ;<br>float diff_rh(ncl5, ncl6, ncl7) ;<br>float diff_ua(ncl8, ncl9, ncl10) ;<br>float diff_va(ncl11, ncl12, ncl13) ;<br>double lev(ncl14) ;<br>double lat(ncl15) ;<br>double lon(ncl16) ;<br>&#125;<br></code></pre></td></tr></table></figure>        </div>      </div>    </div><h2 id="cdo">cdo</h2><p>Error: <code>cdo    remapbil (Abort): Unsupported generic coordinates (Variable: diff_ta)!</code></p><p>It is because <strong>lat/lon/lev are not well-defined</strong>.</p><ul><li>The original signal.nc is not well-defined file...</li><li>have to assign attrs of dimension,<ul><li>isobaricInhPa = 37 ;</li><li>latitude = 721 ;</li><li>longitude = 1440 ;</li></ul></li><li>Probably you need to fix the missing values, too.</li></ul>    <div class="fold">      <div class="fold-title fold-info collapsed" data-toggle="collapse" href="#collapse-5d5d193e" role="button" aria-expanded="false" aria-controls="collapse-5d5d193e">        <div class="fold-arrow">▶</div>rename_signal.py      </div>      <div class="fold-collapse collapse" id="collapse-5d5d193e">        <div class="fold-content">          <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/bin/python</span><br><br><span class="hljs-comment">#------------------------------------------------#</span><br><span class="hljs-comment">#Author:         wpsze</span><br><span class="hljs-comment">#Email：         wpsze</span><br><span class="hljs-comment">#date:           2025-02-07 17:37:01</span><br><span class="hljs-comment">#Version:        0.0 </span><br><span class="hljs-comment">#Description:    The purpose of the script</span><br><span class="hljs-comment">#Copyright (C)： 2025 All rights reserved</span><br><span class="hljs-comment">#------------------------------------------------#</span><br><br><span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np<br><span class="hljs-keyword">import</span> xarray <span class="hljs-keyword">as</span> xr<br><br><span class="hljs-comment"># Load the signal and ERA5 NetCDF files</span><br>signal_nc = xr.open_dataset(<span class="hljs-string">&#x27;signal.nc&#x27;</span>)      <span class="hljs-comment"># Replace with actual signal file path</span><br><br>signal_nc = signal_nc.rename(&#123;<span class="hljs-string">&#x27;ncl0&#x27;</span>: <span class="hljs-string">&#x27;level&#x27;</span>, <span class="hljs-string">&#x27;ncl1&#x27;</span>: <span class="hljs-string">&#x27;latitude&#x27;</span>, <span class="hljs-string">&#x27;ncl2&#x27;</span>: <span class="hljs-string">&#x27;longitude&#x27;</span>,<br>                              <span class="hljs-string">&#x27;ncl3&#x27;</span>: <span class="hljs-string">&#x27;latitude&#x27;</span>, <span class="hljs-string">&#x27;ncl4&#x27;</span>: <span class="hljs-string">&#x27;longitude&#x27;</span>,<br>                              <span class="hljs-string">&#x27;ncl5&#x27;</span>: <span class="hljs-string">&#x27;level&#x27;</span>, <span class="hljs-string">&#x27;ncl6&#x27;</span>: <span class="hljs-string">&#x27;latitude&#x27;</span>, <span class="hljs-string">&#x27;ncl7&#x27;</span>: <span class="hljs-string">&#x27;longitude&#x27;</span>,<br>                              <span class="hljs-string">&#x27;ncl8&#x27;</span>: <span class="hljs-string">&#x27;level&#x27;</span>, <span class="hljs-string">&#x27;ncl9&#x27;</span>: <span class="hljs-string">&#x27;latitude&#x27;</span>, <span class="hljs-string">&#x27;ncl10&#x27;</span>: <span class="hljs-string">&#x27;longitude&#x27;</span>,<br>                              <span class="hljs-string">&#x27;ncl11&#x27;</span>: <span class="hljs-string">&#x27;level&#x27;</span>, <span class="hljs-string">&#x27;ncl12&#x27;</span>: <span class="hljs-string">&#x27;latitude&#x27;</span>, <span class="hljs-string">&#x27;ncl13&#x27;</span>: <span class="hljs-string">&#x27;longitude&#x27;</span>,<br>                              <span class="hljs-string">&#x27;ncl14&#x27;</span>: <span class="hljs-string">&#x27;level&#x27;</span>, <span class="hljs-string">&#x27;ncl15&#x27;</span>: <span class="hljs-string">&#x27;latitude&#x27;</span>, <span class="hljs-string">&#x27;ncl16&#x27;</span>: <span class="hljs-string">&#x27;longitude&#x27;</span>,&#125;)<br><br><span class="hljs-comment"># Define dimensions</span><br>lev = signal_nc[<span class="hljs-string">&#x27;lev&#x27;</span>].values  <span class="hljs-comment"># Level dimension</span><br>lat = signal_nc[<span class="hljs-string">&#x27;lat&#x27;</span>].values  <span class="hljs-comment"># Latitude dimension</span><br>lon = signal_nc[<span class="hljs-string">&#x27;lon&#x27;</span>].values  <span class="hljs-comment"># Longitude dimension</span><br><br><span class="hljs-comment"># Create DataArrays</span><br>diff_ta = xr.DataArray(<br>    signal_nc[<span class="hljs-string">&#x27;diff_ta&#x27;</span>],<br>    dims=[<span class="hljs-string">&quot;level&quot;</span>, <span class="hljs-string">&quot;latitude&quot;</span>, <span class="hljs-string">&quot;longitude&quot;</span>],<br>    coords=&#123;<span class="hljs-string">&quot;level&quot;</span>: lev, <span class="hljs-string">&quot;latitude&quot;</span>: lat, <span class="hljs-string">&quot;longitude&quot;</span>: lon&#125;<br>)<br><br>diff_rh = xr.DataArray(<br>    signal_nc[<span class="hljs-string">&#x27;diff_rh&#x27;</span>],<br>    dims=[<span class="hljs-string">&quot;level&quot;</span>, <span class="hljs-string">&quot;latitude&quot;</span>, <span class="hljs-string">&quot;longitude&quot;</span>],<br>    coords=&#123;<span class="hljs-string">&quot;level&quot;</span>: lev, <span class="hljs-string">&quot;latitude&quot;</span>: lat, <span class="hljs-string">&quot;longitude&quot;</span>: lon&#125;<br>)<br><br>diff_ua = xr.DataArray(<br>    signal_nc[<span class="hljs-string">&#x27;diff_ua&#x27;</span>],<br>    dims=[<span class="hljs-string">&quot;level&quot;</span>, <span class="hljs-string">&quot;latitude&quot;</span>, <span class="hljs-string">&quot;longitude&quot;</span>],<br>    coords=&#123;<span class="hljs-string">&quot;level&quot;</span>: lev, <span class="hljs-string">&quot;latitude&quot;</span>: lat, <span class="hljs-string">&quot;longitude&quot;</span>: lon&#125;<br>)<br><br>diff_va = xr.DataArray(<br>    signal_nc[<span class="hljs-string">&#x27;diff_va&#x27;</span>],<br>    dims=[<span class="hljs-string">&quot;level&quot;</span>, <span class="hljs-string">&quot;latitude&quot;</span>, <span class="hljs-string">&quot;longitude&quot;</span>],<br>    coords=&#123;<span class="hljs-string">&quot;level&quot;</span>: lev, <span class="hljs-string">&quot;latitude&quot;</span>: lat, <span class="hljs-string">&quot;longitude&quot;</span>: lon&#125;<br>)<br><br>diff_ts = xr.DataArray(<br>    signal_nc[<span class="hljs-string">&#x27;diff_ts&#x27;</span>],<br>    dims=[<span class="hljs-string">&quot;latitude&quot;</span>, <span class="hljs-string">&quot;longitude&quot;</span>],<br>    coords=&#123;<span class="hljs-string">&quot;latitude&quot;</span>: lat, <span class="hljs-string">&quot;longitude&quot;</span>: lon&#125;<br>)<br><br><span class="hljs-comment"># Combine into a Dataset</span><br>test = xr.Dataset(&#123;<br>    <span class="hljs-string">&quot;diff_ta&quot;</span>: diff_ta,<br>    <span class="hljs-string">&quot;diff_rh&quot;</span>: diff_rh,<br>    <span class="hljs-string">&quot;diff_ua&quot;</span>: diff_ua,<br>    <span class="hljs-string">&quot;diff_va&quot;</span>: diff_va,<br>    <span class="hljs-string">&quot;diff_ts&quot;</span>: diff_ts<br>&#125;)<br><br>test[<span class="hljs-string">&#x27;latitude&#x27;</span>] = test[<span class="hljs-string">&#x27;latitude&#x27;</span>].assign_attrs(<br>                standard_name = <span class="hljs-string">&quot;latitude&quot;</span>,<br>long_name = <span class="hljs-string">&quot;latitude&quot;</span>,<br>units = <span class="hljs-string">&quot;degrees_north&quot;</span>,<br>axis = <span class="hljs-string">&quot;Y&quot;</span> )<br>test[<span class="hljs-string">&#x27;longitude&#x27;</span>] = test[<span class="hljs-string">&#x27;longitude&#x27;</span>].assign_attrs(<br>                standard_name = <span class="hljs-string">&quot;longitude&quot;</span>,<br>long_name = <span class="hljs-string">&quot;longitude&quot;</span>,<br>units = <span class="hljs-string">&quot;degrees_east&quot;</span>,<br>axis = <span class="hljs-string">&quot;X&quot;</span>)<br><br>test[<span class="hljs-string">&#x27;level&#x27;</span>] = test[<span class="hljs-string">&#x27;level&#x27;</span>].assign_attrs(<br>                standard_name = <span class="hljs-string">&quot;air_pressure&quot;</span>,<br>long_name = <span class="hljs-string">&quot;pressure&quot;</span>,<br>units = <span class="hljs-string">&quot;Pa&quot;</span>,<br>positive = <span class="hljs-string">&quot;down&quot;</span>,<br>axis = <span class="hljs-string">&quot;Z&quot;</span>,<br>stored_direction = <span class="hljs-string">&quot;decreasing&quot;</span>)<br>   <br><span class="hljs-comment">#================== Save =================================================</span><br><span class="hljs-comment"># Save the result to a new NetCDF file</span><br>test.to_netcdf(<span class="hljs-string">&#x27;signal.nc&#x27;</span>, <span class="hljs-built_in">format</span>=<span class="hljs-string">&#x27;NETCDF4&#x27;</span>)<br></code></pre></td></tr></table></figure>        </div>      </div>    </div><p>and, regrid <code>singal.nc</code> to <strong>0.25deg</strong>,</p><figure class="highlight qml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs qml">cdo remapbil,r1440x721 <span class="hljs-keyword">signal</span><span class="hljs-string">.nc signal_0p25.nc</span><br></code></pre></td></tr></table></figure><h2 id="python-script">Python script</h2>    <div class="fold">      <div class="fold-title fold-info collapsed" data-toggle="collapse" href="#collapse-8e159bd8" role="button" aria-expanded="false" aria-controls="collapse-8e159bd8">        <div class="fold-arrow">▶</div>2d_interp.py      </div>      <div class="fold-collapse collapse" id="collapse-8e159bd8">        <div class="fold-content">          <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/bin/python</span><br><br><span class="hljs-comment">#------------------------------------------------#</span><br><span class="hljs-comment">#Author:         wpsze</span><br><span class="hljs-comment">#Email：         wpsze</span><br><span class="hljs-comment">#date:           2025-02-04 16:34:39</span><br><span class="hljs-comment">#Version:        0.0 </span><br><span class="hljs-comment">#Description:    The purpose of the script</span><br><span class="hljs-comment">#Copyright (C)： 2025 All rights reserved</span><br><span class="hljs-comment">#------------------------------------------------#</span><br><span class="hljs-keyword">import</span> os<br><span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np<br><span class="hljs-keyword">import</span> xarray <span class="hljs-keyword">as</span> xr<br><span class="hljs-comment"># from scipy.interpolate import interp1d</span><br><br><span class="hljs-comment"># environment variable </span><br>yyyymmddhh = os.environ[<span class="hljs-string">&#x27;yyyymmddhh&#x27;</span>] <br><br><span class="hljs-comment"># Load the signal and ERA5 NetCDF files</span><br>signal_nc = xr.open_dataset(<span class="hljs-string">&#x27;signal_0p25.nc&#x27;</span>)      <span class="hljs-comment"># Replace with actual signal file path</span><br>era5_nc = xr.open_dataset(<span class="hljs-string">&#x27;ERA5-SL.nc&#x27;</span>)          <span class="hljs-comment"># Replace with actual ERA5 file path</span><br><br><span class="hljs-comment"># Extract 2D SST variables</span><br>sst_signal = signal_nc[<span class="hljs-string">&#x27;diff_ts&#x27;</span>]  <span class="hljs-comment"># SST from signal file (2D array)</span><br>skt_signal = signal_nc[<span class="hljs-string">&#x27;diff_ts&#x27;</span>]  <span class="hljs-comment"># Skin temperature from signal file (2D array)</span><br>lat_signal = signal_nc[<span class="hljs-string">&#x27;lat&#x27;</span>]<br>lon_signal = signal_nc[<span class="hljs-string">&#x27;lon&#x27;</span>]<br><br>sst_era5 = era5_nc[<span class="hljs-string">&#x27;sst&#x27;</span>]       <span class="hljs-comment"># SST from ERA5 file (2D array)</span><br>skt_era5 = era5_nc[<span class="hljs-string">&#x27;skt&#x27;</span>]       <span class="hljs-comment"># Skin temperature from ERA5 file (2D array)</span><br><br><span class="hljs-comment">#================== SST ==================================================</span><br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;=== processing: SST &quot;</span>)<br><span class="hljs-comment"># Update dimensions for signal_sst.nc</span><br><span class="hljs-comment">#sst_signal = sst_signal.rename(&#123;&#x27;ncl3&#x27;: &#x27;latitude&#x27;, &#x27;ncl4&#x27;: &#x27;longitude&#x27;&#125;)</span><br><br><span class="hljs-comment"># # Reverse the SST data along the latitude dimension</span><br><span class="hljs-comment">#reversed_sst_signal = sst_signal[::-1, :]  # Assuming latitude is the first dimension</span><br><br><span class="hljs-comment"># # Update the coordinates to reflect the new latitude order</span><br><span class="hljs-comment">#reversed_latitude = lat_signal[::-1]  # Reverse latitude coordinates, from [-90,90] to [90,-90]</span><br><br><span class="hljs-comment"># # Update the SST variable to use the reversed latitude</span><br><span class="hljs-comment">#reversed_sst_signal = reversed_sst_signal.assign_coords(latitude=reversed_latitude.values, longitude=lon_signal.values)</span><br><br><span class="hljs-comment"># Define new latitude and longitude arrays for 0.25-degree grid</span><br><span class="hljs-comment"># Perform horizontal interpolation to 0.25-degree grid</span><br><span class="hljs-comment"># method (&#123;&quot;linear&quot;, &quot;nearest&quot;, &quot;zero&quot;, &quot;slinear&quot;, &quot;quadratic&quot;, </span><br><span class="hljs-comment"># &quot;cubic&quot;, &quot;quintic&quot;, &quot;polynomial&quot;, &quot;pchip&quot;, &quot;barycentric&quot;, &quot;krogh&quot;,</span><br><span class="hljs-comment"># &quot;akima&quot;, &quot;makima&quot;&#125;) – Interpolation method to use (see descriptions above). fill_value=&#x27;extrapolate&#x27;</span><br><span class="hljs-comment"># reversed_sst_signal = reversed_sst_signal.interp(latitude=sst_era5.coords[&#x27;latitude&#x27;].values, </span><br><span class="hljs-comment">#                                                  longitude=sst_era5.coords[&#x27;longitude&#x27;].values)</span><br><br><span class="hljs-comment"># Add signal to ERA5</span><br>era5_nc[<span class="hljs-string">&#x27;sst&#x27;</span>] = sst_era5 + sst_signal.values[::-<span class="hljs-number">1</span>,:] <span class="hljs-comment"># Reverse latitude coordinates, from [-90,90] to [90,-90]</span><br><br><span class="hljs-comment"># #================== skt ==================================================</span><br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;=== processing: Skin temperature &quot;</span>)<br><span class="hljs-comment"># # Update dimensions for signal_sst.nc</span><br><span class="hljs-comment"># skt_signal = skt_signal.rename(&#123;&#x27;ncl3&#x27;: &#x27;latitude&#x27;, &#x27;ncl4&#x27;: &#x27;longitude&#x27;&#125;)</span><br><br><span class="hljs-comment"># # Reverse the SST data along the latitude dimension</span><br><span class="hljs-comment">#reversed_skt_signal = skt_signal[::-1, :]  # Assuming latitude is the first dimension</span><br><br><span class="hljs-comment"># # Update the coordinates to reflect the new latitude order</span><br><span class="hljs-comment"># # reversed_latitude = lat_signal[::-1]  # Reverse latitude coordinates (Done before!!)</span><br><br><span class="hljs-comment"># # Update the SST variable to use the reversed latitude</span><br><span class="hljs-comment">#reversed_skt_signal = reversed_skt_signal.assign_coords(latitude=reversed_latitude.values, longitude=lon_signal.values)</span><br><br><span class="hljs-comment"># # Define new latitude and longitude arrays for 0.25-degree grid</span><br><span class="hljs-comment"># # Perform horizontal interpolation to 0.25-degree grid</span><br><span class="hljs-comment"># reversed_skt_signal = reversed_skt_signal.interp(latitude=sst_era5.coords[&#x27;latitude&#x27;].values, </span><br><span class="hljs-comment">#                                                  longitude=sst_era5.coords[&#x27;longitude&#x27;].values)</span><br><br><span class="hljs-comment"># # Add signal to ERA5</span><br>era5_nc[<span class="hljs-string">&#x27;skt&#x27;</span>] = skt_era5 + skt_signal.values[::-<span class="hljs-number">1</span>,:] <span class="hljs-comment"># Reverse latitude coordinates, from [-90,90] to [90,-90]</span><br><br><span class="hljs-comment">#================== Save =================================================</span><br><span class="hljs-comment"># Save the result to a new NetCDF file</span><br>era5_nc.to_netcdf(<span class="hljs-string">f&#x27;new_ERA5-0p25-SL-<span class="hljs-subst">&#123;yyyymmddhh&#125;</span>.nc&#x27;</span>)<br><br><span class="hljs-comment">##to_grib(era5_nc, &#x27;new_ERA5_SL.grib&#x27;) #, grib_keys=&#123;&#x27;centre&#x27;: &#x27;ecmf&#x27;&#125;)</span><br><br><span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;Horizontal interpolation completed and save</span><br></code></pre></td></tr></table></figure>        </div>      </div>    </div><h1 id="interpolating-3d-temperature-from-signal-netcdf-to-era5-netcdf">Interpolating 3D Temperature from Signal NetCDF to ERA5 NetCDF</h1><p>Here's a Python script for interpolating a 3D temperature field from a signal NetCDF file to match the grid of an ERA5 NetCDF file.</p><p>In this part, we will demonstrate how to interpolate a 3D temperature field (<code>ta</code>) from a signal NetCDF file to match the grid of an ERA5 NetCDF file containing its own 3D temperature field (<code>TT</code>). This process is essential for applying climate change signals to ERA5 data effectively.</p><h2 id="introduction-1">Introduction</h2><p>In this blog, we'll discuss how to interpolate a 3D temperature field (<code>ta</code>) from a signal NetCDF file to match the grid of an ERA5 NetCDF file, which contains a different temperature variable (<code>TT</code>). This procedure involves two main steps: vertical interpolation to align the vertical levels and horizontal interpolation to match the latitude and longitude coordinates.</p><h2 id="motivation-1">Motivation</h2><p>By applying the Pseudo-Global-Warming (PGW) approach using CMIP6 climate change signals, we can generate a difference that can be added to the initial conditions like ERA5. Accurate interpolation is crucial for effective climate modeling and analysis.</p><h2 id="steps-for-interpolation">Steps for Interpolation</h2><ol type="1"><li><strong>Vertical Interpolation</strong>: Adjust the temperature data from the signal file to the vertical levels of the ERA5 file.</li></ol><h3 id="python-script-1">Python Script</h3>    <div class="fold">      <div class="fold-title fold-info collapsed" data-toggle="collapse" href="#collapse-42d133e0" role="button" aria-expanded="false" aria-controls="collapse-42d133e0">        <div class="fold-arrow">▶</div>ERA5 isobaricInhPa      </div>      <div class="fold-collapse collapse" id="collapse-42d133e0">        <div class="fold-content">          <figure class="highlight console"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs console">netcdf ERA5-PL &#123;<br>dimensions:<br>isobaricInhPa = 37 ;<br>latitude = 721 ;<br>longitude = 1440 ;<br><br>double isobaricInhPa(isobaricInhPa) ;<br>isobaricInhPa:_FillValue = NaN ;<br>isobaricInhPa:long_name = &quot;pressure&quot; ;<br>isobaricInhPa:units = &quot;hPa&quot; ;<br>isobaricInhPa:positive = &quot;down&quot; ;<br>isobaricInhPa:stored_direction = &quot;decreasing&quot; ;<br>isobaricInhPa:standard_name = &quot;air_pressure&quot; ;<br><br><br> isobaricInhPa = 1000, 975, 950, 925, 900, 875, 850, 825, 800, 775, 750, 700, <br>    650, 600, 550, 500, 450, 400, 350, 300, 250, 225, 200, 175, 150, 125, <br>    100, 70, 50, 30, 20, 10, 7, 5, 3, 2, 1 ;<br></code></pre></td></tr></table></figure>        </div>      </div>    </div>    <div class="fold">      <div class="fold-title fold-info collapsed" data-toggle="collapse" href="#collapse-5bf6db73" role="button" aria-expanded="false" aria-controls="collapse-5bf6db73">        <div class="fold-arrow">▶</div>Variables we need      </div>      <div class="fold-collapse collapse" id="collapse-5bf6db73">        <div class="fold-content">          <figure class="highlight console"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs console">float z(isobaricInhPa, latitude, longitude) ;<br>z:GRIB_units = &quot;m**2 s**-2&quot; ;<br>z:long_name = &quot;Geopotential&quot; ;<br>z:standard_name = &quot;geopotential&quot; ;<br>float r(isobaricInhPa, latitude, longitude) ;<br>r:GRIB_units = &quot;%&quot; ;<br>r:long_name = &quot;Relative humidity&quot; ;<br>r:standard_name = &quot;relative_humidity&quot; ;<br>float q(isobaricInhPa, latitude, longitude) ;<br>q:GRIB_units = &quot;kg kg**-1&quot; ;<br>q:long_name = &quot;Specific humidity&quot; ;<br>q:standard_name = &quot;specific_humidity&quot; ;<br>float t(isobaricInhPa, latitude, longitude) ;<br>t:GRIB_units = &quot;K&quot; ;<br>t:long_name = &quot;Temperature&quot; ;<br>t:standard_name = &quot;air_temperature&quot; ;<br>float u(isobaricInhPa, latitude, longitude) ;<br>u:GRIB_units = &quot;m s**-1&quot; ;<br>u:long_name = &quot;U component of wind&quot; ;<br>u:standard_name = &quot;eastward_wind&quot; ;<br>float v(isobaricInhPa, latitude, longitude) ;<br>v:GRIB_units = &quot;m s**-1&quot; ;<br>v:long_name = &quot;V component of wind&quot; ;<br>v:standard_name = &quot;northward_wind&quot; ;<br></code></pre></td></tr></table></figure>        </div>      </div>    </div><p>Below is a Python script that performs the required interpolations.</p>    <div class="fold">      <div class="fold-title fold-info collapsed" data-toggle="collapse" href="#collapse-c21ca059" role="button" aria-expanded="false" aria-controls="collapse-c21ca059">        <div class="fold-arrow">▶</div>3d_interp.py (Pressure level)      </div>      <div class="fold-collapse collapse" id="collapse-c21ca059">        <div class="fold-content">          <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/bin/python</span><br><br><span class="hljs-comment">#------------------------------------------------#</span><br><span class="hljs-comment">#Author:         wpsze</span><br><span class="hljs-comment">#Email：         wpsze</span><br><span class="hljs-comment">#date:           2025-02-04 16:31:50</span><br><span class="hljs-comment">#Version:        0.0 </span><br><span class="hljs-comment">#Description:    The purpose of the script</span><br><span class="hljs-comment">#Copyright (C)： 2025 All rights reserved</span><br><span class="hljs-comment">#------------------------------------------------#</span><br><span class="hljs-keyword">import</span> os<br><span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np<br><span class="hljs-keyword">import</span> xarray <span class="hljs-keyword">as</span> xr<br><span class="hljs-keyword">from</span> scipy.interpolate <span class="hljs-keyword">import</span> interp1d<br><br><span class="hljs-comment"># environment variable </span><br>yyyymmddhh = os.environ[<span class="hljs-string">&#x27;yyyymmddhh&#x27;</span>] <br><br><span class="hljs-comment"># Load the signal and ERA5 NetCDF files</span><br>signal_nc = xr.open_dataset(<span class="hljs-string">&#x27;signal_0p25.nc&#x27;</span>)  <span class="hljs-comment"># Replace with actual signal file path</span><br>era5_nc = xr.open_dataset(<span class="hljs-string">&#x27;ERA5-PL.nc&#x27;</span>)   <span class="hljs-comment"># Replace with actual ERA5 file path</span><br><br><span class="hljs-comment">#================ Vertical levels =======================================</span><br><span class="hljs-comment"># Vertical levels</span><br>signal_levels = signal_nc[<span class="hljs-string">&#x27;level&#x27;</span>].values/<span class="hljs-number">100</span>            <span class="hljs-comment"># Vertical levels from signal file,  lev(ncl14), convert to hPa unit</span><br>lat_signal = signal_nc[<span class="hljs-string">&#x27;lat&#x27;</span>]<br>lon_signal = signal_nc[<span class="hljs-string">&#x27;lon&#x27;</span>]<br><br><span class="hljs-comment"># Update the coordinates to reflect the new latitude order</span><br>reversed_latitude = lat_signal[::-<span class="hljs-number">1</span>]  <span class="hljs-comment"># Reverse latitude coordinates, from [-90,90] to [90,-90]</span><br><br>era5_levels = era5_nc[<span class="hljs-string">&#x27;isobaricInhPa&#x27;</span>]          <span class="hljs-comment"># Vertical levels from ERA5 file, &#x27;level&#x27; if grib_to_netcdf, &#x27;isobaricInhPa&#x27; if xarray/cfgrib</span><br><br><span class="hljs-comment"># signal:</span><br><span class="hljs-comment">#[1000.  925.  850.  700.  600.  500.  400.  300.  250.  200.  150.  100.</span><br><span class="hljs-comment">#   70.   50.]</span><br><span class="hljs-comment"># ERA5:</span><br><span class="hljs-comment">#[1000.  975.  950.  925.  900.  875.  850.  825.  800.  775.  750.  700.</span><br><span class="hljs-comment">#  650.  600.  550.  500.  450.  400.  350.  300.  250.  225.  200.  175.</span><br><span class="hljs-comment">#  150.  125.  100.   70.   50.   30.   20.   10.    7.    5.    3.    2.</span><br><span class="hljs-comment">#    1.]</span><br><span class="hljs-comment"># Only add singals to specific levels and Convert to by era5_levels[1:29]</span><br><span class="hljs-comment"># [975. 950. 925. 900. 875. 850. 825. 800. 775. 750. 700. 650. 600. 550.</span><br><span class="hljs-comment"># 500. 450. 400. 350. 300. 250. 225. 200. 175. 150. 125. 100.  70.  50.]</span><br><br><span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;CMIP6 singal levels = <span class="hljs-subst">&#123;signal_levels&#125;</span>&quot;</span>)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;era5_levels[1:29] = <span class="hljs-subst">&#123;era5_levels[<span class="hljs-number">1</span>:<span class="hljs-number">29</span>].values&#125;</span>&quot;</span>)<br><br><span class="hljs-comment">#================ Interpolation function ================================</span><br><span class="hljs-comment"># Interpolation function for vertical levels</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">vertical_interpolate</span>(<span class="hljs-params">var_3d, signal_levels, target_levels</span>):<br>    interpolated_temp = xr.DataArray(<br>        np.empty((target_levels.size, var_3d.shape[<span class="hljs-number">1</span>], var_3d.shape[<span class="hljs-number">2</span>])), <br>        dims=(<span class="hljs-string">&quot;isobaricInhPa&quot;</span>, <span class="hljs-string">&quot;latitude&quot;</span>, <span class="hljs-string">&quot;longitude&quot;</span>))<br>    interpolated_temp = interpolated_temp.assign_coords(isobaricInhPa=era5_levels.values, <br>                                                        latitude=reversed_latitude.values,<br>                                                        longitude=lon_signal.values)<br>    f = interp1d(signal_levels, var_3d[:, :, :], axis=<span class="hljs-number">0</span>, kind=<span class="hljs-string">&#x27;linear&#x27;</span>, fill_value=<span class="hljs-string">&#x27;extrapolate&#x27;</span>)<br>    interpolated_temp[:, :, :] = f(target_levels)<br>    <span class="hljs-keyword">return</span> interpolated_temp<br><br><span class="hljs-comment">#================ T air_temperature in K ================================</span><br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;=== processing: T air_temperature in K &quot;</span>)<br><br><span class="hljs-comment"># Extract variables</span><br>ta_signal = signal_nc[<span class="hljs-string">&#x27;diff_ta&#x27;</span>]    <span class="hljs-comment"># 3D temperature from signal file, diff_ta(ncl0, ncl1, ncl2)</span><br>TT_era5 = era5_nc[<span class="hljs-string">&#x27;t&#x27;</span>]              <span class="hljs-comment"># 3D temperature from ERA5 file, t(isobaricInhPa, latitude, longitude)</span><br><br><span class="hljs-comment"># Update dimensions</span><br>ta_signal = ta_signal.rename(&#123;<span class="hljs-string">&#x27;level&#x27;</span>: <span class="hljs-string">&#x27;isobaricInhPa&#x27;</span>, <span class="hljs-string">&#x27;lat&#x27;</span>: <span class="hljs-string">&#x27;latitude&#x27;</span>, <span class="hljs-string">&#x27;lon&#x27;</span>: <span class="hljs-string">&#x27;longitude&#x27;</span>&#125;)<br><br><span class="hljs-comment"># Reverse the TT data along the latitude dimension</span><br>reversed_ta_signal = ta_signal[:, ::-<span class="hljs-number">1</span>, :]  <span class="hljs-comment"># latitude is the second dimension</span><br><br><span class="hljs-comment"># Update the TT variable to use the reversed latitude</span><br>reversed_ta_signal = reversed_ta_signal.assign_coords(latitude=reversed_latitude.values, longitude=lon_signal.values)<br><br><span class="hljs-comment"># Perform vertical interpolation</span><br>interpolated_ta = vertical_interpolate(reversed_ta_signal, signal_levels, era5_levels)<br><br><span class="hljs-comment"># Define new latitude and longitude arrays for 0.25-degree grid</span><br><span class="hljs-comment"># Perform horizontal interpolation to 0.25-degree grid</span><br><span class="hljs-comment">## interpolated_ta = interpolated_ta.interp(latitude=TT_era5.coords[&#x27;latitude&#x27;].values, longitude=TT_era5.coords[&#x27;longitude&#x27;].values)</span><br><br><span class="hljs-comment"># Add signal to ERA5</span><br>era5_nc[<span class="hljs-string">&#x27;t&#x27;</span>][<span class="hljs-number">1</span>:<span class="hljs-number">29</span>,:,:] = TT_era5[<span class="hljs-number">1</span>:<span class="hljs-number">29</span>,:,:] + interpolated_ta[<span class="hljs-number">1</span>:<span class="hljs-number">29</span>,:,:]<br><br><span class="hljs-comment">#================ Relative Humidity (RH) in % ================================</span><br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;=== processing: Relative Humidity (RH) in % &quot;</span>)<br><br><span class="hljs-comment"># Extract variables</span><br>rh_signal = signal_nc[<span class="hljs-string">&#x27;diff_rh&#x27;</span>]    <span class="hljs-comment"># 3D RH from signal file, diff_ta(ncl5, ncl6, ncl7)</span><br>RH_era5 = era5_nc[<span class="hljs-string">&#x27;r&#x27;</span>]              <span class="hljs-comment"># 3D RH from ERA5 file, t(isobaricInhPa, latitude, longitude)</span><br><br><span class="hljs-comment"># Update dimensions</span><br>rh_signal = rh_signal.rename(&#123;<span class="hljs-string">&#x27;level&#x27;</span>: <span class="hljs-string">&#x27;isobaricInhPa&#x27;</span>, <span class="hljs-string">&#x27;lat&#x27;</span>: <span class="hljs-string">&#x27;latitude&#x27;</span>, <span class="hljs-string">&#x27;lon&#x27;</span>: <span class="hljs-string">&#x27;longitude&#x27;</span>&#125;)<br><br><span class="hljs-comment"># Reverse the RH data along the latitude dimension</span><br>reversed_rh_signal = rh_signal[:, ::-<span class="hljs-number">1</span>, :]  <span class="hljs-comment"># latitude is the second dimension</span><br><br><span class="hljs-comment"># Update the RH variable to use the reversed latitude</span><br>reversed_rh_signal = reversed_rh_signal.assign_coords(latitude=reversed_latitude.values, longitude=lon_signal.values)<br><br><span class="hljs-comment"># Perform vertical interpolation</span><br>interpolated_rh = vertical_interpolate(reversed_rh_signal, signal_levels, era5_levels)<br><br><span class="hljs-comment"># Define new latitude and longitude arrays for 0.25-degree grid</span><br><span class="hljs-comment"># Perform horizontal interpolation to 0.25-degree grid</span><br><span class="hljs-comment">##interpolated_rh = interpolated_rh.interp(latitude=RH_era5.coords[&#x27;latitude&#x27;].values, longitude=RH_era5.coords[&#x27;longitude&#x27;].values)</span><br><br><span class="hljs-comment"># Add signal to ERA5</span><br>era5_nc[<span class="hljs-string">&#x27;r&#x27;</span>][<span class="hljs-number">1</span>:<span class="hljs-number">29</span>,:,:] = RH_era5[<span class="hljs-number">1</span>:<span class="hljs-number">29</span>,:,:] + interpolated_rh[<span class="hljs-number">1</span>:<span class="hljs-number">29</span>,:,:]<br><br><span class="hljs-comment">#=============================================================================</span><br><br><span class="hljs-comment"># Save the result to a new NetCDF file</span><br>era5_nc.to_netcdf(<span class="hljs-string">f&#x27;new_ERA5-0p25-PL-<span class="hljs-subst">&#123;yyyymmddhh&#125;</span>.nc&#x27;</span>)<br><br><span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;Interpolation completed and saved to &#x27;interpolated_ERA5-0p25-PL-<span class="hljs-subst">&#123;yyyymmddhh&#125;</span>.nc.&quot;</span>)<br></code></pre></td></tr></table></figure>        </div>      </div>    </div>    <div class="fold">      <div class="fold-title fold-info collapsed" data-toggle="collapse" href="#collapse-98e16488" role="button" aria-expanded="false" aria-controls="collapse-98e16488">        <div class="fold-arrow">▶</div>3d_interp_with_uv.py      </div>      <div class="fold-collapse collapse" id="collapse-98e16488">        <div class="fold-content">          <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/bin/python</span><br><br><span class="hljs-comment">#------------------------------------------------#</span><br><span class="hljs-comment">#Author:         wpsze</span><br><span class="hljs-comment">#Email：         wpsze</span><br><span class="hljs-comment">#date:           2025-02-04 16:31:50</span><br><span class="hljs-comment">#Version:        0.0 </span><br><span class="hljs-comment">#Description:    The purpose of the script</span><br><span class="hljs-comment">#Copyright (C)： 2025 All rights reserved</span><br><span class="hljs-comment">#------------------------------------------------#</span><br><span class="hljs-keyword">import</span> os<br><span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np<br><span class="hljs-keyword">import</span> xarray <span class="hljs-keyword">as</span> xr<br><span class="hljs-keyword">from</span> scipy.interpolate <span class="hljs-keyword">import</span> interp1d<br><br><span class="hljs-comment"># environment variable </span><br>yyyymmddhh = os.environ[<span class="hljs-string">&#x27;yyyymmddhh&#x27;</span>] <br><br><span class="hljs-comment"># Load the signal and ERA5 NetCDF files</span><br>signal_nc = xr.open_dataset(<span class="hljs-string">&#x27;signal_0p25.nc&#x27;</span>)  <span class="hljs-comment"># Replace with actual signal file path</span><br>era5_nc = xr.open_dataset(<span class="hljs-string">f&#x27;ERA5-0p25-PL-<span class="hljs-subst">&#123;yyyymmddhh&#125;</span>.nc&#x27;</span>)   <span class="hljs-comment"># Replace with actual ERA5 file path</span><br><br><span class="hljs-comment">#================ Vertical levels =======================================</span><br><span class="hljs-comment"># Vertical levels</span><br>signal_levels = signal_nc[<span class="hljs-string">&#x27;level&#x27;</span>].values/<span class="hljs-number">100</span>            <span class="hljs-comment"># Vertical levels from signal file,  lev(ncl14), convert to hPa unit</span><br>lat_signal = signal_nc[<span class="hljs-string">&#x27;lat&#x27;</span>]<br>lon_signal = signal_nc[<span class="hljs-string">&#x27;lon&#x27;</span>]<br><br><span class="hljs-comment"># Update the coordinates to reflect the new latitude order</span><br>reversed_latitude = lat_signal[::-<span class="hljs-number">1</span>]  <span class="hljs-comment"># Reverse latitude coordinates, from [-90,90] to [90,-90]</span><br><br>era5_levels = era5_nc[<span class="hljs-string">&#x27;isobaricInhPa&#x27;</span>]          <span class="hljs-comment"># Vertical levels from ERA5 file, &#x27;level&#x27; if grib_to_netcdf, &#x27;isobaricInhPa&#x27; if xarray/cfgrib</span><br><br><span class="hljs-comment"># signal:</span><br><span class="hljs-comment">#[1000.  925.  850.  700.  600.  500.  400.  300.  250.  200.  150.  100.</span><br><span class="hljs-comment">#   70.   50.]</span><br><span class="hljs-comment"># ERA5:</span><br><span class="hljs-comment">#[1000.  975.  950.  925.  900.  875.  850.  825.  800.  775.  750.  700.</span><br><span class="hljs-comment">#  650.  600.  550.  500.  450.  400.  350.  300.  250.  225.  200.  175.</span><br><span class="hljs-comment">#  150.  125.  100.   70.   50.   30.   20.   10.    7.    5.    3.    2.</span><br><span class="hljs-comment">#    1.]</span><br><span class="hljs-comment"># Only add singals to specific levels and Convert to by era5_levels[1:29]</span><br><span class="hljs-comment"># [975. 950. 925. 900. 875. 850. 825. 800. 775. 750. 700. 650. 600. 550.</span><br><span class="hljs-comment"># 500. 450. 400. 350. 300. 250. 225. 200. 175. 150. 125. 100.  70.  50.]</span><br><br><span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;CMIP6 singal levels = <span class="hljs-subst">&#123;signal_levels&#125;</span>&quot;</span>)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;era5_levels[1:29] = <span class="hljs-subst">&#123;era5_levels[<span class="hljs-number">1</span>:<span class="hljs-number">29</span>].values&#125;</span>&quot;</span>)<br><br><span class="hljs-comment">#================ Interpolation function ================================</span><br><span class="hljs-comment"># Interpolation function for vertical levels</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">vertical_interpolate</span>(<span class="hljs-params">var_3d, signal_levels, target_levels</span>):<br>    interpolated_temp = xr.DataArray(<br>        np.empty((target_levels.size, var_3d.shape[<span class="hljs-number">1</span>], var_3d.shape[<span class="hljs-number">2</span>])), <br>        dims=(<span class="hljs-string">&quot;isobaricInhPa&quot;</span>, <span class="hljs-string">&quot;latitude&quot;</span>, <span class="hljs-string">&quot;longitude&quot;</span>))<br>    interpolated_temp = interpolated_temp.assign_coords(isobaricInhPa=era5_levels.values, <br>                                                        latitude=reversed_latitude.values,<br>                                                        longitude=lon_signal.values)<br>    f = interp1d(signal_levels, var_3d[:, :, :], axis=<span class="hljs-number">0</span>, kind=<span class="hljs-string">&#x27;linear&#x27;</span>, fill_value=<span class="hljs-string">&#x27;extrapolate&#x27;</span>)<br>    interpolated_temp[:, :, :] = f(target_levels)<br>    <span class="hljs-keyword">return</span> interpolated_temp<br><br><span class="hljs-comment">#================ T air_temperature in K ================================</span><br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;=== processing: T air_temperature in K &quot;</span>)<br><br><span class="hljs-comment"># Extract variables</span><br>ta_signal = signal_nc[<span class="hljs-string">&#x27;diff_ta&#x27;</span>]    <span class="hljs-comment"># 3D temperature from signal file, diff_ta(ncl0, ncl1, ncl2)</span><br>TT_era5 = era5_nc[<span class="hljs-string">&#x27;t&#x27;</span>]              <span class="hljs-comment"># 3D temperature from ERA5 file, t(isobaricInhPa, latitude, longitude)</span><br><br><span class="hljs-comment"># Update dimensions</span><br>ta_signal = ta_signal.rename(&#123;<span class="hljs-string">&#x27;level&#x27;</span>: <span class="hljs-string">&#x27;isobaricInhPa&#x27;</span>, <span class="hljs-string">&#x27;lat&#x27;</span>: <span class="hljs-string">&#x27;latitude&#x27;</span>, <span class="hljs-string">&#x27;lon&#x27;</span>: <span class="hljs-string">&#x27;longitude&#x27;</span>&#125;)<br><br><span class="hljs-comment"># Reverse the TT data along the latitude dimension</span><br>reversed_ta_signal = ta_signal[:, ::-<span class="hljs-number">1</span>, :]  <span class="hljs-comment"># latitude is the second dimension, # Reverse latitude coordinates, from [-90,90] to [90,-90]</span><br><br><span class="hljs-comment"># Update the TT variable to use the reversed latitude</span><br>reversed_ta_signal = reversed_ta_signal.assign_coords(latitude=reversed_latitude.values, longitude=lon_signal.values)<br><br><span class="hljs-comment"># Perform vertical interpolation</span><br>interpolated_ta = vertical_interpolate(reversed_ta_signal, signal_levels, era5_levels)<br><br><span class="hljs-comment"># Define new latitude and longitude arrays for 0.25-degree grid</span><br><span class="hljs-comment"># Perform horizontal interpolation to 0.25-degree grid</span><br><span class="hljs-comment">## interpolated_ta = interpolated_ta.interp(latitude=TT_era5.coords[&#x27;latitude&#x27;].values, longitude=TT_era5.coords[&#x27;longitude&#x27;].values)</span><br><br><span class="hljs-comment"># Add signal to ERA5</span><br>era5_nc[<span class="hljs-string">&#x27;t&#x27;</span>][<span class="hljs-number">1</span>:<span class="hljs-number">29</span>,:,:] = TT_era5[<span class="hljs-number">1</span>:<span class="hljs-number">29</span>,:,:] + interpolated_ta[<span class="hljs-number">1</span>:<span class="hljs-number">29</span>,:,:]<br><br><span class="hljs-comment">#================ Relative Humidity (RH) in % ================================</span><br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;=== processing: Relative Humidity (RH) in % &quot;</span>)<br><br><span class="hljs-comment"># Extract variables</span><br>rh_signal = signal_nc[<span class="hljs-string">&#x27;diff_rh&#x27;</span>]    <span class="hljs-comment"># 3D RH from signal file, diff_ta(ncl5, ncl6, ncl7)</span><br>RH_era5 = era5_nc[<span class="hljs-string">&#x27;r&#x27;</span>]              <span class="hljs-comment"># 3D RH from ERA5 file, t(isobaricInhPa, latitude, longitude)</span><br><br><span class="hljs-comment"># Update dimensions</span><br>rh_signal = rh_signal.rename(&#123;<span class="hljs-string">&#x27;level&#x27;</span>: <span class="hljs-string">&#x27;isobaricInhPa&#x27;</span>, <span class="hljs-string">&#x27;lat&#x27;</span>: <span class="hljs-string">&#x27;latitude&#x27;</span>, <span class="hljs-string">&#x27;lon&#x27;</span>: <span class="hljs-string">&#x27;longitude&#x27;</span>&#125;)<br><br><span class="hljs-comment"># Reverse the RH data along the latitude dimension</span><br>reversed_rh_signal = rh_signal[:, ::-<span class="hljs-number">1</span>, :]  <span class="hljs-comment"># latitude is the second dimension, # Reverse latitude coordinates, from [-90,90] to [90,-90]</span><br><br><span class="hljs-comment"># Update the RH variable to use the reversed latitude</span><br>reversed_rh_signal = reversed_rh_signal.assign_coords(latitude=reversed_latitude.values, longitude=lon_signal.values)<br><br><span class="hljs-comment"># Perform vertical interpolation</span><br>interpolated_rh = vertical_interpolate(reversed_rh_signal, signal_levels, era5_levels)<br><br><span class="hljs-comment"># Define new latitude and longitude arrays for 0.25-degree grid</span><br><span class="hljs-comment"># Perform horizontal interpolation to 0.25-degree grid</span><br><span class="hljs-comment">##interpolated_rh = interpolated_rh.interp(latitude=RH_era5.coords[&#x27;latitude&#x27;].values, longitude=RH_era5.coords[&#x27;longitude&#x27;].values)</span><br><br><span class="hljs-comment"># Add signal to ERA5</span><br>era5_nc[<span class="hljs-string">&#x27;r&#x27;</span>][<span class="hljs-number">1</span>:<span class="hljs-number">29</span>,:,:] = RH_era5[<span class="hljs-number">1</span>:<span class="hljs-number">29</span>,:,:] + interpolated_rh[<span class="hljs-number">1</span>:<span class="hljs-number">29</span>,:,:]<br><br><span class="hljs-comment">#================ u eastward_wind ================================</span><br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;=== processing: u eastward_wind (m s**-1) &quot;</span>)<br><br><span class="hljs-comment"># Extract variables</span><br>ua_signal = signal_nc[<span class="hljs-string">&#x27;diff_ua&#x27;</span>]    <span class="hljs-comment"># 3D diff_ua from signal file, diff_ua(level, latitude, longitude)</span><br>u_era5 = era5_nc[<span class="hljs-string">&#x27;u&#x27;</span>]              <span class="hljs-comment"># 3D u from ERA5 file, u(isobaricInhPa, latitude, longitude)</span><br><br><span class="hljs-comment"># Update dimensions</span><br>ua_signal = ua_signal.rename(&#123;<span class="hljs-string">&#x27;level&#x27;</span>: <span class="hljs-string">&#x27;isobaricInhPa&#x27;</span>, <span class="hljs-string">&#x27;lat&#x27;</span>: <span class="hljs-string">&#x27;latitude&#x27;</span>, <span class="hljs-string">&#x27;lon&#x27;</span>: <span class="hljs-string">&#x27;longitude&#x27;</span>&#125;)<br><br><span class="hljs-comment"># Reverse the RH data along the latitude dimension</span><br>reversed_ua_signal = ua_signal[:, ::-<span class="hljs-number">1</span>, :]  <span class="hljs-comment"># latitude is the second dimension, # Reverse latitude coordinates, from [-90,90] to [90,-90]</span><br><br><span class="hljs-comment"># Update the RH variable to use the reversed latitude</span><br>reversed_ua_signal = reversed_ua_signal.assign_coords(latitude=reversed_latitude.values, longitude=lon_signal.values)<br><br><span class="hljs-comment"># Perform vertical interpolation</span><br>interpolated_ua = vertical_interpolate(reversed_ua_signal, signal_levels, era5_levels)<br><br><span class="hljs-comment"># Define new latitude and longitude arrays for 0.25-degree grid</span><br><span class="hljs-comment"># Perform horizontal interpolation to 0.25-degree grid</span><br><span class="hljs-comment">##interpolated_rh = interpolated_rh.interp(latitude=RH_era5.coords[&#x27;latitude&#x27;].values, longitude=RH_era5.coords[&#x27;longitude&#x27;].values)</span><br><br><span class="hljs-comment"># Add signal to ERA5</span><br>era5_nc[<span class="hljs-string">&#x27;u&#x27;</span>][<span class="hljs-number">1</span>:<span class="hljs-number">29</span>,:,:] = u_era5[<span class="hljs-number">1</span>:<span class="hljs-number">29</span>,:,:] + interpolated_ua[<span class="hljs-number">1</span>:<span class="hljs-number">29</span>,:,:]<br><br><span class="hljs-comment">#================ v northward_wind ================================</span><br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;=== processing: v northward_wind (m s**-1) &quot;</span>)<br><br><span class="hljs-comment"># Extract variables</span><br>va_signal = signal_nc[<span class="hljs-string">&#x27;diff_va&#x27;</span>]    <span class="hljs-comment"># 3D diff_va from signal file, diff_va(level, latitude, longitude)</span><br>v_era5 = era5_nc[<span class="hljs-string">&#x27;v&#x27;</span>]              <span class="hljs-comment"># 3D v from ERA5 file, u(isobaricInhPa, latitude, longitude)</span><br><br><span class="hljs-comment"># Update dimensions</span><br>va_signal = va_signal.rename(&#123;<span class="hljs-string">&#x27;level&#x27;</span>: <span class="hljs-string">&#x27;isobaricInhPa&#x27;</span>, <span class="hljs-string">&#x27;lat&#x27;</span>: <span class="hljs-string">&#x27;latitude&#x27;</span>, <span class="hljs-string">&#x27;lon&#x27;</span>: <span class="hljs-string">&#x27;longitude&#x27;</span>&#125;)<br><br><span class="hljs-comment"># Reverse the RH data along the latitude dimension</span><br>reversed_va_signal = va_signal[:, ::-<span class="hljs-number">1</span>, :]  <span class="hljs-comment"># latitude is the second dimension, # Reverse latitude coordinates, from [-90,90] to [90,-90]</span><br><br><span class="hljs-comment"># Update the RH variable to use the reversed latitude</span><br>reversed_va_signal = reversed_va_signal.assign_coords(latitude=reversed_latitude.values, longitude=lon_signal.values)<br><br><span class="hljs-comment"># Perform vertical interpolation</span><br>interpolated_va = vertical_interpolate(reversed_va_signal, signal_levels, era5_levels)<br><br><span class="hljs-comment"># Define new latitude and longitude arrays for 0.25-degree grid</span><br><span class="hljs-comment"># Perform horizontal interpolation to 0.25-degree grid</span><br><span class="hljs-comment">##interpolated_rh = interpolated_rh.interp(latitude=RH_era5.coords[&#x27;latitude&#x27;].values, longitude=RH_era5.coords[&#x27;longitude&#x27;].values)</span><br><br><span class="hljs-comment"># Add signal to ERA5</span><br>era5_nc[<span class="hljs-string">&#x27;v&#x27;</span>][<span class="hljs-number">1</span>:<span class="hljs-number">29</span>,:,:] = v_era5[<span class="hljs-number">1</span>:<span class="hljs-number">29</span>,:,:] + interpolated_va[<span class="hljs-number">1</span>:<span class="hljs-number">29</span>,:,:]<br><br><span class="hljs-comment">#=============================================================================</span><br><br><span class="hljs-comment"># Save the result to a new NetCDF file</span><br>era5_nc.to_netcdf(<span class="hljs-string">f&#x27;new_ERA5-0p25-PL-<span class="hljs-subst">&#123;yyyymmddhh&#125;</span>.nc&#x27;</span>)<br><br><span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;Interpolation completed and saved to &#x27;interpolated_ERA5-0p25-PL-<span class="hljs-subst">&#123;yyyymmddhh&#125;</span>.nc.&quot;</span>)<br></code></pre></td></tr></table></figure>        </div>      </div>    </div><h3 id="explanation-of-the-code">Explanation of the Code</h3><ol type="1"><li><strong>Loading Data</strong>: The script uses <code>xarray</code> to load the signal and ERA5 NetCDF files.</li><li><strong>Vertical Interpolation</strong>: A function (<code>vertical_interpolate</code>) is defined to perform linear interpolation on the vertical levels of the temperature data.</li><li><strong>Saving the Result</strong>: The interpolated temperature data is saved to a new NetCDF file.</li></ol><h2 id="conclusion">Conclusion</h2><p>This interpolation approach allows for aligning temperature data from different datasets, which is essential for climate modeling. By accurately matching the grids of the signal and ERA5 data, we can effectively analyze and apply climate change signals in our research.</p><hr /><h1 id="converting-netcdf-files-back-to-grib-format-a-step-by-step-guide">Converting NetCDF Files back to GRIB Format: A Step-by-Step Guide</h1><h2 id="introduction-2">Introduction</h2><p>In the realm of climate data analysis, the ability to convert between different file formats is essential. While NetCDF is widely used for storing multidimensional scientific data, GRIB (Generalized Regularly-distributed Information in Binary form) is prevalent in meteorological applications. This blog will guide you through the process of converting NetCDF files back to GRIB format, ensuring you're equipped to handle various data formats in your climate studies.</p><h2 id="motivation-2">Motivation</h2><p>The motivation behind converting NetCDF files to GRIB format can stem from several factors:</p><ul><li><strong>Compatibility</strong>: Many meteorological models and tools predominantly use GRIB format. Converting your NetCDF data ensures compatibility with these systems.</li><li><strong>Efficiency</strong>: GRIB files are often more compact than their NetCDF counterparts, making them easier to store and share, especially when dealing with large datasets.</li><li><strong>Standardization</strong>: For specific applications, adhering to a standard format like GRIB can enhance data interoperability across different platforms and tools.</li></ul><h2 id="麻煩了">麻煩了</h2><p><strong>這一步真是麻煩太多了</strong></p><p>Move to <a href="https://waipangsze.github.io/2025/02/05/NWP-PGW-To-prepare-the-ERA5-GRIB-file/"><strong>NWP | PGW | To prepare the ERA5 GRIB file</strong></a></p><h2 id="verify-the-conversion-1">Verify the Conversion</h2><p>After conversion, it’s crucial to verify that the GRIB file has been created correctly. You can do this by checking the contents:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">grib_ls output_file.grib<br></code></pre></td></tr></table></figure><h2 id="verify-the-initial-condition">Verify the initial condition</h2><p>To plot the vertical profiles of the given data, we can use Python with the matplotlib library. Here's how visualize the profiles of signal_1p25, signal_0p25, diff_era5 and diff-MPAS-init.nc against the specified levels.</p>    <div class="fold">      <div class="fold-title fold-info collapsed" data-toggle="collapse" href="#collapse-4f34dce5" role="button" aria-expanded="false" aria-controls="collapse-4f34dce5">        <div class="fold-arrow">▶</div>check_plot.py      </div>      <div class="fold-collapse collapse" id="collapse-4f34dce5">        <div class="fold-content">          <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/bin/python</span><br><br><span class="hljs-comment">#------------------------------------------------#</span><br><span class="hljs-comment">#Author:         wpsze</span><br><span class="hljs-comment">#Email：         wpsze</span><br><span class="hljs-comment">#date:           2025-02-06 08:54:13</span><br><span class="hljs-comment">#Version:        0.0 </span><br><span class="hljs-comment">#Description:    The purpose of the script</span><br><span class="hljs-comment">#Copyright (C)： 2025 All rights reserved</span><br><span class="hljs-comment">#------------------------------------------------#</span><br><br><span class="hljs-keyword">import</span> xarray <span class="hljs-keyword">as</span> xr<br><span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np<br><span class="hljs-keyword">import</span> pandas <span class="hljs-keyword">as</span> pd<br><span class="hljs-keyword">import</span> matplotlib.pyplot <span class="hljs-keyword">as</span> plt<br><br>SMALL_SIZE = <span class="hljs-number">8</span><br>MEDIUM_SIZE = <span class="hljs-number">10</span><br>BIGGER_SIZE = <span class="hljs-number">24</span><br><br>plt.rcParams[<span class="hljs-string">&quot;figure.figsize&quot;</span>] = (<span class="hljs-number">10</span>,<span class="hljs-number">8</span>)<br>plt.rc(<span class="hljs-string">&#x27;font&#x27;</span>, size=BIGGER_SIZE)          <span class="hljs-comment"># controls default text sizes</span><br>plt.rc(<span class="hljs-string">&#x27;axes&#x27;</span>, titlesize=BIGGER_SIZE)     <span class="hljs-comment"># fontsize of the axes title</span><br>plt.rc(<span class="hljs-string">&#x27;axes&#x27;</span>, labelsize=BIGGER_SIZE)    <span class="hljs-comment"># fontsize of the x and y labels</span><br>plt.rc(<span class="hljs-string">&#x27;xtick&#x27;</span>, labelsize=BIGGER_SIZE)    <span class="hljs-comment"># fontsize of the tick labels</span><br>plt.rc(<span class="hljs-string">&#x27;ytick&#x27;</span>, labelsize=BIGGER_SIZE)    <span class="hljs-comment"># fontsize of the tick labels</span><br>plt.rc(<span class="hljs-string">&#x27;legend&#x27;</span>, fontsize=BIGGER_SIZE)    <span class="hljs-comment"># legend fontsize</span><br>plt.rc(<span class="hljs-string">&#x27;figure&#x27;</span>, titlesize=BIGGER_SIZE)  <span class="hljs-comment"># fontsize of the figure title</span><br><br><span class="hljs-comment">#=================================================================</span><br>yyyymmddhh = <span class="hljs-string">&quot;2022063000&quot;</span><br><br><span class="hljs-comment">#============== signal 1.25 deg =============================</span><br>dsignal = xr.open_dataset(<span class="hljs-string">&quot;signal.nc&quot;</span>)<br><br><span class="hljs-comment">#============== signal 0.25 deg =============================</span><br>dsignal_0p25 = xr.open_dataset(<span class="hljs-string">&quot;signal_0p25.nc&quot;</span>)<br><br><span class="hljs-comment">#============== SL/PL =============================</span><br>original_SL_file = xr.open_dataset(<span class="hljs-string">f&quot;ERA5-0p25-SL-<span class="hljs-subst">&#123;yyyymmddhh&#125;</span>.nc&quot;</span>)<br>new_SL_file = xr.open_dataset(<span class="hljs-string">f&quot;new_ERA5-0p25-SL-<span class="hljs-subst">&#123;yyyymmddhh&#125;</span>.nc&quot;</span>)<br><span class="hljs-comment"># original_PL_file = xr.open_dataset(f&quot;ERA5-0p25-SL-&#123;yyyymmddhh&#125;.nc&quot;)</span><br><span class="hljs-comment"># new_PL_file = xr.open_dataset(f&quot;new_ERA5-0p25-SL-&#123;yyyymmddhh&#125;.nc&quot;)</span><br>diff_PL = xr.open_dataset(<span class="hljs-string">&quot;diff_pl.nc&quot;</span>) <span class="hljs-comment"># ncdiff new_PL.nc PL.nc</span><br><br><span class="hljs-comment">#============== MPAS init.nc diff =============================</span><br>diff_init = xr.open_dataset(<span class="hljs-string">&quot;diff_init.nc&quot;</span>) <span class="hljs-comment"># ncdiff xx.nc xx.nc</span><br><br><span class="hljs-comment"># diff_init[&quot;skintemp&quot;].shape</span><br><span class="hljs-comment"># (1, 40962)</span><br><span class="hljs-comment"># diff_init[&quot;theta&quot;].shape</span><br><span class="hljs-comment"># (1, 40962, 55)</span><br><span class="hljs-comment">#============== SST &amp; SKT =============================</span><br>tmp = np.nanmean(dsignal[<span class="hljs-string">&quot;diff_ts&quot;</span>].values)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;signal diff_ts 1.25deg nanmean = <span class="hljs-subst">&#123;tmp&#125;</span>&quot;</span>)<br><br>tmp = np.nanmean(dsignal_0p25[<span class="hljs-string">&quot;diff_ts&quot;</span>].values)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;signal diff_ts 0.25deg nanmean = <span class="hljs-subst">&#123;tmp&#125;</span>&quot;</span>)<br><br>tmp = new_SL_file[<span class="hljs-string">&quot;sst&quot;</span>].values - original_SL_file[<span class="hljs-string">&quot;sst&quot;</span>].values<br><span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;diff EAR5 (future-past) SST = <span class="hljs-subst">&#123;np.nanmean(tmp)&#125;</span>&quot;</span>)<br><br>tmp = new_SL_file[<span class="hljs-string">&quot;skt&quot;</span>].values - original_SL_file[<span class="hljs-string">&quot;skt&quot;</span>].values<br><span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;diff EAR5 (future-past) SKT = <span class="hljs-subst">&#123;np.nanmean(tmp)&#125;</span>&quot;</span>)<br><br>tmp = diff_init[<span class="hljs-string">&quot;skintemp&quot;</span>]<br><span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;diff init (future-past) skintemp = <span class="hljs-subst">&#123;np.nanmean(tmp)&#125;</span>&quot;</span>)<br><span class="hljs-comment">#============== vertial =============================</span><br><span class="hljs-comment"># Extract the variable &#x27;ta&#x27; (ensure to adjust the variable name if it&#x27;s different)</span><br>ta_signal = dsignal[<span class="hljs-string">&#x27;diff_ta&#x27;</span>]<br>ta_signal_0p25 = dsignal_0p25[<span class="hljs-string">&#x27;diff_ta&#x27;</span>]<br>ta_era5 = diff_PL[<span class="hljs-string">&#x27;t&#x27;</span>]<br><br><span class="hljs-comment"># Assuming the vertical dimension is named &#x27;level&#x27; or &#x27;plev&#x27;; adjust as necessary</span><br>levels = ta_signal[<span class="hljs-string">&#x27;level&#x27;</span>].values  <span class="hljs-comment"># Adjust depending on your dimensions</span><br>levels_era5 = diff_PL[<span class="hljs-string">&#x27;isobaricInhPa&#x27;</span>].values  <span class="hljs-comment"># Adjust depending on your dimensions</span><br><br><span class="hljs-comment"># Plotting</span><br>plt.figure(figsize=(<span class="hljs-number">10</span>, <span class="hljs-number">6</span>))<br><br><span class="hljs-comment"># Plot each profile</span><br>plt.plot(ta_era5.sel(isobaricInhPa=levels_era5).mean(dim=<span class="hljs-string">&#x27;latitude&#x27;</span>).mean(dim=<span class="hljs-string">&#x27;longitude&#x27;</span>), levels_era5, label=<span class="hljs-string">&#x27;ERA5&#x27;</span>, color=<span class="hljs-string">&#x27;green&#x27;</span>, marker = <span class="hljs-string">&#x27;o&#x27;</span>)<br>plt.plot(ta_signal.sel(level=levels).mean(dim=<span class="hljs-string">&#x27;latitude&#x27;</span>).mean(dim=<span class="hljs-string">&#x27;longitude&#x27;</span>), levels/<span class="hljs-number">100</span>, label=<span class="hljs-string">&#x27;Signal&#x27;</span>, color=<span class="hljs-string">&#x27;blue&#x27;</span>, marker = <span class="hljs-string">&#x27;o&#x27;</span>)<br>plt.plot(ta_signal_0p25.sel(level=levels).mean(dim=<span class="hljs-string">&#x27;lat&#x27;</span>).mean(dim=<span class="hljs-string">&#x27;lon&#x27;</span>), levels/<span class="hljs-number">100</span>, label=<span class="hljs-string">&#x27;Signal 0.25°&#x27;</span>, color=<span class="hljs-string">&#x27;orange&#x27;</span>, marker = <span class="hljs-string">&#x27;o&#x27;</span>)<br><br><span class="hljs-comment"># Add labels and title</span><br>plt.xlabel(<span class="hljs-string">&#x27;diff Temperature (K)&#x27;</span>)  <span class="hljs-comment"># Adjust based on your variable unit</span><br>plt.ylabel(<span class="hljs-string">&#x27;Pressure Level (hPa)&#x27;</span>)  <span class="hljs-comment"># Adjust based on your vertical coordinate</span><br>plt.title(<span class="hljs-string">&#x27;Vertical Profiles of diff Temperature (ta)&#x27;</span>)<br>plt.legend()<br>plt.grid()<br>plt.gca().invert_yaxis()  <span class="hljs-comment"># Invert y-axis for pressure levels</span><br>plt.tight_layout()<br><br><span class="hljs-comment"># Show the plot</span><br><span class="hljs-comment"># plt.show()</span><br>plt.savefig(<span class="hljs-string">&quot;diff_ta.png&quot;</span>, dpi=<span class="hljs-number">300</span>)<br><br><span class="hljs-comment">#============== vertial =============================</span><br><span class="hljs-comment"># Extract the variable &#x27;ta&#x27; (ensure to adjust the variable name if it&#x27;s different)</span><br>ta_signal = dsignal[<span class="hljs-string">&#x27;diff_rh&#x27;</span>]<br>ta_signal_0p25 = dsignal_0p25[<span class="hljs-string">&#x27;diff_rh&#x27;</span>]<br>ta_era5 = diff_PL[<span class="hljs-string">&#x27;r&#x27;</span>]<br><br><span class="hljs-comment"># Assuming the vertical dimension is named &#x27;level&#x27; or &#x27;plev&#x27;; adjust as necessary</span><br>levels = ta_signal[<span class="hljs-string">&#x27;level&#x27;</span>].values  <span class="hljs-comment"># Adjust depending on your dimensions</span><br>levels_era5 = diff_PL[<span class="hljs-string">&#x27;isobaricInhPa&#x27;</span>].values  <span class="hljs-comment"># Adjust depending on your dimensions</span><br><br><span class="hljs-comment"># Plotting</span><br>plt.figure(figsize=(<span class="hljs-number">10</span>, <span class="hljs-number">6</span>))<br><br><span class="hljs-comment"># Plot each profile</span><br>plt.plot(ta_era5.sel(isobaricInhPa=levels_era5).mean(dim=<span class="hljs-string">&#x27;latitude&#x27;</span>).mean(dim=<span class="hljs-string">&#x27;longitude&#x27;</span>), levels_era5, label=<span class="hljs-string">&#x27;ERA5&#x27;</span>, color=<span class="hljs-string">&#x27;green&#x27;</span>, marker = <span class="hljs-string">&#x27;o&#x27;</span>)<br>plt.plot(ta_signal.sel(level=levels).mean(dim=<span class="hljs-string">&#x27;latitude&#x27;</span>).mean(dim=<span class="hljs-string">&#x27;longitude&#x27;</span>), levels/<span class="hljs-number">100</span>, label=<span class="hljs-string">&#x27;Signal&#x27;</span>, color=<span class="hljs-string">&#x27;blue&#x27;</span>, marker = <span class="hljs-string">&#x27;o&#x27;</span>)<br>plt.plot(ta_signal_0p25.sel(level=levels).mean(dim=<span class="hljs-string">&#x27;lat&#x27;</span>).mean(dim=<span class="hljs-string">&#x27;lon&#x27;</span>), levels/<span class="hljs-number">100</span>, label=<span class="hljs-string">&#x27;Signal 0.25°&#x27;</span>, color=<span class="hljs-string">&#x27;orange&#x27;</span>, marker = <span class="hljs-string">&#x27;o&#x27;</span>)<br><br><span class="hljs-comment"># Add labels and title</span><br>plt.xlabel(<span class="hljs-string">&#x27;diff RH (%)&#x27;</span>)  <span class="hljs-comment"># Adjust based on your variable unit</span><br>plt.ylabel(<span class="hljs-string">&#x27;Pressure Level (hPa)&#x27;</span>)  <span class="hljs-comment"># Adjust based on your vertical coordinate</span><br>plt.title(<span class="hljs-string">&#x27;Vertical Profiles of diff RH (%)&#x27;</span>)<br>plt.legend()<br>plt.grid()<br>plt.gca().invert_yaxis()  <span class="hljs-comment"># Invert y-axis for pressure levels</span><br>plt.tight_layout()<br><br><span class="hljs-comment"># Show the plot</span><br><span class="hljs-comment"># plt.show()</span><br>plt.savefig(<span class="hljs-string">&quot;diff_rh.png&quot;</span>, dpi=<span class="hljs-number">300</span>)<br><br><span class="hljs-comment">#========================================================</span><br><span class="hljs-comment"># Plotting</span><br>plt.figure(figsize=(<span class="hljs-number">10</span>, <span class="hljs-number">6</span>))<br><br><span class="hljs-comment"># Plot each profile</span><br>plt.plot(np.mean(diff_init[<span class="hljs-string">&quot;relhum&quot;</span>][<span class="hljs-number">0</span>,:,:], axis=<span class="hljs-number">0</span>), np.linspace(<span class="hljs-number">0</span>,<span class="hljs-number">54</span>,<span class="hljs-number">54</span>+<span class="hljs-number">1</span>), label=<span class="hljs-string">&#x27;MPAS-120km&#x27;</span>, color=<span class="hljs-string">&#x27;black&#x27;</span>, marker = <span class="hljs-string">&#x27;o&#x27;</span>)<br><br><span class="hljs-comment"># Add labels and title</span><br>plt.xlabel(<span class="hljs-string">&#x27;diff RH (%)&#x27;</span>)  <span class="hljs-comment"># Adjust based on your variable unit</span><br>plt.ylabel(<span class="hljs-string">&#x27;level&#x27;</span>)  <span class="hljs-comment"># Adjust based on your vertical coordinate</span><br>plt.title(<span class="hljs-string">&#x27;Vertical Profiles of diff RH (%)&#x27;</span>)<br>plt.legend()<br>plt.grid()<br>plt.tight_layout()<br><br><span class="hljs-comment"># Show the plot</span><br><span class="hljs-comment"># plt.show()</span><br>plt.savefig(<span class="hljs-string">&quot;diff_init_rh.png&quot;</span>, dpi=<span class="hljs-number">300</span>)<br></code></pre></td></tr></table></figure>        </div>      </div>    </div><h1 id="ncl-references">NCL references</h1><h1 id="discussion-summary">Discussion Summary</h1><ol type="1"><li><strong>Which Variables Can Be Used?</strong><ul><li>The selection of variables is highly dependent on the specific goals and context of the case study. Commonly utilized variables include:<ul><li><strong>Temperature (T)</strong>: Essential for understanding thermal dynamics.</li><li><strong>Relative Humidity (RH)</strong>: Important for moisture content and cloud formation.</li><li>Additional variables may include geopotential and wind components, depending on the focus of the study.</li></ul></li></ul></li><li><strong>Importing Wind Components (u, v): !!!</strong><ul><li>The decision to import wind components (u and v) should be guided by their relevance to the study. Wind data is crucial for:<ul><li>Enhancing model accuracy, especially in studies involving atmospheric dynamics.</li><li>Providing insights into transport processes and weather patterns.</li></ul></li><li><strong>The PGW method is designed to isolate the thermodynamic effects of climate change</strong> while largely preserving the historical synoptic patterns and dynamics of the atmosphere, such as the large-scale wind fields that govern tropical cyclone steering. <strong>In most PGW implementations, the future climate signal is applied to thermodynamic variables (e.g., temperature and specific humidity profiles) rather than dynamic variables like the 3D wind field</strong>. <strong>This is because altering the wind field directly could disrupt the atmospheric balance (e.g., geostrophic or hydrostatic equilibrium), leading to unrealistic adjustments in the model during the initial spin-up period</strong>. Instead, the wind fields are typically left unchanged in the initial conditions, allowing the model to dynamically adjust the winds in response to the perturbed thermodynamic state as the simulation evolves.</li><li>For tropical cyclones, the steering flow—defined as the vertically averaged environmental wind that guides the storm’s motion—is a critical factor. This flow is influenced by the large-scale circulation patterns (e.g., subtropical ridges, troughs, and jet streams), which are part of the initial and boundary conditions derived from reanalysis data (e.g., ERA-Interim or NCEP) in a control run. In a PGW simulation, the assumption is often that the future climate signal does not significantly alter these large-scale wind patterns in the initial state. <strong>Therefore, in many studies, the 3D wind field is not explicitly modified by adding a future wind signal to the initial conditions</strong>. The focus is instead on how thermodynamic changes (e.g., warmer SSTs, increased atmospheric moisture) affect cyclone intensity, structure, and potentially its track indirectly through feedback on the dynamics.</li><li><strong>If your goal is to isolate the thermodynamic effects of warming</strong> (e.g., how increased SSTs or humidity affect TC intensity), then not adding a 3D wind perturbation is standard practice. The steering flow will remain consistent with the historical case, and any changes in TC behavior will stem from thermodynamic feedbacks.</li><li><strong>If your goal</strong> is to explore how future changes in large-scale circulation might affect TC steering, then you could consider adding a 3D wind perturbation derived from GCM projections (e.g., CMIP5 or CMIP6 under a scenario like RCP8.5). <strong>However, this is less common in PGW because</strong>:<ul><li>GCMs show significant disagreement on future wind field changes, especially at regional scales relevant to TC steering.</li><li>Adding wind perturbations risks introducing imbalances that could destabilize the model unless carefully adjusted (e.g., via pressure corrections to maintain hydrostatic balance).</li><li>The steering flow’s response to climate change is often studied separately using full transient GCM simulations rather than PGW.</li></ul></li><li><strong>In practice, some PGW studies avoid wind perturbations entirely to maintain consistency with the historical storm track and focus on intensity or precipitation changes</strong>. Others might use sensitivity experiments to test the impact of hypothetical wind changes, but this is not the norm.</li></ul></li><li><strong>Interpolation Methods:</strong><ul><li><strong>Horizontal Interpolation</strong>: Bilinear interpolation is commonly used for its simplicity and effectiveness in providing smooth transitions between grid points.</li><li><strong>Vertical Interpolation</strong>: The choice between linear and logarithmic interpolation should be based on the nature of the variable being interpolated:<ul><li><strong>Linear Interpolation</strong> is suitable for most variables.</li><li><strong>Logarithmic Interpolation</strong> may be more appropriate for variables with a wide range of values, such as pressure or density.</li></ul></li></ul></li><li><strong>Consideration of Vertical Levels:</strong><ul><li>When performing vertical interpolation, it is important to consider whether to include levels such as 100 hPa. Generally:<ul><li>If the climate signal data does not extend above certain levels (e.g., 50 hPa), it is prudent to exclude those levels to avoid introducing inconsistencies into the model.</li></ul></li></ul></li><li><strong>Data Integration Formats:</strong><ul><li>The climate signal can be integrated into different formats based on the model being used:<ul><li>For <strong>ERA5</strong>, climate signals can be added to the ICBC (Initial Condition Boundary Condition) files in GRIB format.</li><li>In <strong>WRF</strong>, data may be added directly to <code>met_em</code> files, which are used for meteorological input.<ul><li>ungrib<ul><li>Extract meteorological fields from GRIB files</li></ul></li><li>metgrid<ul><li>Horizontally interpolate meteorological fields (from ungrib) to simulation grids (defined by geogrid)</li></ul></li><li>real.exe<ul><li>Initialization will calculate reference state, vertical coordinate interpolation, disturbance field calculation, output boundary conditions, surface data mask, etc.</li><li><a href="https://sites.google.com/g.ntu.edu.tw/wrf-tutorial-modules/%E6%A8%A1%E5%BC%8F%E8%A8%AD%E8%A8%88/wrf-initialization">初始化會計算 reference state ，垂直座標內插，擾動場計算，產出邊界條件，地表資料遮罩等等</a></li><li><a href="https://www2.mmm.ucar.edu/wrf/users/docs/user_guide_v4/v4.2/users_guide_chap4.html" class="uri">https://www2.mmm.ucar.edu/wrf/users/docs/user_guide_v4/v4.2/users_guide_chap4.html</a></li><li><strong>So, it is fine for adding signal into met_em because met_em only does horizontal interpolation.</strong></li></ul></li><li>wrf.exe</li></ul></li><li>For <strong>MPAS</strong>, it is no met_em step and only from <code>static.nc</code> to <code>init.nc</code>. Therefore, the only way is to add signal into ICBC=ERA5.</li></ul></li></ul></li><li><strong>Long-term Simulations:</strong><ul><li>For extended runs in both MPAS and WRF, it is essential to <strong>regularly update SST data</strong>. This practice helps maintain the relevance of the model outputs to current climate conditions, ensuring that the simulations reflect the most recent data and improving the accuracy of long-term forecasts.</li></ul></li></ol><div class="note note-primary">            <p>Read <strong><a href="https://waipangsze.github.io/2025/02/14/MPAS-ERA5-Update-SST-and-sea-ice-fraction/">MPAS | ERA5| Update SST and sea-ice fraction</a></strong></p>          </div><p>Integrating and interpolating climate variables in models like WRF and MPAS involves careful consideration of the variables used, the methods of interpolation, and the formats for data integration. By addressing these factors, researchers can enhance the accuracy and reliability of climate and weather predictions. Proper handling of SST and other variables in both short-term and long-term simulations is crucial for effective climate modeling and analysis.</p><hr /><h1 id="references">References</h1><ol type="1"><li><a href="https://code.mpimet.mpg.de/projects/cdo/wiki/tutorial#Basic-Usage">Climate Data Operators (CDO) Tutorial (<strong>recommend</strong>)</a></li><li><a href="https://github.com/ecmwf/cfgrib/issues/289">failed to set key 'endStep' in to_grib</a></li><li><a href="https://github.com/ecmwf/cfgrib/issues/18">Add support to write a xarray.Dataset to a GRIB file.</a><ol type="1"><li>cfgrib.to_grib(ds, 'User_Guide_Example_Data_from_cfgrib.grib')#, grib_keys={'centre': 'ecmf'})</li><li><code>cfgrib/xarray_to_grib.py:252: FutureWarning: GRIB write support is experimental, DO NOT RELY ON IT!</code></li></ol></li><li><a href="https://code.mpimet.mpg.de/boards/1/topics/2907">Converting NetCDF to GRIB | 2014</a><ol type="1"><li><code>cdo -v -f grb -copy sstatlantic_addhifreq.nc ofile.grb</code><ol type="1"><li><code>cdo -v -f grb2 -copy sstatlantic_addhifreq.nc ofile.grb</code> if grib2 format.</li></ol></li><li>The large GRIB file has data with 2602x1402=3648004 grid points. CDO stores netCDF double precision floats to 24bit packed GRIB per default. The result is a GRIB record with 10944120 bytes. The max. record length in the GRIB1 standard is 8388607 bytes. <strong>CDO uses the ECMWF extension of the GRIB1 standard for larger GRIB records</strong>. These large GRIB records can only be read by CDO or tools from the ECMWF.</li><li>You can create a 16bit GRIB record to reduce the record size:<ol type="1"><li><code>cdo -b 16 -f grb copy file.nc file.grb</code></li></ol></li></ol></li><li>Due to the fact that the NetCDF data model is much more free and extensible than the GRIB one, it is not possible to write a generic xarray.Dataset to a GRIB file. The aim for cfgrib is to implement write support for a subset of carefully crafted datasets that fit the GRIB data model. In particular the only coordinates that we target at the moment are the one returned by opening a GRIB with the cfgrib flavour of cfgrib.open_dataset, namely:number, time, step, a vertical coordinate (isobaricInhPa, heightAboveGround, surface, etc), and the horizontal coordinates (for example latitude and longitude for a regular_ll grid type).</li></ol>]]></content>
    
    
    <categories>
      
      <category>NWP</category>
      
    </categories>
    
    
    <tags>
      
      <tag>NWP</tag>
      
      <tag>WRF</tag>
      
      <tag>MPAS</tag>
      
      <tag>ERA5</tag>
      
      <tag>PGW</tag>
      
      <tag>GFS</tag>
      
      <tag>GRIB</tag>
      
      <tag>NetCDF</tag>
      
      <tag>CMIP6</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Maths | 黎曼猜想/解析延拓/素數計數函數</title>
    <link href="/2025/02/01/Maths-Riemann-Hypothesis-Analytic-Continuation-Prime-Number-Counting-Function/"/>
    <url>/2025/02/01/Maths-Riemann-Hypothesis-Analytic-Continuation-Prime-Number-Counting-Function/</url>
    
    <content type="html"><![CDATA[<h1 id="euler-product-formula">Euler Product Formula</h1><p>The <strong>Euler product formula</strong> is a significant result in number theory that <em>connects the Riemann zeta function to prime numbers</em>. It states that the Riemann zeta function can be expressed both as an infinite series and as an infinite product over all prime numbers:</p><p><span class="math display">\[\zeta(s) = \sum_{n=1}^{\infty} \frac{1}{n^s} = \prod_{p \text{ prime}} \frac{1}{1 - p^{-s}}\]</span></p><ul><li><p><strong>Left Side</strong>: The left-hand side represents the Riemann zeta function, which is defined for complex numbers <span class="math inline">\(s\)</span> with a real part greater than 1. This series converges for those values of <span class="math inline">\(s\)</span>.</p></li><li><p><strong>Right Side</strong>: The right-hand side is the product over all prime numbers <span class="math inline">\(p\)</span>, where each term <span class="math inline">\(\frac{1}{1 - p^{-s}}\)</span> can be expanded into a geometric series. This formulation highlights the deep connection between prime numbers and the distribution of integers.</p></li></ul><h2 id="historical-context">Historical Context</h2><p><strong>Leonhard Euler first proved this formula in his work Variae observationes circa series infinitas in 1737</strong>, demonstrating how the zeta function encapsulates properties of prime numbers. The proof uses basic algebraic manipulations and the concept of multiplicative functions, showcasing the relationship between the sum of reciprocals of integers raised to a power and the product over primes.</p><h1 id="riemann-hypothesis">Riemann Hypothesis</h1><p>The <strong>Riemann Hypothesis</strong> is one of the most famous unsolved problems in mathematics, originally conjectured by Bernhard Riemann in 1859. It posits that all non-trivial zeros of the Riemann zeta function lie on a specific line in the complex plane known as the <strong>critical line</strong>, defined by:</p><p><span class="math display">\[\text{Re}(s) = \frac{1}{2}\]</span></p><h2 id="details-of-the-hypothesis">Details of the Hypothesis</h2><ul><li><p><strong>Trivial Zeros</strong>: The zeta function has trivial zeros at negative even integers (e.g., -2, -4, -6,...).</p></li><li><p><strong>Non-Trivial Zeros</strong>: The hypothesis asserts that all non-trivial zeros (those not at negative even integers) are located within a critical strip defined by <span class="math inline">\(0 &lt; \text{Re}(s) &lt; 1\)</span>, specifically on the line where <span class="math inline">\(\text{Re}(s) = \frac{1}{2}\)</span>.</p></li></ul><h1 id="黎曼猜想riemann-hypothesis">黎曼猜想（Riemann Hypothesis）</h1><p>黎曼猜想（Riemann Hypothesis）是數學中最重要和最著名的未解問題之一。黎曼猜想是由德國數學家波恩哈德·黎曼於1859年提出的。它與素數的分佈密切相關，特別是與素數計數函數（π(x)）的性質有關。</p><h2 id="黎曼猜想">1. 黎曼猜想</h2><p>黎曼猜想聲稱，所有非平凡的黎曼ζ函數的零點都位於複數平面上，實部為 1/2 的直線上，即 <span class="math inline">\(\frac{1}{2} + it\)</span> 的形式，其中 <span class="math inline">\(t\)</span> 是實數。</p><h2 id="解析延拓-analytic-continuation">2. 解析延拓 (analytic continuation)</h2><p>黎曼ζ函數最初是對於實部大於 1 的數進行定義的，然後通過解析延拓（<a href="https://en.wikipedia.org/wiki/Analytic_continuation">analytic continuation</a>）擴展到其他區域。這種延拓使得ζ函數在整個複數平面上（除了 <span class="math inline">\(s = 1\)</span> 的極點）都具有良好的性質。</p><h2 id="素數質數計數函數">3. 素數(質數)計數函數</h2><p>素數計數函數 <span class="math inline">\(\pi(x)\)</span> 定義為小於或等於 <span class="math inline">\(x\)</span> 的素數的數量。黎曼猜想的正確性與素數的分佈密切相關，特別是它預測了素數的分佈模式。(例如 <span class="math inline">\(\pi(10) = 4\)</span>，因為不超過10 的素數有 2, 3, 5, 7 。)</p><p><img src="https://upload.wikimedia.org/wikipedia/commons/thumb/d/dc/PrimePi.svg/800px-PrimePi.svg.png" width="400" /></p><p>Of great interest in number theory is the growth rate of the prime-counting function. It was conjectured in the end of the 18th century by <strong>Gauss</strong> and by <strong>Legendre</strong> to be approximately</p><p><span class="math display">\[\begin{align}\lim_{x\rightarrow\infty} \frac{\pi(x)}{x/\log x}=1 \\\lim_{x\rightarrow\infty}\frac{\pi(x)}{\operatorname{li}(x)} = 1\end{align}\]</span></p><p>This statement is the prime number theorem and its equivalent statement where <span class="math inline">\(li\)</span> is the <strong>logarithmic integral function</strong>. The prime number theorem was first proved in 1896 by Jacques Hadamard and by Charles de la Vallée Poussin independently, using properties of the Riemann zeta function introduced by Riemann in 1859. Proofs of the prime number theorem not using the zeta function or complex analysis were found around 1948 by Atle Selberg and by Paul Erdős (for the most part independently).</p><h3 id="more-precise-estimates">More precise estimates</h3><p>In 1899, de la Vallée Poussin proved that (for some positive constant <span class="math inline">\(a\)</span>) <span class="math display">\[\pi(x) = \operatorname{li} (x) + O \left(x e^{-a\sqrt{\log x}}\right) \quad\text{as } x \to \infty \]</span></p><p>In 2002, Kevin Ford proved that, <span class="math display">\[\pi(x) = \operatorname{li} (x) + O \left(x \exp \left( -0.2098(\log x)^{3/5} (\log \log x)^{-1/5} \right) \right)\]</span></p><p>Mossinghoff and Trudgian proved an explicit upper bound for the difference between <span class="math inline">\(\pi(x)\)</span> and <span class="math inline">\(li(x)\)</span>, <span class="math display">\[\bigl| \pi(x) - \operatorname{li}(x) \bigr| \le 0.2593 \frac{x}{(\log x)^{3/4}} \exp \left( -\sqrt{ \frac{\log x}{6.315} } \right) \quad \text{for } x \ge 229\]</span></p><p><img src="https://www.changhai.org/articles/science/mathematics/riemann_hypothesis/images/prime_dist.gif" width="400" /></p><p>現在有沒有一個公式可以比質數定理更精確地描述質數的分配呢？</p><h3 id="exact-form">Exact form !!!</h3><p>For <span class="math inline">\(x &gt; 1\)</span>, let <span class="math inline">\(\pi_0(x) = \pi(x) - \frac{1}{2}\)</span> when <span class="math inline">\(x\)</span> is a prime number, and <span class="math inline">\(\pi_0(x) = \pi(x)\)</span> otherwise. <strong>Bernhard Riemann, in his work On the Number of Primes Less Than a Given Magnitude</strong>, proved that <span class="math inline">\(\pi_0(x)\)</span> is equal to</p><p><span class="math display">\[\pi_0(x)=R(x)-\sum_{\rho} R(x^{\rho}),\]</span> where <span class="math inline">\(R(x)=\sum_{n=1}^{\infty} \frac{\mu(n)}{n}\text{ li}\left(x^{1/n}\right)\)</span>,</p><p><span class="math inline">\(\mu(n)\)</span> is the <strong>Möbius function</strong>, <span class="math inline">\(\text{li}(x)\)</span> is the <strong>logarithmic integral function</strong>, <span class="math inline">\(\rho\)</span> indexes <strong>every zero of the Riemann zeta function</strong>, and <span class="math inline">\(\text{li}(x^\rho)\)</span> is not evaluated with a branch cut but instead considered as Ei<span class="math inline">\((\frac{\rho}{n}\log x)\)</span> where Ei<span class="math inline">\((x)\)</span> is the <strong>exponential integral</strong>. If the trivial zeros are collected and the sum is taken only over the non-trivial zeros <span class="math inline">\(\rho\)</span> of the Riemann zeta function, then <span class="math inline">\(\pi_0(x)\)</span> may be approximated.</p><p><span class="math display">\[\pi_0(x)\approx R(x)-\sum_{\rho} R(x^{\rho})-\frac{1}{\log x}+\frac{1}{\pi}\arctan\frac{\pi}{\log x}\]</span></p><p>The Riemann hypothesis suggests that every such non-trivial zero lies along <span class="math inline">\(Re(s) = \frac{1}{2}\)</span>.</p><p>這樣，我們可以說，如果我們知道了黎曼zeta函數的所有非平凡零點的精確位置，那麼就有了計算素數計數函數的精確公式。</p><figure><img src="https://upload.wikimedia.org/wikipedia/commons/8/89/Riemann_Explicit_Formula.gif" alt="Riemann&#39;s explicit formula using the first 200 non-trivial zeros of the zeta function" width="400" /><figcaption>Riemann's explicit formula using the first 200 non-trivial zeros of the zeta function</figcaption></figure><h2 id="對數積分函數">4. 對數積分函數</h2><p>The logarithmic integral has an integral representation defined for all positive real number <span class="math inline">\(x \neq 1\)</span>, <span class="math display">\[\operatorname{li}(x) = \int_0^x \frac{dt}{\ln t}\]</span></p><p><span class="math display">\[\operatorname{li}(x) = \lim_{\varepsilon \to 0+} \left( \int_0^{1-\varepsilon} \frac{dt}{\ln t} + \int_{1+\varepsilon}^x \frac{dt}{\ln t} \right)\]</span></p><p><img src="https://upload.wikimedia.org/wikipedia/commons/thumb/a/ad/Logarithmic_integral_function.svg/2880px-Logarithmic_integral_function.svg.png" width="400" /></p><p>對數積分函數 (The offset logarithmic integral or Eulerian logarithmic integral)定義為： <span class="math display">\[\text{Li}(x) = \int_2^x \frac{dt}{\ln t} = \operatorname{li}(x) - \operatorname{li}(2)\]</span> 這個積分從 2 開始，因為我們在考慮素數的時候，1 不是素數，而 <span class="math inline">\(\log t\)</span> 是自然對數。</p><ul><li><span class="math inline">\(\text{Li}(x)\)</span> 是一個單調遞增的函數，隨著 <span class="math inline">\(x\)</span> 的增大，<span class="math inline">\(\text{Li}(x)\)</span> 會增大。</li><li>根據素數定理，對於大 <span class="math inline">\(x\)</span>，素數計數函數 <span class="math inline">\(\pi(x)\)</span> 和對數積分函數之間的關係可以用漸近公式來表示： <span class="math display">\[\pi(x) \sim \text{Li}(x) \text{（對於大 } x\text{）}\]</span> 這意味著當 <span class="math inline">\(x\)</span> 趨近於無限大時，<span class="math inline">\(\pi(x)\)</span> 和 <span class="math inline">\(\text{Li}(x)\)</span> 之間的比值趨近於 1。</li></ul><p><span class="math display">\[\Pi_0(x) = \operatorname{li}(x) - \sum_\rho \operatorname{li}(x^\rho) -\log 2 + \int_x^\infty\frac{dt}{t(t^2-1) \log t}\]</span></p><h1 id="videos">Videos</h1><iframe width="560" height="315" src="https://www.youtube.com/embed/T93SayXhw2w" title="1+2+3+4+...=-1/12 ？李永樂老師講黎曼猜想（1）" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen></iframe><iframe width="560" height="315" src="https://www.youtube.com/embed/4vbcC4TcMGc" title="質數有多重要？數學家歐拉和高斯是如何研究質數的 ？李永樂老師講黎曼猜想（2）" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen></iframe><iframe width="560" height="315" src="https://www.youtube.com/embed/NeoDdnSlRjk" title="懸賞100萬美元的“黎曼猜想”有多難？李永樂老師講什麽是黎曼猜想（3）" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen></iframe><iframe width="560" height="315" src="https://www.youtube.com/embed/Y86kfiVEXd4" title="朗道-西格爾零點是什麼？張益唐證明了黎曼猜想嗎？" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen></iframe><iframe width="560" height="315" src="https://www.youtube.com/embed/sD0NjbwqlYw" title="But what is the Riemann zeta function? Visualizing analytic continuation" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen></iframe><h1 id="references">References</h1><ol type="1"><li><a href="https://en.wikipedia.org/wiki/On_the_Number_of_Primes_Less_Than_a_Given_Magnitude">On the Number of Primes Less Than a Given Magnitude</a><ol type="1"><li><img src="https://upload.wikimedia.org/wikipedia/commons/thumb/c/cb/Ueber_die_Anzahl_der_Primzahlen_unter_einer_gegebenen_Gr%C3%B6sse.pdf/page1-718px-Ueber_die_Anzahl_der_Primzahlen_unter_einer_gegebenen_Gr%C3%B6sse.pdf.jpg" alt="Bernhard Riemann&#39;s article concerning the number of primes that are less than a given magnitude." width="200" /></li></ol></li><li><a href="https://charlesliuyx.github.io/2018/09/20/%E3%80%90%E7%9B%B4%E8%A7%82%E8%AF%A6%E8%A7%A3%E3%80%91%E9%80%9A%E4%BF%97%E6%98%93%E6%87%82%E4%BA%86%E8%A7%A3%E4%BB%80%E4%B9%88%E6%98%AF%E9%BB%8E%E6%9B%BC%E7%8C%9C%E6%83%B3/">【直观详解】通俗易懂了解什么是黎曼猜 | 2018</a></li><li><a href="https://www.changhai.org/articles/science/mathematics/riemann_hypothesis/">Riemann 猜想漫谈 | 卢昌海 (<strong>推薦</strong>)</a></li><li><a href="https://pansci.asia/archives/147956">數學界的聖杯「黎曼猜想證明」，是否已被人類得手？|2018</a></li></ol>]]></content>
    
    
    <categories>
      
      <category>Maths</category>
      
    </categories>
    
    
    <tags>
      
      <tag>NWP</tag>
      
      <tag>AI</tag>
      
      <tag>ML</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ML | Ollama</title>
    <link href="/2025/01/30/ML-Ollama/"/>
    <url>/2025/01/30/ML-Ollama/</url>
    
    <content type="html"><![CDATA[<h1 id="ollama">Ollama</h1><p>Ollama是一個開源工具，旨在直接在<strong>本地機器上運行大型語言模型（LLMs）</strong>，增強用戶的隱私和性能。它使開發者、研究人員和企業能夠利用強大的人工智能模型，<strong>而無需依賴基於雲的解決方案</strong>，從而保持對數據的完全控制並降低與外部伺服器相關的潛在安全風險。</p><h2 id="ollama的主要特點">Ollama的主要特點</h2><ul><li><p><strong>本地執行</strong>：Ollama使得在本地執行LLMs成為可能，這減輕了隱私問題並增強了數據安全性。這意味著用戶不需要將敏感信息上傳到雲端，確保所有處理都在其設備上進行。</p></li><li><p><strong>廣泛的模型庫</strong>：該平台支持多種預訓練模型，包括流行的LLaMA 2和Code Llama。用戶可以輕鬆選擇適合特定任務的模型，確保人工智能應用的多樣性。</p></li><li><p><strong>自定義和微調</strong>：Ollama允許用戶根據需求自定義和微調語言模型，包括提示工程和少量學習，使輸出更符合用戶目標。</p></li><li><p><strong>無縫集成</strong>：該工具與各種編程語言和框架良好集成，使開發者能夠輕鬆將LLMs納入其項目中。</p></li><li><p><strong>無使用限制</strong>：與許多在線人工智能服務施加使用上限不同，Ollama不限制生成文本的量，為用戶提供了更大的靈活性。</p></li></ul><h2 id="ollama的應用">Ollama的應用</h2><p>Ollama可以在多個領域中使用，包括：</p><ul><li><strong>聊天機器人和虛擬助手</strong>：通過智能自動回應增強客戶服務體驗。</li><li><strong>代碼生成和輔助</strong>：通過生成代碼片段或提供調試幫助來簡化開發工作流程。</li><li><strong>自然語言處理</strong>：促進翻譯、摘要和內容生成等任務。</li><li><strong>研究和知識發現</strong>：分析大型數據集以提取見解或生成假設。</li></ul><p>總之，Ollama是一個強大的本地運行LLMs的工具，在隱私、性能和自定義方面提供顯著優勢。它能夠在不依賴雲基礎設施的情況下運作，使其對於關心數據安全的人士在使用先進人工智能技術時特別具吸引力。</p><p>Ollama is a popular open-source command-line tool and engine that allows you to download quantized versions of the most popular LLM chat models.</p><p>Ollama is a <strong>separate</strong> application that you need to download first and connect to. <strong>Ollama supports both running LLMs on CPU and GPU</strong>.</p><h1 id="本地部署">本地部署</h1><h2 id="ollama-1">Ollama</h2><p>我們可以透過Ollama來進行安裝</p><ul><li>Ollama 官方版：<a href="https://ollama.com/" class="uri">https://ollama.com/</a><ul><li>Mac<ul><li><strong>Apple Silicon 可用</strong></li><li>如果是 Mac, 下載後解開執行，簡單照著指示放到應用程式即可。<strong>雖然是應用程式，不過實際要跑模型的時候是用命令列</strong></li></ul></li><li>Linux<ul><li><code>curl -fsSL https://ollama.com/install.sh | sh</code> # Need <code>sudo</code> priviledge</li><li><a href="https://github.com/ollama/ollama/issues/2111">Enable installation without root priviledge</a><ul><li><a href="https://github.com/ollama/ollama/releases" class="uri">https://github.com/ollama/ollama/releases</a> &amp; e.g. `wget https://github.com/ollama/ollama/releases/download/v0.5.7/ollama-linux-amd64.tgz'<ul><li><strong>ollama-linux-amd64.tgz</strong></li></ul></li><li><code>./ollama serve &amp;</code><ul><li><code>source=routes.go:1238 msg="Listening on 127.0.0.1:11434 (version 0.5.7)"</code></li></ul></li><li><code>./ollama run llama2</code></li><li>The model is stored on <code>$HOME/.ollama</code></li></ul></li></ul></li><li>Ollama 是一個開源軟體，讓使用者可以在自己的硬體上運行、創建和分享大型語言模型服務。這個平台適合希望在本地端運行模型的使用者，因為它不僅可以保護隱私，還允許用戶透過命令行介面輕鬆地設置和互動。Ollama 支援包括 Llama 2 和 Mistral 等多種模型，並提供彈性的客製化選項，例如從其他格式導入模型並設置運行參數。</li></ul></li><li>Web UI 控制端: <a href="https://chromewebstore.google.com/detail/page-assist-%E6%9C%AC%E5%9C%B0-ai-%E6%A8%A1%E5%9E%8B%E7%9A%84-web/jfgfiigpkhlkbnfnbobbkinehhfdhndo">Page Assist - A Web UI for Local AI Models | Chrome Extension</a></li></ul><div class="group-image-container"><div class="group-image-row"><div class="group-image-wrap"><img src="https://i.imgur.com/yycohCi.png" /></div><div class="group-image-wrap"><img src="https://i.imgur.com/qLGkr7T.png" /></div><div class="group-image-wrap"><img src="https://i.imgur.com/EhgPLta.png" /></div></div><div class="group-image-row"><div class="group-image-wrap"><img src="https://i.imgur.com/9Px50B2.png" /></div><div class="group-image-wrap"><img src="https://i.imgur.com/3ki4mkk.png" /></div><div class="group-image-wrap"><img src="https://i.imgur.com/W9MzN7v.png" /></div></div></div><figure class="highlight console"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs console"><span class="hljs-meta prompt_"> $ </span><span class="language-bash">./ollama --<span class="hljs-built_in">help</span></span><br>Large language model runner<br><br>Usage:<br>  ollama [flags]<br>  ollama [command]<br><br>Available Commands:<br>  serve       Start ollama<br>  create      Create a model from a Modelfile<br>  show        Show information for a model<br>  run         Run a model<br>  stop        Stop a running model<br>  pull        Pull a model from a registry<br>  push        Push a model to a registry<br>  list        List models<br>  ps          List running models<br>  cp          Copy a model<br>  rm          Remove a model<br>  help        Help about any command<br><br>Flags:<br>  -h, --help      help for ollama<br>  -v, --version   Show version information<br><br>Use &quot;ollama [command] --help&quot; for more information about a command.<br></code></pre></td></tr></table></figure>    <div class="fold">      <div class="fold-title fold-info collapsed" data-toggle="collapse" href="#collapse-dcdac752" role="button" aria-expanded="false" aria-controls="collapse-dcdac752">        <div class="fold-arrow">▶</div>ollama Commands      </div>      <div class="fold-collapse collapse" id="collapse-dcdac752">        <div class="fold-content">          <figure class="highlight console"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs console"><span class="hljs-meta prompt_"> $ </span><span class="language-bash">./ollama list</span><br>[GIN] 2025/02/04 - 10:53:10 | 200 |      171.11µs |       127.0.0.1 | HEAD     &quot;/&quot;<br>[GIN] 2025/02/04 - 10:53:11 | 200 |    43.04762ms |       127.0.0.1 | GET      &quot;/api/tags&quot;<br>NAME           ID              SIZE      MODIFIED      <br>llama3.2:1b    baf6a787fdff    1.3 GB    3 minutes ago <br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"> $ </span><span class="language-bash">./ollama show llama3.2:1b</span><br>[GIN] 2025/02/04 - 10:53:25 | 200 |      60.457µs |       127.0.0.1 | HEAD     &quot;/&quot;<br>[GIN] 2025/02/04 - 10:53:25 | 200 |   99.470023ms |       127.0.0.1 | POST     &quot;/api/show&quot;<br>  Model<br>    architecture        llama     <br>    parameters          1.2B      <br>    context length      131072    <br>    embedding length    2048      <br>    quantization        Q8_0      <br><br>  License<br>    LLAMA 3.2 COMMUNITY LICENSE AGREEMENT                 <br>    Llama 3.2 Version Release Date: September 25, 2024    <br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"> $ </span><span class="language-bash">./ollama ps</span><br>[GIN] 2025/02/04 - 10:53:58 | 200 |      75.923µs |       127.0.0.1 | HEAD     &quot;/&quot;<br>[GIN] 2025/02/04 - 10:53:58 | 200 |     303.327µs |       127.0.0.1 | GET      &quot;/api/ps&quot;<br>NAME           ID              SIZE      PROCESSOR    UNTIL               <br>llama3.2:1b    baf6a787fdff    2.2 GB    100% CPU     58 seconds from now  <br></code></pre></td></tr></table></figure>        </div>      </div>    </div>    <div class="fold">      <div class="fold-title fold-info collapsed" data-toggle="collapse" href="#collapse-6ae3e036" role="button" aria-expanded="false" aria-controls="collapse-6ae3e036">        <div class="fold-arrow">▶</div>ollama help serve      </div>      <div class="fold-collapse collapse" id="collapse-6ae3e036">        <div class="fold-content">          <figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs livecodeserver"> $ ./ollama help serve<br>Start ollama<br><br>Usage:<br>  ollama serve [flags]<br><br>Aliases:<br>  serve, <span class="hljs-built_in">start</span><br><br>Flags:<br>  -h, <span class="hljs-comment">--help   help for serve</span><br><br>Environment Variables:<br>      OLLAMA_DEBUG               Show additional debug information (e.g. OLLAMA_DEBUG=<span class="hljs-number">1</span>)<br>      OLLAMA_HOST                IP Address <span class="hljs-keyword">for</span> <span class="hljs-keyword">the</span> ollama server (default <span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span>:<span class="hljs-number">11434</span>)<br>      OLLAMA_KEEP_ALIVE          The duration that models stay loaded <span class="hljs-keyword">in</span> memory (default <span class="hljs-string">&quot;5m&quot;</span>)<br>      OLLAMA_MAX_LOADED_MODELS   Maximum <span class="hljs-built_in">number</span> <span class="hljs-keyword">of</span> loaded models per GPU<br>      OLLAMA_MAX_QUEUE           Maximum <span class="hljs-built_in">number</span> <span class="hljs-keyword">of</span> queued requests<br>      OLLAMA_MODELS              The path <span class="hljs-built_in">to</span> <span class="hljs-keyword">the</span> models <span class="hljs-built_in">directory</span><br>      OLLAMA_NUM_PARALLEL        Maximum <span class="hljs-built_in">number</span> <span class="hljs-keyword">of</span> parallel requests<br>      OLLAMA_NOPRUNE             Do <span class="hljs-keyword">not</span> prune model blobs <span class="hljs-keyword">on</span> <span class="hljs-title">startup</span><br>      OLLAMA_ORIGINS             A <span class="hljs-literal">comma</span> separated list <span class="hljs-keyword">of</span> allowed origins<br>      OLLAMA_SCHED_SPREAD        Always schedule model across all GPUs<br>                                 <br>      OLLAMA_FLASH_ATTENTION     Enabled flash attention<br>      OLLAMA_KV_CACHE_TYPE       Quantization type <span class="hljs-keyword">for</span> <span class="hljs-keyword">the</span> K/V cache (default: f16)<br>      OLLAMA_LLM_LIBRARY         Set LLM library <span class="hljs-built_in">to</span> bypass autodetection<br>      OLLAMA_GPU_OVERHEAD        Reserve <span class="hljs-keyword">a</span> portion <span class="hljs-keyword">of</span> VRAM per GPU (<span class="hljs-keyword">bytes</span>)<br>      OLLAMA_LOAD_TIMEOUT        How <span class="hljs-keyword">long</span> <span class="hljs-built_in">to</span> allow model loads <span class="hljs-built_in">to</span> stall <span class="hljs-keyword">before</span> giving up (default <span class="hljs-string">&quot;5m&quot;</span>)<br></code></pre></td></tr></table></figure>        </div>      </div>    </div><h2 id="ollama-where-is-model-stored">ollama where is model stored</h2><ul><li>macOS: <code>~/.ollama/models</code></li><li>Linux: <code>/usr/share/ollama/.ollama/models</code></li><li>Windows: <code>C:\Users&lt;username&gt;.ollama\models</code></li></ul><figure class="highlight console"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs console"><span class="hljs-meta prompt_">$ </span><span class="language-bash"><span class="hljs-built_in">ls</span> ~/.ollama</span><br>history        id_ed25519     id_ed25519.pub logs           models<br><br>[~/.ollama/models]$ du -sh ./*<br> 39G./blobs<br> 24K./manifests<br></code></pre></td></tr></table></figure><h2 id="webui">WebUI</h2><ol type="1"><li>Web UI 控制端: <a href="https://chromewebstore.google.com/detail/page-assist-%E6%9C%AC%E5%9C%B0-ai-%E6%A8%A1%E5%9E%8B%E7%9A%84-web/jfgfiigpkhlkbnfnbobbkinehhfdhndo">Page Assist - A Web UI for Local AI Models | Chrome Extension</a></li><li><a href="https://github.com/open-webui/open-webui">Open WebUI</a><ol type="1"><li><code>micromamba install python=3.11</code></li><li><code>pip install open-webui</code></li><li><code>open-webui serve</code> # you can access at <a href="http://localhost:8080" class="uri">http://localhost:8080</a></li></ol></li></ol>    <div class="fold">      <div class="fold-title fold-info collapsed" data-toggle="collapse" href="#collapse-05eef982" role="button" aria-expanded="false" aria-controls="collapse-05eef982">        <div class="fold-arrow">▶</div>open-webui serve      </div>      <div class="fold-collapse collapse" id="collapse-05eef982">        <div class="fold-content">          <figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs gherkin">INFO  [open_webui.env] Embedding model set: sentence-transformers/all-MiniLM-L6-v2<br>WARNI [langchain_community.utils.user_agent] USER_AGENT environment variable not set, consider setting it to identify your requests.<br><br>  ___                    __        __   _     _   _ ___<br> / _ \ _ __   ___ _ __   \ \      / /__|<span class="hljs-string"> </span>|<span class="hljs-string">__ </span>|<span class="hljs-string"> </span>|<span class="hljs-string"> </span>|<span class="hljs-string"> </span>|<span class="hljs-string">_ _</span>|<br>|<span class="hljs-string"> </span>|<span class="hljs-string"> </span>|<span class="hljs-string"> </span>|<span class="hljs-string"> &#x27;_ \ / _ \ &#x27;_ \   \ \ /\ / / _ \ &#x27;_ \</span>|<span class="hljs-string"> </span>|<span class="hljs-string"> </span>|<span class="hljs-string"> </span>||<span class="hljs-string"> </span>|<br>|<span class="hljs-string"> </span>|<span class="hljs-string">_</span>|<span class="hljs-string"> </span>|<span class="hljs-string"> </span>|<span class="hljs-string">_) </span>|<span class="hljs-string">  __/ </span>|<span class="hljs-string"> </span>|<span class="hljs-string"> </span>|<span class="hljs-string">   \ V  V /  __/ </span>|<span class="hljs-string">_) </span>|<span class="hljs-string"> </span>|<span class="hljs-string">_</span>|<span class="hljs-string"> </span>||<span class="hljs-string"> </span>|<br> \___/|<span class="hljs-string"> .__/ \___</span>|<span class="hljs-string">_</span>|<span class="hljs-string"> </span>|<span class="hljs-string">_</span>|<span class="hljs-string">    \_/\_/ \___</span>|<span class="hljs-string">_.__/ \___/</span>|<span class="hljs-string">___</span>|<br>      |<span class="hljs-string">_</span>|<br><br><br>v0.5.7 - building the best open-source AI user interface.<br><br>https://github.com/open-webui/open-webui<br></code></pre></td></tr></table></figure>        </div>      </div>    </div><ul><li><code>ollama serve</code> on server (default:11434 port)<ul><li><code>source=routes.go:1238 msg="Listening on 127.0.0.1:11434 (version 0.5.7)"</code></li></ul></li><li>ssh tunnel to server (like <code>ssh -N -L 11434:localhost:11434 10.4.7.1</code>)</li><li><code>http://localhost:11434/</code> --&gt; show <code>Ollama is running</code></li><li><code>http://localhost:8080/</code> enters Open-WebUI page (port=8080).</li></ul><div class="group-image-container"><div class="group-image-row"><div class="group-image-wrap"><img src="https://i.imgur.com/Oeapxhq.png" /></div><div class="group-image-wrap"><img src="https://i.imgur.com/lmTpJIS.png" /></div><div class="group-image-wrap"><img src="https://i.imgur.com/7LZCail.png" /></div><div class="group-image-wrap"><img src="https://i.imgur.com/2p6B6lJ.png" /></div></div><div class="group-image-row"></div></div><h3 id="installation-with-default-configuration">Installation with Default Configuration</h3><ul><li><p><strong>If Ollama is on your computer</strong>, use this command:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">docker run -d -p 3000:8080 --add-host=host.docker.internal:host-gateway -v open-webui:/app/backend/data --name open-webui --restart always ghcr.io/open-webui/open-webui:main<br></code></pre></td></tr></table></figure></li><li><p><strong>If Ollama is on a Different Server</strong>, use this command:</p><p>To connect to Ollama on another server, change the <code>OLLAMA_BASE_URL</code> to the server's URL:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">docker run -d -p 3000:8080 -e OLLAMA_BASE_URL=https://example.com -v open-webui:/app/backend/data --name open-webui --restart always ghcr.io/open-webui/open-webui:main<br></code></pre></td></tr></table></figure></li><li><p><strong>To run Open WebUI with Nvidia GPU support</strong>, use this command:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">docker run -d -p 3000:8080 --gpus all --add-host=host.docker.internal:host-gateway -v open-webui:/app/backend/data --name open-webui --restart always ghcr.io/open-webui/open-webui:cuda<br></code></pre></td></tr></table></figure></li></ul><h3 id="installation-for-openai-api-usage-only">Installation for OpenAI API Usage Only</h3><ul><li><p><strong>If you're only using OpenAI API</strong>, use this command:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">docker run -d -p 3000:8080 -e OPENAI_API_KEY=your_secret_key -v open-webui:/app/backend/data --name open-webui --restart always ghcr.io/open-webui/open-webui:main<br></code></pre></td></tr></table></figure></li></ul><h3 id="installing-open-webui-with-bundled-ollama-support">Installing Open WebUI with Bundled Ollama Support</h3><p>This installation method uses a single container image that bundles Open WebUI with Ollama, allowing for a streamlined setup via a single command. Choose the appropriate command based on your hardware setup:</p><ul><li><p><strong>With GPU Support</strong>: Utilize GPU resources by running the following command:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">docker run -d -p 3000:8080 --gpus=all -v ollama:/root/.ollama -v open-webui:/app/backend/data --name open-webui --restart always ghcr.io/open-webui/open-webui:ollama<br></code></pre></td></tr></table></figure></li><li><p><strong>For CPU Only</strong>: If you're not using a GPU, use this command instead:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">docker run -d -p 3000:8080 -v ollama:/root/.ollama -v open-webui:/app/backend/data --name open-webui --restart always ghcr.io/open-webui/open-webui:ollama<br></code></pre></td></tr></table></figure></li></ul><p>Both commands facilitate a built-in, hassle-free installation of both Open WebUI and Ollama, ensuring that you can get everything up and running swiftly.</p><p>After installation, you can access Open WebUI at <a href="http://localhost:3000">http://localhost:3000</a>.</p><h2 id="run">Run</h2><figure class="highlight console"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs console"><span class="hljs-meta prompt_">$ </span><span class="language-bash">ollama run phi3</span><br></code></pre></td></tr></table></figure><ul><li><code>ollama pull &lt;名字&gt;</code> 只下載模型不跑</li><li><code>ollama list</code> 可顯示本機下載了哪些模型</li><li><code>ollama rm &lt;名字&gt;</code> 可刪除下載的模型</li></ul><p><strong>模型儲存</strong> 在 <code>~/.ollama/models/</code>; <strong>log</strong> 也在 <code>~/.ollama/logs/server.log</code></p><h2 id="stop-ollama">Stop Ollama</h2><p>「這什麼蠢問題？不是 ctrl-c 或是 ctrl-d 就好了嗎？」</p><ul><li>其實 ollama run 「結束」以後，服務還在 port 照 bind，可以 ps 看到。雖然一段時間沒跑模型以後，模型就會從記憶體裡卸載，但如果有潔癖的話，可以在 Mac menu bar 右上角看到 Ollama 的圖示，點下去 Quit 就行</li></ul><p><img src="https://i.imgur.com/f44agCl.png" width="300" /></p><ul><li>Linux<ul><li>Identify the Process: <code>ps aux | grep ollama</code></li><li><code>pkill ollama</code> or <code>kill -9 &lt;PID&gt;</code></li></ul></li></ul><h2 id="remove-ollama">Remove Ollama</h2><ul><li>Stop the Ollama Service</li><li>Remove Ollama <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs sh">systemctl stop ollama.service  <span class="hljs-comment"># Stop the service</span><br><span class="hljs-built_in">sudo</span> apt remove ollama         <span class="hljs-comment"># Remove (Debian/Ubuntu)</span><br><span class="hljs-built_in">sudo</span> dnf remove ollama         <span class="hljs-comment"># Remove (Fedora/RHEL)</span><br><span class="hljs-built_in">sudo</span> snap remove ollama        <span class="hljs-comment"># Remove (Snap)</span><br>brew uninstall ollama          <span class="hljs-comment"># Remove (Homebrew)</span><br><span class="hljs-built_in">rm</span> -rf ~/.ollama               <span class="hljs-comment"># Remove configuration files (optional)</span><br></code></pre></td></tr></table></figure> or <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-built_in">sudo</span> <span class="hljs-built_in">rm</span> /usr/local/bin/ollama   <span class="hljs-comment"># Adjust the path as necessary</span><br><span class="hljs-built_in">rm</span> -rf ~/.ollama                <span class="hljs-comment"># Remove configuration files</span><br></code></pre></td></tr></table></figure></li></ul><h2 id="ollama-library">Ollama-library</h2><ul><li><p><a href="https://ollama.com/library" class="uri">https://ollama.com/library</a></p></li><li><p>The Llama 3.2 1B and 3B models support context length of 128K tokens and are state-of-the-art in their class for on-device use cases like summarization, instruction following, and rewriting tasks running locally at the edge. These models are enabled on day one for Qualcomm and MediaTek hardware and optimized for Arm processors.</p></li></ul><p><img src="https://i.imgur.com/g944O2M.png" width="500" /></p><h2 id="model-examples">Model examples</h2><h3 id="llama-large-language-model-meta-ai">LLaMA (Large Language Model Meta AI)</h3><p>LLaMA (Large Language Model Meta AI) is a family of large language models developed by Meta AI, with its initial release in February 2023. The latest version, LLaMA 3.3, was launched in December 2024. (<strong>The largest model, LLaMA 3.1 with 405 billion parameters, requires approximately 854 GB of memory without quantization.</strong> With techniques like 8-bit quantization, this can be reduced to around 427 GB, though it still demands substantial computational resources.)</p><p>Llama 3.2 1B and 3B models:</p><table><thead><tr class="header"><th>Model</th><th>Total Parameters</th><th>Context Length</th><th>Memory Requirements (GB)</th></tr></thead><tbody><tr class="odd"><td><strong>Llama 3.2 1B</strong></td><td>1 billion</td><td>128,000 tokens</td><td>BF16/FP16: ~2.5 GB</td></tr><tr class="even"><td></td><td></td><td></td><td>FP8: ~1.25 GB</td></tr><tr class="odd"><td></td><td></td><td></td><td>INT4: ~0.75 GB</td></tr><tr class="even"><td><strong>Llama 3.2 3B</strong></td><td>3 billion</td><td>128,000 tokens</td><td>BF16/FP16: ~6.5 GB</td></tr><tr class="odd"><td></td><td></td><td></td><td>FP8: ~3.2 GB</td></tr><tr class="even"><td></td><td></td><td></td><td>INT4: ~1.75 GB</td></tr></tbody></table><p>Key Features:</p><ul><li><strong>Multilingual Support</strong>: Trained on up to 9 trillion tokens, supporting languages like English, German, French, Italian, Portuguese, Hindi, Spanish, and Thai.</li><li><strong>Optimized for Efficiency</strong>: Designed for on-device applications such as prompt rewriting and knowledge retrieval.</li><li><strong>High Performance</strong>: Outperforms many existing open-access models of similar sizes and is competitive with larger models.</li></ul><h2 id="customize-a-model-.gguf">Customize a model (.gguf)</h2><h3 id="import-from-gguf">Import from GGUF</h3><p>Ollama supports importing GGUF models in the Modelfile:</p><ol type="1"><li><p>Create a file named <code>Modelfile</code>, with a <code>FROM</code> instruction with the local filepath to the model you want to import.</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">FROM</span> ./vicuna-<span class="hljs-number">33</span>b.Q4_0.gguf<br></code></pre></td></tr></table></figure></li><li><p>Create the model in Ollama</p><figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ebnf"><span class="hljs-attribute">ollama create example -f Modelfile</span><br></code></pre></td></tr></table></figure></li><li><p>Run the model</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs routeros">ollama <span class="hljs-built_in">run</span> example<br></code></pre></td></tr></table></figure></li></ol><h1 id="references">References</h1><ol type="1"><li><a href="https://github.com/ollama/">github | ollama</a></li><li><a href="https://www.freedidi.com/18341.html">本地部署 DeepSeek-R1 大模型！免费开源，媲美OpenAI-o1能力</a></li><li><a href="https://ollama.com/library/deepseek-r1:1.5b">ollama | deepseek-r1</a></li><li><a href="https://huggingface.co/deepseek-ai/DeepSeek-R1-Distill-Qwen-1.5B">huggingface | DeepSeek-R1-Distill-Qwen-1.5B</a></li><li><a href="https://ithelp.ithome.com.tw/m/articles/10343826">Day 03】Ollama UI 本機建置</a></li><li><a href="https://ai.meta.com/blog/llama-3-2-connect-2024-vision-edge-mobile-devices/">Llama 3.2: Revolutionizing edge AI and vision with open, customizable models</a></li><li><a href="https://ollama.com/library/llama3.2">ollama | llama3.2</a></li></ol>]]></content>
    
    
    <categories>
      
      <category>ML</category>
      
    </categories>
    
    
    <tags>
      
      <tag>AI</tag>
      
      <tag>ML</tag>
      
      <tag>Ollama</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ML | DeepSeek</title>
    <link href="/2025/01/30/ML-DeepSeek/"/>
    <url>/2025/01/30/ML-DeepSeek/</url>
    
    <content type="html"><![CDATA[<p>DeepSeek (深度求索)，全稱杭州深度求索人工智能基礎技術研究有限公司，是中國的一家人工智能與大型語言模型公司。該公司的總部位於中國大陸浙江省杭州市，由中資對沖基金幻方量化創立，創始人和行政總裁為梁文鋒。DeepSeek因其在推理任務上的表現與OpenAI的ChatGPT相當，但開發成本和資源消耗卻僅為其一小部分而受到廣泛關注。</p><h1 id="deepseek-model">DeepSeek Model</h1><p>DeepSeek-R1 and DeepSeek-V3 are advanced language models developed by DeepSeek-AI, leveraging a <strong>Mixture of Experts (MoE)</strong> architecture to optimize performance and resource efficiency.</p><ul><li>DeepSeek-V3<ul><li><a href="https://arxiv.org/pdf/2412.19437">Liu, A., Feng, B., Xue, B., Wang, B., Wu, B., Lu, C., ... &amp; Piao, Y. (2024). Deepseek-v3 technical report. arXiv preprint arXiv:2412.19437.</a><ul><li>We present DeepSeek-V3, <strong>a strong Mixture-of-Experts (MoE) language model</strong> with 671B total parameters with 37B activated for each token. To achieve efficient inference and cost-effective training, DeepSeek-V3 adopts Multi-head Latent Attention (MLA) and DeepSeekMoE architectures, which were thoroughly validated in DeepSeek-V2.</li></ul></li><li><a href="https://axk51013.medium.com/0410-llm%E6%96%B0%E7%9F%A5-mixture-of-expert-2024%E5%B9%B4llm%E7%9A%84%E6%96%B0%E6%A8%99%E7%AB%BF-a51c721fea37">【0410 LLM新知】Mixture of Expert，2024年LLM的新標竿</a></li></ul></li><li>DeepSeek-R1<ul><li>DeepSeek-R1 requires <strong>at least 800 GB of HBM memory in FP8</strong> format for inference.</li></ul></li></ul><table><thead><tr class="header"><th style="text-align: center;">Model</th><th style="text-align: center;">#Total Params</th><th style="text-align: center;">#Activated Params</th><th style="text-align: center;">Context Length</th><th style="text-align: center;">Download</th><th style="text-align: center;">VRAM FP8</th></tr></thead><tbody><tr class="odd"><td style="text-align: center;">DeepSeek-R1-Zero</td><td style="text-align: center;">671B</td><td style="text-align: center;">37B</td><td style="text-align: center;">128k</td><td style="text-align: center;"><a href="https://huggingface.co/deepseek-ai/DeepSeek-R1-Zero" class="uri">https://huggingface.co/deepseek-ai/DeepSeek-R1-Zero</a></td><td style="text-align: center;">at least 800 GB</td></tr><tr class="even"><td style="text-align: center;">DeepSeek-R1</td><td style="text-align: center;">671B</td><td style="text-align: center;">37B</td><td style="text-align: center;">128k</td><td style="text-align: center;"><a href="https://huggingface.co/deepseek-ai/DeepSeek-R1" class="uri">https://huggingface.co/deepseek-ai/DeepSeek-R1</a></td><td style="text-align: center;">at least 800 GB</td></tr><tr class="odd"><td style="text-align: center;">DeepSeek-V3</td><td style="text-align: center;">671B</td><td style="text-align: center;"></td><td style="text-align: center;"></td><td style="text-align: center;"></td><td style="text-align: center;">at least 800 GB</td></tr></tbody></table><p>DeepSeek-R1-Zero &amp; DeepSeek-R1 are trained based on DeepSeek-V3-Base. For more details regarding the model architecture, please refer to <a href="https://github.com/deepseek-ai/DeepSeek-V3">DeepSeek-V3</a> repository. (<strong>DeepSeek-V3-671B, 671 billion, VRAM (FP16) ~1,543 GB, VRAM (4-bit Quantization) ~386 GB</strong>)</p><ul><li><code>FP16 Precision</code>: Higher VRAM GPUs or multiple GPUs are required due to the larger memory footprint.</li><li><code>4-bit Quantization</code>: Lower VRAM GPUs can handle larger models more efficiently, reducing the need for extensive multi-GPU setups.</li><li><code>Lower Spec GPUs</code>: Models can still be run on GPUs with lower specifications than the above recommendations, as long as the GPU is equal or more than VRAM requirements. However, the setup would not be optimal and likely requires some tuning, such as adjusting batch sizes and processing settings.</li></ul><h1 id="本地部署">本地部署</h1><h2 id="ollama">Ollama</h2><p>我們可以透過Ollama來進行安裝</p><ul><li>Ollama 官方版：<a href="https://ollama.com/" class="uri">https://ollama.com/</a><ul><li><code>curl -fsSL https://ollama.com/install.sh | sh</code></li><li>Ollama 是一個開源軟體，讓使用者可以在自己的硬體上運行、創建和分享大型語言模型服務。這個平台適合希望在本地端運行模型的使用者，因為它不僅可以保護隱私，還允許用戶透過命令行介面輕鬆地設置和互動。Ollama 支援包括 Llama 2 和 Mistral 等多種模型，並提供彈性的客製化選項，例如從其他格式導入模型並設置運行參數。</li></ul></li><li>Web UI 控制端: <a href="https://chromewebstore.google.com/detail/page-assist-%E6%9C%AC%E5%9C%B0-ai-%E6%A8%A1%E5%9E%8B%E7%9A%84-web/jfgfiigpkhlkbnfnbobbkinehhfdhndo">Page Assist - A Web UI for Local AI Models | Chrome Extension</a></li></ul><h2 id="ollama-where-is-model-stored">ollama where is model stored</h2><ul><li>macOS: <code>~/.ollama/models</code></li><li>Linux: <code>/usr/share/ollama/.ollama/models</code></li><li>Windows: <code>C:\Users&lt;username&gt;.ollama\models</code></li></ul><figure class="highlight console"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs console"><span class="hljs-meta prompt_">$ </span><span class="language-bash"><span class="hljs-built_in">ls</span> ~/.ollama</span><br>history        id_ed25519     id_ed25519.pub logs           models<br><br>[~/.ollama/models]$ du -sh ./*<br> 39G./blobs<br> 24K./manifests<br></code></pre></td></tr></table></figure><h2 id="examples">Examples</h2><ul><li>The Llama 3.2 1B and 3B models support context length of 128K tokens and are state-of-the-art in their class for on-device use cases like summarization, instruction following, and rewriting tasks running locally at the edge. These models are enabled on day one for Qualcomm and MediaTek hardware and optimized for Arm processors.</li></ul><div class="group-image-container"><div class="group-image-row"><div class="group-image-wrap"><img src="https://i.imgur.com/EhgPLta.png" /></div><div class="group-image-wrap"><img src="https://i.imgur.com/9Px50B2.png" /></div></div><div class="group-image-row"><div class="group-image-wrap"><img src="https://i.imgur.com/3ki4mkk.png" /></div><div class="group-image-wrap"><img src="https://i.imgur.com/W9MzN7v.png" /></div></div></div><h2 id="distilled-models">Distilled models</h2><p>DeepSeek team has demonstrated that the reasoning patterns of larger models can be distilled into smaller models, resulting in better performance compared to the reasoning patterns discovered through RL on small models.</p><p>Below are the models created via fine-tuning against several dense models widely used in the research community using reasoning data generated by DeepSeek-R1. The evaluation results demonstrate that the distilled smaller dense models perform exceptionally well on benchmarks.</p><figure class="highlight console"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs console"><span class="hljs-meta prompt_"># </span><span class="language-bash">1.5B Qwen DeepSeek R1</span><br>ollama run deepseek-r1:1.5b<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">7B Qwen DeepSeek R1</span><br>ollama run deepseek-r1:7b<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">8B Llama DeepSeek R1</span><br>ollama run deepseek-r1:8b<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">14B Qwen DeepSeek R1</span><br>ollama run deepseek-r1:14b<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">32B Qwen DeepSeek R1</span><br>ollama run deepseek-r1:32b<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">70B Llama DeepSeek R1</span><br>ollama run deepseek-r1:70b<br></code></pre></td></tr></table></figure><div class="group-image-container"><div class="group-image-row"><div class="group-image-wrap"><img src="https://i.imgur.com/j0QwgGs.png" /></div><div class="group-image-wrap"><img src="https://i.imgur.com/ypBX0bL.png" /></div></div><div class="group-image-row"><div class="group-image-wrap"><img src="https://i.imgur.com/Jq9gqaJ.png" /></div><div class="group-image-wrap"><img src="https://i.imgur.com/knX3TwB.png" /></div></div><div class="group-image-row"><div class="group-image-wrap"><img src="https://i.imgur.com/SyCFPAZ.png" /></div></div></div><h1 id="references">References</h1><ol type="1"><li><a href="https://www.freedidi.com/18341.html">本地部署 DeepSeek-R1 大模型！免费开源，媲美OpenAI-o1能力</a></li><li><a href="https://ollama.com/library/deepseek-r1:1.5b">ollama | deepseek-r1</a></li><li><a href="https://huggingface.co/deepseek-ai/DeepSeek-R1-Distill-Qwen-1.5B">huggingface | DeepSeek-R1-Distill-Qwen-1.5B</a></li><li><a href="https://ithelp.ithome.com.tw/m/articles/10343826">Day 03】Ollama UI 本機建置</a></li><li><a href="https://ai.meta.com/blog/llama-3-2-connect-2024-vision-edge-mobile-devices/">Llama 3.2: Revolutionizing edge AI and vision with open, customizable models</a></li><li><a href="https://ollama.com/library/llama3.2">ollama | llama3.2</a></li></ol>]]></content>
    
    
    <categories>
      
      <category>ML</category>
      
    </categories>
    
    
    <tags>
      
      <tag>NWP</tag>
      
      <tag>AI</tag>
      
      <tag>ML</tag>
      
      <tag>deepseek</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ML | Transformer | Attention, FFN, ResNet</title>
    <link href="/2025/01/30/ML-Transformers/"/>
    <url>/2025/01/30/ML-Transformers/</url>
    
    <content type="html"><![CDATA[<h1 id="attention-is-all-you-need-2017">"Attention is all you need" (2017)</h1><ul><li><a href="https://arxiv.org/abs/1706.03762">Vaswani, A. (2017). <strong>Attention is all you need</strong>. Advances in Neural Information Processing Systems.</a></li></ul><div class="group-image-container"><div class="group-image-row"><div class="group-image-wrap"><img src="https://i.imgur.com/MUotlGg.png" /></div><div class="group-image-wrap"><img src="https://i.imgur.com/swgaC77.png" /></div></div><div class="group-image-row"><div class="group-image-wrap"><img src="https://i.imgur.com/oqquyUc.png" /></div><div class="group-image-wrap"><img src="https://i.imgur.com/qA7n7K2.png" /></div></div><div class="group-image-row"><div class="group-image-wrap"><img src="https://i.imgur.com/MiCibQL.jpg" /></div><div class="group-image-wrap"><img src="https://i.imgur.com/Ddp94SL.png" /></div></div><div class="group-image-row"></div><div class="group-image-row"></div><div class="group-image-row"></div></div><p>Encoder層和Decoder層內部結構如圖所示。</p><ul><li>Encoder具有兩層結構，self-attention和前饋神經網路。 self-attention計算句子中的每個詞都和其他詞的關聯，從而幫助模型更好地理解上下文語義，引入Muti-Head attention後，每個頭關注句子的不同位置，增強了Attention機制關注句子內部單詞之間作用的表達能力。<strong>前饋神經網路為encoder引入非線性變換，增強了模型的擬合能力</strong>。</li><li>The encoder is composed of a stack of <span class="math inline">\(N = 6\)</span> identical layers. (<strong>疊6次</strong> !!!)</li><li>Decoder接受output輸入的同時接受encoder的輸入，幫助目前節點取得到需要重點關注的內容</li><li><strong>縮放因子</strong>的作用是歸一化</li><li>FFN的加入引入了非線性(ReLu激活函數)，變換了attention output的空間, 從而增加了模型的表現能力。把FFN去掉模型也是可以用的，但效果差很多了。</li><li>在每個block中，最後出現的是Layer Normalization，其作用是規範最佳化空間，加速收斂。</li><li>當我們使用梯度下降演算法做最佳化時，我們可能會對輸入資料進行歸一化，但是經過網路層作用後，我們的資料已經不是歸一化的了。隨著網路層數的增加，資料分佈不斷變化，偏差越來越大，導致我們不得不使用更小的學習率來穩定梯度。 Layer Normalization 的作用是確保資料特徵分佈的穩定性，將資料標準化到ReLU活化函數的作用區域，可以使得激活函數更好的發揮作用。<strong>Normalization有兩種方法，Batch Normalization和Layer Normalization</strong>。</li><li><strong>Positional Encoding</strong> : 位置資訊編碼位於encoder和decoder的embedding之後，每個block之前。它非常重要，沒有這部分模型就無法運作。 Positional Encoding是transformer的特有機制，彌補了Attention機制無法捕捉sequence中token位置資訊的缺點。Positional Embedding的成分直接疊加於Embedding之上，使得每個token的位置資訊和它的語義資訊(embedding)充分融合，並被傳遞到後續所有經過複雜變換的序列表達中去。<ul><li><strong>提供位置信息</strong>：位置編碼的主要功能是告訴模型每個輸入向量在序列中的具體位置。這對於理解語言中的語法結構和上下文至關重要，因為語言的意義往往依賴於詞語的順序。</li><li><strong>數學表達</strong> : 位置編碼通常使用正弦和餘弦函數來生成，這樣可以保證不同位置之間的距離信息。具體公式如下：<ul><li>對於位置 <span class="math inline">\(pos\)</span> 和維度 <span class="math inline">\(i\)</span>： <span class="math display">\[\text{PE}(pos, 2i) = \sin\left(\frac{pos}{10000^{2i/d_{model}}}\right)\]</span> <span class="math display">\[\text{PE}(pos, 2i+1) = \cos\left(\frac{pos}{10000^{2i/d_{model}}}\right)\]</span> 其中，<span class="math inline">\(d_{model}\)</span> 是模型的維度（例如512），而 <span class="math inline">\(i\)</span> 是當前維度的索引。<strong>這種設計使得每個位置都有一組唯一的向量表示，並且相鄰位置之間的關係可以通過這些向量的相似性來捕捉</strong>!!!。</li><li><img src="https://i.imgur.com/A3FBmBf.png" width="400" /></li><li>句子中的位置獲得相應的位置編碼。例如，在句子 <code>貓坐在墊子上</code> 中，<code>貓</code>的位置編碼將與<code>坐</code>的不同，這樣模型就能夠理解它們之間的順序和關係。</li></ul></li></ul></li><li><strong>Cross Attention</strong><ul><li>交叉注意力使得模型能夠在處理一個序列時，參考另一個序列的信息。這種機制特別適用於需要同時考慮多個模態或序列的任務，例如機器翻譯、圖像描述生成等。</li><li><strong>與自注意力的對比</strong><ul><li><p><strong>自注意力（Self-Attention）</strong>：主要關注同一序列內部元素之間的關係，允許每個元素關注到其他所有元素。這有助於捕捉長距離依賴關係。</p></li><li><strong>交叉注意力</strong>：則專注於兩個不同序列之間的互動，允許模型在生成過程中參考其他序列的信息。</li></ul></li></ul></li><li>Mask 機制<ul><li>mask 表示掩碼，它對某些值進行掩蓋，使其在參數更新時不產生效果。 Transformer 模型裡面涉及兩種 mask，分別是 padding mask 和 sequence mask。其中，padding mask 在所有的 scaled dot-product attention 裡面都需要用到，而 sequence mask 只有在 decoder 的 self-attention 裡面用到。</li><li><strong>padding mask</strong>: 因為每個批次輸入序列長度都是不一樣的也就是說，我們要對輸入序列進行對齊。具體來說，就是給在較短的序列後面填滿 0。但是如果輸入的序列太長，則是截取左邊的內容，把多餘的直接捨棄。因為這些填滿的位置，其實是沒什麼意義的，所以我們的attention機制不應該把注意力放在這些位置上，所以我們需要進行一些處理。具體的做法是，把這些位置的值加上一個非常大的負數(負無窮)，這樣的話，經過 softmax，這些位置的機率就會接近0。</li><li><strong>Sequence mask</strong>: sequence mask 是為了讓 decoder 不能看見未來的資訊。也就是對於一個序列，在 time_step 為 t 的時刻，我們的解碼輸出應該只能依賴 t 時刻之前的輸出，而不能依賴 t 之後的輸出。因此我們需要想一個辦法，把 t 之後的訊息給隱藏起來。</li></ul></li><li><strong>Decoder Masked Attention</strong><ul><li>遮罩注意力機制的<strong>主要目的是在訓練階段防止解碼器（Decoder）利用未來位置的資訊</strong>，確保模型僅基於當前及之前的輸入生成輸出，模擬實際推理時逐步預測的過程。</li><li>為遮蔽未來位置，在計算 softmax 前，將注意力分數矩陣的上三角部分（未來位置）設為 <code>-inf</code>，（Upper Triangular Matrix），迫使模型忽略未來資訊</li><li><span class="math display">\[\text{MaskedAttention}(Q, K, V) = \text{softmax}\left(\frac{QK^T}{\sqrt{d_k}} + M_{\text{mask}}\right)V\]</span></li><li>假設序列長度為 3，遮罩矩陣為： <span class="math display">\[M_{\text{mask}} = \begin{bmatrix}0 &amp; -\infty &amp; -\infty \\0 &amp; 0 &amp; -\infty \\0 &amp; 0 &amp; 0\end{bmatrix}\]</span> 此矩陣確保位置 <span class="math inline">\(i\)</span> 僅能關注位置 <span class="math inline">\(j \leq i\)</span>。</li><li>解碼器的遮罩多頭注意力（Masked Multi-Head Attention）</li><li>以翻譯任務為例，目標序列為 <strong>"貓坐在墊子上"</strong>：<ul><li><strong>訓練階段</strong>：<br />解碼器輸入為 <code>&lt;BOS&gt; 貓 坐 在 墊子</code>，遮罩確保預測 "坐" 時僅使用 <code>&lt;BOS&gt; 貓</code> 的資訊。</li><li><strong>推理階段</strong>：<br />模型逐步生成輸出（如 <code>貓</code> → <code>坐</code> → <code>在</code>），每一步僅依賴已生成的序列。</li></ul></li><li>遮罩注意力機制是Transformer解碼器的核心設計之一，<strong>透過數學上的遮罩操作與架構上的因果性約束</strong>，實現高效且準確的序列生成，在機器翻譯、文本生成等任務中表現卓越。</li></ul></li><li><strong>Residual Network</strong><ul><li>殘差網絡是深度學習中重要概念。在神經網絡可以收斂的前提下，隨著網絡深度的增加，網絡表現先是逐漸增加至飽和，然後迅速下降，這就是我們經常討論的網絡退化問題。</li></ul></li><li><strong>Output: The Final Linear and Softmax Layer</strong><ul><li>線性變換層是一個簡單的全連接神經網絡，它可以把解碼組件產生的向量投射到一個比它大得多的、被稱作對數幾率（logits）的向量裡。接下來的Softmax 層便會把那些分數變成機率（都是正數、上限1.0）。機率最高的單元格被選中，並且它對應的單字被作為這個時間步的輸出。</li></ul></li></ul><div class="note note-primary">            <ul><li>這裡不得不提一點，雖然論文的名字叫《Attention is All your Need》，但是實際上， FFN and ResNet are also your need。</li><li>研究人員發現FFN 和ResNet 的Skip Connection 無論去掉哪一個，模型都會變得不可用。</li><li>所以說 Attention, FFN, ResNet 可以認為是 Transformers 架構的三駕馬車，缺一不可。</li><li>後續雖然有許多 Transformers 架構的魔改，但真正取得不錯的效果且落地的例子就是修改 FFN 的 MoE 架構。剩下的兩輛馬車，ResNet 幾乎沒辦法修改了，Attention 則在效率和效果之間尋求平衡。</li></ul>          </div><div class="note note-primary">            <ul><li>MoE : Transformer Feed-forward Layers are Mixtures of Experts 這是劉知遠團隊的論文，其實一直以來，神經網路就存在稀疏活化的現象，也就是在推理的時候，其實只有極小一部分參數參與了計算。這篇論文則透過MoE 的想法來將FFN 層拆分成了多個專家，並且新增了一個路由模組來確定推理的時候來掛哪個專家的門診：）這麼做之後，在提升推理速度的同時，效果仍能維持原來的95%以上。挺有價值的工作，大模型上也可以這麼做一把。</li></ul>          </div><div class="group-image-container"><div class="group-image-row"><div class="group-image-wrap"><img src="https://i.imgur.com/T5yqKkc.gif" /></div><div class="group-image-wrap"><img src="https://i.imgur.com/cpdMrRR.gif" /></div></div><div class="group-image-row"><div class="group-image-wrap"><img src="https://i.imgur.com/0jAGUu9.png" /></div><div class="group-image-wrap"><img src="https://i.imgur.com/iAPvqC1.png" /></div></div><div class="group-image-row"></div><div class="group-image-row"></div><div class="group-image-row"></div><div class="group-image-row"></div></div><ul><li>After finishing the encoding phase, we begin the decoding phase. Each step in the decoding phase outputs an element from the output sequence (the English translation sentence in this case).</li><li>The following steps repeat the process until a special symbol is reached indicating the transformer decoder has completed its output.</li><li>The output of each step is fed to the bottom decoder in the next time step, and the decoders bubble up their decoding results just like the encoders did.</li><li>And just like we did with the encoder inputs, we embed and add positional encoding to those decoder inputs to indicate the position of each word.</li></ul><h2 id="linear-classifier-and-final-softmax-for-output-probabilitiesr">Linear Classifier and Final Softmax for Output Probabilitiesr</h2><ul><li>The decoder stack outputs a vector of floats. How do we turn that into a word? That’s the job of the final Linear layer which is followed by a Softmax Layer.</li><li>The Linear layer is a simple fully connected neural network that projects the vector produced by the stack of decoders, into a much, much larger vector called a logits vector.</li><li>Let’s assume that our model knows <strong>10,000 unique English words (our model’s “output vocabulary”)</strong> that it’s learned from its training dataset. This would make the <strong>logits vector 10,000 cells wide</strong> – each cell corresponding to the score of a unique word. That is how we interpret the output of the model followed by the Linear layer.</li><li>The softmax layer then turns those scores into probabilities (all positive, all add up to 1.0). The cell with the highest probability is chosen, and the word associated with it is produced as the output for this time step.</li></ul><div class="group-image-container"><div class="group-image-row"><div class="group-image-wrap"><img src="https://i.imgur.com/c2XOwSF.png" /></div><div class="group-image-wrap"><img src="https://i.imgur.com/7Q5Offp.png" /></div></div><div class="group-image-row"></div><div class="group-image-row"></div><div class="group-image-row"></div><div class="group-image-row"></div><div class="group-image-row"></div></div><iframe width="560" height="315" src="https://www.youtube.com/embed/zxQyTK8quyY" title="Transformer Neural Networks, ChatGPT&#39;s foundation, Clearly Explained!!!" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen></iframe><iframe width="560" height="315" src="https://www.youtube.com/embed/bQ5BoolX9Ag" title="Decoder-Only Transformers, ChatGPTs specific Transformer, Clearly Explained!!!" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen></iframe><h1 id="input-as-vectors-for-a-transformer-model">Input as vectors for a Transformer model</h1><p>To prepare input as vectors for a Transformer model, the following steps are typically followed:</p><h2 id="tokenization">1. <strong>Tokenization</strong></h2><p>The first step involves breaking down the input text into smaller units called tokens. This can be done using various tokenization strategies, such as word-level, subword-level (like Byte Pair Encoding), or character-level tokenization. Each token corresponds to a unique identifier in the vocabulary.</p><h2 id="embedding">2. <strong>Embedding</strong></h2><p>Once the text is tokenized, each token is converted into a dense vector representation through an embedding layer. This process maps tokens to continuous vector spaces, allowing the model to capture semantic relationships between words. The embedding can be learned during training or pre-trained embeddings (like Word2Vec or GloVe) can be used.</p><ul><li><strong>Learned Embeddings</strong>: In the original Transformer paper, Vaswani et al. (2017) proposed using learned embeddings, meaning that the model learns to represent tokens as vectors during training.</li></ul><h2 id="positional-encoding">3. <strong>Positional Encoding</strong></h2><p>Since Transformers do not inherently understand the order of tokens due to their parallel processing capability, positional encodings are added to the embeddings to provide information about the position of each token in the sequence. The positional encoding is typically a fixed function based on sine and cosine functions of different frequencies.</p><ul><li>The positional encoding is added to the input embeddings, resulting in a combined representation that retains both the content and positional information.</li></ul><h2 id="summary-of-input-preparation-steps">Summary of Input Preparation Steps</h2><ol type="1"><li><strong>Tokenization</strong>: Split text into tokens.</li><li><strong>Embedding</strong>: Convert tokens into dense vectors.</li><li><strong>Positional Encoding</strong>: Add positional information to embeddings.</li><li><strong>Feed into Encoder</strong>: Use combined vectors as input for the Transformer encoder.</li></ol><p><img src="https://i.imgur.com/WQyQ5Pe.png" width="600" /></p><h1 id="自注意力機制-self-attention">自注意力機制 (Self-attention)</h1><h2 id="core-components">Core Components</h2><p>In self-attention, we define three matrices:</p><ul><li><strong>Query (Q)</strong>: Represents the elements for which we want to compute attention scores.</li><li><strong>Key (K)</strong>: Represents the elements that will be compared against the queries.</li><li><strong>Value (V)</strong>: Represents the actual information we want to aggregate based on the attention scores.</li></ul><p>To compute these matrices from an input embedding matrix <span class="math inline">\(X\)</span> (of shape <span class="math inline">\(L \times D\)</span>, where <span class="math inline">\(L\)</span> is the number of words and <span class="math inline">\(D\)</span> is the embedding dimension), we use learned weight matrices <span class="math inline">\(W_Q\)</span>, <span class="math inline">\(W_K\)</span>, and <span class="math inline">\(W_V\)</span>:</p><p><span class="math display">\[Q = X W_Q\]</span> <span class="math display">\[K = X W_K\]</span> <span class="math display">\[V = X W_V\]</span></p><h2 id="attention-score-calculation">Attention Score Calculation</h2><p>The self-attention mechanism computes attention scores using the following steps:</p><ol type="1"><li><p><strong>Dot Product</strong>: Calculate the dot product of the query and key matrices: <span class="math display">\[\text{Attention Scores} = QK^T\]</span> This results in a matrix where each entry indicates the similarity between queries and keys.</p></li><li><p><strong>Scaling</strong>: To stabilize gradients during training, we scale the dot product by the square root of the dimension of the key vectors <span class="math inline">\(d_k\)</span>: <span class="math display">\[S = \frac{QK^T}{\sqrt{d_k}}\]</span></p></li><li><p><strong>Softmax</strong>: Apply the softmax function to convert these scores into probabilities: <span class="math display">\[A = \text{softmax}(S)\]</span> This ensures that the attention scores sum to 1 across each row, effectively normalizing them.</p></li><li><p><strong>Weighted Sum</strong>: Finally, compute the output by taking a weighted sum of the value vectors based on the attention scores: <span class="math display">\[O = AV\]</span> Here, <span class="math inline">\(O\)</span> is the output matrix representing aggregated information from <span class="math inline">\(V\)</span> based on how much focus each query gives to each value.</p></li></ol><h3 id="complete-self-attention-equation">Complete Self-Attention Equation</h3><p>Combining these steps, we can express self-attention as: <span class="math display">\[O = \text{softmax}\left(\frac{QK^T}{\sqrt{d_k}}\right)V\]</span></p><h2 id="multi-head-attention">Multi-Head Attention</h2><p>In practice, transformers often use multi-head attention, which allows the model to jointly attend to information from different representation subspaces. The output for each head is computed independently and then concatenated: <span class="math display">\[O = W_o [H_1; H_2; ...; H_M]\]</span> where each head <span class="math inline">\(H_i\)</span> is calculated as: <span class="math display">\[H_i = \text{softmax}\left(\frac{W_k^{(i)}Q(W_q^{(i)})^T}{\sqrt{d_k}}\right)W_v^{(i)}V\]</span></p><p>Here, <span class="math inline">\(W_q^{(i)}, W_k^{(i)}, W_v^{(i)}\)</span> are learned weight matrices for each head, and <span class="math inline">\(W_o\)</span> is a final linear transformation applied after concatenating all heads.</p><div class="group-image-container"><div class="group-image-row"><div class="group-image-wrap"><img src="https://i.imgur.com/m673yGz.png" /></div><div class="group-image-wrap"><img src="https://i.imgur.com/1xy5F9F.png" /></div><div class="group-image-wrap"><img src="https://i.imgur.com/d6LS6YQ.png" /></div></div><div class="group-image-row"><div class="group-image-wrap"><img src="https://i.imgur.com/L8t2LFA.png" /></div><div class="group-image-wrap"><img src="https://i.imgur.com/JL92Jfv.png" /></div><div class="group-image-wrap"><img src="https://i.imgur.com/uNcguro.png" /></div></div><div class="group-image-row"><div class="group-image-wrap"><img src="https://i.imgur.com/9oxhFT8.png" /></div><div class="group-image-wrap"><img src="https://i.imgur.com/AzOhXvb.png" /></div><div class="group-image-wrap"><img src="https://i.imgur.com/36lKeEY.png" /></div></div><div class="group-image-row"><div class="group-image-wrap"><img src="https://i.imgur.com/RxJGBEk.png" /></div><div class="group-image-wrap"><img src="https://i.imgur.com/vu4JQUO.png" /></div></div></div><iframe width="560" height="315" src="https://www.youtube.com/embed/hYdO9CscNes" title="【機器學習2021】自注意力機制 (Self-attention) (上)" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen></iframe><iframe width="560" height="315" src="https://www.youtube.com/embed/gmsMY5kc-zw" title="【機器學習2021】自注意力機制 (Self-attention) (下)" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen></iframe><h1 id="cross-attention">Cross-Attention</h1><div class="note note-primary">            <p>在 cross attention 的基礎上, 提出了 self-attention</p>          </div><div class="group-image-container"><div class="group-image-row"><div class="group-image-wrap"><img src="https://i.imgur.com/kUDX4jY.png" /></div><div class="group-image-wrap"><img src="https://i.imgur.com/LfWgMKb.png" /></div></div><div class="group-image-row"></div><div class="group-image-row"></div><div class="group-image-row"></div></div><h1 id="references">References</h1><ol type="1"><li><a href="https://www.zhihu.com/question/596771388/answer/3459193587">为什么我还是无法理解transformer？ - 看图学的回答 - 知乎 ( <strong>推薦 </strong> )</a></li><li><a href="https://jalammar.github.io/illustrated-transformer/">The Illustrated Transformer ( <strong>推薦 </strong> )</a></li><li><a href="https://goyalpramod.github.io/blogs/Transformers_laid_out/">Transformers Laid Out | Pramod's Blog ( <strong>推薦 </strong> )</a></li><li><a href="https://www.zhihu.com/question/362131975/answer/3360076979">transformer的细节到底是怎么样的？ - 亚东的回答 - 知乎</a></li><li><a href="https://www.zhihu.com/question/362131975/answer/3039107481">transformer的细节到底是怎么样的？ - Hao Bai的回答 - 知乎</a></li><li><a href="https://zhuanlan.zhihu.com/p/311156298">Transformer - Attention is all you need</a></li><li><a href="https://zhuanlan.zhihu.com/p/46990010">论文解读:Attention is All you need</a></li><li><a href="https://deepgram.com/learn/visualizing-and-explaining-transformer-models-from-the-ground-up">Visualizing and Explaining Transformer Models From the Ground Up</a></li><li><a href="https://www.youtube.com/watch?v=n9TlOhRjYoc&amp;ab_channel=Hung-yiLee">【機器學習2021】Transformer (上)</a></li><li><a href="https://www.youtube.com/watch?v=N6aRv06iv2g&amp;ab_channel=Hung-yiLee">【機器學習2021】Transformer (下)</a></li></ol>]]></content>
    
    
    <categories>
      
      <category>ML</category>
      
    </categories>
    
    
    <tags>
      
      <tag>NWP</tag>
      
      <tag>AI</tag>
      
      <tag>ML</tag>
      
      <tag>ResNet</tag>
      
      <tag>RNN</tag>
      
      <tag>Transformer</tag>
      
      <tag>Attention</tag>
      
      <tag>FFN</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ML | Frequentist and Bayesian (頻率派 和 貝葉斯派)</title>
    <link href="/2025/01/30/ML-Frequentist-and-Bayesian/"/>
    <url>/2025/01/30/ML-Frequentist-and-Bayesian/</url>
    
    <content type="html"><![CDATA[<p><strong>貝葉斯派和頻率派</strong>。在學習機器學習的過程中，應該聽過很多次這兩個專業詞彙，剛開始學不用過於深究，這不會影響你學習各種模型，當你了解完很多模型演算法後，再回過頭來看貝葉斯派和頻率派，就會有種醍醐灌頂的感覺，你在每種模型上都可以找到它們的哲學思想、方法論。</p><ul><li>貝葉斯公式： <span class="math inline">\(P(\theta|x)=\frac{P(x|\theta)P(\theta)}{P(x)}\)</span></li><li>先驗機率指的是 <span class="math inline">\(P(\theta)\)</span></li><li>似然機率指的是<span class="math inline">\(P(x|\theta)\)</span></li><li>後驗機率指的是<span class="math inline">\(P(\theta|x)\)</span></li></ul><p>是兩種不同的看待世界的方法論：<strong>頻率派把模型參數看成未知的定量</strong>，<strong>最大概似估計（Maximum likelihood estimation, MLE)</strong> 求解參數，往往最後變成最佳化問題。這一分支又被稱為統計學習。</p><ul><li>The MLE is defined as: <span class="math display">\[\hat{\theta}_{MLE} = \arg \max_{\theta} P(X | \theta)\]</span></li></ul><p><strong>貝葉斯派把模型參數看成未知的變數（機率分佈）</strong>，<strong>以 最大後驗概率估計(Maximum A Posteriori estimation, MAP)</strong> 求解參數。 - The MAP estimation is defined as: <span class="math display">\[   \hat{\theta}_{MAP} = \arg \max_{\theta} P(\theta |X) = \arg \max_{\theta} P(X | \theta) P(\theta)   \]</span></p><ul><li>Here, <span class="math inline">\(P(X | \theta)\)</span> is the likelihood function, and <span class="math inline">\(P(\theta)\)</span> is the prior distribution. The MAP estimation can be seen as a modification of MLE that includes this prior information.</li></ul><p>其實最大化後驗機率還不算純粹的貝葉斯派，純粹的貝葉斯派是求出具體的後驗，難度很大，要進行積分，也就是要求出 <span class="math inline">\(P(x)\)</span> 這一項，<strong>像是蒙特卡羅方法、機率圖模型</strong>。</p><p><span class="math display">\[P(\theta|x)=\frac{P(x|\theta)P(\theta)}{P(x)} = \frac{P(x|\theta)P(\theta)}{\int P(x|\theta)P(\theta) d\theta}\]</span></p><p>可以看到兩者最大的差異在於對參數的認知。</p><div class="note note-primary">            <ul><li><strong>頻率派認為參數是常數，資料是變數</strong>；</li><li><strong>貝葉斯派則認為參數是變量，不可能求出固定的參數，資料是常數</strong>。</li></ul>          </div><table><thead><tr class="header"><th style="text-align: center;">Frequentist</th><th style="text-align: center;">Bayesian</th></tr></thead><tbody><tr class="odd"><td style="text-align: center;">頻率論方法透過大量獨立實驗將機率解釋為統計平均值（大數定律</td><td style="text-align: center;">貝葉斯方法則將機率解釋為信念度（degree of belief）（不需要大量的實驗）</td></tr><tr class="even"><td style="text-align: center;">頻率學派把未知參數看成普通變數（固定值），把樣本看成隨機變數</td><td style="text-align: center;">貝葉斯學派把一切變數看成隨機變量</td></tr><tr class="odd"><td style="text-align: center;">頻率論僅僅利用抽樣數據</td><td style="text-align: center;">貝葉斯理論善於利用過去的知識和抽樣數據</td></tr></tbody></table><h1 id="least-squares-method-cross-entropy-l1-regularization-lasso-l2-regularization">Least squares method, Cross entropy, L1 regularization (Lasso), L2 regularization</h1><h2 id="least-squares-method">Least squares method</h2><p><strong>最小二乘法 (least squares) 就是 雜訊符合常態分佈的 最大概似估計 (MLE) 的數學形式</strong>。從機率角度給出了最小平方法的理論支撐。我們發現頻率派，往往轉換為極大似然法問題，也就是最優化求極值問題，這也被稱為統計學習，像決策樹，支持向量機都有最優化思想，都屬於這一分支。</p><p><span class="math display">\[\begin{align}y &amp;= f(x) + \epsilon \qquad ; \epsilon \sim N(0, \sigma^2)\\f(x) &amp;= w^Tx \\y|w,x &amp;\sim N(w^T x, \sigma^2) \qquad ; \textrm{by given w and x} \\P(y|w,x) &amp;= \dfrac{1}{\sqrt{2 \pi}\sigma}\exp ( - \dfrac{(y - w^Tx)^2}{2\sigma^2}) \\\textrm{By MLE,}\\L(w) &amp;= \log P(Y|X,w)\\&amp;= \log \Pi P(y_i|x_i, w)\\&amp;= \sum \log P(y_i|x_i,w)\\&amp;= \sum ( \log (\dfrac{1}{\sqrt{2\pi}\sigma}) - \dfrac{(y - w^Tx)^2}{2\sigma^2})\\w &amp;= \textrm{argmax} L(w) = \textrm{argmax} (- \dfrac{(y - w^Tx)^2}{2\sigma^2}) = \textrm{argmin} (y - w^Tx)^2\end{align} \]</span></p><h2 id="cross-entropy-loss-function">Cross-Entropy Loss Function</h2><p>Cross-entropy is a fundamental concept in information theory and machine learning, <strong>measuring the difference between two probability distributions</strong>. It quantifies how well one probability distribution <span class="math inline">\(q\)</span> approximates another distribution <span class="math inline">\(p\)</span> over the same set of events.</p><h3 id="definition">Definition</h3><p>In mathematical terms, the cross-entropy <span class="math inline">\(H(p, q)\)</span> between two discrete probability distributions <span class="math inline">\(p\)</span> and <span class="math inline">\(q\)</span> is defined as:</p><p><span class="math display">\[H(p, q) = -\sum_{x \in \mathcal{X}} p(x) \log(q(x))\]</span></p><p>where <span class="math inline">\(p(x)\)</span> is the true distribution and <span class="math inline">\(q(x)\)</span> is the estimated distribution. This formula reflects the average number of bits needed to identify an event drawn from the true distribution when using a coding scheme optimized for the estimated distribution.</p><h4 id="relation-to-kullback-leibler-divergence">Relation to Kullback-Leibler Divergence</h4><p>Cross-entropy is closely related to Kullback-Leibler (KL) divergence, which measures how one probability distribution diverges from a second, expected probability distribution. The relationship can be expressed as:</p><p><span class="math display">\[D_{\mathrm{KL}}(p \parallel q) = H(p, q) - H(p)\]</span></p><p>where <span class="math inline">\(H(p)\)</span> is the entropy of the true distribution <span class="math inline">\(p\)</span>. This indicates that minimizing cross-entropy also minimizes KL divergence when <span class="math inline">\(p\)</span> is fixed</p><h4 id="binary-classification">Binary classification</h4><p>The cross-entropy loss function (also known as log loss) can be expressed for binary classification as:</p><p><span class="math display">\[L(y, \hat{y}) = -[y \log(\hat{y}) + (1 - y) \log(1 - \hat{y})]\]</span></p><p>where: - <span class="math inline">\(y\)</span> is the true label (0 or 1), - <span class="math inline">\(\hat{y}\)</span> is the predicted probability of the positive class.</p><p>For multiclass classification, it generalizes to:</p><p><span class="math display">\[L(y, \hat{y}) = -\sum_{i=1}^{M} y_i \log(\hat{y}_i)\]</span></p><p>where <span class="math inline">\(M\)</span> is the number of classes, and <span class="math inline">\(y_i\)</span> and <span class="math inline">\(\hat{y}_i\)</span> are the true label and predicted probability for class <span class="math inline">\(i\)</span>, respectively.</p><h2 id="regularization">Regularization</h2><p><span class="math display">\[\begin{align}y &amp;= f(x) + \epsilon \qquad ; \epsilon \sim N(0, \sigma^2)\\f(x) &amp;= w^Tx \\y|w &amp;\sim N(w^T x, \sigma^2) \qquad ; \textrm{by given w and constant x} \\P(y|w) &amp;= \dfrac{1}{\sqrt{2 \pi}\sigma}\exp ( - \dfrac{(y - w^Tx)^2}{2\sigma_0^2}) \\P(w) &amp;= \dfrac{1}{\sqrt{2 \pi}\sigma}\exp ( - \dfrac{||w||)^2}{2\sigma_1^2}) \\\textrm{By MAP,}\\L(w) &amp;= \log P(w|Y)\\&amp;= \log \Pi \dfrac{P(Y|w)P(w)}{P(y)}\\&amp;\sim \sum \log P(Y|w)P(w)\\&amp;= \sum ( \log (\dfrac{1}{\sqrt{2\pi}\sigma}) - \dfrac{(y - w^Tx)^2}{2\sigma_0^2} - \dfrac{||w||)^2}{2\sigma_1^2})\\w &amp;= \textrm{argmax} L(w) = \textrm{argmax} (- \dfrac{(y - w^Tx)^2}{2\sigma_0^2} - \dfrac{||w||)^2}{2\sigma_1^2}) = \textrm{argmin} ((y - w^Tx)^2 + \dfrac{\sigma_0^2}{\sigma_1^2}||w||^2)\end{align} \]</span></p><h3 id="l1-regularization-lasso">L1 Regularization (Lasso)</h3><p><strong>Objective Function</strong>: The L1 regularized least squares problem, often referred to as <strong>Lasso regression</strong>, modifies the standard least squares loss function by adding a penalty term based on the absolute values of the coefficients. The objective function can be expressed as:</p><p><span class="math display">\[L_{L1} = \frac{1}{n} \sum_{i=1}^{n} (y_i - \hat{y}_i)^2 + \lambda \sum_{j=1}^{p} |w_j|\]</span></p><h3 id="l2-regularization-ridge">L2 Regularization (Ridge)</h3><p><strong>Objective Function</strong>: The L2 regularized least squares problem, known as <strong>Ridge regression</strong>, similarly alters the least squares loss function by incorporating a penalty based on the squared values of the coefficients. The objective function is given by:</p><p><span class="math display">\[L_{L2} = \frac{1}{n} \sum_{i=1}^{n} (y_i - \hat{y}_i)^2 + \lambda \sum_{j=1}^{p} w_j^2\]</span></p><p>發現<strong>L2正則化就是假設參數符合常態分佈</strong>的最大後驗法的數學形式！同理可得<strong>L1正規化是假設參數符合拉普拉斯分佈</strong>的最大後驗法。我們現在可以從機率角度解釋正規化到底在做什麼了。</p><div class="note note-primary">            <p><strong>正規化就是引入了先驗知識</strong></p>          </div><p>我們知道世界上大多數事件是服從常態分佈的，像是身高、體重、成績等等。因此我們假設參數也符合常態分佈。引入先驗知識有什麼好處呢，我們現在拋一枚硬幣，50次中有30次都是正面向上，問你拋這枚硬幣的機率分佈，這時你想起你人生中遇到的大多數硬幣都是均勻的，儘管數據顯示不均勻，你還是會認為這枚硬幣是均勻的。如果你是這麼想的，<strong>那你就引入了先驗知識。因此引入先驗知識在數據不足的時候有很大好處</strong>。</p><div class="note note-primary">            <p>看到這裡你不禁產生這樣的疑惑，最大後驗法也是轉換成最佳化問題啊，跟頻率派有什麼差別嗎？對的，最大後驗法不是原汁原味的貝葉斯派，它是貝葉斯派的妥協，因為求積分</p><p><span class="math display">\[\int P(x|\theta)P(\theta) d\theta\]</span></p><p><strong>太難了，所以最大後驗法是貝氏派向頻率派的妥協</strong>。因為那積分太難求了，就預設其是一個定值，argmax之後，分母是定值那麼分子最大即可了；所以這就是頻率學派攻擊貝葉斯的落腳點：你這麼牛逼怎麼不把分母求出呢？貝葉斯妥協了</p>          </div><h1 id="more">More,</h1><ul><li>頻率派認為模型參數是客觀存在的，它就在那裡。因此把參數看成常數，如果有一個全知全能神，就能告訴你參數值是多少，當資料量成千上萬時，我們可以不斷逼近那個真實的參數。</li><li>貝葉斯派認為認為一切機率都是主觀的，因此把參數看成變量，不存在客觀存在的機率。<ul><li>在證明L2正規化時，你肯定想問為什麼假設參數的先驗分佈是常態分佈，沒錯，這就是主觀的，是主觀臆斷的。這也是頻率派常常抨擊貝葉斯派的一點，先驗分佈該如何取得？貝葉斯派是這樣辯護的：先驗分佈如何取得不重要，重要的是，我們可以不斷假設，不斷修改。而先驗分佈不是完全瞎猜的，而是基於我之前的人生經驗，例如太陽東升西落，硬幣總是50%向上。</li></ul></li><li>具體到點估計的情形，其實貝葉斯和頻率派沒有什麼差別，因為從極大似然估計的角度來說，給參數加先驗其實可以被看作是加一個正則項，所以你用貝葉斯方法得到的最大後驗估計就等價於帶了正規項的極大似然估計。<ul><li>當然在大多數情況下，我們用貝葉斯方法是想算出參數的後驗分佈。有了後驗分佈你就相當於擁有了參數的所有信息，你想要最大後驗估計就用最大後驗估計，想要用後驗均值當估計量就用後驗均值當估計量，並且連算信賴區間的力氣都省</li><li>你可以從後驗分佈直接找到信賴區間，而不需要像頻率派那樣苦哈哈地去算估計量的漸進分佈（Asymptotic Distribution），或是跑慢死人不償命的Bootstrap。所以有句玩笑，叫做如果你是聰明人那就去研究頻率派，但如果你是個懶人那就去搞貝葉斯，因為會算會跑模擬就行了（逃當然一切都是有代價的，具體到計算層面上，貝葉斯在許多模型的計算上都比頻率學派的要慢一大截。貝葉斯方法往往要求我們模擬整個後驗分佈（在大多數情況下後驗分佈/點估計都沒有明確解）。 （Importance Sampling）和拒絕採樣（Rejection Sampling）就別指望了，想算就只能用MCMC （馬爾科夫鏈蒙特卡洛），也就是透過模擬一條馬可夫鏈來模擬後驗樣本。</li><li>不過近年來大家也開始對變分推論這種方法更感興趣（idea是用簡單分佈的組合去逼近複雜的後驗分佈）。目前來看變分推論的表現非常不錯，唯一的問題是會引入偏差，無法重建真正的後驗分佈，當然這就看這套方法接下來怎麼發展了。</li></ul></li></ul><h1 id="references">References</h1><ol type="1"><li><a href="https://www.zhihu.com/question/268906722/answer/2842695236">机器学习中，频率派和贝叶斯派有什么核心差异？</a></li><li><a href="https://zhuanlan.zhihu.com/p/337637096">统计学里频率学派(Frequentist)与贝叶斯(Bayesian)学派的区别和在机器学习中的应用</a></li></ol>]]></content>
    
    
    <categories>
      
      <category>ML</category>
      
    </categories>
    
    
    <tags>
      
      <tag>NWP</tag>
      
      <tag>AI</tag>
      
      <tag>ML</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ML | RNN Recurrent Neural Network</title>
    <link href="/2025/01/28/ML-RNN-Recurrent-Neural-Network/"/>
    <url>/2025/01/28/ML-RNN-Recurrent-Neural-Network/</url>
    
    <content type="html"><![CDATA[<h1 id="循環神經網路recurrent-neural-networkrnn">循環神經網路（recurrent neural network，RNN)</h1><p>RNN是一種特殊的神經網路結構，它透過在時間上的展開來處理序列資料中的依賴關係。在每個時間步（time step），RNN都會接收一個輸入（例如句子中的一個單字），並輸出一個結果（例如下一個單字的預測）。與傳統的前饋神經網路（Feedforward Neural Network, FNN）不同，RNN在每個時間步都會保留一個隱藏狀態（hidden state），這個隱藏狀態包含了之前所有時間步的信息，並用於計算當前時間步的輸出和下一個時間步的隱藏狀態。</p><p><img src="https://i.imgur.com/qaIEoow.png" width="600" /></p><h2 id="rnn的工作原理">RNN的工作原理</h2><p><img src="https://i.imgur.com/YGZlltA.png" width="600" /></p><p>RNN的核心在於其<strong>隱藏狀態</strong>和<strong>循環結構</strong>。每當新的輸入進來時，RNN不僅考慮當前的輸入，還會利用之前的隱藏狀態來更新當前的隱藏狀態。這樣的設計使得RNN能夠捕捉序列數據中的上下文和依賴關係。</p><h3 id="隱藏狀態">隱藏狀態</h3><p>隱藏狀態是RNN的一個重要組成部分，它保存了過去信息的摘要。在每個時間步，RNN會根據當前輸入和之前的隱藏狀態來計算新的隱藏狀態：</p><p><span class="math display">\[h_t = f(W_h h_{t-1} + W_x x_t)\]</span></p><p>其中，<span class="math inline">\(h_t\)</span> 是當前隱藏狀態，<span class="math inline">\(W_h\)</span> 和 <span class="math inline">\(W_x\)</span> 是權重矩陣，<span class="math inline">\(x_t\)</span> 是當前輸入。</p><h2 id="rnn的應用">RNN的應用</h2><p>RNN在多個領域中有著廣泛的應用：</p><ol type="1"><li><p><strong>自然語言處理（NLP）</strong>：RNN在語言模型、機器翻譯和情感分析等任務中表現出色。它們能夠捕捉單詞之間的上下文關係，提高預測準確性。</p></li><li><p><strong>時間序列分析</strong>：RNN非常適合於基於歷史數據預測未來值，如股票市場預測和天氣預報。</p></li><li><p><strong>語音和音頻處理</strong>：在語音識別中，RNN能夠處理連續的音頻數據，將語音轉換為文本，提高了轉錄準確性。</p></li><li><p><strong>圖像和視頻分析</strong>：結合卷積神經網路（CNN），RNN可以用於視頻分析、物體追蹤和行為識別等任務。</p></li></ol><h2 id="優點">優點</h2><p><strong>處理序列資料的能力</strong>：RNN能夠捕捉序列中的依賴關係，適合處理時間序列和語言等資料。</p><p><strong>參數共享</strong>：RNN在每個時間步驟使用相同的參數，這使得模型參數數量相對較少，避免了過度擬合問題。</p><p><strong>線上學習</strong>：RNN可以處理一個時間步接一個時間步的數據，適合即時數據處理。</p><h2 id="rnn的挑戰與改進">RNN的挑戰與改進</h2><p>儘管RNN在處理序列數據方面具有優勢，但它們也面臨一些挑戰，如<strong>梯度消失</strong>和<strong>梯度爆炸問題</strong>。這些問題會影響模型學習長期依賴關係的能力。</p><p><strong>梯度消失</strong>：在RNN中，由於參數共享和多次連乘的特性，在反向傳播過程中，梯度值可能會隨著時間步的增加而指數級衰減，最終趨近於0。這導致RNN難以學習到長期依賴關係，因為較早時間步的輸入在反向傳播時其梯度幾乎為0，無法對這些輸入進行有效的權重更新。</p><p>由於梯度消失的問題，RNN在處理長序列時難以有效地捕捉長期依賴關係。這意味著如果輸入序列中的某個元素與輸出之間存在長時間的間隔，RNN可能無法有效地學習到這兩者之間的關係，從而限制了其在處理長序列資料時的表現。</p><p><strong>梯度爆炸</strong>：與梯度消失相反，梯度爆炸是指在反向傳播過程中，梯度值可能會隨著時間步的增加而快速增長到非常大，導致模型訓練不穩定甚至無法收斂。</p><p><strong>平行處理能力較差</strong>：RNN的計算是順序進行的，即每個時間步的輸出都依賴前一個時間步的計算結果。這種順序計算的方式限制了RNN的平行處理能力，使得在大規模資料集和複雜模型的情況下，RNN的訓練和推理速度相對較慢。</p><h3 id="改進架構">改進架構</h3><p>為了解決這些問題，研究者提出了改進版本的RNN，如長短期記憶網絡（LSTM）和門控循環單元（GRU）。這些架構引入了門控機制，使得模型能夠選擇性地保留或遺忘信息，從而更有效地捕捉長期依賴性.</p><p>總結來說，循環神經網路是一種強大的工具，能夠有效處理序列數據並捕捉時間上的依賴關係，其應用範圍涵蓋自然語言處理、時間序列預測、語音識別等多個領域。</p><h1 id="literature-review">Literature review</h1><ol type="1"><li>Rumelhart, David E., Geoffrey E. Hinton, and Ronald J. Williams. <a href="">"Learning representations by back-propagating errors."</a> nature 323.6088 (1986): 533-536.</li></ol><h1 id="references">References</h1><ol type="1"><li><a href="https://mp.weixin.qq.com/s/KVL2Epn014KRlcL5hmTUCQ">超全面讲透一个算法模型，RNN ！！</a></li></ol>]]></content>
    
    
    <categories>
      
      <category>ML</category>
      
    </categories>
    
    
    <tags>
      
      <tag>NWP</tag>
      
      <tag>AI</tag>
      
      <tag>ML</tag>
      
      <tag>RNN</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>WRF | Vertical Levels and Heights</title>
    <link href="/2025/01/27/WRF-Vertical-Levels-and-Heights/"/>
    <url>/2025/01/27/WRF-Vertical-Levels-and-Heights/</url>
    
    <content type="html"><![CDATA[<div class="note note-primary">            <ul><li><a href="https://www2.mmm.ucar.edu/wrf/users/wrf_users_guide/build/html/index.html"><strong>WRF Users Guide documentation !!</strong></a></li><li><a href="https://forum.mmm.ucar.edu/forums/frequently-asked-questions.115/">Development Team Announcements &gt; <strong>Frequently Asked Questions</strong></a></li></ul>          </div><h1 id="hybrid-vertical-coordinate">Hybrid Vertical Coordinate</h1><p>WRF is a hybrid vertical coordinate (HVC) and at the surface, it is terrain-following - meaning the heights come from the static geographic data used in the WPS process. Additional details about the HVC can be found in the <a href="https://www2.mmm.ucar.edu/wrf/users/wrf_users_guide/build/html/dynamics.html">Dynamics chapter</a> of the WRF Users Guide.</p><ul><li>Prior to WRFV4.0, the vertical coordinate defaulted to terrain-following. To convert back to that option, set <code>“hybrid_opt=0”</code> in the <code>&amp;dynamics</code> section of the namelist. real.exe and wrf.exe must both be run with the same <code>“hybrid_opt”</code> value.</li><li>When using HVC output with post-processors, use either hydrostatic pressure (<code>P_HYD</code>) or total pressure (<code>PB + P</code>) for diagnostics and vertical interpolation.</li><li>In wrfout, you can find variables <code>PH</code> and <code>PHB</code>, <code>(PH + PHB)/9.8</code> will <strong>give you the real altitude of each model level</strong>. You can do vertical interpolation to put the variables in any levels you want for calculation.</li><li><code>PH</code> and <code>PHB</code> are geopotential, which is a physical variable defined in geoscience</li></ul><div class="group-image-container"><div class="group-image-row"><div class="group-image-wrap"><img src="https://i.imgur.com/3ECQSPE.png" /></div><div class="group-image-wrap"><img src="https://i.imgur.com/v4MPzsr.png" /></div><div class="group-image-wrap"><img src="https://i.imgur.com/oyjw9E5.png" /></div></div></div><h1 id="determine-pressure-and-height-at-each-wrf-vertical-level">Determine pressure and height at each WRF vertical level</h1><ul><li><a href="https://forum.mmm.ucar.edu/threads/determine-pressure-and-height-at-each-wrf-vertical-level.114/">Determine pressure and height at each WRF vertical level</a></li></ul><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs text">They can be computed from:<br><br>(P + PB)*0.01 for pressure at half-sigma level, and<br><br>(PH + PHB)/9.81 for geopotential height at full level.<br><br>The model levels are not at constant pressure or height surfaces because they follow terrain.<br></code></pre></td></tr></table></figure><div class="note note-primary">            <p>the result of (PH+PHB)/9.8 is the height above sea level that is not what you need to check.</p>          </div><p>Above surface, (<code>HGT</code> is terrain height.)</p><div class="note note-primary">            <p>(PH+PHB)/9.81-HGT</p>          </div><p>The center height above surface, absolute altitude should be calculated by running average from the top and bottom:</p><div class="note note-primary">            <p>(((PH(k)+PH(k+1)) / 2) + ((PHB(k)+(PHB(k+1)) / 2) / 9.81 – HGT,</p>          </div><p>where PH and PHB are staggered in the vertical direction, meaning that they are at the tops and bottoms of grid cells. HGT is terrain height. This center height of grid cell is changing from model time to time based on definition of eta vertical coordinate system. You never get it fixed. So you cannot get the answer to your question by re-setting eta levels.</p><h1 id="wrf離地度設定與計算">WRF離地⾼度設定與計算</h1><p>WRF離地⾼度設定與計算, 簡單分享⼀個使⽤python計算wrfout中的離地⾼度程序，如下：</p><ul><li><code>"znu"</code> "eta values on half (mass) levels"</li><li><code>"znw"</code> "eta values on full (w) levels" ""</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> netCDF4 <span class="hljs-keyword">import</span> Dataset<br><span class="hljs-keyword">from</span> wrf <span class="hljs-keyword">import</span> getvar<br><span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np<br>np.set_printoptions(suppress=<span class="hljs-literal">True</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">main</span>(<span class="hljs-params">file_nc</span>):<br>    nc = Dataset(file_nc)<br>    hgt = getvar(nc, <span class="hljs-string">&#x27;HGT&#x27;</span>) <span class="hljs-comment"># &quot;HGT&quot; &quot;Terrain Height&quot;   &quot;m&quot; ij</span><br>    z = getvar(nc, <span class="hljs-string">&#x27;z&#x27;</span>)     <span class="hljs-comment"># z (geopotential /g)</span><br><br>    hei = z - hgt<br>    eta = getvar(nc, <span class="hljs-string">&#x27;ZNU&#x27;</span>)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;離地高度(m)為：&#x27;</span>)<br>    <span class="hljs-built_in">print</span>(hei.mean(dim=[<span class="hljs-string">&#x27;south_north&#x27;</span>, <span class="hljs-string">&#x27;west_east&#x27;</span>]).values)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;\neta值為：&#x27;</span>)<br>    <span class="hljs-built_in">print</span>(eta.values)<br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    file_in = <span class="hljs-string">r&#x27;F:\WRF\wrfout\DaiBu1\test\wrfout_d02_2016-01-01_00_00_00&#x27;</span><br>    main(file_in)<br></code></pre></td></tr></table></figure><p>其中 <code>HGT</code> 變數代表了地面海拔高度，在 geo_em 檔案中就存在了，而 <code>z</code> 代表了海平面高度，是一個診斷量，根據氣壓等值進行計算出來的。而ZNU代表了垂直方向上質量（Mass）格點的 eta 值，也就是可以在 namelist.input 中手動設定 eta_levels 後得到的，其中注意 <strong>eta_levels 為非交錯（Unstaggered）格點</strong>，數量比質量格點多1。</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs text">eta=(P-Ptop)/(Pbot-Ptop)<br></code></pre></td></tr></table></figure><p><code>P</code> 代表某一層的氣壓，也就是​​你需要研究的那一層， <code>Ptop</code> 代表模式頂層氣壓， <code>Pbot</code> 代表地面氣壓。 （WRF中好像是10hpa，不太確定）。從表達式可以看出，<strong>地面的eta值就是1，頂層就是0</strong>。這樣一來，無論某個地區的下墊面的海拔高度是多少，它的eta座標值都統一成1。</p><p>Outputs, <strong>e_vert = 54</strong></p><figure class="highlight console"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs console">離地高度(m)為：<br>[   25.79018    84.52496   159.36661   254.26878   373.91403   523.6823<br>   709.4084    936.94196  1211.5869   1537.3103   1915.9166   2346.727<br>  2826.5383   3351.045    3919.6106   4535.6753   5203.207    5926.446<br>  6709.601    7526.155    8336.745    9129.773    9904.727   10662.59<br> 11405.757   12136.74    12855.216   13558.873   14246.067   14916.217<br> 15570.322   16211.534   16845.14    17475.96    18106.285   18739.186<br> 19379.889   20031.79    20695.127   21368.908   22051.965   22742.492<br> 23437.81    24135.63    24835.205   25537.508   26244.611   26958.385<br> 27679.389   28406.797   29139.291   29875.842   30616.08   ]<br><br>eta值為：<br>[0.9970323  0.9902915  0.98175085 0.9710067  0.9576102  0.9410889<br> 0.92098445 0.8969075  0.8686075  0.83604616 0.79945725 0.759369<br> 0.7165741  0.6719424  0.6260139  0.57906395 0.53141975 0.4834582<br> 0.43560207 0.38982862 0.3482536  0.31100053 0.27762014 0.24770983<br> 0.22090887 0.19689405 0.1753757  0.15609428 0.13881733 0.1233364<br> 0.10946479 0.09703521 0.08589777 0.07591815 0.06697594 0.05896334<br> 0.0517837  0.04535042 0.03958592 0.03442067 0.02979238 0.02564523<br> 0.0219292  0.01859947 0.01561588 0.01294246 0.01054696 0.00840049<br> 0.00647715 0.00475375 0.00320951 0.0018258  0.00058594]<br></code></pre></td></tr></table></figure><p>加密低層層數，總共設定了40層質量格點，對應的 <code>&amp;domains</code> 組中的 <code>eta_levels</code> 設定如下：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs namelist"> eta_levels  = 1.0000, 0.9988, 0.9932, 0.9891, 0.9851,<br>0.9781, 0.9701, 0.9630, 0.9553, 0.8710,<br>0.811, 0.801, 0.782, 0.765, 0.732,<br>0.690, 0.652, 0.613, 0.582, 0.548,<br>0.503, 0.476, 0.432, 0.402, 0.375,<br>0.352, 0.314, 0.283, 0.251, 0.239,<br>0.218, 0.180, 0.152, 0.114, 0.089,<br>0.062, 0<br></code></pre></td></tr></table></figure><h1 id="choosing-an-appropriate-number-of-vertical-levels-e_vert">Choosing an appropriate number of vertical levels (e_vert)</h1><ul><li><a href="https://forum.mmm.ucar.edu/threads/choosing-an-appropriate-number-of-vertical-levels-e_vert.10682/">Choosing an appropriate number of vertical levels (e_vert)</a></li></ul><p>A better question for this is "what is the stretching rate I need to use?"</p><p>See <a href="https://www2.mmm.ucar.edu/wrf/users/wrf_users_guide/build/html/initialization.html#setting-model-vertical-levels">Setting Model Vertical Levels</a> in the WRF Users' Guide.</p><p>A good procedure to follow may be:</p><ol type="1"><li>Determine the model top pressure.</li><li>Determine how thick your lowest layer is (50 m by default)</li><li>Determine maximum thickness (1 km by default).</li></ol><p>Then based on your needs, the stretching rates can be chosen using the table in chapter 4 of UG (link above) as a guideline.</p><ol type="1"><li>Choose the stretching rate(s) - larger if you want fewer levels but it’s not recommended that the rate be &gt; 1.3.</li></ol><ol start="2" type="1"><li>Find the minimum number of levels that works for that stretching factor by iterating running real and changing e_vert. The minimum is the one that gives the smoothest variation in DNW, which can also be viewed in wrfinput as part of the process</li></ol><p>It is worth mentioning that when one chooses this method, the real program prints out the thickness of the layer, and it can be very good information for making adjustments for the stretching parameters.</p><p>*Additional Notes Smoothly varying vertical levels can be very important for model stability. Tests have shown that two different sets of vertical levels gives different numbers of CFL prints. For cases with dz &gt; dx (as can occur for dx &lt; 1 km at the top), tests have also shown that continuous stretching works through to the model top better than having many equal dz levels.</p><h1 id="wrf和cmaq-垂直層sigma座標設定">WRF和CMAQ 垂直層sigma座標設定</h1><ul><li><a href="https://aqmc.moenv.gov.tw/download/CMAQ/%E7%B6%B2%E6%A0%BC%E9%A1%9E%E5%85%AC%E5%91%8A%E6%A8%A1%E5%BC%8FCMAQ%E6%8A%80%E8%A1%93%E6%96%87%E4%BB%B6.pdf">網格類公告模式CMAQ 技術文件</a><ul><li>表1.3-3 WRF和CMAQ 垂直層sigma座標設定</li></ul></li></ul><table><thead><tr class="header"><th>LEVEL</th><th>SIGMA</th><th>氣壓(Pa)</th><th>Full LevelHeight (m)</th><th>Half LevelHeight (m)</th></tr></thead><tbody><tr class="odd"><td></td><td>1.000</td><td>100000</td><td>0</td><td></td></tr><tr class="even"><td>1</td><td>0.995</td><td>99550</td><td>38</td><td>19</td></tr><tr class="odd"><td>2</td><td>0.990</td><td>99100</td><td>76</td><td>57</td></tr><tr class="even"><td>3</td><td>0.980</td><td>98200</td><td>153</td><td>115</td></tr><tr class="odd"><td>4</td><td>0.960</td><td>96400</td><td>309</td><td>231</td></tr><tr class="even"><td>5</td><td>0.930</td><td>93700</td><td>548</td><td>429</td></tr><tr class="odd"><td>6</td><td>0.890</td><td>90100</td><td>878</td><td>713</td></tr><tr class="even"><td>7</td><td>0.850</td><td>86500</td><td>1221</td><td>1050</td></tr><tr class="odd"><td>8</td><td>0.800</td><td>82000</td><td>1671</td><td>1446</td></tr><tr class="even"><td>9</td><td>0.750</td><td>77500</td><td>2146</td><td>1909</td></tr><tr class="odd"><td>10</td><td>0.700</td><td>73000</td><td>2649</td><td>2398</td></tr><tr class="even"><td>11</td><td>0.650</td><td>68500</td><td>3185</td><td>2917</td></tr><tr class="odd"><td>12</td><td>0.600</td><td>64000</td><td>3757</td><td>3471</td></tr><tr class="even"><td>13</td><td>0.550</td><td>59500</td><td>4371</td><td>4064</td></tr><tr class="odd"><td>14</td><td>0.500</td><td>55000</td><td>5033</td><td>4702</td></tr><tr class="even"><td>15</td><td>0.450</td><td>50500</td><td>5751</td><td>5392</td></tr><tr class="odd"><td>16</td><td>0.400</td><td>46000</td><td>6537</td><td>6144</td></tr><tr class="even"><td>17</td><td>0.350</td><td>41500</td><td>7404</td><td>6971</td></tr><tr class="odd"><td>18</td><td>0.300</td><td>37000</td><td>8370</td><td>7887</td></tr><tr class="even"><td>19</td><td>0.250</td><td>32500</td><td>9462</td><td>8916</td></tr><tr class="odd"><td>20</td><td>0.200</td><td>28000</td><td>10716</td><td>10089</td></tr><tr class="even"><td>21</td><td>0.150</td><td>23500</td><td>12191</td><td>11454</td></tr><tr class="odd"><td>22</td><td>0.100</td><td>19000</td><td>13981</td><td>13086</td></tr><tr class="even"><td>23</td><td>0.050</td><td>14500</td><td>16256</td><td>15119</td></tr><tr class="odd"><td>24</td><td>0.000</td><td>10000</td><td>19384</td><td>17820</td></tr></tbody></table><h1 id="references">References</h1><ol type="1"><li><a href="https://forum.mmm.ucar.edu/threads/setting-first-layer-thickness.11680/">Setting first layer thickness</a></li><li><a href="https://forum.mmm.ucar.edu/threads/height-of-first-layer.9128/">height of first layer</a></li><li><a href="https://forum.mmm.ucar.edu/threads/calculate-height-of-first-model-layer.9831/">calculate height of first model layer</a></li><li><a href="https://forum.mmm.ucar.edu/threads/mapping-vertical-levels-to-physical-altitude.9906/">Mapping vertical levels to physical altitude</a></li><li><a href="https://forum.mmm.ucar.edu/threads/vertical-levels-adjustment.5638/">Vertical Levels Adjustment</a><ol type="1"><li><ol type="1"><li>To increase vertical levels below a specific height, I would suggest you run REAL program first to create eta levels. Then you can manually increase the number of levels based on the automatically generated eta levels by REAL. For example , suppose you run REAL and get the following eta levels: <figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs text">eta_levels =<br>1, 0.993, 0.983, 0.97, 0.954, 0.934, 0.909, 0.88,<br>....<br>....<br>/<br>You can then replace the first several eta levels by:<br>1, 0.999, 0.998, 0.996, 0.993, 0.990, 0.980. 0.970, 0.960, 0.950,<br>0.940, 0.930, 0.920, 0.910, 0.900, 0.890, 0.880, 0.870,<br></code></pre></td></tr></table></figure></li></ol></li><li>This is just an example to show how to add more levels within certain height</li><li><ol start="2" type="1"><li>Once wrfinput is produced, you will find <code>PH</code> and <code>PHB</code> in wrfinput, and <strong>(PH=PHB) is the geopotential height</strong> corresponding to model levels.</li></ol></li></ol></li><li><a href="https://forum.mmm.ucar.edu/threads/stretched-vertical-levels-information.14975/">Stretched vertical levels information?</a></li><li><a href="https://forum.mmm.ucar.edu/threads/does-the-real-program-generate-the-full-level-height-based-on-the-international-standard-atmosphere.16833/">Does the REAL program generate the Full level height based on the International Standard Atmosphere?</a></li><li><a href="https://forum.mmm.ucar.edu/threads/vertical-profile-of-wind.16348/">Vertical profile of Wind</a></li><li><a href="https://mp.weixin.qq.com/s/4txXV2kuYktlvasxkiKdeg">计算wrfout垂直层离地高度</a></li></ol>]]></content>
    
    
    <categories>
      
      <category>WRF</category>
      
    </categories>
    
    
    <tags>
      
      <tag>HPC</tag>
      
      <tag>NWP</tag>
      
      <tag>WRF</tag>
      
      <tag>MPAS</tag>
      
      <tag>UCM</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>WRF | MPAS | UCM and LCZs</title>
    <link href="/2025/01/27/WRF-MPAS-UCM-and-LCZs/"/>
    <url>/2025/01/27/WRF-MPAS-UCM-and-LCZs/</url>
    
    <content type="html"><![CDATA[<h1 id="wrf-ucm">WRF-UCM</h1><p>WRF-UCM refers to the Weather Research and Forecasting model (WRF) integrated with an Urban Canopy Model (UCM). This framework is designed to enhance the simulation of urban environments within meteorological models, allowing for more accurate predictions of weather patterns in urban areas.</p><h2 id="urban-canopy-model-ucm">Urban Canopy Model (UCM):</h2><p><strong>A single-layer model</strong> designed to represent urban environments. It incorporates simplified urban geometries and features such as building shadowing and heat exchange processes, improving the representation of lower boundary conditions in urban areas</p><h2 id="bepbem">BEP+BEM</h2><p>The <strong>Building Effect Parameterization (BEP) and Building Energy Model (BEM) scheme</strong> is an advanced modeling framework integrated within the Weather Research and Forecasting (WRF) model, designed to improve the simulation of urban climates.</p><ul><li>The BEM aspect incorporates building energy consumption factors, accounting for heating and cooling needs. This integration helps in assessing the urban heat budget more accurately by considering how energy use impacts local temperatures and climate conditions.</li></ul><h1 id="wrf-bug-fixupdated-ucm">WRF Bug-fix/updated UCM</h1><h2 id="new-features-in-wrfv4.6">New features in WRFV4.6</h2><ul><li>Add two options (slucm_distributed_drag and distributed_ahe_opt) to WRF SLUCM (sf_urban_physics = 1) so that <strong>spatially varying urban morphological parameters (building height, plan area index, frontal area index, roughness length for momentum, and displacement height) can be considered</strong>. <a href="https://github.com/wrf-model/WRF/commit/3cadf04277ac3a050e65461efb6aa939349c60a8">Detail</a><ul><li>SOURCE: Do Ngoc Khanh (Tokyo Institute of Technology)</li><li>This PR adds a new feature to WRF SLUCM by allowing consideration of <strong>spatially varying global distributed urban parameters and spatially hourly monthly varying anthropogenic heat</strong>.</li></ul></li></ul><h3 id="bug-fixes-and-enhancement-in-wrfv4.6">Bug fixes and enhancement in WRFV4.6</h3><ul><li>Correct net long wave fluxes for application in modeling urban climate using Single Layer Urban Canopy Model (SLUCM). It slightly improved 2-m temperature in urban area. <a href="https://github.com/wrf-model/WRF/commit/01228e7dfc0c4c257a7511e028088eddf3dfb388">Details</a></li></ul><h1 id="wrf-bug-fixupdated-lczs">WRF Bug-fix/updated LCZs</h1><h2 id="bug-fixes-and-enhancement-in-wrfv4.6-1">Bug fixes and enhancement in WRFV4.6</h2><ul><li>Fix a bug in Noah-MP for uninitialized leaf mass when LCZ is used. <a href="https://github.com/wrf-model/WRF/commit/554b12c81b081e068e24a0111ee360b528bb97b0">Detail</a></li><li><strong>Update urban LCZ parameter table (URBPARM_LCZ.TBL) with more reasonable values</strong>. <a href="https://github.com/wrf-model/WRF/commit/6156b78dfd350e0514d2455badcd7eab9b7d2d31">Detail</a></li><li>Make the Pleim-Xiu LSM compatible with MODIS LCZ. Also, effects of evaporation from transpiration, soil in both vegetated and non-veg parts and wet leaves on ground temperature all are considered. Previously only the effect from transpiration and evaporation from non-veg soil are considered. <a href="https://github.com/wrf-model/WRF/commit/b7f31dcde42beb4be468edb0541ec02f23b20455">Detail</a></li></ul><h2 id="wrf-version-4.5.1-bug-fix-release">WRF Version 4.5.1 (Bug-fix Release)</h2><ul><li><strong>Fix a bug in building height specification in the LCZ urban parameter table</strong>. <a href="https://github.com/wrf-model/WRF/commit/fb4be8f7b937283ee986db73690a9654bae70b4c">Details</a></li></ul><h2 id="wrf-version-v4.4.2-bug-fix-release">WRF Version v4.4.2 (Bug-fix Release)</h2><ul><li>Update urban local climate zone (LCZ) numbers in parameter tables to avoid overlap with existing NLCD land types. This update affects VEGPARM.TBL, LANDUSE.TBL, and MPTABLE.TBL. <strong>The LCZ numbers in WRF-urban are changed from 31-41 to 51-61</strong>. <a href="https://github.com/wrf-model/WRF/commit/61a1bde309838e2581a40e228b209ef418cd9cc2">Details</a></li><li>Fix the units and unit conversions of several variables in subroutines CARBON and CARBON_CROP (NoahMP scheme); update urban pixel identification by including LCZ urban types in module_sf_noahmpdrv.F for surface variable initialization. <a href="https://github.com/wrf-model/WRF/commit/75c5ddc0094a4630290bec58da8ff2609da1f2c0">Details</a></li></ul><h2 id="wrf-version-v4.3.1-release">WRF Version v4.3.1 Release</h2><ul><li><strong>Some of the urban parameter values for LCZ are changed to make them more generic</strong>.</li></ul><h2 id="wrf-version-4.3">WRF Version 4.3</h2><ul><li><strong>Implementation of Local Climate Zone (LCZ using WUDAPT (31-41) landuse classes, along with standard urban classes (31-33)</strong>. (Ref: Stewart, I.D. and Oke, T.R. (2012) Local Climate Zones for Urban Temperature Studies. Bulletin of the American Meteorological Society, 93, 1879-1900. <a href="http://dx.doi.org/10.1175/BAMS-D-11-00019.1" class="uri">http://dx.doi.org/10.1175/BAMS-D-11-00019.1</a>). More information can be found at <a href="https://ral.ucar.edu/sites/default/files/public/product-tool/urban-canopy-model/WRF_urban_update_Readme_file_WRF4.3.pdf" class="uri">https://ral.ucar.edu/sites/default/files/public/product-tool/urban-canopy-model/WRF_urban_update_Readme_file_WRF4.3.pdf</a>. Data from <a href="https://www.wudapt.org/" class="uri">https://www.wudapt.org/</a> is required. Note that the parameters in the new urban table, URBPARM_LCZ.TBL, may vary greatly from city to city. The default values are probably not appropriate for any given city. Users should adapt these values based on the city they are working with.</li></ul><div class="note note-primary">            <p><a href="https://waipangsze.github.io/2024/10/07/Global-LCZ-for-Urban/">Global-LCZ-for-Urban</a></p>          </div><h1 id="w2w">W2W</h1><ul><li><a href="https://joss.theoj.org/papers/10.21105/joss.04432.pdf">Demuzere, M., Argüeso, D., Zonato, A., &amp; Kittner, J. (2022). W2W: A Python package that injects WUDAPT's Local Climate Zone information in WRF. Journal of Open Source Software, 7(76), 4432.</a><ul><li>The Python-based WUDAPT-to-WRF (W2W) package is developed to translate Local Climate Zone (LCZ) maps into urban canopy parameters readable by WRF</li></ul></li></ul><figure class="highlight console"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs console"><span class="hljs-meta prompt_"># </span><span class="language-bash">w2w.py</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">A WUDAPT-to-WRF python tool that injects WUDAPT<span class="hljs-string">&#x27;s Local Climate Zone information into WRF.</span></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash"><span class="hljs-string">Install</span></span><br>pip install w2w<br><span class="hljs-meta prompt_"># </span><span class="language-bash"><span class="hljs-string">Install from GitHub:</span></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash"><span class="hljs-string">pip install git+https://github.com/matthiasdemuzere/w2w</span></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash"><span class="hljs-string">Run the tool</span></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash"><span class="hljs-string">Check out its help:</span></span><br>w2w --help<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash"><span class="hljs-string">Try with the provided sample:</span></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash"><span class="hljs-string">Sample data used here can be downloaded from the repository in the sample_data folder. After clicking on the file you can download it.</span></span><br>w2w ./sample_data lcz_zaragoza.tif geo_em.d04.nc<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash"><span class="hljs-string">Deploy using your own data:</span></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash"><span class="hljs-string">w2w INPUT_DIRECTORY YOUR_LCZ.TIF YOUR_GEO_EM.d0X.NC</span></span><br></code></pre></td></tr></table></figure><p><img src="https://i.imgur.com/pUxBAbG.png" width="500" /></p><h1 id="steps-to-run-ucm-on-wrf">Steps to Run UCM on WRF</h1><h2 id="prepare-the-environment">1. Prepare the Environment</h2><ul><li>Ensure you have the WRF model installed and configured properly on your system.</li><li>Download or prepare an <strong>urban land-use dataset</strong> if you want to use a specific urban area map. If not, you can use the default land-use map.</li></ul><h2 id="modify-the-configuration-files">2. Modify the Configuration Files</h2><ul><li><strong>Namelist Configuration</strong>:<ul><li>Open the <code>namelist.input</code> file in your WRF directory.</li><li>Set the <code>sf_urban_physics</code> option to <code>1</code> to enable UCM: <figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs text">sf_urban_physics = 1<br></code></pre></td></tr></table></figure><ul><li>For LCZs, <code>“&amp; physics”</code> section of WRF namelist.input: <code>use_wudapt_lcz =1</code> (set to 0 by default).</li></ul></li><li>Ensure that you set this option for every domain you plan to run.</li></ul></li><li><strong>Registry Modifications</strong>:<ul><li>Edit the <code>Registry.EM</code> file located in the <code>Registry/</code> directory. Add an 'h' in the appropriate column to enable output of urban canopy variables in your output files.</li></ul></li></ul><h2 id="prepare-urban-parameters">3. Prepare Urban Parameters</h2><ul><li>Modify the <code>URBPARM.TBL</code> file located in the <code>run/</code> directory to adjust urban parameters according to your study area. This includes parameters like building height, surface albedo, and anthropogenic heat emissions.</li></ul><h2 id="error-warning-too-many-input-landuse-types">ERROR: Warning: too many input landuse types</h2><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs text">ERROR: ------------------------------ FATAL CALLED ------------------------------<br>ERROR: Warning: too many input landuse types<br>CRITICAL ERROR: MPAS core_physics abort<br><br>./MPAS/src/core_atmosphere/physics/physics_wrf/module_sf_noahlsm.F:2437:                     FATAL_ERROR( &#x27;Warning: too many input landuse types&#x27; )<br><br>open(land_unit,file=&#x27;LANDUSE.TBL&#x27;,action=&#x27;READ&#x27;,status=&#x27;OLD&#x27;,iostat=istat)<br><br>./MPAS/src/core_atmosphere/physics/mpas_atmphys_landuse.F:180:       read(unit=land_unit,fmt=*) lucats,luseas<br>./MPAS/src/core_atmosphere/physics/mpas_atmphys_landuse.F:183:          write(mess,*) &#x27;   landuse type = &#x27; // trim (lutype) // &#x27; found&#x27;, lucats, &amp;<br></code></pre></td></tr></table></figure><ul><li>Renew your <code>*.TBL</code> for different version of WRF.</li></ul><h1 id="urbparm.tbl">URBPARM.TBL</h1><ul><li>The appropriate urban parameters are highly variable from city to city (e.g., some cities may have wide roads and short buildings, other cities may have narrow roads and tall buildings). For best use of the urban canopy models, these parameters should be tuned specifically for the city of interest.</li><li><a href="https://ral.ucar.edu/sites/default/files/public/images/product_tool/urbparm.html" class="uri">https://ral.ucar.edu/sites/default/files/public/images/product_tool/urbparm.html</a></li><li><a href="https://github.com/wrf-model/WRF/blob/master/run/URBPARM.TBL" class="uri">https://github.com/wrf-model/WRF/blob/master/run/URBPARM.TBL</a></li><li><a href="https://github.com/wrf-model/WRF/blob/master/run/URBPARM_LCZ.TBL" class="uri">https://github.com/wrf-model/WRF/blob/master/run/URBPARM_LCZ.TBL</a></li></ul>    <div class="fold">      <div class="fold-title fold-info collapsed" data-toggle="collapse" href="#collapse-1ea9d76f" role="button" aria-expanded="false" aria-controls="collapse-1ea9d76f">        <div class="fold-arrow">▶</div>URBPARM.TBL      </div>      <div class="fold-collapse collapse" id="collapse-1ea9d76f">        <div class="fold-content">          <table><thead><tr class="header"><th>URBPARM.TBL</th><th></th></tr></thead><tbody><tr class="odd"><td>ZR</td><td>Roof level (building height) [m]</td></tr><tr class="even"><td>ROOF_WIDTH</td><td>Roof (i.e., building) width [m]</td></tr><tr class="odd"><td>ROAD_WIDTH</td><td>Road width [m]</td></tr><tr class="even"><td>AH</td><td>Anthropogenic heat [W m-2]</td></tr><tr class="odd"><td>FRC_URB</td><td>Fraction of the urban landscape which does not have natural vegetation. [Fraction]</td></tr><tr class="even"><td>CAPR</td><td>Heat capacity of roof [J m-3 K-1]</td></tr><tr class="odd"><td>CAPB</td><td>Heat capacity of building wall [ J m-3 K-1]</td></tr><tr class="even"><td>CAPG</td><td>Heat capacity of ground (road) [J m-3 K-1]</td></tr><tr class="odd"><td>AKSR</td><td>Thermal conductivity of roof [J m-1 s-1 K-1]</td></tr><tr class="even"><td>AKSB</td><td>Thermal conductivity of building wall [J m-1 s-1 K-1]</td></tr><tr class="odd"><td>AKSG</td><td>Thermal conductivity of ground (road) [J m-1 s-1 K-1]</td></tr><tr class="even"><td>ALBR</td><td>Surface albedo of roof [fraction]</td></tr><tr class="odd"><td>ALBB</td><td>Surface albedo of building wall [fraction]</td></tr><tr class="even"><td>ALBG</td><td>Surface albedo of ground (road) [fraction]</td></tr><tr class="odd"><td>EPSR</td><td>Surface emissivity of roof [-]</td></tr><tr class="even"><td>EPSB</td><td>Surface emissivity of building wall [-]</td></tr><tr class="odd"><td>EPSG</td><td>Surface emissivity of ground (road) [-]</td></tr><tr class="even"><td>Z0R</td><td>Roughness length for momentum, over roof [m]</td></tr><tr class="odd"><td>Z0B</td><td>Roughness length for momentum, over building wall [m] Only active for CH_SCHEME == 1</td></tr><tr class="even"><td>Z0G</td><td>Roughness length for momentum, over ground (road) [m] Only active for CH_SCHEME == 1</td></tr><tr class="odd"><td>CH_SCHEME</td><td>Ch of Wall and Road [1: M-O Similarity Theory, 2: Empirical Form of Narita et al., 1997 (recommended)]</td></tr><tr class="even"><td>TS_SCHEME</td><td>Surface and Layer Temperatures [1: 4-layer model, 2: Force-Restore method]</td></tr><tr class="odd"><td>AHOPTION</td><td>[0: No anthropogenic heating, 1: Anthropogenic heating will be added to sensible heat flux term]</td></tr><tr class="even"><td>AHDIUPRF</td><td>Anthropogenic Heating diurnal profile. Multiplication factor applied to AH (as defined in the table above) Hourly values ( 24 of them ), starting at 01 hours Local Time. For sub-hourly model time steps, value changes on the hour and is held constant until the next hour.</td></tr></tbody></table>        </div>      </div>    </div><h1 id="anthropogenic-heating-ah">Anthropogenic Heating (AH)</h1><p>The parameters for urban land surface are highly case-dependent. The default values given in WRF are based on a few observations and I don't think they are representative. One must adjust these values based on one's specific case. However, we don't have more information about how to specify the values. there is little publications discussing this issue. So they are more empirical. It is needed to <code>set AHOPTION and ALHOPTION to 1</code> if you want to activate anthropogenic heating. Again, note that these values are also case-dependent. They may not well apply to your case. You probably need to do lots of tuning.</p><ul><li><a href="https://agupubs.onlinelibrary.wiley.com/doi/pdfdirect/10.1002/2015GL067628">Holst, Christopher Claus, Chi‐Yung Tam, and Johnny CL Chan. "Sensitivity of urban rainfall to anthropogenic heat flux: A numerical experiment." Geophysical Research Letters 43.5 (2016): 2240-2248.</a></li></ul><h1 id="roughness-length">Roughness length</h1><p>The roughness length is a crucial parameter that influences the simulation of wind profiles and heat exchange in urban areas.</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs text">#<br># Ch of Wall and Road [ 1: M-O Similarity Theory, 2: Empirical Form of Narita et al., 1997 (recommended) ]<br>#      (sf_urban_physics=1)<br>#<br><br>CH_SCHEME: 2<br><br>#<br># Z0B:  Roughness length for momentum, over building wall [ m ]<br>#       Only active for CH_SCHEME == 1<br>#      (sf_urban_physics=1)<br>#<br><br>Z0B: 0.0001, 0.0001, 0.0001<br><br>#<br># Z0G:  Roughness length for momentum, over ground (road) [ m ]<br>#       Only active for CH_SCHEME == 1<br>#      (sf_urban_physics=1,2,3)<br>#<br><br>Z0G: 0.01, 0.01, 0.01<br></code></pre></td></tr></table></figure><p>Set <code>Roughness length</code> Only <code>active for CH_SCHEME == 1</code>,</p><p>and, <a href="https://github.com/wrf-model/WRF/blob/d66e442fccc04111067e29274c9f9eaccc3cef28/phys/module_sf_urban.F#L83" class="uri">https://github.com/wrf-model/WRF/blob/d66e442fccc04111067e29274c9f9eaccc3cef28/phys/module_sf_urban.F#L83</a></p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs text">!  CH_SCHEME [integer 1 or 2] : Sfc exchange scheme used for building wall and road<br>!                         [1: M-O Similarity Theory,  2: Empirical Form (recommend)]<br></code></pre></td></tr></table></figure><ul><li><a href="https://forum.mmm.ucar.edu/threads/the-surface-roughness-issue-in-ucm.11533/">The surface roughness issue in UCM</a></li><li><a href="https://forum.mmm.ucar.edu/threads/why-roughness-znt-of-urban-is-lower-than-croplands-in-ucm.11006/">Why roughness(ZNT) of Urban is lower than Croplands in UCM?</a><ul><li>I have tried to modify <code>module_sf_urban.F</code> to change the calculation of Z0C to find whether the calculation of surface roughness in the Urban Canopy Model would influence the output of ZNT from wrfout files. But I find that the change in Z0C will not impact the output of ZNT that ZNT in wrfout files kept about 0.12 no matter how Z0C change.</li></ul></li></ul><div class="group-image-container"><div class="group-image-row"><div class="group-image-wrap"><img src="https://i.imgur.com/gQRdbHS.png" /></div><div class="group-image-wrap"><img src="https://i.imgur.com/mkjsJYt.png" /></div></div><div class="group-image-row"><div class="group-image-wrap"><img src="https://i.imgur.com/SBmM5A8.png" /></div><div class="group-image-wrap"><img src="https://i.imgur.com/XZWd0rk.png" /></div></div></div><p>In above Figure 2,</p><ul><li>left is theta level is 83m, and 1st level is 166m</li><li>right is theta level is ~23m, and 1st level is ~46m</li></ul><h2 id="papars">Papars</h2><ul><li><a href="https://lbezone.hkust.edu.hk/pdfviewer/web/viewer.php?file=aHR0cHM6Ly9sYmV6b25lLmhrdXN0LmVkdS5oay9vYmovMS9vLzk5MTAxMjYzNDk2NzMwMzQxMi85OTEwMTI2MzQ5NjczMDM0MTIucGRm#page=1">Yeung, Pak Shing. Refinement of surface roughness length for the weather research and forecasting model. Diss. 2018.| HKUST</a></li></ul><h1 id="zdc-z0c-2m-is-larger-than-the-1st-wrf-level-stop-in-subroutine-urban---change-zdc-and-z0c">ZDC + Z0C + 2m is larger than the 1st WRF level Stop in subroutine urban - change ZDC and Z0C</h1><figure class="highlight fortran"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs fortran"><span class="hljs-comment">!    ZDC [m]             : Zero plane displacement height (1/5 of ZR)</span><br><span class="hljs-comment">!    Z0C [m]             : Roughness length above canyon for momentum (1/10 of ZR)</span><br><span class="hljs-comment">!     ZA     [m]     : First atmospheric level</span><br><span class="hljs-comment">!                      as a lowest boundary condition</span><br></code></pre></td></tr></table></figure><ul><li>Calculate the following urban canyon geometry parameters following <a href="https://www.sciencedirect.com/science/article/abs/pii/S1352231097004032">Macdonald's (1998) formulations, Macdonald, R. W., Griffiths, R. F., &amp; Hall, D. J. (1998). An improved method for the estimation of surface roughness of obstacle arrays. Atmospheric environment, 32(11), 1857-1864</a>.</li></ul>    <div class="fold">      <div class="fold-title fold-info collapsed" data-toggle="collapse" href="#collapse-738764b7" role="button" aria-expanded="false" aria-controls="collapse-738764b7">        <div class="fold-arrow">▶</div>module_sf_urban.F      </div>      <div class="fold-collapse collapse" id="collapse-738764b7">        <div class="fold-content">          <figure class="highlight fortran"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs fortran"><span class="hljs-comment">! Parameters derived from the morphological terms above.</span><br><span class="hljs-comment">! These parameters are computed in the code.</span><br><span class="hljs-comment">!</span><br><span class="hljs-comment">!    HGT [-]             : normalized building height</span><br><span class="hljs-comment">!    SVF [-]             : sky view factor</span><br><span class="hljs-comment">!    R   [-]             : Normalized roof width (a.k.a. &quot;building coverage ratio&quot;)</span><br><span class="hljs-comment">!    RW  [-]             : = 1 - R</span><br><span class="hljs-comment">!    Z0C [m]             : Roughness length above canyon for momentum (1/10 of ZR)</span><br><span class="hljs-comment">!    Z0HC [m]            : Roughness length above canyon for heat (1/10 of Z0C)</span><br><span class="hljs-comment">!    ZDC [m]             : Zero plane displacement height (1/5 of ZR)</span><br><br>......<br><br>Cd         = <span class="hljs-number">1.2</span><br>alpha_macd = <span class="hljs-number">4.43</span><br>beta_macd  = <span class="hljs-number">1.0</span><br><br>......<br><br>      ZDC = ZR * ( <span class="hljs-number">1.0</span> + ( alpha_macd ** ( -R ) )  * ( R - <span class="hljs-number">1.0</span> ) )<br><br>      Z0C = ZR * ( <span class="hljs-number">1.0</span> - ZDC/ZR ) * &amp;<br>           <span class="hljs-built_in">exp</span> (-(<span class="hljs-number">0.5</span> * beta_macd * Cd / (VonK**<span class="hljs-number">2</span>) * ( <span class="hljs-number">1.0</span>-ZDC/ZR) * lambda_f )**(-<span class="hljs-number">0.5</span>))<br><br>   <span class="hljs-keyword">IF</span>( ZDC+Z0C+<span class="hljs-number">2.</span> &gt;= ZA) <span class="hljs-keyword">THEN</span><br>    <span class="hljs-keyword">CALL</span> wrf_error_fatal (<span class="hljs-string">&quot;ZDC + Z0C + 2m is larger than the 1st WRF level &quot;</span>// &amp;<br>                           <span class="hljs-string">&quot;Stop in subroutine urban - change ZDC and Z0C&quot;</span> ) <br>   <span class="hljs-keyword">END</span> <span class="hljs-keyword">IF</span><br><br>......<br><br>      <span class="hljs-comment">! The following urban canyon geometry parameters are following Macdonald&#x27;s (1998) formulations</span><br>      <br>      <span class="hljs-comment">! Lambda_P :: Plan areal fraction, which corresponds to R for a 2-d canyon.</span><br>      <span class="hljs-comment">! Lambda_F :: Frontal area index, which corresponds to HGT for a 2-d canyon</span><br>      <span class="hljs-comment">! Cd       :: Drag coefficient ( 1.2 from Grimmond and Oke, 1998 )</span><br>      <span class="hljs-comment">! Alpha_macd :: Emperical coefficient ( 4.43 from Macdonald et al., 1998 )</span><br>      <span class="hljs-comment">! Beta_macd  :: Correction factor for the drag coefficient ( 1.0 from Macdonald et al., 1998 )</span><br><br>      Lambda_P = R_TBL(LC)<br>      Lambda_F = HGT_TBL(LC)<br>      Cd         = <span class="hljs-number">1.2</span><br>      alpha_macd = <span class="hljs-number">4.43</span> <br>      beta_macd  = <span class="hljs-number">1.0</span><br><br>......<br></code></pre></td></tr></table></figure>        </div>      </div>    </div><h1 id="how-is-10m-wind-speed-computed">How is 10m wind speed computed?</h1><p>Generally 10m wind is computed based on the <code>Monin-Obukhov similarity theory</code>; however, please see <code>phys/module_sf_myjsfc.F</code> regarding the MYJ PBL. For the MM5 surface layer option, see <code>module_sf_sfclay.F</code>. The ARW Technical Note lists published papers that discuss this, if you are interested in reading more.</p><ul><li><a href="https://forum.mmm.ucar.edu/threads/how-is-10m-wind-speed-computed.75/" class="uri">https://forum.mmm.ucar.edu/threads/how-is-10m-wind-speed-computed.75/</a></li></ul><h1 id="literature-review">Literature Review</h1><ul><li><a href="https://ams.confex.com/ams/pdfpapers/79765.pdf">Chen, Fei, et al. "<strong>Utilizing the coupled WRF/LSM/Urban modeling system with detailed urban classification</strong> to simulate the urban heat island phenomena over the Greater Houston area." Fifth Symposium on the Urban Environment. Vol. 25. American Meteorological Society Vancouver, BC, Canada, 2004.</a></li><li><a href="https://www.jstage.jst.go.jp/article/jmsj/82/1/82_1_67/_pdf">Kusaka, Hiroyuki, and Fujio Kimura. "<strong>Coupling a single-layer urban canopy model with a simple atmospheric model</strong>: Impact on urban heat island simulation for an idealized case." Journal of the Meteorological Society of Japan. Ser. II 82.1 (2004): 67-80.</a></li><li><a href="https://pdxscholar.library.pdx.edu/cgi/viewcontent.cgi?article=1045&amp;context=mengin_fac">Chen, Fei, et al. "<strong>The integrated WRF/urban modeling system</strong>: development, evaluation, and applications to urban environmental problems." (2011).</a></li><li><a href="https://www.jstage.jst.go.jp/article/jmsj/90B/0/90B_2012-B03/_pdf">Kusaka, Hiroyuki, et al. "<strong>Numerical simulation of urban heat island effect by the WRF model with 4-km grid increment</strong>: An inter-comparison study between the urban canopy model and slab model." 気象集誌. 第 2 輯 90.0 (2012): 33-45.</a></li><li><a href="http://ir.lib.ncu.edu.tw:88/thesis/view_etd.asp?URN=103621004"><strong>利用 WRF/Urban Canopy Model 模擬探討台灣北部都市地區之熱島效應</strong>. 2016. PhD Thesis. National Central University.</a></li><li><a href="https://www.researchgate.net/profile/Huidong-Li-3/publication/328053113_Quantifying_urban_heat_island_intensity_and_its_physical_mechanism_using_WRFUCM/links/616a2df6039ba26844489530/Quantifying-urban-heat-island-intensity-and-its-physical-mechanism-using-WRF-UCM.pdf">Li, Huidong, et al. "<strong>Quantifying urban heat island intensity</strong> and its physical mechanism using WRF/UCM." Science of the total environment 650 (2019): 3110-3119.</a></li><li><a href="https://agupubs.onlinelibrary.wiley.com/doi/pdf/10.1002/2017JD026702">Wang, Yi, et al. "Impact of <strong>land surface heterogeneity on urban heat island</strong> circulation and sea‐land breeze circulation in <strong>Hong Kong</strong>." Journal of Geophysical Research: Atmospheres 122.8 (2017): 4332-4352.</a></li><li><a href="https://agupubs.onlinelibrary.wiley.com/doi/pdfdirect/10.1029/2021JD035348">Kim, G., Cha, D. H., Song, C. K., &amp; Kim, H. (2021). <strong>Impacts of anthropogenic heat and building height</strong> on urban precipitation over the Seoul metropolitan area in regional climate modeling. Journal of Geophysical Research: Atmospheres, 126(23), e2021JD035348.</a></li></ul><h2 id="cuhk">CUHK</h2><ul><li><a href="https://doi.org/10.1029/2024JD040915">Hu, C., C.-Y. Tam, Z. Li, J. Chen, Y. Li, K.K.W. Cheung, Z.-L. Yang, J.-E. Chu and T. N. Chow, 2024: <strong>Impacts of Urban Heat and Surface Roughness</strong> on Landfalling Tropical Cyclone Intensity: A Case Study based on TC Victor (1997) in Coastal South China, J. Geophys. Res., 129, e2024JD040915.</a><ul><li>urban surface roughness contributes to a decrease in postlandfall storm intensity through frictional energy dissipation</li><li>the roughness of the city's surface also helped to weaken the storm because of the friction.</li></ul></li><li><a href="https://doi.org/10.1007/s00376-024-4114-x">Hu, C., C.-Y. Tam and Z. Wang, 2024: <strong>Urbanization Impacts on South China Greater Bay Area Extreme Rainfall</strong> - Sensitivity to Synoptic Systems during Pre-monsoon Period Climate Dynamics, Adv. Atmos. Sci., https://doi.org/10.1007/s00376-024-4114-x</a></li><li><a href="https://www.nature.com/articles/s41598-024-52193-2q">Hu, C., C.-Y. Tam, Z.-L. Yang and Z. Wang, 2024: <strong>Analyzing Urban Influence on Extreme Winter Precipitation</strong> through Observations and Numerical Simulation of Two South China Case Studies, Scientific Reports, https://www.nature.com/articles/s41598-024-52193-2q</a></li></ul><h2 id="hko">HKO</h2><ul><li><a href="https://www.hko.gov.hk/hko/publica/reprint/r923.pdf">Mok, Hing Yim, Man Chi Wu, and Cheuk Yin Cheng. "Spatial variation of the characteristics of urban heat island effect in Hong Kong." Journal of Civil Engineering and Architecture 5.9 (2011): 779-786.</a></li><li><a href="https://www.climatechange.edu.hk/cause-of-climate-change/7-3-zh-%E9%A6%99%E6%B8%AF%E7%9A%84%E6%B0%A3%E5%80%99%E8%AE%8A%E5%8C%96%E5%8F%88%E6%98%AF%E6%80%8E%E6%A8%A3%E5%91%A2%EF%B9%96/7-3-2-zh-%E5%9F%8E%E5%B8%82%E7%99%BC%E5%B1%95%E5%A6%82%E4%BD%95%E5%BD%B1%E9%9F%BF%E9%A6%99%E6%B8%AF%E7%9A%84%E6%B0%A3%E5%80%99/?lang=zh-hant">城市發展如何影響香港的氣候 | 城市熱島效應</a><ul><li>全球暖化及本地城市發展皆會影響香港的氣候，根據天文台的研究，城市發展對香港長期暖化趨勢的貢獻估計可達百分之五十。</li><li>在香港，熱島效應基本上是夜間現象，它在冬季時較為顯著，尤其是在大氣穩定、微風及天朗氣清的日子最為明顯。</li><li><strong>香港的高樓建築及高密度城市發展增加了地面的磨擦力及阻擋空氣流動，降低市區內部風速</strong>。圖3.7顯示1968至2015年間横瀾島的年均風速無明顯的趨勢，而位於市區的京士柏年均風速則明顯下降。</li></ul></li><li><a href="https://www.climatechange.edu.hk/cause-of-climate-change/7-3-zh-%e9%a6%99%e6%b8%af%e7%9a%84%e6%b0%a3%e5%80%99%e8%ae%8a%e5%8c%96%e5%8f%88%e6%98%af%e6%80%8e%e6%a8%a3%e5%91%a2%ef%b9%96/7-3-3-zh-%e5%be%ae%e6%b0%a3%e5%80%99/?lang=zh-hant#source">微氣候</a></li></ul><h2 id="hk-planning-department">HK Planning Department</h2><ul><li><a href="https://www.tpb.gov.hk/en/papers/TPB/1001-tpb_8972.pdf">Urban Climatic Map and Standards for Wind Environment | 2011</a><ul><li><a href="https://www.eeb.gov.hk/sites/default/files/susdev/html/en/council/SSCPaper02-12Att2e.pdf" class="uri">https://www.eeb.gov.hk/sites/default/files/susdev/html/en/council/SSCPaper02-12Att2e.pdf</a></li></ul></li></ul><h2 id="tw-cwa-天氣分析與預報研討會">TW CWA: 天氣分析與預報研討會</h2><ul><li><a href="https://conf.cwa.gov.tw/media/cwa_past_conferences/106/2017_ppt/A2/A2-37-2017_%E5%A4%A9%E6%B0%A3%E5%88%86%E6%9E%90%E8%88%87%E9%A0%90%E5%A0%B1%E8%A8%8E%E8%AB%96%E6%9C%83_%E6%9E%97%E4%BC%AF%E5%8B%B3_V2.pdf">Urban Canopy Model對高解析度模式預報影響之探討 | 林伯勳、洪景山 | 2017.09.13</a></li></ul><h1 id="references">References</h1><ol type="1"><li><a href="https://citeseerx.ist.psu.edu/document?repid=rep1&amp;type=pdf&amp;doi=89e976035880446f1e33a9f8492af4da05a2b011">Tewari, M., Chen, F., Kusaka, H., &amp; Miao, S. (2007). Coupled WRF/Unified Noah/urban-canopy modeling system. Ncar WRF Documentation, NCAR, Boulder, 122, 1-22.</a></li><li><a href="https://agupubs.onlinelibrary.wiley.com/doi/pdf/10.1002/2015JD024450">Barlage, Michael, Shiguang Miao, and Fei Chen. "Impact of physics parameterizations on high‐resolution weather prediction over two Chinese megacities." Journal of Geophysical Research: Atmospheres 121.9 (2016): 4487-4498.</a></li><li><a href="https://scholarsarchive.byu.edu/cgi/viewcontent.cgi?article=7694&amp;context=facpub">Smithson, C. L., White, N. J., Klomp, H. R., Monson, E. C., &amp; Adams, B. R. (2023). User Guide for Urban Canopy Modeling in WRF. Version 1.0.</a></li><li><a href="https://ral.ucar.edu/sites/default/files/public/product-tool/urban-canopy-model/WRF_urban_update_Readme_file_WRF4.3.pdf">Updates of WRF-urban in WRF 4.3: Local Climate Zones, Mitigation Strategies, building materials permeability and new buildings drag coefficient | March 24, 2021</a><ol type="1"><li>implemented in WRF, allows now to incorporate 11 urban classes corresponding to the WUDAPT(<a href="http://www.wudapt.org/" class="uri">http://www.wudapt.org/</a>) Local Climate Zones (LCZ)</li><li><code>“&amp; physics”</code> section of WRF namelist.input: <code>use_wudapt_lcz =1</code> (set to 0 by default).</li></ol></li><li><a href="https://ral.ucar.edu/sites/default/files/public/product-tool/urban-canopy-model/README_BEP_BEM_MODIFICATIONS.pdf">The new version of the BEP+BEM scheme in WRF 4.3: Local Climate Zones, Mitigation Strategies, building materials permeability and new buildings drag coefficient | February 10, 2021</a><ol type="1"><li>The new version of the <strong>BEP+BEM urban multilayer scheme</strong>, implemented in WRF, allows now to incorporate 10 urban classes corresponding to the WUDAPT (<a href="http://www.wudapt.org/" class="uri">http://www.wudapt.org/</a>) Local Climate Zones (LCZ).</li></ol></li><li><a href="https://mp.weixin.qq.com/s/BIXCzU-QTBGkOVyBRJ8aEQ">城市气象模拟的1、2、3（上）| 朱浩楠 | 2016年09月30日</a></li></ol>]]></content>
    
    
    <categories>
      
      <category>WRF</category>
      
    </categories>
    
    
    <tags>
      
      <tag>HPC</tag>
      
      <tag>NWP</tag>
      
      <tag>WRF</tag>
      
      <tag>MPAS</tag>
      
      <tag>UCM</tag>
      
      <tag>LCZs</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ML | ResNet</title>
    <link href="/2025/01/26/ML-ResNet/"/>
    <url>/2025/01/26/ML-ResNet/</url>
    
    <content type="html"><![CDATA[<h1 id="殘差網路概述">殘差網路概述</h1><p><strong>殘差神經網路</strong>（Residual Neural Network，簡稱 <strong>ResNet</strong> ） 是一種深度學習模型，<strong>旨在解決傳統深度神經網路中常見的梯度消失和梯度爆炸問題</strong>。這種網路的核心理念是讓每一層學習與輸入之間的殘差，而非直接學習預期的輸出。這樣的設計使得訓練更深層的模型變得更為有效，並且在增加層數時能保持甚至提高準確率。</p><p><strong>ResNet 透過 殘差學習解決了深度網路的退化問題，讓我們可以訓練出更深的網絡</strong>，這稱得上是深度網絡的一個歷史大突破吧。</p><h2 id="殘差塊-residual-block">殘差塊 (Residual Block)</h2><p>ResNet的基本單位是殘差塊（<strong>Residual Block</strong>），每個殘差塊都包含一個短路連接（<strong>shortcut connection</strong>），這是一條將輸入直接連接到輸出的路徑。這樣，即使在反向傳播過程中出現梯度消失或爆炸，捷徑連接也能確保梯度順利流動，從而促進學習。</p><p>ResNet 的核心在於其殘差塊。每個殘差塊包含一個捷徑連接，<strong>這條連接將輸入直接加到輸出上</strong>。這樣做的目的是讓網路能夠學習到恒等映射，即使在其他層出現梯度消失時，捷徑連接仍能確保梯度能夠有效反向傳播。</p><p>具體而言，假設 <span class="math inline">\(x\)</span> 是輸入，<span class="math inline">\(F(x)\)</span> 是通過卷積和激活函數計算出的映射，那麼殘差塊的輸出可以表示為：</p><p><span class="math display">\[H(x) = F(x) + x\]</span></p><p>當網絡學會了恒等映射時，即 <span class="math inline">\(F(x) = 0\)</span>，則輸出 <span class="math inline">\(H(x)\)</span> 就等於輸入 <span class="math inline">\(x\)</span>。這樣，即使 <span class="math inline">\(F(x)\)</span> 的梯度為0，捷徑連接仍然能夠保證前面層的梯度不會消失</p><p>ResNet的作者何愷明也因此摘得CVPR2016最佳論文獎，當然何博士的成就遠不止於此，感興趣的可以去搜一下他後來的輝煌戰績。是解決了深度CNN模型難見訓練的問題，從圖2中可以<strong>14年的VGG才19層</strong>，而<strong>15年的ResNet多達152層</strong>，這在網絡深度如果完全不是一個量級上，所以是第一眼看這張圖的話，一定會覺得ResNet是靠深度取勝。</p><h2 id="梯度消失的本質">梯度消失的本質</h2><p>在傳統的深度神經網路中，隨著層數的增加，梯度在反向傳播過程中會逐漸變小，最終導致更新無法進行。這是因為每一層的輸出依賴於前面各層的輸出，當激活函數的導數小於1時，梯度會隨著層數增加而減少，形成梯度消失現象。</p><h3 id="退化問題degradation-problem">退化問題（Degradation problem）</h3><p>實驗發現深度網路出現了<strong>退化問題（Degradation problem）</strong>：網路深度增加時，網路準確度出現飽和，甚至出現下降。這個現象可以在直觀看出來：56層的網路 比 20層網路效果還要差。這不會是過度擬合問題，因為56層網路的訓練誤差同樣高。<strong>我們知道深層網路存在著梯度消失或爆炸的問題</strong>，這使得深度學習模型很難訓練。但是現在已經存在一些技術手段如 BatchNorm 來緩解這個問題。深度網路的退化問題至少說明深度網路不容易訓練。但我們考慮這樣一個事實：現在你有一個淺層網絡，你想透過向上堆積新層來建立深層網絡，一個極端情況是這些增加的層什麼也不學習，僅僅複製淺層網絡的特徵，即這樣新層是恆等映射（Identity mapping）。在這種情況下，深層網路應該至少和淺層網路效能一樣，也不應該出現退化現象。好吧，你不得不承認肯定是目前的訓練方法有問題，才使得深層網路很難去找到一個好的參數。</p><h2 id="工作原理">工作原理</h2><h3 id="批歸一化batch-normalization">批歸一化（Batch Normalization）</h3><p><strong>批歸一化</strong>是一種正則化技術，用於減少內部協變偏移（Internal Covariate Shift），這是指在訓練過程中，隨著參數更新，層的輸入分佈會發生變化。這會導致訓練速度變慢，並使得模型難以收斂。</p><h4 id="工作原理-1">工作原理</h4><ol type="1"><li><strong>標準化</strong>：對每一批次的輸入進行標準化，使其均值為0，方差為1。這樣可以使得每層的輸入保持在相似的範圍內。</li></ol><p><span class="math display">\[\hat{x} = \frac{x - \mu}{\sqrt{\sigma^2 + \epsilon}}\]</span></p><p>其中，<span class="math inline">\(\mu\)</span> 是批次均值，<span class="math inline">\(\sigma^2\)</span> 是批次方差，<span class="math inline">\(\epsilon\)</span> 是一個小常數，用於防止除以零。</p><ol start="2" type="1"><li><strong>縮放和平移</strong>：標準化後，通過學習到的參數 <span class="math inline">\(\gamma\)</span> 和 <span class="math inline">\(\beta\)</span> 對輸出進行縮放和平移，以保持模型的表達能力。</li></ol><p><span class="math display">\[y = \gamma \hat{x} + \beta\]</span></p><p>這樣做不僅提高了訓練的穩定性，還加速了收斂速度，使得更深層的網絡能夠有效訓練。</p><h3 id="預激活技術pre-activation">預激活技術（Pre-activation）</h3><p><strong>預激活技術</strong>是對傳統殘差塊結構的一種改進，它將激活函數放置在卷積層之前。這種方法有助於改善梯度流動並提高模型性能。</p><p>在傳統的殘差塊中，結構如下：</p><p><span class="math display">\[H(x) = F(x) + x\]</span></p><p>而在預激活結構中，則改為：</p><ol type="1"><li><strong>先進行批歸一化和激活</strong>：首先對輸入 <span class="math inline">\(x\)</span> 進行 卷積、批歸一化 (Batch Normalization）。</li></ol><p><span class="math display">\[y = F(x)\]</span></p><ol start="2" type="1"><li><strong>再進行捷徑連接</strong>：然後將捷徑連接添加到經過處理的輸出上。激活。</li></ol><p><span class="math display">\[H(x) = y + x\]</span></p><p>這樣做的好處是，在每個殘差塊中都能夠更好地保留信息流動，<strong>使得梯度能夠更有效地反向傳播</strong>。</p><h1 id="deep-residual-learning-for-image-recognition.">"Deep residual learning for image recognition."</h1><ul><li><a href="https://openaccess.thecvf.com/content_cvpr_2016/papers/He_Deep_Residual_Learning_CVPR_2016_paper.pdf">He, Kaiming, et al. "Deep residual learning for image recognition." Proceedings of the IEEE conference on computer vision and pattern recognition. 2016.</a><ul><li>這是何凱明論文的原圖，可以看到，<strong>56層的網路無論是在訓練集或測試集上</strong>，誤差率都比20層的要高。<strong>出現這種現象的原因並非是由於層數加深引發的梯度消失/梯度爆炸</strong>，<em>因為已經通過歸一化的方法解決了這個問題</em>，對於出現這種現象的原因將在下面討論，我們將這種反常的現象稱之為「退化現象」。</li><li>作者比較18-layer和34-layer的網路效果，可以看到普通的網路出現退化現象，但ResNet很好的解決了<strong>退化問題</strong>。</li><li>殘差單元可以以跳層連接的形式實現，即將單元的輸入直接與單元輸出加在一起，然後再啟動。因此殘差網路可以輕鬆地用主流的自動微分深度學習框架實現，直接使用BP演算法更新參數損失對某低層輸出的梯度，被分解為了兩項。</li></ul></li></ul><div class="group-image-container"><div class="group-image-row"><div class="group-image-wrap"><img src="https://i.imgur.com/IRN73Xt.png" /></div><div class="group-image-wrap"><img src="https://i.imgur.com/LT2gCRW.png" /></div></div><div class="group-image-row"><div class="group-image-wrap"><img src="https://i.imgur.com/YGVdUTF.png" /></div><div class="group-image-wrap"><img src="https://i.imgur.com/UtmMY3o.png" /></div></div><div class="group-image-row"><div class="group-image-wrap"><img src="https://i.imgur.com/HX57hvz.png" /></div></div></div><h1 id="殘差學習為何有效-沒有明確的定論">殘差學習為何有效? 沒有明確的定論</h1><h2 id="梯度保持">梯度保持</h2><ul><li><a href="http://deeplearning.ouxinyu.cn/References/%5BarXiv1603.05027%5D%20Identity%20Mappings%20in%20Deep%20Residual%20Networks.pdf">He, Kaiming, et al. "<strong>Identity mappings in deep residual networks</strong>." Computer Vision–ECCV 2016: 14th European Conference, Amsterdam, The Netherlands, October 11–14, 2016, Proceedings, Part IV 14. Springer International Publishing, 2016.</a></li><li>在殘差網路中，遠跳連接使用恆等映射<ul><li>問題一: 如果遠跳連線不是恆等映射會怎樣？</li><li>問題二：如果最後的激活函數取消會怎樣？</li></ul></li></ul><h2 id="loss-surfaces">Loss surfaces</h2><ul><li><a href="https://proceedings.neurips.cc/paper_files/paper/2018/file/a41b3bb3e6b050b6c9067c67f663b915-Paper.pdf">Li, H., Xu, Z., Taylor, G., Studer, C., &amp; Goldstein, T. (2018). Visualizing the <strong>loss landscape of neural nets</strong>. Advances in neural information processing systems, 31.</a></li></ul><p>"Visualizing the Loss Landscape of Neural Nets" 是一篇探討神經網絡損失函數結構的研究論文。該研究旨在理解神經網絡在訓練過程中如何最小化高維非凸損失函數，並探討損失景觀（loss landscape）對模型泛化能力的影響。</p><h3 id="研究背景">研究背景</h3><p>在訓練神經網絡時，最小化損失函數是一個關鍵步驟。這一過程通常涉及從一個複雜的高維空間中找到全局最小值。儘管這在理論上是困難的，但實務中卻有時能夠輕易達成。這種現象的原因與多種因素有關，包括網絡架構設計、優化器選擇以及變量初始化等。</p><h3 id="損失景觀的可視化">損失景觀的可視化</h3><p>研究者們提出了一種基於“過濾器正規化”（Filter Normalization）的可視化方法，這一方法能夠清晰地展示損失函數的結構。通過對損失景觀進行可視化，可以直觀地理解不同神經網絡架構如何影響損失函數的分佈，以及這些變化如何影響模型的泛化能力。</p><h4 id="損失景觀的特徵">損失景觀的特徵</h4><ol type="1"><li><strong>平坦區域</strong>：在損失景觀中，平坦區域意味著小幅度的參數變化會導致損失值的微小變化，這通常與較好的泛化能力相關。</li><li><strong>陡峭區域</strong>：相反，陡峭區域則表示參數的小變動可能會引起損失值的大幅變化，這可能導致模型在未見數據上的表現不穩定。</li></ol><p>圖中展示了對於ResNet-56, 有skip connection和沒有skip connection之間，其loss surface的區別。<strong>可以看出來，增加了 skip connection之後，loss surface明顯平滑很多，自然有利於網路優化了。</strong></p><div class="group-image-container"><div class="group-image-row"><div class="group-image-wrap"><img src="https://i.imgur.com/dreneeh.png" /></div><div class="group-image-wrap"><img src="https://i.imgur.com/N8Fj8fS.png" /></div></div></div><h2 id="常微分方程-動力學系統">常微分方程 動力學系統</h2><ul><li><a href="https://proceedings.neurips.cc/paper_files/paper/2018/file/69386f6bb1dfed68692a24c8686939b9-Paper.pdf">Chen, R. T., Rubanova, Y., Bettencourt, J., &amp; Duvenaud, D. K. (2018). Neural ordinary differential equations. Advances in neural information processing systems, 31.</a><ul><li>神經常微分方程（Neural Ordinary Differential Equations，簡稱Neural ODE）是一種新型的深度學習模型，將神經網絡的結構與常微分方程（ODE）相結合，提供了一種連續的方式來描述數據的變化。這一概念於2018年在NeurIPS會議上獲得最佳論文獎，並迅速成為機器學習領域中的熱門話題。</li><li>神經常微分方程的基本思想是將傳統神經網絡中的離散層結構轉變為連續層。這意味著，神經網絡的每一層不再是獨立的，而是可以看作是一個連續的動態系統。</li><li>我們利用了微分方程的方法來進行連續時間的推斷。</li></ul></li></ul><p>殘差的數學表示為</p><p><span class="math display">\[h_{t+1} = h_t + f(h_t, \theta_t)\]</span></p><p>， 如果從常微分方程 動力學系統 的角度出發：</p><p><span class="math display">\[\dfrac{d h(t)}{dt} = f(h(t), t, \theta)\]</span></p><p>如果把神經元看成一個動力學系統，那麼殘差連接其實是這個動力學系統的離散形式。</p><ul><li>我們把整個映射看成100%，則前面四層網絡實現了98%的映射關係，而殘餘的映射由紫色層完成，Residual 另一個翻譯就是 殘餘，殘留 的意思，也就是讓每一個殘差塊，只關注殘餘映射的一小部分</li><li>resnet 是微分方程的離散化。分析起來得結合manifold微分幾何。這才是根子。而不是什麼泰勒展開。</li><li>真要分析它的性能，要將resnet空間看作參數化的函數流形，分析流形上的曲率分佈，將其與普通CNN相比較，你會看到它與量子計算系統的流形結構高度相似，而且比CNN平滑，這才搗到根上。</li><li>其實這種網絡結構不應該被稱為殘差網絡，而應該稱為跳連結網絡。真正的恆等映射並非博主所說的粉紅色部分，而是跳轉直連這部分。由於跳連結這條線沒有加入其他層，是直連的，所以才是恆等映射。如果將“殘差”字樣全部替換為“跳鏈接”，估計很多人就不會有疑問了。因為在沒有跳連結之前，神經網路會有以下問題：從前向傳播的方向來看：資料每經過一層就會造成資訊損失，層數越多，後面可以學習的特徵就越少。而加入跳連結後，高層可以學習前一層的輸出，同時也能學習前一層或幾層的輸入。這就像教學一樣，大學生教高中生，高中生教國中生，國中生教小學生。由於每個人的能力有限，知識傳遞時會有損失。假如每個人都損失一點，到最後的人可能就沒什麼好學的了。而跳連結的想法就好比小學生，他不僅可以接觸到國中生給自己的知識，還可以直接接觸到高中的知識，這樣小學生就能更好地學習了。從反向傳播的方向來說：由於誤差是從高層逐步向底層傳播的，所以沒有跳連結之前，高層的誤差向底層傳播時會越來越少。假如最高層的誤差是100，等傳到底層時就可能變成0.1了。而有了跳連結後，我們可以直接將誤差100直接傳給底層，而不僅僅是簡單的一層一層地傳遞。理解了跳連結就可以很簡單的理解他的變種了，原理都是一樣的；不要被殘差這個詞誤導了</li><li>跟數值計算解線性方程組裡的鬆弛差不多，就是讓參數變化不要太大，不要一下子就越過了鞍點</li><li>學過自動化控制的人應該知道 這個想法在自動化控制裡面是常識 無所不在 前饋控制 其實殘差應該改名為前饋</li></ul><h1 id="references">References</h1><ol type="1"><li><a href="https://zh.d2l.ai/chapter_convolutional-modern/resnet.html">7.6. 残差网络（ResNet）</a></li><li><a href="https://www.zhihu.com/question/306135761/answer/2491142607?utm_psn=1867892895526309888">为什么残差连接的网络结构更容易学习？</a></li><li><a href="http://openaccess.thecvf.com/content_cvpr_2017/papers/Xie_Aggregated_Residual_Transformations_CVPR_2017_paper.pdf">Xie, S., Girshick, R., Dollár, P., Tu, Z., &amp; He, K. (2017). Aggregated residual transformations for deep neural networks. In Proceedings of the IEEE conference on computer vision and pattern recognition (pp. 1492-1500).</a></li></ol>]]></content>
    
    
    <categories>
      
      <category>ML</category>
      
    </categories>
    
    
    <tags>
      
      <tag>NWP</tag>
      
      <tag>AI</tag>
      
      <tag>ML</tag>
      
      <tag>ResNet</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ML | VAE Variational Auto-Encoder</title>
    <link href="/2025/01/26/ML-VAE-Variational-Autoencoder/"/>
    <url>/2025/01/26/ML-VAE-Variational-Autoencoder/</url>
    
    <content type="html"><![CDATA[<h1 id="基礎知識回顧">基礎知識回顧</h1><ul><li>Latent Variable</li><li>Variations</li><li>Gaussian Mixture Model<ul><li><strong>Gaussian Mixture Model</strong>，即高斯混合模型。生成模型比較主流的三個模型為：隱馬可夫模型HMM、樸素貝葉斯模型NB、高斯混合模型GMM。這裡我們主要為大家介紹GMM。<ul><li>混合模型是一個可以用來表示在總體分佈中含有N個子分佈的機率模型，它表示了觀測資料在總體中的機率分佈。利用混合模型計算總體分佈機率時我們並不需要知道原始觀測資料中子分佈的資訊。由 Fourier Theory 可得，任一隨時間做週期性變化的波，都可以分解為一系列不同頻率、不同振幅、不同相位的正弦波。同樣地，我們也可以用多個常態分佈的疊加去逼近任一個分佈。</li></ul></li></ul></li><li>Conditional Probability<ul><li><strong>Conditional Probability</strong>：條件機率。定義兩個事件A和時間B，求A和B同時發生的機率：</li><li><span class="math inline">\(P(A, B) = P(B) P(A|B) = P(A) P(B|A)\)</span></li></ul></li><li>KL divergence<ul><li>KL divergence：KL散度又稱為KL距離或相對熵，用於衡量兩個機率分佈之間的距離。給定真實分佈 <span class="math inline">\(P(x)\)</span> 和理論分佈 <span class="math inline">\(Q(x)\)</span>，我們將它們之間的KL散度公式定義為：</li><li><span class="math inline">\(KL (P||Q) = \sum P(x) \log (\dfrac{P(x)}{Q(x)}) = \int P(x) \log (\dfrac{P(x)}{Q(x)}) dx\)</span></li><li>此外，關於 KL 散度的一些性質如下：<ul><li><strong>KL散度是不對稱的</strong>：因為P到Q的距離不等於Q到P的距離，即 <span class="math inline">\(KL(P||Q)≠KL(Q||P)\)</span> 。這很容易造成 model collapse 即模式坍縮－模型傾向於產生一些比較容易騙過判別器的樣本，加快模型的收斂，從而導致生成的多樣性變差，生成出來的效果也比較差，相當於走捷徑。</li><li>當且僅當兩個分佈完全一致時，KL散度等於0。</li></ul></li></ul></li><li>Maximum Likelihood Estimate<ul><li>Maximum Likelihood Estimate，MLE：極大似然估計。要理解什麼是極大似然估計，我們要先理解什麼是“似然”，它同一般的機率事件又有啥區別？給定一個函數 <span class="math inline">\(P(x|\theta)\)</span>， <span class="math inline">\(x\)</span> 代表樣本點， <span class="math inline">\(\theta\)</span> 表示參數：<ul><li>當 <span class="math inline">\(\theta\)</span> 為常數， <span class="math inline">\(x\)</span> 為變數時，我們稱 為關於 的<strong>機率函數</strong>；</li><li>當 <span class="math inline">\(x\)</span> 為常數， <span class="math inline">\(\theta\)</span> 為變數時，我們稱 為關於 的<strong>似然函數</strong></li></ul></li><li>極大似然估計中樣本點的取樣都必須滿足 i.i.d.，它尋找的是使得樣本點 <span class="math inline">\(x\)</span> 能夠以最大機率發生的 <span class="math inline">\(\theta\)</span> 的取值</li></ul></li></ul><h1 id="applications">Applications</h1><p>Auto-Encoders are a specialized type of neural network primarily used for <strong>unsupervised learning tasks</strong>. They function by compressing input data into a lower-dimensional representation and then reconstructing the original data from this compressed form. Below are some key applications and functionalities of autoencoders.</p><p>自動編碼器（Autoencoder）在多種情境下表現出色，特別是在無監督學習和數據處理方面。以下是一些自動編碼器最有效的應用場景：</p><h2 id="自動編碼器的有效情境">自動編碼器的有效情境</h2><ol type="1"><li><strong>特徵降維</strong>：<ul><li>自動編碼器能夠將高維數據壓縮到低維空間，提取出數據中的關鍵特徵，這一過程類似於主成分分析（PCA），但通常能捕捉更複雜的非線性結構.</li></ul></li><li><strong>數據去噪</strong>：<ul><li>去噪自動編碼器（Denoising Autoencoder）專門設計用來從受損或帶噪聲的數據中恢復原始信號，這在圖像處理和音頻信號處理中非常有效.</li></ul></li><li><strong>異常檢測</strong>：<ul><li>自動編碼器可以用於識別異常數據點。通過訓練模型重建正常數據，當輸入異常數據時，重建誤差會顯著增加，從而標識出異常.</li></ul></li><li><strong>生成模型</strong>：<ul><li>變分自動編碼器（Variational Autoencoder, VAE）和對抗自動編碼器（Adversarial Autoencoder, AAE）等擴展版本可用於生成新樣本，如圖像或時間序列數據，這在創意應用中非常有用.</li></ul></li><li><strong>特徵提取</strong>：<ul><li>自動編碼器可以作為特徵提取器，將學習到的隱含表示用於後續的有監督學習任務，提升模型性能.</li></ul></li><li><strong>圖像重建與修復</strong>：<ul><li>在計算機視覺領域，自動編碼器可以用於圖像重建和修復，例如從模糊或部分損壞的圖像中重建清晰的圖像.</li></ul></li></ol><p>Input = image, text</p><div class="group-image-container"><div class="group-image-row"><div class="group-image-wrap"><img src="https://i.imgur.com/0EJzfPK.png" /></div><div class="group-image-wrap"><img src="https://i.imgur.com/i8javUE.png" /></div></div><div class="group-image-row"></div></div><h1 id="auto-encoder">Auto-Encoder</h1><p>Auto-Encoder自編碼器是1986年由 Rumelhart 提出，可用於高維複雜資料的處理, 它促進了神經網路的發展。自編碼神經網路是一種<strong>無監督學習演算法</strong>（訓練範例未標註），它使用了BP反向傳播演算法，致力於使輸出與輸入越接近越好。</p><h2 id="structure-of-auto-encoder">Structure of Auto-Encoder</h2><p>An Auto-Encoder typically consists of three main components:</p><ul><li><strong>Encoder</strong>: Compresses the input data into a lower-dimensional representation.</li><li><strong>Bottleneck (Code)</strong>: Contains the compressed representation of the input.</li><li><strong>Decoder</strong>: Reconstructs the original input from the compressed representation.<br /></li><li><div class="group-image-container"><div class="group-image-row"><div class="group-image-wrap"><img src="https://i.imgur.com/shu8T3B.png" /></div><div class="group-image-wrap"><img src="https://i.imgur.com/Qx6HPqW.png" /></div></div><div class="group-image-row"><div class="group-image-wrap"><img src="https://i.imgur.com/OmfCUi2.png" /></div><div class="group-image-wrap"><img src="https://i.imgur.com/yewPTO0.png" /></div></div></div></li></ul><h2 id="自編碼器的限制在哪裡">自編碼器的限制在哪裡？</h2><p>透過AE建構出一個比PCA更清晰的自編碼器模型，<strong>但這並不是真正意義上的生成模型</strong>。對於一個特定的生成模型，它一般應該滿足以下兩點：</p><ul><li>編碼器和解碼器是可以獨立分割的（類比GAN的Generator和Discriminator）</li><li>固定維度下任意取樣出來的編碼，都應該能透過解碼器產生一張清晰且真實的圖片</li></ul><p>這裡解釋下第二點。如下圖所示，我們用一張全月圖和一張半月圖去訓練一個AE，經過訓練，模型能夠很好地還原出這兩張圖片。接下來，我們在latent code上中間一點，即兩張圖片編碼點中間處任取一點，將這點交給解碼器進行解碼，直覺上我們會得到一張介於全月圖和半月圖之間的圖片（如陰影面積覆蓋3/4的樣子）。然而，實際上當你那這個點去decode的時候你會發現AE還原出來的圖片不僅模糊而且還是亂碼的。為什麼會出現這種現象？一個直觀上的解釋是AE的Encoder和Decoder都使用了 DNN，<strong>DNN是一個非線性的變換過程，因此在latent space上點與點之間transform往往沒有規律可循</strong>。</p><h3 id="引入噪聲-隨機性">引入噪聲 (隨機性)</h3><div class="note note-primary">            <p>如何解決這個問題呢？<strong>一個想法就是引入噪聲</strong>，擴大圖片的編碼區域，從而能夠覆蓋到失真的空白編碼區。其實說白了就是透過增加輸入的多樣性來增強輸出的魯棒性。當我們將輸入圖片編碼之前引入一點噪聲，使得每張圖片的編碼點出現在綠色箭頭範圍內，這樣一來所得到的latent space就能覆蓋到更多的編碼點。此時我們再從中間點抽取去還原便可以得到一個我們比較希望得到的輸出。</p>          </div><p>雖然我們為輸入圖片增添了一些噪音 (引入噪聲) 使得latent space能夠覆蓋到比較多的區域，但是還是有不少地方沒有被覆蓋到，比如上圖右邊黃色的部分因為離得比較遠所以就沒編碼到。因此，我們是否可以嘗試利用更多的噪音，使得對於每一個輸入樣本，它的編碼都能夠覆蓋到整個編碼空間？只不過這裡我們需要保證的是，對於源編碼附近的編碼我們應該給定一個高的機率值，而對於距離原編碼點距離較遠的，我們應該給定一個低的機率值。沒錯，整體來說，<strong>我們就是要將原先一個單點拉伸到整個編碼空間，即將離散的編碼點引申為一條連續的接近常態分佈的編碼曲線</strong>。</p><div class="group-image-container"><div class="group-image-row"><div class="group-image-wrap"><img src="https://i.imgur.com/WcjuQGm.png" /></div><div class="group-image-wrap"><img src="https://i.imgur.com/Ahr59Ji.png" /></div><div class="group-image-wrap"><img src="https://i.imgur.com/9bIChjc.png" /></div></div></div><p>到這裡，我們已經不知不覺到來到了 <strong>變分自編碼器 VAE 的核心思想腹地</strong>。以下我們將詳細敘述VAE的模型架構。</p><h1 id="variational-auto-encoder">Variational Auto-Encoder</h1><p>早在2013年，Kingma和Welling就推出了變分自動編碼器（VAE），簡而言之，VAE的想法是訓練具有正則化潛在空間的自動編碼器。然後，正則化編碼器被迫將資料編碼為接近高斯的分佈，而解碼器則從潛在空間重建資料。</p><p>變分法便是用來求泛函數的極值。下面就不展開了，有興趣的可以自行查閱相關資料。這裡主要說一點的就是 VAE 中 V 是怎麼來的，認為應該只是計算的過程中用到了變分法的思想去求解，所以就取名叫 VAE。</p><ul><li><a href="https://arxiv.org/abs/1312.6114">Kingma, Diederik P. "Auto-encoding variational bayes." arXiv preprint arXiv:1312.6114 (2013).</a></li><li><a href="https://arxiv.org/abs/1906.02691">An Introduction to Variational Autoencoders (2019)</a></li></ul><div class="group-image-container"><div class="group-image-row"><div class="group-image-wrap"><img src="https://i.imgur.com/y99QAWW.png" /></div><div class="group-image-wrap"><img src="https://i.imgur.com/8KvMH5H.png" /></div><div class="group-image-wrap"><img src="https://i.imgur.com/rO6O6rt.png" /></div></div><div class="group-image-row"><div class="group-image-wrap"><img src="https://i.imgur.com/YGNSOKR.png" /></div><div class="group-image-wrap"><img src="https://i.imgur.com/7IAIlyS.png" /></div><div class="group-image-wrap"><img src="https://i.imgur.com/mavnxry.png" /></div></div><div class="group-image-row"><div class="group-image-wrap"><img src="https://i.imgur.com/v9pXyAv.png" /></div><div class="group-image-wrap"><img src="https://i.imgur.com/0BY1Ikf.png" /></div><div class="group-image-wrap"><img src="https://i.imgur.com/WY36In6.png" /></div></div></div><p>最後，再讓我們一起來討論下VAE的限制。雖然VAE比普通的AE模型訓練出來的效果要好得多，但是訓練過VAE模型的人都知道，它生成出來的圖片相對GANs那種直接利用對抗學習的方式會比較模糊，這是由於它是通過直接計算生成圖片和原始圖片之間的均方誤差，所以得到的是一張「平均圖像」。</p><h1 id="sampling-引入噪聲">*** Sampling (引入噪聲)</h1><p>結構：VAE也是由編碼器和解碼器組成，<strong>但它在編碼階段引入了一個機率模型 (引入噪聲)</strong>。編碼器輸出的是潛在空間的參數（平均值和變異數），而不是直接的潛在表示。解碼器則從這個潛在分佈中取樣產生資料。</p><p>目的：VAE的目標不僅是重構輸入數據，<strong>還希望潛在空間的表示具有良好的性質，例如連續性和可解釋性。這使得 VAE 適合產生新數據</strong>。</p><p>應用：VAE廣泛應用於生成建模，如影像生成、資料插值和缺失資料填充</p><p><img src="https://i.imgur.com/JzSVy2C.png" width="800" /></p><h2 id="編碼器與機率分佈">編碼器與機率分佈</h2><p>編碼器與機率分佈：在 VAE 中，編碼器不是直接輸出潛在變數 <span class="math inline">\(z\)</span> 的值，而是輸出 <span class="math inline">\(z\)</span> 的參數。這通常是潛在空間的均值 <span class="math inline">\(\mu\)</span> 和 方差 <span class="math inline">\(\sigma\)</span>。透過這些參數，我們可以定義一個常態分佈：</p><p><span class="math display">\[z \sim N(\mu(x), \sigma(x))\]</span></p><div class="note note-primary">            <p>這裡，<span class="math inline">\(\mu(x)\)</span> 和 <span class="math inline">\(\sigma(x)\)</span> 是由編碼器網路產生的。這樣，<span class="math inline">\(z\)</span> 的值就是在<strong>這個分佈中進行取樣</strong>的。</p>          </div><div class="note note-primary">            <ul><li>編碼器為每個輸入輸出一個多元正態分佈的參數（均值和方差）。從這個分佈中進行採樣可以生成新數據點，通過將這些採樣的潛在向量傳遞給解碼器，<strong>有效地創建出與訓練數據相似但又不同的新實例</strong>。</li><li>採樣過程為模型<strong>引入了隨機性</strong>，這是捕捉數據變異性的關鍵。與傳統的自編碼器產生確定性輸出不同，VAE利用採樣中的隨機性確保從相同輸入生成不同的潛在向量，從而實現對數據的更豐富表示。<strong>這種隨機性有助於從相似輸入中探索多樣化的輸出</strong>。</li><li><strong>這確保了學習到的潛在空間是結構化的，並促進了數據點之間有意義的插值</strong> (!!!)。</li><li>訓練完成後，VAE不僅可以從學習到的後驗分佈中進行採樣，還可以從各種其他分佈中進行採樣。例如，它們可以從先驗分佈（通常是標準正態分佈）中進行採樣，<strong>這可能導致生成多樣的新數據點。這種靈活性使得VAE能夠應用於各種上下文，例如生成圖像或填補缺失數據</strong>。</li></ul>          </div><div class="note note-primary">            <p>總之，VAE中的採樣對於其生成能力至關重要，引入了必要的隨機性，通過結構化潛在空間幫助正則化，利用重參數化等高效訓練技術，並提供了生成新數據實例的靈活性。</p>          </div><div class="note note-primary">            <p><strong>但如果</strong>我們從這個分佈中取樣，那麼這個節點 <span class="math inline">\(z\)</span> 將是一個隨機節點，無法進行反向傳播 (不能微分, 採樣本身是不可導的)，這意味著無法進行優化。(為了在訓練過程中允許反向傳播，同時保持隨機採樣，VAE採用了一種稱為<strong>重參數化技巧</strong>的方法。)</p>          </div><h1 id="重參數化技巧-reparameterization-trick">*** 重參數化技巧 (Reparameterization trick)</h1><p><img src="https://i.imgur.com/LbEi0j8.png" width="600" /></p><div class="note note-primary">            <ul><li><strong>Random node z</strong> can not be done via Backpropagation !!! (直接從這個分佈採樣會導致梯度無法通過隨機節點回傳，因此 <strong>重參數化技巧</strong> 將 <strong>採樣過程</strong> 分解為 <strong>確定性變換</strong>。)</li><li>Then, introduce a <strong>New External Noise Input</strong> <span class="math inline">\(\epsilon\)</span> is <span class="math inline">\(N(0,1)\)</span> !!!</li><li>The <span class="math inline">\(\epsilon\)</span> is <span class="math inline">\(N(0,1)\)</span> and will be not involved into Backpropagation !!! (not on the our Chain Rule !!!)</li></ul>          </div><div class="note note-primary">            <p>重參數化技巧是指將隨機變量的 <strong>採樣過程轉</strong> 換為一個 <strong>確定性函數</strong> 與 <strong>隨機噪聲</strong> 的組合。這樣做的目的是使得模型在訓練過程中可以進行有效的梯度反向傳播。</p>          </div><p>重參數化技巧：<strong>為了使得 VAE 能夠進行有效的反向傳播</strong>，使用了重參數化技巧。具體來說，我們將 <span class="math inline">\(z\)</span> 表達為：</p><p><span class="math display">\[z = \mu(x) + \sigma(x) \cdot \epsilon\]</span></p><p>其中 <span class="math inline">\(\epsilon \sim N(0,1)\)</span> 。</p><div class="note note-primary">            <ul><li>透過這種方式，<strong>我們可以將隨機性從網路的前向傳播中分離出來，使得我們能夠透過標準的反向傳播演算法來訓練模型</strong>。</li><li>例如，如果 <span class="math inline">\(q_{\phi}(z|x)\)</span> 是均值為 <span class="math inline">\(\mu\)</span>、方差為 <span class="math inline">\(\sigma^2\)</span> 的高斯分佈，可以從標準正態分佈 <span class="math inline">\(N(0, I)\)</span> 中採樣一個噪聲 <span class="math inline">\(\epsilon\)</span>，然後計算 <span class="math inline">\(z = \mu + \sigma \odot \epsilon\)</span>。這樣，<strong><span class="math inline">\(z\)</span> 的採樣就變成了均值和方差的函數，從而使得梯度可以通過 <span class="math inline">\(z\)</span> 回傳</strong>。</li></ul>          </div><h1 id="vae生成的影像品質並不好">VAE生成的影像品質並不好</h1><p>目前在影像生成領域，除了VAE，還有GAN，Diffusion模型等，相較之下，VAE生成的影像品質並不好，通常比較模糊。但為什麼在StableDiffusion中，採用了VAE+diffusion的結構，效果就變得非常好了？</p><p>過高的壓縮率、重建損失只有平方誤差、完整的KL散度項，都是傳統VAE模糊的原因。而對於傳統VAE來說，能改進的只有重構損失，其實如果你把傳統VAE的重構損失也換成“平方誤差 + perceptual損失 + 對抗損失”，也能明顯減少VAE的模糊。</p><p>但是，改進VAE的重構損失只能解決清晰度問題，解決不了壓縮率問題，將一張 256x256 甚至 1024x1024 的圖片壓縮為單一向量，必然會有嚴重的資訊損失，只能重構出一些比較宏觀的語義，細節層面肯定沒辦法更好保留。</p><p>相較之下，LDM的VAE只用來壓縮圖片大小，它不負責成為一個生成模型（交給diffusion來做），所以能騰出的空間更多。例如，將壓縮為單一向量改為保留a*b大小的feature map，單這一點就可以讓重構結果清晰不少，然後弱化KL散度項（或者VQ-VAE的VQ作為正則，都差不多，這是為了防止latent的變異數過大）也能讓結果更清晰，更不用說改進重構損失了。</p><p>說穿了，LDM的VAE只負責重構出清晰的結果（外加一點正則），它的核心作用的AE而不是VAE，生成能力強是因為Diffusion強。</p><p>所以 (latent diffusion model) LDM的VAE可以當做AE來理解，本質上是因為圖片和視訊資訊實在太稀疏了，搞個AE壓縮一下，方便後面diffusion訓練。 KL散度就是懲罰項，讓latent的分佈集中一下，別太分散了，方便後面學習，不考慮 z 一定要用常態分佈採樣。</p>    <div class="fold">      <div class="fold-title fold-info collapsed" data-toggle="collapse" href="#collapse-8f7bdefe" role="button" aria-expanded="false" aria-controls="collapse-8f7bdefe">        <div class="fold-arrow">▶</div>pytorch VAE      </div>      <div class="fold-collapse collapse" id="collapse-8f7bdefe">        <div class="fold-content">          <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> torch<br><span class="hljs-keyword">import</span> torchvision<br><span class="hljs-keyword">import</span> torch.nn <span class="hljs-keyword">as</span> nn<br><span class="hljs-keyword">import</span> torch.optim <span class="hljs-keyword">as</span> optim<br><span class="hljs-keyword">from</span> torchvision <span class="hljs-keyword">import</span> datasets, transforms<br><span class="hljs-keyword">from</span> torch.utils.data <span class="hljs-keyword">import</span> DataLoader<br><span class="hljs-keyword">import</span> matplotlib.pyplot <span class="hljs-keyword">as</span> plt<br><br>device = torch.device(<span class="hljs-string">&quot;cuda&quot;</span> <span class="hljs-keyword">if</span> torch.cuda.is_available() <span class="hljs-keyword">else</span> <span class="hljs-string">&quot;cpu&quot;</span>)<br>device = <span class="hljs-string">&quot;cpu&quot;</span><br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;device = &quot;</span>, device)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;torch.__version__ = &quot;</span>, torch.__version__)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;torch.cuda.is_available() = &quot;</span>, torch.cuda.is_available())<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;torch.cuda.device_count() = &quot;</span>, torch.cuda.device_count())<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;torch.cuda.current_device() =&quot;</span>, torch.cuda.current_device())<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;torch.cuda.device(0) = &quot;</span>, torch.cuda.device(<span class="hljs-number">0</span>))<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;torch.cuda.get_device_name(0) = &quot;</span>, torch.cuda.get_device_name(<span class="hljs-number">0</span>))<br><br><span class="hljs-comment"># 超参数</span><br>latent_dim = <span class="hljs-number">20</span><br>batch_size = <span class="hljs-number">128</span><br>learning_rate = <span class="hljs-number">1e-3</span><br>num_epochs = <span class="hljs-number">10</span><br><br><span class="hljs-comment"># 数据准备</span><br>transform = transforms.Compose([<br>    transforms.ToTensor(),<br>    <span class="hljs-comment"># transforms.Normalize((0.5,), (0.5,))</span><br>])<br>train_dataset = datasets.MNIST(root=<span class="hljs-string">&#x27;./data&#x27;</span>, train=<span class="hljs-literal">True</span>, download=<span class="hljs-literal">True</span>, transform=transform)<br>train_loader = DataLoader(dataset=train_dataset, batch_size=batch_size, shuffle=<span class="hljs-literal">True</span>)<br><br><span class="hljs-comment"># VAE模型定义</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">VAE</span>(nn.Module):<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, latent_dim</span>):<br>        <span class="hljs-built_in">super</span>(VAE, <span class="hljs-variable language_">self</span>).__init__()<br>        <span class="hljs-comment"># 编码器</span><br>        <span class="hljs-variable language_">self</span>.encoder = nn.Sequential(<br>            nn.Flatten(),<br>            nn.Linear(<span class="hljs-number">28</span>*<span class="hljs-number">28</span>, <span class="hljs-number">400</span>),<br>            nn.ReLU(),<br>            nn.Linear(<span class="hljs-number">400</span>, <span class="hljs-number">2</span> * latent_dim)  <span class="hljs-comment"># 输出均值和对数方差</span><br>        )<br>        <span class="hljs-comment"># 解码器</span><br>        <span class="hljs-variable language_">self</span>.decoder = nn.Sequential(<br>            nn.Linear(latent_dim, <span class="hljs-number">400</span>),<br>            nn.ReLU(),<br>            nn.Linear(<span class="hljs-number">400</span>, <span class="hljs-number">28</span>*<span class="hljs-number">28</span>),<br>            nn.Sigmoid()  <span class="hljs-comment"># 输出范围在[0, 1]之间</span><br>        )<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">reparameterize</span>(<span class="hljs-params">self, mu, logvar</span>):<br>        std = torch.exp(<span class="hljs-number">0.5</span> * logvar)<br>        eps = torch.randn_like(std)<br>        <span class="hljs-keyword">return</span> mu + eps * std<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">forward</span>(<span class="hljs-params">self, x</span>):<br>        <span class="hljs-comment"># 编码</span><br>        mu_logvar = <span class="hljs-variable language_">self</span>.encoder(x)<br>        mu, logvar = mu_logvar[:, :latent_dim], mu_logvar[:, latent_dim:]<br>        z = <span class="hljs-variable language_">self</span>.reparameterize(mu, logvar)<br>        <span class="hljs-comment"># 解码</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-variable language_">self</span>.decoder(z), mu, logvar<br><br><span class="hljs-comment"># 损失函数</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">loss_function</span>(<span class="hljs-params">recon_x, x, mu, logvar</span>):<br>    BCE = nn.functional.binary_cross_entropy(recon_x, x.view(-<span class="hljs-number">1</span>, <span class="hljs-number">28</span>*<span class="hljs-number">28</span>), reduction=<span class="hljs-string">&#x27;sum&#x27;</span>)<br>    KLD = -<span class="hljs-number">0.5</span> * torch.<span class="hljs-built_in">sum</span>(<span class="hljs-number">1</span> + logvar - mu.<span class="hljs-built_in">pow</span>(<span class="hljs-number">2</span>) - logvar.exp())<br>    <span class="hljs-keyword">return</span> BCE + KLD<br><br><span class="hljs-comment"># 初始化模型和优化器</span><br>model = VAE(latent_dim)<br>model.to(device)<br><br>optimizer = optim.Adam(model.parameters(), lr=learning_rate)<br><br><span class="hljs-comment"># 训练模型</span><br>model.train()<br><span class="hljs-keyword">for</span> epoch <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(num_epochs):<br>    train_loss = <span class="hljs-number">0</span><br>    <span class="hljs-keyword">for</span> batch_idx, (data, _) <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(train_loader):<br>        optimizer.zero_grad()<br>        data = data.to(device)<br>        recon_batch, mu, logvar = model(data)<br>        loss = loss_function(recon_batch, data, mu, logvar)<br>        loss.backward()<br>        train_loss += loss.item()<br>        optimizer.step()<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;Epoch <span class="hljs-subst">&#123;epoch + <span class="hljs-number">1</span>&#125;</span>, Loss: <span class="hljs-subst">&#123;train_loss / <span class="hljs-built_in">len</span>(train_loader.dataset):<span class="hljs-number">.4</span>f&#125;</span>&#x27;</span>)<br><br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Training finished!&quot;</span>)<br><br><span class="hljs-comment"># 生成图像</span><br>model.<span class="hljs-built_in">eval</span>()<br><span class="hljs-keyword">with</span> torch.no_grad():<br>    sample = torch.randn(<span class="hljs-number">64</span>, latent_dim)  <span class="hljs-comment"># 生成64个潜在样本</span><br>    sample = sample.to(device)<br>    generated_images = model.decoder(sample).view(-<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">28</span>, <span class="hljs-number">28</span>)  <span class="hljs-comment"># 解码为图像</span><br><br><span class="hljs-comment"># 可视化生成的图像</span><br>grid_img = torchvision.utils.make_grid(generated_images, nrow=<span class="hljs-number">8</span>, normalize=<span class="hljs-literal">True</span>)<br>grid_img = grid_img.cpu()<br>plt.figure(figsize=(<span class="hljs-number">10</span>, <span class="hljs-number">10</span>))<br>plt.imshow(grid_img.permute(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">0</span>).numpy())<br>plt.axis(<span class="hljs-string">&#x27;off&#x27;</span>)<br><span class="hljs-comment">#plt.show()</span><br>plt.savefig(<span class="hljs-string">&#x27;test.png&#x27;</span>)<br></code></pre></td></tr></table></figure>        </div>      </div>    </div><ul><li>real time是時脈走過的時間，user time 是程式在使用者狀態的cpu時間，sys time 為程式在內核態的cpu時間</li><li><code>%cpu_usage = (user_time + sys_time)/real_time * 100%</code></li></ul><p>GPU-3090 (only ~7% utility) <figure class="highlight console"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs console">real1m16.440s<br>user1m23.738s<br>sys0m32.552s<br></code></pre></td></tr></table></figure></p><p>CPU (all 20cores are used) <figure class="highlight console"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs console">real1m56.233s<br>user11m45.820s<br>sys25m28.952s<br></code></pre></td></tr></table></figure></p><h1 id="literautre-review">Literautre Review</h1><p>The marginal likelihood is composed of a sum over the marginal likelihoods of individual datapoints <span class="math display">\[\log p_{\boldsymbol{\theta}}(\mathbf{x}^{(1)},\cdots,\mathbf{x}^{(N)})=\sum_{i=1}^{N}\log p_{\boldsymbol{\theta}}(\mathbf{x}^{(i)})\]</span> , which can each be rewritten as: <span class="math display">\[\log p_{\boldsymbol{\theta}}(\mathbf{x}^{(i)})=D_{KL}(q_{\boldsymbol{\phi}}(\mathbf{z}|\mathbf{x}^{(i)})||p_{\boldsymbol{\theta}}(\mathbf{z}|\mathbf{x}^{(i)}))+\mathcal{L}(\boldsymbol{\theta},\boldsymbol{\phi};\mathbf{x}^{(i)}) \]</span></p><p>The fırst RHS term is the KL divergence of the approximate from the true posterior. Since this <strong>KL- divergence is non- negative</strong>, the second RHS term, <span class="math inline">\(\mathcal{L} ( \boldsymbol{\theta }, \boldsymbol{\phi }; \mathbf{x} ^{( i) })\)</span> is called the <strong>(variational) lower bound</strong> on the marginal likelihood of datapoint <span class="math inline">\(i\)</span>, and can be written as:</p><p><span class="math display">\[\log p_{\boldsymbol{\theta}}(\mathbf{x}^{(i)})\geq\mathcal{L}(\boldsymbol{\theta},\boldsymbol{\phi};\mathbf{x}^{(i)})=\mathbb{E}_{q_{\boldsymbol{\phi}}(\mathbf{z}|\mathbf{x})}\left[-\log q_{\boldsymbol{\phi}}(\mathbf{z}|\mathbf{x})+\log p_{\boldsymbol{\theta}}(\mathbf{x},\mathbf{z})\right]\]</span></p><p>which can also be written as:</p><p><span class="math display">\[\mathcal{L}(\boldsymbol{\theta},\boldsymbol{\phi};\mathbf{x}^{(i)})=-D_{KL}(q_{\boldsymbol{\phi}}(\mathbf{z}|\mathbf{x}^{(i)})||p_{\boldsymbol{\theta}}(\mathbf{z}))+\mathbb{E}_{q_{\boldsymbol{\phi}}(\mathbf{z}|\mathbf{x}^{(i)})}\left[\log p_{\boldsymbol{\theta}}(\mathbf{x}^{(i)}|\mathbf{z})\right]\]</span> We want to differentiate and optimize the lower bound <span class="math inline">\(\mathcal{L}(\boldsymbol{\theta},\boldsymbol{\phi};\mathbf{x}^{(i)})\)</span> w.r.t. both the variational parameters <span class="math inline">\(\phi\)</span> and generative parameters <span class="math inline">\(\theta.\)</span> However, the gradient of the lower bound w.r.t. <span class="math inline">\(\phi\)</span> is a bit problematic. The usual (naïve) Monte Carlo gradient estimator for this type of problem is: <span class="math display">\[\nabla _{\boldsymbol{\phi }}\mathbb{E} _{q_{\boldsymbol{\phi }( \mathbf{z} ) }}\left [ f( \mathbf{z} ) \right ] = \mathbb{E} _{q_{\boldsymbol{\phi }( \mathbf{z} ) }}\left [ f( \mathbf{z} ) \nabla _{q_{\boldsymbol{\phi }( \mathbf{z} ) }}\log q_{\boldsymbol{\phi }}( \mathbf{z} ) \right ] \simeq \frac 1L\sum _{l= 1}^Lf( \mathbf{z} ) \nabla _{q_{\boldsymbol{\phi }( \mathbf{z} ^{( l) }) }}\log q_{\boldsymbol{\phi }}( \mathbf{z} ^{( l) })\]</span> where <span class="math inline">\(\mathbf{z}^{(l)}\sim q_{\boldsymbol{\phi}}(\mathbf{z}|\mathbf{x}^{(i)}).\)</span> This gradient estimator exhibits exhibits very high variance (see.g. [BJP12]) and is impractical for our purposes.</p><div class="group-image-container"><div class="group-image-row"><div class="group-image-wrap"><img src="https://i.imgur.com/qjPqBwc.png" /></div><div class="group-image-wrap"><img src="https://i.imgur.com/Q6DXjJP.png" /></div></div><div class="group-image-row"><div class="group-image-wrap"><img src="https://i.imgur.com/gC1Dm6T.png" /></div><div class="group-image-wrap"><img src="https://i.imgur.com/LbEi0j8.png" /></div></div></div><ul><li><strong>Random node <span class="math inline">\(z\)</span></strong> can not be done via Backpropagation!!!</li><li>The <span class="math inline">\(\epsilon\)</span> is <span class="math inline">\(N(0,1)\)</span> and will be not involved into Backpropagation!!</li></ul><h1 id="references">References</h1><ol type="1"><li><a href="https://www.youtube.com/watch?v=qJeaCHQ1k2w">Variational Autoencoders | Generative AI Animated</a></li><li><a href="https://www.youtube.com/watch?v=iwEzwTTalbg">Variational Autoencoder - Model, ELBO, loss function and maths explained easily! (<strong>Recommend</strong>)</a></li><li><a href="https://www.youtube.com/watch?v=Dg0YcABQ_aU">台大資訊 深度學習之應用 | ADL 10.3: Variational Auto-Encoder (VAE) 控制特徵的分布以生成用</a></li><li><a href="https://mp.weixin.qq.com/s/LwtwaPEkrhFMwazY3PfRew">深度理解变分自编码器(VAE) | 从入门到精通</a></li><li><a href="https://mp.weixin.qq.com/s/ZjAK_Z7jvrPMGslKiYca_Q">VAE原理及示例代码</a></li><li><a href="https://zhuanlan.zhihu.com/p/348498294?utm_psn=1866895402294468608">机器学习方法—优雅的模型（一）：变分自编码器（VAE）</a></li><li><a href="https://mp.weixin.qq.com/s/LFmFXA1hFZE8lesSk1XzzQ">VAE变分自编码器原理解析看这一篇就够了！另附Python代码实现</a></li><li><a href="https://stackabuse.com/autoencoders-for-image-reconstruction-in-python-and-keras/">Autoencoders for Image Reconstruction in Python and Keras</a></li><li><a href="https://arxiv.org/pdf/1906.02691">Diederik P. Kingma and Max Welling (2019), “An Introduction to Variational Autoencoders”, Foundations and Trends in Machine Learning: Vol. xx, No. xx, pp 1–18. DOI: 10.1561/XXXXXXXXX</a></li></ol>]]></content>
    
    
    <categories>
      
      <category>ML</category>
      
    </categories>
    
    
    <tags>
      
      <tag>NWP</tag>
      
      <tag>AI</tag>
      
      <tag>ML</tag>
      
      <tag>VAE</tag>
      
      <tag>Auto-Encoder</tag>
      
      <tag>Generative AI</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ML | ECMWF | Anemoi</title>
    <link href="/2025/01/25/ML-ECMWF-Anemoi/"/>
    <url>/2025/01/25/ML-ECMWF-Anemoi/</url>
    
    <content type="html"><![CDATA[<h1 id="anemoi">Anemoi</h1><p><a href="https://anemoi.ecmwf.int/">Anemoi</a> is a collaborative and open-source framework for developing machine learning weather forecasting models. Named after the Greek gods of the winds, the goal of Anemoi is to provide the key building blocks to train state‑of-the‑art data-driven weather forecasting models and run them in an operational context. As a framework it seeks to handle many of the complexities that meteorological organisations will share, allowing them to easily train models from existing recipes but with their own data.</p><ul><li><a href="https://eurocc-austria.at/fileadmin/eurocc-main/events/Webinar_Weather_Climate_13.11.2024/4_Mariana_Clare_AIFS_a_data-driven_probabilistic_weather_forecasting_system_-2.pdf">AIFS: a data-driven probabilistic forecasting system | Slides | November 13, 2024</a></li><li><a href="https://arxiv.org/abs/2406.01465v1">AIFS - ECMWF’s data-driven forecasting system | arXiv | 03 Jun 2024</a></li><li><a href="https://charts.ecmwf.int/?facets=%7B%22Product%20type%22%3A%5B%22Experimental%3A%20AIFS%22%2C%22Experimental%3A%20Machine%20learning%20models%22%5D%7D">Experimental: AIFS, Experimental: Machine learning models | Charts</a></li><li><a href="https://huggingface.co/ecmwf">https://huggingface.co/ecmwf | ecmwf/aifs-single</a><ul><li>To generate a new forecast using AIFS, you can use <code>anemoi-inference</code>. In the following notebook, a step-by-step workflow is specified to run the AIFS using the HuggingFace model:</li></ul></li></ul><h2 id="aifs">AIFS</h2><p><strong>AIFS</strong> is based on a <strong>graph neural network (GNN) encoder and decoder</strong>, and a sliding window transformer processor, and is trained on ECMWF’s ERA5 re-analysis and ECMWF’s operational numerical weather prediction (NWP) analyses.</p><ul><li>AIFS training data, <a href="https://www.ecmwf.int/en/newsletter/178/news/aifs-new-ecmwf-forecasting-system">AIFS: a new ECMWF forecasting system</a></li><li><a href="https://www.ecmwf.int/en/about/media-centre/aifs-blog/2024/first-update-aifs">First update to the AIFS | 16 January 2024</a></li><li><a href="https://www.ecmwf.int/en/about/media-centre/news/2024/bringing-together-users-researchers-and-coders-ecmwfs-machine">Bringing together users, researchers and coders in ECMWF’s machine learning efforts | 15 May 2024</a><ul><li>“Because of the code adaptation we’ve done, we can easily expand parts of the AIFS and Anemoi to regional systems,”</li></ul></li></ul><div class="group-image-container"><div class="group-image-row"><div class="group-image-wrap"><img src="https://i.imgur.com/GBcuV9S.png" width="600" /></div><div class="group-image-wrap"><img src="https://i.imgur.com/zHcuWYK.png" width="600" /></div></div></div><h2 id="webinar-anemoi---a-framework-for-building-the-aifs-and-other-data-driven-weather-forecasting-models-virtual-april-30-2024">Webinar: Anemoi - a framework for building the AIFS and other data-driven weather forecasting models | Virtual | April 30, 2024</h2><ul><li><a href="https://events.ecmwf.int/event/409/" class="uri">https://events.ecmwf.int/event/409/</a></li><li>Description<ul><li>Last year ECMWF introduced the AIFS, building on a series of innovative papers which demonstrated the potential of machine learning in creating data-driven weather forecasting models.</li><li>Machine learning models typically build on <strong>open-source frameworks, such as Tensorflow, PyTorch and JAX</strong> which allow communities to work together and build on one another's work. Weather forecasting brings its own challenges for machine learning, with large datasets and spatial-temporal problems.</li><li>In this webinar, we will introduce Anemoi, the toolbox from which the AIFS is trained.</li><li>We have been developing this toolbox with a view to many users both inside and outside of ECMWF to <strong>use the toolbox to train both global and local weather forecasting models</strong>. The toolbox aims to allow users to bring their own datasets and customise their ML models.</li><li>We will introduce the toolbox, talk through the steps needed to train a data-driven model and explain how Anemoi helps with these tasks. Finally we will outline a roadmap for future Anemoi development.</li></ul></li><li>Additional utility tools exist in supporting repositories beyond these core modules. Anemoi builds on top of ECMWF’s Artificial Intelligence Forecasting System (AIFS), expanding that codebase to enable wider functionality for a greater range of users. <strong>Future AIFS models will be trained using Anemoi</strong>.</li></ul><h2 id="discover-anemoi-webinar-series-online-13-30-january-2025">Discover Anemoi: Webinar Series | Online | 13-30 January 2025</h2><ul><li><a href="https://events.ecmwf.int/event/446/" class="uri">https://events.ecmwf.int/event/446/</a></li></ul><p>Discover Anemoi will feature six webinars, demonstrating the use of key components of the Anemoi ecosystem. The webinars will cover:</p><ul><li>An introduction to Anemoi</li><li>Creating datasets</li><li>Building graphs</li><li>Training models</li><li>Inference</li><li>Contributing as a developer</li></ul><h1 id="high-resolution-inside-the-nordic">High resolution inside the Nordic</h1><p>The AIFS is a global system, but work has also been going on in <strong>Anemoi to create regional (limited-area) ML systems</strong>. For example, <em>MET Norway</em> has created a regional model for Scandinavia (<a href="https://arxiv.org/abs/2409.02891v1">Nipen et al., 2024, arXiv:2409.02891</a>).</p><p>The plot shows a 7-day forecast of 10 m wind speed (shading) and sea-level pressure (contours). The model has learned to forecast at high resolution (here ~10 km) inside the Nordic region, and at low resolution (here ~100 km) outside of this domain. The model successfully creates a higher-resolution structure over the Nordics.</p><ul><li><a href="https://arxiv.org/pdf/2409.02891v1">Nipen, T. N., Haugen, H. H., Ingstad, M. S., Nordhagen, E. M., Salihi, A. F. S., Tedesco, P., ... &amp; Chantry, M. (2024). Regional data-driven weather modeling with a global stretched-grid. arXiv preprint arXiv:2409.02891.</a><ul><li>A <strong>data-driven model (DDM)</strong> suitable for regional weather forecasting applications is presented. The model extends the Artificial Intelligence Forecasting System by introducing a stretched-grid architecture that dedicates higher resolution over a regional area of interest and maintains a lower resolution elsewhere on the globe. The model is based on graph neural networks, which naturally affords arbitrary multi-resolution grid configurations.</li><li>The model is pre-trained on 43 years of global <strong>ERA5</strong> data at 31 km resolution and is further refined using 3.3 years of <strong>2.5 km resolution operational analyses from the MetCoOp Ensemble Prediction System (MEPS)</strong>.</li></ul></li></ul><p>The DDM was trained on compute nodes equipped with four AMD Instinct MI250X GPUs, each with 128 GB memory. To speed up training, we used <strong>data parallelism across 32 model instances for stages A–C</strong> and <strong>16 for stage D</strong>. For stages B–D, we used model parallelism to run one instance of the model on each node. This splits the nodes and edges of the graphs across multiple GPUs and is necessary for fitting the 31 km global and 2.5 km regional stretched-grid model within the available GPU memory</p><div class="group-image-container"><div class="group-image-row"><div class="group-image-wrap"><img src="https://i.imgur.com/xHsB08i.png" /></div><div class="group-image-wrap"><img src="https://i.imgur.com/yDB2LwN.png" /></div><div class="group-image-wrap"><img src="https://i.imgur.com/i8uLpch.png" /></div></div><div class="group-image-row"><div class="group-image-wrap"><img src="https://i.imgur.com/20hdCXS.png" /></div><div class="group-image-wrap"><img src="https://i.imgur.com/zzSAUKE.png" /></div></div></div><h1 id="build-anemoi">Build Anemoi</h1><p><strong>Anemoi</strong> is a framework for developing machine learning weather forecasting models. It comprises of components or packages for</p><ul><li>preparing training datasets,</li><li>conducting ML model training and</li><li>a registry for datasets and trained models.</li></ul><p>Anemoi provides tools for operational inference, including interfacing to verification software. As a framework it seeks to handle many of the complexities that meteorological organisations will share, allowing them to easily train models from existing recipes but with their own data.</p><ul><li><a href="https://anemoi.ecmwf.int/" class="uri">https://anemoi.ecmwf.int/</a></li></ul><p><img src="https://i.imgur.com/LqJLGkK.png" width="500" /></p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-attr">name:</span> <span class="hljs-string">anemoi</span><br><span class="hljs-attr">channels:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">conda-forge</span><br><span class="hljs-attr">dependencies:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">python==3.10.15</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">cuda==12.4.1</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">kerchunk</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">h5py</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">s3fs</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">pip:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">anemoi-utils[all]</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">anemoi-transform[all]</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">anemoi-datasets[create]</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">anemoi-models</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">anemoi-graphs</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">anemoi-training</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">anemoi-inference</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">anemoi-registry[all]</span><br></code></pre></td></tr></table></figure><h2 id="dependencies">Dependencies</h2><ul><li>Arrows indicate dependencies between packages.</li><li>Dashed lines indicate optional dependencies.</li></ul><p><img src="https://i.imgur.com/PIR32YC.png" width="300" /></p><h2 id="flow-of-data-in-inference">Flow of data in inference</h2><p>The schema above is a high-level overview of the data flow in the <strong>inference process</strong> (click on the image for a larger version).</p><p>Several key concepts are introduced:</p><p>Input:</p><ul><li>Prognostic variables:</li><li>Diagnostic variables:</li></ul><p>Output:</p><ul><li>Constant forcings:</li><li>Dynamic forcings:</li><li>Computed constants:</li><li>Computed forcings:</li></ul><p><img src="https://i.imgur.com/69OpDZv.png" width="700" /></p><h2 id="hugging-face-aifs-single-via-anemoi">Hugging Face | AIFS-single via anemoi</h2><ul><li><a href="https://huggingface.co/ecmwf/aifs-single/tree/main">Download the Model's Checkpoint</a> from <a href="https://huggingface.co/ecmwf/aifs-single">Hugging Face</a><ul><li>Note the aifs_single_v0.2.1.ckpt checkpoint just contains the model’s weights. That file does not contain any information about the optimizer states, lr-scheduler states, etc.</li><li>Training Procedure</li><li>Training Hyperparameters</li><li>Speeds, Sizes, Times<br /></li><li>Evaluation</li><li>Known limitations</li><li>Technical Specifications<ul><li>Hardware</li><li>Software<ul><li>The model was developed and trained using the AnemoI framework.</li></ul></li></ul></li></ul></li><li><a href="https://huggingface.co/ecmwf/aifs-single/blob/main/run_AIFS_v0_2_1.ipynb">https://huggingface.co/ecmwf/aifs-single/blob/main/run_AIFS_v0_2_1.ipynb</a><ul><li>DATE = OpendataClient().latest()</li></ul></li></ul><p><img src="https://i.imgur.com/rOuLVhs.png" width="400" /></p><h3 id="save-input_state">save input_state</h3><p>These functions are all that you need for saving and loading almost any object:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> pickle <br><br><span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">&#x27;saved_dictionary.pkl&#x27;</span>, <span class="hljs-string">&#x27;wb&#x27;</span>) <span class="hljs-keyword">as</span> f:<br>    pickle.dump(dictionary, f)<br>        <br><span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">&#x27;saved_dictionary.pkl&#x27;</span>, <span class="hljs-string">&#x27;rb&#x27;</span>) <span class="hljs-keyword">as</span> f:<br>    loaded_dict = pickle.load(f)<br></code></pre></td></tr></table></figure><h1 id="discover-anemoi-webinar-series">Discover Anemoi: Webinar Series</h1><ul><li><a href="https://events.ecmwf.int/event/446/timetable/" class="uri">https://events.ecmwf.int/event/446/timetable/</a></li></ul><iframe width="560" height="315" src="https://www.youtube.com/embed/AiO-GCIPcM4" title="Discover Anemoi: Introduction to Anemoi" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen></iframe><iframe width="560" height="315" src="https://www.youtube.com/embed/S91TGYrKg00" title="Discover Anemoi: Anemoi Datasets" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen></iframe><iframe width="560" height="315" src="https://www.youtube.com/embed/tIuyeQgGEG4" title="Discover Anemoi: Anemoi Graphs" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen></iframe><iframe width="560" height="315" src="https://www.youtube.com/embed/hbzgAsxDMX4" title="Discover Anemoi: Anemoi Training" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen></iframe><iframe width="560" height="315" src="https://www.youtube.com/embed/CEXqlpSuNPo" title="Discover Anemoi: Inference" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen></iframe><h1 id="references">References</h1><ol type="1"><li><a href="https://www.ecmwf.int/en/newsletter/178/news/aifs-new-ecmwf-forecasting-system">AIFS: a new ECMWF forecasting system | ECMWF | January 2024</a></li><li><a href="https://www.ecmwf.int/en/about/media-centre/news/2024/bringing-together-users-researchers-and-coders-ecmwfs-machine">Bringing together users, researchers and coders in ECMWF’s machine learning efforts | 15 May 2024</a></li><li><a href="https://www.ecmwf.int/en/about/media-centre/news/2024/machine-learning-play-growing-role-weather-forecasting-says-dg">Machine learning to play growing role in weather forecasting, says DG | ECMWF | 9 September 2024</a><ol type="1"><li>Machine learning is well suited to weather forecasting due to the vast amounts of data that are used to determine the best possible initial conditions and to produce global forecasts.<br /></li></ol></li><li><a href="https://www.ecmwf.int/en/newsletter/181/editorial/machine-learning-ensembles">Machine learning ensembles | ECMWF | October 2024</a></li><li><a href="https://data.cma.cn/site/article/id/42435.html">欧洲中期天气预报中心联合多国共推人工智能天气预报计划 | CMA</a><ol type="1"><li>目前，Anemoi吸引了西班牙国家气象局、丹麦气象研究所、德国气象局、芬兰气象研究所、意大利空军气象局、荷兰皇家气象研究所、挪威气象局、法国气象局、瑞士气象局和比利时皇家气象研究所的参与。一些国家基于Anemoi在机器学习模型的创建上取得了进展，如挪威气象局为斯堪的纳维亚创建了区域模型，德国气象局正利用其全球数值预报模式(ICON)数据开发一个名为AICON的数据驱动天气预报模型。</li></ol></li></ol>]]></content>
    
    
    <categories>
      
      <category>ML</category>
      
    </categories>
    
    
    <tags>
      
      <tag>NWP</tag>
      
      <tag>ECMWF</tag>
      
      <tag>AI</tag>
      
      <tag>ML</tag>
      
      <tag>Anemoi</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>WRF | MPAS | README.physics_files</title>
    <link href="/2025/01/24/WRF-MPAS-README.physics_files/"/>
    <url>/2025/01/24/WRF-MPAS-README.physics_files/</url>
    
    <content type="html"><![CDATA[<p>While browsing the WRF repository, I came across an introduction file in version 4.6.1, located at <code>WRF/run/README.physics_files</code>. This file provides a list of external files used by various physical schemes in the WRF model.</p><p>In this post, I'll give a brief overview for everyone to learn together.</p><p>When using certain schemes, we may wonder what data they rely on. The official documentation included a summary of the calling files in the <strong>update for version 4.3</strong> in <strong>April 2021</strong>, making it easier for everyone to reference. Subsequent minor versions have also included additional information,<strong>with the latest details primarily pertaining to version 4.6.1</strong>.</p><p>Initially, these files were located in the <code>run</code> directory and would then be linked to the <code>test/em_real</code> directory after compilation.</p><p>It's important to note that the files ending with "DBL" are only needed when using the real*8 double precision run mode.</p><p>You can check which fixed files are utilized in the parameterization schemes you commonly use.</p><ul><li><a href="https://github.com/wrf-model/WRF/blame/master/run/README.physics_files" class="uri">https://github.com/wrf-model/WRF/blame/master/run/README.physics_files</a></li></ul>    <div class="fold">      <div class="fold-title fold-info collapsed" data-toggle="collapse" href="#collapse-8f7bdefe" role="button" aria-expanded="false" aria-controls="collapse-8f7bdefe">        <div class="fold-arrow">▶</div>README.physics_files      </div>      <div class="fold-collapse collapse" id="collapse-8f7bdefe">        <div class="fold-content">          <figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br></pre></td><td class="code"><pre><code class="hljs text">This is a list of all the physics options that require additional files.<br>Necessary files are listed below each option.<br>Those files must be linked to the directory where WRF is run.<br><br>Note: the files with DBL at the end are only used when running the model with real*8<br><br>----------------------------------------------------------------------------------<br>Microphysics<br><br>Eta/Ferrier (Option 5):<br>ETAMPNEW_DATA<br>ETAMPNEW_DATA_DBL<br>ETAMPNEW_DATA.expanded_rain<br>ETAMPNEW_DATA.expanded_rain_DBL<br><br>Thompson (Option 8):<br>CCN_ACTIVATE.BIN<br><br>SBM (Options 30 and 32):<br>bulkdens.asc_s_0_03_0_9<br>bulkradii.asc_s_0_03_0_9<br>capacity.asc<br>coeff_p.asc<br>coeff_q.asc<br>constants.asc<br>kernels.asc_s_0_03_0_9<br>kernels_z.asc<br>masses.asc<br>termvels.asc<br><br>P3 (Options 50, 51, and 52)<br>p3_lookupTable_1.dat-3momI_v5.1.7<br>p3_lookupTable_1.dat-5.3-2momI<br>p3_lookupTable_2.dat-2momI_v5.2.3<br><br>Jensen (Option 55):<br>ishmael-gamma-tab.bin<br>ishmael-qi-qc.bin<br>ishmael-qi-qr.bin<br><br>----------------------------------------------------------------------------------<br>Surface<br><br>Slab 5-Layer (Option 1):<br>LANDUSE.TBL<br><br>Noah (Option 2):<br>LANDUSE.TBL<br>GENPARM.TBL<br>SOILPARM.TBL<br>VEGPARM.TBL<br><br>RUC (Option 3):<br>LANDUSE.TBL<br>GENPARM.TBL<br>SOILPARM.TBL<br>VEGPARM.TBL<br><br>NoahMP (Option 4):<br>LANDUSE.TBL<br>GENPARTM.TBL<br>MPTABLE.TBL<br>SOILPARM.TBL<br><br>CLM (Option 5):<br>LANDUSE.TBL<br>CLM_ALB_ICE_DFS_DATA<br>CLM_ALB_ICE_DRC_DATA<br>CLM_ASM_ICE_DFS_DATA<br>CLM_ASM_ICE_DRC_DATA<br>CLM_DRDSDT0_DATA<br>CLM_EXT_ICE_DFS_DATA<br>CLM_EXT_ICE_DRC_DATA<br>CLM_DRDSDT0_DATA<br>CLM_EXT_ICE_DFS_DATA<br>CLM_EXT_ICE_DRC_DATA<br>CLM_KAPPA_DATA<br>CLM_TAU_DATA<br><br>PX (Option 7):<br>LANDUSE.TBL<br>VEGPARM.TBL<br><br>SSiB (Option 8):<br>LANDUSE.TBL<br><br>Wind-farm SFC Layer (windturbine_spec = 1)<br>wind-turbine-1.tbl<br><br>----------------------------------------------------------------------------------<br>Radiation<br><br>RRTM (ra_lw_physics Option 1): <br>RRTM_DATA<br>RRTM_DATA_DBL<br>        (Since V4.4, using these files becomes a runtime option. *.SSP245 is linked by default)<br>        CAMtr_volume_mixing_ratio.A1B<br>        CAMtr_volume_mixing_ratio.A2<br>        CAMtr_volume_mixing_ratio.RCP4.5<br>        CAMtr_volume_mixing_ratio.RCP6<br>        CAMtr_volume_mixing_ratio.RCP8.5<br>        CAMtr_volume_mixing_ratio.SSP119<br>        CAMtr_volume_mixing_ratio.SSP126<br>        CAMtr_volume_mixing_ratio.SSP245<br>        CAMtr_volume_mixing_ratio.SSP370<br>        CAMtr_volume_mixing_ratio.SSP585<br><br>CAM (Option 3):<br>        aerosol.formatted<br>        aerosol_lat.formatted<br>        aerosol_lon.formatted<br>        aerosol_plev.formatted<br>        CAM_ABS_DATA<br>        CAM_AEROPT_DATA<br>        (if o3input=2 - default)<br>        ozone.formatted<br>        ozone_lat.formatted<br>        ozone_plev.formatted<br>        (Since V4.4, using these files becomes a runtime option. *.SSP245 is linked by default)<br>        CAMtr_volume_mixing_ratio.A1B<br>        CAMtr_volume_mixing_ratio.A2<br>        CAMtr_volume_mixing_ratio.RCP4.5<br>        CAMtr_volume_mixing_ratio.RCP6<br>        CAMtr_volume_mixing_ratio.RCP8.5<br>        CAMtr_volume_mixing_ratio.SSP119<br>        CAMtr_volume_mixing_ratio.SSP126<br>        CAMtr_volume_mixing_ratio.SSP245<br>        CAMtr_volume_mixing_ratio.SSP370<br>        CAMtr_volume_mixing_ratio.SSP585<br><br>RRTMG (Option 4,24,14):<br>RRTMG_LW_DATA<br>RRTMG_LW_DATA_DBL<br>RRTMG_SW_DATA<br>RRTMG_SW_DATA_DBL<br>        aerosol.formatted<br>        aerosol_lat.formatted<br>        aerosol_lon.formatted<br>        aerosol_plev.formatted<br>        (if o3input=2 - default)<br>        ozone.formatted<br>        ozone_lat.formatted<br>        ozone_plev.formatted<br>        (Since V4.4, using these files becomes a runtime option. *.SSP245 is linked by default)<br>        CAMtr_volume_mixing_ratio.A1B<br>        CAMtr_volume_mixing_ratio.A2<br>        CAMtr_volume_mixing_ratio.RCP4.5<br>        CAMtr_volume_mixing_ratio.RCP6<br>        CAMtr_volume_mixing_ratio.RCP8.5<br>        CAMtr_volume_mixing_ratio.SSP119<br>        CAMtr_volume_mixing_ratio.SSP126<br>        CAMtr_volume_mixing_ratio.SSP245<br>        CAMtr_volume_mixing_ratio.SSP370<br>        CAMtr_volume_mixing_ratio.SSP585<br><br>Goddard (Option 5):<br>BROADBAND_CLOUD_GODDARD.bin<br><br>GFDL (Option 99):<br>co2_trans<br>tr49t67<br>tr49t85<br>tr67t85<br><br>Eclipse option (ra_sw_eclipse = 1)<br>        eclipse_besselian_elements.dat<br><br>----------------------------------------------------------------------------------<br>Other Options:<br><br>Urban Physics, no LCZ (sf_urban_physics = 1, 2, &amp; 3)<br>URBPARM.TBL<br><br>Urban Physics (sf_urban_physics = 1, 2, and 3) with LCZ (use_wudapt_lcz = 1)<br>URBPARM_LCZ.TBL<br><br>Chemistry (chem_opt = 112, 114, 111, 201, 202)<br>HLC.TBL<br></code></pre></td></tr></table></figure>        </div>      </div>    </div>]]></content>
    
    
    <categories>
      
      <category>WRF</category>
      
    </categories>
    
    
    <tags>
      
      <tag>HPC</tag>
      
      <tag>NWP</tag>
      
      <tag>WRF</tag>
      
      <tag>MPAS</tag>
      
      <tag>MPI</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ML | set CUDA_HOME in a conda environment</title>
    <link href="/2025/01/22/ML-set-CUDA_HOME-in-a-conda-environment/"/>
    <url>/2025/01/22/ML-set-CUDA_HOME-in-a-conda-environment/</url>
    
    <content type="html"><![CDATA[<h1 id="set-cuda_home-in-a-conda-environment">set CUDA_HOME in a conda environment</h1><figure class="highlight console"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs console">micromamba install -c conda-forge cudatoolkit-dev<br>which nvcc<br>nvcc --version<br>echo $CUDA_HOME<br>export CUDA_HOME=$CONDA_PREFIX<br>echo $CUDA_HOME<br></code></pre></td></tr></table></figure><h1 id="references">References</h1><ol type="1"><li><a href="https://vinesmsuic.github.io/linux-conda-cudahome/index.html">How to set my CUDA_HOME in a conda environment?</a></li><li><a href="https://github.com/conda/conda/issues/7757#issuecomment-967303351" class="uri">https://github.com/conda/conda/issues/7757#issuecomment-967303351</a></li><li></li></ol>]]></content>
    
    
    <categories>
      
      <category>ML</category>
      
    </categories>
    
    
    <tags>
      
      <tag>AI</tag>
      
      <tag>ML</tag>
      
      <tag>pytorch</tag>
      
      <tag>NVIDIA</tag>
      
      <tag>CUDA</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>NWP | Clear-sky vs. All-sky Approaches in NWP and DA</title>
    <link href="/2025/01/21/NWP-Clear-sky-vs-All-sky-Approaches-in-NWP-and-DA/"/>
    <url>/2025/01/21/NWP-Clear-sky-vs-All-sky-Approaches-in-NWP-and-DA/</url>
    
    <content type="html"><![CDATA[<h1 id="clear-sky-vs.-all-sky-approaches-in-nwp-and-da">Clear-sky vs. All-sky Approaches in NWP and DA</h1><p>In the field of Numerical Weather Prediction (NWP) and Data Assimilation (DA), the <strong>clear-sky</strong> and <strong>all-sky</strong> approaches represent two different methodologies for incorporating satellite observations into weather models.</p><h2 id="clear-sky-approach">Clear-sky Approach</h2><p>The <strong>clear-sky approach</strong> has been the traditional method used in NWP since the 1980s, <strong>where observations (obs) affected by clouds are typically excluded from the assimilation process</strong>. This exclusion arises from the challenges in accurately modeling cloud and precipitation conditions, which can significantly distort satellite measurements. As a result, only cloud-free observations are assimilated, limiting the amount of useful data incorporated into weather models. (<strong>其中受雲影響的觀測 (obs) 被排除在同化過程之外</strong>)</p><ul><li><strong>Limitations</strong>:<ul><li>Excludes a large percentage of available satellite data, particularly in cloudy regions.</li><li>Can lead to biases in model outputs due to lack of information about cloud dynamics and moisture distribution.</li></ul></li></ul><h2 id="all-sky-approach">All-sky Approach</h2><p>The <strong>all-sky approach</strong>, developed more recently, aims to utilize all available satellite observations, <strong>including those impacted by clouds and precipitation</strong>. This method has gained traction over the last decade as advancements in data assimilation techniques have improved the ability to handle cloud-affected data effectively.</p><ul><li><strong>Key Features</strong>:<ul><li>Direct assimilation of satellite radiances in cloudy conditions, allowing for a more comprehensive use of available data.</li><li>Enhances the analysis of atmospheric variables such as temperature, humidity, and wind speed by incorporating information from cloud structures.</li><li>Aims to correct systematic errors in forecasts by using cloud-related observations to inform model adjustments.</li></ul></li></ul><h2 id="benefits-of-all-sky-assimilation">Benefits of All-sky Assimilation</h2><ol type="1"><li><strong>Increased Data Utilization</strong>: The all-sky approach allows for a more balanced assimilation of satellite observations across both clear and cloudy areas, overcoming previous biases towards clear conditions.</li><li><strong>Improved Forecast Accuracy</strong>: Studies have shown that using all-sky data can lead to statistically significant reductions in forecast errors, particularly in regions where clouds are prevalent.</li><li><strong>Enhanced Coverage</strong>: By including cloud-affected observations, the all-sky method improves coverage in meteorologically interesting areas that may otherwise be underrepresented in NWP models.</li></ol><h2 id="challenges-ahead">Challenges Ahead</h2><p>Despite its advantages, <strong>the all-sky approach still faces challenges</strong>, particularly concerning observation error modeling and the complexities introduced by cloud dynamics. Ongoing research is necessary to refine these methods further and ensure their operational viability across various forecasting systems.</p><p>In summary, while the clear-sky approach has served as a foundation for satellite data assimilation in NWP, the all-sky approach represents a significant evolution that seeks to leverage more comprehensive datasets for improved weather forecasting capabilities.</p><h1 id="literature-review">Literature review</h1><ul><li><a href="https://www.mdpi.com/2073-4433/11/6/599/pdf">Wang, Jingnan, et al. "Comparison of assimilating all-sky and clear-sky satellite radiance for Typhoon Chan-Hom and Nangka forecasts." Atmosphere 11.6 (2020): 599.</a><ul><li>In the past, the radiative transfer model was not able to represent the scattering properties of hydrometeors well. Furthermore, because of the poor understanding and predictability of clouds and precipitation, as well as the discontinuous, nonlinear nature of moist atmospheric processes [2], <strong>satellite observations are mainly assimilated under clear-sky conditions, discarding a large number of observations in clouds and precipitation area</strong>.</li><li><strong>In infrared channels particularly, most data are rejected because of “cloud contamination”</strong> [3].</li><li>The European Centre for Medium-Range Weather Forecasts (ECMWF) has applied all-sky satellite radiance assimilation, directly making use of observations of clouds and precipitation which provide clearly positive effects on short-term forecasts [13,14].</li></ul></li></ul><figure><img src="https://i.imgur.com/tckuU85.png" alt="Figure 2. Brightness temperature simulation for AMSR2 channel 10 after (a) clear-sky quality control and (b) all-sky quality control." width="600" /><figcaption>Figure 2. Brightness temperature simulation for AMSR2 channel 10 after (a) clear-sky quality control and (b) all-sky quality control.</figcaption></figure><ul><li><a href="https://journals.ametsoc.org/downloadpdf/view/journals/mwre/150/5/MWR-D-21-0273.1.pdf">Duncan, D. I., Bormann, N., Geer, A. J., &amp; Weston, P. (2022). Assimilation of AMSU-A in all-sky conditions. Monthly Weather Review, 150(5), 1023-1041.</a></li></ul><figure><img src="https://i.imgur.com/mItN9pH.png" alt="First-guess departures for (top) all-sky and (bottom) clear-sky channel-5 observations assimilated during the 0000 UTC long window on 15 Sep 2019, normalized by the observation errors assigned. The National Hurricane Center (NHC) best track locations at 0000 UTC over the life of Humberto are given by a black ×, with a white circle showing the hurricane location on this date, just east of Florida. Data from all AMSU-A sensors are shown together. Departures are normalized by the assigned observation errors." width="600" /><figcaption>First-guess departures for (top) all-sky and (bottom) clear-sky channel-5 observations assimilated during the 0000 UTC long window on 15 Sep 2019, normalized by the observation errors assigned. The National Hurricane Center (NHC) best track locations at 0000 UTC over the life of Humberto are given by a black ×, with a white circle showing the hurricane location on this date, just east of Florida. Data from all AMSU-A sensors are shown together. Departures are normalized by the assigned observation errors.</figcaption></figure><ul><li><a href="https://link.springer.com/article/10.1007/s00376-021-0401-y">Li, Yu, Keyi Chen, and Zhipeng Xian. "Evaluation of all-Sky assimilation of FY-3C/MWHS-2 on Mei-yu precipitation forecasts over the Yangtze-Huaihe river basin." Advances in Atmospheric Sciences 38 (2021): 1397-1414.</a><ul><li>采用晴天、多云、雨区等全天候条件下同化微波观测资料对提升与云雨相关的重大天气过程的预报水平有潜在的积极作用。本文选取2017年6月28日至7月3日一次典型的梅雨锋暴雨过程进行了同化及预报研究,基于中尺度WRF-ARW模式及其同化系统WRFDA,采用3D-Var同化方法,利用风云三号C星微波湿度计(FY-3C/MWHS-2)观测资料进行了晴空和全天候同化试验。其结果表明:<strong>全天候同化试验能更加充分的利用云雨区域的微波探测信息,其对FY-3C/MWHS-2的资料利用率比晴空同化试验高出10%</strong>。另外,全天候同化试验减小了约0.5%的湿度场预报误差,对强降水的预报产生了正面影响,但其对风场和温度场的预报总体呈中性的影响。虽然本文中使用的全天候同化算法只能调节湿度、风和温度有关的变量,不能直接获取云雨的信息,但是其对暴雨预报的积极影响在防灾减灾方面存在潜在的业务应用前景。</li></ul></li><li><a href="https://link.springer.com/article/10.1007/s00376-020-0219-z">Xu, Dongmei, et al. "Assimilating all-sky infrared radiances from Himawari-8 using the 3DVar method for the prediction of a severe storm over North China." Advances in Atmospheric Sciences 38 (2021): 661-676.</a><ul><li>使用3DVar方法吸收来自Himawari-8的全天红外辐射，以预测华北地区的一场强风暴。尽管雷达观测以高时空分辨率捕获了暴风雨结构，但在降水形成后，它们仅限于暴风雨区域内。对地静止卫星数据覆盖了风暴和周围环境降水形成之前雷达网络中的空白。该研究探索了使用Himawari-8数据与天气研究和预报模型数据同化系统（WRFDA）融合从Himawari-8数据中吸收水汽通道辐射的效果，该辐射对华北地区发生了严重的暴雨。这项研究最初在WRFDA系统的框架中增强了用于高级Himawari成像仪（AHI）辐射的快速云检测方案。在进行数据同化之前，先进行偏差校正，晴空AHI辐射的云探测和多云辐射的观测误差建模。完全应用了所有AHI辐射观测值，而没有对全天候AHI辐射数据同化进行任何质量控制。结果表明，通过使用依赖于云的观测误差模型，模拟的全天空AHI辐射度更适合观测，从而进一步提高了云的高度。全天候的AHI辐射同化会调整所有类型的水凝物变量，尤其是云水和降水雪。事实证明，通过对雷达反射率进行验证，吸收全天候AHI数据可以改善水凝物规格。因此，与仅使用常规和AHI晴朗天空辐射率数据的实验相比，在全天条件下对AHI观测值的同化对降水位置和强度都有整体改善的影响。</li></ul></li></ul><h1 id="clear-sky-vs.-all-sky-in-da">Clear-sky vs. All-sky in DA</h1><p>The implementation of <strong>all-sky assimilation in the data assimilation (DA) process is generally considered more challenging than the clear-sky approach</strong>. Here are the main factors contributing to this complexity:</p><h2 id="complexity-of-radiative-transfer-modeling">1. <strong>Complexity of Radiative Transfer Modeling</strong></h2><p>All-sky assimilation involves dealing with the intricate effects of clouds on radiative transfer, which complicates the interpretation of satellite observations. The modeling of radiative transfer in cloudy conditions is inherently complex due to scattering effects caused by hydrometeors like ice, snow, and rain. This complexity makes it difficult to accurately interpret satellite observations, as the radiative signal can be significantly altered by cloud properties. Errors from scattering can lead to misinterpretation of temperature increments, complicating the assimilation process. Unlike clear-sky conditions, where the radiative signal is straightforward, clouds introduce scattering and absorption phenomena that must be accurately modeled to extract useful data from satellite observations.</p><h2 id="observation-error-characterization">2. <strong>Observation Error Characterization</strong></h2><p>In all-sky conditions, characterizing observation errors becomes more difficult due to the variability introduced by different cloud types and precipitation. This can lead to larger and correlated errors in observations, complicating the assimilation process and potentially degrading forecast accuracy if not properly managed.</p><h2 id="data-volume-and-quality-management">3. <strong>Data Volume and Quality Management</strong></h2><p>While all-sky assimilation can provide a greater volume of data (up to 65% more than clear-sky assimilation), the challenge lies in managing this increased data volume effectively. The added complexity of integrating cloud-affected observations requires sophisticated methods to ensure that the quality of assimilated data does not compromise forecast performance.</p><h2 id="operational-implementation-challenges">4. <strong>Operational Implementation Challenges</strong></h2><p>Despite its potential benefits, all-sky assimilation has not yet been widely adopted operationally due to concerns about whether it can consistently improve forecast scores compared to existing clear-sky systems. Operational centers often have well-established clear-sky assimilation frameworks, making it difficult to transition to all-sky methods without risking degradation in forecast quality.</p><h2 id="balancing-signal-and-noise">5. <strong>Balancing Signal and Noise</strong></h2><p>Incorporating cloud-affected observations requires careful balancing between meaningful signals and noise. The challenge is to ensure that the assimilation system does not overfit cloud observations, which can lead to inaccuracies in model initialization and subsequent forecasts.</p><h2 id="zero-gradient-problem">6. <strong>Zero Gradient Problem</strong></h2><p>The zero gradient problem arises when data assimilation systems struggle to incorporate cloud information effectively in the absence of clouds in the background state. This issue complicates the initialization of clouds and can hinder the overall performance of the assimilation system</p><h2 id="conclusion">Conclusion</h2><p>Overall, while all-sky assimilation offers significant advantages in utilizing a broader range of satellite data, its implementation is fraught with challenges that require advanced modeling techniques and careful management of observation errors. These complexities make it a more demanding process compared to clear-sky assimilation in the DA framework.</p>]]></content>
    
    
    <categories>
      
      <category>NWP</category>
      
    </categories>
    
    
    <tags>
      
      <tag>NWP</tag>
      
      <tag>WRF</tag>
      
      <tag>MPAS</tag>
      
      <tag>DA</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>MPAS | UXarray</title>
    <link href="/2025/01/17/MPAS-UXarray/"/>
    <url>/2025/01/17/MPAS-UXarray/</url>
    
    <content type="html"><![CDATA[<h1 id="uxarray">UXarray</h1><p>Xarray extension for <strong>unstructured climate and global weather data analysis and visualization</strong> written around the UGRID conventions.</p><h2 id="why">Why?</h2><p>UXarray aims to address the geoscience community need for tools that enable standard data analysis techniques to operate directly on unstructured grids. It extends upon and inherits from the commonly used Xarray Python package to provide a powerful and familiar interface for working with unstructured grids in Python. UXarray provides Xarray styled functions to better read in and use unstructured grid datasets that follow standard conventions, including UGRID, MPAS, SCRIP, and Exodus formats.</p><p>The “U” in UXarray stands for “Unstructured Grids”.</p><ul><li><a href="https://uxarray.readthedocs.io/en/latest/" class="uri">https://uxarray.readthedocs.io/en/latest/</a></li></ul><h1 id="installation">Installation</h1><figure class="highlight console"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs console">micromamba env create -n uxarray<br>micromamba activate uxarray<br>micromamba install conda-forge::uxarray==2024.11.1<br>micromamba install scipy<br>micromamba install conda-forge::netcdf4<br>micromamba install conda-forge::wrf-python<br>micromamba install conda-forge::cartopy<br>micromamba install conda-forge::basemap<br></code></pre></td></tr></table></figure><p>where <code>uxarray==2024.11.1</code> can be changed.</p><h2 id="jupyter-notebook">Jupyter Notebook</h2><p>Use Jupyter Notebook instead of JupyterLab, as the latter does not display the variable mesh correctly when zoomed in.</p><ul><li>trick<ul><li>convert JupyterLab to Jupyter Notebook on broswer</li><li>on http path, remove <code>tree</code> and enter.</li></ul></li></ul><h1 id="plot-simple-start">Plot: Simple Start</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs JupyterNotebook">import uxarray as ux<br>import numpy as np<br>import matplotlib.pyplot as plt<br>from matplotlib import colors<br><br>file_dir=&quot;/home/wpsze/MPAS-A/meshes/x1.40962_120km/&quot;<br><br>grid_path = f&quot;&#123;file_dir&#125;/static.nc&quot;<br>data_path = f&quot;&#123;file_dir&#125;/static.nc&quot;<br>print(grid_path)<br>print(data_path)<br>uxds = ux.open_dataset(grid_path, data_path)<br><br># Plot ivgtyp<br>uxds[&quot;ivgtyp&quot;].plot(coastline=&quot;10m&quot;, cmap=&quot;jet&quot;, clim=(1, 20), dynamic=True)<br><br># make a color map of fixed colors<br>cmap = colors.ListedColormap([&#x27;white&#x27;, &#x27;green&#x27;, &#x27;red&#x27;, &#x27;blue&#x27;, &#x27;white&#x27;])<br>uxds[&quot;ivgtyp&quot;].plot(coastline=&quot;10m&quot;, cmap=cmap, clim=(11, 15), dynamic=True)<br><br># wind speed from u10 and v10<br>tmp = uxds[&quot;u10&quot;]<br>tmp[&quot;u10&quot;] = np.sqrt(uxds[&quot;u10&quot;]**2 + uxds[&quot;v10&quot;]**2)<br>tmin, tmax = int(tmp[&quot;u10&quot;].min().values), int(tmp[&quot;u10&quot;].max().values)<br>tmp[&quot;u10&quot;].isel(Time=0).plot(coastline=&quot;10m&quot;, cmap=&quot;jet&quot;, clim=(tmin, tmax), dynamic=True)<br></code></pre></td></tr></table></figure><div class="group-image-container"><div class="group-image-row"><div class="group-image-wrap"><img src="https://i.imgur.com/JuNIoOk.png" /></div><div class="group-image-wrap"><img src="https://i.imgur.com/qV0CrXV.png" /></div></div><div class="group-image-row"><div class="group-image-wrap"><img src="https://i.imgur.com/EWzShPE.png" /></div><div class="group-image-wrap"><img src="https://i.imgur.com/WjlzFsd.png" /></div></div><div class="group-image-row"></div></div><h1 id="grid-topology-visualization">Grid Topology Visualization</h1><ul><li>take a bit longer time to process</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs JupyterNotebook">uxgrid = uxds.uxgrid<br>uxgrid.plot(title=&quot;Grid Plot Accessor&quot;)<br>uxgrid.plot(coastline=&quot;10m&quot;, title=&quot;Grid Plot Accessor&quot;)<br>uxgrid.plot.edges(color=&quot;black&quot;, title=&quot;Grid Edge Plot&quot;)<br><br>(<br>    uxgrid.plot.edges(color=&quot;black&quot;)<br>    * uxgrid.plot.nodes(marker=&quot;o&quot;, size=150).relabel(&quot;Corner Nodes&quot;)<br>    * uxgrid.plot.face_centers(marker=&quot;s&quot;, size=150).relabel(&quot;Face Centers&quot;)<br>    * uxgrid.plot.edge_centers(marker=&quot;^&quot;, size=150).relabel(&quot;Edge Centers&quot;)<br>).opts(title=&quot;Grid Coordinates&quot;, legend_position=&quot;top_right&quot;)<br></code></pre></td></tr></table></figure><div class="group-image-container"><div class="group-image-row"><div class="group-image-wrap"><img src="https://i.imgur.com/GatMAmn.png" /></div><div class="group-image-wrap"><img src="https://i.imgur.com/AOoyabH.png" /></div></div><div class="group-image-row"><div class="group-image-wrap"><img src="https://i.imgur.com/7QJkxL7.png" /></div><div class="group-image-wrap"><img src="https://i.imgur.com/tJahcAo.png" /></div></div><div class="group-image-row"></div></div><h1 id="geographic-projections-features">Geographic Projections &amp; Features</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs JupyterNotebook">import cartopy.crs as ccrs<br>import geoviews.feature as gf<br><br>central_longitude = 114<br><br>uxds[&quot;ivgtyp&quot;].plot.polygons(<br>    rasterize=True,<br>    projection=ccrs.Orthographic(central_longitude=central_longitude),<br>    cmap=ux.cmaps.sequential_blue,<br>    title=&quot;Projected Polygon Plot (Centered about 114 degrees longitude)&quot;,<br>) * gf.coastline(projection=ccrs.Orthographic(central_longitude=central_longitude))<br></code></pre></td></tr></table></figure><p><img src="https://i.imgur.com/a5RvPaz.png" width="500" /></p>]]></content>
    
    
    <categories>
      
      <category>MPAS</category>
      
    </categories>
    
    
    <tags>
      
      <tag>MPAS</tag>
      
      <tag>UXarray</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>CFD | OpenFOAM | fluentMeshToFoam .msh to openfoam</title>
    <link href="/2025/01/15/CFD-fluentMeshToFoam-msh-to-openfoam/"/>
    <url>/2025/01/15/CFD-fluentMeshToFoam-msh-to-openfoam/</url>
    
    <content type="html"><![CDATA[<h1 id="issue">Issue</h1><ul><li><a href="https://cfd-china.com/topic/7815/%E4%B8%80%E4%B8%AA%E5%8F%AF%E5%8E%8B%E7%BC%A9%E8%B6%85%E9%9F%B3%E9%80%9Fopenfoam%E7%AE%97%E4%BE%8B-%E6%83%B3%E6%89%BE%E4%B8%AAfluent%E5%A4%A7%E4%BD%AC%E6%9D%A5%E8%AE%BE%E7%BD%AE%E4%B8%80%E4%B8%AA?lang=en-US">一个可压缩超音速OpeNFOAM算例，想找个fluent大佬来设置一个</a><ul><li>粘度： 0</li><li>湍流模型：无</li><li>二维算例，所有壁面都可以为滑移，或者零梯度边界</li><li>进口边界：静压：1e5、温度：400K、速度：1000m/s</li><li>没有其他进口；右边是出口</li><li>稳态</li><li>网格数量：10000个</li></ul></li></ul><div class="note note-primary">            <p>OpenFOAM计算大约3秒算完。最大压力 810000 。想看一下Fluent的最大压力多少。</p>          </div><ul><li><a href="http://dyfluid.com/openfoam.html#id2">稳态超音速横向射流</a><ul><li><a href="https://cfd-china.com/topic/7064/rhosimplefoam%E6%B1%82%E8%A7%A3%E8%B6%85%E9%9F%B3%E9%80%9F%E6%A8%AA%E5%90%91%E5%B0%84%E6%B5%81%E9%97%AE%E9%A2%98/11">rhoSimpleFoam求解超音速横向射流问题</a></li><li></li></ul></li></ul><p><img src="https://cfd-china.com/assets/uploads/files/1736863312130-%E6%8D%95%E8%8E%B7.jpg" /></p><h1 id="review-openfoam">Review OpenFOAM</h1><p>In OpenFOAM, directories play a crucial role in organizing files and data for simulations. Here's an overview of common directories and their meanings:</p><ol type="1"><li><p><strong>Case Directory</strong>: This is the main folder for a specific simulation case. It contains all the files related to that simulation.</p></li><li><p><strong>0 (Zero Directory)</strong>: Contains initial conditions for the simulation. Files here specify the starting values for variables (e.g., velocity, pressure) at time zero.</p></li><li><strong>constant Directory</strong>: Holds files related to the physical properties of the simulation. This includes:<ul><li><strong>transportProperties</strong>: Defines fluid properties like viscosity and density.</li><li><strong>turbulenceProperties</strong>: Specifies turbulence models and parameters.</li></ul></li><li><strong>system Directory</strong>: Contains files that control the simulation execution, including:<ul><li><strong>controlDict</strong>: Manages the simulation time, output frequency, and solver settings.</li><li><strong>fvSchemes</strong>: Defines numerical schemes for discretization.</li><li><strong>fvSolution</strong>: Contains solver settings and tolerances.</li></ul></li><li><p><strong>Post-processing Directories</strong>: After running a simulation, results can be processed and visualized. Directories like <code>results</code> or <code>output</code> might be used for storing processed data.</p></li><li><p><strong>Allrun and Allclean Scripts</strong>: Often found in the case directory, these scripts automate the running and cleaning processes for simulations.</p></li></ol><p>Understanding these directories is essential for effectively using OpenFOAM, as each serves a specific purpose in the overall workflow of setting up, running, and analyzing simulations.</p><h1 id="fluentmeshtofoamfluent3dmeshtofoam">fluentMeshToFoam/fluent3DMeshToFoam</h1>    <div class="fold">      <div class="fold-title fold-info collapsed" data-toggle="collapse" href="#collapse-8f7bdefe" role="button" aria-expanded="false" aria-controls="collapse-8f7bdefe">        <div class="fold-arrow">▶</div>fluentMeshToFoam/fluent3DMeshToFoam      </div>      <div class="fold-collapse collapse" id="collapse-8f7bdefe">        <div class="fold-content">          <figure class="highlight console"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs console">Usage: fluentMeshToFoam [OPTIONS] &lt;Fluent mesh file&gt;<br>options:<br>  -2D &lt;thickness&gt;   use when converting a 2-D mesh (applied before scale)<br>  -case &lt;dir&gt;       specify alternate case directory, default is the cwd<br>  -fileHandler &lt;handler&gt;<br>                    override the fileHandler<br>  -libs &lt;(lib1 .. libN)&gt;<br>                    pre-load libraries<br>  -noFunctionObjects<br>                    do not execute functionObjects<br>  -scale &lt;factor&gt;   geometry scaling factor - default is 1<br>  -writeSets        write cell zones and patches as sets<br>  -writeZones       write cell zones as zones<br>  -srcDoc           display source code in browser<br>  -doc              display application documentation in browser<br>  -help             print the usage<br><br>Using: OpenFOAM-8 (see https://openfoam.org)<br>Build: 8<br><br><br>Usage: fluent3DMeshToFoam [OPTIONS] &lt;Fluent mesh file&gt;<br>options:<br>  -case &lt;dir&gt;       specify alternate case directory, default is the cwd<br>  -cubit            special parsing of (incorrect) cubit files<br>  -fileHandler &lt;handler&gt;<br>                    override the fileHandler<br>  -ignoreCellGroups &lt;names&gt;<br>                    specify cell groups to ignore<br>  -ignoreFaceGroups &lt;names&gt;<br>                    specify face groups to ignore<br>  -includedAngle &lt;angle&gt;<br>                    feature angle with which to split cyclics<br>  -libs &lt;(lib1 .. libN)&gt;<br>                    pre-load libraries<br>  -noFunctionObjects<br>                    do not execute functionObjects<br>  -scale &lt;factor&gt;   geometry scaling factor - default is 1<br>  -srcDoc           display source code in browser<br>  -doc              display application documentation in browser<br>  -help             print the usage<br><br>Using: OpenFOAM-8 (see https://openfoam.org)<br>Build: 8<br></code></pre></td></tr></table></figure>        </div>      </div>    </div><p>Here's how to convert a .msh file to OpenFOAM format using fluentMeshToFoam:</p><ol type="1"><li><p>Create a new empty directory for your case: <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">mkdir</span> supersonic<br><span class="hljs-built_in">cd</span> supersonic<br></code></pre></td></tr></table></figure></p></li><li><p>Create the basic OpenFOAM directory structure: <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">mkdir</span> constant<br><span class="hljs-built_in">mkdir</span> system<br></code></pre></td></tr></table></figure> and prepare all requried files,</p></li><li><p>Copy your .msh file to the case directory: <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ file supersonic_injet-stead.msh <br>supersonic_injet-stead.msh: ASCII text<br><br><span class="hljs-built_in">cp</span> /path/to/your/supersonic_injet-stead.msh .<br></code></pre></td></tr></table></figure></p></li><li><p>Run the conversion tool: <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">fluent3DMeshToFoam supersonic_injet-stead.msh<br></code></pre></td></tr></table></figure></p></li></ol>    <div class="fold">      <div class="fold-title fold-info collapsed" data-toggle="collapse" href="#collapse-90469042" role="button" aria-expanded="false" aria-controls="collapse-90469042">        <div class="fold-arrow">▶</div>fluent3DMeshToFoam results      </div>      <div class="fold-collapse collapse" id="collapse-90469042">        <div class="fold-content">          <figure class="highlight console"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><code class="hljs console">/*---------------------------------------------------------------------------*\<br>  =========                 |<br>  \\      /  F ield         | OpenFOAM: The Open Source CFD Toolbox<br>   \\    /   O peration     | Website:  https://openfoam.org<br>    \\  /    A nd           | Version:  8<br>     \\/     M anipulation  |<br>\*---------------------------------------------------------------------------*/<br>Build  : 8<br>Exec   : fluent3DMeshToFoam supersonic_injet-stead.msh<br>Date   : Jan 15 2025<br>Time   : 15:10:16<br>Host   : &quot;xxx&quot;<br>PID    : 2856052<br>I/O    : uncollated<br>Case   : /home/wpsze/openfoam/simulation/supersonic<br>nProcs : 1<br>sigFpe : Enabling floating point exception trapping (FOAM_SIGFPE).<br>fileModificationChecking : Monitoring run-time modified files using timeStampMaster (fileModificationSkew 10)<br>allowSystemOperations : Allowing user-supplied system call operations<br><br>// * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * //<br>Create time<br><br>Dimension of grid: 3<br>Number of points: 20850<br>Number of cells: 10180<br>Number of faces: 40964<br>PointGroup: 1 start: 0 end: 20849.  Reading points...done.<br>FaceGroup: 2 start: 0 end: 20115.  Reading mixed faces...done.<br>FaceGroup: 10 start: 20116 end: 20171.  Reading mixed faces...done.<br>FaceGroup: 11 start: 20172 end: 20173.  Reading mixed faces...done.<br>FaceGroup: 12 start: 20174 end: 20355.  Reading mixed faces...done.<br>FaceGroup: 13 start: 20356 end: 20411.  Reading mixed faces...done.<br>FaceGroup: 14 start: 20412 end: 20591.  Reading mixed faces...done.<br>FaceGroup: 15 start: 20592 end: 20603.  Reading mixed faces...done.<br>FaceGroup: 16 start: 20604 end: 40963.  Reading mixed faces...done.<br>CellGroup: 1 start: 0 end: 10179 type: 1<br>Zone: 1 name: fluid-1 type: fluid.  Reading zone data...done.<br>Zone: 2 name: interior-1 type: interior.  Reading zone data...done.<br>Zone: 10 name: inlet1 type: pressure-outlet.  Reading zone data...done.<br>Zone: 11 name: inlet2 type: pressure-outlet.  Reading zone data...done.<br>Zone: 12 name: top type: pressure-outlet.  Reading zone data...done.<br>Zone: 13 name: outlet type: pressure-outlet.  Reading zone data...done.<br>Zone: 14 name: bottom type: wall.  Reading zone data...done.<br>Zone: 15 name: obstacle type: wall.  Reading zone data...done.<br>Zone: 16 name: frontandback type: pressure-outlet.  Reading zone data...done.<br><br>FINISHED LEXING<br><br>Creating patch 0 for zone: 10 name: inlet1 type: pressure-outlet<br>Creating patch 1 for zone: 11 name: inlet2 type: pressure-outlet<br>Creating patch 2 for zone: 12 name: top type: pressure-outlet<br>Creating patch 3 for zone: 13 name: outlet type: pressure-outlet<br>Creating patch 4 for zone: 14 name: bottom type: wall<br>Creating patch 5 for zone: 15 name: obstacle type: wall<br>Creating patch 6 for zone: 16 name: frontandback type: pressure-outlet<br>Creating cellZone 0 name: fluid-1 type: fluid<br>Creating faceZone 0 name: interior-1 type: interior<br>faceZone from Fluent indices: 0 to: 20115 type: interior<br>patch 0 from Fluent indices: 20116 to: 20171 type: pressure-outlet<br>patch 1 from Fluent indices: 20172 to: 20173 type: pressure-outlet<br>patch 2 from Fluent indices: 20174 to: 20355 type: pressure-outlet<br>patch 3 from Fluent indices: 20356 to: 20411 type: pressure-outlet<br>patch 4 from Fluent indices: 20412 to: 20591 type: wall<br>patch 5 from Fluent indices: 20592 to: 20603 type: wall<br>patch 6 from Fluent indices: 20604 to: 40963 type: pressure-outlet<br><br>Writing mesh to &quot;constant/region0&quot;<br><br>End<br></code></pre></td></tr></table></figure>        </div>      </div>    </div><ol start="5" type="1"><li>Check the mesh quality (optional but recommended): <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">checkMesh<br></code></pre></td></tr></table></figure></li></ol>    <div class="fold">      <div class="fold-title fold-info collapsed" data-toggle="collapse" href="#collapse-dfb167e8" role="button" aria-expanded="false" aria-controls="collapse-dfb167e8">        <div class="fold-arrow">▶</div>checkMesh results      </div>      <div class="fold-collapse collapse" id="collapse-dfb167e8">        <div class="fold-content">          <figure class="highlight console"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><code class="hljs console">/*---------------------------------------------------------------------------*\<br>  =========                 |<br>  \\      /  F ield         | OpenFOAM: The Open Source CFD Toolbox<br>   \\    /   O peration     | Website:  https://openfoam.org<br>    \\  /    A nd           | Version:  8<br>     \\/     M anipulation  |<br>\*---------------------------------------------------------------------------*/<br>Build  : 8<br>Exec   : checkMesh<br>Date   : Jan 15 2025<br>Time   : 22:33:17<br>Host   : &quot;xxx&quot;<br>PID    : 2938734<br>I/O    : uncollated<br>Case   : /home/wpsze/openfoam/simulation/supersonic<br>nProcs : 1<br>sigFpe : Enabling floating point exception trapping (FOAM_SIGFPE).<br>fileModificationChecking : Monitoring run-time modified files using timeStampMaster (fileModificationSkew 10)<br>allowSystemOperations : Allowing user-supplied system call operations<br><br>// * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * //<br>Create time<br><br>Create polyMesh for time = 0<br><br>Time = 0<br><br>Mesh stats<br>    points:           20850<br>    internal points:  0<br>    faces:            40964<br>    internal faces:   20116<br>    cells:            10180<br>    faces per cell:   6<br>    boundary patches: 7<br>    point zones:      0<br>    face zones:       1<br>    cell zones:       1<br><br>Overall number of cells of each type:<br>    hexahedra:     10180<br>    prisms:        0<br>    wedges:        0<br>    pyramids:      0<br>    tet wedges:    0<br>    tetrahedra:    0<br>    polyhedra:     0<br><br>Checking topology...<br>    Boundary definition OK.<br>    Cell to face addressing OK.<br>    Point usage OK.<br>    Upper triangular ordering OK.<br>    Face vertices OK.<br>    Number of regions: 1 (OK).<br><br>Checking patch topology for multiply connected surfaces...<br>    Patch               Faces    Points   Surface topology                  <br>    inlet1              56       114      ok (non-closed singly connected)  <br>    inlet2              2        6        ok (non-closed singly connected)  <br>    top                 182      366      ok (non-closed singly connected)  <br>    outlet              56       114      ok (non-closed singly connected)  <br>    bottom              180      364      ok (non-closed singly connected)  <br>    obstacle            12       28       ok (non-closed singly connected)  <br>    frontandback        20360    20850    ok (non-closed singly connected)  <br><br>Checking geometry...<br>    Overall domain bounding box (-1.33333 0 0) (3 1 1)<br>    Mesh has 3 geometric (non-empty/wedge) directions (1 1 1)<br>    Mesh has 3 solution (non-empty) directions (1 1 1)<br>    Boundary openness (2.3102e-17 -4.76257e-17 4.86259e-16) OK.<br>    Max cell openness = 1.0842e-16 OK.<br>    Max aspect ratio = 62.3378 OK.<br>    Minimum face area = 0.00026736. Maximum face area = 0.03.  Face area magnitudes OK.<br>    Min volume = 0.00026736. Max volume = 0.00054.  Total volume = 4.32833.  Cell volumes OK.<br>    Mesh non-orthogonality Max: 0 average: 0<br>    Non-orthogonality check OK.<br>    Face pyramids OK.<br>    Max skewness = 5.92121e-14 OK.<br>    Coupled point location match (average 0) OK.<br><br>Mesh OK.<br><br>End<br></code></pre></td></tr></table></figure>        </div>      </div>    </div><p>After conversion, you'll have: - <code>constant/polyMesh/</code> directory containing the mesh files - Basic OpenFOAM mesh files: points, faces, cells, boundary, etc.</p><h1 id="run">Run</h1><h2 id="test-case">Test case</h2><ul><li>Importing the setup of windAroundBuildings<ul><li>simpleFoam</li></ul></li></ul><p><img src="https://i.imgur.com/4BxQnOB.gif" width="500" /></p><h1 id="references">References</h1><ol type="1"><li><a href="https://openfoamwiki.net/index.php/FluentMeshToFoam">FluentMeshToFoam | openfoamwiki</a></li><li><a href="https://openfoamwiki.net/index.php/Fluent3DMeshToFoam#Comparison_between_fluentMeshToFoam_and_fluent3DMeshToFoam">Fluent3DMeshToFoam | openfoamwiki</a><ol type="1"><li>4 Comparison between fluentMeshToFoam and fluent3DMeshToFoam</li><li>From the release notes for OpenFOAM 1.4.1:<ol type="1"><li>New fluent3DMeshToFoam converter for 3D meshes from Fluent format to OpenFOAM format including full support for all BCs, zones etc.;</li></ol></li><li>Comparing the source code for fluentMeshToFoam and fluent3DMeshToFoam in OpenFOAM 1.4.1 and 1.5, the following main differences can be found:<ol type="1"><li>fluentMeshToFoam supports 2D and 3D Fluent meshes, while fluent3DMeshToFoam only supports 3D.</li><li>fluent3DMeshToFoam deals with hanging nodes.</li><li>fluentMeshToFoam has the options to write sets and zones, while fluent3DMeshToFoam has the option to ignore a cell groups and face groups.</li><li>fluentMeshToFoam can only handle the following 3D cell types: tet, hex, pyramid, prism</li><li>fluent3DMeshToFoam can handle internal walls/patches, or at least it looks like it does. fluentMeshToFoam requires a workaround: Howto importing fluent mesh with internal walls</li></ol></li></ol></li></ol>]]></content>
    
    
    <categories>
      
      <category>CFD</category>
      
    </categories>
    
    
    <tags>
      
      <tag>HPC</tag>
      
      <tag>OpenFOAM</tag>
      
      <tag>fluent</tag>
      
      <tag>mesh</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>HTML | Visualization</title>
    <link href="/2025/01/15/html-Visualization/"/>
    <url>/2025/01/15/html-Visualization/</url>
    
    <content type="html"><![CDATA[<h1 id="html-to-display-figures">html to display figures</h1><p>To create <strong>a simple HTML and JavaScript code that displays all images from a specified folder</strong>, you can use the following code. This example assumes that your images are stored in a folder named images within the same directory as your HTML file.</p><p>To automatically display all images from a folder <strong>without manually specifying each image name</strong>, you can use JavaScript to fetch the list of image files dynamically. However, JavaScript running in the browser does not have direct access to the file system for security reasons.</p><p>Done by <code>Claude-3.5-Sonne vis Poe</code>, <a href="https://poe.com/s/pKQ5uBUv9PlOfTN4aBB8" class="uri">https://poe.com/s/pKQ5uBUv9PlOfTN4aBB8</a></p><ul><li>Python script that you can run to generate a JavaScript file with the image list</li><li>HTML file to use this JavaScript file.</li></ul><figure class="highlight console"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs console"><span class="hljs-meta prompt_">$ </span><span class="language-bash">python3 get_images_list.py</span> <br><span class="hljs-meta prompt_">$ </span><span class="language-bash">python3 -m http.server 4007</span><br></code></pre></td></tr></table></figure><ul><li>Open the HTML file in a web browser to see your image gallery.</li></ul><p>open <a href="http://localhost:4007/display_images.html" class="uri">http://localhost:4007/display_images.html</a> or <a href="http://server-ip:4007/display_images.html" class="uri">http://server-ip:4007/display_images.html</a></p><p>Features of this solution:</p><ul><li>Displays all image files regardless of filename</li><li>Shows the filename below each image</li><li>Supports multiple image formats (<strong>png, jpg, jpeg, gif, bmp, webp</strong>)</li><li>Responsive grid layout</li><li>Hover effects on images</li><li>Error handling for missing images</li><li>Filename display with overflow handling</li></ul><figure class="highlight console"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs console">/your-project-directory (web_display)<br>├── display_by_web.sh<br>├── display_images.html (or whatever you name your HTML file)<br>├── get_images_list.py<br>└── /images<br>    ├── image1.png<br>    ├── image2.png<br>    └── ... (other PNG images)<br></code></pre></td></tr></table></figure>    <div class="fold">      <div class="fold-title fold-info collapsed" data-toggle="collapse" href="#collapse-6ae3e036" role="button" aria-expanded="false" aria-controls="collapse-6ae3e036">        <div class="fold-arrow">▶</div>display_by_web.sh      </div>      <div class="fold-collapse collapse" id="collapse-6ae3e036">        <div class="fold-content">          <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-meta">#!/bin/bash</span><br><br><span class="hljs-comment"># </span><br><span class="hljs-comment"># ./display_by_web.sh &lt;image directory path&gt;</span><br><span class="hljs-comment"># </span><br><br><span class="hljs-built_in">export</span> images_dir=<span class="hljs-variable">$&#123;1&#125;</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;images_dir = <span class="hljs-variable">$&#123;images_dir&#125;</span>&quot;</span><br><br><span class="hljs-built_in">cd</span> /home/wpsze/web_display/ <br><br><span class="hljs-built_in">rm</span> -r images<br><span class="hljs-built_in">mkdir</span> -p images<br><span class="hljs-built_in">ln</span> -s <span class="hljs-variable">$&#123;images_dir&#125;</span>/* images<br><br>python3 get_images_list.py<br>python3 -m http.server 4007<br></code></pre></td></tr></table></figure>        </div>      </div>    </div>    <div class="fold">      <div class="fold-title fold-info collapsed" data-toggle="collapse" href="#collapse-9c51fa20" role="button" aria-expanded="false" aria-controls="collapse-9c51fa20">        <div class="fold-arrow">▶</div>get_images_list.py      </div>      <div class="fold-collapse collapse" id="collapse-9c51fa20">        <div class="fold-content">          <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> os<br><span class="hljs-keyword">import</span> json<br><br><span class="hljs-comment"># Directory containing the images</span><br>image_dir = <span class="hljs-string">&#x27;./images/&#x27;</span><br><br><span class="hljs-comment">#image_dir = os.environ[&quot;image_dir&quot;]</span><br><br><span class="hljs-comment"># Get all image files</span><br>image_files = []<br><span class="hljs-keyword">for</span> filename <span class="hljs-keyword">in</span> <span class="hljs-built_in">sorted</span>(os.listdir(image_dir)):<br>    <span class="hljs-keyword">if</span> filename.lower().endswith((<span class="hljs-string">&#x27;.png&#x27;</span>, <span class="hljs-string">&#x27;.jpg&#x27;</span>, <span class="hljs-string">&#x27;.jpeg&#x27;</span>, <span class="hljs-string">&#x27;.gif&#x27;</span>, <span class="hljs-string">&#x27;.bmp&#x27;</span>, <span class="hljs-string">&#x27;.webp&#x27;</span>)):<br>        image_files.append(filename)<br><br><span class="hljs-comment"># Create JavaScript file</span><br><span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">&#x27;image-list.js&#x27;</span>, <span class="hljs-string">&#x27;w&#x27;</span>) <span class="hljs-keyword">as</span> f:<br>    f.write(<span class="hljs-string">&#x27;const imageFiles = &#x27;</span>)<br>    json.dump(image_files, f)<br>    f.write(<span class="hljs-string">&#x27;;&#x27;</span>)<br></code></pre></td></tr></table></figure>        </div>      </div>    </div>    <div class="fold">      <div class="fold-title fold-info collapsed" data-toggle="collapse" href="#collapse-05eef982" role="button" aria-expanded="false" aria-controls="collapse-05eef982">        <div class="fold-arrow">▶</div>display_images.html      </div>      <div class="fold-collapse collapse" id="collapse-05eef982">        <div class="fold-content">          <figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">&quot;en&quot;</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">&quot;UTF-8&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;viewport&quot;</span> <span class="hljs-attr">content</span>=<span class="hljs-string">&quot;width=device-width, initial-scale=1.0&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>Image Gallery<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span><br>    <span class="hljs-comment">&lt;!-- Prevent browser caching --&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">http-equiv</span>=<span class="hljs-string">&quot;Cache-Control&quot;</span> <span class="hljs-attr">content</span>=<span class="hljs-string">&quot;no-cache, no-store, must-revalidate&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">http-equiv</span>=<span class="hljs-string">&quot;Pragma&quot;</span> <span class="hljs-attr">content</span>=<span class="hljs-string">&quot;no-cache&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">http-equiv</span>=<span class="hljs-string">&quot;Expires&quot;</span> <span class="hljs-attr">content</span>=<span class="hljs-string">&quot;0&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span><span class="language-css"></span><br><span class="language-css">        <span class="hljs-selector-class">.gallery</span> &#123;</span><br><span class="language-css">            <span class="hljs-attribute">display</span>: grid;</span><br><span class="language-css">            <span class="hljs-attribute">grid-template-columns</span>: <span class="hljs-built_in">repeat</span>(auto-fill, <span class="hljs-built_in">minmax</span>(<span class="hljs-number">400px</span>, <span class="hljs-number">1</span>fr));</span><br><span class="language-css">            <span class="hljs-attribute">gap</span>: <span class="hljs-number">20px</span>;</span><br><span class="language-css">            <span class="hljs-attribute">padding</span>: <span class="hljs-number">20px</span>;</span><br><span class="language-css">        &#125;</span><br><span class="language-css"></span><br><span class="language-css">        <span class="hljs-selector-class">.image-container</span> &#123;</span><br><span class="language-css">            <span class="hljs-attribute">position</span>: relative;</span><br><span class="language-css">            aspect-ratio: <span class="hljs-number">1</span>;</span><br><span class="language-css">            <span class="hljs-attribute">overflow</span>: hidden;</span><br><span class="language-css">            <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">8px</span>;</span><br><span class="language-css">            <span class="hljs-attribute">box-shadow</span>: <span class="hljs-number">0</span> <span class="hljs-number">2px</span> <span class="hljs-number">4px</span> <span class="hljs-built_in">rgba</span>(<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0.1</span>);</span><br><span class="language-css">            <span class="hljs-attribute">transition</span>: transform <span class="hljs-number">0.3s</span> ease;</span><br><span class="language-css">        &#125;</span><br><span class="language-css"></span><br><span class="language-css">        <span class="hljs-selector-class">.image-container</span><span class="hljs-selector-pseudo">:hover</span> &#123;</span><br><span class="language-css">            <span class="hljs-attribute">transform</span>: <span class="hljs-built_in">scale</span>(<span class="hljs-number">1.05</span>);</span><br><span class="language-css">        &#125;</span><br><span class="language-css"></span><br><span class="language-css">        <span class="hljs-selector-class">.image-container</span> <span class="hljs-selector-tag">img</span> &#123;</span><br><span class="language-css">            <span class="hljs-attribute">width</span>: <span class="hljs-number">100%</span>;</span><br><span class="language-css">            <span class="hljs-attribute">height</span>: <span class="hljs-number">100%</span>;</span><br><span class="language-css">            <span class="hljs-attribute">object-fit</span>: contain;</span><br><span class="language-css">        &#125;</span><br><span class="language-css"></span><br><span class="language-css">        <span class="hljs-selector-class">.filename</span> &#123;</span><br><span class="language-css">            <span class="hljs-attribute">position</span>: absolute;</span><br><span class="language-css">            <span class="hljs-attribute">bottom</span>: <span class="hljs-number">0</span>;</span><br><span class="language-css">            <span class="hljs-attribute">left</span>: <span class="hljs-number">0</span>;</span><br><span class="language-css">            <span class="hljs-attribute">right</span>: <span class="hljs-number">0</span>;</span><br><span class="language-css">            <span class="hljs-attribute">background</span>: <span class="hljs-built_in">rgba</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0.7</span>);</span><br><span class="language-css">            <span class="hljs-attribute">color</span>: white;</span><br><span class="language-css">            <span class="hljs-attribute">padding</span>: <span class="hljs-number">5px</span>;</span><br><span class="language-css">            <span class="hljs-attribute">font-size</span>: <span class="hljs-number">12px</span>;</span><br><span class="language-css">            <span class="hljs-attribute">text-align</span>: center;</span><br><span class="language-css">            <span class="hljs-attribute">overflow</span>: hidden;</span><br><span class="language-css">            <span class="hljs-attribute">text-overflow</span>: ellipsis;</span><br><span class="language-css">            <span class="hljs-attribute">white-space</span>: nowrap;</span><br><span class="language-css">        &#125;</span><br><span class="language-css">    </span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;gallery&quot;</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;imageGallery&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">&quot;image-list.js&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="language-javascript"></span><br><span class="language-javascript">        <span class="hljs-keyword">const</span> imageFolder = <span class="hljs-string">&#x27;images/&#x27;</span>; <span class="hljs-comment">// Change this to your folder name</span></span><br><span class="language-javascript">        <span class="hljs-keyword">const</span> gallery = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">&#x27;imageGallery&#x27;</span>);</span><br><span class="language-javascript"></span><br><span class="language-javascript">        imageFiles.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">filename</span> =&gt;</span> &#123;</span><br><span class="language-javascript">            <span class="hljs-keyword">const</span> imgContainer = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">&#x27;div&#x27;</span>);</span><br><span class="language-javascript">            imgContainer.<span class="hljs-property">className</span> = <span class="hljs-string">&#x27;image-container&#x27;</span>;</span><br><span class="language-javascript">            </span><br><span class="language-javascript">            <span class="hljs-keyword">const</span> img = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">&#x27;img&#x27;</span>);</span><br><span class="language-javascript">            img.<span class="hljs-property">src</span> = imageFolder + filename;</span><br><span class="language-javascript">            img.<span class="hljs-property">alt</span> = filename;</span><br><span class="language-javascript">            </span><br><span class="language-javascript">            <span class="hljs-comment">// Add filename display</span></span><br><span class="language-javascript">            <span class="hljs-keyword">const</span> filenameDiv = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">&#x27;div&#x27;</span>);</span><br><span class="language-javascript">            filenameDiv.<span class="hljs-property">className</span> = <span class="hljs-string">&#x27;filename&#x27;</span>;</span><br><span class="language-javascript">            filenameDiv.<span class="hljs-property">textContent</span> = filename;</span><br><span class="language-javascript">            </span><br><span class="language-javascript">            <span class="hljs-comment">// Error handling for images that might not exist</span></span><br><span class="language-javascript">            img.<span class="hljs-property">onerror</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) &#123;</span><br><span class="language-javascript">                <span class="hljs-variable language_">this</span>.<span class="hljs-property">parentElement</span>.<span class="hljs-title function_">remove</span>();</span><br><span class="language-javascript">            &#125;;</span><br><span class="language-javascript">            </span><br><span class="language-javascript">            imgContainer.<span class="hljs-title function_">appendChild</span>(img);</span><br><span class="language-javascript">            imgContainer.<span class="hljs-title function_">appendChild</span>(filenameDiv);</span><br><span class="language-javascript">            gallery.<span class="hljs-title function_">appendChild</span>(imgContainer);</span><br><span class="language-javascript">        &#125;);</span><br><span class="language-javascript">    </span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span><br></code></pre></td></tr></table></figure>        </div>      </div>    </div><h1 id="result">Result</h1><p><img src="https://i.imgur.com/kKLnFZH.png" /></p><h1 id="note">Note</h1><p>To prevent browser caching and always show the latest images, then need to clear the cache of browser.</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">&quot;en&quot;</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">&quot;UTF-8&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;viewport&quot;</span> <span class="hljs-attr">content</span>=<span class="hljs-string">&quot;width=device-width, initial-scale=1.0&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>Image Gallery - No Cache<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span><br>    <span class="hljs-comment">&lt;!-- Prevent browser caching --&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">http-equiv</span>=<span class="hljs-string">&quot;Cache-Control&quot;</span> <span class="hljs-attr">content</span>=<span class="hljs-string">&quot;no-cache, no-store, must-revalidate&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">http-equiv</span>=<span class="hljs-string">&quot;Pragma&quot;</span> <span class="hljs-attr">content</span>=<span class="hljs-string">&quot;no-cache&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">http-equiv</span>=<span class="hljs-string">&quot;Expires&quot;</span> <span class="hljs-attr">content</span>=<span class="hljs-string">&quot;0&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span><span class="language-css"></span><br><span class="language-css">        <span class="hljs-selector-class">.gallery</span> &#123;</span><br><span class="language-css">            <span class="hljs-attribute">display</span>: grid;</span><br><span class="language-css">            <span class="hljs-attribute">grid-template-columns</span>: <span class="hljs-built_in">repeat</span>(auto-fill, <span class="hljs-built_in">minmax</span>(<span class="hljs-number">200px</span>, <span class="hljs-number">1</span>fr));</span><br><span class="language-css">            <span class="hljs-attribute">gap</span>: <span class="hljs-number">20px</span>;</span><br><span class="language-css">            <span class="hljs-attribute">padding</span>: <span class="hljs-number">20px</span>;</span><br><span class="language-css">        &#125;</span><br><span class="language-css">...</span><br></code></pre></td></tr></table></figure><h2 id="more">More,</h2><h3 id="for-size-of-image-within-box">For size of image within box,</h3><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs html">.image-container img &#123;<br>    width: 100%;<br>    height: 100%;<br>    object-fit: contain;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="https://i.imgur.com/pymFB2Y.png" width="600" /></p>]]></content>
    
    
    <categories>
      
      <category>HTML</category>
      
    </categories>
    
    
    <tags>
      
      <tag>python</tag>
      
      <tag>HTML</tag>
      
      <tag>Visualization</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ML | Time Series</title>
    <link href="/2025/01/13/ML-Time-Series/"/>
    <url>/2025/01/13/ML-Time-Series/</url>
    
    <content type="html"><![CDATA[<p>Conda env is built as,</p><figure class="highlight console"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs console">micromamba env create -n ML<br>micromamba activate ML<br>micromamba install python==3.10<br>micromamba install pytorch torchvision torchaudio pytorch-cuda=12.4 -c pytorch -c nvidia<br>micromamba install yfinance matplotlib pandas numpy scipy<br>micromamba install scikit-learn<br>micromamba install ipykernel<br>python -m ipykernel install --user --name=ML --display-name=&#x27;Environment(ML)&#x27;<br>micromamba install plotly<br>micromamba install  pytorch_geometric<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>ML</category>
      
    </categories>
    
    
    <tags>
      
      <tag>AI</tag>
      
      <tag>ML</tag>
      
      <tag>pytorch</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ML | stable-video-diffusion-img2vid-xt</title>
    <link href="/2025/01/10/ML-stable-video-diffusion-img2vid-xt/"/>
    <url>/2025/01/10/ML-stable-video-diffusion-img2vid-xt/</url>
    
    <content type="html"><![CDATA[<h1 id="stable-video-diffusion-img2vid-xt">stable-video-diffusion-img2vid-xt</h1><p>Stable Video Diffusion (SVD) Image-to-Video is a diffusion model that takes in a still image as a conditioning frame, and generates a video from it.</p><p>Stable Video Diffusion (SVD) 1.1 (image -to-Video)是一种以静止图像作为条件帧，并从中生成视频的扩散模型。</p><p>(SVD) Image-to-Video is a latent diffusion model trained to generate short video clips from an image conditioning. This model was trained to <strong>generate 25 frames at resolution 576x1024</strong> given a context frame of the same size, finetuned from SVD Image-to-Video [14 frames]. We also finetune the widely used f8-decoder for temporal consistency.</p><p>All considered potential data sources were included for final training, with none held out as the proposed data filtering methods described in the SVD paper handle the quality control/filtering of the dataset. With regards to safety/NSFW filtering, sources considered were either deemed safe or filtered with the in-house NSFW filters. No explicit human labor is involved in training data preparation. However, human evaluation for model outputs and quality was extensively used to evaluate model quality and performance.</p><p>Not safe for work (NSFW) is Internet slang or shorthand used to mark links to content, videos, or website pages the viewer may not wish to be seen viewing in a public, formal, or controlled environment. NSFW Filter 是一款通过AI 过滤网页上NSFW 成人内容的Firefox、Chrome 插件，可以帮助你过滤掉那些不适时宜出现的内容，主要是图片、视频。</p><p>SVD全称Stable Video Diffusion，是StabilityAI最新的开源文本生成视频大模型。这个模型是基于Stable Diffusion 2.1进行初始化，然后通过在图像模型中插入时空卷积和注意力层来构建这个视频生成模型的架构，最终在<strong>1.52亿视频数据集上训练得到</strong>。</p><p>SVD系列模型包含2个版本，一个是可以生成 <strong>14帧576x1024图像 的SVD常规模板</strong>，一个是可以生成 <strong>20帧的 SVD-XT 的微调版本</strong>。二者除了生成视频的帧数不一样外，其它都是完全相同的。</p><table><thead><tr class="header"><th>模型名称</th><th>视频帧数</th><th>开源情况</th></tr></thead><tbody><tr class="odd"><td>Stable Video Diffusion</td><td>14帧</td><td>允许研究，不允许商用</td></tr><tr class="even"><td>Stable Video Diffusion - XT</td><td>20帧</td><td>允许研究，不允许商用</td></tr></tbody></table><p>It’s entirely possible to run the <code>img2vid</code> and <code>img2vid-xt</code> models on a GTX 1080 with <strong>8GB of VRAM</strong>! No, it is huge.</p><ul><li><a href="https://huggingface.co/stabilityai/stable-video-diffusion-img2vid-xt" class="uri">https://huggingface.co/stabilityai/stable-video-diffusion-img2vid-xt</a></li><li><a href="https://github.com/Stability-AI/generative-models" class="uri">https://github.com/Stability-AI/generative-models</a></li></ul><figure class="highlight console"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs console">micromamba env create -n SVD<br>micromamba activate SVD<br>micromamba install python==3.10<br>pip3 install torch==2.0.1 torchvision torchaudio --index-url https://download.pytorch.org/whl/cu118<br>pip install -r requirements/pt2.txt <br>pip install .<br>pip3 install -e git+https://github.com/Stability-AI/datapipelines.git@main#egg=sdata<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">下载 safetensors 模型 (svd_xt.safetensors) ，放到 checkpoints 这个文件夹里。</span><br>mkdir checkpoints<br>cd checkpoints/<br>ln -s ../../stable-video-diffusion-img2vid-xt/svd_xt* .<br></code></pre></td></tr></table></figure><p>where Why cu118/torch==2.0.1?</p><p>Run,</p><figure class="highlight console"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs console"><span class="hljs-meta prompt_"># </span><span class="language-bash">输入下面的命令，启动界面。</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">streamlit run scripts/demo/video_sampling.py</span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">上述命令会自动打开一个新的网页。如果没有打开，看看 PowerShell 窗口的信息。找到本地可以打开的URL，应该是这样的：</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">http://localhost:8501</span> <br></code></pre></td></tr></table></figure><h2 id="section"></h2><p>November 21, 2023</p><p>We are releasing Stable Video Diffusion, an image-to-video model, for research purposes:</p><ul><li>SVD: This model was trained to generate 14 frames at resolution 576x1024 given a context frame of the same size. We use the standard image encoder from SD 2.1, but replace the decoder with a temporally-aware deflickering decoder.</li><li>SVD-XT: Same architecture as SVD but finetuned for 25 frame generation. You can run the community-build gradio demo locally by running python -m scripts.demo.gradio_app.</li><li>We provide a <strong>streamlit demo</strong> <code>scripts/demo/video_sampling.py</code> and a <strong>standalone python script</strong> <code>scripts/sampling/simple_video_sample.py</code> for inference of both models.</li><li>Alongside the model, we release a technical report.</li></ul><h1 id="error">Error</h1><h2 id="importerror-numpy.core.multiarray-failed-to-import">ImportError: numpy.core.multiarray failed to import</h2><p>解决方法：</p><ul><li>这个错误是由于numpy版本与某个库文件包，比如opencv-python版本不匹配造成的</li><li>系统原来不要有numpy这个包！！！如果你已经安装了，请先卸载numpy包，再安装opencv-python包</li></ul><h2 id="typeerror-randn_like-argument-input-position-1-must-be-tensor-not-nonetype">TypeError: randn_like(): argument 'input' (position 1) must be Tensor, not NoneType</h2><p>The error seems to be related to the fact that streamlet is trying to run the model before you uploaded the image. If you just ignore this error and upload an image, everything will work.</p><p>When I switch from Edge browser to Chrome, it seems works fine.</p><h2 id="runtimeerror-numpy-is-not-available">RuntimeError: Numpy is not available</h2><p>This will be easily solved by upgrading numpy.... When I face this error, that time numpy version 1.22 was installed.... I update version to x.x.x using this command.</p><h2 id="error-cant-find-rust-compiler">error: can't find Rust compiler</h2><ul><li>pip install transformers</li></ul><h2 id="outofmemoryerror">OutOfMemoryError</h2><p>torch.cuda.OutOfMemoryError: CUDA out of memory. Tried to allocate 4.43 GiB (GPU 0; 23.48 GiB total capacity; 17.83 GiB already allocated; 3.75 GiB free; 19.39 GiB reserved in total by PyTorch) If reserved memory is &gt;&gt; allocated memory try setting max_split_size_mb to avoid fragmentation. See documentation for Memory Management and PYTORCH_CUDA_ALLOC_CONF</p><ul><li>Decode t frames at a time (set small if you are low on VRAM)</li></ul><h2 id="runtimeerror-sizes-of-tensors-must-match-except-in-dimension-1.-expected-size-6-but-got-size-5-for-tensor-number-1-in-the-list.">RuntimeError: Sizes of tensors must match except in dimension 1. Expected size 6 but got size 5 for tensor number 1 in the list.</h2><p>Make sure the size if the width/height is a 64 step (512, 576, 640...)</p><h2 id="runtimeerror-image-too-small-should-be-larger-than-256x256">RuntimeError: image too small, should be larger than 256x256</h2><h2 id="typeerror-tiffwriter.write-got-an-unexpected-keyword-argument-fps">TypeError: TiffWriter.write() got an unexpected keyword argument 'fps'</h2><ul><li>pip install imageio==2.19.3 (?)</li><li>pip install imageio-ffmpeg==0.4.7 (work!)</li></ul><h1 id="references">References</h1><ol type="1"><li><a href="https://zhuanlan.zhihu.com/p/672699032">运行Stable Video Diffusion模型实现图生视频img2vid</a></li></ol>]]></content>
    
    
    <categories>
      
      <category>ML</category>
      
    </categories>
    
    
    <tags>
      
      <tag>AI</tag>
      
      <tag>ML</tag>
      
      <tag>pytorch</tag>
      
      <tag>LLM</tag>
      
      <tag>huggingface</tag>
      
      <tag>stable-video-diffusion</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ML | stable-diffusion</title>
    <link href="/2025/01/09/ML-stable-diffusion/"/>
    <url>/2025/01/09/ML-stable-diffusion/</url>
    
    <content type="html"><![CDATA[<h1 id="stable-diffusion-xl-base-1.0">stable-diffusion-xl-base-1.0</h1><ul><li><a href="https://huggingface.co/stabilityai/stable-diffusion-xl-base-1.0" class="uri">https://huggingface.co/stabilityai/stable-diffusion-xl-base-1.0</a></li></ul><p><img src="https://huggingface.co/stabilityai/stable-diffusion-xl-base-1.0/resolve/main/pipeline.png" width="500" /></p><p>The <code>stable-diffusion-xl-base-1.0</code> is a text-to-image generative model developed by Stability AI.</p><ul><li>Inputs<ul><li>Text prompt: A description of the desired image, such as "a beautiful sunset over a mountain landscape".</li></ul></li><li>Outputs<ul><li>Generated image: An image that corresponds to the input text prompt, generated using the model's diffusion-based text-to-image capabilities.</li></ul></li></ul><figure class="highlight console"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs console">micromamba env create -n SD<br>micromamba activate SD<br>micromamba install python==3.10<br>pip install diffusers --upgrade<br>pip install invisible_watermark transformers accelerate safetensors gradio<br>micromamba install git-lfs<br></code></pre></td></tr></table></figure><ul><li>When using torch &gt;= 2.0, you can improve the inference speed by 20-30% with torch.compile. Simple wrap the unet with torch compile before running the pipeline:<ul><li><code>pipe.unet = torch.compile(pipe.unet, mode="reduce-overhead", fullgraph=True)</code></li></ul></li><li>If you are limited by GPU VRAM, you can enable cpu offloading by calling pipe.enable_model_cpu_offload instead of .to("cuda"):<ul><li><code>- pipe.to("cuda")</code></li><li><code>+ pipe.enable_model_cpu_offload()</code></li></ul></li></ul><p>The models are saved at,</p><figure class="highlight console"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs console">6.7G/home/wpsze/.cache/huggingface/hub/models--stabilityai--stable-diffusion-xl-base-1.0<br>4.4G/home/wpsze/.cache/huggingface/hub/models--stabilityai--stable-diffusion-xl-refiner-1.0<br></code></pre></td></tr></table></figure><h2 id="base-model">base model</h2><p>To just use the base model, you can run:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/bin/python</span><br><br><span class="hljs-keyword">from</span> diffusers <span class="hljs-keyword">import</span> DiffusionPipeline<br><span class="hljs-keyword">import</span> torch<br><br>pipe = DiffusionPipeline.from_pretrained(<span class="hljs-string">&quot;stabilityai/stable-diffusion-xl-base-1.0&quot;</span>, torch_dtype=torch.float16, use_safetensors=<span class="hljs-literal">True</span>, variant=<span class="hljs-string">&quot;fp16&quot;</span>)<br>pipe.to(<span class="hljs-string">&quot;cuda&quot;</span>)<br><br><span class="hljs-comment"># if using torch &lt; 2.0</span><br><span class="hljs-comment"># pipe.enable_xformers_memory_efficient_attention()</span><br><br>prompt = <span class="hljs-string">&quot;An astronaut riding a green horse&quot;</span><br><br>image = pipe(prompt=prompt).images[<span class="hljs-number">0</span>]<br><br>image.save(<span class="hljs-string">&quot;astronaut_rides_horse.png&quot;</span>) <span class="hljs-comment"># 1024 x 1024</span><br></code></pre></td></tr></table></figure><p>GPU: ~ 10GB</p><h2 id="base-refiner-pipeline">base + refiner pipeline</h2><p>To use the whole base + refiner pipeline as an ensemble of experts you can run:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> diffusers <span class="hljs-keyword">import</span> DiffusionPipeline<br><span class="hljs-keyword">import</span> torch<br><br><span class="hljs-comment"># load both base &amp; refiner</span><br>base = DiffusionPipeline.from_pretrained(<br>    <span class="hljs-string">&quot;stabilityai/stable-diffusion-xl-base-1.0&quot;</span>, torch_dtype=torch.float16, variant=<span class="hljs-string">&quot;fp16&quot;</span>, use_safetensors=<span class="hljs-literal">True</span><br>)<br>base.to(<span class="hljs-string">&quot;cuda&quot;</span>)<br>refiner = DiffusionPipeline.from_pretrained(<br>    <span class="hljs-string">&quot;stabilityai/stable-diffusion-xl-refiner-1.0&quot;</span>,<br>    text_encoder_2=base.text_encoder_2,<br>    vae=base.vae,<br>    torch_dtype=torch.float16,<br>    use_safetensors=<span class="hljs-literal">True</span>,<br>    variant=<span class="hljs-string">&quot;fp16&quot;</span>,<br>)<br>refiner.to(<span class="hljs-string">&quot;cuda&quot;</span>)<br><br><span class="hljs-comment"># Define how many steps and what % of steps to be run on each experts (80/20) here</span><br>n_steps = <span class="hljs-number">40</span><br>high_noise_frac = <span class="hljs-number">0.8</span><br><br>prompt = <span class="hljs-string">&quot;A majestic lion jumping from a big stone at night&quot;</span><br><br><span class="hljs-comment"># run both experts</span><br>image = base(<br>    prompt=prompt,<br>    num_inference_steps=n_steps,<br>    denoising_end=high_noise_frac,<br>    output_type=<span class="hljs-string">&quot;latent&quot;</span>,<br>).images<br>image = refiner(<br>    prompt=prompt,<br>    num_inference_steps=n_steps,<br>    denoising_start=high_noise_frac,<br>    image=image,<br>).images[<span class="hljs-number">0</span>]<br><br>image.save(<span class="hljs-string">&quot;refiner.png&quot;</span>) <br></code></pre></td></tr></table></figure><p>GPU: ~ 14GB</p><h2 id="demo">Demo</h2><ul><li><p><strong>Left</strong>: Base model, <strong>Right</strong>: Base+refiner model</p><ul><li><strong>prompt = "An astronaut is doing Numerical Weather Prediction simulation on Space."</strong></li></ul></li></ul><div class="group-image-container"><div class="group-image-row"><div class="group-image-wrap"><img src="https://i.imgur.com/imchHVz.png" /></div><div class="group-image-wrap"><img src="https://i.imgur.com/KKiwfNI.png" /></div></div></div><h1 id="where-does-hugging-faces-transformers-save-models">Where does hugging face's transformers save models?</h1><p>The cache location has changed again, and is now <code>~/.cache/huggingface/hub/</code></p><figure class="highlight console"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs console"><span class="hljs-meta prompt_">$ </span><span class="language-bash"><span class="hljs-built_in">du</span> -sh ~/.cache/huggingface/hub/*</span><br>6.3G/home/wpsze/.cache/huggingface/hub/models--deepseek-ai--deepseek-vl2-tiny<br>414M/home/wpsze/.cache/huggingface/hub/models--dslim--bert-base-NER<br>961M/home/wpsze/.cache/huggingface/hub/models--ecmwf--aifs-single<br>1.7G/home/wpsze/.cache/huggingface/hub/models--microsoft--DialoGPT-medium<br>172K/home/wpsze/.cache/huggingface/hub/models--microsoft--Florence-2-large<br>6.7G/home/wpsze/.cache/huggingface/hub/models--stabilityai--stable-diffusion-xl-base-1.0<br>4.4G/home/wpsze/.cache/huggingface/hub/models--stabilityai--stable-diffusion-xl-refiner-1.0<br>4.0K/home/wpsze/.cache/huggingface/hub/version.txt<br>4.0K/home/wpsze/.cache/huggingface/hub/version_diffusers_cache.txt<br></code></pre></td></tr></table></figure><h1 id="web-page">web page</h1><ul><li><a href="https://www.volcengine.com/docs/6419/1149863">GPU-基于Diffusers和Gradio搭建SDXL推理应用</a></li><li><a href="https://medium.com/@yvontarbajo/%E9%BA%BB%E7%93%9C%E8%B5%B0%E5%85%A5%E9%AD%94%E6%B3%95%E4%B8%96%E7%95%8C-i-gradio-2e9705f2410e">麻瓜走入魔法世界 I — Gradio</a></li><li><a href="http://localhost:8000/" class="uri">http://localhost:8000/</a></li></ul>    <div class="fold">      <div class="fold-title fold-info collapsed" data-toggle="collapse" href="#collapse-88d67c90" role="button" aria-expanded="false" aria-controls="collapse-88d67c90">        <div class="fold-arrow">▶</div>python script      </div>      <div class="fold-collapse collapse" id="collapse-88d67c90">        <div class="fold-content">          <p>git clone,</p><figure class="highlight console"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs console">git clone https://github.com/AUTOMATIC1111/TorchDeepDanbooru.git<br>cd TorchDeepDanbooru<br>wget https://github.com/AUTOMATIC1111/TorchDeepDanbooru/releases/download/v1/model-resnet_custom_v3.pt<br></code></pre></td></tr></table></figure><p>and web.py,</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/bin/python</span><br><br><span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np<br><span class="hljs-keyword">import</span> gradio <span class="hljs-keyword">as</span> gr<br><span class="hljs-keyword">from</span> diffusers <span class="hljs-keyword">import</span> DiffusionPipeline,StableDiffusionXLImg2ImgPipeline<br><span class="hljs-keyword">import</span> torch<br><span class="hljs-keyword">import</span> tqdm<br><span class="hljs-keyword">from</span> datetime <span class="hljs-keyword">import</span> datetime<br><br><span class="hljs-keyword">from</span> TorchDeepDanbooru <span class="hljs-keyword">import</span> deep_danbooru_model<br><br>MODEL_BASE =  <span class="hljs-string">&quot;stabilityai/stable-diffusion-xl-base-1.0&quot;</span><br>MODEL_REFINER = <span class="hljs-string">&quot;stabilityai/stable-diffusion-xl-refiner-1.0&quot;</span><br><br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Loading model&quot;</span>,MODEL_BASE)<br>base = DiffusionPipeline.from_pretrained(MODEL_BASE, torch_dtype=torch.float16, use_safetensors=<span class="hljs-literal">True</span>, variant=<span class="hljs-string">&quot;fp16&quot;</span>)<br>base.to(<span class="hljs-string">&quot;cuda&quot;</span>)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Loading model&quot;</span>,MODEL_REFINER)<br>refiner = StableDiffusionXLImg2ImgPipeline.from_pretrained(MODEL_REFINER, text_encoder_2=base.text_encoder_2,vae=base.vae, torch_dtype=torch.float16, use_safetensors=<span class="hljs-literal">True</span>, variant=<span class="hljs-string">&quot;fp16&quot;</span>,)<br>refiner.to(<span class="hljs-string">&quot;cuda&quot;</span>)<br><br><span class="hljs-comment"># Define how many steps and what % of steps to be run on each experts (80/20) here</span><br><span class="hljs-comment"># base-high noise, refiner-low noise</span><br><span class="hljs-comment"># the base model steps = default_n_steps*default_high_noise_frac</span><br>default_n_steps = <span class="hljs-number">40</span><br>default_high_noise_frac = <span class="hljs-number">0.8</span><br>default_num_images =<span class="hljs-number">2</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">predit_txt2img</span>(<span class="hljs-params">prompt,negative_prompt,model_selected,num_images,n_steps, high_noise_frac,cfg_scale</span>):<br>    <span class="hljs-comment"># run both experts</span><br>    start = datetime.now()<br><br>    num_images=<span class="hljs-built_in">int</span>(num_images)<br>    n_steps=<span class="hljs-built_in">int</span>(n_steps)<br>    prompt, negative_prompt = [prompt] * num_images, [negative_prompt] * num_images<br>    images_list = []<br>    model_selected = model_selected<br>    high_noise_frac=<span class="hljs-built_in">float</span>(high_noise_frac)<br>    cfg_scale=<span class="hljs-built_in">float</span>(cfg_scale)<br><br>    g = torch.Generator(device=<span class="hljs-string">&quot;cuda&quot;</span>)<br><br>    <span class="hljs-keyword">if</span> model_selected == <span class="hljs-string">&quot;sd-xl-base-1.0&quot;</span> <span class="hljs-keyword">or</span> model_selected == <span class="hljs-string">&quot;sd-xl-base-refiner-1.0&quot;</span>:<br>        images = base(<br>            prompt=prompt,<br>            negative_prompt=negative_prompt,<br>            num_inference_steps=n_steps,<br>            denoising_end=high_noise_frac,<br>            guidance_scale=cfg_scale,<br>            output_type=<span class="hljs-string">&quot;latent&quot;</span> <span class="hljs-keyword">if</span> model_selected == <span class="hljs-string">&quot;sd-xl-base-refiner-1.0&quot;</span> <span class="hljs-keyword">else</span> <span class="hljs-string">&quot;pil&quot;</span>,<br>            generator=g<br>        ).images<br>    <br>    <span class="hljs-keyword">if</span> model_selected == <span class="hljs-string">&quot;sd-xl-base-refiner-1.0&quot;</span>:<br>        images = refiner(<br>            prompt=prompt,<br>            negative_prompt=negative_prompt,<br>            num_inference_steps=n_steps,<br>            denoising_start=high_noise_frac,<br>            guidance_scale=cfg_scale,<br>            image=images,<br>        ).images<br><br>    <span class="hljs-keyword">for</span> image <span class="hljs-keyword">in</span> images:<br>        images_list.append(image)<br><br>    torch.cuda.empty_cache()<br>    <br>    cost_time=(datetime.now()-start).seconds<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;cost time=<span class="hljs-subst">&#123;cost_time&#125;</span>,<span class="hljs-subst">&#123;datetime.now()&#125;</span>&quot;</span>)<br>    <br>    <span class="hljs-keyword">return</span> images_list<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">predit_img2img</span>(<span class="hljs-params">prompt, negative_prompt,init_image, model_selected,n_steps, high_noise_frac,cfg_scale,strength</span>):<br>    <br>    start = datetime.now()<br>    prompt = prompt<br>    negative_prompt =negative_prompt<br><br>    model_selected = model_selected<br>    init_image = init_image<br>    n_steps=<span class="hljs-built_in">int</span>(n_steps)<br>    high_noise_frac=<span class="hljs-built_in">float</span>(high_noise_frac)<br>    cfg_scale=<span class="hljs-built_in">float</span>(cfg_scale)<br>    strength=<span class="hljs-built_in">float</span>(strength)<br><br>    <span class="hljs-keyword">if</span> model_selected == <span class="hljs-string">&quot;sd-xl-refiner-1.0&quot;</span>:<br>        images = refiner(<br>            prompt=prompt,<br>            negative_prompt=negative_prompt,<br>            num_inference_steps=n_steps,<br>            denoising_start=high_noise_frac,<br>            guidance_scale=cfg_scale,<br>            strength = strength,<br>            image=init_image,<br>            <span class="hljs-comment"># target_size = (1024, 1024)</span><br>        ).images<br><br>    torch.cuda.empty_cache()<br>    <br>    cost_time=(datetime.now()-start).seconds<br><br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;cost time=<span class="hljs-subst">&#123;cost_time&#125;</span>,<span class="hljs-subst">&#123;datetime.now()&#125;</span>&quot;</span>)<br><br>    <span class="hljs-keyword">return</span> images[<span class="hljs-number">0</span>]<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">interrogate_deepbooru</span>(<span class="hljs-params">pil_image, threshold</span>):<br>    threshold =<span class="hljs-number">0.5</span><br>    model = deep_danbooru_model.DeepDanbooruModel()<br>    model.load_state_dict(torch.load(<span class="hljs-string">&#x27;/home/wpsze/ML/huggingface_hub/stable-diffusion-xl-base-1.0/TorchDeepDanbooru/model-resnet_custom_v3.pt&#x27;</span>))<br>    model.<span class="hljs-built_in">eval</span>().half().cuda()<br><br>    pic = pil_image.convert(<span class="hljs-string">&quot;RGB&quot;</span>).resize((<span class="hljs-number">512</span>, <span class="hljs-number">512</span>))<br>    a = np.expand_dims(np.array(pic, dtype=np.float32), <span class="hljs-number">0</span>) / <span class="hljs-number">255</span><br><br>    <span class="hljs-keyword">with</span> torch.no_grad(), torch.autocast(<span class="hljs-string">&quot;cuda&quot;</span>):<br>        x = torch.from_numpy(a).cuda()<br><br>        <span class="hljs-comment"># first run</span><br>        y = model(x)[<span class="hljs-number">0</span>].detach().cpu().numpy()<br><br>        <span class="hljs-comment"># measure performance</span><br>        <span class="hljs-keyword">for</span> n <span class="hljs-keyword">in</span> tqdm.tqdm(<span class="hljs-built_in">range</span>(<span class="hljs-number">10</span>)):<br>            model(x)<br><br>    result_tags_out = []<br>    <span class="hljs-keyword">for</span> i, p <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(y):<br>        <span class="hljs-keyword">if</span> p &gt;= threshold:<br>            result_tags_out.append(model.tags[i])<br>            <span class="hljs-built_in">print</span>(model.tags[i], p)<br><br>    prompt = <span class="hljs-string">&#x27;, &#x27;</span>.join(result_tags_out).replace(<span class="hljs-string">&#x27;_&#x27;</span>, <span class="hljs-string">&#x27; &#x27;</span>).replace(<span class="hljs-string">&#x27;:&#x27;</span>, <span class="hljs-string">&#x27; &#x27;</span>)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;prompt=<span class="hljs-subst">&#123;prompt&#125;</span>&quot;</span>)<br>    <span class="hljs-keyword">return</span> prompt<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">clear_txt2img</span>(<span class="hljs-params">prompt, negative_prompt</span>):<br>    prompt = <span class="hljs-string">&quot;&quot;</span><br>    negative_prompt = <span class="hljs-string">&quot;&quot;</span><br>    <span class="hljs-keyword">return</span> prompt, negative_prompt<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">clear_img2img</span>(<span class="hljs-params">prompt, negative_prompt, image_input,image_output</span>):<br>    prompt = <span class="hljs-string">&quot;&quot;</span><br>    negative_prompt = <span class="hljs-string">&quot;&quot;</span><br>    image_input = <span class="hljs-literal">None</span><br>    image_output = <span class="hljs-literal">None</span><br><br>    <span class="hljs-keyword">return</span> prompt, negative_prompt,image_input,image_output<br><br><span class="hljs-keyword">with</span> gr.Blocks(title=<span class="hljs-string">&quot;Stable Diffusion&quot;</span>,theme=gr.themes.Default(primary_hue=gr.themes.colors.blue))<span class="hljs-keyword">as</span> demo:<br>    <br>    <span class="hljs-keyword">with</span> gr.Tab(<span class="hljs-string">&quot;Text-to-Image&quot;</span>): <br>        <span class="hljs-comment"># gr.Markdown(&quot;Stable Diffusion XL Base + Refiner.&quot;)</span><br>        model_selected = gr.Radio([<span class="hljs-string">&quot;sd-xl-base-refiner-1.0&quot;</span>,<span class="hljs-string">&quot;sd-xl-base-1.0&quot;</span>],show_label=<span class="hljs-literal">False</span>, value=<span class="hljs-string">&quot;sd-xl-base-refiner-1.0&quot;</span>)       <br>        <span class="hljs-keyword">with</span> gr.Row():<br>            <span class="hljs-keyword">with</span> gr.Column(scale=<span class="hljs-number">4</span>):<br>                prompt = gr.Textbox(label= <span class="hljs-string">&quot;Prompt&quot;</span>,lines=<span class="hljs-number">3</span>)<br>                negative_prompt = gr.Textbox(label= <span class="hljs-string">&quot;Negative Prompt&quot;</span>,lines=<span class="hljs-number">1</span>)<br>                <span class="hljs-keyword">with</span> gr.Row():<br>                    <span class="hljs-keyword">with</span> gr.Column():                        <br>                        n_steps=gr.Slider(<span class="hljs-number">20</span>, <span class="hljs-number">60</span>, value=default_n_steps, label=<span class="hljs-string">&quot;Steps&quot;</span>, info=<span class="hljs-string">&quot;Choose between 20 and 60&quot;</span>)<br>                        high_noise_frac=gr.Slider(<span class="hljs-number">0</span>, <span class="hljs-number">1</span>, value=<span class="hljs-number">0.8</span>, label=<span class="hljs-string">&quot;Denoising Start at&quot;</span>)<br>                    <span class="hljs-keyword">with</span> gr.Column():     <br>                        num_images=gr.Slider(<span class="hljs-number">1</span>, <span class="hljs-number">3</span>, value=default_num_images, label=<span class="hljs-string">&quot;Gernerated Images&quot;</span>, info=<span class="hljs-string">&quot;Choose between 1 and 3&quot;</span>) <span class="hljs-comment">#num images=4,A10报显存溢出</span><br>                        cfg_scale=gr.Slider(<span class="hljs-number">1</span>, <span class="hljs-number">20</span>, value=<span class="hljs-number">7.5</span>, label=<span class="hljs-string">&quot;CFG Scale&quot;</span>)<br>            <span class="hljs-keyword">with</span> gr.Column(scale=<span class="hljs-number">1</span>):<br>                <span class="hljs-keyword">with</span> gr.Row():<br>                    txt2img_button = gr.Button(<span class="hljs-string">&quot;Generate&quot;</span>,size=<span class="hljs-string">&quot;sm&quot;</span>)<br>                    clear_button = gr.Button(<span class="hljs-string">&quot;Clear&quot;</span>,size=<span class="hljs-string">&quot;sm&quot;</span>)<br>        gallery = gr.Gallery(label=<span class="hljs-string">&quot;Generated images&quot;</span>, show_label=<span class="hljs-literal">False</span>, elem_id=<span class="hljs-string">&quot;gallery&quot;</span>,columns=<span class="hljs-built_in">int</span>(num_images.value), height=<span class="hljs-number">800</span>,object_fit=<span class="hljs-string">&#x27;fill&#x27;</span>)<br>        <br>        txt2img_button.click(predit_txt2img, inputs=[prompt, negative_prompt, model_selected,num_images,n_steps, high_noise_frac,cfg_scale], outputs=[gallery])<br>        clear_button.click(clear_txt2img, inputs=[prompt, negative_prompt], outputs=[prompt, negative_prompt])<br>    <br>    <span class="hljs-keyword">with</span> gr.Tab(<span class="hljs-string">&quot;Image-to-Image&quot;</span>):  <br>        model_selected = gr.Radio([<span class="hljs-string">&quot;sd-xl-refiner-1.0&quot;</span>],value=<span class="hljs-string">&quot;sd-xl-refiner-1.0&quot;</span>,show_label=<span class="hljs-literal">False</span>)<br>        <span class="hljs-keyword">with</span> gr.Row():<br>            <span class="hljs-keyword">with</span> gr.Column(scale=<span class="hljs-number">1</span>):<br>                prompt = gr.Textbox(label= <span class="hljs-string">&quot;Prompt&quot;</span>,lines=<span class="hljs-number">2</span>)<br>            <span class="hljs-keyword">with</span> gr.Column(scale=<span class="hljs-number">1</span>):            <br>                negative_prompt = gr.Textbox(label= <span class="hljs-string">&quot;Negative Prompt&quot;</span>,lines=<span class="hljs-number">2</span>)<br>        <span class="hljs-keyword">with</span> gr.Row():<br>            <span class="hljs-keyword">with</span> gr.Column(scale=<span class="hljs-number">3</span>):<br>                image_input = gr.Image(<span class="hljs-built_in">type</span>=<span class="hljs-string">&quot;pil&quot;</span>,height=<span class="hljs-number">512</span>)<br>            <span class="hljs-keyword">with</span> gr.Column(scale=<span class="hljs-number">3</span>):<br>                image_output = gr.Image(height=<span class="hljs-number">512</span>)<br>            <span class="hljs-keyword">with</span> gr.Column(scale=<span class="hljs-number">1</span>):<br>                img2img_deepbooru = gr.Button(<span class="hljs-string">&quot;Interrogate DeepBooru&quot;</span>,size=<span class="hljs-string">&quot;sm&quot;</span>)<br>                <span class="hljs-comment"># img2img_clip = gr.Button(&quot;Interrogate CLIP&quot;,size=&quot;sm&quot;)</span><br>                img2img_button = gr.Button(<span class="hljs-string">&quot;Generate&quot;</span>,size=<span class="hljs-string">&quot;lg&quot;</span>)<br>                clear_button = gr.Button(<span class="hljs-string">&quot;Clear&quot;</span>,size=<span class="hljs-string">&quot;sm&quot;</span>) <br>                                <br>                n_steps=gr.Slider(<span class="hljs-number">20</span>, <span class="hljs-number">60</span>, value=<span class="hljs-number">40</span>, step=<span class="hljs-number">10</span>,label=<span class="hljs-string">&quot;Steps&quot;</span>)<br>                high_noise_frac=gr.Slider(<span class="hljs-number">0</span>, <span class="hljs-number">1</span>, value=<span class="hljs-number">0.8</span>, step=<span class="hljs-number">0.1</span>,label=<span class="hljs-string">&quot;Denoising Start at&quot;</span>)<br>                cfg_scale=gr.Slider(<span class="hljs-number">1</span>, <span class="hljs-number">20</span>, value=<span class="hljs-number">7.5</span>, step=<span class="hljs-number">0.1</span>,label=<span class="hljs-string">&quot;CFG Scale&quot;</span>)<br>                strength=gr.Slider(<span class="hljs-number">0</span>, <span class="hljs-number">1</span>, value=<span class="hljs-number">0.3</span>,step=<span class="hljs-number">0.1</span>,label=<span class="hljs-string">&quot;Denoising strength&quot;</span>)  <br>       <br>        img2img_deepbooru.click(fn=interrogate_deepbooru, inputs=image_input,outputs=[prompt])<br>        img2img_button.click(predit_img2img, inputs=[prompt, negative_prompt, image_input, model_selected, n_steps, high_noise_frac,cfg_scale,strength], outputs=image_output)<br>        clear_button.click(clear_img2img, inputs=[prompt, negative_prompt, image_input], outputs=[prompt, negative_prompt, image_input,image_output]) <br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&quot;__main__&quot;</span>:<br>    demo.launch(server_name=<span class="hljs-string">&quot;0.0.0.0&quot;</span>, server_port=<span class="hljs-number">8000</span>)<br></code></pre></td></tr></table></figure>        </div>      </div>    </div><p><img src="https://i.imgur.com/0AR2q5n.png" width="500" /></p><p><img src="https://i.imgur.com/5SRHOZj.png" /></p><h1 id="access-to-model-is-restricted-not-yet">Access to model is restricted (not yet)</h1><figure class="highlight console"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs console">Cannot access gated repo for url https://huggingface.co/stabilityai/stable-diffusion-3.5-large/resolve/main/model_index.json.<br>Access to model stabilityai/stable-diffusion-3.5-large is restricted. You must have access to it and be authenticated to access it. Please log in.<br></code></pre></td></tr></table></figure><div class="note note-success">            <p>huggingface -- sign up -- Access Tokens -- generate token key</p>          </div><p>You need to sign in to huggingface, accept the license agreement on sd 3.5 page, go to settings in your hf profile, find your token and input it in sd next config file.</p><figure class="highlight console"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs console"><span class="hljs-meta prompt_">$ </span><span class="language-bash">huggingface-cli login</span><br><br>    _|    _|  _|    _|    _|_|_|    _|_|_|  _|_|_|  _|      _|    _|_|_|      _|_|_|_|    _|_|      _|_|_|  _|_|_|_|<br>    _|    _|  _|    _|  _|        _|          _|    _|_|    _|  _|            _|        _|    _|  _|        _|<br>    _|_|_|_|  _|    _|  _|  _|_|  _|  _|_|    _|    _|  _|  _|  _|  _|_|      _|_|_|    _|_|_|_|  _|        _|_|_|<br>    _|    _|  _|    _|  _|    _|  _|    _|    _|    _|    _|_|  _|    _|      _|        _|    _|  _|        _|<br>    _|    _|    _|_|      _|_|_|    _|_|_|  _|_|_|  _|      _|    _|_|_|      _|        _|    _|    _|_|_|  _|_|_|_|<br><br>    To log in, `huggingface_hub` requires a token generated from https://huggingface.co/settings/tokens .<br>Enter your token (input will not be visible): <br>Add token as git credential? (Y/n) n<br>Token is valid (permission: fineGrained).<br>The token `sd` has been saved to /home/wpsze/.cache/huggingface/stored_tokens<br>Your token has been saved to /home/wpsze/.cache/huggingface/token<br>Login successful.<br>The current active token is: `sd`<br></code></pre></td></tr></table></figure><p>Then,</p><figure class="highlight console"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs console">403 Forbidden: Please enable access to public gated repositories in your fine-grained token settings to view this repository..<br>Cannot access content at: https://huggingface.co/stabilityai/stable-diffusion-3.5-large/resolve/main/model_index.json.<br>Make sure your token has the correct permissions.<br></code></pre></td></tr></table></figure><h1 id="references">References</h1><ol type="1"><li><a href="https://soulteary.com/2023/07/29/get-started-with-stability-ai-sdxl-1-0-release-using-docker.html">使用 Docker 快速上手 Stability AI 的 SDXL 1.0 正式版</a></li><li><a href="https://soulteary.com/2022/12/10/play-the-stable-diffusion-model-on-macbook-devices-with-m1-and-m2-chips.html">在搭载 M1 及 M2 芯片 MacBook设备上玩 Stable Diffusion 模型</a></li><li><a href="https://www.volcengine.com/docs/6419/1149863">GPU-基于Diffusers和Gradio搭建SDXL推理应用</a></li><li><a href="https://medium.com/@yvontarbajo/%E9%BA%BB%E7%93%9C%E8%B5%B0%E5%85%A5%E9%AD%94%E6%B3%95%E4%B8%96%E7%95%8C-i-gradio-2e9705f2410e">麻瓜走入魔法世界 I — Gradio</a></li></ol>]]></content>
    
    
    <categories>
      
      <category>ML</category>
      
    </categories>
    
    
    <tags>
      
      <tag>AI</tag>
      
      <tag>ML</tag>
      
      <tag>pytorch</tag>
      
      <tag>LLM</tag>
      
      <tag>huggingface</tag>
      
      <tag>stable-diffusion</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ML | huggingface</title>
    <link href="/2025/01/08/ML-huggingface-LLM/"/>
    <url>/2025/01/08/ML-huggingface-LLM/</url>
    
    <content type="html"><![CDATA[<h1 id="conda-env">Conda env</h1><figure class="highlight console"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs console"><span class="hljs-meta prompt_"># </span><span class="language-bash">check CUDA Version:</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">nvidia-smi</span><br><br>micromamba env create -n huggingface<br>micromamba activate huggingface <br>micromamba install python==3.10<br>micromamba install pytorch torchvision torchaudio pytorch-cuda=12.4 -c pytorch -c nvidia<br>micromamba install conda-forge::transformers<br>micromamba install git-lfs<br></code></pre></td></tr></table></figure><h1 id="where-does-hugging-faces-transformers-save-models">Where does hugging face's transformers save models?</h1><p>The cache location has changed again, and is now <code>~/.cache/huggingface/hub/</code></p><figure class="highlight console"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs console"><span class="hljs-meta prompt_">$ </span><span class="language-bash"><span class="hljs-built_in">du</span> -sh ~/.cache/huggingface/hub/*</span><br>6.3G/home/wpsze/.cache/huggingface/hub/models--deepseek-ai--deepseek-vl2-tiny<br>414M/home/wpsze/.cache/huggingface/hub/models--dslim--bert-base-NER<br>961M/home/wpsze/.cache/huggingface/hub/models--ecmwf--aifs-single<br>1.7G/home/wpsze/.cache/huggingface/hub/models--microsoft--DialoGPT-medium<br>172K/home/wpsze/.cache/huggingface/hub/models--microsoft--Florence-2-large<br>6.7G/home/wpsze/.cache/huggingface/hub/models--stabilityai--stable-diffusion-xl-base-1.0<br>4.4G/home/wpsze/.cache/huggingface/hub/models--stabilityai--stable-diffusion-xl-refiner-1.0<br>4.0K/home/wpsze/.cache/huggingface/hub/version.txt<br>4.0K/home/wpsze/.cache/huggingface/hub/version_diffusers_cache.txt<br></code></pre></td></tr></table></figure><h1 id="example">Example</h1><ul><li><a href="https://waipangsze.github.io/2025/01/09/ML-stable-diffusion/" class="uri">https://waipangsze.github.io/2025/01/09/ML-stable-diffusion/</a></li></ul>]]></content>
    
    
    <categories>
      
      <category>ML</category>
      
    </categories>
    
    
    <tags>
      
      <tag>AI</tag>
      
      <tag>ML</tag>
      
      <tag>pytorch</tag>
      
      <tag>LLM</tag>
      
      <tag>huggingface</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ML | Scaling Law</title>
    <link href="/2025/01/08/ML-Scaling-Law/"/>
    <url>/2025/01/08/ML-Scaling-Law/</url>
    
    <content type="html"><![CDATA[<h1 id="scaling-law">Scaling Law</h1><p>In machine learning, a neural scaling law is an empirical scaling law that describes how neural network performance changes as key factors are scaled up or down. These factors typically include the <strong>number of parameters</strong>, <strong>training dataset size</strong>, and <strong>training cost</strong>.</p><ul><li>Scaling Law 定義：我們可以用模型大小、Dataset大小、總計算量，來預測模型最終能力。（通常以相對簡單的函數型態, ex: Linear relationship）</li><li>如果我們接受原本Scaling Law的定義（模型性能可藉由參數量、Dataset大小、計算量預測），馬上就會衍伸出兩個很重要的問題。<ul><li>Return（收益）：在固定的訓練計算量之下，我們所能得到的最好性能是多好？</li><li>Allocation（分配）：我們要怎麼分配我們的模型參數量跟Dataset大小。（假設計算量 = 參數量 * Dataset size，我們要大模型 * 少量data、中模型 * 中量data、還是小模型 * 大量data）</li></ul></li><li>2022年DeepMind提出Chinchilla Scaling Law，同時解決了這兩個問題，並且依此改善了當時其他大模型的訓練方式。<ul><li>他們基於三種方式來找到訓練LLM的Scaling Law：<ul><li>固定模型大小，變化訓練Data數量。</li><li>固定計算量（浮點運算），變化模型大小。</li><li>對所有實驗結果，直接擬合參數化損失函數。</li></ul></li></ul></li><li><strong>這就像是開頭OpenAI的圖，找到了一個預估訓練LLM回報的公式，依此，我們不用拿超大的模型跟數據，用幾個月甚至幾年的時間慢慢做實驗，只要在小模型、小數據下驗證、確認我們的公式，就可以設計一個更大型的訓練，大幅度減少了實驗成本</strong>。</li></ul><h2 id="因應scaling-law我們要如何改變我們的工作模式與思考方式">因應Scaling Law，我們要如何改變我們的工作模式與思考方式？</h2><ul><li>要能 Scaling，意味著組織必須能夠支援持續擴大（Scale）模型的infra跟GPU資源分配模式。<ul><li>首先，我們來說 infrastructure，以7B模型而言，粗估要佔用15GB~20GB的GPU memory，也就是說如果你全參數訓練，一張A100（80GB GPU memory）只能開 Batch = 4，如果你想要 Batch = 64, 128，那麼必須先進行跨卡和跨機的訓練環境設置。</li><li>同時為了加速訓練，讓memory使用率變的更高，每一兩個月幾乎就有新的技術、python package出來，Ex: Flash Attention 2, Zero 3, Vllm, Gradient Checkpoint, CPU offloading …等，隨時追蹤最新的訓練優化技術，並且保持組織的Server要能夠高頻率做改變，如果一個組織對Server裡面pip版本更新、各種packages更新的週期都是以月為單位，注定會在infra層面落後全世界半年到一年。</li></ul></li></ul><h2 id="gpu的資源分配模式-通過scaling檢查">GPU的資源分配模式, 通過Scaling檢查</h2><p>GPU的資源分配模式，傳統實驗室、公司的GPU資源模式不外乎兩種：</p><ul><li>平均分攤GPU給每個人</li><li>因應Project去申請更大型的GPU cluster</li></ul><div class="note note-primary">            <p>更好的方法應該是盡量讓每個Project都具備在 3B 以下模型進行概念驗證的能力，並<strong>設計正式的Scaling檢查機制</strong>，只有<strong>通過Scaling檢查的團隊</strong>可以 "By experiments" 去使用更大的GPU Cluster。這邊提到Scaling檢查機制，核心就是，當我們想要跑7B甚至13B模型時，我們最好在3B以下的模型都有一致的Scaling Behavior。最好在BERT跟T5這兩種大小先進行過概念驗證。</p>          </div><h2 id="scaling其中最少都會包含三個階段">Scaling，其中最少都會包含三個階段</h2><ul><li>Cold start：一開始模型太小、Data不夠、問題太難時，會呈現怎麼訓練都沒有幫助，好幾個不同大小的模型、Dataset訓練出來的結果都差不多爛，看不出Scaling的時期。</li><li>Scaling：正常的Scaling時期。</li><li>Plateau：撞到了某個隱形的天花板，可能是Dataset品質帶來的天花板、本身任務的Irreducible Error、Architecture的能力天花板。</li></ul><p><img src="https://miro.medium.com/v2/resize:fit:828/format:webp/1*7bmT0RvnsfR1vvQ2ZBh8WQ.png" width="600" /></p><h2 id="一個好的idea一定要具備scale的潛能">一個好的idea，一定要具備Scale的潛能</h2><h1 id="references">References</h1><ul><li><a href="https://axk51013.medium.com/llm%E5%B0%88%E6%AC%84-%E8%BF%8E%E6%8E%A52024%E5%B9%B4-10%E5%80%8B%E5%BF%85%E9%A0%88%E8%A6%81%E6%90%9E%E6%87%82%E7%9A%84llm%E6%A6%82%E5%BF%B5-1-scaling-law-5f6a409d35c5">LLM 10大觀念-1 Scaling Law</a></li><li><a href="https://en.wikipedia.org/wiki/Neural_scaling_law">Neural_scaling_law | wiki</a></li><li><a href="https://arxiv.org/abs/2001.08361">Kaplan, Jared, et al. "Scaling laws for neural language models." arXiv preprint arXiv:2001.08361 (2020). | OpenAI</a></li></ul>]]></content>
    
    
    <categories>
      
      <category>ML</category>
      
    </categories>
    
    
    <tags>
      
      <tag>AI</tag>
      
      <tag>ML</tag>
      
      <tag>pytorch</tag>
      
      <tag>LLM</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ML | GPU Memory for ML model</title>
    <link href="/2025/01/07/ML-GPU-Memory-for-Models/"/>
    <url>/2025/01/07/ML-GPU-Memory-for-Models/</url>
    
    <content type="html"><![CDATA[<h1 id="gpu-memory-you-need-to-serve-any-ml-models">GPU Memory you need to serve any ML models</h1><p><strong>System Memory (RAM)</strong> is not ideal for this purpose because it is slower than GPU memory. <strong>GPU memory</strong>, also known as <strong>VRAM (Video Memory)</strong> or <strong>GDDR (Graphics DDR)</strong>, is specifically designed for high-performance computing tasks like deep learning. It provides the speed and bandwidth needed to efficiently run large language models.</p><div class="note note-primary">            <p>So, the more VRAM the GPU has, the bigger Model/LLM it can host and serve</p>          </div><ul><li>P (parameters) : The number of parameters in the model. For example, GPT-3 has 175 Billion parameters, Llama-70b has 70 Billion Parameters etc.</li><li>Q (Precision or Size per parameter) : Is the data type used to store the model parameters. Common data types include:<ul><li>FP32 (32-bit floating point): 4 bytes per parameter</li><li>FP16 (half/BF16) (16-bit floating point): 2 bytes per parameter</li><li>INT8 (8-bit integer): 1 byte per parameter</li><li>INT4 (4-bit integer): 0.5 bytes per parameter</li></ul></li></ul><p>Overhead factor : This accounts for additional memory used during inference, such as storing activations (intermediate results) of the model. A typical overhead factor is 20%.</p><p>以 Llama-2-7b-hf 為例</p><ul><li>因為全精度模型參數是 float32 類型, 佔用 4 個位元組，粗略計算：1b(10億)個模型參數，約佔用4G顯存(實際大小：10^9 * 4 / 1024^3 ~= 3.725 GB) ，則LLaMA 的參數量為7b，那麼載入模型參數所需的顯存為：3.725 * 7 ~= 26.075 GB</li><li>如果您的顯存不足 32GB，那麼可以設定半精度的 FP16/BF16 來加載，每個參數只佔 2 個字節，所需顯存就直接減半，只需要約 13GB。雖然模型效果會因精度損失而略微降低，但一般在可接受範圍。</li><li>如果您的顯存不足 16GB，那麼可以採用 int8 量化後，顯存再減半，只需要約 6.5GB，但是模型效果會更差一些。</li><li>如果您的顯存少於 8GB，那麼只能採用 int4 量化，顯示再減半，只需要約 3.26GB。</li></ul><p>我們來說 infrastructure，以7B模型而言，粗估要佔用 15GB~20GB 的GPU memory，也就是說如果你全參數訓練，一張A100（80GB GPU memory）只能開 Batch = 4，如果你想要 Batch = 64, 128，那麼必須先進行跨卡和跨機的訓練環境設置。</p><h2 id="torch.dtype">torch.dtype</h2><ul><li><a href="https://pytorch.org/docs/stable/tensor_attributes.html" class="uri">https://pytorch.org/docs/stable/tensor_attributes.html</a></li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># add `torch_dtype=torch.float16` to use half the memory</span><br></code></pre></td></tr></table></figure><h1 id="references">References</h1><ul><li><a href="https://www.microsoft.com/en-us/research/uploads/prod/2020/09/dnnmem.pdf">Estimating GPU Memory Consumption of Deep Learning Models | microsoft | 2020 (<strong>Recommended</strong>)</a></li><li><a href="https://ksingh7.medium.com/calculate-how-much-gpu-memory-you-need-to-serve-any-llm-67301a844f21">Calculate : How much GPU Memory you need to serve any LLM ?</a></li><li><a href="https://unfoldai.com/gpu-memory-requirements-for-llms/">GPU memory requirements for serving Large Language Models</a></li><li><a href="https://www.jiqizhixin.com/articles/2020-02-19-9">2020年搞深度学习需要什么样的GPU：请上48G显存</a></li><li><a href="https://cloud.tencent.com/developer/article/2403424">挑战性能极限小显卡大作为，教你如何在有限资源下运行大型深度学习模型，GPU显存估算并高效利用全攻略！</a></li></ul>]]></content>
    
    
    <categories>
      
      <category>ML</category>
      
    </categories>
    
    
    <tags>
      
      <tag>AI</tag>
      
      <tag>ML</tag>
      
      <tag>pytorch</tag>
      
      <tag>NVIDIA</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>CFD | Boussinesq approximation (buoyancy)</title>
    <link href="/2025/01/03/CFD-Boussinesq-approximation-buoyancy/"/>
    <url>/2025/01/03/CFD-Boussinesq-approximation-buoyancy/</url>
    
    <content type="html"><![CDATA[<h1 id="boussinesq-approximation-buoyancy">Boussinesq approximation (buoyancy)</h1><p>In fluid dynamics, the Boussinesq approximation is used in the field of buoyancy-driven flow (also known as natural convection). It ignores density differences except where they appear in terms multiplied by <span class="math inline">\(g\)</span>, the acceleration due to gravity.</p><p>Boussinesq flows are common in nature (such as atmospheric fronts, oceanic circulation, katabatic winds), industry (dense gas dispersion, fume cupboard ventilation), and the built environment (natural ventilation, central heating). The approximation can be used to simplify the equations describing such flows, whilst still describing the flow behaviour to a high degree of accuracy.</p><p><span class="math display">\[ \frac{\partial\rho}{\partial t} + \nabla\cdot\left(\rho\mathbf{u}\right) = 0\]</span></p><p>If density variations are ignored, this reduces to <span class="math display">\[\nabla\cdot\mathbf{u} = 0\]</span></p><p>The general expression for conservation of momentum of an incompressible, Newtonian fluid (the Navier–Stokes equations) is</p><p><span class="math display">\[\frac{\partial \mathbf{u}}{\partial t} + \left( \mathbf{u}\cdot\nabla \right) \mathbf{u} = -\frac{1}{\rho}\nabla p + \nu\nabla^2 \mathbf{u} + \frac{1}{\rho}\mathbf{F}\]</span></p><p>where <span class="math inline">\(F\)</span> is the sum of any body forces such as gravity. In this equation, density variations are assumed to have a fixed part and another part that has a linear dependence on temperature:</p><p><span class="math display">\[\rho = \rho_0 - \alpha\rho_0(T-T_0),\]</span></p><p>where <span class="math inline">\(\alpha\)</span> is the coefficient of <strong>thermal expansion</strong>. The Boussinesq approximation states that the density variation is only important in the buoyancy term.</p><p>If <span class="math inline">\(F = \rho \mathbf{g}\)</span> is the gravitational body force, the resulting conservation equation is</p><p><span class="math display">\[ \frac{\partial \mathbf{u}}{\partial t} + \left( \mathbf{u}\cdot\nabla \right) \mathbf{u} = -\frac{1}{\rho_0}\nabla (p-\rho_0\mathbf{g}\cdot\mathbf{z}) + \nu\nabla^2 \mathbf{u} - \mathbf{g}\alpha(T-T_0)\]</span></p><p>In the equation for heat flow in a temperature gradient, the heat capacity per unit volume, <span class="math display">\[\rho C_p\]</span>, is assumed constant and the dissipation term is ignored. The resulting equation is</p><p><span class="math display">\[\frac{\partial T}{\partial t} + \mathbf{u}\cdot\nabla T = \frac{k}{\rho C_p}\nabla^2T +\frac{J}{\rho C_p}\]</span></p><p>where <span class="math inline">\(J\)</span> is the rate per unit volume of internal heat production and <span class="math inline">\(k\)</span> is the <strong>thermal conductivity</strong>.</p><p>The three numbered equations are the basic convection equations in the Boussinesq approximation.</p><h1 id="references">References</h1><ul><li><a href="https://www.comsol.com/multiphysics/boussinesq-approximation">The Boussinesq Approximation</a></li><li><a href="https://www.simscale.com/docs/simwiki/cfd-computational-fluid-dynamics/what-is-boussinesq-approximation/">What is the Boussinesq Approximation?</a></li><li><a href="https://arxiv.org/abs/2206.03046">The Boussinesq approximation for buoyant flows</a></li></ul>]]></content>
    
    
    <categories>
      
      <category>CFD</category>
      
    </categories>
    
    
    <tags>
      
      <tag>HPC</tag>
      
      <tag>OpenFOAM</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ML | PINN | DeepXDE</title>
    <link href="/2025/01/03/ML-PINN-DeepXDE/"/>
    <url>/2025/01/03/ML-PINN-DeepXDE/</url>
    
    <content type="html"><![CDATA[<h1 id="deepxde">DeepXDE</h1><p>DeepXDE 是一款开源且高度模块化的科学计算工具，以深度学习为核心，提供多种数据、物理机理及数理融合的模型，如PINN、DeepONet、MFNN等，同时支持多种类型微分方程，如常微分方程、偏微分方程的定义及求解，可有效解决复杂科学计算问题。 基于所提供的深度学习求解模型，DeepXDE具备以下典型的功能特点：</p><ul><li>高度模块化：DeepXDE提供多种支持调用、组合的模块，如计算域、边界条件、微分方程、神经网络、训练及预测等，方便用户组合构建物理系统；</li><li>多类微分方程：支持自定义常微分方程、偏微分方程、积分微分方程等来描述具体问题；</li><li>可扩展性：支持用户结合自身需求添加自定义的数值算法、模型或其他功能；</li><li>可视化 ：提供一系列丰富的可视化工具，可以帮助用户直观地理解计算结果。</li></ul><p>在科学计算领域，DeepXDE的强大功能与高精度求解能力，使其成为国内外知名的科学计算工具之一。截止目前，DeepXDE的下载量已超过40万次，并被全球70多所知名大学、科研机构和企业采用，比如MIT、Stanford、美国西北太平洋国家实验室、通用汽车等。在实际应用中，DeepXDE正在帮助用户快速解决复杂的科学计算问题，为各领域科学研究的进展作出了重要贡献。</p><ul><li><a href="https://github.com/lululxvi/deepxde" class="uri">https://github.com/lululxvi/deepxde</a></li><li><a href="https://deepxde.readthedocs.io/en/latest/user/installation.html#" class="uri">https://deepxde.readthedocs.io/en/latest/user/installation.html#</a></li><li><a href="https://www.paddlepaddle.org.cn/support/news?action=detail&amp;id=3315" class="uri">https://www.paddlepaddle.org.cn/support/news?action=detail&amp;id=3315</a></li></ul><h1 id="install">Install</h1><figure class="highlight console"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs console">micromamba create -n deepxde <br>micromamba activate /home/wpsze/micromamba/envs/deepxde<br>micromamba install conda-forge::pytorch-gpu<br>micromamba install -c conda-forge deepxde<br></code></pre></td></tr></table></figure><h1 id="run">Run</h1><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-meta">#!/bin/bash</span><br><br><span class="hljs-built_in">source</span> /home/wpsze/micromamba/etc/profile.d/mamba.sh<br>micromamba activate deepxde<br><br><span class="hljs-comment"># Before running your code, run this shell command to tell torch that there are no GPUs:</span><br><span class="hljs-comment">#export CUDA_VISIBLE_DEVICES=&quot;&quot;</span><br><br>time DDE_BACKEND=pytorch python Helmholtz_equation_2D.py<br></code></pre></td></tr></table></figure><h2 id="gpu">GPU</h2><figure class="highlight console"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs console">nvidia-smi<br></code></pre></td></tr></table></figure><ul><li>GPU usage,</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> torch<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;--&quot;</span>)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;torch.cuda.memory_allocated: %fMB&quot;</span>%(torch.cuda.memory_allocated(<span class="hljs-number">0</span>)/<span class="hljs-number">1024</span>/<span class="hljs-number">1024</span>))<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;torch.cuda.memory_reserved: %fMB&quot;</span>%(torch.cuda.memory_reserved(<span class="hljs-number">0</span>)/<span class="hljs-number">1024</span>/<span class="hljs-number">1024</span>))<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;torch.cuda.max_memory_reserved: %fMB&quot;</span>%(torch.cuda.max_memory_reserved(<span class="hljs-number">0</span>)/<span class="hljs-number">1024</span>/<span class="hljs-number">1024</span>))<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;--&quot;</span>)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;torch.cuda.memory_allocated: %fGB&quot;</span>%(torch.cuda.memory_allocated(<span class="hljs-number">0</span>)/<span class="hljs-number">1024</span>/<span class="hljs-number">1024</span>/<span class="hljs-number">1024</span>))<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;torch.cuda.memory_reserved: %fGB&quot;</span>%(torch.cuda.memory_reserved(<span class="hljs-number">0</span>)/<span class="hljs-number">1024</span>/<span class="hljs-number">1024</span>/<span class="hljs-number">1024</span>))<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;torch.cuda.max_memory_reserved: %fGB&quot;</span>%(torch.cuda.max_memory_reserved(<span class="hljs-number">0</span>)/<span class="hljs-number">1024</span>/<span class="hljs-number">1024</span>/<span class="hljs-number">1024</span>))<br>device = torch.device(<span class="hljs-string">&#x27;cuda:0&#x27;</span>)<br>free, total = torch.cuda.mem_get_info(device)<br>mem_used_MB = (total - free) / <span class="hljs-number">1024</span> ** <span class="hljs-number">2</span><br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;mem_used_MB = &quot;</span>, mem_used_MB)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;mem_used_GB = &quot;</span>, mem_used_MB/<span class="hljs-number">1024</span>)<br></code></pre></td></tr></table></figure><h2 id="cpu-only">CPU only</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># Before running your code, run this shell command to tell torch that there are no GPUs:</span><br><span class="hljs-built_in">export</span> CUDA_VISIBLE_DEVICES=<span class="hljs-string">&quot;&quot;</span><br><br><span class="hljs-comment"># This will tell it to use only one GPU (the one with id 0) and so on:</span><br><span class="hljs-built_in">export</span> CUDA_VISIBLE_DEVICES=<span class="hljs-string">&quot;0&quot;</span><br></code></pre></td></tr></table></figure><h2 id="cpu-vs-gpu">CPU vs GPU</h2><p>Test: <a href="https://deepxde.readthedocs.io/en/latest/demos/pinn_forward/helmholtz.2d.neumann.hole.html">Helmholtz equation over a 2D square domain with a hole</a></p><ul><li>iterations = 10000</li><li>num_dense_layers = 6</li><li>num_dense_nodes = 1350</li></ul><table><thead><tr class="header"><th></th><th>Cores</th><th>Training Time</th><th></th></tr></thead><tbody><tr class="odd"><td>CPU</td><td>20</td><td>5809s ~ 97min</td><td></td></tr><tr class="even"><td>GPU</td><td>10496</td><td>227s ~ 3.78min</td><td></td></tr><tr class="odd"><td>GPU/CPU</td><td>524.8</td><td>0.03907729385</td><td>1/0.039 ~ 25.59</td></tr></tbody></table><ul><li>CPU: (%CPU=2000)<ul><li>Intel(R) Xeon(R) Silver 4210R CPU @ 2.40GHz</li><li>Core(s) per socket: 10</li><li>Socket(s): 2</li></ul></li><li>GPU: 3090 (Volatile GPU util ~ 87%)<ul><li>CUDA cores: 10496</li></ul></li></ul><h1 id="reproducibility">Reproducibility</h1><p>Completely reproducible results are not guaranteed across PyTorch releases, individual commits, or different platforms. Furthermore, results may not be reproducible between CPU and GPU executions, even when using identical seeds.</p><p>However, there are some steps you can take to limit the number of sources of nondeterministic behavior for a specific platform, device, and PyTorch release. First, you can control sources of randomness that can cause multiple executions of your application to behave differently. Second, you can configure PyTorch to avoid using nondeterministic algorithms for some operations, so that multiple calls to those operations, given the same inputs, will produce the same result.</p><ul><li><a href="https://pytorch.org/docs/stable/notes/randomness.html" class="uri">https://pytorch.org/docs/stable/notes/randomness.html</a></li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> torch<br>torch.manual_seed(<span class="hljs-number">0</span>)<br><br><span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np<br>np.random.seed(<span class="hljs-number">0</span>)<br><br><span class="hljs-keyword">import</span> random<br>random.seed(<span class="hljs-number">0</span>)<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>ML</category>
      
    </categories>
    
    
    <tags>
      
      <tag>AI</tag>
      
      <tag>PINN</tag>
      
      <tag>DeepONet</tag>
      
      <tag>ML</tag>
      
      <tag>DeepXDE</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>NWP | Bias Correction</title>
    <link href="/2025/01/02/NWP-Bias-Correction/"/>
    <url>/2025/01/02/NWP-Bias-Correction/</url>
    
    <content type="html"><![CDATA[<ul><li><a href="https://www.hko.gov.hk/hko/publica/reprint/r948.pdf">應用「模式輸出統計」校正數碼氣溫預報 | HKO | 2011</a><ul><li>多元線性回歸及卡爾曼濾波</li><li>出現次數最多的最佳因子，首三位為2米溫度、925hPa經向風及850hPa溫度</li></ul></li><li><a href="https://www.weather.gov.hk/tc/publica/reprint/files/r1010.pdf">應用「模式輸出統計」校正相對濕度及風的數碼預報 | HKO | 2012</a><ul><li>把2010年9月至2011年8月的數據分為四季，分別找出不同統計模型在四季及全年(即2010年9月至2011年8月)的最佳因子組合。</li><li>不同季節的比較</li><li>時間及空間的變化</li><li>t–測試</li></ul></li><li><a href="https://www.weather.gov.hk/tc/publica/ghm_21/files/MPaper_Choi.pdf">利用卡爾曼濾波修正每日地面氣溫預報 | 澳門地球物理暨氣象局</a></li><li><a href="https://www.hko.gov.hk/hko/publica/reprint/r1226.pdf">按天氣情境修正數值預報模式的低溫預報 | HKO | 2016</a></li></ul>]]></content>
    
    
    <categories>
      
      <category>NWP</category>
      
    </categories>
    
    
    <tags>
      
      <tag>NWP</tag>
      
      <tag>AI</tag>
      
      <tag>ML</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ML | CorrDiff (NVIDIA)</title>
    <link href="/2025/01/02/ML-CorrDiff-NVIDIA/"/>
    <url>/2025/01/02/ML-CorrDiff-NVIDIA/</url>
    
    <content type="html"><![CDATA[<h1 id="news">News</h1><ul><li><a href="https://www.scimonth.com.tw/archives/10997">生成式AI與傳統數值天氣預報的結合NVIDIA CorrDiff天氣降尺度模型 | 科學月刊 | 2024-07-15</a><ul><li>輝達（NVIDIA）執行長黃仁勳今（2024）年3月在美國舉辦的GTC（GPU technology conference）大會及6月在臺灣舉辦的臺北國際電腦展（COMPUTEX）上，皆展示了一項稱為「CorrDiff」（ Corrector Diffusion ）的生成式人工智慧（generative artificial intelligence, generative AI）技術，並表示它可以應用於區域高解析度天氣預報上。</li><li>對於氣象模擬與預報來說，縮小網格解析度一直是一大挑戰。傳統物理模式受限於運行時所需的龐大運算量，當今執行全球預報的最高解析度模式為ECMWF的九公里解析度全球模式。</li><li>氣象署發展的「RWRF」（Radar WRF）高解析度極短期劇烈天氣預報系統（延伸閱讀2），可提升對臺灣區域劇烈天氣的預報能力。此系統奠基於美國國家大氣研究中心（National Center for Atmospheric Research）的「WRF」（Weather Research &amp; Forecasting）數值天氣預報模式與它的資料同化系統（WRFDA），再由氣象署針對臺灣本地需求修改發展，自2016年起開始作業運作。RWRF系統的模式解析度為兩公里，涵蓋範圍如圖一所示。它能運行區域高解析度的<strong>快速更新循環資料同化</strong>，將高解析度的即時觀測資料運用於區域模式中，藉此得到區域範圍內更準確的分析與短期預報資料，比單純的動力降尺度預報更為複雜。<strong>其中，資料同化使臺灣區域的氣象雷達觀測資料每半小時進入此模式中、地面氣象站觀測資料（包含人工和自動氣象站）每一小時進入模式中。RWRF系統以每小時的更新頻率提供13小時長度的預報資料，</strong> 作為署內預報中心與民航局等相關政府單位的參考。</li><li>我們可以知道此模型在訓練過程中採用的輸入資料為ERA5全球約25公里解析度再分析資料（僅擷取與RWRF範圍相近的臺灣鄰近範圍）；而採用的輸出資料則為氣象署RWRF系統的兩公里解析度歷史分析資料，包含垂直最大雷達回波（radar reflectivity）、兩公尺高氣溫、十公尺高東西向與南北向風速等四個單層變數。</li><li>在氣象署提供的四年餘的RWRF資料中，前三年被用作為訓練資料，而後面的一年四個月則是驗證資料。</li><li>由此設計可知，CorrDiff模型的目標是將較低解析度（約25公里）的全球天氣預報模式資料，提升解析度成為高解析度（兩公里）的資料，並在過程中獲得對區域劇烈天氣預報重要的氣象變數──最大雷達回波、地面氣溫與風速。</li><li>就使用長期歷史資料建立模型而論，CorrDiff可說是一種進階（AI）版的統計降尺度；但它能得到高解析度網格資料而非觀測點上的資料，以目標與效果而言比較近似於動力降尺度技術。</li><li><strong>CorrDiff模型採用兩步驟來完成降尺度的計算</strong>：<ul><li><strong>第一步驟</strong>是先以常應用於影像處理、能有效獲取影像特徵的UNet回歸架構，進行資料樣本平均值的修正；</li><li><strong>第二步驟</strong>則利用生成式AI中的擴散（diffusion）演算法，強化資料的高解析度細節與極值。擴散演算法透過將圖像加入雜訊，再去除雜訊的循環過程來執行，過去常應用於圖片的去噪（denoising）、修補或超解析度成像等。</li></ul></li><li>最後，CorrDiff模型的運算速度遠遠快於RWRF系統的數值天氣預報模式，後者需要在高速運算電腦上使用大量中央處理器（central processing unit, CPU）核心進行運算，而前者在單一圖形處理器（graphics processing unit, GPU）上即可用更短的時間完成運算，兩者的能源使用效率有天壤之別。</li><li>參考預印本論文中所提，未來此技術可能有以下幾種不同的應用方式<ul><li>一、由傳統全球模式數值天氣預報資料，降尺度成為高解析度預報。</li><li>二、由AI全球天氣預報模式的預報資料，降尺度成為高解析度預報。</li><li>三、氣候模擬研究（例如氣候變遷推估）上的降尺度應用，特別是用於評估未來極端天氣事件發生的機率。</li><li>四、用於與RWRF系統截然不同的其他地理區域的降尺度（可能仍需要取得對應區域的高解析度氣象資料用於模型訓練）。<ul><li>其中，第三點與第四點的應用方式尚未直接有研究結果，仍為潛在應用，有待未來更多研究來證明與展示它的能力。</li></ul></li></ul></li></ul></li><li>輝達執行長黃仁勳皆提到與中央氣象署合作開發的生成式AI模型「CorrDiff」，能透過AI將氣象資料解析度從25公里降至2公里，與傳統模式相比，更可讓單次推理速度提高1,000倍、能耗減少3,000倍。<a href="https://technews.tw/2024/09/28/cwa-corrdiff-nvidia/">link: 2024 年 09 月 28 日</a><ul><li>用CorrDiff來「降尺度」（也就是提高解析度）的重要性由此而生。</li><li>以CorrDiff來說，便是由氣象署提供四年份、以每小時計的2公里氣象資料，共含四個變數，而輝達則拿出25公里氣象資料，並負責演算法及提供超級電腦運算資源，採「監督式學習」（Supervised learning）進行訓練，共同打磨出這款模型。</li><li>「輝達在做CorrDiff之前，其實已經在全球天氣預報有非常好的成果，所以他接著就要找一個小尺度、天氣最困難最複雜的地方，」陳柏孚分析，台灣處在最大季風區、有複雜地形，又有颱風、梅雨，本身就夠挑戰、夠有特色，雙方合作是雙贏。</li></ul></li></ul><h1 id="paper">Paper</h1><ul><li><a href="https://arxiv.org/abs/2309.15214">Mardani, Morteza, et al. "Residual corrective diffusion modeling for km-scale atmospheric downscaling." arXiv preprint arXiv:2309.15214 (2023).</a></li></ul><p>Consider a specific region on Earth, mapped onto a two-dimensional grid. Our input <span class="math inline">\(\mathbf{y} \in \mathbb{R} ^{c_\mathrm{in}\times m\times n}\)</span> is a low-resolution meteorological data taken from a 25-km global reanalysis, or weather forecasting model (e.g., FourCastNet [46,36,7], or the Global Forecast System (GFS) [44]). Here, <strong><span class="math inline">\(c_\mathrm{in}\)</span> represents the number of input channels and <span class="math inline">\(m,n\)</span> represent the dimensions of a 2D subset of the globe</strong>. <strong>Our targets <span class="math inline">\(\mathbf{x} \in \mathbb{R} ^{c_\mathrm{out}\times p\times q}\)</span> come from corresponding data aligned in time <span class="math inline">\(c_\mathrm{out}\)</span> but having higher resolution, i.e., <span class="math inline">\(p&gt;m\)</span> and <span class="math inline">\(q&gt;n.\)</span></strong></p><p>In our proof of concept we use the <strong>ERA5 reanalysis as input</strong>, over a subregion surrounding Taiwan, with <span class="math inline">\(m=n=36,c_{in}=12\)</span> and <span class="math inline">\(c_\mathrm{out}=4.\)</span> See Table S2 for details about the inputs and outputs. The target <span class="math inline">\(\begin{array}{c}\text{data are 12.5 times higher resolution }(p=q=448)\end{array}\)</span>and <strong>were produced using a radar-assimilating Weather Research and Forecasting (WRF) physical simulator [48] provided by the Central Weather Administration of Taiwan (CWA) [15] (i.e., CWA-WRF)</strong>, which employs a dynamical downscaling approach. Though imperfect, WRF is a SOTA model for km-scale weather simulations and is used operationally by several national weather agencies.</p><p><span class="math display">\[\begin{align*}\mbox{CorrDiff} : \mathbf{y} \in \mathbb{R} ^{c_\mathrm{in}\times m\times n} \longrightarrow \mathbf{x} \in \mathbb{R} ^{c_\mathrm{out}\times p\times q} \\p&gt;m , q&gt;n\end{align*}\]</span></p><p><img src="https://i.imgur.com/LgX4aZr.png" width="800" /> <img src="https://i.imgur.com/e9PX9n8.png" width="800" /></p><p>CorrDiff employs a two-step approach to effectively manage the complexities of multi-scale atmospheric data:</p><ul><li><strong>UNet Prediction</strong>: The first step involves using a UNet architecture to predict the <em>conditional mean of the atmospheric variables based on lower-resolution data</em>.</li><li><strong>Diffusion Correction</strong>: The second step utilizes a correction diffusion model to predict the residuals, effectively refining the output by learning from the differences between the predicted mean and actual observations.</li><li>This method is <strong>like to Reynolds decomposition in fluid dynamics</strong>, allowing for a more manageable learning process by isolating generative learning to stochastic scales.</li></ul><p>Importantly, <strong>兩步驟來先後訓練</strong></p><ul><li><strong>CorrDiff模型採用兩步驟來完成降尺度的計算</strong>：<ul><li><strong>第一步驟</strong>是先以常應用於影像處理、能有效獲取影像特徵的UNet回歸架構，進行資料樣本平均值的修正；</li><li><strong>第二步驟</strong>則利用生成式AI中的擴散（diffusion）演算法，強化資料的高解析度細節與極值。擴散演算法透過將圖像加入雜訊，再去除雜訊的循環過程來執行，過去常應用於圖片的去噪（denoising）、修補或超解析度成像等。</li></ul></li><li>CorrDiff consists of two steps: regression and generation.<ul><li>The regression step approximates the mean, while</li><li>the generation step further corrects the mean but also generates the distribution, producing fine-scale details stochastically.</li><li>The diffusion component of CorrDiff is found to be <strong>especially important for the task of radar channel synthesis</strong>.</li></ul></li></ul><h1 id="basedline-models">Basedline Models</h1><ul><li>Interpolation of ERA5</li><li>UNet</li><li>Random Forest (RF)</li></ul><h1 id="unet">UNet</h1><p><img src="https://i.imgur.com/6CJzWhN.png" /> <img src="https://i.imgur.com/kWBDUkI.png" /></p><h1 id="stochastic-differential-equations-sdes">Stochastic differential equations (SDEs)</h1><ul><li><a href="https://journals.ametsoc.org/view/journals/mwre/143/3/mwr-d-14-00140.1.xml?tab_body=abstract-display">Selz, T., &amp; Craig, G. C. (2015). <strong>Upscale error growth in a high-resolution simulation of a summertime weather event over Europe</strong>. Monthly Weather Review, 143(3), 813-827.</a></li><li><a href="https://proceedings.neurips.cc/paper_files/paper/2019/file/3001ef257407d5a371a96dcd947c7d93-Paper.pdf">Song, Y., &amp; Ermon, S. (2019). <strong>Generative modeling by estimating gradients of the data distribution</strong>. Advances in neural information processing systems, 32.</a></li><li><a href="https://proceedings.neurips.cc/paper/2020/file/4c5bcfec8584af0d967f1ab10179ca4b-Paper.pdf">Ho, J., Jain, A., &amp; Abbeel, P. (2020). <strong>Denoising diffusion probabilistic models</strong>. Advances in neural information processing systems, 33, 6840-6851.</a></li><li><a href="https://arxiv.org/pdf/2011.13456">Song, Y., Sohl-Dickstein, J., Kingma, D. P., Kumar, A., Ermon, S., &amp; Poole, B. (2020). <strong>Score-based generative modeling through stochastic differential equations</strong>. arXiv preprint arXiv:2011.13456.</a></li><li><a href="https://arxiv.org/pdf/2111.13606">Batzolis, G., Stanczuk, J., Schönlieb, C. B., &amp; Etmann, C. (2021). <strong>Conditional image generation with score-based diffusion models</strong>. arXiv preprint arXiv:2111.13606.</a></li><li><a href="https://proceedings.neurips.cc/paper_files/paper/2022/file/a98846e9d9cc01cfb87eb694d946ce6b-Paper-Conference.pdf">Karras, T., Aittala, M., Aila, T., &amp; Laine, S. (2022). <strong>Elucidating the design space of diffusion-based generative models</strong>. Advances in neural information processing systems, 35, 26565-26577.</a></li></ul><h1 id="getting-started">Getting started</h1><p>To build custom CorrDiff versions, you can get started by training the <strong>“Mini” version of CorrDiff</strong>, which uses smaller training samples and a smaller network to reduce training costs from thousands of GPU hours to <strong>around 10 hours on A100 GPUs</strong> while still producing reasonable results. It also includes a simple data loader that can be used as a baseline for training CorrDiff on custom datasets.</p><p>Start by installing Modulus (if not already installed) and copying this folder (examples/generative/corrdiff) to a system with a GPU available. Also download the CorrDiff-Mini dataset from <a href="https://catalog.ngc.nvidia.com/orgs/nvidia/teams/modulus/resources/modulus_datasets-hrrr_mini">NGC</a>.</p><h2 id="nvidia-modulus">NVIDIA Modulus</h2><ul><li><a href="https://github.com/NVIDIA/modulus" class="uri">https://github.com/NVIDIA/modulus</a></li><li><code>git clone https://github.com/NVIDIA/modulus.git</code></li><li><a href="https://github.com/NVIDIA/modulus/tree/main/examples/generative/corrdiff" class="uri">https://github.com/NVIDIA/modulus/tree/main/examples/generative/corrdiff</a></li><li><a href="https://docs.nvidia.com/deeplearning/modulus/getting-started/index.html#system-requirements">Modulus Overview | System Requirements</a></li><li>The <strong>CorrDiff-Mini training dataset</strong> of ERA5 (low-resolution) reanalysis and the corresponding HRRR (high-resolution) analysis fields at a resolution of approximately 3 km per pixel. It is intended to be used with the CorrDiff-Mini code in Modulus to enable training a lightweight CorrDiff version for educational and testing purposes and as a baseline for implementing custom versions of CorrDiff.<ul><li><a href="https://catalog.ngc.nvidia.com/orgs/nvidia/teams/modulus/resources/modulus_datasets-hrrr_mini" class="uri">https://catalog.ngc.nvidia.com/orgs/nvidia/teams/modulus/resources/modulus_datasets-hrrr_mini</a></li><li>The data are collected from the <strong>period 2018-2021 from the HRRR CONUS</strong> domain covering the continental United States and some surrounding regions. The samples are <strong>64x64 pixels in size</strong>, with a spatial resolution of <strong>approximately 3 km per pixel</strong>.</li><li>The ERA5 variables, intended to be used as the CorrDiff input, include <strong>temperatures (t), geopotential height (z), west-east (u) and south-north (v) winds and specific humidities (q), each as 1000, 850, 500 and 250 hPa pressure levels, as well as the 10-meter winds, 2-meter temperature, total column water vapor, surface pressure and mean sea level pressure.</strong> The HRRR variables, intended as the CorrDiff <strong>output, include 10-meter winds, 2-meter temperature and total precipitation.</strong></li></ul></li></ul><figure class="highlight console"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs console">micromamba env create -n CorrDiff<br>micromamba activate CorrDiff<br>micromamba install pytorch torchvision torchaudio pytorch-cuda=12.4 -c pytorch -c nvidia<br>pip install nvidia-modulus[all]<br>pip install quadpy orthopy ndim gdown<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">OSError: CUDA_HOME environment variable is not <span class="hljs-built_in">set</span>. Please <span class="hljs-built_in">set</span> it to your CUDA install root.</span><br><br>micromamba install -c conda-forge cudatoolkit-dev<br>which nvcc<br>nvcc --version<br>echo $CUDA_HOME<br>export CUDA_HOME=$CONDA_PREFIX<br>echo $CUDA_HOME<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">Currently the pip installation does not support the tesselated geometry module <span class="hljs-keyword">in</span> Modulus Sym</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">RuntimeError:</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">     The detected CUDA version (11.7) mismatches the version that was used to compile</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">     PyTorch (12.4). Please make sure to use the same CUDA versions.</span><br><br>micromamba install conda-forge::cython<br>pip install nvidia-modulus.sym --no-build-isolation<br></code></pre></td></tr></table></figure><ul><li>$ cat list.yml</li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">name:</span> <span class="hljs-string">CorrDiff</span><br><span class="hljs-attr">channels:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">conda-forge</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">pytorch</span><br><span class="hljs-attr">dependencies:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">cudatoolkit-dev</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">conda-forge::cython</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">pytorch</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">pytorch-cuda=12.4</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">conda-forge::singularity</span> <span class="hljs-string">&lt;--</span> <span class="hljs-string">apply</span> <span class="hljs-string">singularity</span> <span class="hljs-string">at</span> <span class="hljs-string">the</span> <span class="hljs-string">end??</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">torchaudio</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">torchvision</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">pip:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">Pint==0.19.2</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">gdown==5.2.0</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">ndim==0.1.27</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">nvidia-modulus==0.9.0</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">orthopy==0.9.12</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">quadpy==0.17.21</span><br><br><span class="hljs-attr">prefix:</span> <span class="hljs-string">&quot;/home/wpsze/micromamba/envs/CorrDiff&quot;</span><br></code></pre></td></tr></table></figure><p>conda install nvidia/label/cuda-12.4.0::cuda-toolkit ??</p><h3 id="what-is-modulus-symbolic">What is Modulus Symbolic?</h3><ul><li><a href="https://pypi.org/project/nvidia-modulus.sym/" class="uri">https://pypi.org/project/nvidia-modulus.sym/</a></li></ul><p>Modulus Symbolic (Modulus Sym) repository is part of Modulus SDK and it provides algorithms and utilities to be used with Modulus core, to explicitly physics inform the model training. This includes utilities for explicitly integrating symbolic PDEs, domain sampling and computing PDE-based residuals using various gradient computing schemes.</p><h2 id="singularity">singularity</h2><ul><li><a href="https://catalog.ngc.nvidia.com/orgs/nvidia/teams/modulus/containers/modulus/tags" class="uri">https://catalog.ngc.nvidia.com/orgs/nvidia/teams/modulus/containers/modulus/tags</a></li><li><code>nvcr.io/nvidia/modulus/modulus:24.12</code></li></ul><figure class="highlight console"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs console">singularity build Modulus.sif docker://nvcr.io/nvidia/modulus/modulus:&lt;tag&gt; #24.12<br>singularity run --writable --nv Modulus.sif<br><br>2025/01/23 15:46:48  info unpack layer: sha256:a2d286ac9f2e054214a2097dbe3029a51572ab8e295c3fed336e98a0015bcfc3<br>INFO:    Creating SIF file...<br>INFO:    Build complete: Modulus.sif<br></code></pre></td></tr></table></figure><p>and,</p><figure class="highlight console"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs console"><span class="hljs-meta prompt_">$ </span><span class="language-bash">singularity inspect Modulus.sif</span> <br>org.label-schema.build-arch: amd64<br>org.label-schema.build-date: Thursday_23_January_2025_15:46:48_HKT<br>org.label-schema.schema-version: 1.0<br>org.label-schema.usage.singularity.deffile.bootstrap: docker<br>org.label-schema.usage.singularity.deffile.from: nvcr.io/nvidia/modulus/modulus:24.12<br>org.label-schema.usage.singularity.version: 3.8.6<br></code></pre></td></tr></table></figure><h2 id="running-examples">Running examples</h2><h1 id="references">References</h1><ol type="1"><li><a href="https://yang-song.net/blog/2021/score/">Generative Modeling by Estimating Gradients of the Data Distribution</a></li></ol>]]></content>
    
    
    <categories>
      
      <category>ML</category>
      
    </categories>
    
    
    <tags>
      
      <tag>AI</tag>
      
      <tag>ML</tag>
      
      <tag>pytorch</tag>
      
      <tag>Diffusion</tag>
      
      <tag>UNet</tag>
      
      <tag>NVIDIA</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>CFD | DNS</title>
    <link href="/2024/12/23/CFD-DNS/"/>
    <url>/2024/12/23/CFD-DNS/</url>
    
    <content type="html"><![CDATA[<h1 id="dns">DNS</h1><p><a href="https://en.wikipedia.org/wiki/Direct_numerical_simulation">A direct numerical simulation (DNS)</a> is a simulation in computational fluid dynamics (CFD) in which the Navier–Stokes equations are numerically solved without any turbulence model. This means that the whole range of spatial and temporal scales of the turbulence must be resolved. All the spatial scales of the turbulence must be resolved in the computational mesh, from the smallest dissipative scales (Kolmogorov microscales), up to the integral scale <span class="math inline">\(L\)</span>, associated with the motions containing most of the kinetic energy.</p><p>In fluid dynamics, Kolmogorov microscales are the smallest scales in turbulent flow. At the Kolmogorov scale, viscosity dominates and the turbulence kinetic energy is dissipated into thermal energy.</p><table><thead><tr class="header"><th>Term</th><th>Formula</th></tr></thead><tbody><tr class="odd"><td>Kolmogorov length scale</td><td><span class="math inline">\(\eta = \left( \frac{\nu^3}{\varepsilon} \right)^{1/4}\)</span></td></tr><tr class="even"><td>Kolmogorov time scale</td><td><span class="math inline">\(\tau_\eta = \sqrt{ \frac{\nu}{\varepsilon} }\)</span></td></tr><tr class="odd"><td>Kolmogorov velocity scale</td><td><span class="math inline">\(u_\eta = \left( \nu \varepsilon \right)^{1/4}\)</span></td></tr></tbody></table><p>where</p><ul><li><span class="math inline">\(\varepsilon\)</span> is the average rate of dissipation of turbulence kinetic energy per unit mass, and</li><li><span class="math inline">\(\nu\)</span> is the kinematic viscosity of the fluid.</li></ul><h1 id="references">References</h1><ol type="1"><li><a href="https://mp.weixin.qq.com/s?__biz=MzAxNzkyOTkxNw==&amp;mid=2247489154&amp;idx=1&amp;sn=b770765d2d4b2c810180a9449300e846&amp;chksm=9bdf5550aca8dc46994752a830236071d351ba846cc957932cbd199c0e14100cee6aa4aeb747&amp;scene=21#wechat_redirect">湍流是什么？（2）涡太小，量太大，值难算</a></li><li></li></ol>]]></content>
    
    
    <categories>
      
      <category>CFD</category>
      
    </categories>
    
    
    <tags>
      
      <tag>HPC</tag>
      
      <tag>OpenFOAM</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ML | Genesis</title>
    <link href="/2024/12/20/ML-Genesis-AI/"/>
    <url>/2024/12/20/ML-Genesis-AI/</url>
    
    <content type="html"><![CDATA[<h1 id="what-is-genesis">What is Genesis?</h1><p><img src="https://github.com/Genesis-Embodied-AI/Genesis/blob/main/imgs/teaser.png?raw=true" width="600" /></p><ul><li><a href="https://github.com/Genesis-Embodied-AI/Genesis" class="uri">https://github.com/Genesis-Embodied-AI/Genesis</a></li></ul><p>Genesis is a physics platform designed for general purpose Robotics/Embodied AI/Physical AI applications. It is simultaneously multiple things:</p><ul><li>A universal physics engine re-built from the ground up, capable of simulating a wide range of materials and physical phenomena.</li><li>A lightweight, ultra-fast, pythonic, and user-friendly robotics simulation platform.</li><li>A powerful and fast photo-realistic rendering system.</li><li>A generative data engine that transforms user-prompted natural language description into various modalities of data.</li></ul><h1 id="micromamba">micromamba</h1><h2 id="try-on-cpu-only">Try on CPU only,</h2><figure class="highlight console"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs console">micromamba env create -n genesis<br>micromamba activate genesis<br>micromamba install pytorch torchvision torchaudio cpuonly -c pytorch<br>micromamba install anaconda::pip<br>micromamba install conda-forge::libgl<br>pip3 install git+https://github.com/cnr-isti-vclab/PyMeshLab<br>pip install einops timm pillow<br>pip install genesis-world <br></code></pre></td></tr></table></figure><p>and testing,</p><figure class="highlight console"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs console"><span class="hljs-meta prompt_">&gt;</span><span class="language-bash">&gt;&gt; import genesis as gs</span><br>Failed to import pyrender. Rendering will not work.<br><span class="hljs-meta prompt_">&gt;</span><span class="language-bash">&gt;&gt; gs.init(backend=gs.cpu)</span><br>[Genesis] [14:56:47] [INFO] ╭─────────────────────────────────────────────────────────────────────────────────────╮<br>[Genesis] [14:56:47] [INFO] │┈┉┈┉┈┉┈┉┈┉┈┉┈┉┈┉┈┉┈┉┈┉┈┉┈┉┈┉┈┉┈┉┈┉┈┉┈┉ Genesis ┈┉┈┉┈┉┈┉┈┉┈┉┈┉┈┉┈┉┈┉┈┉┈┉┈┉┈┉┈┉┈┉┈┉┈┉┈┉│<br>[Genesis] [14:56:47] [INFO] ╰─────────────────────────────────────────────────────────────────────────────────────╯<br>[Genesis] [14:56:47] [INFO] Running on [Intel Core Processor (Haswell, no TSX, IBRS)] with backend gs.cpu. Device memory: 62.39 GB.<br>[Genesis] [14:56:48] [INFO] 🚀 Genesis initialized. 🔖 version: 0.2.0, 🌱 seed: None, 📏 precision: &#x27;32&#x27;, 🐛 debug: False, 🎨 theme: &#x27;dark&#x27;.<br><span class="hljs-meta prompt_">&gt;</span><span class="language-bash">&gt;&gt; gs.generate(<span class="hljs-string">&quot;A drop of water falls on the window&quot;</span>)</span><br>Traceback (most recent call last):<br>  File &quot;&lt;stdin&gt;&quot;, line 1, in &lt;module&gt;<br>AttributeError: module &#x27;genesis&#x27; has no attribute &#x27;generate&#x27;<br><span class="hljs-meta prompt_">&gt;</span><span class="language-bash">&gt;&gt;</span> <br></code></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs python">scene = gs.Scene(show_viewer=<span class="hljs-literal">True</span>)<br>NameError: name <span class="hljs-string">&#x27;trimesh&#x27;</span> <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> defined<br></code></pre></td></tr></table></figure><p>export CONDA_INCLUDE_PATH=/home/wpsze/micromamba/envs/genesis/include/ cd ./ext/LuisaRender cmake -S . -B build -D CMAKE_BUILD_TYPE=Release -D PYTHON_VERSIONS=3.9 -D LUISA_COMPUTE_DOWNLOAD_NVCOMP=ON -D LUISA_COMPUTE_ENABLE_GUI=OFF -D ZLIB_INCLUDE_DIR=$CONDA_INCLUDE_PATH cmake --build build -j $(nproc)</p>]]></content>
    
    
    <categories>
      
      <category>ML</category>
      
    </categories>
    
    
    <tags>
      
      <tag>AI</tag>
      
      <tag>ML</tag>
      
      <tag>pytorch</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>CFD | Wall Function</title>
    <link href="/2024/12/18/CFD-Wall-Functions/"/>
    <url>/2024/12/18/CFD-Wall-Functions/</url>
    
    <content type="html"><![CDATA[<h1 id="why-using-wall-functions-approach">Why using wall functions approach?</h1><p>Nowadays turbulence models are heavily used when doing CFD simulations. However, <strong>some mature turbulence models such as $ k-$ are only valid in the area of turbulence fully developed</strong>, and <em>don’t perform well in the area close to the wall</em>. In order to deal with the near wall region, two ways are usually proposed.</p><ul><li><strong>One way is to integrate the turbulence to the wall</strong>. Turbulence models are modified to enable the viscosity-affected region to be resolved with all the mesh down to the wall, including the viscous sublayer. This approach leads to requirement of abundant mesh number, which means a substantial computational resource is needed.</li><li><strong>Another way is to use so-called wall functions</strong>, which can model the near wall region. Wall functions are empirical equations used to satisfy the physics of the flow in the near wall region and the first cell center needs to be placed in the log-law region to ensure the accuracy of the result. Wall functions are used to bridge the inner region between the wall and the turbulence fully developed region, in order to provide near-wall boundary conditions for the momentum and turbulence transport equations, rather than to specify those conditions at the wall itself</li></ul><div class="note note-primary">            <p>Wall functions are an essential tool in CFD for modeling turbulent flows near solid boundaries. By using empirical relationships to approximate the near-wall region, they provide a balance between accuracy and computational efficiency.</p>          </div><p><img src="https://i.imgur.com/vEtRCp6.png" width="600" /></p><h1 id="wall-functions">Wall functions</h1><p>If you are a CFD engineer or scientist, wall functions are your best choice most of the time for your turbulent flow simulations since they can provide reliably accurate results within much less time than fully solving the turbulent boundary layer.</p><p><img src="https://i.imgur.com/xDxSACl.png" width="600" /></p><h2 id="wall-functions-in-openfoam">Wall functions in OpenFOAM</h2><p><strong>Wall functions are boundary conditions</strong> and in OpenFOAM all of them inherit from the abstract class <code>FvPatchField</code>.</p><p><strong>Wall functions directory</strong> in OpenFOAM is located in the path</p><p><code>$FOAM_SRC/TurbulenceModels/turbulenceModels/derivedFvPatchFields/wallFunctions</code></p><p>In wallFunctions directory there are six types of wall function sub-directories</p><ul><li>epsilonWallFunctions</li><li>kqRWallFunctions</li><li>omegaWallFunctions</li><li>fWallFunctions</li><li>nutWallFunctions</li><li>v2WallFunctions</li></ul><h1 id="near-wall-treatment-and-wall-functions">Near-wall treatment and wall functions</h1><ul><li>Wall functions is the approach to use if you are more interested in the mixing in the outer region, rather than the forces on the wall.</li><li>If accurate prediction of forces or heat transfer on the walls are key to your simulation (aerodynamic drag, turbomachinery blade performance, heat transfer) you might not want to use wall functions.</li><li>If you are conducting 2D steady simulations, do not be afraid of using a wall resolving approach.</li><li>On the other hand, if you are conducting 3D steady simulations, everything depends on your computational resources, but it you can afford it, use a wall resolving approach.</li><li>In all the other situations (unsteady cases) and if you do not have any restrictions in the nearwall treatment, use wall functions.</li><li>But again, it depends on your computational resources and time available.</li><li><strong>Wall functions can be used in RANS, DES and LES</strong>.</li><li><strong>If you are doing LES, it is highly recommended to use wall functions</strong>. Otherwise, your meshing requirements will be very similar to DNS</li></ul><p><img src="https://i.imgur.com/sSDoDhW.png" width="600" /> <img src="https://i.imgur.com/lluX5kd.png" width="600" /> <img src="https://i.imgur.com/cOet8K5.png" width="600" /> <img src="https://i.imgur.com/rsr0mMj.png" width="600" /> <img src="https://i.imgur.com/GiL1ZLN.png" width="600" /></p><h1 id="references">References</h1><ol type="1"><li><a href="https://www.wolfdynamics.com/training/turbulence/OF2021/turbulence_2021_OF8.pdf">turbulence_2021_OF8 (<strong>recommend</strong>)</a></li><li><a href="https://cfdmonkey.com/a-brief-introduction-to-wall-functions-in-cfd/">A brief introduction to wall functions in CFD</a></li><li><a href="https://doc.cfd.direct/notes/cfd-general-principles/wall-functions">7.5 Wall functions | The Architects of OpenFOAM</a></li><li><a href="https://www.tfd.chalmers.se/~hani/kurser/OS_CFD_2016/FangqingLiu/openfoamFinal.pdf">A Thorough Description Of How Wall Functions Are Implemented In OpenFOAM | Developed for OpenFOAM-4.0.x (<strong>recommend</strong>)</a></li></ol>]]></content>
    
    
    <categories>
      
      <category>CFD</category>
      
    </categories>
    
    
    <tags>
      
      <tag>HPC</tag>
      
      <tag>OpenFOAM</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>CFD | RANS vs. URANS vs. LES</title>
    <link href="/2024/12/18/CFD-RANS-URANS-LES/"/>
    <url>/2024/12/18/CFD-RANS-URANS-LES/</url>
    
    <content type="html"><![CDATA[<h1 id="characteristics-of-turbulence">Characteristics of turbulence</h1><p>One characteristic of turbulent flows is their <strong>irregularity</strong> (or <strong>randomness</strong>). A fully deterministic approach to characterize turbulent flows is very difficult. Turbulent flows are usually described statistically.</p><ul><li>The <strong>diffusivity</strong> of turbulence cause rapid mixing and increased rates of momentum, heat, and mass transfer. A flow that looks random but does not exhibit the spreading of velocity fluctuations through the surrounding fluid is not turbulent.</li><li>Turbulent flows are <strong>dissipative</strong>. Kinetic energy gets converted into heat due to viscous shear stresses. Turbulent flows die out quickly when no energy is supplied.</li><li>Turbulent flows always occur at <strong>high Reynolds numbers</strong>. They are caused by a complex interaction between the viscous forces and convection.</li><li>Turbulent flows are rotational, that is, they have <strong>non-zero vorticity</strong>. Mechanisms such as the stretching of three-dimensional vortices play a key role in turbulence.</li><li>Turbulence is a <strong>continuum phenomenon</strong>. Even the smallest eddies are significantly larger than the molecular scales.</li><li>Turbulence is a <strong>feature of flow and is not a property of the fluid</strong>. A liquid or a gas at high Reynolds number will exhibit the same dynamics.</li></ul><ol type="1"><li><strong>Turbulent flows can originate at the walls</strong>. When this is the case, we talk about <code>wall bounded turbulence</code>.</li><li><strong>Turbulent flows can also originate in the absence of walls (or far from walls)</strong>. When this is the case, we talk about <code>shear free turbulence</code> (usually <strong>jets, heated walls, atmospheric flows</strong>).</li></ol><h1 id="instantaneous-fluctuations-removing-small-scales">Instantaneous fluctuations – Removing small scales</h1><p>We have seen that turbulent flows are characterize by instantaneous fluctuations of velocity, pressure, and all transported quantities.</p><ul><li>In most engineering applications is not of interest resolving the instantaneous fluctuations.</li><li>To avoid the need to resolve the instantaneous fluctuations (or small scales), two methods can be used:<ul><li><strong>Reynolds averaging</strong>.</li><li><strong>Filtering</strong>.</li></ul></li><li>If you want to resolve all scales, you conduct DNS simulations, which are very computationally intensive.</li><li>Two methods can be used to eliminate the need to resolve the small scales:<ul><li><strong>Reynolds averaging (RANS/URANS)</strong>:<ul><li>All turbulence scales are modeled.</li><li>Can be 2D and 3D.</li><li>Can be steady or unsteady.</li></ul></li><li><strong>Filtering (LES/DES)</strong>:<ul><li>Resolves large eddies.</li><li>Models small eddies.</li><li>Intrinsically 3D and unsteady.</li></ul></li></ul></li><li>Both methods introduce additional terms in the governing equations that must be modeled (these terms are related to the instantaneous fluctuations).</li><li>The final goal of turbulence modeling is to find the closure equations to model these additional terms (usually a stress tensor).</li></ul><p><img src="https://i.imgur.com/yMpYzXN.png" width="600" /></p><p><img src="https://i.imgur.com/SrU2JMy.png" width="600" /></p><h1 id="reynolds-averaging-rans">Reynolds Averaging (RANS)</h1><div class="note note-primary">            <p><strong>Averaging the quantities (time average, spatial average or ensemble average)</strong></p>          </div><ul><li>Reynolds averaging simple consists in:<ul><li>Splitting the instantaneous value of the primitive variables into a mean component and a fluctuating component (Reynolds decomposition).</li><li><strong>Averaging the quantities (time average, spatial average or ensemble average)</strong>.</li><li>Applying a few averaging rules to simplify the equations</li><li>When we use Reynolds averaging, we are taking a statistical approach to turbulence modeling.</li></ul></li></ul><ol type="1"><li><strong>RANS (Reynolds-Averaged Navier-Stokes)</strong>: Time averaging</li><li><strong>URANS (Unsteady Reynolds-Averaged Navier-Stokes)</strong>: Ensemble averaging</li></ol><p><img src="https://i.imgur.com/hIMgzph.png" width="600" /></p><h2 id="time-averaging">Time averaging</h2><div class="note note-primary">            <p><strong>Time averaging is appropriate for stationary turbulence or slowly varying turbulent flows.</strong></p>          </div><p><span class="math display">\[\bar{\phi}(\mathbf{x})=\lim _{T \rightarrow \infty} \frac{1}{T} \int_t^{t+T} \phi(\mathbf{x}, t) d t\]</span></p><h2 id="spatial-averaging">Spatial averaging</h2><div class="note note-primary">            <p><strong>Spatial averaging is appropriate for homogenous turbulence.</strong></p>          </div><p><span class="math display">\[\bar{\phi}(t)=\lim _{V \rightarrow \infty} \frac{1}{V} \int_V \phi(\mathrm{x}, t) d V\]</span></p><h2 id="ensemble-averaging">Ensemble averaging</h2><div class="note note-primary">            <p><strong>Ensemble averaging is appropriate for unsteady turbulence.</strong></p>          </div><ul><li>In ensemble averaging, <strong>the number or realizations (or experiments) must be large enough</strong> to eliminate the effects of fluctuations. This type of averaging can be used with steady or unsteady flows.</li><li>If you can afford it, ensemble averaging is recommended. Have in mind that CFD is deterministic, <strong>so you should start each realization using different initial conditions and boundary conditions fluctuations to obtain different outcomes</strong>.</li></ul><p><span class="math display">\[\bar{\phi}(\mathrm{x}, t)=\lim _{ N \rightarrow \infty} \frac{1}{N} \sum_{i=1}^N \phi(\mathrm{x}, t)\]</span></p><h2 id="averaging-rules">Averaging rules</h2><p><img src="https://i.imgur.com/l3vVmDc.png" width="600" /></p><h1 id="question-urans">Question: URANS</h1><ul><li>URANS we basically insert the time derivative and ensemble-average the flow for a certain time step (see the picture, which is taken from the book of Ferzinger, 2020; left side is supposed to be RANS and right side is supposed to be URANS).</li><li>URANS is a Reynolds-Averaged equation. When you do this reynolds-averaging you assume that you average long enough so that you resolve the mean. That is, you assume you CAN actually find the average. If the flow time-scales and turbulent time-scales are similar and you don't average long enough the turbulent contribution will not be zero and you therefore get a mean-flow that is contaminated by turbulence statistics (which is not the true mean flow). This to me in a user-error and not a problem with URANS. If you don't sample long enough to get the correct statistics then you simply get the wrong statistics.<a href="https://www.cfd-online.com/Forums/main/6519-rans-urans.html">link</a></li><li>I think the definition of URANS is contentious for CFD theorists and therefore so is its applicability. In general, URANS isn't really defined very well. I've seen some try to define it in a similar way to LES in terms of how the energy spectrum is captured/modelled. I think this discussion really becomes important (useful) when developing hybrid resolving/modelling method (DES). Moreover, most if not all the commercial codes do not explain the foundation of how their URANS approuch is implimented. I'm sure it's usually just ensuring there's a time derivative in the transport equations. But agree with other posts here, for all intents and purposes, transient RANS ~ URANS. <a href="https://www.reddit.com/r/CFD/comments/k40bit/difference_between_unsteady_rans_urans_and/">link</a></li><li>对于 <span class="math inline">\(\int_t^{t+\Delta t}\)</span> 的 <span class="math inline">\(\Delta t\)</span>，从理论上 URANS 这个<span class="math inline">\(\Delta t\)</span>是任意的，如果不考虑附加的湍流封闭模型如ke之类，<span class="math inline">\(\Delta t\)</span>足够的小，就变成了LES (<strong>LES can be applied spatial/temporal/both filtering</strong>)，<span class="math inline">\(\Delta t\)</span>足够的大，就变成了RANS。然而<span class="math inline">\(\Delta t\)</span> 并不需要显性的给定。所以对URANS取决定性的还是 <span class="math inline">\(\mu_t\)</span>. <a href="https://cfd-china.com/topic/6517/rans-urans-des-les-vles/13">link</a><ul><li>类似的，URANS与LES从传输方程上区别也非常少，区别仅仅在与 <span class="math inline">\(\nu\)</span> 的模化，如果是LES的 <span class="math inline">\(\nu\)</span> ，那就是LES，如果是URANS的 <span class="math inline">\(\nu\)</span> ，那就是URANS。湍流理论会从底层特别深的地方，推导出来 <span class="math inline">\(\nu\)</span> 的不同，但是代码就是代码，不知道底层啥样的，到了代码这一层，只不过就是 <span class="math inline">\(\nu\)</span> 的大小不 同。</li></ul></li><li><strong>In below figure (right), let's define <span class="math inline">\(T_1 &lt;&lt; T &lt;&lt; T_2\)</span> for URANS.</strong></li><li><strong>Question: What turbulence model does URANS use?</strong> 1) Same as RANS?</li></ul><p><img src="https://i.imgur.com/yMpYzXN.png" width="600" /></p><ul><li><a href="https://mp.weixin.qq.com/s/c1nUiTd3UjO54ERO6RCKUw">link</a>: 雷诺时均法对非稳态NS方程做平均以后，多出了反应湍流脉动的雷诺应力项，需要通过模型封闭。常用的封闭方法是基于Boussineq假设（又即，涡粘假设），该假设将雷诺应力与应变率的关系视为正比，其比例系数即为湍流粘性系数（又即，涡粘系数）。之后，通过对湍流粘性系数进行建模对NS方程进行封闭。某一变量的雷诺平均操作如下： <span class="math inline">\(\int_t^{t+\Delta t}\)</span>, <strong>其中时间间隔比较重要，物理上要求这个时间间隔要远大于湍流的随机脉动周期，但又要远小于时均量的变化周期</strong> —— <strong>这是一个令人直观上感觉很奇怪的要求</strong>。在时均值几乎不随时间变化的稳态或准稳态湍流中，时间间隔趋近于无穷大；但在时均值随时间变化的非定常湍流中，时间间隔的取值非常重要。如果时间间隔取值太小，则平均量无法代表该段时间内物理量的整体均值；而如果时间间隔取值过大，则求解结果无法反应流动的变化细节，这是制约URANS计算结果精度的原因之一。LES采用非稳态NS方程直接对大涡进行模拟，而采用亚格子模型来对小涡进行建模。亚格子模型建模的思路却与RANS中的Boussineq假设相似，即将湍流脉动所造成的影响用湍流粘性系数来描述，之后通过模型封闭湍流粘性系数进而封闭整个控制方程。<ul><li>所不同的是，<strong>LES方法只是对亚格子尺度上的湍流脉动进行建模</strong>，</li><li>而<strong>RANS则是对整场尺度的湍流脉动进行建模</strong>，</li><li>而<strong>这种整场的模化必然也会导致URANS计算结果精度存在一定偏差</strong>。</li></ul></li><li><a href="https://blog.sciencenet.cn/home.php?mod=space&amp;uid=895670&amp;do=blog&amp;id=686615">link</a> <strong>雷诺平均，经常被误解为时间平均，其实应该是样本平均</strong>。只是在不同的条件下，样本平均可以用这样那样的平均方式代替。从RANS和URANS的平均方式与求解结果的验证方法上来看：<ul><li>1.<strong>若流动“时间统计”均匀，也即T趋于无穷大时</strong>，<strong>T上的时间平均存在，且时均值与时间无关</strong>。<strong>对应的是RANS</strong>，因此可以用实验数据做样本平均（或很长时间的时间平均）跟RANS结果对比。可以肯定的是：RANS计算出的结果是流场变量的系统平均。</li><li>2.<strong>若流场存在缓变周期T2（imposed unsteadiness），湍流脉动周期为T1，且T1，T2满足这样的条件：存在T对于T2来说无穷小，对于T1来说无穷大，那么可以在T上作时间平均得到URANS</strong>。对于实验数据与仿真数据的对比，当比较均值时，可以用实验数据在T上作平均跟URANS结果对比；若要对比脉动值，则需要把URANS捕捉到的脉动（URANS结果减去URANS结果的时间平均值（该值应该与时间无关））跟湍流模型模拟的脉动值加起来跟实验脉动数据（实验值减去它的二次时间平均）对比。</li><li>3.若不满足上面那条，但是流动属周期流动的，则可以通过<code>相平均</code>得到URANS，此时可用实验数据做相平均与URANS的结果对比，且可以通过判断URANS结果的时间平均是否与时间无关来确定此种流动是否合适用URANS。对于实验数据与仿真数据的对比，当比较均值时，可以用实验数据做相平均作跟URANS结果直接对比；若要对比脉动值，则需要把URANS捕捉到的脉动（URANS结果减去URANS结果的时间平均值（该值也应该与时间无关））跟湍流模型模拟的脉动加起来跟实验脉动数据（实验值减去其相平均值的时均值）对比。</li></ul></li><li><strong>若上面的都不满足</strong>（可以用URANS的结果做时间平均后是否随时间变化来确定），就只能老老实实的用系统平均，或者LES或DNS了。</li></ul><h2 id="question-what-is-phase-averaging">Question: What is phase averaging?</h2><h1 id="large-eddy-simulation-les">Large eddy simulation (LES)</h1><p>Large eddy simulation (LES) is a mathematical model for turbulence used in computational fluid dynamics. It was initially proposed in <strong>1963 by Joseph Smagorinsky</strong> to simulate atmospheric air currents, and <strong>first explored by Deardorff (1970)</strong>.</p><p>An LES filter can be applied to a spatial and temporal field $ (,t) $ and <strong>perform a spatial filtering operation</strong>, <strong>a temporal filtering operation</strong>, or <strong>both</strong>. The filtered field, denoted with a bar, is defined as</p><p><span class="math display">\[\overline{\phi(\boldsymbol{x},t)} = \displaystyle{\int_{-\infty}^{\infty}} \int_{-\infty}^{\infty} \phi(\boldsymbol{r},\tau) G(\boldsymbol{x}-\boldsymbol{r},t - \tau) d\tau d \boldsymbol{r}\]</span></p><p><span class="math display">\[\overline{\phi} = G \star \phi\]</span></p><p><span class="math display">\[\phi = \bar{\phi} + \phi^{\prime}\]</span></p><h2 id="smagorinskylilly-model">Smagorinsky–Lilly model</h2><p>The first SGS model developed was the Smagorinsky–Lilly SGS model, which was developed by <strong>Joseph Smagorinsky</strong> and used in the <strong>first LES simulation by Deardorff</strong>. It models the eddy viscosity as:</p><p><span class="math display">\[\nu_\mathrm{t} = C \Delta^2\sqrt{2\bar{S}_{ij}\bar{S}_{ij}} = C \Delta^2 \left| \bar{S} \right|\]</span></p><p>where <span class="math inline">\(\Delta\)</span> is the <strong>grid size</strong> and <span class="math inline">\(C\)</span> is a constant.</p><p>This method assumes that the energy production and dissipation of the small scales are in equilibrium.</p><h1 id="ex-1d-burgers-equation">Ex: 1D Burgers equation</h1><p>Consider the 1D Burgers equation in terms of the velocity field <span class="math inline">\(u(x, t)\)</span> <span class="math display">\[\begin{equation*}\frac{\partial u}{\partial t}+\frac{\partial u^{2} / 2}{\partial x}=\frac{\partial}{\partial x}\left(v \frac{\partial u}{\partial x}\right) \tag{1}\end{equation*}\]</span></p><h2 id="les">LES</h2><p>In the continuous <strong>LES approach the scale separation is obtained via low-pass filtering</strong>. The spatial filtering operation (no time-filtering is considered here) can be expressed as the convolution product between the unfiltered point-wise velocity field and some suitable filter function <span class="math inline">\(G\)</span>, that is <span class="math display">\[\begin{equation*}\bar{u}(x, t ; \Delta)=\int_{R} G\left(x-x^{\prime} ; \Delta\right) u\left(x^{\prime}, t\right) d x^{\prime} \tag{2}\end{equation*}\]</span> <span class="math inline">\(\Delta\)</span> being the characteristic filter width. The LES equation is obtained by applying (2) to each term of (1) <span class="math display">\[\begin{equation*}\frac{\partial \bar{u}}{\partial t}+\frac{\partial \bar{u}^{2} / 2}{\partial x}=\frac{\partial}{\partial x}\left(v \frac{\partial \bar{u}}{\partial x}\right)+\underbrace{\frac{\partial\left(\bar{u}^{2}-u^{2}\right) / 2}{\partial x}}_{\frac{\partial f(\bar{u}, u)}{\partial x}} \tag{3}\end{equation*}\]</span></p><p>Commutation between filtering and derivative being applied</p><h2 id="urans">URANS</h2><p>As a counterpart, in the continuous <strong>URANS approach a statistical averaging</strong> is adopted. <span class="math display">\[\begin{equation*}\langle u\rangle(x, t)=\lim _{N \rightarrow \infty} \frac{1}{N} \sum_{k=1}^{N} u_{k}(x, t) \tag{4}\end{equation*}\]</span></p><p><span class="math inline">\(N\)</span> being the <strong>number of sample of the ensemble averaging</strong>. The URANS equation is obtained by applying (4) to each term of (1)</p><p><span class="math display">\[\begin{equation*}\frac{\partial\langle u\rangle}{\partial t}+\frac{\partial\langle u\rangle^{2} / 2}{\partial x}=\frac{\partial}{\partial x}\left(v \frac{\partial\langle u\rangle}{\partial x}\right)+\underbrace{\frac{\partial\left(\langle u\rangle^{2}-u^{2}\right) / 2}{\partial x}}_{\frac{\partial g(\langle u\rangle, u)}{\partial x}} \tag{5}\end{equation*}\]</span></p><h2 id="close-equations">Close equations</h2><p>In order to close Eqs.(3) and (5), suitable models are used, that is</p><p><span class="math display">\[f(\bar{u}, u) \cong f_{\text {LES }}(\bar{u}), \qquad g(\langle u\rangle, u) \cong g_{\text {URANS }}(\langle u\rangle)\]</span></p><h2 id="discretization">Discretization</h2><p>If we consider now the practical solution, a discretization of the derivative is introduced. Assume the same discretization is adopted for the LES and URANS equations, so that we can write a unique equation <span class="math display">\[\frac{\delta u_{j}}{\delta t}+\frac{\delta u_{j}^{2} / 2}{\delta x}=\frac{\delta}{\delta x}\left(v \frac{\delta u_{j}}{\delta x}\right)+\frac{\delta}{\delta x}\left\{\begin{array}{c}f_{L E S}\left(u_{j}\right)  \tag{6}\\g_{\text {URANS }}\left(u_{j}\right)\end{array}\right.\]</span> that characterizes LES or URANS depending on the closure model.</p><div class="note note-primary">            <p>One can deduce that the discrete equation (6) never implied a real application of a spatial filtering or an ensemble averaging. <strong>The only assessment is the spatial filtering implicitly induced by the discretization, a fact that is congruent to the LES assumption but not to the URANS one</strong>.</p>          </div><p>The Eq.(6) must be well posed by the set of initial and boundary conditions. This point adds a distinction as they should be different for LES and URANS.</p><h1 id="references">References</h1><ol type="1"><li><a href="http://www.dicat.unige.it/guerrero/teaching.html">Joel Guerrero's homepage</a><ol type="1"><li><a href="http://www.dicat.unige.it/guerrero/turbulence2020/slides/2tur_preliminaries.pdf">2tur_preliminaries (<strong>recommend</strong>)</a></li><li><a href="http://www.dicat.unige.it/guerrero/turbulence2020/slides/3turbulence_Scales_law_of_the_wall_wall_function.pdf">3turbulence_Scales_law_of_the_wall_wall_function (<strong>recommend</strong>)</a></li><li><a href="http://www.dicat.unige.it/guerrero/turbulence2020/slides/5governing_equations.pdf">5governing_equations (<strong>recommend</strong>)</a></li></ol></li><li><a href="https://www.wolfdynamics.com/training/turbulence/OF2021/turbulence_2021_OF8.pdf">turbulence_2021_OF8 (<strong>recommend</strong>)</a></li><li><a href="https://www.researchgate.net/profile/Filippo-Maria-Denaro/post/URANS-what-is-the-meaning-for-statistically-steady-flows-and-what-compared-to-LES/attachment/5b407d1e4cde265cb64d663d/AS%3A645677793165312%401530952990388/download/URANS+vs.+LES.pdf">URANS vs. LES</a></li><li><a href="https://marinecfd.xyz/post/rans-turbulence-modeling/">雷诺平均 Navier-Stokes 方程</a></li></ol>]]></content>
    
    
    <categories>
      
      <category>CFD</category>
      
    </categories>
    
    
    <tags>
      
      <tag>HPC</tag>
      
      <tag>OpenFOAM</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ML | Diffusion Models (Denoising diffusion probabilistic models)</title>
    <link href="/2024/12/15/ML-Diffusion-Models/"/>
    <url>/2024/12/15/ML-Diffusion-Models/</url>
    
    <content type="html"><![CDATA[<h1 id="diffusion-models">Diffusion Models</h1><p>Diffusion Models are <strong>generative models</strong>, meaning that they are used to generate data similar to the data on which they are trained. Fundamentally, <strong>Diffusion Models work by destroying training data through the successive addition of Gaussian noise, and then learning to recover the data by reversing this noising process</strong>. After training, we can use the Diffusion Model to generate data by simply passing randomly sampled noise through the learned denoising process.</p><p>More specifically, a Diffusion Model is a <strong>latent variable model</strong> which maps to the latent space <strong>using a fixed Markov chain</strong>. This chain gradually adds noise to the data in order to obtain the approximate posterior <span class="math inline">\(q(x_1:T|x_0)\)</span>, where <span class="math inline">\(x_1, ..., x_T\)</span> are the latent variables with the same dimensionality as <span class="math inline">\(x_0\)</span>. In the figure below, we see such a Markov chain manifested for image data.</p><p>Ultimately, the image is asymptotically transformed to pure Gaussian noise. The goal of training a diffusion model is to learn the <strong>reverse process</strong>. By traversing backwards along this chain, we can generate new data.</p><ul><li><a href="https://proceedings.neurips.cc/paper/2020/file/4c5bcfec8584af0d967f1ab10179ca4b-Paper.pdf">Ho, Jonathan, Ajay Jain, and Pieter Abbeel. "Denoising diffusion probabilistic models." Advances in neural information processing systems 33 (2020): 6840-6851.</a></li></ul><p><img src="https://i.imgur.com/BOHjnCW.png" /> <img src="https://i.imgur.com/ArrrokC.png" /></p><h2 id="training">Training</h2><ul><li>Loss function: <strong>Kullback-Leibler (KL) Divergences</strong>. The KL Divergence is an asymmetric statistical distance measure of how much one probability distribution P differs from a reference distribution Q.</li></ul><p><img src="https://i.imgur.com/AGYXOQO.png" /> <img src="https://i.imgur.com/EslrwLZ.png" /></p><p>在擴散模型中，<strong>反向過程</strong>是學習數據分布的核心機制。以下是對這一過程的詳細闡述：</p><h3 id="反向過程的定義">1. <strong>反向過程的定義</strong></h3><p>反向過程是指從一個完全噪聲化的樣本逐步去噪，以恢復出原始數據的過程。這個過程通常是在採樣階段進行，目標是從最終的噪聲數據 <span class="math inline">\(x_T\)</span> 開始，通過一系列逆向步驟，得到無噪聲的原始數據 <span class="math inline">\(x_0\)</span>。</p><h3 id="前向過程與反向過程">2. <strong>前向過程與反向過程</strong></h3><ul><li><p><strong>前向過程</strong>是將數據逐步添加噪聲，形成一系列帶噪聲的樣本。數學上，這個過程可以表示為： <span class="math display">\[q(x_t | x_{t-1}) = \mathcal{N}(x_t; \sqrt{1 - \beta_t} x_{t-1}, \beta_t I)\]</span> 其中 <span class="math inline">\(\beta_t\)</span> 是時間步 <span class="math inline">\(t\)</span> 的噪聲參數。</p></li><li><p><strong>反向過程</strong>則是從噪聲逐步去除，以恢復原始數據。通常假設為條件高斯分布： <span class="math display">\[p_\theta(x_{t-1} | x_t) = \mathcal{N}(x_{t-1}; \mu_\theta(x_t, t), \Sigma_\theta(x_t, t))\]</span> <div class="note note-primary">            <p>這裡 <span class="math inline">\(\mu_\theta\)</span> 和 <span class="math inline">\(\Sigma_\theta\)</span> 是由神經網絡學習得到的 <strong>均值</strong> 和 <strong>協方差</strong>。</p>          </div></p></li></ul><h3 id="學習反向過程">3. <strong>學習反向過程</strong></h3><p>為了學習反向過程，模型需要通過神經網絡近似條件概率分布 <span class="math inline">\(p_\theta(x_{t-1} | x_t)\)</span>。具體步驟如下：</p><ul><li><p><strong>初始化</strong>：從標準正態分布 <span class="math inline">\(N(0, I)\)</span> 中隨機抽取初始樣本 <span class="math inline">\(x_T\)</span>。</p></li><li><strong>逐步去噪</strong>：從時間步 <span class="math inline">\(T\)</span> 開始，逐步向前推進到時間步 <span class="math inline">\(1\)</span>，在每個時間步 <span class="math inline">\(t\)</span> 中進行以下操作：<ul><li>抽取噪聲 <span class="math inline">\(z\)</span>，當 <span class="math inline">\(t &gt; 1\)</span> 時，從標準正態分布中抽取。</li><li>使用 <strong>參數化的均值和協方差進行去噪</strong>： <span class="math display">\[x_{t-1} = \frac{1}{\sqrt{\alpha_t}}(x_t - \frac{1 - \alpha_t}{\sqrt{1 - \bar{\alpha}_t}} \epsilon_\theta(x_t, t)) + \sigma_t z\]</span> 其中 <span class="math inline">\(\alpha_t\)</span> 和 <span class="math inline">\(\bar{\alpha}_t\)</span> 是預定義的噪聲參數，<span class="math inline">\(\epsilon_\theta(x_t, t)\)</span> 是 <strong>神經網絡預測的噪聲</strong>，<span class="math inline">\(\sigma_t\)</span> 是調整噪聲幅度的參數。</li></ul></li></ul><h3 id="目標函數">4. <strong>目標函數</strong></h3><p>為了優化神經網絡，模型通過最小化負對數似然來學習反向過程。可以使用變分下界（ELBO）來表示損失函數： <span class="math display">\[L = L_0 + L_1 + ... + L_T\]</span> 其中每項損失 <span class="math inline">\(L_t\)</span> 實際上是兩個高斯分布之間的 <strong>KL散度</strong> ，可以明確地寫為相對於均值的L2損失。</p><h3 id="總結">5. <strong>總結</strong></h3><p>通過上述步驟，擴散模型能夠有效地學習到數據的複雜分布。<strong>在訓練完成後，可以從標準正態分布中隨機抽取一個噪聲圖像，然後利用學到的反向過程將其轉化為與訓練數據相似的新圖像</strong>。這種方法在圖像生成、音頻合成等領域展示了強大的應用潛力。</p><h1 id="details">Details</h1><div class="group-image-container"><div class="group-image-row"><div class="group-image-wrap"><img src="https://i.imgur.com/JMP2TcX.png" /></div></div><div class="group-image-row"></div><div class="group-image-row"></div><div class="group-image-row"></div><div class="group-image-row"></div><div class="group-image-row"></div></div><h2 id="重參數化技巧-reparameterization-trick">重參數化技巧 (Reparameterization trick)</h2><p>重參數化技巧在許多工作 (VAE) 中有所引用。如果我們要從某個分佈中隨機取樣 (高斯分佈) 一個樣本，這個過程是無法反傳梯度的。而這個經由高斯雜訊取樣得到 <span class="math inline">\(x_t\)</span> 的過程在diffusion中到處都是，因此我們需要透過重參數技巧來使得他可微。最通常的做法是吧隨機性透過一個獨立的隨機變數 <span class="math inline">\((\epsilon)\)</span> 引導過去。舉個例子，如果要從高斯分佈 <span class="math inline">\(z\sim\mathcal{N}(z;\mu_\theta,\sigma_\theta^2\mathbf{I})\)</span> 取樣一個 <span class="math inline">\(z\)</span>,我們可以寫成：</p><p><span class="math display">\[z=\mu_\theta+\sigma_\theta\odot\epsilon,\epsilon\sim\mathcal{N}(0,\mathbf{I})\]</span></p><p>上式的z依舊是有隨機性的，且滿足平均值為 <span class="math inline">\(\mu_\theta\)</span> 變異數為 <span class="math inline">\(\sigma_\theta^2\)</span> 的高斯分佈。這裡的 <span class="math inline">\(\mu_\theta\)</span> ,<span class="math inline">\(\sigma_\theta^2\)</span>可以是由參數 <span class="math inline">\(\theta\)</span> 的神經網路推論得到的。整個「採樣」過程依舊梯度可導，隨機性被轉嫁到了<span class="math inline">\(\epsilon\)</span>上。</p><h2 id="forward-diffusion-process">Forward Diffusion Process</h2><h3 id="任意時刻的x_t可以由x_0和beta表示">任意時刻的<span class="math inline">\(x_t\)</span>可以由<span class="math inline">\(x_0\)</span>和<span class="math inline">\(\beta\)</span>表示</h3><figure><img src="https://i.imgur.com/JtK0R8X.png" alt="Forward Diffusion Process - add noise to the image" width="600" /><figcaption>Forward Diffusion Process - add noise to the image</figcaption></figure><p>透過這個 Reparameterization trick，我們可以將取樣影像 <span class="math inline">\(x_t\)</span> 表示如下：</p><p><span class="math display">\[\begin{align}z &amp;= \mu + \sigma \epsilon \qquad ;\epsilon \sim N(0,I)\\x_t &amp;= \sqrt{1-\beta_t} x_{t-1} + \sqrt{\beta_t} \epsilon_{t-1} \\&amp;= \sqrt{a_t} x_{t-1} + \sqrt{1 - a_t} \epsilon_{t-1} \\\end{align}\]</span></p><p>能夠透過 <span class="math inline">\(x_0\)</span> 和 <span class="math inline">\(\beta\)</span> 快速得到 <span class="math inline">\(x_t\)</span> 對後續 diffusion model 的推論和推導有巨大作用。</p><div class="group-image-container"><div class="group-image-row"><div class="group-image-wrap"><img src="https://i.imgur.com/dYILzWB.png" /></div><div class="group-image-wrap"><img src="https://i.imgur.com/lpFiGtT.png" /></div></div><div class="group-image-row"></div><div class="group-image-row"></div><div class="group-image-row"></div><div class="group-image-row"></div><div class="group-image-row"></div></div><div class="note note-primary">            <p>現在我們可以使用這個公式在任何時間步直接取樣 <span class="math inline">\(x_t\)</span>，這使得 Forward Diffusion Process 更快, <span class="math display">\[x_t = \sqrt{1-\bar{\alpha}_t} x_{0} + \sqrt{1-\bar{\alpha}_t} \epsilon\]</span></p>          </div><h2 id="reverse-diffusion-process">Reverse Diffusion Process</h2><p><img src="https://i.imgur.com/2g9HXta.png" width="600" /></p><div class="note note-primary">            <p>Unlike the forward process, we cannot use <span class="math inline">\(q(x_{t-1}|x_t)\)</span> to reverse the noise since it is <strong>intractable</strong> (<strong>uncomputable</strong>).</p>          </div><ul><li>Thus we need to train a neural network <span class="math inline">\(p_\theta(x_{t-1}|x_t)\)</span> to approximate <span class="math inline">\(q(x_{t-1}|x_t)\)</span> .</li><li>The approximation <span class="math inline">\(p_\theta(x_{t-1}|x_t)\)</span> follows <strong>a normal distribution</strong> and <strong>its mean and variance</strong> are set as follows</li></ul><p><span class="math display">\[\begin{align}\mu_\theta &amp;:= \tilde{\mu}_t(x_t, x_0)\\\Sigma_\theta &amp;:= \tilde{\beta}_t \mathbf{I}\end{align}\]</span></p><p><strong>Loss Function</strong>: We can define our loss as a <strong>Negative Log-Likelihood</strong>:</p><p><img src="https://i.imgur.com/i69Cxwx.png" width="400" /></p><p><strong>This setup is very similar to the one in VAE</strong>. instead of optimizing the intractable loss function itself, we can optimize the <strong>Variational Lower Bound</strong>.</p><p><img src="https://i.imgur.com/GAvchZh.png" width="700" /></p><ol type="1"><li><span class="math inline">\(L_T\)</span> Constant term</li><li><span class="math inline">\(L_{t-1}\)</span> Stepwise denoising term<ol type="1"><li><img src="https://i.imgur.com/672L1Hw.png" width="600" /></li><li>To approximate the target denoising step <span class="math inline">\(q\)</span>, we only need to approximate its mean using a neural network. So <strong>we set the approximated mean</strong> <span class="math inline">\(\mu_\theta\)</span> to be in the <strong>same form as the target mean</strong> <span class="math inline">\(\tilde{\mu}_t\)</span> (with <strong>a learnable neural network</strong> <span class="math inline">\(\epsilon_\theta\)</span>)</li><li>Experimentally, better results can be achieved by ignoring the weighting term and simply comparing the target and predicted noises with MSE.</li><li>So, it turns out that to approximate the desired denoising step <span class="math inline">\(q\)</span>, we just need to approximate the noise <span class="math inline">\(\epsilon_t\)</span> using a neural network <span class="math inline">\(\epsilon_\theta\)</span>.</li></ol></li><li><span class="math inline">\(L0\)</span> Reconstruction term<ol type="1"><li>This is the reconstruction loss of the last denoising step and it can be ignored during training for the following reasons: It can be approximated using the same neural network in <span class="math inline">\(L_{t-1}\)</span>. Ignoring it makes the sample quality better and makes it simpler to implement.</li></ol></li></ol><h3 id="simplified-loss-todo">Simplified Loss (ToDo)</h3><p>So the final simplified training objective (<a href="https://arxiv.org/abs/2006.11239">Ho et al. (2020)</a> empirically found that training the diffusion model works better with a simplified objective that ignores the weighting term) is as follows:</p><p><img src="https://i.imgur.com/sMyAqVN.png" width="400" /></p><h2 id="with-unet-model">With UNet model ***</h2><ul><li>A random time step t will be selected for each training sample (image).</li><li>Apply the Gaussian noise (corresponding to t) to each image.</li><li>Convert the time steps to embeddings (vectors).</li></ul><p><img src="https://i.imgur.com/PmD5Azy.png" width="600" /></p><h2 id="training-1">Training</h2><p><img src="https://i.imgur.com/bnNS9z4.png" width="400" /></p><h3 id="training-step">training step</h3><p>The official training algorithm is as above, and the following diagram is an illustration of how a training step works</p><p><img src="https://i.imgur.com/LgIOlQO.png" width="600" /></p><h2 id="reverse-diffusion-sampling">Reverse Diffusion (Sampling)</h2><p><img src="https://i.imgur.com/F2EuVPU.png" width="400" /></p><h3 id="generating-step">generating step</h3><p>We can generate images from noises using the above algorithm. The following diagram is an illustration of it. Note that in the last step, we simply output the learned mean <span class="math inline">\(\mu_\theta(x_{t=1}, t=1)\)</span> without adding the extra noise to it.</p><p><img src="https://i.imgur.com/wQIehey.png" width="600" /></p><h2 id="summary">Summary</h2><p>Summary Here are some main takeaways from this article:</p><ul><li>The Diffusion model is divided into two parts: forward diffusion and reverse diffusion.</li><li>The forward diffusion can be done using the closed-form formula.</li><li>The backward diffusion can be done using a trained neural network.</li><li>To approximate the desired denoising step q, we just need to approximate the noise <span class="math inline">\(\epsilon_t\)</span> using a neural network <span class="math inline">\(\epsilon_\theta\)</span>.</li><li>Training on the simplified loss function yields better sample quality.</li></ul><h1 id="literature-review">Literature review</h1><ul><li>An example of training a diffusion model for modeling a 2D swiss roll data. (Image source: <a href="https://arxiv.org/abs/1503.03585">Sohl-Dickstein et al., 2015</a>)<ul><li><img src="https://i.imgur.com/oVtF9Tt.png" width="500" /></li></ul></li></ul><h1 id="questions">Questions</h1><ul><li><a href="https://www.zhihu.com/question/613852600/answer/3273556154">diffusion预测噪声为什么用UNET模型呢？ - 章彦博的回答 - 知乎</a><ul><li>其中的 <span class="math inline">\(\epsilon_\theta\)</span> 就直接是你要訓練的模型了，它是用來預測噪音 <span class="math inline">\(\epsilon\)</span> 的。但我們知道，<strong>噪音都是高頻的</strong>，不存在低維度的特徵，神經網路很難學習。同時， <span class="math inline">\(x_0\)</span> 通常是光滑的，神經網路會比較容易學到。</li><li>不使用UNet的話，這裡就直接用一個兩層全連接網路來預測雜訊。看起來是個很簡單的任務，但效果非常差。跑了100個epoch，想著就算沒有收斂，怎麼樣也能學個大概。結果沒想到，不光沒學個大概，連數值範圍都爆炸了</li><li>然後我把epoch設到了10000，數值範圍終於接近了，但效果還是很差。我猜想這就是噪音惹的禍。神經網路努力地去學習高頻的噪聲，從而忽略了低頻的範圍訊息</li><li><span class="math inline">\(\epsilon = \dfrac{x_t - \sqrt{1-\bar{\alpha}_t} x_{0}}{\sqrt{1-\bar{\alpha}_t}}\)</span></li><li><span class="math inline">\(\text{UNet}(x) = g(x + f(x))\)</span>, 它恰好和上式有類似的結構.</li><li>試驗的: <span class="math inline">\(\epsilon_\theta(x_t, t) = x_t + f(x_t, t)\)</span>, 改了之後，效果立刻就好起來了。而且就算不收斂，數值範圍也不會爆炸</li><li>如果認為神經網路能擬合一切的話，確實本質上是一樣的。但你加了U-Net / ResNet的結構之後，網路會更容易發現較好的解。而且我的實驗表明，如果沒有這樣的結構，網路在收斂之前的行為非常差。我猜是因為<strong>epsilon是高頻</strong>的，而神經網路很難從這樣的數據中學習。</li><li>至於一開始為什麼會使用UNet，因為 Noise 本身其實是一個很特殊的訊息，並不適用於傳統的神經網路來學習。 UNet因為獨特的 Skip connection 架構可以很好的學到 <strong>Noise裡的高頻訊息</strong>，如果嘗試用FC層的神經網路來預測Noise，效果會非常炸裂</li></ul></li></ul><h1 id="diffusion-models-vs-gans-vs-vaes">Diffusion Models vs GANs vs VAEs</h1><p>擴散模型（Diffusion Models）與傳統的生成對抗網絡（GANs）和變分自編碼器（VAEs）相比，具有多項顯著的優勢和特點。以下是這三種生成模型的比較：</p><h2 id="穩定性">1. <strong>穩定性</strong></h2><ul><li><strong>擴散模型</strong>：訓練過程相對穩定，不容易出現梯度消失或爆炸等問題。這使得擴散模型在訓練時更易於優化，並且能夠生成高質量的樣本。</li><li><strong>GANs</strong>：訓練過程不穩定，容易出現模式崩潰（mode collapse），即生成器只能生成有限類型的數據，這限制了其多樣性。</li><li><strong>VAEs</strong>：雖然訓練過程較為穩定，但生成的數據多樣性相對較低，可能不適合需要高多樣性的應用。</li></ul><h2 id="生成質量">2. <strong>生成質量</strong></h2><ul><li><strong>擴散模型</strong>：能夠捕捉到更多的細節信息，生成更加真實、細膩的圖像。這使得擴散模型在圖像生成等任務中表現出色。</li><li><strong>GANs</strong>：在生成質量方面通常表現良好，特別是在需要高保真度的應用中，如圖像合成和風格轉換。</li><li><strong>VAEs</strong>：雖然訓練穩定，但生成的數據質量可能不如GANs高，因此在複雜數據生成任務中表現較弱。</li></ul><h2 id="計算資源與效率">3. <strong>計算資源與效率</strong></h2><ul><li><strong>擴散模型</strong>：在訓練和生成過程中需要消耗大量計算資源，並且由於需要多次迭代和反向擴散過程，導致采樣速度較慢。</li><li><strong>GANs</strong>：通常需要較大的計算資源，但一旦訓練完成，其生成速度相對較快。</li><li><strong>VAEs</strong>：計算量相對較小，訓練過程較快，但可能無法產生足夠多樣化的數據。</li></ul><h2 id="可控性">4. <strong>可控性</strong></h2><ul><li><strong>擴散模型</strong>：具有良好的可控性，可以通過調整擴散步長、噪聲強度等參數來精細控制生成結果，以滿足用戶需求。</li><li><strong>GANs</strong>：可控性較差，因為生成器和判別器之間的對抗性質使得難以直接控制輸出特徵。</li><li><strong>VAEs</strong>：通過隱變量進行控制，但可控性通常不如擴散模型強。</li></ul><h2 id="應用場景">5. <strong>應用場景</strong></h2><ul><li><strong>擴散模型</strong>：已在計算機視覺、自然語言處理、語音合成等多個領域取得成功應用，如圖像生成、超分辨率、去噪等任務。</li><li><strong>GANs</strong>：廣泛應用於圖像生成、風格轉換等需要高質量生成的場景。</li><li><strong>VAEs</strong>：更適合於數據分析、降維等應用場景，並且具有良好的解釋性。</li></ul><h2 id="總結-1">總結</h2><p>總體而言，擴散模型在穩定性、生成質量和可控性方面展現了顯著優勢，使其成為當前深度學習領域中一個重要的研究方向。隨著技術的不斷發展，擴散模型有望在更多應用中取代傳統的GANs和VAEs。</p><h1 id="references">References</h1><ol type="1"><li><a href="https://roysubhradip.hashnode.dev/a-beginners-guide-to-diffusion-models-understanding-the-basics-and-beyond">A Beginner's Guide to Diffusion Models: Understanding the Basics and Beyond | Subhradip Roy's Blog (<strong>Recommend</strong>)</a></li><li><a href="https://lilianweng.github.io/posts/2021-07-11-diffusion-models/#forward-diffusion-process">What are Diffusion Models? (<strong>Recommend</strong>)</a></li><li><a href="https://www.youtube.com/playlist?list=PLJV_el3uVTsNi7PgekEUFsyVllAJXRsP-">【生成式AI】淺談圖像生成模型 Diffusion Model 原理</a></li><li><a href="https://blog.cnbang.net/tech/3823/">理解 Stable Diffusion UNet 网络</a></li><li><a href="https://www.assemblyai.com/blog/diffusion-models-for-machine-learning-introduction/">Introduction to Diffusion Models for Machine Learning</a></li></ol>]]></content>
    
    
    <categories>
      
      <category>ML</category>
      
    </categories>
    
    
    <tags>
      
      <tag>AI</tag>
      
      <tag>ML</tag>
      
      <tag>pytorch</tag>
      
      <tag>Diffusion</tag>
      
      <tag>UNet</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ML | U-Net</title>
    <link href="/2024/12/13/ML-Unet/"/>
    <url>/2024/12/13/ML-Unet/</url>
    
    <content type="html"><![CDATA[<h1 id="u-net">U-Net</h1><p>The <code>U-Net</code> architecture follows an <strong>encoder-decoder cascade structure</strong>, where the encoder gradually compresses information into a <strong>lower-dimensional representation</strong>. Then the decoder decodes this information back to the original image dimension. Owing to this, the architecture gets an overall U-shape, which leads to the name U-Net.</p><p><strong>U-Net is a convolutional neural network that was developed for image segmentation</strong>. The network is based on a <a href="https://openaccess.thecvf.com/content_cvpr_2015/papers/Long_Fully_Convolutional_Networks_2015_CVPR_paper.pdf">fully convolutional neural network</a> whose architecture was modified and extended to work with fewer training images and to yield more precise segmentation.</p><p><img src="https://i.imgur.com/eKOoRN9.png" width="600" /></p><p>U-Net is a prominent deep learning architecture primarily used for <strong>semantic segmentation</strong> in computer vision tasks, particularly in the biomedical field. Developed by <a href="https://www.academia.edu/download/80140288/1505.pdf">Olaf Ronneberger and colleagues in 2015</a>, U-Net was designed to perform well even with limited training data, making it particularly useful in medical imaging where annotated datasets are scarce.</p><figure><img src="https://i.imgur.com/l2LtVgl.png" alt="Fig. 1. U-net architecture (example for 32x32 pixels in the lowest resolution). Each blue box corresponds to a multi-channel feature map. The number of channels is denoted on top of the box. The x-y-size is provided at the lower left edge of the box. White boxes represent copied feature maps. The arrows denote the different operations. ( Source: Ronneberger, O., Fischer, P., &amp; Brox, T. (2015). U-net: Convolutional networks for biomedical image segmentation." width="600" /><figcaption>Fig. 1. U-net architecture (example for 32x32 pixels in the lowest resolution). Each blue box corresponds to a multi-channel feature map. The number of channels is denoted on top of the box. The x-y-size is provided at the lower left edge of the box. White boxes represent copied feature maps. The arrows denote the different operations. ( Source: Ronneberger, O., Fischer, P., &amp; Brox, T. (2015). U-net: Convolutional networks for biomedical image segmentation.</figcaption></figure><h2 id="architecture-overview">Architecture Overview</h2><p>U-Net features a distinctive <strong>U-shaped architecture</strong> that consists of two main paths: the <strong>contracting path</strong> (encoder) and the <strong>expansive path</strong> (decoder).</p><ul><li><p><strong>Contracting Path (Encoder)</strong>: This part of the network captures context from the input image. It consists of several convolutional layers followed by max pooling operations, which progressively reduce the spatial dimensions while increasing the depth of feature maps. The encoder extracts high-level features from the input image, similar to other convolutional networks.</p></li><li><p><strong>Expansive Path (Decoder)</strong>: The decoder's role is to upsample the feature maps obtained from the encoder back to the original image size. This is achieved through <strong>transposed convolutions</strong> (<strong>deconvolutions</strong>) and concatenation with corresponding feature maps from the encoder via <strong>skip connections</strong>. These skip connections help preserve spatial information that might be lost during downsampling, allowing for more precise localization of features in the output segmentation map.</p></li></ul><h3 id="key-features">Key Features</h3><ul><li><strong>Skip Connections</strong>: These connections between corresponding layers in the encoder and decoder allow the model to retain spatial information, which is crucial for accurate segmentation.</li><li><strong>Fully Convolutional Network</strong>: U-Net is a fully convolutional network, meaning it does not rely on fully connected layers, making it more efficient for image processing tasks.</li><li><strong>Effective with Limited Data</strong>: U-Net's design enables it to perform well even when trained on small datasets, which is a significant advantage in fields like medical imaging where data acquisition can be challenging.</li></ul><h2 id="applications">Applications</h2><p>U-Net has been widely adopted for various applications beyond biomedical image segmentation, including:</p><ul><li><strong>Medical Imaging</strong>: Segmenting organs or tumors in MRI and CT scans.</li><li><strong>Satellite Image Analysis</strong>: Identifying land use or changes in land cover.</li><li><strong>Autonomous Vehicles</strong>: Assisting in scene understanding by segmenting objects within images.</li></ul><p>In summary, U-Net's innovative architecture and effective use of skip connections have made it a foundational model in semantic segmentation tasks across various domains, particularly where data scarcity poses challenges.</p><h1 id="u-net-模型">U-Net 模型</h1><p>U-Net 模型可以分為三個主要部分：</p><ul><li><code>編碼器（Encoder）</code>：編碼器負責通過卷積和最大池化等操作對輸入影像進行降維處理（Downsampling），以提取影像中的重要特徵。我們可以把這一過程想像成在影像上移動一個小視窗，然後記錄下視窗中的特徵</li><li><code>解碼器（Decoder）</code>：解碼器則通過反卷積做上採樣（Upsample）來把特徵資訊重新組合成一張與原始影像大小相同的新影像，其中，反卷積會逐步還原原始輸入影像中的高頻資訊（影像細節）和低頻資訊（影像輪廓），最後生成的影像就會是像素級的分割結果</li><li><code>跳躍連接（Skip Connection）</code>：跳躍連接是在編碼器和解碼器之間的連接，它有助於保留在編碼器階段可能遺失的資訊，通過拼接，使得解碼器在上採樣的時候，能夠保留更多在編碼器時的特徵圖中的高分辨率細節資訊，提高分割的精確度。這對於語義分割任務非常重要，因為編碼器的卷積會保留重要的細節資訊</li></ul><h2 id="u-net-convolutional-networks-for-biomedical-image-segmentation">U-net: Convolutional networks for biomedical image segmentation</h2><ul><li><a href="https://link.springer.com/chapter/10.1007/978-3-319-24574-4_28">Ronneberger, O., Fischer, P., &amp; Brox, T. (2015). U-net: Convolutional networks for biomedical image segmentation. In Medical image computing and computer-assisted intervention–MICCAI 2015: 18th international conference, Munich, Germany, October 5-9, 2015, proceedings, part III 18 (pp. 234-241). Springer International Publishing.</a></li></ul><p>The network architecture is illustrated in Figure 1.</p><ul><li>It consists of a <strong>contracting path</strong> (left side) and an <strong>expansive path</strong> (right side).</li><li>The contracting path follows the typical architecture of a <strong>convolutional network</strong>.</li><li>It consists of the repeated<ul><li>application of two <strong>3x3 convolutions</strong> (unpadded convolutions), each followed by a rectified linear unit (<strong>ReLU</strong>) and a <strong>2x2 max pooling</strong> operation with stride 2 for downsampling.</li><li>At each downsampling step we <strong>double the number of feature channels</strong>.</li><li>Every step in the expansive path consists of an upsampling of the feature map followed by a<ul><li><strong>2x2 convolution ("up-convolution") that halves the number of feature channels</strong>,</li><li>a <strong>concatenation</strong> with the <code>correspondingly cropped</code> <strong>feature map</strong> from the contracting path,</li></ul></li><li>and two <strong>3x3 convolutions</strong>, each followed by a ReLU.</li><li>The cropping is necessary due to the loss of border pixels in every convolution.</li><li>At the final layer a 1x1 convolution is used to map each 64-component feature vector to the desired number of classes. In total the network has 23 convolutional layers.</li></ul></li></ul><p>To allow a seamless tiling of the output segmentation map (see Figure 2), it is important to select the input tile size such that all 2x2 max-pooling operations are applied to a layer with an even x- and y-size.</p><h1 id="一文搞懂-deconvolutiontransposed-convolutionsub-pixel-or-fractional-convolution"><a href="https://www.cnblogs.com/shine-lee/p/11559825.html">一文搞懂 deconvolution、transposed convolution、sub-pixel or fractional convolution</a></h1><ol type="1"><li><code>deconvolution</code>，实际上与 <code>transposed convolution</code> 、<code>sub-pixel</code> or <code>fractional convolution</code> 指代相同。<strong>transposed convolution</strong> 是一个更好的名字，sub-pixel or fractional convolution可以看成是transposed convolution的一个特例。对一个常规的卷积层而言，前向传播时是convolution，将input feature map映射为output feature map，反向传播时则是transposed convolution，根据output feature map的梯度计算出input feature map的梯度，梯度图的尺寸与feature map的尺寸相同</li><li><strong>convolution</strong> 过程是将 4×4 的map映射为 2×2 的map，而 <strong>transposed convolution</strong> 过程则是将 2×2 的map映射为 4×4 的map，两者的kernel size均为3</li><li>对于一般情况，只需把握一个宗旨：transposed convolution 将 output size 恢复为 input size 且保持连接方式相同</li></ol><figure><img src="https://s2.ax1x.com/2019/09/18/n75lfs.gif" alt="convolution vs transposed convolution" width="600" /><figcaption>convolution vs transposed convolution</figcaption></figure><h1 id="反捲積deconvolution上採樣unsampling與上池化unpooling差異"><a href="https://medium.com/ai%E5%8F%8D%E6%96%97%E5%9F%8E/%E5%8F%8D%E6%8D%B2%E7%A9%8D-deconvolution-%E4%B8%8A%E6%8E%A1%E6%A8%A3-unsampling-%E8%88%87%E4%B8%8A%E6%B1%A0%E5%8C%96-unpooling-%E5%B7%AE%E7%95%B0-feee4db49a00">反捲積(Deconvolution)、上採樣(UNSampling)與上池化(UnPooling)差異</a></h1><ol type="1"><li>逆卷積(Deconvolution)比較容易引起誤會，轉置卷積(Transposed Convolution)是一個更為合適的叫法</li></ol><p><img src="https://miro.medium.com/v2/resize:fit:828/format:webp/0*eTUfEWr8wwLbGt-y" width="400" /></p><h1 id="copy-and-crop-操作">Copy and crop 操作</h1><ul><li><a href="https://github.com/Rwzzz/Unet" class="uri">https://github.com/Rwzzz/Unet</a></li></ul><ol type="1"><li>论文中只用分割出细胞边界，所以最后使用的是2个1<em>1卷积得到背景和目标两个。如果是多目标分割，根据分割目标的种类来决定使用1</em>1的卷积的数量来输出Segmentation map.注：对于多目标的Label标注：可以使用不同颜色，然后使用One-hot编码生成Label进行训练</li><li>Copy and crop操作： 经过两次3<em>3卷积后，大小变为28×28，然后经过一次2</em>2卷积，变为56×56，这时和左侧大小为64×64的图像进行维度的叠加，但是由于图像大小不同，需要将左侧的64×64大小的图像裁剪为56×56大小,此处的裁剪是合理的，原因看下一步3中讲的Overlap-tile策略。</li><li>可以发现Unet论文中输入的图像是572×572但是输出图像确实388×388.这是不是就意味着原图像存在信息丢失的现象呢？实际上不是的，经过了no padding的卷积操作，输入图像和输出图像肯定是不一样的尺寸，但是Unet在论文中提及了一种策略--Overlap-tile，将图像进行镜像扩充和输入网络，这样经过卷积后得到的输出图像和实际需要提取的图像是相同的尺寸。    例如下图，实际需要分割的图像是黄色框所选中部分，但是输入到网络中的图像是蓝色部分，对空白部分进行镜像填充，这样经过网络后所得到的的输出大小尺寸适合实际需要分割的图像大小是一样的。</li><li>Unet模型简单，并且使用较少的数据集，可以达到非常理想的分割效果，对于医学和其他一些数据集比较少的领域优势很大。</li></ol><h1 id="youtube">Youtube</h1><ul><li>U-Net Architecture</li></ul><iframe width="628" height="353" src="https://www.youtube.com/embed/oQxrjl3INEY" title="U-Net Architecture" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen></iframe><ul><li>Deep learning: U-Net architecture | Qingjie Meng</li></ul><iframe width="628" height="353" src="https://www.youtube.com/embed/NDfhW9YTvek" title="U-Net architecture" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen></iframe><h1 id="hands-on-動手實踐"><strong>Hands-on (動手實踐)</strong></h1><p>todo</p><h1 id="references">References</h1><ol type="1"><li><a href="https://openaccess.thecvf.com/content_cvpr_2015/papers/Long_Fully_Convolutional_Networks_2015_CVPR_paper.pdf">Long, J., Shelhamer, E., &amp; Darrell, T. (2015). <strong>Fully convolutional networks for semantic segmentation</strong>. In Proceedings of the IEEE conference on computer vision and pattern recognition (pp. 3431-3440).</a></li><li><a href="https://www.academia.edu/download/80140288/1505.pdf">Ronneberger, O., Fischer, P., &amp; Brox, T. (2015). <strong>U-net: Convolutional networks for biomedical image segmentation</strong>. In Medical image computing and computer-assisted intervention–MICCAI 2015: 18th international conference, Munich, Germany, October 5-9, 2015, proceedings, part III 18 (pp. 234-241). Springer International Publishing.</a></li><li><a href="https://martin12345m.medium.com/3d-unet-%E5%B0%8F%E7%B0%A1%E4%BB%8B-%E6%9E%B6%E6%A7%8B-1-%E5%BE%9E2d%E9%96%8B%E5%A7%8B-669cacd2f813">3D Unet 小簡介：架構(1) — 從2D開始</a></li><li><a href="https://pyimagesearch.com/2021/11/08/u-net-training-image-segmentation-models-in-pytorch/">U-Net: Training Image Segmentation Models in PyTorch</a></li><li><a href="https://acrocanthosaurus627.medium.com/%E7%B6%93%E5%85%B8%E7%B6%B2%E8%B7%AF%E7%B3%BB%E5%88%97-%E5%8D%81-unet-545efa00ad99">Pytorch實作系列 — UNet</a><ol type="1"><li>對於原本的論文，有幾點疑惑<ol type="1"><li>作者使用沒有 padding 的卷積操作，不知道是怎麼將output與label對齊。</li><li>作者提到結合下採樣時要進行copy and crop，但沒提crop的內容。</li><li>很多技巧的細節沒講。</li></ol></li></ol></li></ol>]]></content>
    
    
    <categories>
      
      <category>ML</category>
      
    </categories>
    
    
    <tags>
      
      <tag>AI</tag>
      
      <tag>ML</tag>
      
      <tag>pytorch</tag>
      
      <tag>U-Net</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ML | GNN Graph Neural Network Model</title>
    <link href="/2024/12/12/ML-GNN/"/>
    <url>/2024/12/12/ML-GNN/</url>
    
    <content type="html"><![CDATA[<h1 id="overview-of-graph-neural-networks-gnns">Overview of Graph Neural Networks (GNNs)</h1><p>Graph Neural Networks (GNNs) are a specialized type of neural network designed to process and analyze graph-structured data. Unlike traditional neural networks that operate on structured data (like images or text), GNNs can directly handle the complex relationships represented in graphs, making them particularly useful for tasks where data is interconnected.</p><h2 id="what-is-a-graph">What is a Graph?</h2><p>A graph is a mathematical structure consisting of <strong>nodes</strong> (or vertices) and <strong>edges</strong> (connections between nodes). Formally, a graph $ G $ can be defined as $ G = (V, E) $, where $ V $ is the set of nodes and $ E $ is the set of edges. Graphs can represent various types of data, such as social networks, molecular structures, and transportation systems.</p><h2 id="how-gnns-work">How GNNs Work</h2><p>GNNs utilize a process called <strong>message passing</strong>, where information is exchanged between neighboring nodes. Each node updates its state by aggregating information from its neighbors, allowing the network to learn representations that capture the structure and features of the graph. The final output for each node is known as its <strong>embedding</strong>, which encapsulates the node's information in relation to its neighbors. (Message passing layers are permutation-equivariant layers mapping a graph into an updated representation of the same graph.)</p><h2 id="types-of-gnns">Types of GNNs</h2><p>There are several variations of GNNs, each suited for different applications:</p><ul><li><strong>Graph Convolutional Networks (GCNs)</strong>: These networks extend convolutional neural networks (CNNs) to graph data by learning features from neighboring nodes through convolution-like operations.</li><li><strong>Recurrent Graph Neural Networks (RGNNs)</strong>: RGNNs are designed for handling temporal or sequential data on graphs, leveraging recurrent mechanisms to model dependencies over time.</li><li><strong>Gated Graph Neural Networks (GGNNs)</strong>: These networks introduce gating mechanisms to better manage long-range dependencies within graph structures.</li><li><strong>Graph Autoencoders</strong>: Used primarily for unsupervised learning tasks such as link prediction, these models encode graph data into lower-dimensional representations and then attempt to reconstruct the original graph.</li></ul><h2 id="applications-of-gnns">Applications of GNNs</h2><p>GNNs are versatile and can be applied in various domains:</p><ul><li><strong>Node Classification</strong>: Predicting labels for nodes in a graph, often used in social networks or citation networks.</li><li><strong>Link Prediction</strong>: Estimating the likelihood of connections between nodes, useful in recommendation systems.</li><li><strong>Graph Classification</strong>: Classifying entire graphs based on their structure and node features, applicable in molecular chemistry and bioinformatics.</li></ul><p><img src="https://i.imgur.com/9cs4ilH.png" width="600" /></p><h2 id="conclusion">Conclusion</h2><p>Graph Neural Networks represent a significant advancement in machine learning by enabling the analysis of complex relational data. Their ability to learn from the structure and features of graphs opens up new possibilities across numerous fields, from social sciences to biology and beyond. As research continues to evolve, GNNs are likely to become increasingly integral to understanding and leveraging interconnected data.</p><h1 id="a-gentle-introduction-to-graph-neural-networks-recommend"><a href="https://distill.pub/2021/gnn-intro/">A Gentle Introduction to Graph Neural Networks (<strong>Recommend</strong>)</a></h1><div class="note note-danger">            <p>A GNN is an optimizable transformation on all attributes of the graph (nodes, edges, global-context) that preserves graph symmetries (permutation invariances).</p>          </div><p>We’re going to build GNNs using the “message passing neural network” framework proposed by <a href="https://proceedings.mlr.press/v70/gilmer17a/gilmer17a.pdf">Gilmer et al.</a> using the Graph Nets architecture schematics introduced by <a href="https://www.researchgate.net/profile/Andrea-Tacchetti/publication/325557043_Relational_inductive_biases_deep_learning_and_graph_networks/links/5cd0ad38299bf14d957cca5c/Relational-inductive-biases-deep-learning-and-graph-networks.pdf">Battaglia et al.</a></p><p>GNNs adopt a <strong>“graph-in, graph-out” architecture</strong> meaning that these model types accept a graph as input, with information loaded into its nodes, edges and global-context, and progressively transform these embeddings, without changing the connectivity of the input graph.</p><ul><li>What types of problems have graph structured data?<ul><li>We have described some examples of graphs in the wild, but what tasks do we want to perform on this data? There are three general types of prediction tasks on graphs: <strong>graph-level, node-level, and edge-level</strong>.<ul><li>In a <code>graph-level task</code>, we predict a single property for a whole graph.</li><li>For a <code>node-level task</code>, we predict some property for each node in a graph.</li><li>For an <code>edge-level task</code>, we want to predict the property or presence of edges in a graph.</li></ul></li><li>For the three levels of prediction problems described above (graph-level, node-level, and edge-level), we will show that all of the following problems can be solved with a single model class, the GNN. But first, let’s take a tour through the three classes of graph prediction problems in more detail, and provide concrete examples of each.</li></ul></li></ul><p><img src="https://i.imgur.com/lTzKFu6.png" width="600" /> <img src="https://i.imgur.com/QzUIet1.png" width="600" /></p><p>However, it is not always so simple. For instance, you might have information in the graph stored in edges, but no information in nodes, but still need to make predictions on nodes. We need a way to collect information from edges and give them to nodes for prediction. We can do this by pooling. <code>Pooling proceeds</code> in two steps:</p><ol type="1"><li>For each item to be pooled, gather each of their embeddings and concatenate them into a matrix.</li><li>The gathered embeddings are then aggregated, usually via a sum operation.</li></ol><p>We represent the <strong>pooling operation</strong> by the letter <span class="math inline">\(\rho\)</span>, and denote that we are gathering information from edges to nodes as <span class="math inline">\(p_{E_n \to V_{n}}\)</span>.</p><p><img src="https://i.imgur.com/IuZEdeO.png" width="600" /></p><p><img src="https://i.imgur.com/SU2M541.png" width="600" /></p><h2 id="other-types-of-graphs-multigraphs-hypergraphs-hypernodes-hierarchical-graphs">Other types of graphs (multigraphs, hypergraphs, hypernodes, hierarchical graphs)</h2><p>We can also consider nested graphs, where for example a node represents a graph, also called a <a href="https://dl.acm.org/doi/pdf/10.1145/174608.174610">hypernode graph</a>. Nested graphs are useful for <strong>representing hierarchical information</strong>. For example, we can consider a network of molecules, where a node represents a molecule and an edge is shared between two molecules if we have a way (reaction) of transforming one to the other <a href="https://academic.oup.com/bioinformatics/article-pdf/34/13/i457/50316205/bioinformatics_34_13_i457.pdf">(1)</a>, <a href="https://www.nature.com/articles/s41467-020-19267-x.pdf">(2)</a>. In this case, we can learn on a nested graph by having a GNN that learns representations at the molecule level and another at the reaction network level, and alternate between them during training.</p><p><img src="https://i.imgur.com/36EVPAi.png" width="600" /></p><h2 id="gnn-introduction"><a href="https://web.stanford.edu/class/cs224w/index.html#content">GNN introduction</a></h2><ul><li>A graph G can be defined as G = (V, E), where V is the set of nodes, and E are the edges between them.</li><li>If there are directional dependencies between nodes then edges are directed. If not, edges are undirected.</li><li>A graph is often represented by A, an adjacency matrix.</li><li>If a graph has n nodes, A has a dimension of (n × n).</li><li>Sometimes the nodes have a set of features (for example, a user profile). If the node has f numbers of features, then the node feature matrix X has a dimension of (n × f).</li></ul><p><img src="https://i.imgur.com/0efkNVa.png" width="500" /></p><ul><li>In graph theory, we implement the concept of Node Embedding. It means mapping nodes to a d- dimensional embedding space (low dimensional space rather than the actual dimension of the graph), so that similar nodes in the graph are embedded close to each other. Our goal is to map nodes so that similarity in the embedding space approximates similarity in the network.<ul><li>Let’s define <span class="math inline">\(u\)</span> and <span class="math inline">\(v\)</span> as two nodes in a graph.</li><li><span class="math inline">\(x_u\)</span> and <span class="math inline">\(x_v\)</span> are two feature vectors.</li><li>Now we’ll define the encoder function Enc(u) and Enc(v), which convert the feature vectors to <span class="math inline">\(z_u\)</span> and <span class="math inline">\(z_v\)</span>.</li><li>Note: the similarity function could be Euclidean distance.</li></ul></li><li>So the challenge now is how to come up with the encoder function?<ul><li>The encoder function should be able to perform :<ul><li>Locality (local network neighborhoods)</li><li>Aggregate information</li><li>Stacking multiple layers (computation)</li></ul></li></ul></li></ul><div class="group-image-container"><div class="group-image-row"><div class="group-image-wrap"><img src="https://i.imgur.com/NhNdI8o.png" width="500" /></div><div class="group-image-wrap"><img src="https://i.imgur.com/OU2SPdQ.png" width="500" /></div></div><div class="group-image-row"><div class="group-image-wrap"><img src="https://i.imgur.com/NFIF847.png" width="500" /></div><div class="group-image-wrap"><img src="https://i.imgur.com/fKZQc9J.png" width="500" /></div></div><div class="group-image-row"><div class="group-image-wrap"><img src="https://i.imgur.com/zT4XYSp.png" width="500" /></div></div></div><p>where <span class="math inline">\(h_v^k\)</span> is Hidden state of node <span class="math inline">\(v\)</span> on step <span class="math inline">\(k\)</span>.</p><p>Now, to train the model we need to define a loss function on the embeddings.</p><ul><li>We can feed the embeddings into any loss function and run stochastic gradient descent to train the weight parameters.<ul><li>Training can be unsupervised or supervised:<ul><li><strong>Unsupervised training</strong>:<ul><li>Use only the graph structure: similar nodes have similar embeddings. Unsupervised loss function can be a loss based on node proximity in the graph, or random walks. (Node clustering is a typical unsupervised learning task.)</li></ul></li><li><strong>Supervised training</strong>:<ul><li>Train model for a supervised task like node classification, normal or anomalous node.</li></ul></li></ul></li></ul></li></ul><div class="note note-primary">            <p>和周圍位置的資訊一起收集，進到運算，然後傳到下一層，重複這個步驟…那不就是卷積神經網路(CNN)嗎?沒錯，在CNN裡，相鄰位置集結資訊的是圖片的畫素，而在這裡，GNN的訊息傳遞收集的是相鄰位置的端點/連結。差別在於：CNN有固定的規格，而訊息傳遞端看關聯性決定，比較有彈性。</p><p>我們再以端點的訊息傳遞為例。第一層的GNN，收集的是某個端點周圍，有直接關連性的端點的資訊。再堆疊一層之後，雖然重複這個步驟，但別忘了，它周圍那些端點，在上一層也跟他做過一樣的動作 — 蒐集周圍直接關聯性的資訊。所以在第二層，這個端點可以藉由只集結周圍有直接關聯性的端點的資訊，就收集到間接關聯性端點的資訊了。如此層層疊加，疊到一定層數的時候，一個端點可能可以囊括整個圖像一大部分，甚至是整體端點的資訊，只是所含資訊量的比重，隨端點關聯性遠近有所不同而已。</p>          </div><h2 id="node-embeddings">Node embeddings</h2><h3 id="graph-representation-learning">Graph Representation Learning</h3><div class="group-image-container"><div class="group-image-row"><div class="group-image-wrap"><img src="https://i.imgur.com/ZxYLdMW.png" width="500" /></div><div class="group-image-wrap"><img src="https://i.imgur.com/FHPzwuF.png" width="500" /></div></div></div><p>why embedding?</p><ul><li>Task: Map nodes into an embedding space<ul><li>Similarity of embeddings between nodes indicates their similarity in the network. For example:</li><li>Both nodes are close to each other (connected by an edge)</li><li>Encode network information</li><li>Potentially used for many downstream predictions</li></ul></li><li>Encoder + Decoder Framework</li><li>We will now learn node similarity definition that uses <strong>random walks</strong>, and how to optimize embeddings for such a similarity measure.<ul><li>This is <strong>unsupervised</strong>/self-supervised way of learning node embeddings.<ul><li>We are <strong>not</strong> utilizing node labels</li><li>We are <strong>not</strong> utilizing node features</li><li>The goal is to directly estimate a set of coordinates(i.e., the embedding) of a node so that some aspect of the network structure (captured by DEC) is preserved.</li><li>These embeddings are task independent</li><li><strong>They are not trained for a specific task but can be used for any task</strong>.</li></ul></li></ul></li></ul><p><img src="https://i.imgur.com/f9iPbQC.png" width="500" /></p><h3 id="a-zt-z">A = Z^T Z ?</h3><div class="group-image-container"><div class="group-image-row"><div class="group-image-wrap"><img src="https://i.imgur.com/P93DVQz.png" width="500" /></div><div class="group-image-wrap"><img src="https://i.imgur.com/RNoveXJ.png" width="500" /></div></div></div><h3 id="singular-value-decomposition-svd">singular value decomposition (SVD)</h3><p>In linear algebra, the singular value decomposition (SVD) is a factorization of a real or complex matrix into a rotation, followed by a rescaling followed by another rotation. It generalizes the eigendecomposition of a square normal matrix with an orthonormal eigenbasis to any ⁠<span class="math inline">\(m\times n\)</span>⁠ matrix. It is related to the polar decomposition.</p><p><img src="https://i.imgur.com/GyTLhY3.png" width="500" /></p><h3 id="eigendecomposition-of-a-matrix">Eigendecomposition of a matrix</h3><p>like eigen-vector/eigen-values, take first d-dim values?</p><p><img src="https://i.imgur.com/NSU9aE6.png" width="500" /></p><h4 id="cholesky-decomposition-what-we-need">Cholesky decomposition (What we need!!)</h4><p>The Cholesky decomposition of a Hermitian positive-definite matrix A,</p><p><span class="math display">\[A = L L^*\]</span></p><p><img src="https://i.imgur.com/CWYksHg.png" width="500" /> <img src="https://i.imgur.com/AXe1taX.png" data-widht="500" /></p><p>But,</p><div class="note note-primary">            <p>There are various methods for calculating the Cholesky decomposition. <strong>The computational complexity of commonly used algorithms is <span class="math inline">\(O(n^3)\)</span> in general</strong>.</p>          </div><h3 id="graph-is-permutation-invariant">Graph is <em>permutation invariant</em></h3><div class="group-image-container"><div class="group-image-row"><div class="group-image-wrap"><img src="https://i.imgur.com/DlVGg6t.png" width="500" /></div><div class="group-image-wrap"><img src="https://i.imgur.com/F7ZSTtn.png" width="500" /></div></div><div class="group-image-row"><div class="group-image-wrap"><img src="https://i.imgur.com/V2Z75Pk.png" width="500" /></div><div class="group-image-wrap"><img src="https://i.imgur.com/SDAY91T.png" width="500" /></div></div></div><div class="note note-primary">            <p><strong>Graph neural networks consist of multiple permutation equivariant / invariant functions</strong></p>          </div><ul><li>This explains why the <strong>naïve MLP approach fails for graphs</strong></li></ul><div class="note note-primary">            <p>Next: Design graph neural networks that are permutation invariant / equivariant <strong>by passing and aggregating information from neighbors</strong>!</p>          </div><h3 id="graph-convolutional-networks-massage-passing">Graph Convolutional Networks &amp; massage passing</h3><div class="group-image-container"><div class="group-image-row"><div class="group-image-wrap"><img src="https://i.imgur.com/Z6UI3cN.png" width="500" /></div><div class="group-image-wrap"><img src="https://i.imgur.com/j4A5H4S.png" width="500" /></div></div></div><ol type="1"><li>The rows of input node features and output embeddings are aligned</li></ol><div class="note note-primary">            <p>和周圍位置的資訊一起收集，進到運算，然後傳到下一層，重複這個步驟…那不就是卷積神經網路(CNN)嗎?沒錯，在CNN裡，相鄰位置集結資訊的是圖片的畫素，而在這裡，GNN的訊息傳遞收集的是相鄰位置的端點/連結。差別在於：CNN有固定的規格，而訊息傳遞端看關聯性決定，比較有彈性。</p><p>我們再以端點的訊息傳遞為例。第一層的GNN，收集的是某個端點周圍，有直接關連性的端點的資訊。再堆疊一層之後，雖然重複這個步驟，但別忘了，它周圍那些端點，在上一層也跟他做過一樣的動作 — 蒐集周圍直接關聯性的資訊。所以在第二層，這個端點可以藉由只集結周圍有直接關聯性的端點的資訊，就收集到間接關聯性端點的資訊了。如此層層疊加，疊到一定層數的時候，一個端點可能可以囊括整個圖像一大部分，甚至是整體端點的資訊，只是所含資訊量的比重，隨端點關聯性遠近有所不同而已。</p>          </div><h3 id="training-model-loss-function">Training model: loss function?</h3><ul><li>How do we train the GCN to generate embeddings? Need to define a <strong>loss function</strong> on the embeddings.</li></ul><div class="group-image-container"><div class="group-image-row"><div class="group-image-wrap"><img src="https://i.imgur.com/UVUEGLk.png" width="500" /></div><div class="group-image-wrap"><img src="https://i.imgur.com/veQIjnw.png" width="500" /></div></div><div class="group-image-row"><div class="group-image-wrap"><img src="https://i.imgur.com/GtwlKjp.png" width="500" /></div><div class="group-image-wrap"><img src="https://i.imgur.com/5aN9B9C.png" width="500" /></div></div><div class="group-image-row"><div class="group-image-wrap"><img src="https://i.imgur.com/S7MPU0P.png" width="500" /></div></div><div class="group-image-row"><div class="group-image-wrap"><img src="https://i.imgur.com/8jRfivB.png" width="500" /></div><div class="group-image-wrap"><img src="https://i.imgur.com/yCUS4U7.png" width="500" /></div></div></div><h3 id="capability">Capability</h3><div class="group-image-container"><div class="group-image-row"><div class="group-image-wrap"><img src="https://i.imgur.com/U0OY62w.png" width="500" /></div></div><div class="group-image-row"><div class="group-image-wrap"><img src="https://i.imgur.com/c4IAQhi.png" width="500" /></div><div class="group-image-wrap"><img src="https://i.imgur.com/rGc3QZs.png" width="500" /></div></div></div><h3 id="toy-model-interactive-visualiztion-of-gnn">Toy model: Interactive Visualiztion of GNN</h3><p>GNN 101: Visual Learning of Graph Neural Networks in Your Web Browser</p><ul><li><a href="https://visual-intelligence-umn.github.io/GNN-101" class="uri">https://visual-intelligence-umn.github.io/GNN-101</a></li></ul><div class="group-image-container"><div class="group-image-row"><div class="group-image-wrap"><img src="https://i.imgur.com/3XObrn8.png" width="500" /></div><div class="group-image-wrap"><img src="https://i.imgur.com/L9KMlJq.png" width="500" /></div></div></div><h1 id="gnn-vs-cnn">GNN vs CNN</h1><p><img src="https://i.imgur.com/BmgKRhE.png" width="500" /></p><ul><li>CNN can be seen as a special GNN with fixed neighbor size and ordering:<ul><li>The size of the filter is pre-defined for a CNN.</li><li>The advantage of GNN is it processes arbitrary graphs with different degrees for each node.</li></ul></li><li>CNN is not permutation invariant/equivariant.<ul><li>Switching the order of pixels leads to different outputs.</li></ul></li></ul><div class="note note-primary">            <p>和周圍位置的資訊一起收集，進到運算，然後傳到下一層，重複這個步驟…那不就是卷積神經網路(CNN)嗎?沒錯，在CNN裡，相鄰位置集結資訊的是圖片的畫素，而在這裡，GNN的訊息傳遞收集的是相鄰位置的端點/連結。差別在於：CNN有固定的規格，而訊息傳遞端看關聯性決定，比較有彈性。</p><p>我們再以端點的訊息傳遞為例。第一層的GNN，收集的是某個端點周圍，有直接關連性的端點的資訊。再堆疊一層之後，雖然重複這個步驟，但別忘了，它周圍那些端點，在上一層也跟他做過一樣的動作 — 蒐集周圍直接關聯性的資訊。所以在第二層，這個端點可以藉由只集結周圍有直接關聯性的端點的資訊，就收集到間接關聯性端點的資訊了。如此層層疊加，疊到一定層數的時候，一個端點可能可以囊括整個圖像一大部分，甚至是整體端點的資訊，只是所含資訊量的比重，隨端點關聯性遠近有所不同而已。</p>          </div><div class="note note-primary">            <ul><li><strong>GNN is a general architecture</strong><ul><li><strong>CNN can be viewed as a special GNN</strong></li></ul></li></ul>          </div><h1 id="gnn-vs-transformer">GNN vs Transformer</h1><div class="group-image-container"><div class="group-image-row"><div class="group-image-wrap"><img src="https://i.imgur.com/zAfVR5g.png" width="500" /></div><div class="group-image-wrap"><img src="https://i.imgur.com/rR1efwk.png" width="500" /></div></div><div class="group-image-row"><div class="group-image-wrap"><img src="https://i.imgur.com/7OObt20.png" width="500" /></div></div></div><ul><li>A nice blog plot for this: <a href="https://towardsdatascience.com/transformers-are-graph-neural-networks-bca9f75412aa" class="uri">https://towardsdatascience.com/transformers-are-graph-neural-networks-bca9f75412aa</a></li></ul><h1 id="gnn-framework">GNN Framework</h1><h2 id="gnn-layer">GNN layer</h2><div class="group-image-container"><div class="group-image-row"><div class="group-image-wrap"><img src="https://i.imgur.com/hsgTIGD.png" width="500" /></div><div class="group-image-wrap"><img src="https://i.imgur.com/2gceJOo.png" width="500" /></div></div><div class="group-image-row"><div class="group-image-wrap"><img src="https://i.imgur.com/lMJQzR8.png" width="500" /></div><div class="group-image-wrap"><img src="https://i.imgur.com/1j3LoP2.png" width="500" /></div></div><div class="group-image-row"><div class="group-image-wrap"><img src="https://i.imgur.com/Tzd7dkw.png" width="500" /></div></div></div><h2 id="different-gnn-layer">Different GNN layer</h2><div class="group-image-container"><div class="group-image-row"><div class="group-image-wrap"><img src="https://i.imgur.com/nfsUrA5.png" width="500" /></div><div class="group-image-wrap"><img src="https://i.imgur.com/1vxH2wW.png" width="500" /></div></div><div class="group-image-row"><div class="group-image-wrap"><img src="https://i.imgur.com/DkH1XRR.png" width="500" /></div><div class="group-image-wrap"><img src="https://i.imgur.com/z6PE4z4.png" width="500" /></div></div><div class="group-image-row"><div class="group-image-wrap"><img src="https://i.imgur.com/wAJktVl.png" width="500" /></div></div></div><h2 id="some-practices-on-gnn-layer">Some Practices on GNN layer</h2><div class="group-image-container"><div class="group-image-row"><div class="group-image-wrap"><img src="https://i.imgur.com/PiNqHRa.png" width="500" /></div><div class="group-image-wrap"><img src="https://i.imgur.com/gMtJNND.png" width="500" /></div></div><div class="group-image-row"><div class="group-image-wrap"><img src="https://i.imgur.com/MhV5wA0.png" width="500" /></div><div class="group-image-wrap"><img src="https://i.imgur.com/rIERKYc.png" width="500" /></div></div><div class="group-image-row"><div class="group-image-wrap"><img src="https://i.imgur.com/N1xN3NF.png" width="500" /></div></div></div><h1 id="class-of-gnn">Class of GNN</h1><figure><img src="https://i.imgur.com/9QG4bGC.png" alt="Chami, I., Abu-El-Haija, S., Perozzi, B., Ré, C., &amp; Murphy, K. (2022). Machine learning on graphs: A model and comprehensive taxonomy. Journal of Machine Learning Research, 23(89), 1-64." /><figcaption>Chami, I., Abu-El-Haija, S., Perozzi, B., Ré, C., &amp; Murphy, K. (2022). Machine learning on graphs: A model and comprehensive taxonomy. Journal of Machine Learning Research, 23(89), 1-64.</figcaption></figure><h1 id="laplacian-matrix">Laplacian matrix</h1><p>In the mathematical field of graph theory, the Laplacian matrix, also called the graph Laplacian, admittance matrix, Kirchhoff matrix or discrete Laplacian, is a matrix representation of a graph. Named after Pierre-Simon Laplace, the graph Laplacian matrix can be viewed as a matrix form of the negative discrete Laplace operator on a graph approximating the negative continuous Laplacian obtained by the finite difference method.</p><ul><li><a href="https://archwalker.github.io/blog/2019/06/16/GNN-Spectral-Graph.html">拉普拉斯矩阵, 谱分解, 图上的傅里叶变换</a></li></ul><p><img src="https://i.imgur.com/3BzmSWo.png" width="800" /></p><h2 id="laplacian-matrix-normalization">Laplacian matrix normalization</h2><p><img src="https://i.imgur.com/Ium26nb.png" width="800" /> <img src="https://i.imgur.com/1YSc7iN.png" width="800" /></p><h2 id="inductive-learning-transductive-learning">Inductive learning, Transductive learning</h2><p>Inductive Inference 我們利用training data這五個點，得到一個function，再利用這個function去predict test data的label。</p><p>Transductive Inference 在使用transductive inference的時候，除了training data以外，我們還可以得知test data的一些資訊。如在上圖中，我們可以得知test data的cluster情況，而藉此我們更可以正確判斷node是屬於哪一個category。</p><p>Inductive Inference雖然不能利用到test data的資訊，但如果我們有夠多的training data，而且test data 和training data 是來自於同一個distribution，則Inductive Inference還是會有好的效果。而Inductive Inference最大的優點在於，當有新的test data時，可以套用從training data學到的同一個function來predict。相反的，Transductive Inference可以利用test data的資訊，這對於手邊沒有很多training data的情況很有幫助，但缺點就是當有新的test data進來時，我們需要重新訓練function，因為新的data會提供新的訊息。</p><h1 id="further">Further</h1><h2 id="computational-graphs">Computational graphs</h2><h2 id="expressivity-power-of-gnn">Expressivity Power of GNN</h2><h2 id="a-classical-expressivity-test-is-graph-isomorphism">A classical expressivity test is Graph isomorphism</h2><h2 id="graph-transformers">Graph Transformers</h2><h2 id="heterogeneous-graphs">Heterogeneous Graphs</h2><h3 id="relational-gcn">Relational GCN</h3><h2 id="knowledge-graphs">Knowledge Graphs</h2><h2 id="gnns-for-recommender-systems">GNNs for recommender systems</h2><h1 id="regional-data-driven-weather-modeling-with-a-global-stretched-grid">Regional data-driven weather modeling with a global stretched-grid</h1><ul><li><a href="https://arxiv.org/pdf/2409.02891">Nipen, Thomas Nils, et al. "Regional data-driven weather modeling with a global stretched-grid." arXiv preprint arXiv:2409.02891 (2024).</a></li></ul><p><img src="https://i.imgur.com/4C4jXs3.png" width="600" /> <img src="https://i.imgur.com/KIhFwXW.png" width="600" /> <img src="https://i.imgur.com/cG9STZy.png" width="600" /></p><h1 id="references">References</h1><ol type="1"><li><a href="https://distill.pub/2021/gnn-intro/">A Gentle Introduction to Graph Neural Networks (<strong>Recommend</strong>)</a></li><li><a href="https://web.stanford.edu/class/cs224w/index.html#content">CS224W: Machine Learning with Graphs (<strong>Recommend</strong>)</a></li><li><a href="https://archwalker.github.io/blog/2019/06/16/GNN-Spectral-Graph.html">拉普拉斯矩阵, 谱分解, 图上的傅里叶变换 (<strong>Recommend</strong>)</a></li><li><a href="https://zhuanlan.zhihu.com/p/136521625?utm_psn=1861545495794683904">图神经网络从入门到入门</a></li><li><a href="https://zhuanlan.zhihu.com/p/619400627">时空图神经网络综述</a></li><li><a href="https://tzuruey.medium.com/graphs-networks-636fc9fddd63">Graphs Networks 分類</a></li><li><a href="https://www.datacamp.com/tutorial/comprehensive-introduction-graph-neural-networks-gnns-tutorial">A Comprehensive Introduction to Graph Neural Networks (GNNs)</a></li><li><a href="https://www.kaggle.com/code/iogbonna/introduction-to-graph-neural-network-with-pytorch">Introduction to Graph Neural Network with Pytorch</a></li><li><a href="https://papers.baulab.info/papers/Scarselli-2009.pdf">Scarselli, F., Gori, M., Tsoi, A. C., Hagenbuchner, M., &amp; Monfardini, G. (2008). <strong>The graph neural network model</strong>. IEEE transactions on neural networks, 20(1), 61-80.</a></li><li><a href="https://arxiv.org/pdf/1810.00826">Xu, K., Hu, W., Leskovec, J., &amp; Jegelka, S. (2018). <strong>How powerful are graph neural networks?</strong>. arXiv preprint arXiv:1810.00826.</a></li><li><a href="https://www.sciencedirect.com/science/article/pii/S2666651021000012">Zhou, J., Cui, G., Hu, S., Zhang, Z., Yang, C., Liu, Z., ... &amp; Sun, M. (2020). <strong>Graph neural networks: A review of methods and applications</strong>. AI open, 1, 57-81.</a></li><li><a href="https://ieeexplore.ieee.org/ielaam/5962385/9312808/9046288-aam.pdf">Wu, Z., Pan, S., Chen, F., Long, G., Zhang, C., &amp; Philip, S. Y. (2020). <strong>A comprehensive survey on graph neural networks</strong>. IEEE transactions on neural networks and learning systems, 32(1), 4-24.</a></li><li><a href="http://proceedings.mlr.press/v70/gilmer17a/gilmer17a.pdf">Neural Message Passing for Quantum Chemistry J. Gilmer, S.S. Schoenholz, P.F. Riley, O. Vinyals, G.E. Dahl. Proceedings of the 34th International Conference on Machine Learning, Vol 70, pp. 1263--1272. PMLR. 2017.</a></li><li><a href="https://www.researchgate.net/profile/Andrea-Tacchetti/publication/325557043_Relational_inductive_biases_deep_learning_and_graph_networks/links/5cd0ad38299bf14d957cca5c/Relational-inductive-biases-deep-learning-and-graph-networks.pdf">Relational inductive biases, deep learning, and graph networks P.W. Battaglia, J.B. Hamrick, V. Bapst, A. Sanchez-Gonzalez, V. Zambaldi, M. Malinowski, A. Tacchetti, D. Raposo, A. Santoro, R. Faulkner, C. Gulcehre, F. Song, A. Ballard, J. Gilmer, G. Dahl, A. Vaswani, K. Allen, C. Nash, V. Langston, C. Dyer, N. Heess, D. Wierstra, P. Kohli, M. Botvinick, O. Vinyals, Y. Li, R. Pascanu. 2018.</a></li><li><a href="https://dl.acm.org/doi/pdf/10.1145/174608.174610">Poulovassilis, A., &amp; Levene, M. (1994). <strong>A nested-graph model for the representation and manipulation of complex objects</strong>. ACM Transactions on Information Systems (TOIS), 12(1), 35-68.</a></li><li><a href="https://academic.oup.com/bioinformatics/article-pdf/34/13/i457/50316205/bioinformatics_34_13_i457.pdf">Zitnik, M., Agrawal, M., &amp; Leskovec, J. (2018). <strong>Modeling polypharmacy side effects with graph convolutional networks</strong>. Bioinformatics, 34(13), i457-i466.</a></li><li><a href="https://www.nature.com/articles/s41467-020-19267-x.pdf">Stocker, S., Csanyi, G., Reuter, K., &amp; Margraf, J. T. (2020). <strong>Machine learning in chemical reaction space</strong>. Nature communications, 11(1), 5505.</a></li></ol>]]></content>
    
    
    <categories>
      
      <category>ML</category>
      
    </categories>
    
    
    <tags>
      
      <tag>NWP</tag>
      
      <tag>ECMWF</tag>
      
      <tag>AI</tag>
      
      <tag>ML</tag>
      
      <tag>pytorch</tag>
      
      <tag>GNN</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ML | PyTorch</title>
    <link href="/2024/12/12/ML-pytorch/"/>
    <url>/2024/12/12/ML-pytorch/</url>
    
    <content type="html"><![CDATA[<h1 id="pytorch">PyTorch</h1><p>2017 年初由 Facebook 開源的另一套建立在 Torch 之上的深度學習框架 PyTorch 因其語法簡潔優雅、概念直觀和易上手的特性，甫推出便迅速走紅，儼然已成為瓜分深度學習市場的有力競爭者。</p><p>PyTorch is an optimized tensor library for deep learning using GPUs and CPUs. Automatic differentiation is done with a tape-based system at both a functional and neural network layer level. This functionality brings a high level of flexibility and speed as a deep learning framework and provides accelerated NumPy-like functionality.</p><p>To check if your GPU driver and CUDA/ROCm is enabled and accessible by PyTorch,</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> torch<br><br><span class="hljs-built_in">print</span>(torch.__version__)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;torch.cuda.is_available() = &quot;</span>, torch.cuda.is_available())<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;torch.cuda.device_count() = &quot;</span>, torch.cuda.device_count())<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;torch.cuda.current_device() =&quot;</span>, torch.cuda.current_device())<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;torch.cuda.device(0) = &quot;</span>, torch.cuda.device(<span class="hljs-number">0</span>))<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;torch.cuda.get_device_name(0) = &quot;</span>, torch.cuda.get_device_name(<span class="hljs-number">0</span>))<br></code></pre></td></tr></table></figure><p>General usage,</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># 导⼊包和版本查询</span><br><span class="hljs-keyword">import</span> torch <br><span class="hljs-keyword">import</span> torch.nn <span class="hljs-keyword">as</span> nn <br><span class="hljs-keyword">import</span> torchvision <br><br><span class="hljs-built_in">print</span>(torch.__version__) <br><span class="hljs-built_in">print</span>(torch.version.cuda) <br><span class="hljs-built_in">print</span>(torch.backends.cudnn.version()) <br><span class="hljs-built_in">print</span>(torch.cuda.get_device_name(<span class="hljs-number">0</span>))<br><br><br><span class="hljs-comment"># 可复现性在硬件设备（CPU、GPU）不同时，完全的可复现性⽆法保证，即使随机种⼦相同。但是，在同⼀个设备上，应该保证可复现性。具体做法是，在程序开始的时候固定torch的随机种⼦，同时也把numpy的随机种⼦固定。</span><br><br>np.random.seed(<span class="hljs-number">0</span>) <br>torch.manual_seed(<span class="hljs-number">0</span>) <br>torch.cuda.manual_seed_all(<span class="hljs-number">0</span>) <br>torch.backends.cudnn.deterministic = <span class="hljs-literal">True</span> <br>torch.backends.cudnn.benchmark = <span class="hljs-literal">False</span><br></code></pre></td></tr></table></figure><h1 id="example">Example</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-number">1.</span>导入Pyorch 库：<br><span class="hljs-comment"># 导入PyTorch库，用于构建和训练神经网络</span><br><span class="hljs-keyword">import</span> torch<br><span class="hljs-comment"># 导入神经网络模块，用于定义神经网络结构</span><br><span class="hljs-keyword">import</span> torch.nn <span class="hljs-keyword">as</span> nn<br><span class="hljs-comment"># 导入优化器模块，用于定义模型的优化算法</span><br><span class="hljs-keyword">import</span> torch.optim <span class="hljs-keyword">as</span> optim<br><span class="hljs-comment"># 导入函数al模块，用于使用各种激活函数和损失函数</span><br><span class="hljs-keyword">import</span> torch.nn.functional <span class="hljs-keyword">as</span> F<br><span class="hljs-comment"># 导入数据加载和数据集模块，用于处理和加载训练数据</span><br><span class="hljs-keyword">from</span> torch.utils.data <span class="hljs-keyword">import</span> DataLoader, Dataset<br><span class="hljs-comment"># 导入变换模块，用于对图像数据进行预处理</span><br><span class="hljs-keyword">from</span> torchvision <span class="hljs-keyword">import</span> transforms<br><br><span class="hljs-number">2.</span>检查 GPU 支持：<br><span class="hljs-comment"># 根据环境选择合适的计算设备</span><br>device = torch.device(<span class="hljs-string">&quot;cuda&quot;</span> <span class="hljs-keyword">if</span> torch.cuda.is_available() <span class="hljs-keyword">else</span> <span class="hljs-string">&quot;cpu&quot;</span>)<br><br><span class="hljs-number">3.</span>创建自定义数据集：<br><span class="hljs-keyword">class</span> <span class="hljs-title class_">CustomDataset</span>(<span class="hljs-title class_ inherited__">Dataset</span>):<br>    <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    自定义数据集类，继承自torch.utils.data.Dataset。</span><br><span class="hljs-string">    用于封装任意数据和其对应的标签，方便在神经网络模型中使用。</span><br><span class="hljs-string">    </span><br><span class="hljs-string">    参数:</span><br><span class="hljs-string">    - data: 数据集，可以是任意形式，如numpy数组或Pandas DataFrame。</span><br><span class="hljs-string">    - labels: 数据集的标签，通常是一个一维数组或列表。</span><br><span class="hljs-string">    - transform: 可选的数据转换函数，用于在获取数据项时对其进行转换。</span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, data, labels, transform=<span class="hljs-literal">None</span></span>):<br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        初始化自定义数据集类。</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        <span class="hljs-variable language_">self</span>.data = data<br>        <span class="hljs-variable language_">self</span>.labels = labels<br>        <span class="hljs-variable language_">self</span>.transform = transform<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__len__</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        返回数据集的大小。</span><br><span class="hljs-string">        </span><br><span class="hljs-string">        返回:</span><br><span class="hljs-string">        - 数据集的样本数量。</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">len</span>(<span class="hljs-variable language_">self</span>.data)<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__getitem__</span>(<span class="hljs-params">self, index</span>):<br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        根据索引获取数据项。</span><br><span class="hljs-string">        </span><br><span class="hljs-string">        参数:</span><br><span class="hljs-string">        - index: 索引值，用于获取数据集中的特定样本。</span><br><span class="hljs-string">        </span><br><span class="hljs-string">        返回:</span><br><span class="hljs-string">        - x: 数据项。</span><br><span class="hljs-string">        - y: 数据项的标签。</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        x = <span class="hljs-variable language_">self</span>.data[index]<br>        y = <span class="hljs-variable language_">self</span>.labels[index]<br><br>        <span class="hljs-comment"># 如果提供了数据转换函数，则应用该函数对数据项进行转换</span><br>        <span class="hljs-keyword">if</span> <span class="hljs-variable language_">self</span>.transform:<br>            x = <span class="hljs-variable language_">self</span>.transform(x)<br><br>        <span class="hljs-keyword">return</span> x, y<br><br><span class="hljs-number">4.</span>使用数据增强：<br><span class="hljs-comment"># 定义一个转换器，用于将图像转换为一系列预处理步骤的组合</span><br>transform = transforms.Compose([<br>    <span class="hljs-comment"># 随机水平翻转图像，增加数据集的多样性</span><br>    transforms.RandomHorizontalFlip(),<br>    <span class="hljs-comment"># 随机旋转图像，旋转角度在(-10, 10)之间，以增强模型的泛化能力</span><br>    transforms.RandomRotation(<span class="hljs-number">10</span>),<br>    <span class="hljs-comment"># 将图像转换为Tensor，以便于在PyTorch模型中使用</span><br>    transforms.ToTensor(),<br>])<br><br><span class="hljs-number">5.</span>数据加载：<br><span class="hljs-comment"># 创建训练数据集实例</span><br><span class="hljs-comment"># 参数:</span><br><span class="hljs-comment"># - train_data: 训练数据输入</span><br><span class="hljs-comment"># - train_labels: 训练数据标签</span><br><span class="hljs-comment"># - transform: 数据转换函数</span><br>train_dataset = CustomDataset(train_data, train_labels, transform=transform)<br><br><span class="hljs-comment"># 创建数据加载器</span><br><span class="hljs-comment"># 参数:</span><br><span class="hljs-comment"># - train_dataset: 训练数据集实例</span><br><span class="hljs-comment"># - batch_size: 每个批次的数据大小</span><br><span class="hljs-comment"># - shuffle: 是否在每个epoch开始时打乱数据顺序</span><br>train_loader = DataLoader(train_dataset, batch_size=<span class="hljs-number">64</span>, shuffle=<span class="hljs-literal">True</span>)<br><br><span class="hljs-number">6.</span>定义神经网络模型：<br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Net</span>(nn.Module):<br>    <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    定义一个神经网络模型。继承自torch.nn.Module。</span><br><span class="hljs-string">    该模型包括一个卷积层和两个全连接层。</span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        初始化模型并定义各层。</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        <span class="hljs-built_in">super</span>(Net, <span class="hljs-variable language_">self</span>).__init__()<br>        <span class="hljs-variable language_">self</span>.conv1 = nn.Conv2d(<span class="hljs-number">1</span>, <span class="hljs-number">32</span>, kernel_size=<span class="hljs-number">3</span>)  <span class="hljs-comment"># 卷积层：输入通道数1，输出通道数32，卷积核大小3x3</span><br>        <span class="hljs-variable language_">self</span>.fc1 = nn.Linear(<span class="hljs-number">32</span> * <span class="hljs-number">28</span> * <span class="hljs-number">28</span>, <span class="hljs-number">128</span>)  <span class="hljs-comment"># 全连接层：输入大小32*28*28，输出大小128</span><br>        <span class="hljs-variable language_">self</span>.fc2 = nn.Linear(<span class="hljs-number">128</span>, <span class="hljs-number">10</span>)  <span class="hljs-comment"># 全连接层：输入大小128，输出大小10</span><br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">forward</span>(<span class="hljs-params">self, x</span>):<br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        定义模型的前向传播过程。</span><br><span class="hljs-string">        :param x: 输入数据，一个张量</span><br><span class="hljs-string">        :return: 模型输出，一个张量</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        x = F.relu(<span class="hljs-variable language_">self</span>.conv1(x))  <span class="hljs-comment"># 经过卷积层后使用ReLU激活函数</span><br>        x = x.view(x.size(<span class="hljs-number">0</span>), -<span class="hljs-number">1</span>)  <span class="hljs-comment"># 将张量展平</span><br>        x = F.relu(<span class="hljs-variable language_">self</span>.fc1(x))  <span class="hljs-comment"># 经过第一个全连接层后使用ReLU激活函数</span><br>        x = <span class="hljs-variable language_">self</span>.fc2(x)  <span class="hljs-comment"># 第二个全连接层的输出，此处不使用激活函数</span><br>        <span class="hljs-keyword">return</span> x<br><br><span class="hljs-number">7.</span>实例化模型和优化器：<br><span class="hljs-comment">#实例化神经网络模型并转移到指定设备上</span><br>model = Net().to(device)  <br><br><span class="hljs-comment">#初始化优化器，使用Adam算法优化模型参数</span><br><span class="hljs-comment">#学习率设置为0.001，以适应大多数深度学习模型的训练需求</span><br>optimizer = optim.Adam(model.parameters(), lr=<span class="hljs-number">0.001</span>)<br><br><span class="hljs-number">8.</span>定义损失函数：<br><span class="hljs-comment"># 定义损失函数为交叉熵损失，用于分类任务中</span><br>criterion = nn.CrossEntropyLoss()<br><br><span class="hljs-number">9.</span>训练模型：<br><span class="hljs-comment"># 迭代训练模型，共进行num_epochs轮</span><br><span class="hljs-keyword">for</span> epoch <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(num_epochs):  <br>    <span class="hljs-comment"># 遍历训练数据加载器，获取批次索引、数据和目标标签</span><br>    <span class="hljs-keyword">for</span> batch_idx, (data, target) <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(train_loader):  <br>        <span class="hljs-comment"># 将数据和目标标签移动到指定设备（如GPU）</span><br>        data, target = data.to(device), target.to(device)  <br><br>        <span class="hljs-comment"># 清空梯度，避免累积</span><br>        optimizer.zero_grad()  <br>        <span class="hljs-comment"># 前向传播，获取模型输出</span><br>        output = model(data)  <br>        <span class="hljs-comment"># 计算模型输出与目标标签之间的损失</span><br>        loss = criterion(output, target)  <br>        <span class="hljs-comment"># 反向传播，计算梯度</span><br>        loss.backward()  <br>        <span class="hljs-comment"># 更新模型权重</span><br>        optimizer.step()  <br><br>        <span class="hljs-comment"># 按照日志间隔打印训练信息</span><br>        <span class="hljs-keyword">if</span> batch_idx % log_interval == <span class="hljs-number">0</span>:  <br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;Train Epoch: <span class="hljs-subst">&#123;epoch&#125;</span> [<span class="hljs-subst">&#123;batch_idx * <span class="hljs-built_in">len</span>(data)&#125;</span>/<span class="hljs-subst">&#123;<span class="hljs-built_in">len</span>(train_loader.dataset)&#125;</span> (<span class="hljs-subst">&#123;<span class="hljs-number">100.</span> * batch_idx / <span class="hljs-built_in">len</span>(train_loader):<span class="hljs-number">.0</span>f&#125;</span>%)]\tLoss: <span class="hljs-subst">&#123;loss.item():<span class="hljs-number">.6</span>f&#125;</span>&quot;</span>)<br><br><span class="hljs-number">10.</span>评估模型：<br>model.<span class="hljs-built_in">eval</span>()  <span class="hljs-comment"># 将模型设置为评估模式，以禁用dropout等仅在训练时需要的特性</span><br>test_loss = <span class="hljs-number">0</span>  <span class="hljs-comment"># 初始化测试损失为0</span><br>correct = <span class="hljs-number">0</span>  <span class="hljs-comment"># 初始化正确预测的数量为0</span><br><span class="hljs-keyword">with</span> torch.no_grad():  <span class="hljs-comment"># 在不需要计算梯度的上下文中进行评估，以减少内存消耗</span><br>    <span class="hljs-keyword">for</span> data, target <span class="hljs-keyword">in</span> test_loader:  <span class="hljs-comment"># 遍历测试数据集</span><br>        data, target = data.to(device), target.to(device)  <span class="hljs-comment"># 将数据和目标移动到指定设备</span><br>        output = model(data)  <span class="hljs-comment"># 前向传播，获取模型的输出</span><br>        test_loss += criterion(output, target).item()  <span class="hljs-comment"># 计算并累加测试损失</span><br>pred = output.argmax(dim=<span class="hljs-number">1</span>, keepdim=<span class="hljs-literal">True</span>)  <span class="hljs-comment"># 获取预测的类别索引</span><br>correct += pred.eq(target.view_as(pred)).<span class="hljs-built_in">sum</span>().item()  <span class="hljs-comment"># 计算并累加正确预测的数量</span><br><br>test_loss /= <span class="hljs-built_in">len</span>(test_loader.dataset)  <span class="hljs-comment"># 计算平均测试损失</span><br>test_accuracy = <span class="hljs-number">100.</span> * correct / <span class="hljs-built_in">len</span>(test_loader.dataset)  <span class="hljs-comment"># 计算测试准确率</span><br><br><span class="hljs-comment"># 打印测试集的平均损失和准确率</span><br><span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;Test set: Average loss: <span class="hljs-subst">&#123;test_loss:<span class="hljs-number">.4</span>f&#125;</span>, Accuracy: <span class="hljs-subst">&#123;correct&#125;</span>/<span class="hljs-subst">&#123;<span class="hljs-built_in">len</span>(test_loader.dataset)&#125;</span> (<span class="hljs-subst">&#123;test_accuracy:<span class="hljs-number">.0</span>f&#125;</span>%)&#x27;</span>)<br><br><span class="hljs-number">11.</span>保存和加载模型：<br><span class="hljs-comment"># 保存模型的参数状态</span><br>torch.save(model.state_dict(), <span class="hljs-string">&#x27;model.pth&#x27;</span>)  <br><br><span class="hljs-comment"># 实例化一个新的模型对象</span><br>model = Net()  <br><span class="hljs-comment"># 加载保存的模型参数状态到新的模型对象中</span><br>model.load_state_dict(torch.load(<span class="hljs-string">&#x27;model.pth&#x27;</span>))  <br><span class="hljs-comment"># 将模型移动到指定的设备上，例如CPU或GPU</span><br>model.to(device)<br><br><span class="hljs-number">12.</span>使用 GPU 加速：<br><span class="hljs-comment"># 将模型移动到指定设备上，以适应不同硬件环境（如GPU或CPU）</span><br>model = model.to(device)  <br><br><span class="hljs-comment"># 将数据移动到指定设备上，确保数据与模型在同一硬件环境</span><br>data = data.to(device)  <br><br><span class="hljs-comment"># 将目标值移动到指定设备上，保证目标与数据、模型一致</span><br>target = target.to(device)<br><br><span class="hljs-number">13.</span>使用 TensorBoard 进行可视化：<br><span class="hljs-keyword">from</span> torch.utils.tensorboard <span class="hljs-keyword">import</span> SummaryWriter<br>  <br><span class="hljs-comment"># 创建一个SummaryWriter对象，用于将训练过程中的损失和准确率等数据写入TensorBoard日志文件</span><br>writer = SummaryWriter()<br>  <br><span class="hljs-comment"># 遍历训练的每个周期(epoch)</span><br><span class="hljs-keyword">for</span> epoch <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(num_epochs):<br>    <span class="hljs-comment"># 进行训练和记录...</span><br>    <span class="hljs-comment"># 记录当前周期的训练损失</span><br>    writer.add_scalar(<span class="hljs-string">&#x27;Loss/train&#x27;</span>, loss.item(), epoch)<br>    <span class="hljs-comment"># 记录当前周期的训练准确率</span><br>    writer.add_scalar(<span class="hljs-string">&#x27;Accuracy/train&#x27;</span>, accuracy, epoch)<br>    <span class="hljs-comment"># ...</span><br>  <br><span class="hljs-comment"># 关闭SummaryWriter对象，确保所有数据被正确写入日志文件</span><br>writer.close()<br><br><span class="hljs-number">14.</span>调整学习率：<br><span class="hljs-comment"># 初始化学习率调度器，以便在训练过程中按策略调整学习率</span><br>scheduler = optim.lr_scheduler.StepLR(optimizer, step_size=<span class="hljs-number">10</span>, gamma=<span class="hljs-number">0.1</span>)  <br><br><span class="hljs-comment"># 开始训练过程，迭代指定的轮次</span><br><span class="hljs-keyword">for</span> epoch <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(num_epochs):  <br>    <span class="hljs-comment"># 更新学习率调度器，根据当前轮次调整学习率</span><br>    scheduler.step()  <span class="hljs-comment"># 更新学习率  </span><br>    <span class="hljs-comment"># 进行训练...</span><br><br><span class="hljs-number">15.</span>使用预训练模型：<br><span class="hljs-comment"># 导入torchvision中的models模块，用于访问预定义的模型架构和预训练模型</span><br><span class="hljs-keyword">import</span> torchvision.models <span class="hljs-keyword">as</span> models<br>  <br><span class="hljs-comment"># 初始化一个预训练的ResNet-18模型</span><br><span class="hljs-comment"># ResNet-18是一个深度卷积神经网络，具有18层，广泛应用于图像分类任务中</span><br><span class="hljs-comment"># 参数pretrained=True表示使用ImageNet数据集预训练的模型权重</span><br>model = models.resnet18(pretrained=<span class="hljs-literal">True</span>)<br><br><span class="hljs-number">16.</span>迁移学习：<br><span class="hljs-comment"># 遍历模型的所有参数</span><br><span class="hljs-keyword">for</span> param <span class="hljs-keyword">in</span> model.parameters():  <br>    param.requires_grad = <span class="hljs-literal">False</span>  <span class="hljs-comment"># 冻结模型参数，防止在训练过程中更新这些参数</span><br>  <br><span class="hljs-comment"># 替换最后的全连接层以适应新的类别数</span><br>model.fc = nn.Linear(model.fc.in_features, num_classes)<br></code></pre></td></tr></table></figure><h1 id="references">References</h1><ol type="1"><li><a href="https://dev.to/hyperkai/check-pytorch-version-cpu-and-gpucuda-in-pytorch-6jk">Check PyTorch version, CPU and GPU(CUDA) in PyTorch</a></li><li><a href="https://mp.weixin.qq.com/s/bcIC27Xo_LAaLUegElzOsg">Pytorch 高频使用代码集锦</a></li><li><a href="https://mp.weixin.qq.com/s/ydlzsZ3wuZt-0CRHeYy3GQ">包含代码逐行解读！PyTorch真的不难，常见的用法就这么多！</a></li></ol>]]></content>
    
    
    <categories>
      
      <category>ML</category>
      
    </categories>
    
    
    <tags>
      
      <tag>AI</tag>
      
      <tag>PINN</tag>
      
      <tag>DeepONet</tag>
      
      <tag>ML</tag>
      
      <tag>pytorch</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Maths | ROC Curves</title>
    <link href="/2024/12/10/maths-ROC/"/>
    <url>/2024/12/10/maths-ROC/</url>
    
    <content type="html"><![CDATA[<h1 id="roc-curve">ROC curve</h1><p>在訊號檢測理論中，<strong>接收者操作特徵曲線</strong>，或者叫 <strong>ROC 曲線</strong>（Receiver operating characteristic curve），是一種坐標圖式的分析工具，</p><ul><li>用於選擇最佳的訊號偵測模型 、</li><li>捨棄次佳的模型 或者</li><li>在同一模型中設置最佳閾值。</li></ul><p>在做決策時，ROC分析能不受成本／效益的影響，給出客觀中立的建議。</p><p>ROC曲線 (Receiver operating characteristic curve) 是第二次世界大戰中的發明，最初用在1941年的珍珠港事件，以偵測戰場上的日軍載具（飛機、船艦），其原理係利用雷達上的信號強弱設定閾值，以作為軍事行動的判斷依據，而發展出的信號偵測理論(Signal Detection Theory )，1950年代被應用在心理學領域。數十年來，ROC分析被用於醫學、無線電、生物學、犯罪心理學領域中，而且最近在機器學習（machine learning）和數據探勘（data mining）領域也得到了很好的發展。在醫學上，廣泛地應用在疾病的診斷，同時也被應用在流行病學、實證醫學研究、放射技術、社會科學的研究上。在臨床上可能會面對檢驗方法複雜、耗時、有侵入性、結果需要有經驗者才能準確判讀等因素，而利用ROC曲線發展出更簡易操作的替代方式，並與臨床認定的黃金標準(Gold standard)作比較，例如以癌症的切片檢查作為黃金標準，該標準將病人判定為罹癌與未罹癌，以鑑定新的診斷工具替代黃金標準的可行性。</p><div class="note note-danger">            <ul><li>A <strong>receiver operating characteristic curve</strong>, or <strong>ROC curve</strong>, is a graphical plot that illustrates the <strong>performance of a binary classifier model</strong> (can be used for multi class classification as well) at <strong>varying threshold values</strong>.</li><li>The ROC curve is the plot of the <strong>true positive rate (TPR) against the false positive rate (FPR) at each threshold setting</strong>.</li></ul>          </div><p>Terminology,</p><ul><li>True positive (TP)</li><li>False positive (FP)</li><li>True negative (TN)</li><li>False negative (FN)</li><li>The <code>true-positive rate</code> (TPR) is also known as <strong>sensitivity</strong> or <strong>probability of detection</strong>.</li><li>The <code>false-positive rate</code> (FPR) is also known as the <strong>probability of false alarm</strong> and equals <strong>(1 − specificity)</strong>.</li><li><code>ROC</code> is also known as a relative operating characteristic curve, because it is a comparison of two operating characteristics (TPR and FPR) as the criterion changes.</li></ul><p>在信號偵測理論中，ROC曲線是以圖像的方式<strong>呈現二分類系統(binary classifier system)在特定的分類或閾值(discrimination threshold)下的表現</strong>。</p><ul><li>圖形的縱軸(y-axis)為真陽性率(true positive rate; TPR)，又稱為敏感度(sensitivity)；</li><li>橫軸(x-axis)為偽陽性率(false-posiitive rate; FPR)，以1 – 特異度(specificity)表示，</li></ul><p>而敏感度為將結果正確判斷為陽性的機率，特異度係將結果正確判斷為負向或陰性的機率。當指定一個分界點(cut-point)來區分檢驗的陽性與陰性時，這個分界點會影響到診斷工具的敏感度(sensitivity)及特異度(specificity)。在醫學上，敏感度表示有病者被判為陽性的機率，而特異度表示無病者被判為陰性的機率。在曲線上的任何一個點都會對應到一組敏感度與1-特異度，<strong>而敏感度與特異度會受到分界點移動的影響</strong>。</p><div class="note note-danger">            <p><strong>Each prediction result or instance of a confusion matrix represents one point in the ROC space.</strong></p>          </div><p>In the field of machine learning and specifically the problem of statistical classification, a <code>confusion matrix</code>, also known as <strong>error matrix</strong>.</p><div class="note note-danger">            <p><strong>By adjusting the threshold used by this classifier, we can get a curve passing through (0, 0) and (1, 1)</strong>. <em>This is the ROC curve of this classifier</em>.</p>          </div><h2 id="roc-curve-equation">ROC Curve Equation</h2><p>The ROC curve is based on two key metrics:</p><ul><li><p><strong>True Positive Rate (TPR)</strong>, also known as Sensitivity: <span class="math display">\[\text{TPR} = \frac{\text{True Positives (TP)}}{\text{True Positives (TP)} + \text{False Negatives (FN)}}\]</span></p></li><li><p><strong>False Positive Rate (FPR)</strong>: <span class="math display">\[\text{FPR} = \frac{\text{False Positives (FP)}}{\text{False Positives (FP)} + \text{True Negatives (TN)}}\]</span></p></li></ul><p>The ROC curve is a plot of TPR against FPR at various threshold settings. Each point on the ROC curve corresponds to a different threshold, showing the trade-off between sensitivity and specificity. The area under the ROC curve (AUC) quantifies the overall ability of the model to discriminate between positive and negative classes.</p><p><img src="https://upload.wikimedia.org/wikipedia/commons/thumb/4/4f/ROC_curves.svg/1024px-ROC_curves.svg.png" alt="\hat{y} is model, y is actual value" width="600" /> <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/1/13/Roc_curve.svg/1024px-Roc_curve.svg.png" width="600" /></p><h1 id="auc-area-under-roc-curve">AUC (Area Under roc Curve)</h1><p>一般情況下，這個曲線都應該處於(0, 0)和(1, 1)連線的上方。因為(0, 0)和(1, 1)連線形成的ROC曲線實際上代表的是一個隨機分類器。如果很不幸，你得到一個位於此直線下方的分類器的話，<strong>一個直觀的補救辦法就是把所有的預測結果反向，即：分類器輸出結果為正類，則最終分類的結果為負類</strong>，反之，則為正類。雖然，用ROC 曲線來表示分類器的效能很直覺好用。可是，人們總是希望有一個數值來標示分類器的好壞。於是Area Under roc Curve(AUC)就出現了。顧名思義，AUC的值就是處於ROC 曲線下方的那部分面積的大小。通常，AUC的值介於0.5到1.0之間，較大的AUC代表了較好的表現。 AUC（Area Under roc Curve）是用來度量分類模型好壞的一個標準。</p><h1 id="roc-vs-pr">ROC vs PR</h1><p>The equations for the ROC (Receiver Operating Characteristic) curve and the PR (Precision-Recall) curve are derived from their respective metrics used to assess the performance of binary classifiers.</p><h2 id="pr-curve-equation">PR Curve Equation</h2><p>The PR curve focuses on two different metrics:</p><ul><li><p><strong>Precision</strong>: <span class="math display">\[\text{Precision} = \frac{\text{True Positives (TP)}}{\text{True Positives (TP)} + \text{False Positives (FP)}}\]</span></p></li><li><p><strong>Recall</strong> (which is equivalent to TPR): <span class="math display">\[\text{Recall} = \frac{\text{True Positives (TP)}}{\text{True Positives (TP)} + \text{False Negatives (FN)}}\]</span></p></li></ul><p>The PR curve is a plot of <strong>Precision against Recall</strong> at <strong>various thresholds</strong>. This curve is particularly useful in scenarios where the positive class is rare or when false positives are more critical than false negatives. The area under the PR curve (AUC-PR) provides a summary measure of the model's ability to maintain precision across different levels of recall.</p><p><img src="https://upload.wikimedia.org/wikipedia/commons/thumb/2/26/Precisionrecall.svg/525px-Precisionrecall.svg.png" width="400" /></p><h2 id="summary">Summary</h2><p>In summary, both curves provide valuable insights into classifier performance, but they focus on different aspects: - The <strong>ROC curve</strong> evaluates the balance between sensitivity and specificity. - The <strong>PR curve</strong> emphasizes the trade-off between precision and recall, making it more suitable for imbalanced datasets.</p><p>The <strong>ROC (Receiver Operating Characteristic) curve</strong> and the <strong>Precision-Recall (PR) curve</strong> are both essential tools for evaluating the performance of binary classification models, but they serve different purposes and are suited to different scenarios. Here are the key differences:</p><h2 id="key-differences-between-roc-and-pr-curves">Key Differences Between ROC and PR Curves</h2><ol type="1"><li><strong>Focus on Class Distribution</strong>:<ul><li><strong>ROC Curve</strong>: This curve plots the True Positive Rate (TPR) against the False Positive Rate (FPR) across various threshold settings. <strong>It considers both positive and negative classes equally, making it suitable for balanced datasets where both classes are important</strong>.</li><li><strong>PR Curve</strong>: In contrast, the PR curve focuses specifically on the positive class by plotting Precision (the proportion of true positive predictions among all positive predictions) against Recall (the proportion of actual positives correctly identified). <strong>This makes it particularly useful in scenarios with imbalanced datasets</strong>, where the positive class is rare or more critical.</li></ul></li><li><strong>Interpretation of Metrics</strong>:<ul><li><strong>ROC Curve</strong>: The area under the ROC curve (AUC-ROC) provides a single measure of overall model performance, indicating how well the model distinguishes between classes regardless of their distribution[3][4].</li><li><strong>PR Curve</strong>: The area under the PR curve (AUC-PR) reflects the model's ability to maintain high precision while capturing as many true positives as possible. It is especially informative when false positives carry significant consequences, such as in fraud detection or medical diagnoses[2][6].</li></ul></li><li><strong>Performance Visualization</strong>:<ul><li><strong>ROC Curve</strong>: The ROC curve can sometimes present an overly optimistic view of a model's performance in highly imbalanced datasets because it accounts for true negatives that may not be relevant in such cases[1][3].</li><li><strong>PR Curve</strong>: The PR curve provides a clearer picture of performance when dealing with imbalanced classes, as it directly relates to the positive class's prediction quality without being influenced by the large number of true negatives[2][6].</li></ul></li><li><strong>Use Cases</strong>:<ul><li><strong>ROC Curve</strong>: Best used when you want to evaluate a model's performance across different thresholds in balanced datasets or when both classes are equally important. It is also useful for comparing multiple models[3][4].</li><li><strong>PR Curve</strong>: More appropriate for applications where the positive class is significantly less frequent than the negative class, such as in medical testing for rare diseases or fraud detection, where maximizing precision and recall for the minority class is crucial[1][2][3].</li></ul></li></ol><h2 id="conclusion">Conclusion</h2><p>In summary, while both ROC and PR curves are valuable for assessing binary classifiers, they cater to different needs based on class distribution and specific evaluation goals. <strong>ROC curves are ideal for balanced datasets</strong>, whereas <strong>PR curves excel in situations with significant class imbalance</strong>, providing deeper insights into model performance related to the positive class. Leveraging both curves can offer a comprehensive understanding of a model's strengths and weaknesses.</p><h2 id="深入介紹及比較roc曲線及pr曲線"><a href="https://medium.com/nlp-tsupei/roc-pr-%E6%9B%B2%E7%B7%9A-f3faa2231b8c">深入介紹及比較ROC曲線及PR曲線</a></h2><ul><li>ROC Curves 適合類別平均的情況，而 PR Curves 適合於類別不平均的情況</li><li>AUC (Area under curve) 可以當作一個判斷整體模型能力(skill)的指標</li><li>可以直接比較不同模型在不同Threshold下的Skill</li><li><strong>ROC 曲線同時考慮了正例以及負例</strong>，因此適用於評估分類器整體的效能，<strong>而 PR 曲線則專注於正例</strong>，若是在類別平均且正例及負例的判斷都重要的情況下，ROC 曲線是不錯的選擇</li><li>由於 ROC 曲線的 X 軸使用到了 FPR，在類別不平均的情況下(負樣本較多)，使得 FPR 的增長會被稀釋，會導致 ROC 曲線呈現出過度樂觀的結果，因此在類別不平均的情況下，PR 曲線會是較好的選擇</li></ul><h1 id="圖解-roc-曲線精通-roc-與-auc-用法輕鬆記熟定義"><a href="https://haosquare.com/roc-curve/">圖解 ROC 曲線：精通 ROC 與 AUC 用法、輕鬆記熟定義</a></h1><ul><li>分類模型只會輸出機率，不會真的幫你「分類」</li><li>在機器學習領域的分類問題，我們通常會把分析模型稱為分類器（Classifier），好像模型會幫我們做好分類一樣，但實際上不是如此！不論是 貝氏分類器、或者羅吉斯回歸，<strong>統計模型只負責輸出機率，最後要怎麼分類是決策者的職責</strong>。認清這點，就能理解 ROC 曲線的價值了。</li><li>對於不同資料使用場景，決策的閾值（Threshold 或者 Cut-off）—也就是機率門檻值—將會不同，<strong>ROC 曲線的核心目標正是要呈現不同閾值會對你的決策品質造成什麼影響</strong>。</li><li>（補充：正負樣本是針對二分類問題的真實資料而言，正樣本的意思是真實答案為正向；例如真實資料顯示有下雨；反之為負樣本，例如資料顯示實際上沒有下雨）</li><li>以上兩數據都是基於「決策者預測結果為正樣本」</li><li>我們作為決策者當然只在乎預測為正樣本的情形！</li><li>這則筆記前面強調過分類模型只會輸出機率，不會真的幫你分類，而分類的決策又取決於閾值（機率的門檻值），ROC 曲線的目標是要呈現不同閾值會造成什麼不同的決策品質。</li><li>實際上，AUC 除了在圖形上代表面積，其數據亦存在數學意義：AUC 代表隨機一個（答案為）正樣本被預測出的分數高於隨機一個（答案為）負樣本的機率。更囉唆地解釋：先隨機選一個已知答案為正的樣本，再隨機選一個已知答案為負的樣本，AUC 代表分類器預測此正樣本比此負樣本更可能為正樣本的機率。值得注意的是，AUC 的此數學意義同樣與閾值無關、不受閾值選擇限制喔！</li><li>一條 ROC 曲線：單一個分類器比較不同閾值的成效</li><li>多條 ROC 曲線：用 AUC 比較多個分類器整體表現</li></ul><h1 id="references">References</h1><ol type="1"><li><a href="https://en.wikipedia.org/wiki/Receiver_operating_characteristic">ROC</a></li><li><a href="https://estat.pixnet.net/blog/post/61795603">ROC曲線 (Receiver Operating Characteristic Curve)</a></li><li><a href="https://sub.daais.sinica.edu.tw/download/jriaaward/34.pdf">疾病篩檢診斷工具之評估：從ROC 曲線到 Lorenz 曲線到 Kullback-Leibler 距離</a></li><li><a href="https://medium.com/nlp-tsupei/roc-pr-%E6%9B%B2%E7%B7%9A-f3faa2231b8c">深入介紹及比較ROC曲線及PR曲線</a></li><li><a href="https://haosquare.com/roc-curve/">(<strong>推薦</strong>)| 圖解 ROC 曲線：精通 ROC 與 AUC 用法、輕鬆記熟定義</a></li><li><a href="https://haosquare.com/roc-curve-best-cutoff/">ROC 曲線上的最佳閾值：Youden Index 與圖解法介紹</a></li><li><a href="https://cloud.tencent.com/developer/article/1747389">什么是ROC曲线？为什么要使用ROC?以及 AUC的计算</a></li></ol>]]></content>
    
    
    <categories>
      
      <category>Maths</category>
      
    </categories>
    
    
    <tags>
      
      <tag>NWP</tag>
      
      <tag>AI</tag>
      
      <tag>ML</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>MPAS | Smagorinsky turbulence model | Eddy viscosity</title>
    <link href="/2024/12/10/MPAS-eddy-viscosity-in-the-Smagorinsky-turbulence-model/"/>
    <url>/2024/12/10/MPAS-eddy-viscosity-in-the-Smagorinsky-turbulence-model/</url>
    
    <content type="html"><![CDATA[<h1 id="large-eddy-simulation-les">Large eddy simulation (LES)</h1><p>Large eddy simulation (LES) is a mathematical model for turbulence used in computational fluid dynamics. It was initially proposed in <strong>1963 by Joseph Smagorinsky to simulate atmospheric air currents</strong>, and <strong>first explored by Deardorff (1970)</strong>. LES is currently applied in a wide variety of engineering applications, including combustion,acoustics, and simulations of the atmospheric boundary layer.</p><p>The principal idea behind LES is to reduce the computational cost by ignoring the smallest length scales, which are the most computationally expensive to resolve, via low-pass filtering of the Navier–Stokes equations. Such a low-pass filtering, which can be viewed as a time- and spatial-averaging, effectively removes small-scale information from the numerical solution. This information is not irrelevant, however, and its effect on the flow field must be modelled, a task which is an active area of research for problems in which small-scales can play an important role.</p><h1 id="smagorinskylilly-model">Smagorinsky–Lilly model</h1><p>The first sub-grid scales (SGS) model developed was the <strong>Smagorinsky–Lilly SGS model</strong>, which was developed by Joseph Smagorinsky and used in the first LES simulation by Deardorff. It models the eddy viscosity as:</p><p><span class="math display">\[\nu_\mathrm{t} = C \Delta^2\sqrt{2\bar{S}_{ij}\bar{S}_{ij}} = C \Delta^2 \left| \bar{S} \right|\]</span></p><p>where <span class="math inline">\(\Delta\)</span> is the grid size and <span class="math inline">\(C\)</span> is a constant.</p><p>This method assumes that the energy production and dissipation of the small scales are in equilibrium - that is, <span class="math inline">\(\epsilon\)</span>, the dissipation of kinetic energy.</p><h1 id="mpas-a">MPAS-A</h1><ol type="1"><li>Only horizontal mixing.</li></ol><ul><li><code>MPAS-Model/src/core_atmosphere/Registry.xml</code>,</li></ul><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">nml_option</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;config_horiz_mixing&quot;</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;character&quot;</span> <span class="hljs-attr">default_value</span>=<span class="hljs-string">&quot;2d_smagorinsky&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">units</span>=<span class="hljs-string">&quot;-&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">description</span>=<span class="hljs-string">&quot;Formulation of horizontal mixing&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">possible_values</span>=<span class="hljs-string">&quot;`2d_fixed&#x27; or `2d_smagorinsky&#x27;&quot;</span>/&gt;</span><br><br><span class="hljs-tag">&lt;<span class="hljs-name">nml_option</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;config_len_disp&quot;</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;real&quot;</span> <span class="hljs-attr">default_value</span>=<span class="hljs-string">&quot;0.0&quot;</span> <span class="hljs-attr">in_defaults</span>=<span class="hljs-string">&quot;false&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">units</span>=<span class="hljs-string">&quot;m&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">description</span>=<span class="hljs-string">&quot;Horizontal length scale, used by the Smagorinsky formulation of horizontal diffusion and by 3-d divergence damping&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">possible_values</span>=<span class="hljs-string">&quot;Positive real values. A zero value implies that the length scale is prescribed by the nominalMinDc value in the input file.&quot;</span>/&gt;</span><br><br><br><span class="hljs-tag">&lt;<span class="hljs-name">nml_option</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;config_smagorinsky_coef&quot;</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;real&quot;</span> <span class="hljs-attr">default_value</span>=<span class="hljs-string">&quot;0.125&quot;</span> <span class="hljs-attr">in_defaults</span>=<span class="hljs-string">&quot;false&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">units</span>=<span class="hljs-string">&quot;-&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">description</span>=<span class="hljs-string">&quot;Dimensionless empirical parameter relating the strain tensor to the eddy viscosity in the Smagorinsky turbulence model&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">possible_values</span>=<span class="hljs-string">&quot;Real values typically in the range 0.1 to 0.4&quot;</span>/&gt;</span><br><br><span class="hljs-tag">&lt;<span class="hljs-name">var</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;kdiff&quot;</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;real&quot;</span> <span class="hljs-attr">dimensions</span>=<span class="hljs-string">&quot;nVertLevels nCells Time&quot;</span> <span class="hljs-attr">units</span>=<span class="hljs-string">&quot;m^2 s^&#123;-1&#125;&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">description</span>=<span class="hljs-string">&quot;Smagorinsky horizontal eddy viscosity&quot;</span>/&gt;</span><br></code></pre></td></tr></table></figure><ul><li><code>MPAS-Model/src/core_atmosphere/dynamics/mpas_atm_time_integration.F</code>,</li></ul><figure class="highlight fortran"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs Fortran">   <span class="hljs-comment">! Output: tend - tendencies: tend_u, tend_w, tend_theta and tend_rho</span><br>   <span class="hljs-comment">!                these are all coupled-variable tendencies.</span><br>   <span class="hljs-comment">!         various other quantities in diag: Smagorinsky eddy viscosity</span><br>......<br>   <span class="hljs-keyword">call</span> mpas_pool_get_config(configs, <span class="hljs-string">&#x27;config_smagorinsky_coef&#x27;</span>, c_s)<br>......<br><br>         <span class="hljs-comment">! Smagorinsky eddy viscosity, based on horizontal deformation (in this case on model coordinate surfaces).</span><br>         <span class="hljs-comment">! The integration coefficients were precomputed and stored in defc_a and defc_b</span><br><br>         <span class="hljs-keyword">if</span>(config_horiz_mixing == <span class="hljs-string">&quot;2d_smagorinsky&quot;</span>) <span class="hljs-keyword">then</span><br>            <span class="hljs-keyword">do</span> iCell = cellStart,cellEnd<br>               d_diag(<span class="hljs-number">1</span>:nVertLevels) = <span class="hljs-number">0.0</span><br>               d_off_diag(<span class="hljs-number">1</span>:nVertLevels) = <span class="hljs-number">0.0</span><br>               <span class="hljs-keyword">do</span> iEdge=<span class="hljs-number">1</span>,nEdgesOnCell(iCell)<br>                  <span class="hljs-keyword">do</span> k=<span class="hljs-number">1</span>,nVertLevels<br>                     d_diag(k)     = d_diag(k)     + defc_a(iEdge,iCell)*u(k,EdgesOnCell(iEdge,iCell))  &amp;<br>                                                   - defc_b(iEdge,iCell)*v(k,EdgesOnCell(iEdge,iCell))<br>                     d_off_diag(k) = d_off_diag(k) + defc_b(iEdge,iCell)*u(k,EdgesOnCell(iEdge,iCell))  &amp;<br>                                                   + defc_a(iEdge,iCell)*v(k,EdgesOnCell(iEdge,iCell))<br>                  <span class="hljs-keyword">end</span> <span class="hljs-keyword">do</span><br>               <span class="hljs-keyword">end</span> <span class="hljs-keyword">do</span><br><span class="hljs-comment">!DIR$ IVDEP</span><br>               <span class="hljs-keyword">do</span> k=<span class="hljs-number">1</span>, nVertLevels<br>                  <span class="hljs-comment">! here is the Smagorinsky formulation, </span><br>                  <span class="hljs-comment">! followed by imposition of an upper bound on the eddy viscosity</span><br>                  kdiff(k,iCell) = <span class="hljs-built_in">min</span>((c_s * config_len_disp)**<span class="hljs-number">2</span> * <span class="hljs-built_in">sqrt</span>(d_diag(k)**<span class="hljs-number">2</span> + d_off_diag(k)**<span class="hljs-number">2</span>),(<span class="hljs-number">0.01</span>*config_len_disp**<span class="hljs-number">2</span>) * invDt)<br>               <span class="hljs-keyword">end</span> <span class="hljs-keyword">do</span><br>            <span class="hljs-keyword">end</span> <span class="hljs-keyword">do</span><br><br>            h_mom_eddy_visc4   = config_visc4_2dsmag * config_len_disp**<span class="hljs-number">3</span><br>            h_theta_eddy_visc4 = h_mom_eddy_visc4<br><br>         <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(config_horiz_mixing == <span class="hljs-string">&quot;2d_fixed&quot;</span>) <span class="hljs-keyword">then</span><br><br>            kdiff(<span class="hljs-number">1</span>:nVertLevels,cellStart:cellEnd) = config_h_theta_eddy_visc2<br>            h_mom_eddy_visc4 = config_h_mom_eddy_visc4<br>            h_theta_eddy_visc4 = config_h_theta_eddy_visc4<br><br>         <span class="hljs-keyword">end</span> <span class="hljs-keyword">if</span><br>......<br></code></pre></td></tr></table></figure><h1 id="wrf">WRF</h1><ol type="1"><li>sub-grid turbulence (constant K diffusion/ 2-D Smagorinsky/ predicted TKE /2-D, 6th order diffusion / Nonlinear Backscatter Anisotropic (NBA) sub-grid turbulence stress for LES )</li></ol><ul><li><code>run/README.namelist</code>, <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs namelist">km_opt(max_dom) = 1,! eddy coefficient option<br>                1 = constant (use khdif kvdif)<br>                2 = 1.5 order TKE closure (3D)<br>                3 = Smagorinsky first order closure (3D)<br>                    Note: option 2 and 3 are not recommended for DX &gt; 2 km<br>                4 = horizontal Smagorinsky first order closure<br>                    (recommended for real-data cases)<br>c_s (max_dom) = 0.25     ! Smagorinsky coeff<br></code></pre></td></tr></table></figure></li></ul><h2 id="wrf-les">WRF-LES</h2><p>WRF provides a capability for ideal LES simulation. Please take a look at the WRF/test/em_les/README.les to get some idea how it works. Note that real-data LES simulation could be more complicated.</p><ul><li><code>WRF/test/em_real/namelist.input.pbl-les</code>,</li><li><code>WRF/test/em_les/README.les</code> --&gt; The ideal em_les test case</li></ul><ol type="1"><li><a href="https://www2.mmm.ucar.edu/wrf/users/tutorial/presentation_pdfs/202101/dudhia_physics_pbl_turbulence.pdf">(<strong>Important</strong>) | Overview of WRF Physics Boundary Layer and Turbulence | 2021Jimy Dudhia NCAR/MMM</a><ol type="1"><li>P.26-</li><li>For grid sizes of up to about 100 m, LES is preferable</li><li>LES treats turbulence three-dimensionally instead of separate vertical (PBL) and horizontal diffusion schemes</li></ol></li></ol><h1 id="references">References</h1><ol type="1"><li>Skamarock, W. C., Klemp, J. B., Duda, M. G., Fowler, L. D., Park, S., &amp; Ringler, T. D. (2012). A Multiscale Nonhydrostatic Atmospheric Model Using Centroidal Voronoi Tesselations and C-Grid Staggering. Monthly Weather Review, 140(9), 3090-3105. <a href="https://doi.org/10.1175/MWR-D-11-00215.1" class="uri">https://doi.org/10.1175/MWR-D-11-00215.1</a><ol type="1"><li>The horizontal filtering formulation of Smagorinsky (1963) uses the second-order Laplacians along with an eddy viscosity</li></ol></li></ol>]]></content>
    
    
    <categories>
      
      <category>MPAS</category>
      
    </categories>
    
    
    <tags>
      
      <tag>HPC</tag>
      
      <tag>NWP</tag>
      
      <tag>WRF</tag>
      
      <tag>MPAS</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>WRF | MPAS | MPI | halo/ghost cell</title>
    <link href="/2024/12/07/wrf-mpas-MPI-halocell-ghostcell/"/>
    <url>/2024/12/07/wrf-mpas-MPI-halocell-ghostcell/</url>
    
    <content type="html"><![CDATA[<h1 id="message-passing-interface-mpi">Message Passing Interface (MPI)</h1><p>訊息傳遞介面（Message Passing Interface，縮寫MPI）是一個平行計算的應用程式介面（API），常在超級電腦、電腦叢集等<strong>非共用主記憶體環境</strong>程式設計。</p><p>The message passing interface effort began in the summer of <strong>1991</strong> when a small group of researchers started discussions at a mountain retreat in Austria. Out of that discussion came a Workshop on Standards for Message Passing in a <strong>Distributed Memory Environment</strong>, held on April 29–30, <strong>1992</strong> in Williamsburg, Virginia.</p><p>MPI is a communication protocol for programming parallel computers.</p><h1 id="numerical-approach">Numerical Approach</h1><h2 id="the-problem-diffusion-in-a-two-dimensional-domain">The problem: diffusion in a two-dimensional domain</h2><p><span class="math display">\[\frac{\partial{u}}{\partial{t}} = D\left(\frac{\partial^2{u}}{\partial{x^2}} + \frac{\partial^2{u}}{\partial{y^2}}\right) \tag{1}\]</span></p><p>and apply the finite difference mehtod and above equation is expressed as,</p><p><span class="math display">\[ \frac{u_{i,k}^{j+1} - 2u_{i,k}^{j}}{\Delta t} = D \left(\frac{u_{i+1,k}^j-2u_{i,k}^j+u_{i-1,k}^j}{\Delta x^2}+ \frac{u_{i,k+1}^j-2u_{i,k}^j+u_{i,k-1}^j}{\Delta y^2}\right)\tag{2}\]</span></p><p>Equation (2) is really all is needed in order to find the solution across the whole domain at each subsequent time step. It is rather easy to implement a code that does this sequentially, with one process (CPU). <strong>However, here we want to discuss a parallel implementation that uses multiple processes</strong>.</p><p><img src="https://i.imgur.com/EIfd3nA.png" width="400" /></p><h2 id="use-mutiple-cores-mpi">Use mutiple cores, MPI,</h2><p>It shows how processes #0 and #1 will need to communicate in order to evaluate the solution near the boundary. This is where MPI enters. In the next section, we are going to look at an efficient way of communicating.</p><ul><li>Two neighboring processes need to communicate in order to find the solution near the boundary. Process #0 needs to know the value of the solution in B in order to calculate the solution at the grid point A. Similarly, process #1 needs to know the value at point C in order to calculate the solution at the grid point D. These values are unknown by the processes, until communication between processes #0 and #1 occurs.</li></ul><p><img src="https://i.imgur.com/gwauub0.png" width="400" /></p><h2 id="communication-among-processes-ghost-cells">Communication among processes: ghost cells</h2><p>Halo cells/ghost cells are additional grid points added around the edges of the computational domain to extend the grid beyond the physical boundaries of the model. They are crucial for ensuring that calculations at the boundaries can utilize information from adjacent grid points, which may not be directly part of the simulation domain.</p><p><img src="https://i.imgur.com/5b51gg2.png" width="400" /></p><figure><img src="https://i.imgur.com/SLlYNCN.png" alt="Non-uniform grid (top figure) decomposed into two uniform grids using a ghost cells generated for the data exchange (bottom figure)(from [35]). (from Perović, N., Frisch, J., Salama, A., Sun, S., Rank, E., &amp; Mundani, R. P. (2017). Multi-scale high-performance fluid flow: Simulations through porous media. Advances in Engineering Software, 103, 85-98.)" width="600" /><figcaption>Non-uniform grid (top figure) decomposed into two uniform grids using a ghost cells generated for the data exchange (bottom figure)(from [35]). (from Perović, N., Frisch, J., Salama, A., Sun, S., Rank, E., &amp; Mundani, R. P. (2017). Multi-scale high-performance fluid flow: Simulations through porous media. Advances in Engineering Software, 103, 85-98.)</figcaption></figure><p>An important notion in computational fluid dynamics is the one of <strong>ghost cells</strong>. This concept is useful whenever the <strong>spatial domain is decomposed into multiple sub-domains</strong>, each of which is solved by one process.</p><p><strong>Here is the problem</strong>: it is very <strong>inefficient</strong> to have process #0 and process #1 <strong>communicate each time</strong> they need a node from the neighboring process: it would result in an <strong>unacceptable communication overhead</strong>.</p><p>Instead, what is common practice is to surround the “real” sub-domains with extra cells called <strong>ghost cells</strong>.</p><div class="note note-danger">            <p>These <strong>ghost cells</strong> represent <strong>copies</strong> of the solution at the boundaries of neighboring sub-domains.</p>          </div><p>At each time step, the old boundary of each sub-domain is passed to its neighbors. This allows the new solution at the boundary of a sub-domain to be calculated with a significantly reduced communication overhead. The net effect is a speedup in the code.</p><ul><li>Communication among processes without (left) and with (right) ghost cells. Without ghost cells, each cell on the boundary of a sub-domain needs to pass its own message to a neighboring process. <strong>Using ghost cells allows to minimize the number of messages passed</strong>, as many cells belonging to the boundaries of a process are exchanged at once with a single message. Here, for example, Process #0 is passing its entire North boundary to Process #1, and its entire East boundary to Process #2.</li></ul><p><img src="https://i.imgur.com/pYIM9km.png" width="500" /></p><h1 id="wrf">WRF</h1><h2 id="three-level-domain-decomposition-of-wrf">Three level domain decomposition of WRF</h2><p>The entire study area in the WRF is called a <strong>domain</strong>. The subdomain obtained by dividing the domain with processes is called a <strong>patch</strong>, <em>a process known as domain decomposition</em>. The subdomains are assigned to each process. The patch can also be subdivided into <strong>tiles</strong>, <em>a process known as tile division</em>.</p><p><img src="https://i.imgur.com/XgaxGpW.png" width="400" /></p><p>WRF uses</p><ul><li><code>nproc_x</code> to denote the <em>number of processes</em> in the <strong>east–west direction</strong> of the domain and</li><li><code>nproc_y</code> to denote the <em>number of processes</em> in the <strong>north–south</strong> direction of the domain.</li></ul><p>The domain decomposition should follow the following condition:</p><p><span class="math display">\[\mbox{n} = \mbox{nproc}_x \times \mbox{nproc}_y\tag{3}\]</span></p><p><img src="https://i.imgur.com/SqQhBMB.png" width="500" /></p><h3 id="performance-analysis-and-optimizations-of-the-weather-research-and-forecasting-wrf-model-2018"><a href="https://www.cisl.ucar.edu/sites/default/files/2021-09/Dixit_Patel_Presentation.pdf">Performance Analysis and Optimizations of the Weather Research and Forecasting (WRF) Model | 2018</a></h3><ul><li><strong>Intel</strong> 18.0.1 + SGI MPT 2.18 gives best performance</li><li><strong>Compiler Optimizations</strong><ul><li>GNU : <code>-ofast</code></li><li>Intel : <code>-xHost -fp-model fast =2</code></li></ul></li><li><strong>Hyperthreaded runs lowered model performance</strong></li></ul><div class="group-image-container"><div class="group-image-row"><div class="group-image-wrap"><img src="https://i.imgur.com/jNWRgGL.png" alt="1" /></div><div class="group-image-wrap"><img src="https://i.imgur.com/QH6rJCB.png" alt="2" /></div></div><div class="group-image-row"><div class="group-image-wrap"><img src="https://i.imgur.com/QsOLIMW.png" alt="3" /></div><div class="group-image-wrap"><img src="https://i.imgur.com/EG86Edj.png" alt="4" /></div></div></div><ul><li>Scalability Summary</li></ul><p><img src="https://i.imgur.com/82xzzGC.png" width="600" /></p><h3 id="tutorial-notes-wrf-software-2.1"><a href="http://danida.vnu.edu.vn/cpis/files/Refs/WRF/WRF%20Software.pdf">Tutorial Notes: WRF Software 2.1</a></h3><ul><li>WRF can be run serially or as a parallel job</li><li>WRF uses <strong>domain decomposition</strong> to divide total amount of work over parallel processes • Since the process model has two levels (heavy-weight and light-weight = MPI and OpenMP), the decomposition of the application over processes has two levels:<ul><li>The <strong>domain</strong> is first broken up into rectangular pieces that are assigned to heavy-weight processes. These pieces are called <strong>patches</strong></li><li>The <strong>patches</strong> may be further subdivided into smaller rectangular pieces that are called <strong>tiles</strong>, and these are assigned to <strong>threads</strong> within the process.</li></ul></li><li>Model domains are decomposed for parallelism on two-levels<ul><li><strong>Patch</strong>: section of model domain a located to a <strong>distributed memory node</strong>, this is the scope of a mediation layer solver or physics driver.</li><li><strong>Tile</strong>: section of a patch allocated to a <strong>shared-memory processor</strong> within a node; this is also the scope of a model layer subroutine.</li><li>Distributed memory parallelism is over patches; shared memory parallelism is over tiles within patches</li></ul></li></ul><h1 id="mpas">MPAS</h1><h2 id="an-overview-of-the-structure-of-mpas-meshes-boulder2023"><a href="https://www2.mmm.ucar.edu/projects/mpas/tutorial/Boulder2023/lectures/mesh_structure.pdf">An overview of the structure of MPAS meshes | Boulder2023</a></h2><p><img src="https://i.imgur.com/SsGuRLq.png" width="600" /> <img src="https://i.imgur.com/PpBWRMb.png" width="600" /> <img src="https://i.imgur.com/SsaBchP.png" width="600" /> <img src="https://i.imgur.com/raumO6Y.png" width="600" /> <img src="https://i.imgur.com/S6VjTov.png" width="600" /></p><h1 id="references">References</h1><ol type="1"><li><a href="http://www.claudiobellei.com/2018/09/30/julia-mpi/">Parallel programming with Julia using MPI</a></li><li><a href="https://www.iue.tuwien.ac.at/phd/quell/Hierarchical-Grids.html">Chapter 2 Hierarchical Grids</a></li><li>Perović, N., Frisch, J., Salama, A., Sun, S., Rank, E., &amp; Mundani, R. P. (2017). <strong>Multi-scale high-performance fluid flow: Simulations through porous media</strong>. Advances in Engineering Software, 103, 85-98.</li><li>Huang, J., Wang, W., Wang, Y., Jiang, J., Yan, C., Zhao, L., &amp; Bai, Y. (2023). <strong>Performance Evaluation and Optimization of the Weather Research and Forecasting (WRF) Model Based on Kunpeng 920</strong>. Applied Sciences, 13(17), 9800. <a href="https://doi.org/10.3390/app13179800" class="uri">https://doi.org/10.3390/app13179800</a></li><li><a href="https://www.cisl.ucar.edu/sites/default/files/2021-09/Dixit_Patel_Presentation.pdf">Performance Analysis and Optimizations of the Weather Research and Forecasting (WRF) Model | 2018</a><ol type="1"><li><strong>Intel</strong> 18.0.1 + SGI MPT 2.18 gives best performance</li></ol></li><li><a href="https://www2.mmm.ucar.edu/projects/mpas/tutorial/Boulder2023/agenda.html">MPAS-A Tutorial Agenda | Boulder2023</a><ol type="1"><li><a href="https://www2.mmm.ucar.edu/projects/mpas/tutorial/Boulder2023/lectures/mesh_structure.pdf">An overview of the structure of MPAS meshes</a></li></ol></li><li><a href="https://www.tropmet.res.in/introspect/presentation/13feb/skamarock_20170213.pdf">MPAS | skamarock_20170213</a></li></ol>]]></content>
    
    
    <categories>
      
      <category>WRF</category>
      
    </categories>
    
    
    <tags>
      
      <tag>HPC</tag>
      
      <tag>NWP</tag>
      
      <tag>WRF</tag>
      
      <tag>MPAS</tag>
      
      <tag>MPI</tag>
      
      <tag>halo cell</tag>
      
      <tag>ghost cell</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>MPAS | MPAS-A Idealized Test Cases</title>
    <link href="/2024/12/06/MPAS-A-Idealized-Test-Cases/"/>
    <url>/2024/12/06/MPAS-A-Idealized-Test-Cases/</url>
    
    <content type="html"><![CDATA[<h1 id="mpas-atmosphere-idealized-test-cases">MPAS-Atmosphere idealized test cases</h1><div class="note note-danger">            <ul><li><strong><a href="https://mpas-dev.github.io/atmosphere/test_cases.html" class="uri">https://mpas-dev.github.io/atmosphere/test_cases.html</a></strong></li></ul>          </div><p>The downloads below for MPAS-Atmosphere idealized test cases include the following:</p><ul><li>an MPAS mesh file to be used with the test case;</li><li>for 3-d test cases, mesh decomposition files for several MPI task counts;</li><li>a <strong>namelist file for creating initial conditions</strong> for the test case;</li><li>a <strong>namelist file for running the model</strong>; and</li><li><strong>NCL scripts</strong> for making plots of the output.</li></ul><p>The process of generating initial conditions and running each test case is described in further detail in the MPAS-Atmosphere Users' Guide.</p><h2 id="test-cases-on-the-sphere">Test cases on the sphere</h2><h3 id="the-jablonowski-and-williamson-baroclinic-wave-test-case.">The Jablonowski and Williamson baroclinic wave test case.</h3><div class="note note-danger">            <p><strong>Jablonowski, C., &amp; Williamson, D. L. (2006). A baroclinic instability test case for atmospheric model dynamical cores. Quarterly Journal of the Royal Meteorological Society, 132(621C), 2943–2975. <a href="https://doi.org/10.1256/qj.06.12" class="uri">https://doi.org/10.1256/qj.06.12</a></strong></p>          </div><ul><li>The dynamical core is initialized with steady-state, balanced initial conditions that are an analytic solution to the hydrostatic primitive equations. <strong>This model set-up reveals how well a dynamical core maintains this initial state</strong> before numerical round-off and truncation errors as well as gravity waves degrade the steady state.</li></ul><p><img src="https://i.imgur.com/Cu4feVO.png" width="400" /> <img src="https://i.imgur.com/luYcZPl.png" width="400" /></p><p>Steps to run this test case:</p><ol type="1"><li><strong>Link</strong> the <code>init_atmosphere_model</code> and <code>atmosphere_model</code> executables from the top-level MPAS directory.</li><li>Run <code>init_atmosphere_model</code> to create initial conditions.<ol type="1"><li>The log file may show WARNING messages; these can generally be ignored.</li></ol></li><li>Run <code>atmosphere_model</code></li><li>Run the <strong>bwave_surface_p.ncl</strong> script to produce <strong>plots of surface pressure</strong> each simulated day.</li></ol><figure class="highlight console"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs console">bwave_surface_p.ncl            x1.40962.graph.info.part.16<br>namelist.atmosphere            x1.40962.graph.info.part.2<br>namelist.init_atmosphere       x1.40962.graph.info.part.24<br>README                         x1.40962.graph.info.part.4<br>stream_list.atmosphere.output  x1.40962.graph.info.part.6<br>streams.atmosphere             x1.40962.graph.info.part.8<br>streams.init_atmosphere        x1.40962.grid.nc<br>x1.40962.graph.info.part.12<br></code></pre></td></tr></table></figure><p>and,</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs netcdf">netcdf x1.40962.init &#123;<br>dimensions:<br>nVertLevels = 26 ;<br>nCells = 40962 ;<br>Time = UNLIMITED ; // (1 currently)<br>StrLen = 64 ;<br>nEdges = 122880 ;<br>nVertices = 81920 ;<br>TWO = 2 ;<br>maxEdges = 10 ;<br>maxEdges2 = 20 ;<br>vertexDegree = 3 ;<br>R3 = 3 ;<br>nMonths = 12 ;<br>nSoilComps = 8 ;<br>FIFTEEN = 15 ;<br>nVertLevelsP1 = 27 ;<br>nSoilLevels = 4 ;<br></code></pre></td></tr></table></figure><p>Create a run.sh,</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-meta">#!/bin/bash</span><br><span class="hljs-built_in">export</span> CODE_DIR=/home/wpsze/MPAS-A/mpasv822/MPASv822/<br><span class="hljs-built_in">export</span> MPAS_ENV=/home/wpsze/MPAS-A/mpas_env.sh<br><span class="hljs-built_in">source</span> <span class="hljs-variable">$&#123;MPAS_ENV&#125;</span><br><span class="hljs-built_in">source</span> /home/wpsze/micromamba/etc/profile.d/micromamba.sh<br>micromamba activate mpas_env<br><br><span class="hljs-built_in">ln</span> -s <span class="hljs-variable">$&#123;CODE_DIR&#125;</span>/init_atmosphere_model<br><span class="hljs-built_in">ln</span> -s <span class="hljs-variable">$&#123;CODE_DIR&#125;</span>/atmosphere_model<br><br>./init_atmosphere_model<br>./atmosphere_model<br></code></pre></td></tr></table></figure><p>the run is done and shows,</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs log">   timer_name                                            total       calls        min            max            avg      pct_tot   pct_par     par_eff<br> 1 total time                                        6369.85205         1     6369.85205     6369.85205     6369.85205   100.00       0.00       1.00<br> 2  initialize                                         16.04797         1       16.04797       16.04797       16.04797     0.25       0.25       1.00<br> 3   read_ICs                                          12.92155         1       12.92155       12.92155       12.92155     0.20      80.52       1.00<br> 2  diagnostic_fields                                  39.15386      6146        0.00027        0.55109        0.00637     0.61       0.61       1.00<br> 2  stream_output                                     135.25525      3073        0.00000       25.31770        0.04401     2.12       2.12       1.00<br> 2  time integration                                 6178.20117      3072        1.83821        6.71001        2.01113    96.99      96.99       1.00<br> 3   atm_rk_integration_setup                          72.62624      3072        0.02114        0.06312        0.02364     1.14       1.18       1.00<br> 3   atm_compute_moist_coefficients                    37.50331      3072        0.01115        0.03584        0.01221     0.59       0.61       1.00<br> 3   physics_get_tend                                  22.05075      3072        0.00633        0.03133        0.00718     0.35       0.36       1.00<br> 3   atm_compute_vert_imp_coefs                        45.81344      3072        0.01347        0.04496        0.01491     0.72       0.74       1.00<br> 3   atm_compute_dyn_tend                            2480.10986      9216        0.20928        0.82551        0.26911    38.94      40.14       1.00<br> 3   small_step_prep                                  133.52666      9216        0.01284        0.03533        0.01449     2.10       2.16       1.00<br> 3   atm_advance_acoustic_step                       2095.08105     36864        0.04626        0.15461        0.05683    32.89      33.91       1.00<br> 3   atm_divergence_damping_3d                        457.87030     36864        0.01101        0.03708        0.01242     7.19       7.41       1.00<br> 3   atm_recover_large_step_variables                 268.87030      9216        0.02323        0.08294        0.02917     4.22       4.35       1.00<br> 3   atm_compute_solve_diagnostics                    445.47675      9216        0.03804        0.16322        0.04834     6.99       7.21       1.00<br> 3   atm_rk_dynamics_substep_finish                    43.84446      3072        0.01267        0.03757        0.01427     0.69       0.71       1.00<br><br>-----------------------------------------<br>Total log messages printed:<br>   Output messages =                25140<br>   Warning messages =                   0<br>   Error messages =                     0<br>   Critical error messages =            0<br>-----------------------------------------<br></code></pre></td></tr></table></figure><ul><li>Plot: <code>ncl bwave_surface_p.ncl</code>, <strong>for surface pressure</strong>,</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs ncl">rdzw = f-&gt;rdzw(:)<br>p = f-&gt;pressure(iTime,:,0)<br>rho=f-&gt;rho(iTime,:,:)<br>qv = f-&gt;qv(iTime,:,:) <br>h = (p + 0.5/rdzw(0)*9.80616*(1.25*rho(:,0) - .25*rho(:,1)))/100. ;for dry!!!<br>;h = (p + 0.5/rdzw(0)*9.80616*(1.25*rho(:,0)*(1.+qv(:,0)) - .25*rho(:,1)*(1.+qv(:,1))))/100. ;for moist!!!<br></code></pre></td></tr></table></figure><p><img src="https://i.imgur.com/IY1Zckj.gif" width="600" /></p><h2 id="test-cases-on-the-cartesian-plane">Test cases on the Cartesian plane</h2><h3 id="supercell">Supercell</h3><p>The supercell thunderstorm test case.</p><ul><li><a href="https://www2.cgd.ucar.edu/events/20140407/Presentations-Posters/Klemp.pdf">Idealized Nonhydrostatic Supercell Simulations in the Global MPAS | Klemp | 2014</a><ul><li>Supercell Thunderstorms<ul><li>Strong, long-lived convective cells</li><li>Deep, persistent rotating updrafts</li><li>May propagate tranverse to the mean winds</li><li>May split into two counter-rotating storms</li><li>Produce most of the world’s intense tornadoes</li></ul></li></ul></li><li>Based on historical supercell simulations (Weisman and Klemp, 1982, 1984)</li><li><a href="http://admg.engin.umich.edu/wp-content/uploads/sites/525/2021/03/DCMIP-2016_TestCaseDocument_10June2016.pdf">Zarzycki, C. M., Jablonowski, C., Kent, J., Lauritzen, P. H., Nair, R., Reed, K. A., ... &amp; Skamarock, W. C. (2019). DCMIP2016: the splitting supercell test case. Geoscientific Model Development, 12(3), 879-892.</a></li></ul><p>Steps to run this test case:</p><ol type="1"><li>Link the <code>init_atmosphere_model</code> and <code>atmosphere_model</code> executables from the top-level MPAS directory.</li><li>Run <code>init_atmosphere_model</code> to create initial conditions.</li><li>Run <code>atmosphere_model</code>.</li><li>Run the <code>supercell.ncl</code> script to produce <strong>plots theta, vertical velocity</strong>, etc.</li></ol><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs netcdf">netcdf supercell_init &#123;<br>dimensions:<br>nVertLevels = 40 ;<br>nCells = 28080 ;<br>Time = UNLIMITED ; // (1 currently)<br>StrLen = 64 ;<br>nEdges = 84240 ;<br>nVertices = 56160 ;<br>TWO = 2 ;<br>maxEdges = 6 ;<br>maxEdges2 = 12 ;<br>vertexDegree = 3 ;<br>R3 = 3 ;<br>nMonths = 12 ;<br>nSoilComps = 8 ;<br>FIFTEEN = 15 ;<br>nVertLevelsP1 = 41 ;<br>nSoilLevels = 4 ;<br></code></pre></td></tr></table></figure><p>the run is done and shows,</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs log">   timer_name                                            total       calls        min            max            avg      pct_tot   pct_par     par_eff<br> 1 total time                                        6989.56445         1     6989.56445     6989.56445     6989.56445   100.00       0.00       1.00<br> 2  initialize                                         13.22789         1       13.22789       13.22789       13.22789     0.19       0.19       1.00<br> 3   read_ICs                                          11.03032         1       11.03032       11.03032       11.03032     0.16      83.39       1.00<br> 2  diagnostic_fields                                  30.90804      4802        0.00030        0.53316        0.00644     0.44       0.44       1.00<br> 2  stream_output                                      52.69895      2401        0.00000       24.40299        0.02195     0.75       0.75       1.00<br> 2  time integration                                 6891.87109      2400        2.28900        4.57639        2.87161    98.60      98.60       1.00<br> 3   physics driver                                     0.01804      2400        0.00000        0.00014        0.00001     0.00       0.00       1.00<br> 3   atm_rk_integration_setup                          81.38436      2400        0.02777        0.08220        0.03391     1.16       1.18       1.00<br> 3   atm_compute_moist_coefficients                    61.76581      2400        0.01953        0.08913        0.02574     0.88       0.90       1.00<br> 3   physics_get_tend                                  32.39993      2400        0.00967        0.02704        0.01350     0.46       0.47       1.00<br> 3   atm_compute_vert_imp_coefs                        43.12508      2400        0.01534        0.04965        0.01797     0.62       0.63       1.00<br> 3   atm_compute_dyn_tend                            1610.07593      7200        0.17735        0.70892        0.22362    23.04      23.36       1.00<br> 3   small_step_prep                                   97.92229      7200        0.01138        0.03734        0.01360     1.40       1.42       1.00<br> 3   atm_advance_acoustic_step                       1270.13843     28800        0.03023        0.10505        0.04410    18.17      18.43       1.00<br> 3   atm_divergence_damping_3d                        310.51599     28800        0.00890        0.05312        0.01078     4.44       4.51       1.00<br> 3   atm_recover_large_step_variables                 237.22810      7200        0.02374        0.08794        0.03295     3.39       3.44       1.00<br> 3   atm_advance_scalars                              986.22546      4800        0.14607        0.64590        0.20546    14.11      14.31       1.00<br> 3   atm_compute_solve_diagnostics                    371.22009      7200        0.03595        0.17258        0.05156     5.31       5.39       1.00<br> 3   atm_advance_scalars_mono                         644.47906      2400        0.18351        0.88479        0.26853     9.22       9.35       1.00<br> 3   atm_rk_dynamics_substep_finish                    43.15440      2400        0.01410        0.04277        0.01798     0.62       0.63       1.00<br> 3   microphysics                                    1031.64172      2400        0.30451        0.79860        0.42985    14.76      14.97       1.00<br> 4    mp_kessler                                      247.80276      2400        0.08487        0.28454        0.10325     3.55      24.02       1.00<br><br>-----------------------------------------<br>Total log messages printed:<br>   Output messages =                26971<br>   Warning messages =                   0<br>   Error messages =                     0<br>   Critical error messages =            0<br>-----------------------------------------<br></code></pre></td></tr></table></figure><p>Plot,</p><div class="group-image-container"><div class="group-image-row"><div class="group-image-wrap"><img src="https://i.imgur.com/EoUDfnf.png" alt="1" /></div><div class="group-image-wrap"><img src="https://i.imgur.com/71tbDoJ.png" alt="2" /></div></div></div><h3 id="mountain-wave">Mountain-wave</h3><p>The Schaer mountain-wave test case.</p><div class="note note-danger">            <p><strong><a href="https://iacweb.ethz.ch/doc/publications/2002_ScharEtAl_VertCoord.pdf">Schär, C., Leuenberger, D., Fuhrer, O., Lüthi, D., &amp; Girard, C. (2002). A new terrain-following vertical coordinate formulation for atmospheric prediction models. Monthly Weather Review, 130(10), 2459-2480.</a></strong></p>          </div><ul><li><strong>Analytical solution</strong> (Eqn. 46, Figure 13g)</li><li><a href="https://www.umr-cnrm.fr/gmapdoc/IMG/pdf/TestingNHMOdels.pdf">Standard Tests of NH dynamical kernels | Jozef Vivoda | 2005</a><ul><li>P.8 Schaer test case</li></ul></li></ul><p><img src="https://i.imgur.com/aGauoyFl.png" width="600" /></p><p>Steps to run this test case:</p><ol type="1"><li>Link the <code>init_atmosphere_model</code> and <code>atmosphere_model</code> executables from the top-level MPAS directory</li><li>Run <code>init_atmosphere_model</code> to create initial conditions</li><li>Run <code>atmosphere_model</code></li><li>Run the <code>mtn_wave_w.ncl</code> script to <strong>plot vertical cross-sections of vertical velocity</strong></li></ol><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs netcdf">netcdf mtn_wave_init &#123;<br>dimensions:<br>nVertLevels = 70 ;<br>nCells = 1600 ;<br>Time = UNLIMITED ; // (1 currently)<br>StrLen = 64 ;<br>nEdges = 4800 ;<br>nVertices = 3200 ;<br>TWO = 2 ;<br>maxEdges = 6 ;<br>maxEdges2 = 12 ;<br>vertexDegree = 3 ;<br>R3 = 3 ;<br>nMonths = 12 ;<br>nSoilComps = 8 ;<br>FIFTEEN = 15 ;<br>nVertLevelsP1 = 71 ;<br>nSoilLevels = 4 ;<br></code></pre></td></tr></table></figure><p>the run is done and shows,</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs log">   timer_name                                            total       calls        min            max            avg      pct_tot   pct_par     par_eff<br> 1 total time                                         479.17487         1      479.17487      479.17487      479.17487   100.00       0.00       1.00<br> 2  initialize                                          1.40130         1        1.40130        1.40130        1.40130     0.29       0.29       1.00<br> 3   read_ICs                                           1.04874         1        1.04874        1.04874        1.04874     0.22      74.84       1.00<br> 2  diagnostic_fields                                  38.32835      6002        0.00030        0.26142        0.00639     8.00       8.00       1.00<br> 2  stream_output                                       8.16368      3001        0.00000        2.18816        0.00272     1.70       1.70       1.00<br> 2  time integration                                  430.28293      3000        0.12909        0.37118        0.14343    89.80      89.80       1.00<br> 3   atm_rk_integration_setup                           7.68167      3000        0.00226        0.00653        0.00256     1.60       1.79       1.00<br> 3   atm_compute_moist_coefficients                     3.88766      3000        0.00115        0.00331        0.00130     0.81       0.90       1.00<br> 3   physics_get_tend                                   1.73502      3000        0.00049        0.00179        0.00058     0.36       0.40       1.00<br> 3   atm_compute_vert_imp_coefs                         4.89605      3000        0.00145        0.00413        0.00163     1.02       1.14       1.00<br> 3   atm_compute_dyn_tend                             181.87900      9000        0.01650        0.06131        0.02021    37.96      42.27       1.00<br> 3   small_step_prep                                    9.66831      9000        0.00094        0.00315        0.00107     2.02       2.25       1.00<br> 3   atm_advance_acoustic_step                        113.06064     36000        0.00273        0.01248        0.00314    23.59      26.28       1.00<br> 3   atm_divergence_damping_3d                         37.56601     36000        0.00091        0.00282        0.00104     7.84       8.73       1.00<br> 3   atm_recover_large_step_variables                  21.39947      9000        0.00175        0.00898        0.00238     4.47       4.97       1.00<br> 3   atm_compute_solve_diagnostics                     37.34831      9000        0.00319        0.01347        0.00415     7.79       8.68       1.00<br> 3   atm_rk_dynamics_substep_finish                     4.19751      3000        0.00123        0.00363        0.00140     0.88       0.98       1.00<br><br>-----------------------------------------<br>Total log messages printed:<br>   Output messages =                24552<br>   Warning messages =                   0<br>   Error messages =                     0<br>   Critical error messages =            0<br>-----------------------------------------<br></code></pre></td></tr></table></figure><p>Plot,</p><p><img src="https://i.imgur.com/ZZHlHFq.gif" width="600" /></p><h1 id="references">References</h1><ol type="1"><li>Skamarock, W. C., Klemp, J. B., Duda, M. G., Fowler, L. D., Park, S., &amp; Ringler, T. D. (2012). A Multiscale Nonhydrostatic Atmospheric Model Using Centroidal Voronoi Tesselations and C-Grid Staggering. Monthly Weather Review, 140(9), 3090-3105. <a href="https://doi.org/10.1175/MWR-D-11-00215.1" class="uri">https://doi.org/10.1175/MWR-D-11-00215.1</a><ol type="1"><li>Test cases: Nonhydrostatic flows on Cartesian planes<ol type="1"><li>2D Scha¨r test case</li><li>2D density current</li><li>Supercell simulation</li></ol></li><li>Test cases: Large-scale flow on the sphere<ol type="1"><li>Dry baroclinic wave simulations</li><li>Unfiltered baroclinic wave simulations</li></ol></li></ol></li></ol>]]></content>
    
    
    <categories>
      
      <category>MPAS</category>
      
    </categories>
    
    
    <tags>
      
      <tag>HPC</tag>
      
      <tag>NWP</tag>
      
      <tag>WRF</tag>
      
      <tag>MPAS</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>CFD | OpenFOAM | STL file | 網格生成</title>
    <link href="/2024/12/05/CFD-openfoam-stl-mesh-generation/"/>
    <url>/2024/12/05/CFD-openfoam-stl-mesh-generation/</url>
    
    <content type="html"><![CDATA[<h1 id="openfoam三維網格生成器">OpenFOAM三維網格生成器</h1><p>snappyHexMesh（SHM）是OpenFOAM軟體的三維結構化網格生成模組，功能比較強大，設定靈活，表面處理貼合功能非常強健並且可以並行運算。 SHM能夠透過使用者自訂參數（如細化參數castellatedMeshControls、切合參數snapControls等）對預先載入的幾何體檔案（通常為'.stl'檔案）自動實現三維網格生成、加密(castellatedMesh)、切合（snap ）和新增邊界層（addLayers）等操作。</p><p>SHM產生OpenFOAM網格流程如圖1所示:</p><figure><img src="https://i.imgur.com/oggvctr.png" alt="圖1 基於snappyHexMesh的OpenFOAM網格生成流程圖" width="600" /><figcaption>圖1 基於snappyHexMesh的OpenFOAM網格生成流程圖</figcaption></figure><p>需提供以下三個文件：</p><ol type="1"><li>STL檔案格式的幾何檔案（binary或ascii格式，儲存在 <code>constant/triSurface</code> 子字典中）；</li><li>背景六面體網格（用於定義計算域範圍和背景網格，一般由 <code>blockMesh</code> 生成，也可由外部網格生成器生成）；</li><li><code>snappyHexMeshDict</code> 字典（提供生成網格的必要信息，位於 <code>system</code> 子資料夾下）。</li></ol><h2 id="什麼是-stl-檔案">什麼是 STL 檔案？</h2><p>STL 是一種常用於 3D 列印和電腦輔助設計 (CAD) 的檔案格式。縮寫名稱 STL 代表「光固化立體成型」(<strong>Stereolithography</strong>)，一種熱門的 3D 列印技術。此外，這種檔案也稱作「標準三角語言」(<strong>Standard Triangle Language</strong>) 或「標準曲面細分語言」(<strong>Standard Tessellation Language</strong>)。 STL 檔案是由一系列相連的三角形構成，這些三角形可用於描繪 3D 模型或物件的表面幾何圖形。設計越複雜，使用的三角形數量就越多，解析度也隨之提高。您可以透過副檔名 .stl 以及缺乏色彩與紋理的特點來辨識 STL 格式影像。</p><p>無論列印 3D 模型的目的是純粹好玩還是製作實務原型，您都必須建立 STL 檔案來儲存設計。請先在 CAD 軟體程式中繪製模型，然後將完成的設計以 STL 檔案格式匯出並儲存至電腦。</p><ul><li><a href="https://vr.me.ncku.edu.tw/courses/cg110/sites/vr.me.ncku.edu.tw.courses.cg110/files/STL.pdf">STL 檔案資料結構</a></li><li><a href="https://3dlabstore.com.hk/blog/3d-software/popular-stl-editiors?srsltid=AfmBOoqL1Z-brQRzPgIC-kvSjG7SpBiql9WLuug-r5hypwAlAFvT-CNE">幾個常用的修改STL模型軟件</a><ul><li><strong>MeshLab</strong><ul><li>MeshLab是一個開源、便攜且可擴展的系統，用於處理和編輯3D三角形網格。這個系統於2005年年底發佈，旨在幫助用戶進行3D掃描、編輯、清理、修復、檢查、呈現和轉換等操作。MeshLab用途廣泛，它可以用於各種學術和研究中，如文化遺產、表面重建、古生物學等。涉及到3D網格模型處理的，都可以用這款軟件來處理。</li></ul></li><li>MeshMixer<ul><li>MeshMixer適合許多需要修改STL模型的使用者，初學者或是經驗豐富的設計人員皆適用。</li></ul></li><li>ZBrushCoreMini<ul><li>ZBrushCoreMini適合對雕刻方面感興趣的人群，此款軟件操作時類似使用畫筆一樣去編輯。</li></ul></li></ul></li></ul><h3 id="d打印的stl和obj格式有什麼區別修改起來一樣麼">3D打印的STL和OBJ格式有什麼區別？修改起來一樣麼？</h3><p>STL文件格式是由3D SYSTEMS 公司於1988 年制定的一種爲快速原型製造技術服務的三維圖形文件格式。STL文件不同於其他一些基於特徵的實體模型，STL用三角形網格來表現3D CAD模型，只能描述三維物體的幾何信息，不支持顏色材質等信息。正因爲數據簡化，格式簡單，STL普及很快應用廣泛。</p><p>OBJ文件是Alias|Wavefront公司爲它的一套基於工作站的3D建模和動畫軟件”Advanced Visualizer”開發的一種標準3D模型文件格式，很適合用於3D軟件模型之間的數據交換，能支持顏色等信息。</p><p>兩者在修改上相差不多，都是需要導入到相關的模型修改軟件中進行。</p><h1 id="applications">Applications</h1><ul><li><a href="https://ppfocus.com/0/ed40c27be.html">SnappyHexMesh網格劃分實例詳解</a><ul><li>使用surfaceCheck檢查proeller.stl, <code>surfaceCheck constant/propeller.stl</code></li></ul></li></ul><h1 id="blender-gis-to-stl">Blender GIS to stl</h1><ul><li><a href="https://github.com/domlysz/BlenderGIS" class="uri">https://github.com/domlysz/BlenderGIS</a></li><li><p><a href="https://blender-addons.org/blendergis-addon/">BlenderGIS addon</a></p></li><li><p><strong>download</strong></p></li></ul><div class="note note-danger">            <p>GIS datafile import : Import in Blender most commons GIS data format : <code>Shapefile vector</code>, <code>raster image</code>, <code>geotiff DEM</code>, <code>OpenStreetMap xml</code>.</p>          </div><h2 id="google-gis-srtm-30m-to-stl">Google GIS (SRTM 30m) to stl</h2><ul><li>Note : Since 2022, the OpenTopography web service requires an API key. Please register to opentopography.org and request a key. This service is still free.</li></ul><div class="group-image-container"><div class="group-image-row"><div class="group-image-wrap"><img src="https://i.imgur.com/s3CBmtM.png" alt="1" /></div><div class="group-image-wrap"><img src="https://i.imgur.com/Sgvffp8.png" alt="2" /></div><div class="group-image-wrap"><img src="https://i.imgur.com/1EBJ21x.png" alt="3" /></div></div><div class="group-image-row"><div class="group-image-wrap"><img src="https://i.imgur.com/Sk7Oeev.png" alt="4" /></div><div class="group-image-wrap"><img src="https://i.imgur.com/11gtygg.png" alt="5" /></div></div></div><h2 id="openstreetmap-xml-to-stl">OpenStreetMap xml to stl</h2><h3 id="download-osm-file">Download osm file</h3><p><img src="https://i.imgur.com/POleA9W.png" width="400" /></p><h3 id="import-osm-file">Import osm file</h3><p><img src="https://i.imgur.com/POvvxOu.png" width="400" /></p><h3 id="export-stl-file">export stl file</h3><ul><li>meshlab</li></ul><figure><img src="https://i.imgur.com/bvsHeZV.png" alt="Open by meshlab" width="400" /><figcaption>Open by <strong>meshlab</strong></figcaption></figure><ul><li>admesh</li></ul><figure><img src="https://i.imgur.com/SVTBUsh.png" alt="Check by admesh" width="400" /><figcaption>Check by <strong>admesh</strong></figcaption></figure><h1 id="osm">OSM</h1><p><strong>OpenStreetMap</strong> 是一个庞大的地理信息数据库，而且是完全开放和免费的。</p><ul><li><a href="https://www.openstreetmap.org/#map=13/22.2868/114.2492" class="uri">https://www.openstreetmap.org/#map=13/22.2868/114.2492</a></li><li>export --&gt; <code>map.osm</code></li></ul><p><code>.osm</code> 文件格式是 OpenStreetMap 所特有的。你不会在其他地方遇到它。如果你曾经使用 JOSM 下载过数据并将其保存为文件，你可能已经注意到文件的扩展名是 <code>.osm</code> 。如果你是一个GIS用户，你可能也注意到，使用QGIS等软件打开这些文件并不容易。</p><p><img src="https://i.imgur.com/lqqINf9.png" width="600" /></p><h1 id="shapefile">Shapefile</h1><p><strong>shapefile</strong> 是一种广泛使用的矢量地理数据存储格式。它是由 ESRI 公司开发的，该公司制造了 ArcGIS ，这是一套流行的地理信息系统应用程序。</p><p>Shapefile 实际上是几个不同文件的集合。例如，一个包含建筑数据的shapefile可能有以下扩展名的文件。</p><ul><li>buildings.shp</li><li>buildings.shx</li><li>buildings.dbf</li></ul><p>shapefiles 通常也会有包含其他信息的附加文件。</p><p>一个 shapefile 只能容纳一种类型的特征（点、线或多边形），每个特征的属性都包含在一个表中。与 OpenStreetMap 系统不同的是，在 OpenStreetMap 系统中，每个对象都可以拥有无限数量的标签，shapefile 中的特征属性必须适合 shapefile 定义的表格结构。</p><p>OpenStreetMap数据可以转换为shapefiles。各种网站提供了从OSM数据转换而来的shapefiles。</p><h1 id="references">References</h1><ol type="1"><li><a href="https://www.wolfdynamics.com/wiki/meshing_OF_SHM.pdf">Mesh generation using snappyHexMesh (<strong>recommend</strong>)</a></li><li><a href="https://www.fangzhenxiu.com/post/7273888/?uri=473_83g6eo3r4s1">解锁新技能：OpenFOAM三维网格生成器</a></li><li><a href="https://www.adobe.com/hk_zh/creativecloud/file-types/image/vector/stl-file.html">STL 檔案</a></li><li><a href="https://blog.iaac.net/urban-wind-flow-modeling-with-pinns/?utm_source=perplexity">Urban Wind Flow Modeling with PINNs (<strong>recommend</strong>)</a><ol type="1"><li>Data Sources<ol type="1"><li>Real-Time Wind Data: <code>OpenWeatherMap</code> wind conditions.</li><li>3D Building Models: <code>OpenStreetMap (OSM)</code> data using Overpass API.</li></ol></li></ol></li></ol>]]></content>
    
    
    <categories>
      
      <category>CFD</category>
      
    </categories>
    
    
    <tags>
      
      <tag>HPC</tag>
      
      <tag>OpenFOAM</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Maths | p-value | Statistical Significance</title>
    <link href="/2024/12/05/maths-p-value/"/>
    <url>/2024/12/05/maths-p-value/</url>
    
    <content type="html"><![CDATA[<h1 id="p-value">p-value</h1><p>In null-hypothesis significance testing, the p-value is the probability of obtaining test results at least as extreme as the result actually observed, under the assumption that the null hypothesis is correct.</p><p>p值（p value）就是當虛無假設為真時所得到的樣本觀察結果或更極端結果出現的概率。如果p值很小，說明在虛無假設下極端觀測結果的發生概率很小。而如果出現了，根據小概率原理，就有理由拒絕虛無假設；p值越小，拒絕虛無假設的理由越充分。</p><p>常常看到有人說p-value &lt;0.05，所以達到統計上的意義，模型合理，但你真的知道這是什麼意思嗎? p 值是什麼？ p 值是由 Ronald Fisher 在 1920 年代發展出來的，已將近一百年。p 值檢定最開始，是檢定在一個 model 之下，實驗出來的 data 跟 model 到底吻合不吻合。這個被檢定的 model，我們把它叫做虛無假設（null hypothesis），一般情況下，這個被檢定的 model，是假設實驗並無系統性效應的，即效應是零，或是隨機狀態。在這個虛無假設之下，得到一個統計值，然後要算獲得這麼大（或這麼小）的統計值的機率有多少，這個或機率就是 p 值。我們得到 p 值以後，要作統計檢定。我們相約成俗地設定一個顯著水準，叫做 α，α 通常都是 0.05，有時候大家會嚴格一點用 0.01，比較不嚴格則用 0.10。如果我們的 α = 0.05，則若 p &lt; 0.05，我們就可以拒絕虛無假設，並宣稱這個檢定在統計上是顯著的，否則檢定就不顯著，這是傳統的 p 值檢定方法。如果統計上顯著的話，我們就認為得到實驗結果的機會很小，所以就不接受虛無假設。</p><p><img src="https://i.imgur.com/R9rzCZ6.png" width="600" /> <img src="https://i.imgur.com/YNCQYZz.png" /></p><h1 id="statistical-hypothesis-test">Statistical hypothesis test</h1><p>A statistical hypothesis test is a method of statistical inference used to decide whether the data sufficiently supports a particular hypothesis. A statistical hypothesis test typically involves a calculation of a test statistic. Then a decision is made, either by comparing the test statistic to a critical value or equivalently by evaluating a p-value computed from the test statistic. Roughly 100 specialized statistical tests have been defined.</p><h2 id="students-t-test">Student's t-test</h2><p><img src="https://i.imgur.com/EJrAqbw.png" width="600" /></p><p>Student's t-test is a statistical test used to test whether the difference between the response of two groups is statistically significant or not. It is any statistical hypothesis test in which the test statistic follows a <strong>Student's t-distribution</strong> under the null hypothesis. It is most commonly applied when the test statistic would <strong>follow a normal distribution</strong> if the value of a scaling term in the test statistic were known.</p><p><img src="https://i.imgur.com/n8aDZgE.png" width="600" /></p><p>雖然 t 檢定相對於假設的差異較為穩固，t 檢定實際上假設：</p><ul><li>資料為<strong>連續資料</strong>。</li><li>樣本資料必須從母體隨機採樣。</li><li>變異數具同質性 (各群組資料的變異性相似)。</li><li><strong>資料趨近於常態分佈</strong>。</li><li><p>針對雙樣本 t 檢定 (Two sample t test)，我們必須有<strong>獨立樣本</strong>。若樣本並非獨立，則使用<strong>配對t檢定 (Paired t test)</strong>可能會較為合適。</p></li><li>When the <strong>normality assumption does not hold</strong>, a non-parametric alternative to the t-test may have better statistical power.<ul><li><strong>Nonparametric statistics</strong> is a type of statistical analysis that makes minimal assumptions about the underlying distribution of the data being studied. Nonparametric tests are often used when the assumptions of parametric tests are evidently violated.</li><li>The first meaning of nonparametric involves techniques that <strong>do not rely on data belonging to any particular</strong> parametric family of probability distributions.</li><li>非參數統計學（英語：nonparametric statistics），或稱無參數統計學、非參數統計分析，是統計學的一個分支，適用於<strong>總體分佈情況未明、小樣本、總體分佈不為正態也不易轉換為正態</strong>。</li><li>參數統計（Parametric statistics）是統計學的一個分支，它假設樣本數據來自總體，而總體可以透過具有固定參數集的概率分佈 (e.g.正態分佈族) 進行充分建模。</li></ul></li></ul><h2 id="wilcoxon-signed-rank-test">Wilcoxon signed-rank test</h2><p>The Wilcoxon signed-rank test is a <strong>non-parametric rank test</strong> for statistical hypothesis testing used either to test the location of a population based on a sample of data, or to compare the locations of two populations using two matched samples.</p><ul><li><a href="https://mengte.online/archives/333">单样本Wilcoxon符号秩检验(One Sample Wilcoxon Signed Rank Test)——理论介绍</a></li><li><a href="https://mengte.online/archives/12539">单样本Wilcoxon符号秩检验(One Sample Wilcoxon Signed Rank Test)——Python软件实现</a></li><li><a href="https://mengte.online/archives/340">配对样本Wilcoxon符号秩检验(Paired Samples Wilcoxon Signed Rank Test)——理论介绍</a></li><li><a href="https://mengte.online/archives/12555">配对样本Wilcoxon符号秩检验(Paired Samples Wilcoxon Signed Rank Test)——Python软件实现</a></li><li><a href="https://statistics-using-python.blogspot.com/2019/08/wilcoxon-signed-rank-wilcoxon-signed.html">兩組成對資料Wilcoxon signed-rank檢定 (Wilcoxon signed-rank test for paired samples，non-parametric)</a></li></ul><h1 id="applications">Applications</h1><ul><li><a href="https://www.ecmwf.int/en/elibrary/78783-significance-changes-medium-range-forecast-scores">Significance of changes in medium-range forecast scores | ECMWF | 2015</a><ul><li>By making an independent realisation of the null distribution used in the hypothesis testing, using 1,885 paired forecasts (about 2.5 years of testing), it is possible to construct an alternative significance test that makes no statistical assumptions about the data.</li><li>A main issue is that <strong>chaotic error growth</strong> leads to large differences in skill between any two forecasts.</li><li>This study focuses on medium-range (day 3 to day 10 here) extratropical forecast scores of which the quintessential example is the <strong>root-mean-square (RMS) error in 500 hPa geopotential height</strong>.</li><li>The RMS error as a function of lead-time (Fig. 2) illustrates the rapid baroclinic error growth in midlatitudes.</li><li>As mentioned, <strong>the usual basis of significance testing</strong> is to create a <strong>population of paired differences</strong> in scores between an experiment and a control (e.g. Wilks, 2006).</li><li>** It can also be used to create an entirely <strong>non-parametric significance test, i.e. one that makes no assumptions on the distributions of forecast scores</strong>.</li><li>The solution (Fisher, 1998; Wilks, 2006) is to look at the paired differences,</li><li>The time-autocorrelation between paired differences at day-5 is 0.15 for base times separated by 12 h and 0.07 for separations of 24 h. Autocorrelation is essentially zero for any longer period.</li><li>However, for now we will assume that <strong>taking paired differences</strong> has created a statistical population that has sufficiently little autocorrelation that a normal t-test can be used to test for statistical significance.</li></ul></li><li><a href="https://www.ecmwf.int/en/newsletter/178/earth-system-science/improved-two-metre-temperature-forecasts-2024-upgrade">Improved two-metre temperature forecasts in the 2024 upgrade | ECMWF | 2024</a><ul><li>The grey rectangles show 95% confidence intervals</li></ul></li></ul><p><img src="https://www.ecmwf.int/sites/default/files/styles/wide/public/2024-01/NL-178-M2-Ingleby-Figure-7.jpg?itok=b-FTGlu4" /></p><h1 id="references">References</h1><ol type="1"><li><a href="https://notebook.community/therealAJ/python-sandbox/data-science/learning/ud1/DataScience/TTest">T-Tests and P-Values</a></li><li><a href="https://haosquare.com/normal-distribution-central-limit-theorem-t-test/">(<strong>推薦</strong>)| t 檢定與中央極限定理：你真的懂常態分佈嗎？</a></li><li><a href="https://www.cnblogs.com/IvyWong/p/10134012.html">使用 Python 进行 T检验</a><ol type="1"><li>单样本T检验(ttest_1samp)</li><li>两独立样本T检验(ttest_ind)</li><li>配对样本T检验(ttest_rel)</li></ol></li><li><a href="https://medium.com/@jason8410271027/%E5%AD%B8%E7%BF%92%E7%AD%86%E8%A8%98-%E7%8D%A8%E7%AB%8B%E6%A8%A3%E6%9C%ACt%E6%AA%A2%E5%AE%9A-%E7%90%86%E8%AB%96-python%E5%AF%A6%E4%BD%9C-146699cf0bd9">【學習筆記】獨立樣本t檢定-理論+Python實作</a></li><li><a href="https://blog.udn.com/nilnimest/844041900">看電影學統計: p值的陷阱</a></li><li><a href="https://chih-sheng-huang821.medium.com/%E7%B5%B1%E8%A8%88%E5%AD%B8-%E5%A4%A7%E5%AE%B6%E9%83%BD%E5%96%9C%E6%AD%A1%E5%95%8F%E7%9A%84%E7%B3%BB%E5%88%97-p%E5%80%BC%E6%98%AF%E4%BB%80%E9%BA%BC-2c03dbe8fddf">統計學:大家都喜歡問的系列-p值是什麼</a></li><li><a href="https://www.jmp.com/zh_tw/statistics-knowledge-portal/t-test.html">t 檢定</a></li><li>Wilks, D. S. (2006, 2011). Statistical methods in the atmospheric sciences. Academic press.</li></ol>]]></content>
    
    
    <categories>
      
      <category>Maths</category>
      
    </categories>
    
    
    <tags>
      
      <tag>NWP</tag>
      
      <tag>AI</tag>
      
      <tag>ML</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>CFD | OpenFOAM | In parallel</title>
    <link href="/2024/12/04/openfoam-in-parallel/"/>
    <url>/2024/12/04/openfoam-in-parallel/</url>
    
    <content type="html"><![CDATA[<h1 id="running-applications-in-parallel">Running applications in parallel</h1><div class="note note-danger">            <p>Both <strong>domain decomposition and reconstruction processes</strong> can only be done on a <strong>single core</strong>.</p>          </div><p>This section describes how to run OpenFOAM in parallel on distributed processors.</p><div class="note note-danger">            <p>The method of parallel computing used by OpenFOAM is known as <strong>domain decomposition</strong>, in which the geometry and associated fields are broken into pieces and allocated to separate processors for solution.</p>          </div><p>The process of parallel computation involves: decomposition of mesh and fields; running the application in parallel; and, post-processing the decomposed case as described in the following sections. The parallel running uses the public domain <strong>openMPI</strong> implementation of the standard message passing interface (MPI).</p><h2 id="decomposition-of-mesh-and-initial-field-data">Decomposition of mesh and initial field data</h2><ul><li>The mesh and fields are decomposed using the decomposePar utility.</li><li>The geometry and fields are broken up according to a set of parameters specified in a dictionary named <code>decomposeParDict</code> that must be located in the <code>system</code> directory of the case of interest.</li></ul><p>An example <code>decomposeParDict</code> dictionary can be copied from the <code>interFoam/damBreak/damBreak</code> tutorial if the user requires one; the dictionary entries within it are reproduced below:</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-number">17</span> numberOfSubdomains <span class="hljs-number">8</span>;<br><span class="hljs-number">18</span><br><span class="hljs-number">19</span> method          simple;<br><span class="hljs-number">20</span><br><span class="hljs-number">21</span> simpleCoeffs<br><span class="hljs-number">22</span> &#123;<br><span class="hljs-number">23</span>     <span class="hljs-built_in">n</span>           (<span class="hljs-number">4</span> <span class="hljs-number">1</span> <span class="hljs-number">2</span>);<br><span class="hljs-number">24</span> &#125;<br><span class="hljs-number">25</span><br><span class="hljs-number">26</span> <span class="hljs-comment">// ******************************* //</span><br></code></pre></td></tr></table></figure><figure><img src="https://i.imgur.com/rxTVXxT.png" alt="&quot;simple&quot; geometric decomposition" width="600" /><figcaption>"simple" geometric decomposition</figcaption></figure><p>The user has a choice of four methods of decomposition, specified by the method keyword as described below.</p><ul><li><code>simple</code><ul><li>Simple geometric decomposition in which the domain is split into pieces by direction.</li></ul></li><li><code>hierarchical</code><ul><li>Hierarchical geometric decomposition which is the same as simple except the user specifies the order in which the directional split is done.</li></ul></li><li><code>scotch</code><ul><li>Scotch decomposition which requires no geometric input from the user and attempts to minimise the number of processor boundaries. The user can specify a weighting for the decomposition between processors, through an optional processorWeights keyword which can be useful on machines with differing performance between processors. There is also an optional keyword entry strategy that controls the decomposition strategy through a complex string supplied to Scotch. For more information, see the source code file: <code>$FOAM_SRC/parallel/decompose/scotchDecomp/scotchDecomp.C</code></li></ul></li><li><code>manual</code><ul><li>Manual decomposition, where the user directly specifies the allocation of each cell to a particular processor.</li></ul></li></ul><p>For each method there are a set of coefficients specified in a sub-dictionary of <code>decompositionDict</code>, named <code>&lt;method&gt;Coeffs</code> as shown in the dictionary listing.</p><h3 id="docs-and-github-code">Docs and github code:</h3><ul><li>Ref: <a href="https://www.openfoam.com/documentation/guides/latest/doc/openfoam-guide-parallel.html">The decomposeParDict | OpenFOAM: User Guide</a></li><li><a href="https://github.com/OpenFOAM/OpenFOAM-4.x/blob/master/applications/utilities/parallelProcessing/decomposePar/decomposeParDict">decomposeParDict code</a></li></ul><table><thead><tr class="header"><th style="text-align: left;"><strong>Name</strong></th><th style="text-align: left;"><strong>Class</strong></th></tr></thead><tbody><tr class="odd"><td style="text-align: left;">none</td><td style="text-align: left;">Foam::noDecomp</td></tr><tr class="even"><td style="text-align: left;">manual</td><td style="text-align: left;">Foam::manualDecomp</td></tr><tr class="odd"><td style="text-align: left;">simple</td><td style="text-align: left;">Foam::simpleGeomDecomp</td></tr><tr class="even"><td style="text-align: left;">hierarchical</td><td style="text-align: left;">Foam::hierarchGeomDecomp</td></tr><tr class="odd"><td style="text-align: left;">kahip</td><td style="text-align: left;">Foam::kahipDecomp</td></tr><tr class="even"><td style="text-align: left;">metis</td><td style="text-align: left;">Foam::metisDecomp</td></tr><tr class="odd"><td style="text-align: left;">scotch</td><td style="text-align: left;">Foam::scotchDecomp</td></tr><tr class="even"><td style="text-align: left;">structured</td><td style="text-align: left;">Foam::structuredDecomp</td></tr><tr class="odd"><td style="text-align: left;">multiLevel</td><td style="text-align: left;">Foam::multiLevelDecomp</td></tr></tbody></table><p>If using metis,</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs c++">numberOfSubdomains   N;<br>method               metis;<br><br>metisCoeffs<br>&#123;<br>    method           k-way;  <span class="hljs-comment">// recursive or k-way</span><br>    <span class="hljs-built_in">options</span>          ( ...);<br>    <span class="hljs-built_in">processorWeights</span> ( ... );<br>&#125;<br></code></pre></td></tr></table></figure><p>error,</p><figure class="highlight console"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs console"><span class="hljs-meta prompt_">--&gt; </span><span class="language-bash">FOAM FATAL ERROR:</span> <br>You are trying to use metis but do not have the metisDecomp library loaded.<br>This message is from the dummy metisDecomp stub library instead.<br><br>Please install metis and make sure that libmetis.so is in your LD_LIBRARY_PATH.<br>The metisDecomp library can then be built from $FOAM_SRC/parallel/decompose/metisDecomp and dynamically loading or linking this library will add metis as a decomposition method.<br>Please be aware that there are license restrictions on using Metis.<br><br>    From function Foam::List&lt;signed int&gt; Foam::metisDecomp::decompose(const Foam::polyMesh &amp;, const Foam::Field&lt;Foam::Vector&lt;double&gt;&gt; &amp;, const Foam::Field&lt;double&gt; &amp;)<br>    in file dummyMetisDecomp.C at line 93.<br><br>FOAM exiting<br></code></pre></td></tr></table></figure><h2 id="run.sh-script">run.sh script</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment">## Loading OpenFOAM environment</span><br><br><span class="hljs-comment"># NP=Number of cores available in the system.</span><br><span class="hljs-built_in">export</span> NP=$(<span class="hljs-built_in">nproc</span>)<br><br><span class="hljs-comment"># Create decomposeParDict file to support $NP number of processes.</span><br><span class="hljs-built_in">cp</span> system/decomposeParDict.6 system/decomposeParDict.<span class="hljs-variable">$&#123;NP&#125;</span><br><br><span class="hljs-comment"># Change the numberOfSubdomains in decomposeParDict to create $NP number of subdomains</span><br>sed -i <span class="hljs-string">&quot;s/numberOfSubdomains.*/numberOfSubdomains <span class="hljs-variable">$&#123;NP&#125;</span>;/&quot;</span> system/decomposeParDict.<span class="hljs-variable">$&#123;NP&#125;</span><br><br><span class="hljs-comment">#Change the grid size for $NP, here setting grid size for 192 core system (48*4*1)</span><br>sed -i <span class="hljs-string">&quot;s/ n           (3 2 1)/ n           (48 4 1);/&quot;</span> system/decomposeParDict.<span class="hljs-variable">$&#123;NP&#125;</span><br><br><span class="hljs-comment">#Default Mesh size is very small (0.35M cells), scaling up the Mesh size to 20M cells</span><br>sed -i <span class="hljs-string">&quot;s/(20 8 8)/(100 40 40)/&quot;</span> system/blockMeshDict<br><br><span class="hljs-comment">#To use the file &quot;system/decomposeParDict.$&#123;NP&#125;&quot; in Allrun (run script)</span><br>sed -i <span class="hljs-string">&quot;s#system/decomposeParDict.6#system/decomposeParDict.<span class="hljs-variable">$&#123;NP&#125;</span>#&quot;</span> Allrun<br><br><span class="hljs-comment">#To run the benchmark</span><br><span class="hljs-comment">#Allrun script executes a combination multiple steps</span><br><span class="hljs-comment">#like Mesh creation, Setting the initial fields, Running the application, Postprocessing etc.</span><br>./Allrun<br></code></pre></td></tr></table></figure><h2 id="decomposepar"><code>decomposePar</code></h2><p>The <code>decomposePar</code> utility is executed in the normal manner by typing</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">decomposePar<br></code></pre></td></tr></table></figure><p>On completion, a set of subdirectories will have been created, one for each processor, in the case directory. The directories are named <code>processorN</code> represents a processor number and contains a time directory, containing the decomposed field descriptions, and a <code>constant/polyMesh</code> directory containing the decomposed mesh description.</p><h2 id="example-motorbike">Example, <code>motorBike</code></h2><ul><li><code>./Allrun</code></li></ul><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-meta">#!/bin/sh</span><br><span class="hljs-built_in">cd</span> <span class="hljs-variable">$&#123;0%/*&#125;</span> || <span class="hljs-built_in">exit</span> 1    <span class="hljs-comment"># Run from this directory</span><br><br><span class="hljs-comment"># Source tutorial run functions</span><br>. <span class="hljs-variable">$WM_PROJECT_DIR</span>/bin/tools/RunFunctions<br><br><span class="hljs-comment"># Copy motorbike surface from resources directory</span><br><span class="hljs-built_in">cp</span> <span class="hljs-variable">$FOAM_TUTORIALS</span>/resources/geometry/motorBike.obj.gz constant/triSurface/<br>runApplication surfaceFeatures<br><br>runApplication blockMesh<br><br>runApplication decomposePar -copyZero<br>runParallel snappyHexMesh -overwrite<br><br>runParallel patchSummary<br>runParallel potentialFoam<br>runParallel $(getApplication)<br><br>runApplication reconstructParMesh -constant<br>runApplication reconstructPar -latestTime<br></code></pre></td></tr></table></figure><p>and outputs are,</p><figure class="highlight console"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs console"><br>Cleaning /home/wpsze/openfoam/openfoam8/run/motorBike case<br>Running surfaceFeatures on /home/wpsze/openfoam/openfoam8/run/motorBike<br>Running blockMesh on /home/wpsze/openfoam/openfoam8/run/motorBike<br>Running decomposePar on /home/wpsze/openfoam/openfoam8/run/motorBike<br>Running snappyHexMesh in parallel on /home/wpsze/openfoam/openfoam8/run/motorBike using 6 processes<br>Running patchSummary in parallel on /home/wpsze/openfoam/openfoam8/run/motorBike using 6 processes<br>Running potentialFoam in parallel on /home/wpsze/openfoam/openfoam8/run/motorBike using 6 processes<br>Running simpleFoam in parallel on /home/wpsze/openfoam/openfoam8/run/motorBike using 6 processes<br>Running reconstructParMesh on /home/wpsze/openfoam/openfoam8/run/motorBike<br>Running reconstructPar on /home/wpsze/openfoam/openfoam8/run/motorBike<br><br>real5m5.399s<br>user27m17.537s<br>sys0m22.050s<br>=====================<br>Total of 311 seconds elapsed for process<br>Total of 5 minutes elapsed for process<br>=====================<br></code></pre></td></tr></table></figure><h1 id="post-processing-parallel-processed-cases">Post-processing parallel processed cases</h1><p>When post-processing cases that have been run in parallel the user can:</p><ul><li>reconstruct the mesh and field data to recreate the complete domain and fields, which can be post-processed as normal;</li><li>post-process each segment of decomposed domain individually; or</li><li>use ParaView via the option paraFoam -vtk and select the decomposedCase from the GUI whereby the case will be assembled internally</li></ul><h2 id="reconstructing-mesh-and-data">Reconstructing mesh and data</h2><p>The <code>reconstructPar</code> utility performs such a reconstruction by executing the command:</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">reconstructPar<br></code></pre></td></tr></table></figure><p>Executing <code>reconstructPar</code> without any additional options will process all stored time directories.</p><h1 id="issues">Issues</h1><ul><li><a href="https://cfd-china.com/topic/3170/openfoam%E5%9C%A8%E5%B9%B6%E8%A1%8C%E8%BF%90%E7%AE%97%E7%BB%93%E6%9D%9F%E5%90%8E-%E8%83%BD%E5%90%A6%E5%B9%B6%E8%A1%8Creconstructpar-%E6%88%96%E8%80%85%E6%9C%89%E6%B2%A1%E6%9C%89%E5%85%B6%E4%BB%96%E6%96%B9%E6%B3%95%E8%83%BD%E5%A4%9F%E5%8A%A0%E5%BF%ABreconstructpar">OpenFOAM在并行运算结束后 能否并行reconstructPar？或者有没有其他方法能够加快reconstructPar？</a><ul><li>最近跑了几个网格总数比较大的案例（大概500w~1000w），并行计算结束后，执行了reconstructPar进行重构，但是重构时间特别长。</li><li>试试这个 <code>mpirun -np 2 redistributePar -reconstruct -parallel</code></li><li>印象中以前看一个培训材料说分块和重构都只能单核</li><li>openfoam的decomposePar、reconstructPar是个老大难。这个应该需要大幅度的fund他们才会解决。目前他们对这方面还没有迫切的处理需求。目前openfoam针对reconstructPar这面的处理方式是后处理也是并行来搞，paraview直接看decompose的数据，各种postProcess也都是并行来。针对decomposePar慢的问题，openfoam这面是画网格snappyHexMesh直接并行来。所以我这面尝试处理2个亿网格，从生成到计算，也还可以。但是如果是第三方生成的2个亿网格，需要decomposePar，那可就慢了</li></ul></li></ul><h1 id="references">References</h1><ol type="1"><li><a href="https://www.openfoam.com/documentation/user-guide/3-running-applications/3.2-running-applications-in-parallel">3.2 Running applications in parallel</a></li><li><a href="https://hprc.tamu.edu/files/training/2024/Spring/Instructions_for_OpenFOAM_2024_spring.pdf">Instructions_for_OpenFOAM_2024_spring</a></li><li><a href="https://www.amd.com/zh-tw/developer/zen-software-studio/applications/spack/hpc-applications-openfoam.html">Build OpenFOAM using Spack</a></li><li><a href="https://www.openfoam.com/documentation/guides/latest/doc/openfoam-guide-parallel.html">The decomposeParDict | OpenFOAM: User Guide</a></li></ol>]]></content>
    
    
    <categories>
      
      <category>CFD</category>
      
    </categories>
    
    
    <tags>
      
      <tag>HPC</tag>
      
      <tag>OpenFOAM</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>CFD | OpenFOAM | Notes/Blogs</title>
    <link href="/2024/12/04/openfoam-notes/"/>
    <url>/2024/12/04/openfoam-notes/</url>
    
    <content type="html"><![CDATA[<h1 id="notesblogs-筆記部落格列表">Notes/Blogs 筆記/部落格列表</h1><ol type="1"><li><a href="https://www.diva-portal.org/smash/get/diva2:1458913/FULLTEXT01.pdf">CFD study and method development for air intake systems using OpenFOAM 2020 | GIOVANNI CALZOLARI</a><ol type="1"><li>KTH ROYAL INSTITUTE OF TECHNOLOGY SCHOOL OF ENGINEERING SCIENCES</li></ol></li><li><a href="https://blog.iaac.net/urban-wind-flow-modeling-with-pinns/?utm_source=perplexity">Urban Wind Flow Modeling with PINNs</a><ol type="1"><li>Data Sources<ol type="1"><li>Real-Time Wind Data: <code>OpenWeatherMap</code> wind conditions.</li><li>3D Building Models: <code>OpenStreetMap (OSM)</code> data using Overpass API.</li></ol></li><li><code>NVIDIA Modulus</code> and <code>PyTorch</code> are employed</li></ol></li><li><a href="https://ntrs.nasa.gov/citations/19920016719">Wall functions for the kappa-epsilon turbulence model in generalized nonorthogonal curvilinear coordinates | NASA 1992</a></li></ol>]]></content>
    
    
    <categories>
      
      <category>CFD</category>
      
    </categories>
    
    
    <tags>
      
      <tag>HPC</tag>
      
      <tag>OpenFOAM</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Bash | Measure the execution time</title>
    <link href="/2024/12/04/bash-Measure-the-execution-time/"/>
    <url>/2024/12/04/bash-Measure-the-execution-time/</url>
    
    <content type="html"><![CDATA[<h1 id="measure-the-execution-time">Measure the execution time</h1><h2 id="time"><code>time</code></h2><p>The <code>time</code> that you are using is the bash shell built in <code>time</code> which the only option is <code>-p</code></p><p>The command "time" report a execution time information</p><figure class="highlight console"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs console">time sleep 1<br><br>Output:<br>real 0m1.001s<br>user 0m0.000s<br>sys 0m0.001s<br></code></pre></td></tr></table></figure><p>Description:</p><ul><li><code>Real</code> - time from start to finish.</li><li><code>User</code> - the amount of CPU time spent in use-mode. It is actual CPU time used in executing the process.</li><li><code>Sys</code> - the amount of CPU time spent in kernel.</li></ul><h2 id="date-s"><code>date +%s</code></h2><p>You can measure execution time by subtraction start date and end date:</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># time elapsed</span><br>start_time=<span class="hljs-string">&quot;<span class="hljs-subst">$(date -u +%s)</span>&quot;</span><br><br>commands...<br><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;=====================&quot;</span><br>end_time=<span class="hljs-string">&quot;<span class="hljs-subst">$(date -u +%s)</span>&quot;</span><br>elapsed=<span class="hljs-string">&quot;<span class="hljs-subst">$(($end_time-$start_time)</span>)&quot;</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;Total of <span class="hljs-variable">$elapsed</span> seconds elapsed for process&quot;</span><br>time_mins=<span class="hljs-string">&quot;<span class="hljs-subst">$(($elapsed /60)</span>)&quot;</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;Total of <span class="hljs-variable">$time_mins</span> minutes elapsed for process&quot;</span><br>time_hours=<span class="hljs-string">&quot;<span class="hljs-subst">$(($elapsed /60/60)</span>)&quot;</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;Total of <span class="hljs-variable">$time_hours</span> hours elapsed for process&quot;</span> <br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;=====================&quot;</span><br></code></pre></td></tr></table></figure><h1 id="log-21"><code>&gt; log 2&gt;&amp;1 &amp;</code></h1><figure class="highlight console"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs console"><span class="hljs-meta prompt_">$ </span><span class="language-bash">time ./Allrun &gt; output_file.txt 2&gt;&amp;1 &amp;</span> <br></code></pre></td></tr></table></figure><h1 id="tee"><code>tee</code></h1><p>It basically breaks the output of a program so that it can be <strong>both displayed and saved in a file</strong>. It does both the tasks simultaneously, copies the result into the specified files or variables and also display the result.</p><figure class="highlight console"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs console"><span class="hljs-meta prompt_">$ </span><span class="language-bash">time ./Allrun | <span class="hljs-built_in">tee</span> output_file.txt</span> <br></code></pre></td></tr></table></figure><p><img src="https://media.geeksforgeeks.org/wp-content/uploads/tee-command-linux.jpg" width="600" /></p><h1 id="references">References</h1><ol type="1"><li><a href="https://www.geeksforgeeks.org/tee-command-linux-example/">tee command in Linux with examples</a></li></ol>]]></content>
    
    
    <categories>
      
      <category>Bash</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Linux</tag>
      
      <tag>Bash</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>LaTex | Formula Recognition | 數學公式識別軟體</title>
    <link href="/2024/12/04/latex-Formula-Recognition/"/>
    <url>/2024/12/04/latex-Formula-Recognition/</url>
    
    <content type="html"><![CDATA[<h1 id="數學公式識別軟體-simpletex">數學公式識別軟體 SimpleTex</h1><p>當需要編輯大量數學公式時，如果有一款軟體能夠識別公式圖片自動產生 Latex/Word 公式，這將極大的減少我們的工作量。</p><p>最近在網路上找到SimpleTex這款軟體，支援自動辨識圖片公式、手寫板公式辨識功能，試用一段時間感覺還可以。</p><p>專案網址：<a href="https://simpletex.cn/" class="uri">https://simpletex.cn/</a></p><p>SimpleTex 目前提供 Win 和 Mac 平台軟體安裝版，也提供網頁版功能<a href="https://simpletex.cn/ai/latex_ocr" class="uri">https://simpletex.cn/ai/latex_ocr</a>，可以先在網頁上試用，滿足需求的話可以考慮安裝本地軟體版本。</p><p><img src="https://i.imgur.com/Yh12yDl.png" width="600" /> <img src="https://i.imgur.com/P17jVOa.png" width="600" /></p><h1 id="mathpix-snip">Mathpix Snip</h1><p>Mathpix：Mathpix是專業的數學公式辨識工具，可將拍攝的數學公式轉換為 LaTeX 程式碼或 MathM L格式。它支援多種輸入方式，包括拍照識別和手寫輸入，適用於數學公式識別要求較高的用戶。</p><p>Mathpix Snip：Mathpix Snip是Mathpix的免費版本，可以透過截圖的方式識別數學公式並轉換為LaTeX程式碼。您可以使用它在電腦上快速識別網頁或文件中的數學公式。</p><ul><li><strong>Register</strong>: Now that you have verified your email address, you can start using the Snip apps to easily digitize math and science on your mobile and desktop devices. You are also welcome to use our Snip web app - a full-featured Markdown editor with PDF conversion support. For more information read Mathpix Snip app docs.</li><li><p><strong>Visit</strong> <a href="https://snip.mathpix.com/home" class="uri">https://snip.mathpix.com/home</a></p></li><li>Mathpix for MacOS, Windows &amp; Linux<ul><li><a href="https://mathpix.com/desktop-downloads" class="uri">https://mathpix.com/desktop-downloads</a></li></ul></li></ul><p><img src="https://i.imgur.com/LXfdzEk.png" width="600" /> <img src="https://i.imgur.com/ajciup1.png" width="600" /></p>]]></content>
    
    
    <categories>
      
      <category>LaTex</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>CFD | OpenFOAM | Allrun</title>
    <link href="/2024/12/03/openfoam-Allrun/"/>
    <url>/2024/12/03/openfoam-Allrun/</url>
    
    <content type="html"><![CDATA[<h1 id="allrun">Allrun</h1><p>All OpenFOAM tutorials have <code>Allrun</code> and <code>Allclean</code> scripts which call some mysterious RunFunctions from even more mysterious sources.</p><p>Source OpenFOAM first,</p><div class="note note-danger">            <p>source /home/wpsze/openfoam/openfoam8/source_openfoam.sh</p>          </div><h2 id="the-manual-way">The Manual Way</h2><p>To be honest, one could easily get along without those functions. Just call <code>OpenFOAM</code> applications by their name:</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-meta">#!/bin/sh</span><br> <br><span class="hljs-comment"># background mesh for Snappy</span><br>blockMesh &gt; log.blockMesh<br> <br><span class="hljs-comment"># decompose and mesh</span><br>decomposePar -force &gt; log.decomposePar<br>mpirun -np 4 snappyHexMesh -overwrite &gt; log.snappyHexMesh<br>mpirun -np 4 checkMesh &gt; log.checkMesh<br>mpirun -np 4 renumberMesh -overwrite &gt; log.renumberMesh<br> <br><span class="hljs-comment"># see an explanation below</span><br><span class="hljs-built_in">rm</span> -r 0<br><span class="hljs-built_in">cp</span> -r 0.orig 0<br> <br><span class="hljs-comment"># run the solver</span><br>mpirun -np 4 simpleFoam<br></code></pre></td></tr></table></figure><p>As you can see, it works just fine, but it does get a little verbose and repetitive. And if you decide to change the number of processors, you have to edit <code>system/decomposeParDict</code> and every parallel-running application call in all your scripts.</p><h2 id="runfunctions-to-the-rescue"><code>RunFunctions</code> to the Rescue</h2><p>These functions are defined in <code>$WM_PROJECT_DIR/bin/tools/RunFunctions</code> so if you want to use them, you have to tell Bash where they are (<strong>mind the dot at the beginning</strong>):</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-meta">#!/bin/shs</span><br><span class="hljs-built_in">cd</span> <span class="hljs-variable">$&#123;0%/*&#125;</span> || <span class="hljs-built_in">exit</span> 1    <span class="hljs-comment"># run from this directory</span><br><br>. <span class="hljs-variable">$&#123;WM_PROJECT_DIR:?&#125;</span>/bin/tools/RunFunctions<br> <br><span class="hljs-comment"># background mesh for Snappy</span><br>runApplication blockMesh<br> <br><span class="hljs-comment"># decompose and mesh</span><br>runApplication decomposePar -force<br>runParallel snappyHexMesh -overwrite<br>runParallel checkMesh<br>runParallel renumberMesh -overwrite<br> <br><span class="hljs-comment"># restore 0/ directory</span><br>restore0Dir<br> <br><span class="hljs-comment"># run the solver</span><br>runParallel $(getApplication)<br></code></pre></td></tr></table></figure><h3 id="runapplication">runApplication</h3><p><code>runApplication</code> will, as the name suggests, run the specified application.</p><ul><li><strong>It will redirect the app’s output to a log file.</strong></li><li><strong>Also, if the log exists, it will not run!</strong></li><li>If you don’t care about existing logs, you can overwrite it with <code>-o</code> option:<ul><li><code>runApplication -o decomposePar -force</code></li></ul></li><li>If you run the app multiple times and want the same log, append to an existing one with <code>-a</code> option:<ul><li><code>runApplication -a decomposePar -force</code></li></ul></li></ul><h3 id="runparallel">runParallel</h3><p>The same as runApplication but it will first <strong>read</strong> <code>system/decomposeParDict</code> to get number of processors. It will then run your app in parallel with MPI. The same logging options apply as to runApplication.</p><h3 id="getapplication">getApplication</h3><p>This will <strong>read</strong> <code>system/controlDict</code>.application and return that command. You will usually need this just to avoid hard-coding solvers. According to DRY principle, <strong>it is already specified in controlDict and that should be enough</strong>.</p><p>Instead, feed getApplication’s output to runApplication / runParallel:</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">runApplication $(getApplication)<br></code></pre></td></tr></table></figure><p>That saves you quite some steps:</p><ul><li>Matching decomposeParDict.numberOfSubdomains</li><li>Matching controlDict.application</li><li>Invoking MPI</li><li>Keeping log files and whatsit.</li></ul><h3 id="restore0dir">restore0Dir</h3><p>If you run <code>potentialFoam</code>, <code>setFields</code> and similar apps, they <strong>will overwrite boundary conditions</strong> that you meticulously prepared in your <code>0/</code> directory.</p><p>To prevent that from happening, it is wise to keep your boundary conditions in a directory where solvers can’t touch them and copy them to <code>0/</code> just before runs. It’s easy to do that by hand but <code>restore0Dir</code> will also take care of some other stuff (<code>#include</code> directives, parallel runs, …).</p><p>Anyway, a line saved is a line less to maintain.</p><h1 id="cleanfunctions">CleanFunctions</h1><p>There are more goodies that come in hand with RunFunctions! Type this into shell:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">cat</span> <span class="hljs-variable">$WM_PROJECT_DIR</span>/bin/tools/CleanFunctions<br></code></pre></td></tr></table></figure><p>and take a scroll through the output to find commands such as:</p><ul><li>cleanDynamicCode</li><li>cleanSnappyFiles</li><li>cleanPostProcessing</li><li>cleanCase</li><li>cleanCase0</li></ul><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-meta">#!/bin/sh</span><br><span class="hljs-built_in">cd</span> <span class="hljs-variable">$&#123;0%/*&#125;</span> || <span class="hljs-built_in">exit</span> 1    <span class="hljs-comment"># run from this directory</span><br><br><span class="hljs-comment"># Source tutorial clean functions</span><br>. <span class="hljs-variable">$WM_PROJECT_DIR</span>/bin/tools/CleanFunctions<br><br>cleanCase<br></code></pre></td></tr></table></figure><h1 id="references">References</h1><ol type="1"><li><a href="https://damogranlabs.com/2020/10/runfunctions-a-quick-cheatsheet/">RunFunctions: a Quick Cheatsheet</a></li><li><a href="https://ml-cfd.com/openfoam/basic/2020/06/12/3-ways-to-run-tutorials-in-OpenFOAM.html">3 ways to run tutorials in OpenFOAM</a></li><li><a href="https://www.openfoam.com/documentation/user-guide/3-running-applications/3.2-running-applications-in-parallel">3.2 Running applications in parallel</a></li><li><a href="https://www.amd.com/zh-tw/developer/zen-software-studio/applications/spack/hpc-applications-openfoam.html">Build OpenFOAM using Spack</a></li></ol>]]></content>
    
    
    <categories>
      
      <category>CFD</category>
      
    </categories>
    
    
    <tags>
      
      <tag>HPC</tag>
      
      <tag>OpenFOAM</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Linux | ffmpeg </title>
    <link href="/2024/12/02/ffmpeg/"/>
    <url>/2024/12/02/ffmpeg/</url>
    
    <content type="html"><![CDATA[<h1 id="ffmpeg">FFmpeg</h1><p>FFmpeg 是一個開放原始碼的自由軟件，可以執行音頻和視像多種格式的錄影、轉檔、串流功能，包含了libavcodec ——這是一個用於多個專案中音頻和視像的解碼器函式庫，以及libavformat——一個音頻與視像格式轉換函式庫。該專案的名稱靈感來源於 MPEG 影片標準組織，其中「FF」代表「快進」（fast forward），因此FFmpeg代表「快進動態圖像專家組」。其標誌是一個之字形掃描圖案，顯示了 MPEG 影片編解碼器如何處理熵編碼。</p><p>動態影像專家小組（英語：Moving Picture Experts Group，簡稱MPEG）為一源自國際標準化組織 (ISO) 與國際電工委員會 (IEC) 等國際組織的工作小組，成立於1988年，有超過300名專家一起制定影音壓縮及傳輸的規格標準。</p><p>此計劃由幾個元件組成：命令列應用程式</p><ul><li><code>ffmpeg</code> : 用於對視訊檔案或音頻檔案轉換格式</li><li><code>ffplay</code> : 一個簡單的播放器，基於SDL與FFmpeg函式庫</li><li><code>ffprobe</code> : 用於顯示媒體檔案的資訊</li></ul><h2 id="convert-mp4-to-gif">Convert mp4 to gif</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh">ffmpeg -i input.mp4 -pix_fmt rgb24 output.gif<br>ffmpeg -i input.mp4 -pix_fmt gray output.gif<br></code></pre></td></tr></table></figure><h2 id="cuttrim-a-video">Cut/trim a video</h2><p>The fastest and best ffmpeg-based method I have figured out is:</p><figure class="highlight console"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs console">ffmpeg -ss 00:01:00 -to 00:08:00 -i input.mp4 -c:v copy -c:a copy output.mp4<br></code></pre></td></tr></table></figure><p>This command trims your video in seconds!</p><p>Also, the <code>-t</code> option specifies a duration, not an end time. The above command will encode 7s of video starting at 1s. To start at 1s and end at 8s use <code>-t 7</code>. If you are using a current version of ffmpeg you can also replace <code>-t</code> with <code>-to</code> in the above command to end at the specified time.</p><p>The <code>-c:v copy -c:a copy</code> commands copy the original audio and video without re-encoding.</p><h2 id="change-the-output-frame-rate"><a href="https://trac.ffmpeg.org/wiki/ChangingFrameRate">Change the output frame rate</a></h2><p>To change the output frame rate to 30 fps, use the following command: <a href="https://ffmpeg.org/ffmpeg-filters.html#fps-1">docs</a></p><figure class="highlight console"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs console">ffmpeg -i &lt;input&gt; -filter:v fps=30 &lt;output&gt;<br></code></pre></td></tr></table></figure><h2 id="speeding-upslowing-down-video"><a href="https://trac.ffmpeg.org/wiki/How%20to%20speed%20up%20/%20slow%20down%20a%20video">Speeding up/slowing down video</a></h2><p>To double the speed of the video with the setpts filter, you can use: or<br />To slow down your video, you have to use a multiplier greater than 1:</p><figure class="highlight console"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs console">ffmpeg -i input.mp4 -filter:v &quot;setpts=0.5*PTS&quot; output.mp4<br>ffmpeg -i input.mp4 -filter:v &quot;setpts=2.0*PTS&quot; output.mp4<br></code></pre></td></tr></table></figure><h2 id="compress-video">Compress video</h2><h3 id="h264-codec-and-mp4-container">H264 codec and MP4 container</h3><p>To convert the MOV file to MP4 and compress it using the H.264 codec run the following command from the folder you saved the input.mov sample file:</p><figure class="highlight console"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs console">ffmpeg -i input.mov -c:v libx264 -pix_fmt yuv420p output.mp4<br></code></pre></td></tr></table></figure><ul><li><code>-i input.mov</code> : - specifies the input video file.</li><li><code>-c:v libx264</code> : - sets the video compression codec to H.264 (libx264).</li><li><code>-pix_fmt yuv420p</code> : - changes the ProRes pixel format (4:2:2) to H.264 compatible pixel format (4:2:0). output.mp4 - the name of the output file.</li></ul><h3 id="h265-codec-and-mp4-container">H265 codec and MP4 container</h3><figure class="highlight console"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs console">ffmpeg -i input.mov -c:v libx265 -pix_fmt yuv420p output.mp4<br></code></pre></td></tr></table></figure><h3 id="using-constant-rate-factor-crf-to-compress-the-video">Using Constant Rate Factor (CRF) to compress the video</h3><p>The command looks like this, with the -crf 28 option added:</p><figure class="highlight console"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs console">ffmpeg -i input.mov -c:v libx264 -pix_fmt yuv420p -crf 28 output.mp4<br></code></pre></td></tr></table></figure><h3 id="optimising-the-compression-and-encoding-settings">Optimising the compression and encoding settings</h3><p>There are many other command-line options that we can use to configure how FFmpeg performs the compression. Consider this command:</p><figure class="highlight console"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs console">ffmpeg -i input.mov -c:v libx264  -pix_fmt yuv420p -crf 28 -preset fast -tune zerolatency -c:a aac output.mp4<br></code></pre></td></tr></table></figure><h3 id="compress-video-by-reducing-the-resolution">Compress video by reducing the resolution</h3><p>Reducing the video width and height (input.mov file is 1920px x 1080px,)</p><figure class="highlight console"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs console">ffmpeg -i input.mov -c:v libx264 -pix_fmt yuv420p -crf 28 -vf scale=1280:720 output.mp4<br></code></pre></td></tr></table></figure><p>It is also common to maintain the aspect ratio of the video so it does not become distorted. To do this we can use the scale filter with a <code>-1</code> value, which will automatically calculate the correct height or width based on the other dimension. Like this:</p><figure class="highlight console"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs console">ffmpeg -i input.mov -c:v libx264 -pix_fmt yuv420p -crf 28 -vf scale=-1:720 output.mp4<br></code></pre></td></tr></table></figure><p>This will resize the height to 720px, while maintaining the original aspect ratio of the video.</p><h3 id="compress-video-by-reducing-the-bitrate">Compress video by reducing the bitrate</h3><p>Reducing video bitrate</p><figure class="highlight console"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs console">ffmpeg -i input.mov -c:v libx264 -pix_fmt yuv420p -b:v 1000k -vf scale=-1:720 output.mp4<br></code></pre></td></tr></table></figure><p>Here, we replace the <code>-crf</code> parameter and use the <code>-b:v 1000k</code> option to set the video bitrate to 1000 Kbps.</p><p>Reducing audio bitrate</p><figure class="highlight console"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs console">ffmpeg -i input.mov -c:v libx264 -pix_fmt yuv420p -b:v 1000k -b:a 128k -vf scale=-1:720 output.mp4<br></code></pre></td></tr></table></figure><p>We added the <code>-b:a 128k</code> to set the audio bitrate to 128 Kbps. This won't have any effect on our sample video as it doesn't have any audio.</p><h1 id="references">References</h1><ol type="1"><li><a href="https://www.ffmpeg.org/documentation.html">ffmpeg.org | Documentation</a></li><li><a href="https://shotstack.io/learn/compress-video-ffmpeg/">How to compress video using FFmpeg</a></li></ol>]]></content>
    
    
    <categories>
      
      <category>Linux</category>
      
    </categories>
    
    
    <tags>
      
      <tag>ffmpeg</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>CFD | SIMPLE 算法</title>
    <link href="/2024/11/26/CFD-SIMPLE-algorithm/"/>
    <url>/2024/11/26/CFD-SIMPLE-algorithm/</url>
    
    <content type="html"><![CDATA[<h1 id="不可壓縮-navier-stokes-方程"><strong>不可壓縮 Navier-Stokes 方程</strong></h1><p>對於不可壓縮Navier-Stokes方程，可以表示為：</p><h2 id="動量方程"><strong>動量方程：</strong></h2><p><span class="math display">\[\rho \frac{\partial \mathbf{u}}{\partial t} + \rho (\mathbf{u} \cdot \nabla) \mathbf{u} = -\nabla p + \mu \nabla^2 \mathbf{u} + \mathbf{f}\]</span></p><h2 id="穩狀"><strong>穩狀:</strong></h2><p><span class="math display">\[\frac{\partial \mathbf{u}}{\partial t} = 0\]</span></p><h2 id="連續方程"><strong>連續方程：</strong></h2><p><span class="math display">\[\nabla \cdot \mathbf{u} = 0\]</span></p><p>式中有 4 個待求的物理量：</p><ul><li><span class="math inline">\(\mathbf{u}_x\)</span>：在 <span class="math inline">\(x\)</span> 方向的速度分量，</li><li><span class="math inline">\(\mathbf{u}_y\)</span>：在 <span class="math inline">\(y\)</span> 方向的速度分量，</li><li><span class="math inline">\(\mathbf{u}_z\)</span>：在 <span class="math inline">\(z\)</span> 方向的速度分量，</li><li><span class="math inline">\(p\)</span>：壓力。</li></ul><p>其中：</p><ul><li><span class="math inline">\(p\)</span> 為壓力（pressure），</li><li><span class="math inline">\(\mu\)</span> 為運動黏度（dynamic viscosity），</li><li><span class="math inline">\(\rho\)</span> 為流體密度，</li><li><span class="math inline">\(\mathbf{f}\)</span> 為體積力，例如重力或外加力。</li></ul><p>在求解不可壓縮 Navier-Stokes方 程時，會遇到以下兩個主要困難：</p><ol type="1"><li><strong>壓力的顯式求解</strong>：壓力 <span class="math inline">\(\nabla p\)</span> 隱藏在動量方程中，與速度場 <span class="math inline">\(\mathbf{u}\)</span> 相耦合，沒有顯式的壓力求解方式。</li><li><strong>連續性約束</strong>：從動量方程中求解出的速度場 <span class="math inline">\(\mathbf{u}\)</span> 不一定滿足連續方程 <span class="math inline">\(\nabla \cdot \mathbf{u} = 0\)</span> 的不可壓縮性條件。</li></ol><h1 id="simple-演算法">SIMPLE 演算法</h1><p>SIMPLE（Semi-Implicit Method for Pressure-Linked Equations）演算法是針對上述問題提出的一種數值求解方法，主要透過壓力校正來分解耦合問題。其步驟如下：</p><ol type="1"><li><strong>動量方程離散化：</strong><br />將動量方程寫成矩陣形式： <span class="math display">\[[M] \mathbf{u} = \mathbf{b}\]</span> 其中 <span class="math inline">\([M]\)</span> 是係數矩陣，<span class="math inline">\(\mathbf{u}\)</span> 是速度場，<span class="math inline">\(\mathbf{b}\)</span> 是包含壓力梯度項和其它源項的向量。</li></ol><hr /><p>在不可壓縮Navier-Stokes方程中，壓力的直接求解通常利用 <strong>壓力 Poisson 方程</strong>。該方程是從動量方程與連續性條件組合推導而來，用於確保速度場滿足不可壓縮條件（<span class="math inline">\(\nabla \cdot \mathbf{u} = 0\)</span>）。推導過程如下：</p><hr /><h2 id="壓力-poisson-方程的推導">壓力 Poisson 方程的推導</h2><ol type="1"><li><p><strong>連續方程：</strong> <span class="math display">\[\nabla \cdot \mathbf{u} = 0\]</span></p></li><li><p><strong>動量方程：</strong> <span class="math display">\[\rho \frac{\partial \mathbf{u}}{\partial t} + \rho (\mathbf{u} \cdot \nabla) \mathbf{u} = -\nabla p + \mu \nabla^2 \mathbf{u} + \mathbf{f}\]</span></p><p>將動量方程兩側對空間做散度運算，得到： <span class="math display">\[\nabla \cdot \left[ \rho \frac{\partial \mathbf{u}}{\partial t} + \rho (\mathbf{u} \cdot \nabla) \mathbf{u} \right] = -\nabla^2 p + \nabla \cdot (\mu \nabla^2 \mathbf{u}) + \nabla \cdot \mathbf{f}\]</span></p></li><li><p><strong>利用連續性約束：</strong> 假設 <span class="math inline">\(\mathbf{u}\)</span> 不完全滿足連續性，為了修正壓力，考慮壓力與速度的相互影響，可得壓力 Poisson 方程的通用形式： <span class="math display">\[\nabla^2 p = \nabla \cdot \left[ \rho (\mathbf{u} \cdot \nabla) \mathbf{u} \right] - \rho \frac{\partial (\nabla \cdot \mathbf{u})}{\partial t} + \nabla \cdot \mathbf{f}.\]</span></p></li><li><p><strong>穩態情況：</strong> 當系統處於穩態且外力項可忽略時，簡化為： <span class="math display">\[\nabla^2 p = \rho \nabla \cdot \left[ (\mathbf{u} \cdot \nabla) \mathbf{u} \right].\]</span></p></li></ol><hr /><h2 id="使用壓力-poisson-方程的目標">使用壓力 Poisson 方程的目標</h2><ul><li><strong>修正壓力場：</strong> 確保修正後的速度場滿足不可壓縮條件。</li><li><strong>耦合速度與壓力：</strong> 將壓力從動量方程顯性分離，通過 壓力 Poisson 方程 <strong>解壓力</strong>後，<strong>代入動量方程修正速度場</strong>。</li></ul><hr /><p>壓力 Poisson 方程的解法通常基於離散化數值技術，例如有限差分法、有限體積法等，通過求解壓力校正場 <span class="math inline">\(p&#39;\)</span> 來逐步逼近最終滿足 <span class="math inline">\(\nabla \cdot \mathbf{u} = 0\)</span> 的速度場。</p><p>SIMPLE (Semi-Implicit Method for Pressure Linked Equations) 是一種數值方法，用於解決不可壓縮Navier-Stokes方程中的速度和壓力耦合問題。</p><hr /><h3 id="注意事項">注意事項</h3><ol type="1"><li><p><strong>欠鬆弛因子的作用</strong><br />欠鬆弛因子在每次迭代中減小更新幅度，防止發散，提高算法穩定性。</p></li><li><p><strong>網格選擇</strong><br />壓力和速度的網格離散化需滿足 <strong>交錯網格法（staggered grid）</strong>，以避免數值擴散或壓力震盪問題。</p></li><li><p><strong>收斂條件</strong><br />選擇合適的殘差範圍和迭代次數限制，確保結果的準確性和計算效率。</p></li></ol><p>SIMPLE 是一種穩健且簡單的方法，適合處理<strong>穩態不可壓縮流體問題</strong>，但在處理瞬態或高雷諾數流體時，可能需要改進版本，如 SIMPLEC 或 PISO。</p><hr /><p>SIMPLE演算法求解過程總結為如下4步：</p><ol type="1"><li>由給定的初始壓力或上一迭代步壓力求解動量方程，但是求得的速度變數並不一定滿足連續性方程。</li><li>根據壓力泊松方程式求解得到壓力。</li><li>利用求得的壓力修正速度，使之能滿足連續性方程式.</li><li>若速度不滿足動量方程，請回到步驟（1）重複循環，直到滿足為止。</li></ol><p>那其他的標量方程式怎麼辦？例如能量方程式、湍流方程式 <span class="math inline">\(k\)</span> 方程式及 <span class="math inline">\(\epsilon\)</span> 方程式等。這些方程式也可以放到上數求解循環中，只要放到速度修正方程式後依序求解即可。</p><figure><img src="https://i.imgur.com/QoJMran.png" alt="SIMPLE" width="600" /><figcaption>SIMPLE</figcaption></figure><p>PISO演算法是在SIMPLE以後發展出來，最初為 <strong>瞬態</strong> <strong>不可壓縮流動</strong> 設計的一種演算法。 PISO演算法與SIMPLE演算法的差異在於速度場由速度修正方程修正後，並沒有直接回到如下動量方程進行迭代循環，而是直接進行更新H矩陣，求解壓力泊松方程，因此動量方程只是初始迭代使用過一次，此後便不再使用，因此相比 SIMPLE 演算法計算量減少，速度更快。</p><div class="note note-danger">            <p>由於有方程式的<strong>時間導數項</strong>，<strong>PISO演算法在瞬態流動計算時候比較穩定</strong>。<strong>當時間步長比較小時，時間導數項會遠大於動量方程式對流項、擴散項、源項等其他項，而由於時間倒數項會出現矩陣對角陣上，因此小的時間步長就會使矩陣對角佔優，這種矩陣特性會使方程式的解更加穩定，花費較少的迭代步達到收斂</strong>。</p><p><span class="math display">\[\dfrac{\partial U}{\partial t} = \dfrac{U_p^{i+1} - U_p^{i}}{\Delta t}\]</span></p>          </div><p>當然從另一方面來說，由於穩態流動沒有時間導數項，因此若簡單使用SIMPLE演算法就不如PISO演算法穩定，<strong>因此SIMPLE演算法會以使用鬆弛因子的方式人工增加對角矩陣係數，使方程式求解更加穩定</strong>，具體細節這裡就不再多說了。</p><p>總的來說吧，PISO演算法比較適合瞬態不可壓縮流體。當時間步長足夠小時（庫朗數&lt;1）時，就不需要人工增加對角矩陣係數，使其對角佔優，只需要做一次動量方程式求解，然後對壓力方程式及速度修正方程式進行迭代循環即可收斂。</p><figure><img src="https://i.imgur.com/2NqUqHH.png" alt="PISO" width="600" /><figcaption>PISO</figcaption></figure><h1 id="references">References</h1><ol type="1"><li><a href="http://staff.ustc.edu.cn/~humaobin/course/cht/ppt/6.0.pdf">第6章 回流问题流动－传热 耦合计算的数值方法</a></li><li><a href="http://staff.ustc.edu.cn/~humaobin/course/cht/ppt/6.4.pdf">6.4 原始变量顺序求解流场的 压力修正方法</a></li><li><a href="https://mp.weixin.qq.com/s/vEoW0lTb5QbfTFs7FZwGQQ">OpenFOAM编程案例 | 14 SIMPLE算法</a></li><li><a href="https://www.youtube.com/watch?v=OOILoJ1zuiw&amp;ab_channel=FluidMechanics101">[CFD] The SIMPLE Algorithm (to solve incompressible Navier-Stokes)</a></li><li><a href="https://zhuanlan.zhihu.com/p/126368311?utm_psn=1845836334389919744">什么是SIMPLE及PISO算法？</a></li><li><a href="https://www.cfdsupport.com/OpenFOAM-Training-by-CFD-Support/node199.html">SIMPLE algorithm description</a></li></ol>]]></content>
    
    
    <categories>
      
      <category>CFD</category>
      
    </categories>
    
    
    <tags>
      
      <tag>HPC</tag>
      
      <tag>OpenFOAM</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>WRF | WPS in parallel or in serial</title>
    <link href="/2024/11/25/wps-in-parallel-or-in-serial/"/>
    <url>/2024/11/25/wps-in-parallel-or-in-serial/</url>
    
    <content type="html"><![CDATA[<ul><li><strong>keywords: metgrid.exe, geogrid.exe, dmpar, serial</strong></li></ul><h1 id="wrfwps-compilation-tutorial"><a href="https://www2.mmm.ucar.edu/wrf/OnLineTutorial/compilation_tutorial.php">WRF/WPS Compilation Tutorial</a></h1><p>You should be given a list of various options for compiler types, whether to compile in serial or parallel, and whether to compile ungrib with GRIB2 capability. Unless you plan to create extremely large domains,</p><div class="note note-danger">            <p><strong>It is recommended to compile WPS in serial mode, regardless of whether you compiled WRF in parallel.</strong></p>          </div><h1 id="resolved-serial-vs.-dmpar-jan-15-2019"><a href="https://forum.mmm.ucar.edu/threads/resolved-serial-vs-dmpar.583/">(RESOLVED) serial vs. dmpar | Jan 15, 2019</a></h1><p>That is a good question. <strong>We have just found that the advantage to running WPS in parallel isn't that beneficial (or much faster) than a simple serial run</strong>, as the WPS programs run so quickly anyway. We do find that it is necessary if you have very large domains (1000's x 1000's of grid cells). That being said, if you are finding that it speeds up the process for your runs, then it should be perfectly fine to use parallel processing. As I'm sure you already know, geogrid and metgrid are the only programs that can be run in parallel. Ungrib must still be run serially.</p><h1 id="using-mpas-output-for-wrf-initial-and-lateral-boundary-conditions">Using MPAS Output for WRF Initial and Lateral Boundary Conditions</h1><div class="note note-warning">            <p><a href="https://www2.mmm.ucar.edu/wrf/users/docs/user_guide_v4/v4.2/users_guide_chap3.html#_Using_MPAS_Output">Using MPAS Output for WRF Initial and Lateral Boundary Conditions</a></p>          </div><ul><li><a href="https://waipangsze.github.io/2024/11/13/WRF-MPAS-as-ICBC/" class="uri">https://waipangsze.github.io/2024/11/13/WRF-MPAS-as-ICBC/</a></li></ul><div class="note note-warning">            <p><strong>It is worth noting that the use of native MPAS output with metgrid.exe has not been thoroughly tested for parallel (i.e., “dmpar”) builds of the WPS; it is therefore recommended to run metgrid.exe in serial when processing MPAS datasets.</strong></p>          </div><p><strong>Please use 1 core (serial) to run metgrid.exe.</strong> Otherwise, the wrfout will be fail even (dmpar) of metgrid seems to be done.</p><div class="note note-danger">            <p><strong>sbatch -N 1 -n 1 run_metgrid.sh</strong></p>          </div>]]></content>
    
    
    <categories>
      
      <category>WRF</category>
      
    </categories>
    
    
    <tags>
      
      <tag>WRF</tag>
      
      <tag>WPS</tag>
      
      <tag>MPAS</tag>
      
      <tag>IC/BC</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>CFD | OpenFOAM Installation</title>
    <link href="/2024/11/20/CFD-openfoam-installation/"/>
    <url>/2024/11/20/CFD-openfoam-installation/</url>
    
    <content type="html"><![CDATA[<h1 id="openfoam">OpenFOAM</h1><p>OpenFOAM是一個CFD軟體。它包括一系列應用程序，這些應用程式在CFD中執行一系列任務。應用程式主要分為兩類：<a href="http://www.dyfluid.com/openfoam11-1.html#id1">link</a></p><ul><li>求解器，用於執行CFD計算；</li><li>以及實現上述任務的其他程序；</li></ul><p>在OpenFOAM-11之前，每個流動類型都需要呼叫特定的求解器。由於流動類型非常多，OpenFOAM層包含了近100個解算器。像simpleFoam和pimpleFoam這樣的求解器自上世紀90年代初以來一直是OpenFOAM的主力。</p><p>然而<strong>OpenFOAM-11引進了模組化求解器，其為一個重大的改進</strong>。應用程式解算器被單一foamRun求解器取代，foamRun是一個框架性求解器。 foamRun可以載入一個求解器模組，該模組繼續呼叫對應的流動類型。例如之前simpleFoam以及pisoFoam的算例，都採用foamRun求解器來運作。在foamRun求解器程式碼中，會依據對應的演算法進行調整。這在程式碼層次的改動是相當大的。 OpenFOAM-11可以認為是一次徹底的改變。官方將這次改動的原因解釋為更加的貼近多物理場的特性，對於多物理場的耦合更加的成熟。當然這裡面也存在商業上的原因。</p><p>特別的，OpenFOAM-11還有一個foamMultiRun求解器，它可以接受兩個或更多域區域，並為每個區域應用不同的求解器模組。例如，它可以將一個或多個流體和固體的模組耦合起來，典型的引用就是多區域傳熱流動。</p><ul><li><a href="https://cfd-china.com/topic/6484/openfoam-11-openfoam-v2306">OpenFOAM-11，OpenFOAM-v2306 | Jul 13, 2023 | CFD中文网</a>, <a href="https://cfd-china.com/topic/7189/openfoam-11">openFoam-11 | CFD中文网</a><ul><li>ESI以及基金会纷纷推出OpenFOAM-v2306以及OpenFOAM-v11。后者改动尤其巨大。求解器模块化，比如之前的icoFoam是个求解器，但目前被处理成了一个库。OpenFOAM-v11比之前，在多物理场耦合方面，更加友好。但更加增加了使用难度。</li><li>尤其是对于OpenFOAM-11这面。OpenFOAM这面几个大改动，一个是OpenFOAM-3.0，一个是OpenFOAM-11。这个OpenFOAM-11改的，改的相当大。</li><li>是。。。OpeNFOAM11改动很大.. 我开始用了都发蒙</li><li>你就用paraFoam -buildin也行，我自己也用这个（如果不看做拉格朗日粒子的话）</li></ul></li></ul><h1 id="binarysource-package">Binary/Source Package</h1><ul><li><a href="https://dl.openfoam.org/">OpenFOAM Binary/Source Package Repository</a><ul><li>source/ Source Code Packs for Compiling OpenFOAM (v1.7.0-12) on Linux</li><li>third-party/ Source Code Packs of Third Party Software supporting OpenFOAM (v1.7.0-12) on Linux</li></ul></li></ul><h1 id="software-for-compilation"><a href="https://openfoam.org/download/source/software-for-compilation/">Software for Compilation</a></h1><div class="note note-primary">            <p><a href="https://waipangsze.github.io/2023/05/06/Intel_OneAPI/">Intel OneAPI installation</a></p>          </div><p>原理：OpenFOAM編譯需要一些軟體和函式庫，像是 <code>flex</code>, <code>zlib</code> 之類</p><p>Repository and compilation software:</p><ul><li><code>Git</code> distributed version control software used for the OpenFOAM source repositories.</li><li><code>Compiler</code>: either GCC version 5.5 or above; or LLVM Clang version 16 or above (possibly earlier); or the Intel oneAPI DPC++/C++ Compiler version 2021.3.0 or above. GCC is most commonly available and the version can be checked by typing</li><li><code>FLEX</code> fast lexical analyser, used by OpenFOAM for reading files of third-party format</li><li><code>cmake</code> build software for compiling ParaView, the third-party visualisation toolkit.</li></ul><p>Software for <code>OpenFOAM</code> (and <code>ParaView</code>):</p><ul><li><code>OpenMPI</code> message passing interface for parallel computation.</li><li><code>ParaView</code> can be installed as a system package, in which case its dependencies do not need to be installed. However, in order to compile its reader modules within OpenFOAM, all its dependencies need to be installed including the development environments of QT, graphics (GL), data formats, etc</li></ul><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs sh"> $ micromamba <span class="hljs-built_in">env</span> create -n cfd_env<br>Empty environment created at prefix: /home/wpsze/micromamba/envs/cfd_env<br> $ micromamba install conda-forge::zlib<br> $ micromamba install anaconda::cmake<br> $ micromamba install conda-forge::flex<br> $ micromamba install conda-forge::bison<br> $ micromamba install conda-forge::cgal<br> $ micromamba install anaconda::metis<br></code></pre></td></tr></table></figure><h2 id="載入環境">載入環境</h2><p>安裝需要載入 Intel 編譯環境和 gcc 環境，且 gcc 環境不應高於 Intel 編譯器環境</p><h2 id="environment-variables">Environment variables</h2><h3 id="wm-options">WM options</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs sh">WM_THIRD_PARTY_DIR=<span class="hljs-variable">$HOME</span>/OpenFOAM/ThirdParty-1.6.x<br>WM_PROJECT_INST_DIR=<span class="hljs-variable">$HOME</span>/OpenFOAM<br>WM_PROJECT_DIR=<span class="hljs-variable">$HOME</span>/OpenFOAM/OpenFOAM-1.6.x<br>WM_DIR=<span class="hljs-variable">$HOME</span>/OpenFOAM/OpenFOAM-1.6.x/wmake<br>WM_PROJECT_USER_DIR=<span class="hljs-variable">$HOME</span>/OpenFOAM/<span class="hljs-variable">$USER</span>-1.6.x<br><br>WM_PRECISION_OPTION=DP<br>WM_ARCH_OPTION=64<br>WM_LINK_LANGUAGE=c++<br>WM_ARCH=linux64<br>WM_CXXFLAGS=-m64 -fPIC<br>WM_CFLAGS=-m64 -fPIC<br>WM_PROJECT_VERSION=1.6.x<br>WM_COMPILER_LIB_ARCH=64<br>WM_CXX=g++<br>WM_COMPILER_ARCH=<br>WM_PROJECT=OpenFOAM<br>WM_LDFLAGS=-m64<br>WM_COMPILER=Gcc<br>WM_MPLIB=OPENMPI<br>WM_CC=gcc<br>WM_COMPILE_OPTION=Opt<br>WM_OPTIONS=linux64GccDPOpt<br>WM_PRECISION_OPTION=DP<br>WM_ARCH_OPTION=64<br></code></pre></td></tr></table></figure><h3 id="foam-options">FOAM options</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs sh">FOAM_SOLVERS=<span class="hljs-variable">$HOME</span>/OpenFOAM/OpenFOAM-1.6.x/applications/solvers<br>FOAM_APPBIN=<span class="hljs-variable">$HOME</span>/OpenFOAM/OpenFOAM-1.6.x/applications/bin/linux64GccDPOpt<br>FOAM_TUTORIALS=<span class="hljs-variable">$HOME</span>/OpenFOAM/OpenFOAM-1.6.x/tutorials<br>FOAM_JOB_DIR=<span class="hljs-variable">$HOME</span>/OpenFOAM/jobControl<br>FOAM_LIB=<span class="hljs-variable">$HOME</span>/OpenFOAM/OpenFOAM-1.6.x/lib<br>FOAM_SITE_APPBIN=<span class="hljs-variable">$HOME</span>/OpenFOAM/site/1.6.x/bin/linux64GccDPOpt<br>FOAM_MPI_LIBBIN=<span class="hljs-variable">$HOME</span>/OpenFOAM/OpenFOAM-1.6.x/lib/linux64GccDPOpt/openmpi-1.3.3<br>FOAM_APP=<span class="hljs-variable">$HOME</span>/OpenFOAM/OpenFOAM-1.6.x/applications<br>FOAM_SITE_LIBBIN=<span class="hljs-variable">$HOME</span>/OpenFOAM/site/1.6.x/lib/linux64GccDPOpt<br>FOAM_SRC=<span class="hljs-variable">$HOME</span>/OpenFOAM/OpenFOAM-1.6.x/src<br>FOAM_SIGFPE=<br>FOAM_UTILITIES=<span class="hljs-variable">$HOME</span>/OpenFOAM/OpenFOAM-1.6.x/applications/utilities<br>FOAM_USER_LIBBIN=WM_PROJECT_USER_DIR/lib/linux64GccDPOpt<br>FOAM_INST_DIR=<span class="hljs-variable">$HOME</span>/OpenFOAM<br>FOAM_LIBBIN=<span class="hljs-variable">$HOME</span>/OpenFOAM/OpenFOAM-1.6.x/lib/linux64GccDPOpt<br>FOAM_RUN=WM_PROJECT_USER_DIR/run<br>FOAM_USER_APPBIN=WM_PROJECT_USER_DIR/applications/bin/linux64GccDPOpt<br></code></pre></td></tr></table></figure><h3 id="other-options">Other options</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs sh">MPI_ARCH_PATH=<span class="hljs-variable">$HOME</span>/OpenFOAM/ThirdParty-1.6.x/openmpi-1.3.3/platforms/linux64GccDPOpt<br>ParaView_INST_DIR=<span class="hljs-variable">$HOME</span>/OpenFOAM/ThirdParty-1.6.x/paraview-3.6.1<br>OPAL_PREFIX=<span class="hljs-variable">$HOME</span>/OpenFOAM/ThirdParty-1.6.x/openmpi-1.3.3/platforms/linux64GccDPOpt<br>ParaView_DIR=<span class="hljs-variable">$HOME</span>/OpenFOAM/ThirdParty-1.6.x/paraview-3.6.1/platforms/linux64Gcc<br>PARAVIEW_DIR=/opt/packages/Paraview3<br>ParaView_VERSION=3.6.1<br>MPI_HOME=<span class="hljs-variable">$HOME</span>/OpenFOAM/ThirdParty-1.6.x/openmpi-1.3.3<br></code></pre></td></tr></table></figure><h2 id="修改openfoam的配置">修改OpenFOAM的配置</h2><h3 id="for-openfoam-11etcbashrc">For OpenFOAM-11/<code>etc/bashrc</code>,</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs sh">59 <span class="hljs-comment">#- Compiler location:</span><br>60 <span class="hljs-comment">#    WM_COMPILER_TYPE= system | ThirdParty (OpenFOAM)</span><br>61 <span class="hljs-built_in">export</span> WM_COMPILER_TYPE=system<br><br>63 <span class="hljs-comment">#- Compiler:</span><br>64 <span class="hljs-comment">#    WM_COMPILER = Gcc | Gcc48 ... Gcc62 | Clang | Icx</span><br>65 <span class="hljs-built_in">export</span> WM_COMPILER=Icx<br>66 <span class="hljs-built_in">unset</span> WM_COMPILER_ARCH WM_COMPILER_LIB_ARCH<br><br>86 <span class="hljs-comment">#- MPI implementation:</span><br>87 <span class="hljs-comment">#    WM_MPLIB = SYSTEMOPENMPI | OPENMPI | SYSTEMMPI | MPICH | MPICH-GM | HPMPI</span><br>88 <span class="hljs-comment">#               | MPI | FJMPI | QSMPI | SGIMPI | INTELMPI</span><br>89 <span class="hljs-built_in">export</span> WM_MPLIB=INTELMPI <br></code></pre></td></tr></table></figure><h3 id="for-cannot-find--lz-issude">For <strong>cannot find -lz</strong> issude,</h3><h4 id="check--lz">check -lz</h4><p>使用以下命令查詢gcc能否搜尋到指定的庫檔:</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs sh"> $ gcc -lz --verbose<br>Using built-in specs.<br>COLLECT_GCC=gcc<br>COLLECT_LTO_WRAPPER=/usr/libexec/gcc/x86_64-redhat-linux/8/lto-wrapper<br>...<br>/usr/bin/ld: cannot find -lz<br>collect2: error: ld returned 1 <span class="hljs-built_in">exit</span> status<br></code></pre></td></tr></table></figure><p>若安裝了軟體，找到了庫檔案的路徑。但依然會提示上述錯誤。則表示gcc的搜尋路徑不包含該庫檔案所在的路徑。</p><ul><li>修改環境變數<ul><li><code>$ export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:/opt/biosoft/hdf5-1.8.15-patch1/lib/</code></li><li>修改環境變數 <code>LD_LIBRARY_PATH</code>，加入函式庫檔案所在路徑。使用 <code>export</code> 指令使修改生效。</li><li><code>$ echo 'export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:/opt/biosoft/hdf5-1.8.15-patch1/lib/' &gt;&gt; ~/.bashrc</code></li><li><code>$ source ~/.bashrc</code></li><li>將上述 <code>export</code> 指令加入設定檔 <code>~/.bashrc</code>，使其永久生效。</li><li><code>$ export LIBRARY_PATH=/opt/biosoft/hdf5-1.8.15-patch1/lib/:$LIBRARY_PATH</code></li><li><strong>若修改變數 <code>LD_LIBRARY_PATH</code> 不奏效，則修改變數 <code>LIBRARY_PATH</code> 。</strong></li></ul></li></ul><ol type="1"><li><strong>cannot find -lz</strong><ol type="1"><li><code>-lz</code> - is zlib, <a href="http://zlib.net/" class="uri">http://zlib.net/</a><ol type="1"><li>You may need <code>-L/opt/lib</code> to specify a path. This should give you another linker error, <strong>looking for zlib</strong>. Then add <code>-lz</code>.</li></ol></li><li><code>-lm</code> - is the math library as you've worked out (implementation defined AFAIK)</li><li><code>-lrt</code> - provides POSIX realtime extensions: <a href="http://www.s-gms.ms.edus.si/cgi-bin/man-cgi?librt+3LIB" class="uri">http://www.s-gms.ms.edus.si/cgi-bin/man-cgi?librt+3LIB</a></li></ol></li><li>vim <code>ThirdParty-11/scotch_6.0.9/src/Makefile.inc</code></li></ol><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs sh"> 6 AR      = icx<br><br> 9 CCS     = icx<br>10 CCP     = mpiicc<br>11 CCD     = mpiicc<br></code></pre></td></tr></table></figure><h2 id="setup-env">setup env</h2><ul><li><strong>openfoam_env.sh</strong></li></ul><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment">## Openfoam needs</span><br><span class="hljs-built_in">source</span> /home/wpsze/micromamba/etc/profile.d/micromamba.sh<br>micromamba activate cfd_env<br><br><span class="hljs-built_in">source</span> /home/wpsze/intel/oneapi/setvars.sh intel64<br><span class="hljs-built_in">export</span> MPI_ROOT=/home/wpsze/intel/oneapi/mpi/2021.9.0<br><span class="hljs-built_in">export</span> LD_LIBRARY_PATH=<span class="hljs-variable">$LD_LIBRARY_PATH</span>:/home/wpsze/micromamba/envs/cfd_env/lib<br><span class="hljs-built_in">export</span> C_INCLUDE_PATH=/home/wpsze/micromamba/envs/cfd_env/include<br><span class="hljs-built_in">export</span> CPLUS_INCLUDE_PATH=/home/wpsze/micromamba/envs/cfd_env/include<br><br><span class="hljs-built_in">export</span> LIBRARY_PATH=/home/wpsze/micromamba/envs/cfd_env/lib<br><span class="hljs-built_in">export</span> PATH=/home/wpsze/intel/oneapi/mpi/2021.9.0/bin:<span class="hljs-variable">$PATH</span><br><br>make --version<br>cmake --version<br>gcc --version<br>g++ --version<br>gfortran --version<br><span class="hljs-built_in">which</span> mpiifort<br>mpiifort --version<br><span class="hljs-built_in">which</span> mpiicc<br>mpiicc --version<br><br>mpirun -np 4 <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;hello&quot;</span><br></code></pre></td></tr></table></figure><h2 id="編譯安裝-thirdparty">編譯安裝 ThirdParty</h2><p>進入到 ThirdParty 的解壓縮目錄</p><p>在執行編譯之前，<strong>先輸入指令 echo $MPI_ROOT 查看該變數是否有值！</strong> 這點十分重要，如果MPI_ROOT為空，那麼編譯 ThirdParty 不會報錯，<strong>但是會有一個warning資訊說缺少MPI_ROOT，會缺少 ptscotchf.h</strong> 。這就導致在編譯 OpenFOAM的時候，<strong>會報錯說缺少 ptscotchf.h 導致編譯失敗！</strong>一般來說，載入intel編譯環境之後會自動 <code>export MPI_ROOT</code> 這個變量，但是也可以手動設置，輸入 <code>which mpicc</code> ，然後複製該目錄，複製到 mpi 層即可！</p><p>然後執行 <code>./Allclean</code> 進行清理，再執行 <code>./Allwmake</code> 進行編譯</p><p>如果發生報錯：本目錄不是 WM_THIRD_PARTY_DIR 目錄。說明 OpenFOAM 的 bashrc 檔案配置出現了問題，請確保 WM_THIRD_PARTY_DIR 所指定的目錄確定是ThirdParty目錄的上層目錄。</p><p>編譯完成之後，在同一會話視窗下回到OpenFOAM的安裝目錄，然後開始編譯安裝OpenFOAM</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-built_in">source</span> /home/wpsze/openfoam/openfoam11/openfoam_env.sh<br><br><span class="hljs-built_in">source</span> /home/wpsze/openfoam/openfoam11/OpenFOAM-11/etc/bashrc<br><span class="hljs-built_in">cd</span> /home/wpsze/openfoam/openfoam11/ThirdParty-11<br><br><span class="hljs-built_in">pwd</span><br><span class="hljs-built_in">echo</span> <span class="hljs-variable">$PATH</span><br><span class="hljs-built_in">echo</span> <span class="hljs-variable">$MPI_ROOT</span><br><br>./Allclean<br>./Allwmake | <span class="hljs-built_in">tee</span> Allwmake.<span class="hljs-built_in">log</span><br></code></pre></td></tr></table></figure><p>output:</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs sh">========================================<br>Build Metis decomposition<br>    optional component Metis was not found<br>========================================<br>Build Zoltan decomposition<br>    optional component Zoltan was not found<br><br>========================================<br>Done ThirdParty Allwmake<br>========================================<br></code></pre></td></tr></table></figure><h2 id="編譯安裝-openfoam">編譯安裝 OpenFOAM</h2><p>進入到OpenFOAM 的安裝目錄，執行 <code>./Allwmake -j</code> 以開始編譯，<code>-j</code> 這一參數的意思是調用起所有的CPU核心來並行編譯，當然，如果不希望調用起這麼多核，也可以指定核心數，例如 .<code>/Allwmake -j 8</code> ，只使用8 個核心</p><p>編譯過程十分漫長，如果編譯中途報錯說無法建立xx目錄，手動建立即可，然後重新執行 <code>./Allwmake -j</code> 會從中斷處開始編譯而不是重新從頭開始編譯。</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-built_in">source</span> /home/wpsze/openfoam/openfoam11/openfoam_env.sh<br><br><span class="hljs-built_in">source</span> /home/wpsze/openfoam/openfoam11/OpenFOAM-11/etc/bashrc<br><span class="hljs-built_in">cd</span> /home/wpsze/openfoam/openfoam11/OpenFOAM-11<br><br><span class="hljs-built_in">pwd</span><br><span class="hljs-built_in">echo</span> <span class="hljs-variable">$MPI_ROOT</span><br><br>./Allclean<br>./Allwmake -j 16 | <span class="hljs-built_in">tee</span> Allwmake.<span class="hljs-built_in">log</span><br></code></pre></td></tr></table></figure><h2 id="配置運作環境">配置運作環境</h2><p>設定與編譯時相同的 MPI 編譯環境 - 將 OpenFOAM-x.0 裡面的 bin和platforms/linux64IccDPInt32Opt/bin 加入 PATH - 將 OpenFOAM-x.0 裡面的 platforms/linux64IccDPInt32Opt/lib 及其子目錄加入 LD_LIBRARY_PATH - 將 ThirdParty-x.0 裡面的 platforms/linux64IccDPInt32/lib 及其子目錄加入 LD_LIBRARY_PATH</p><h2 id="測試openfoam">測試OpenFOAM</h2><ul><li>新建一個測試目錄，將內容複製進去，然後執行OpenFOAM指令測試，如下：</li><li>cp -r OpenFoam-x.0/tutorials/incompressible/simpleFoam/pitzDaily .</li><li>cd pitzDaily</li><li>blockMesh</li><li>simpleFoam</li></ul><h1 id="paraview後處理工具安裝"><a href="http://dyfluid.com/install.html#paraview">ParaView（後處理工具）安裝</a></h1><p>安裝OpenFOAM之後，還需要安裝ParaView。主要用於對OpenFOAM算例進行後處理。 Paraview的安裝有倆種方式。</p><ul><li>一種是安裝原版paraivew，</li><li>一種是在OpenFOAM環境中編譯paraFoam。</li></ul><div class="note note-primary">            <p>注意，原版ParaView不能顯示拉格朗日粒子，但處理大網格算例較快。可按照所需進行選擇。也可兩者同時安裝。</p>          </div><p>原版ParaView：可用透過下面的指令來安裝： <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-built_in">sudo</span> apt install paraview<br></code></pre></td></tr></table></figure> 在使用的過程中，可以在OpenFOAM算例下建立一個空檔案並命名為case.foam，然後在終端機鍵入paraview即可運作。運行後，用ParaView打開case.foam即可。</p><p>編譯版paraFoam：一次複製下面所有內容到終端機： <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-built_in">cd</span> <span class="hljs-variable">$HOME</span>/OpenFOAM/ThirdParty-11 &amp;&amp;<br><span class="hljs-built_in">sudo</span> apt-get install git cmake build-essential libgl1-mesa-dev libxt-dev libqt5x11extras5-dev libqt5help5 qttools5-dev qtxmlpatterns5-dev-tools libqt5svg5-devm-py3335-m​​im-pyon ninja-build qtbase5-dev qtchooser qt5-qmake qtbase5-dev-tools &amp;&amp;<br>./makeParaView &amp;&amp;<br>wmRefresh &amp;&amp;<br><span class="hljs-built_in">cd</span> <span class="hljs-variable">$FOAM_UTILITIES</span>/postProcessing/graphics/PVReaders &amp;&amp;<br>./Allwclean &amp;&amp;<br>./Allwmake<br></code></pre></td></tr></table></figure></p><p>其會自動下載 <code>ParaView</code> 並開始編譯，編譯過程較長。然後鍵入 <code>paraFoam</code> 即可運行，其會自動建立一個後綴為 <code>.OpenFOAM</code> 的文件，並自動掛載。</p><h2 id="create-a-empty-file-as-.foam">Create a empty file as <code>.foam</code></h2><p>在資料夾中新增一個 <code>.foam</code> 的空文件，如</p><figure class="highlight console"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs console"><span class="hljs-meta prompt_">$ </span><span class="language-bash"><span class="hljs-built_in">touch</span> test.foam</span><br></code></pre></td></tr></table></figure><p>使用 <code>paraview</code> 開啟 <code>test.foam</code>，即可查看執行結果。</p><h2 id="remote-paraview-recommend">Remote paraview (Recommend)</h2><ul><li><a href="https://docs.paraview.org/en/latest/ReferenceManual/parallelDataVisualization.html">Remote and parallel visualization</a></li><li><a href="https://youtu.be/-jFw9jVHJgs">High performance computing: How to connect to a remote ParaView server</a></li></ul><h3 id="remote-side-hpc">Remote side (HPC),</h3><ul><li>create a conda env</li></ul><figure class="highlight console"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs console"><span class="hljs-meta prompt_">$ </span><span class="language-bash">micromamba <span class="hljs-built_in">env</span> create -n paraview</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">micromamba activate paraview</span> <br><span class="hljs-meta prompt_">$ </span><span class="language-bash">micromamba install paraview</span><br></code></pre></td></tr></table></figure><ul><li>open a server with define port number</li></ul><figure class="highlight console"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs console"><span class="hljs-meta prompt_">$ </span><span class="language-bash"><span class="hljs-built_in">cd</span> /Case-<span class="hljs-built_in">dir</span>/</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash"><span class="hljs-built_in">touch</span> case.foam</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">pvserver --server-port=5566</span><br>Waiting for client...<br>Connection URL: cs://node.HPC.com:5566<br>Accepting connection(s): node.HPC.com:5566<br></code></pre></td></tr></table></figure><p>If <code>pvserver: error while loading shared libraries: libcgns.so.3.4: cannot open shared object file: No such file or directory</code>,</p><h3 id="local-pc">Local PC,</h3><ul><li>Open a new terminal, <code>ssh -N -L 5566:localhost:5566 username@remote-ip</code></li><li>Download the same version of paraview. <a href="https://www.paraview.org/download/">link</a></li><li>Open paraview, file --&gt; connect (setup)</li></ul><p><img src="https://i.imgur.com/9szKnJ7.png" width="600" /></p><div class="note note-primary">            <p>Remark: Please re-build <code>$ pvserver --server-port=5566</code> after disconnect. (pvserver is Exited automatically.)</p>          </div><div class="group-image-container"><div class="group-image-row"><div class="group-image-wrap"><img src="https://i.imgur.com/hcUDTWH.png" alt="1" /></div><div class="group-image-wrap"><img src="https://i.imgur.com/4MPm2zG.png" alt="2" /></div><div class="group-image-wrap"><img src="https://i.imgur.com/r3k8rJn.png" alt="3" /></div></div><div class="group-image-row"><div class="group-image-wrap"><img src="https://i.imgur.com/UgIhObW.png" alt="4" /></div><div class="group-image-wrap"><img src="https://i.imgur.com/QNfj62G.png" alt="5" /></div><div class="group-image-wrap"><img src="https://i.imgur.com/6YJTJWr.png" alt="6" /></div></div><div class="group-image-row"><div class="group-image-wrap"><img src="https://i.imgur.com/G2WTB6I.png" alt="7" /></div><div class="group-image-wrap"><img src="https://i.imgur.com/ICAoNxU.png" alt="8" /></div><div class="group-image-wrap"><img src="https://i.imgur.com/O6Pq9ar.png" alt="9" /></div></div></div><div class="note note-primary">            <p>Remark: "Display is not acessible on the server side. ......" may be login/multiple nodes issue. But, the connection is <strong>Done</strong>.</p>          </div><h1 id="openfoam多版本共存">OpenFOAM多版本共存</h1><p>不同大廠的OpenFOAM版本各有特性，因此使用者可能有多版本OpenFOAM共存的需求。多版本OpenFOAM共存非常簡單。舉例說明：如果使用者打算在Ubuntu系統上安裝OpenFOAM-11以及OpenFOAM-8，</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-built_in">alias</span> of11=<span class="hljs-string">&quot;source ~/OpenFOAM/OpenFOAM-11/etc/bashrc&quot;</span><br><span class="hljs-built_in">alias</span> of8=<span class="hljs-string">&quot;source ~/OpenFOAM/OpenFOAM-8/etc/bashrc&quot;</span><br></code></pre></td></tr></table></figure><h1 id="parallel-execution">Parallel execution</h1><ul><li><a href="https://www.openfoam.com/documentation/guides/latest/man/decomposePar.html">decomposePar(1)</a></li><li><a href="https://openfoamwiki.net/index.php/DecomposePar">DecomposePar</a></li></ul><h1 id="scalability">Scalability</h1><p><a href="https://www.cfd-china.com/topic/3988/200%E4%B8%87%E7%BD%91%E6%A0%BC%E5%B9%B6%E8%A1%8C%E7%AE%97%E5%8A%9B%E6%B5%8B%E8%AF%95-openfoam%E7%89%88%E6%9C%AC?_=1603587871660&amp;lang=en-US">200万网格并行算力测试（OpenFOAM版本）</a></p><ul><li>Model name: Intel(R) Xeon Phi(TM) CPU 7250 @ 1.40GHz<ul><li>cpu MHz : 1500.915</li><li>Socket(s) : 1</li><li>cpu cores : 68</li></ul></li></ul><figure class="highlight console"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs console"><span class="hljs-meta prompt_"># </span><span class="language-bash">cores   Wall time (s):</span><br>------------------------<br>68 215.05<br>64 240.74<br>48 290.68<br>32 298.58<br>24 365.3<br>16 544.95<br>8 721.1<br>4 1366.75<br>2 2382.85<br>1 4529.38<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">cores   Wall time (s):</span><br>------------------------<br>204 248.78<br>136 206.09<br>68 212.28<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">cores   Wall time (s):</span><br>------------------------<br>204 251.24<br>136 207.51<br>68 207.64<br></code></pre></td></tr></table></figure><ul><li>model name : Intel(R) Xeon(R) Gold 6342 CPU @ 2.80GHz<ul><li>cpu MHz : 3500.000</li><li>Socket(s) : 2</li><li>cpu cores : 24</li><li>siblings : 48</li></ul></li></ul><figure class="highlight console"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs console"><span class="hljs-meta prompt_"># </span><span class="language-bash">cores   Wall time (s):</span><br>------------------------<br>48 55.82<br>24 92.98<br>16 132.98<br>8 175.14<br>4 348.56<br>2 554.62<br>1 920.68<br></code></pre></td></tr></table></figure><div class="note note-warning">            <p><a href="http://dyfluid.com/HPC.html">高性能计算最佳实践</a></p>          </div><h2 id="性能测试cfd标准算例"><a href="http://dyfluid.com/standard.html">性能测试CFD标准算例</a></h2><ul><li>200万网格/OpenFOAM<ul><li>适用于机器内存大于16G的机器</li></ul></li><li>2000万网格/OpenFOAM<ul><li>适用于机器内存大于70G的机器</li></ul></li><li>2亿网格/OpenFOAM<ul><li>适用于机器内存大于512G的机器</li></ul></li></ul><h1 id="references">References</h1><ol type="1"><li><a href="https://blog.csdn.net/weixin_49181094/article/details/107345305">使用Intel编译器编译OpenFOAM</a></li><li><a href="https://www.ctyun.cn/document/20661708/10239799">使用OpenFOAM软件进行流体力学仿真计算</a></li><li><a href="https://blog.qiql.net/archives/openfoam">Linux 平台 OpenFOAM 安装及调试指南【附安装脚本】</a></li><li><a href="https://cfd-china.com/topic/3465/%E5%A4%A9%E6%B2%B3-2-%E5%8F%B7%E8%B6%85%E7%AE%97%E5%AE%89%E8%A3%85-openfoam-7-%E4%B8%8D%E5%90%ABcgal">天河 2 号超算安装 OpenFOAM 7 (不含CGAL)</a></li><li><a href="https://community.intel.com/t5/Intel-MPI-Library/Parallel-CFD-simulations-with-OpenFOAM/m-p/1466576">y.tab.c:270:6: error: conflicting types for ‘scotchyyerror’</a><ol type="1"><li>It means that the scotch library from ThirdParty-10 did not compile successfully. Do you have any ideas about how to solve it? I changed the line 65 in etc/bashrc to use the Intel compiler (because I think that it was possible to compile scotch with icx), however the scotch compilation during the execution of ./Allwmake still used gcc despite my changes.</li></ol></li><li><a href="https://www.cnblogs.com/zhming26/p/6164131.html">/usr/bin/ld: cannot find -lxxx 的解决办法</a></li><li><a href="https://www.cnblogs.com/panfeng412/archive/2011/10/20/library_path-and-ld_library_path.html">LIBRARY_PATH和LD_LIBRARY_PATH环境变量的区别</a><ol type="1"><li><code>LIBRARY_PATH</code> 环境变量用于在<strong>程序编译期间</strong>查找动态链接库时指定查找共享库的路径</li><li><code>LD_LIBRARY_PATH</code> 环境变量用于在<strong>程序加载运行期间</strong>查找动态链接库时指定除了系统默认路径之外的其他路径</li></ol></li></ol>]]></content>
    
    
    <categories>
      
      <category>CFD</category>
      
    </categories>
    
    
    <tags>
      
      <tag>HPC</tag>
      
      <tag>OpenFOAM</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>NWP | Non-hydrostatic numerical models for the atmosphere</title>
    <link href="/2024/11/19/A_review_of_non-hydrostatic_numerical_models_for_the_atmosphere/"/>
    <url>/2024/11/19/A_review_of_non-hydrostatic_numerical_models_for_the_atmosphere/</url>
    
    <content type="html"><![CDATA[<h1 id="a-review-of-non-hydrostatic-numerical-models-for-the-atmosphere">A review of non-hydrostatic numerical models for the atmosphere</h1><div class="note note-primary">            <p><strong><a href="https://sraman.wordpress.ncsu.edu/files/2020/09/J98.pdf">Xu, L., Raman, S., &amp; Madala, R. V. (1992, August). A review of non-hydrostatic numerical models for the atmosphere. In 1st World Congress of Nonlinear Analysis Fire and Forest Meteorology. Nonlinear World, Walter de Gruyter, New York, Tampa, FL.</a></strong></p>          </div><p>Three major components are discussed.</p><ul><li>Governing equations<ul><li>Various approximations to governing equations</li><li>The Boussinesq anelastic and fully compressible treatments</li><li>Various vertical coordinate systems</li></ul></li><li>Numerical techniques<ul><li>To handle acoustic and fast moving gravity modes</li><li>Including semi-implicit and split-explicit time integration schemes to control the acoustic modes</li><li>Method of defining vertical and lateral boundary conditions are also discussed</li></ul></li><li>Inclusion of nonlinear physical processes<ul><li>Review inclusion of nonlinear physical processes</li></ul></li></ul><h1 id="references">References</h1><ol type="1"><li><a href="https://citeseerx.ist.psu.edu/document?repid=rep1&amp;type=pdf&amp;doi=34f8ad634c6a397280184c216e9ac25997358dce">Steppeler, J., Hess, R., Schättler, U., &amp; Bonaventura, L. (2003). Review of numerical methods for nonhydrostatic weather prediction models. Meteorology and Atmospheric Physics, 82, 287-301.</a></li><li><a href="https://sraman.wordpress.ncsu.edu/files/2020/09/J98.pdf">Xu, L., Raman, S., &amp; Madala, R. V. (1992, August). A review of non-hydrostatic numerical models for the atmosphere. In 1st World Congress of Nonlinear Analysis Fire and Forest Meteorology. Nonlinear World, Walter de Gruyter, New York, Tampa, FL.</a></li><li><a href="https://journals.ametsoc.org/view/journals/mwre/120/9/1520-0493_1992_120_2109_tsotsn_2_0_co_2.pdf">Skamarock, William C., and Joseph B. Klemp. "The stability of time-split numerical methods for the hydrostatic and the nonhydrostatic elastic equations." Monthly Weather Review 120.9 (1992): 2109-2127.</a></li><li><a href="https://www.ecmwf.int/sites/default/files/elibrary/1991/12300-numerical-methods-nonhydrostatic-models.pdf">Skamarock, William C. "Numerical methods for non-hydrostastic models" (1991)</a></li></ol>]]></content>
    
    
    <categories>
      
      <category>NWP</category>
      
    </categories>
    
    
    <tags>
      
      <tag>WRF</tag>
      
      <tag>MPAS</tag>
      
      <tag>ECMWF</tag>
      
      <tag>paper</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>MPAS | killed - signal X</title>
    <link href="/2024/11/18/killed-signal-x/"/>
    <url>/2024/11/18/killed-signal-x/</url>
    
    <content type="html"><![CDATA[<h1 id="killed-by-signal-9-killed">KILLED BY SIGNAL: 9 (Killed)</h1><div class="note note-primary">            <p>Ouf Of Memory (OOM). A rough approximation for the memory required to run a simulation on a mesh with N cells is N * 0.175 MB</p>          </div><ul><li><a href="https://forum.mmm.ucar.edu/threads/atmosphere_model-bad-termination-of-one-of-your-application-processes.10105/">atmosphere_model - bad termination of one of your application processes</a></li></ul><p>I agree that the issue may be a memory limitation. A rough approximation for the memory required to run a simulation on a mesh with <strong>N cells is N * 0.175 MB</strong>, which suggests <strong>around 7.2 GB of memory would be required for the 120-km mesh with 40962 cells</strong>. There is more discussion on computational requirements in <a href="https://forum.mmm.ucar.edu/phpBB3/viewtopic.php?f=12&amp;t=10047">this thread</a> that may be useful.</p>]]></content>
    
    
    <categories>
      
      <category>MPAS</category>
      
    </categories>
    
    
    <tags>
      
      <tag>NWP</tag>
      
      <tag>WRF</tag>
      
      <tag>MPAS</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>CFD | Incompressible and Compressible</title>
    <link href="/2024/11/15/CFD-compression-Incompression/"/>
    <url>/2024/11/15/CFD-compression-Incompression/</url>
    
    <content type="html"><![CDATA[<h1 id="governing-equations">Governing Equations</h1><p>The equations that govern the fluid flow are based on the conservation laws of a fluid’s physical properties. The basic equations are the three laws of conservation1:</p><ul><li>Conservation of Mass: <strong>Continuity Equation</strong></li><li>Conservation of Momentum: <strong>Navier Stokes Equation</strong></li><li><strong>Equation of state</strong></li><li>Conservation of Energy: First Law of Thermodynamics or <strong>Energy Equation</strong><ul><li>An additional enthalpy equation from thermodynamics is required that includes a dissipation term and accounts for temperature changes during flow when heat or any other energy exchange is involved.Convective and conjugate heat transfer simulations involve thermal energy transfers for accurate CFD analysis. Stress-strain relations for compressible fluids can further complicate equations of compressible flow.</li></ul></li></ul><h2 id="equations">Equations</h2><p>Conservation of Mass and Momentum, <span class="math display">\[\begin{align*}\frac{D(\,)}{Dt} &amp;= \frac{\partial(\,)}{\partial t}+V\cdot\nabla(\,) \tag{0} \\\dfrac{D \rho}{D t} + \rho (\nabla \cdot \vec{v}) &amp;= 0 \tag{1}\\\rho \dfrac{D\vec{v}}{D t} &amp;= -\nabla p + \mu \nabla^2 \vec{v} + \rho \vec{g}  \tag{2}\\\end{align*}\]</span></p><p>Equation of state, <span class="math display">\[\begin{align*}P &amp;= P(\rho, T) \qquad (e.g. PV = nRT) \tag{3}\\\end{align*}\]</span></p><p>Energy Equation, <span class="math display">\[\begin{align*}dE_t &amp; = dQ + dW \tag{4}\\\end{align*}\]</span></p><p>where <span class="math inline">\(dQ\)</span> is the heat added to the system, <span class="math inline">\(dW\)</span> is the work done on the system, and <span class="math inline">\(dE_t\)</span> is the increment in the total energy of the system. One of the common types of energy equation is:</p><p><span class="math display">\[\begin{align*}\displaystyle \dfrac{D{\cal E}}{Dt} &amp;= - \frac{p}{\rho}\,\nabla\cdot{\bf v} + \frac{\chi}{\rho} +\frac{\nabla\!\cdot( \kappa\,\nabla T)}{\rho} \tag{5} \\\displaystyle \chi &amp;= \frac{\partial v_i}{\partial x_j} d_{ij} = 2 \mu \left(e_{ij} e_{ij} - \dfrac{1}{3} e_{ii} e_{jj} \right) = \mu \left( \dfrac{\partial v_i}{\partial x_j}\dfrac{\partial v_i}{\partial x_j} + \dfrac{\partial v_i}{\partial x_j}\dfrac{\partial v_j}{\partial x_i} - \dfrac{2}{3} \dfrac{\partial v_i}{\partial x_i}\dfrac{\partial v_j}{\partial x_j} \right)\end{align*}\]</span></p><p>According to the previous equation, the internal energy per unit mass of a co-moving fluid element evolves in time as a consequence of work done on the element by pressure as its volume changes, viscous heat generation due to flow shear, and heat conduction.</p><h1 id="transport-equation">Transport Equation</h1><ul><li><a href="https://www.simscale.com/docs/simwiki/numerics-background/what-is-the-transport-equation/">What is Transport Equation?</a></li><li><a href="https://www.cfd-online.com/Wiki/Generic_scalar_transport_equation">Generic scalar transport equation</a></li><li><a href="https://ocw.mit.edu/courses/3-185-transport-phenomena-in-materials-engineering-fall-2003/resources/3_21/">Transport Phenomena in Materials Engineering</a></li></ul><p>The Transport equation describes how a scalar quantity is transported within a fluid and applies to many scalars, including <strong>passive scalars</strong>, <strong>temperature</strong> and <strong>even momentum by component</strong>. The general transport equation is as follows:</p><p><span class="math display">\[\underbrace{\frac{\partial \rho \phi}{\partial t}}_{\substack{\text{unsteady} \\ \text{term}}} = \underbrace{\nabla \cdot (\rho \boldsymbol{u} \phi) \vphantom{\frac{\partial \phi}{\partial t}}}_{\substack{\text{Convection} \\ \text{term}}} \hspace{2mm} – \underbrace{\nabla \cdot (\Gamma \nabla \phi) \vphantom{\frac{\partial \phi}{\partial t}}}_{\substack{\text{Diffusion} \\ \text{term}}} + \underbrace{S \vphantom{\frac{\partial \phi}{\partial t}}}_{\substack{\text{Source} \\ \text{term}}} \tag{6}\]</span></p><p>Where:</p><ul><li><span class="math inline">\(\phi\)</span> can be any scalar</li><li><span class="math inline">\(\boldsymbol{u}\)</span> is the velocity vector (u, v, w)</li><li><span class="math inline">\(S\)</span> is the source of a scalar</li></ul><p>From the mathematical point of view, the transport equation is also called the <strong>convection-diffusion equation</strong>. The convection-diffusion equation is the basis for the most common transportation models.</p><h1 id="incompressible-flow">Incompressible flow</h1><p>In most situations of general interest, the flow of a conventional liquid, such as water, is incompressible to a high degree of accuracy. A fluid is said to be incompressible when the mass density of a co-moving volume element does not change appreciably as the element moves through regions of varying pressure. In other words, <strong>for an incompressible fluid, the rate of change of $ $ following the motion is zero</strong>: that is,</p><p><span class="math display">\[\displaystyle \frac{D\rho}{Dt} = 0\]</span></p><p>In this case, the continuity equation reduces to <span class="math display">\[\displaystyle \nabla\cdot{\bf v} = 0\]</span></p><p>We conclude that, as a <strong>consequence of mass conservation</strong>,</p><div class="note note-primary">            <p>An <strong>incompressible fluid must have a divergence-free</strong>, or solenoidal, velocity field.</p>          </div><p>This immediately implies that <strong>the volume of a co-moving fluid element is a constant of the motion</strong>. In most practical situations, the initial density distribution in an incompressible fluid is uniform in space. Hence, it follows from Equation (1.76) that the density distribution remains uniform in space and constant in time. In other words, we can generally treat the density, <span class="math inline">\(\rho\)</span> , as a uniform constant in incompressible fluid flow problems.</p><p><img src="https://i.imgur.com/XwL79J8.png" width="600" /> <img src="https://i.imgur.com/zaf58vA.png" width="600" /> <img src="https://i.imgur.com/GkV6pMK.png" width="600" /> <img src="https://i.imgur.com/6FStEBC.png" width="600" /> <img src="https://i.imgur.com/iznmeSr.png" width="600" /> <img src="https://i.imgur.com/RjdjunO.png" width="600" /></p><h1 id="compressible-flow">Compressible flow</h1><p>A compressible flow is a flow in which the fluid density <span class="math inline">\(\rho\)</span> varies significantly within the flowfield. Therefore, <span class="math inline">\(\rho(x, y, z)\)</span> must now be treated as a field variable rather than simply a constant. Typically, significant density variations start to appear when the <strong>flow Mach number exceeds 0.3</strong>. The effects become especially large when the Mach number approaches and exceeds unity.</p><p>In incompressible flow the density <span class="math inline">\(\rho\)</span> does not change.</p><p><img src="https://i.imgur.com/rDx2DHd.png" width="600" /></p><p>A perfect gas is one whose individual molecules interact only via direct collisions, with no other intermolecular forces present. For such a perfect gas, the properties <span class="math inline">\(P, V, \rho\)</span>, and the temperature <span class="math inline">\(T\)</span> are related by the following <strong>equation of state</strong>,</p><p><span class="math display">\[PV = nRT\]</span></p><p>where <span class="math inline">\(R\)</span> is the specific gas constant. For air, $R = 287 J⋅kg^{−1}⋅K $.</p><p>The appearance of the temperature <span class="math inline">\(T\)</span> in the equation of state means that it must vary within the flowfield. Therefore, <span class="math inline">\(T(x, y, z)\)</span> must be treated as a new field variable in addition to <span class="math inline">\(\rho(x, y, z)\)</span>. n the moving Control Volume (CV) scenario above, the change in the CV’s volume is not only accompanied by a change in density, but by a change in temperature as well.</p><p>The appearance of the temperature also means that thermodynamics will need to be addressed. So in addition to the <strong>conservation of mass and momentum</strong> which were employed in low speed flows, we will now also need to consider the <strong>conservation of energy</strong>. The following table compares the variables and equations which come into play in the two cases.</p><p><img src="https://i.imgur.com/qeDj31C.png" width="600" /></p><h2 id="mach-number-馬赫數">Mach number 馬赫數</h2><p>儘管氣體是可壓縮的，但在低速時它們所經歷的密度變化可能並不顯著。以空氣為例。圖顯示了以馬赫數為函數的密度變化圖。密度變化表示為 <span class="math inline">\(\rho/\rho_0\)</span>，其中 <span class="math inline">\(\rho_0\)</span> 是零速度（即，零馬赫數）時的空氣密度。</p><figure><img src="https://i.imgur.com/dND1Epn.png" alt="以空氣為例。圖顯示了以馬赫數為函數的密度變化圖" width="400" /><figcaption>以空氣為例。圖顯示了以馬赫數為函數的密度變化圖</figcaption></figure><div class="note note-primary">            <p>對於<strong>不可壓縮流動，溫度通常保持恆定</strong>。但在<strong>可壓縮流動中，可能會發生顯著的溫度變化，導致能量模式之間的交換</strong> (在計算可壓縮流動時，<strong>必須考慮能量方程式</strong>)</p>          </div><p>對於馬赫數高達0.3的情況，密度變化在 <span class="math inline">\(\rho_0\)</span> 的5%以內。因此，在這個範圍內，實際上可以忽略密度變化，並將流動視為不可壓縮的。但是，當馬赫數超過0.3時，變化確實變得顯著，並且在馬赫數為1時，密度變化達到了36.5%。在馬赫數為2時，密度變化高達77%。不可壓縮流和可壓縮流之間的另一個重要區別是由於溫度變化引起的。對於<strong>不可壓縮流動，溫度通常保持恆定</strong>。但在<strong>可壓縮流動中，可能會發生顯著的溫度變化，導致能量模式之間的交換</strong>。這些事實的直接後果是，在計算可壓縮流動時，<strong>必須考慮能量方程式</strong>（這在不可壓縮流動中沒有進行）。此外，為了處理能量模式的交換，就必須理解流動的熱力學。熱力學是一個涵蓋許多主題的龐大主題。</p><h2 id="openfoam案例可壓縮流體模擬"><a href="https://mp.weixin.qq.com/s/Z0K06ziGHhbbhVNLpTv2cg">openFOAM案例：可壓縮流體模擬</a></h2><ul><li>可壓縮流體的求解要點</li></ul><p>物體在可接近音速或超音速飛行的時候，由於速度非常快，空氣就會因為運動被壓縮，它的密度就會改變，也變成了可壓縮流體。與不可壓縮流體相比，可壓縮流體在CFD模擬上有些差異，首先我們來看控制方程式：</p><p><img src="https://i.imgur.com/HL8RfHp.png" width="400" /></p><div class="note note-primary">            <p>可壓縮流體的控制方程式和我們之前遇到的方程式相比，<strong>最大的特性就是它的密度就不再是常數</strong>了。既然密度成為了一個變量，<strong>為了讓方程組封閉。我們就需要一個方程式對密度的變化來描述</strong>，而這個方程式就是<strong>狀態方程式</strong>。狀態方程式就是物質密度隨溫度壓力變化的關係。那麼由於狀態方程式裡又牽涉到溫度了。<strong>描述溫度就需要一個能量方程式</strong>。所以我們求解可壓縮流體都是要同時求解能量方程式。</p>          </div><p>求解可壓縮流體的方程，最簡單的一個思路就是採用和先前提到的<strong>不可壓縮流體演算法類似</strong>的方法來求解。例如之前提到的 <code>simple</code> 或 <code>piso</code> 演算法，先解<strong>動量方程得</strong>到 U，再將動量方程與壓力方程式變換，再得到<strong>壓力方程</strong>，得到 P。再透過壓力<strong>修正方程式校正U</strong>，不斷迭代得到求解。與不可壓縮流體相比，可壓縮流體的密度是可變的，我們透過狀態方程式引入這種變化就可以了。<strong>這裡速度與壓力的求解是分開的所以叫分離式求解</strong>，而且推導出來的是壓力方程，因此叫<strong>基於壓力的求解</strong>。</p><p><img src="https://i.imgur.com/3s6rOru.png" width="600" /></p><p>還有一種方法是<strong>基於密度的求解</strong>，<strong>把狀態方程帶入動量方程，把壓力項變成密度項</strong>。這樣就可以直接把連續性方程式與動量方程式連結起來同時求解。所以這就叫<strong>耦合求解，求解出來的是速度場和密度場</strong>，所以又叫基於密度的求解。把速度場與密度場求出來以後，<strong>再用狀態方程式把壓力場求出來</strong>就可以了。</p><p><img src="https://i.imgur.com/fuChsqX.png" width="600" /></p><p><strong>openfoam</strong> 裡，基於密度的解算器是 <code>rhoCentralFoam</code> ，基於壓力的解算器是 <code>rhoPimpleFoam</code> 。從數學角度而言兩種解算器原理上都可以求解可壓縮流體流動，但由於演算法與離散格式上的區別，二者的使用範圍稍有不同。兩種解算器基於壓力的解算器，更接近不可壓縮流體的解方式，適宜低馬赫數的流體。基於密度的求解器，適用於高馬赫數的流體。現在隨著演算法與離散方式的進步，二者解馬赫數的範圍都在擴大。</p><h1 id="references">References</h1><ol type="1"><li><a href="https://web.mit.edu/16.unified/www/SPRING/fluids/Spring2008/LectureNotes/f11.pdf">Fluids – Lecture 11 Notes</a></li><li><a href="https://ocw.mit.edu/courses/2-29-numerical-marine-hydrodynamics-13-024-spring-2003/01e395bcab50dc4cd8f82ebaa045aca3_lecture_notes.pdf">13.024-Numerical Methods in Incompressible Fluid Mechanics</a></li><li><a href="https://www.physicsforums.com/threads/constant-density-vs-incompressible.902510/">Constant density vs Incompressible</a></li><li><a href="https://farside.ph.utexas.edu/teaching/336L/Fluidhtml/node11.html">Convective Time Derivative</a></li><li><a href="https://farside.ph.utexas.edu/teaching/336L/Fluidhtml/node14.html">Energy Conservation</a></li><li><a href="https://farside.ph.utexas.edu/teaching/336L/Fluidhtml/node15.html">Equations of Incompressible Fluid Flow</a></li><li><a href="https://www.simscale.com/docs/simwiki/cfd-computational-fluid-dynamics/compressible-flow-vs-incompressible-flow/">Compressible Flow vs Incompressible Flow</a></li><li><a href="https://mp.weixin.qq.com/s/_OwJGqOovMjfy8ax42ANOA">针对昨天压力悖论的解释</a><ol type="1"><li>为什么我们会陷入这个悖论？我想很多做不可压缩流体模拟的朋友，平时常用的就四组方程：一个连续性方程，三个动量方程。连续性方程里面有一个密度和三个速度，带来四个未知量；三个动量方程带来一个新的未知量——压力。四个方程，五个未知量，怎么求解？所以我们通常会给定密度。这样方程组就封闭了。但是昨天我跟你说，要考虑状态方程，这就多了一个方程，但是你还是认为没有多出任何未知量（温度、密度都给定）。这样方程组就超定了，于是产生矛盾。实际上，加入状态方程后，密度就不能再认为恒定了。所以这可能是一个思维定势的坑。</li></ol></li><li><a href="https://mp.weixin.qq.com/s/Z0K06ziGHhbbhVNLpTv2cg">openFOAM案例：可压缩流体模拟</a></li></ol>]]></content>
    
    
    <categories>
      
      <category>CFD</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>Southwest monsoon | 西南季風</title>
    <link href="/2024/11/14/southwest-monsoon/"/>
    <url>/2024/11/14/southwest-monsoon/</url>
    
    <content type="html"><![CDATA[<h1 id="西南季風">西南季風</h1><p>亞洲南部的季風，主要是由信風帶的季節移動而引起的，但也有<strong>海陸熱力差異的影響</strong>，以印度季風為例，冬季信風帶南移，赤道低壓移到南半球，亞洲大陸冷高壓強大，高壓南部的東北風就成為亞洲南部的冬季風。夏季信風帶北移，赤道低壓移到北半球，再加上大陸熱力因子的作用，低壓中心出現在印度半島。而此時正是南半球的冬季，澳大利亞是一個低温高壓區，氣壓梯度由南向北，南來氣流跨越赤道後，受北半球地轉偏向力的作用，形成西南風，這就是南亞的夏季風。</p><p>在季風的影響下，南亞也是冬幹夏濕，但是它和<strong>東亞季風</strong>有一個明顯差別，即<strong>南亞夏季風</strong>比冬季風強。這是因為冬季亞洲南部遠離蒙古-西伯利亞高壓中心，並有西藏高原的阻擋，再加上印度半島面積較小，緯度較低，海陸之間的氣壓梯度較弱，因此冬季風不強。相反，夏季印度半島氣温特別高，是熱低壓中心所在，它與南半球副高之間的氣壓梯度大，因此南亞的夏季風強於冬季風。</p><p><strong>西南季風，屬季風亞洲中的一個季風</strong>。主要盛行於6～8月。盛行於南亞、東南亞及部分東亞一帶，為風向西南的夏季季風。西南季風來<strong>自於低空的越赤道氣流</strong>。這種氣流在亞洲被稱為「西南季風」。西南季風的到來，代表着季節的轉換，由冬季正式轉為夏季。</p><p>夏季時，西南季風北上為東亞和東南亞國家帶來豐富的降水，造成許多國家的主要水資源來源為西南季風，如 造成東南亞的菲律賓群島及中南半島的熱帶季風氣候，也因此造成水患。</p><p>位在南亞的印度及孟加拉因地形影響形成地形雨，在印度德干高原西部和喜馬拉雅山南部降下豪大雨，造成印度乞拉朋吉為全球降水量最多的地區之一。 於東亞的臺灣也受此季風對每年5～6月的梅雨季造成影響。</p><ul><li>西南季風的源頭是東非馬達加斯加島附近的索馬利亞噴流，空間尺度橫跨印度洋一直到太平洋西部，範圍非常大而且持續的時間是以月來計算的。</li></ul><p><img src="https://i.imgur.com/3qu9wAZ.png" width="600" /></p><h2 id="北半球夏季西南季風-建立的時間點">北半球夏季西南季風 建立的時間點</h2><p>北半球夏季西南季風 建立的時間點，<strong>因為西南季風的建立不但代表了季節的轉換，由冬天型態正式轉變成夏天型態</strong>，西南季風建立後會夾帶大量的暖濕水氣北上進入亞洲陸地，對於台灣的梅雨降雨狀況具有關鍵性的影響。所謂的「季風」是因為地球表面海洋和陸地的比熱不同，加上太陽直射地球表面的區域隨著地球公轉而出現季節性的南北移動，而形成大範圍的海陸溫度差，因此導致大尺度範圍空氣流動的結果。</p><p>西南季風達到正式的「ON-SET」有一個比較明確的定義型態，<strong>共有3支氣流共同合成西南季風</strong>。最主要的一支就是前面提到的，</p><ul><li>遠從東非的索馬利亞噴流跨過赤道以及北印度洋後，再傳播到中南半島以及南海的大尺度氣流，</li><li>另外兩支較小的氣流分別是來自印尼附近的跨赤道氣流以及菲律賓東方順著太平洋高壓邊緣北上的氣流，</li></ul><p><strong>當這3支氣流到齊的時候，就是西南季風正式建立的時間點</strong>。</p><p><img src="https://i.imgur.com/BO29vIu.png" /></p><h2 id="南亞夏季季風是如何形成的">南亞夏季季風是如何形成的？</h2><ul><li>位於<strong>南半球的南印度洋副熱帶高壓</strong>（「馬斯克林高壓」）[A]隨著季節向北移近赤道。馬斯克林高壓的低層氣流會以逆時針方向流出，結合了「南印度洋東南信風」 [B]之後，便穿過赤道，形成「過赤道流」[C]。</li><li>由於南亞季風區的西邊是非洲大陸，過赤道流受到東非地形的影響，被侷限在東非以東，於是形成流速極快的「<strong>索馬利噴流</strong>」。這股索馬利噴流因為受到科氏力影響，會進而轉成西南風，這就是印度半島的「<strong>西南季風</strong>」[D]。正因為此處的西南季風來自強勁的索馬利噴流，所以南亞的夏季季風相當旺盛。</li><li>印度半島的北方是高聳的青康藏高原，高原不但阻擋了來自北邊的其他天氣系統，使它們無法影響印度半島夏季的氣候，也使得西南季風無法往北延伸，僅止於高原以南。<strong>青康藏高原的存在，正是造成南亞季風區西南季風風向穩定不受影響的原因</strong>。</li><li>青康藏高原高層地表的溫度較鄰近地區的氣溫高出許多，因而在高層形成「<strong>南亞高壓</strong>」[E]。<strong>南亞高壓的存在代表高層的輻散，有利於維持高原南邊的低層低壓。低層的低壓槽吸引了大範圍由南向北的氣流，在經科氏力的作用轉成西南風，這就是西南季風存在的原因之一</strong>。西南季風從南方的海洋帶來充分的水汽，造成南亞地區夏季大量的降水，也就是雨季的來臨。降水的過程會釋放大量潛熱，加熱高層大氣，更有助於高壓的維特。</li><li>印度半島的高層大氣因北邊南亞高壓的存在，輻散的北風受科氏力影響而轉為東風，形成強盛的熱帶東風噴流。</li></ul><p><img src="https://i.imgur.com/wAkWQde.png" width="400" /></p><h2 id="東亞夏季季風是如何形成的">東亞夏季季風是如何形成的？</h2><ul><li>位於南半球的南太平洋副熱帶高壓（「<strong>澳大利亞高壓</strong>」）[O]隨著季節向北移近赤道。澳大利亞高壓的低層氣流同樣會以逆時針方向流出，結合「南太平洋東南信風」[P]，穿過赤道，形成「過赤道流」[Q]，流向亞洲大陸的低壓槽。過赤道流受科氏力的影響，會轉為西南風，形成東亞夏季季風區的西南季風[R]。因為澳大利亞高壓並沒有南亞的馬斯克林高壓那麼強，加上東亞的西邊沒有類似東非的地形，所以東亞的過赤道氣流並沒有南亞的索馬利噴流那麼強，這也是<strong>東亞夏季季風不如南亞夏季季風強盛的原因之一</strong>。</li><li>由於陸地東面有個規模不小的「西太平洋副熱帶高壓」[S]，由於西太平洋高壓的存在，東亞季風區東部的風向不單單只有西南風，也常伴隨由太平洋高壓西南方下沈的偏東南風，因此東亞季風不似南亞季風穩定。</li><li>在東亞夏季季風區，海洋位在大陸的東邊和南邊，而且此區地形大為緩和，並沒有類似青康藏高原這種地形的屏障。因此，北方的「中緯度氣團」[T]會南下影響季風區的氣候，造成西南季風和中緯度氣團間形成「梅雨鋒帶」[U]，帶來梅雨，所以此區的降雨情形非常多變化，不似南亞季風區單純──印度半島並沒有梅雨鋒的存在。</li><li>東亞季風區的高層也存在熱帶東風噴流，不過由於沒有青康藏高原持續加熱的影響，高層的熱帶東風噴流也沒有像南亞地區的熱帶東風噴流那麼強。</li></ul><p><img src="https://i.imgur.com/e5AarLw.png" width="400" /></p><h1 id="西南季風爆發"><a href="https://www.mmets.org/?p=1274">「西南季風」爆發 ?!</a></h1><p>到了夏半年，太陽強烈照射亞洲大陸，地面溫度”熱”，空氣隨之上升，形成大型的低壓區，而海洋則較陸地”涼”，氣壓較高。空氣從海洋(高氣壓)流向陸地(低氣壓)，這種海陸熱力差異形成澳門夏季的「西南季風」。</p><p>很多時候，雨量多不多，取決於“水”，而「西南季風」爆發的重要性就是“水汽突然增多”。氣象學上，南海「西南季風」爆發是季節變化的一個轉折點，代表水汽輸送帶進入南海，此時「西南季風」控制南海及華南，華南地區的雲量和降雨都會”明顯”增多。一般來說，「西南季風」在 5 月的第 4、5 候(註：氣候上，1候代表5日；5月第1候，即5月1-5日)進入南海到達華南沿岸。</p><p>「西南季風」和它的水汽輸送帶是一步一步形成的，整個西南季風系統的形成分為 3 個階段，如下：</p><ul><li>南半球的東南信風越過赤道，但受到東非高山地形阻擋，氣流速度增加，進入印度西南面。阿拉伯海可能會出現熱帶氣旋。</li><li>氣流繼續向東推進，進入印度東南面，此時孟加拉灣很大機會出現熱帶氣旋；隨後氣流會進一步接近中南半島後，緬甸、泰國、馬來西亞等進入雨季。</li><li>隨着籠罩華南及南海的副熱帶高壓逐漸“退場”，「西南季風」便可進入南海，到達華南，而它的水汽輸送帶正是澳門降雨的主要水汽來源。</li></ul><p>跟着上述的 3 步曲，大家就可以大概知道「西南季風」爆發時間。若澳門受到低壓槽影響，而「西南季風」同時為低壓槽送上源源不絕的水汽，此時雨量會十分可觀，甚至出現大暴雨。我們必須做好準備、注意防範 !</p><p><img src="https://i.imgur.com/zfpj5zI.png" /></p><h1 id="西南季風-hko"><a href="https://www.hko.gov.hk/tc/education/climate/climate-change/00261-onset-of-southwest-monsoon-end-of-the-fog-season-and-start-of-the-rain-season.html">西南季風 | HKO</a></h1><ul><li>西南季候風<ul><li>季候風形成的主因是大範圍海洋與陸地之間的溫差。踏入四月，太陽逐漸北移，北半球的日照會增多，亞洲大陸上的空氣會比相鄰海洋上的空氣升溫較快。陸地的空氣因而會變得較輕及上升，最終在大陸上形成低壓中心。海洋上的暖濕氣流便會大致流向該低壓中心，導致西南季候風的爆發。圖一為1971至2000年橫瀾島的月平均盛行風向，清楚顯示本港的風向會<strong>在五、六月之間由偏東風轉為西南風</strong>。</li><li><img src="https://i.imgur.com/ispYSwO.png" alt="圖一 1971- 2000年橫瀾島月平均盛行風向" /></li></ul></li><li>霧季的終結<ul><li>香港的<strong>霧季一般由二月開始直至四月左右結束</strong>。溫暖潮濕的海洋空氣平流流經近岸較涼的海面上，氣溫會逐漸降至露點， 水汽便凝結為微小水點而形成霧（一般稱此為平流霧）。由於海水較涼，而其上的空氣較暖，大氣相對穩定，有助將水汽限制於大氣的最低層。隨着季節變化，海水亦慢慢變暖，海面上的大氣變得較不穩定，容易產生對流活動。因此，五月西南季候風的爆發通常亦標誌着霧季的結束。圖二為1971至2000年香港天文台平均每月觀測到有霧的日數，可見五月出現霧的日子並不多，平均少於0.2日。</li><li><img src="https://i.imgur.com/E39hmpo.png" alt="圖二 1971-2000年香港天文台平均每月觀測到有霧的日數。" /></li></ul></li><li>雨季的開始<ul><li>由於西南季候風會<strong>帶來溫暖潮濕的空氣，加上海水升溫，有利對流活動的發展</strong>。若然配合其他有利的氣象條件，如低層輻合或高層輻散，西南季候風有時引致大雨。圖三為1971至2000年香港天文台錄得的月平均雨量，顯示五月份雨量明顯增加，跟西南季候風爆發的時間相互吻合。</li><li><img src="https://i.imgur.com/1Umv5Pn.png" title="fig:" alt="圖三 1971-2000年香港天文台錄得的月平均雨量" /></li></ul></li></ul><h1 id="references">References</h1><ol type="1"><li><a href="https://www.hko.gov.hk/tc/education/climate/climate-change/00261-onset-of-southwest-monsoon-end-of-the-fog-season-and-start-of-the-rain-season.html">西南季候風的爆發:霧季的終結及雨季的開始 | HKO</a></li><li><a href="https://blog.weatherrisk.com/index.php/13-weatherrisk/media/the-news/weather-talk/74-southwest-monsoon-is-big-weapon">西南季風－梅雨鋒面的強大武器</a></li><li><a href="https://www.mmets.org/?p=1274">「西南季風」爆發 ?!</a></li></ol>]]></content>
    
    
    <categories>
      
      <category>Meteorology</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>Trough Line | 槽線</title>
    <link href="/2024/11/14/trough-line/"/>
    <url>/2024/11/14/trough-line/</url>
    
    <content type="html"><![CDATA[<h1 id="槽線">槽線</h1><p>槽線是低壓槽內氣流水平輻合最強的地區。通常在槽線附近的天氣變化比較明顯，這種特徵使它在天氣預報中佔據著非常重要的位置。槽線識別方法包括人工識別和自動識別。</p><p>一般來說等壓面上的等位勢高度線（也就是常簡稱的等高線）是這樣的分佈的話，那就說這個區域存在一個低壓槽。</p><p><img src="https://i.imgur.com/zOCTflV.png" width="300" /> <img src="https://i.imgur.com/77Z6L2B.png" /></p><ul><li>當低氣壓呈延長狀，稱為<strong>低壓槽</strong>。在天氣圖上，它會<strong>伴隨著一條槽線</strong>。槽線上的氣壓會較其兩旁氣壓為低。</li></ul><p><img src="https://i.imgur.com/pQQieMF.png" /></p><h1 id="gradient-wind-balance">Gradient Wind Balance</h1><p><img src="https://i.imgur.com/ztlxJHa.png" /></p><p><img src="https://i.imgur.com/bCulgOr.png" /></p><h1 id="references">References</h1><ol type="1"><li><a href="https://www.hko.gov.hk/tc/education/weather/wind-and-pressure/00117-introduction-to-air-pressure-part-ii.html">氣壓的基本知識（二） | HKO</a></li></ol>]]></content>
    
    
    <categories>
      
      <category>Meteorology</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>Trough | 低壓槽</title>
    <link href="/2024/11/14/trough/"/>
    <url>/2024/11/14/trough/</url>
    
    <content type="html"><![CDATA[<h2 id="低壓槽">低壓槽</h2><p>低壓槽 (Trough）是從低壓中心延伸出來的狹長區域，經常與鋒伴隨出現。</p><p>受地理環境、季節變化等因素影響，<strong>地面氣壓分佈一般並不均勻</strong>。氣壓較四週為低的地區，稱為低壓區。從<strong>低壓區延伸出來的狹長區域，稱為低壓槽</strong>。有鋒性的槽﹝槽的兩邊有冷暖氣團的差異﹞，視乎槽的移動方向，稱為冷鋒、暖鋒或靜止鋒。在華北地區，尤其在冬季，低壓槽通常以冷鋒形式出現，由東北向西南伸展，自西向東移動。在華南地區，低壓槽通常為東西走向，自北向南移動，推向南海北部。冬天鋒性較強，在天氣圖上多以冷鋒形態出現。到春天及初夏鋒性較弱，五、六月便是華南低壓槽的旺季。這些月份，夏天西南季候風正向北進入中國內陸，其前沿的位置往往就是在槽線上，<strong>故這時候的低壓槽也被稱為季風槽（monsoon trough）</strong>。</p><p>人望高處，水向低流。空氣則朝氣壓低的地區走。不同的氣流在低壓槽上匯聚，空氣被迫上升，空氣中的水汽凝結成雲及雨。在適當條件下更可能有雷暴發展。</p><p>低壓槽伸延數百公里，但惡劣天氣主要是來自當中面積數十平方公里的<strong>對流細胞（convective cells）</strong>，這些細胞的生命史只有短短數小時。故此暴雨警告的有效時間通常不會太長，不像熱帶氣旋警告訊號一掛整天。但如果低壓槽移動緩慢，其盤踞的地區便會經常受新發展的對流細胞影響，惡劣天氣便持續不散，大雨連場，即如六月底七月初香港經歷的情況一樣。</p><p>隨著季節轉換，每逢四至六月，北面(冷)大陸氣團與南面(暖)海洋氣團不時會出現對峙的情況，好像拔河一樣，交界的位置上空氣匯聚上升，大量水汽凝結成雲和雨，地面氣壓低，所以稱為「低壓槽」。如果「低壓槽」移動緩慢或一直停留，就可能造成暴雨。</p><p><img src="https://i.imgur.com/gNhCQU9.png" width="600" /></p><ul><li>低壓槽像一個峽長的山谷</li></ul><figure><img src="https://i.imgur.com/rGYeYlW.png" alt="低壓槽像一個峽長的山谷" width="600" /><figcaption>低壓槽像一個峽長的山谷</figcaption></figure><h1 id="低壓槽與冷鋒">低壓槽與冷鋒</h1><p><strong>低壓槽與冷鋒相似，但冷鋒是由冷暖氣團相遇形成，有明顯的溫度差，而低壓槽南北兩側的溫度差未必明顯</strong>。冷鋒通常穩定向南移動，因此影響香港的惡劣天氣比較短暫，但低壓槽有時移動緩慢。當低壓槽徘徊於某地區時，往往帶來持續降雨，釀成水災。</p><p>春季開始，來自陸地的冷空氣減弱，來自海洋的溫暖潮濕空氣變得活躍並進入內陸，兩者相遇形成低壓槽。空氣由四周流入低壓槽，在低壓槽內上升，由於上升時氣壓下降，空氣膨脹降溫，空氣內的水汽凝結形成棉花般的積雲。當積雲向上發展至對流層頂時，稱為積雨雲。</p><ul><li><strong>當低壓槽在內陸時</strong>，香港天氣溫暖潮濕，吹和緩南至西南風。隨著低壓槽迫近，風勢轉為清勁，離岸及高地可能達強風以上，天文台需要發出強烈季候風信號。</li><li><strong>當低壓槽橫過香港時</strong>，天色轉暗，風向由南至西南轉為西北並出現猛烈陣風，可將貨櫃等大型物件吹倒。漁民把這種現象稱為「西北石湖」或「打石湖」，對海面漁船及小艇構成危險。狂風過後，氣溫明顯下降，並開始有雨。</li></ul><p>假如上升氣流非常活躍，暖空氣上升至大氣高層時，由於氣溫低於0度，空氣中的水汽結成冰晶。冰晶由於重量而下墜，但被上升氣流再次推到大氣高層，更多的水汽凝結，冰晶體積增大變成冰粒。這個過程不斷重覆，直至上升氣流消失或無法承受冰粒的重量時，冰粒便降到地面，稱為雹。</p><h1 id="examples">Examples</h1><h2 id="低壓槽本周後期殺到-料為港帶來今年第一場雷暴-2023-03-22"><a href="https://std.stheadline.com/realtime/article/1913756/%E5%8D%B3%E6%99%82-%E6%B8%AF%E8%81%9E-%E4%BD%8E%E5%A3%93%E6%A7%BD%E6%9C%AC%E5%91%A8%E5%BE%8C%E6%9C%9F%E6%AE%BA%E5%88%B0-%E6%96%99%E7%82%BA%E6%B8%AF%E5%B8%B6%E4%BE%86%E4%BB%8A%E5%B9%B4%E7%AC%AC%E4%B8%80%E5%A0%B4%E9%9B%B7%E6%9A%B4">低壓槽本周後期殺到 料為港帶來今年第一場雷暴 2023-03-22</a></h2><p>天文台指低壓槽將於本周後期殺到，料為港帶來今年第一場雷暴。</p><p>踏入春季，低壓槽開始變活躍，不時影響華南地區。除了帶來驟雨，有時更可能觸發狂風雷暴等強對流天氣。天文台今日（22日）發表一篇題為「低壓槽靠近，天氣不穩定」的天氣隨筆，指最新預測顯示，位於華南北部的低壓槽會在本周後期移向華南沿岸，廣東地區天氣會漸趨不穩定，該低壓槽亦有機會為本港帶來今年第一場雷暴。</p><p>文章中提到，從預報圖看到，與低壓槽相關的雨區會在周五（24日）逐漸靠近廣東沿岸。按照現時電腦模式顯示，預計周五的雨區主要集中在華南內陸。然而春季低壓槽的前沿偶有颮線形成。即使低壓槽仍在較為內陸的位置，在其前沿發展的颮線有可能已經提前抵達沿岸地區。倘若情況如此，本港周五稍後可能會受狂風雷暴影響。</p><p><img src="https://i.imgur.com/a8s16YX.png" /></p><ul><li>電腦模式預測星期五（3月24日）的天氣圖，預測與 <strong>低壓槽(藍色粗線)</strong> 相關的降雨主要集中在內陸地區。</li><li>天文台又預料低壓槽會在周六進一步靠近沿岸地區，屆時本港出現「顯著降雨」的概率為「高」，<strong>屆時若來自北方的冷空氣較強，低壓槽有機會發展為一道微弱冷鋒</strong>。受隨後的東北季候風影響，本港下周初氣溫稍為下降，仍然有雨。</li></ul><h2 id="季風低壓和熱帶氣旋-hko"><a href="https://www.hko.gov.hk/tc/education/weather/meteorology-basics/00491-monsoon-lows-and-tropical-cyclones.html">季風低壓和熱帶氣旋 | HKO</a></h2><p><strong>當地面天氣圖出現一個氣壓數值較四周低的區域，而能夠分析出閉合的等壓線，該區域便能稱為低壓區</strong>。低壓區可以按其特徵再加以分類，如<strong>季風低壓</strong>、<strong>鋒面低壓</strong>等。今期便和大家談一談季風低壓。</p><p>季風低壓原本是形容夏季影響北印度洋及孟加拉灣的低壓系統，其覆蓋範圍一般較大，閉合等壓線的直徑可達 1000 公里。結構方面，季風低壓最大風速的區域一般位於其外圍。受其他位於附近的天氣系統影響，大風區域可能只集中在季風低壓的某個方向，且風速可達烈風程度。至於在季風低壓中心附近的風速和對流發展相對較弱。季風低壓這個用語其後擴展至形容其他地區(如南海、西北太平洋和澳洲)有相似特徵的低壓系統。</p><p>當季風低壓的中心開始出現持續的對流活動和風速上升的情況，便有機會發展為熱帶氣旋。需要留意：<strong>並不是所有季風低壓都具備發展為熱帶氣旋的條件，如周圍的水氣供應不足，又或遇上強烈的垂直風切變(即大氣高層和低層的風向或風速出現明顯差異)，季風低壓便難以發展為熱帶氣旋</strong>。</p><p>在<strong>北半球的夏季</strong>，衛星雲圖上有時會出現一條滿佈深厚雲團、連綿數千公里長的帶狀區域（附圖黃色虛線圈），氣象學上稱為「<strong>熱帶輻合帶</strong>」，而位於南海至印度洋的一段又叫做「<strong>季風槽</strong>」。由於南北兩側分別吹著西南季風及東北信風這兩支「對頭風」（見圖藍色箭頭），季風槽上容易爆發對流活動，並發展成低壓區，統稱為季風低壓。</p><p>雖然季風低壓與成熟熱帶氣旋兩者都有旋轉環流，但結構上有明顯差別（附表）。至於前者會否演變成後者的問題，就要視乎大氣環境（垂直風場差異、水氣輸送、海水溫度、高空輻散等）是否配合。2016年8月17日早上在廣東西部沿岸海域生成的熱帶低氣壓便是一個成功演變的例子。</p><p><img src="https://i.imgur.com/w5S5PKr.png" /> <img src="https://i.imgur.com/DhvkFg1.png" width="400" /></p><h2 id="當東北季候風遇上廣闊低壓槽-hko-星期六-2024年9月21日"><a href="https://www.hko.gov.hk/tc/%E5%A4%A9%E6%B0%A3%E9%9A%A8%E7%AD%86/108944/%E7%95%B6%E6%9D%B1%E5%8C%97%E5%AD%A3%E5%80%99%E9%A2%A8%E9%81%87%E4%B8%8A%E5%BB%A3%E9%97%8A%E4%BD%8E%E5%A3%93%E6%A7%BD">當東北季候風遇上廣闊低壓槽 | HKO | 星期六, 2024年9月21日</a></h2><p>本港經歷有記錄以來最熱的中秋節後，這兩日迎來了明顯的天氣變化。</p><ul><li>天氣圖顯示一道廣闊低壓槽正影響南海北部至台灣以東海域一帶（圖一），</li><li>而低壓槽上出現多個低壓區。</li><li>其中一個低壓區今日向西橫過本港北部（圖二），</li><li>但其中心風力及對流較弱，並未達到熱帶氣旋強度。</li></ul><p>受與該低壓區相關的雨帶影響，大美督曾短暫吹東北強風，中午前後本港亦有大驟雨及狂風雷暴，多處地區錄得超過50毫米雨量，港島部分地區雨量超過70毫米，天文台亦先後發出黃色及紅色暴雨警告信號。</p><p><img src="https://i.imgur.com/aKUEoYH.png" alt="圖一 9月21日8時地面天氣圖顯示一道廣闊低壓槽正影響南海北部至台灣以東海域一帶。而華中有相當緊密的氣壓梯度。" width="600" /> <img src="https://i.imgur.com/czXPlSE.png" alt="圖二 雷達圖像顯示一個較弱的低壓區今早向西橫過本港北部，其相關雨帶在中午前後為本港帶來大驟雨及狂風雷暴。" width="600" /> <img src="https://i.imgur.com/QDHVYSW.png" alt="圖三 不同電腦模式預測9月23日下午8時的地面天氣圖。" width="600" /></p><h1 id="references">References</h1><ol type="1"><li><a href="https://www.metwarn.com/news/posts/2021/02/%E8%A5%BF%E9%A2%A8%E6%A7%BD%E4%B8%8D%E6%98%AF%E5%A4%A9%E6%B0%A3%E5%A0%B1%E5%91%8A%E6%8F%90%E5%88%B0%E7%9A%84%E4%BD%8E%E5%A3%93%E6%A7%BD%EF%BC%81/">西風槽不是天氣報告提到的低壓槽！</a></li><li><a href="https://www.hko.gov.hk/tc/education/weather/meteorology-basics/00001-what-is-a-trough.html">低壓槽 | HKO</a></li><li><a href="https://www.mmets.org/?p=992">低壓槽是甚麼?</a></li><li><a href="https://www.hko.gov.hk/tc/blog/00000142.htm">季風低壓知多少? | HKO</a></li><li><a href="https://www.weather.org.hk/news/%E4%BD%8E%E5%A3%93%E6%A7%BD%E8%88%87%E5%A4%A9%E6%B0%A3/">低壓槽與天氣</a></li></ol>]]></content>
    
    
    <categories>
      
      <category>Meteorology</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>Westerly Trough | 西風槽</title>
    <link href="/2024/11/14/westerly-trough/"/>
    <url>/2024/11/14/westerly-trough/</url>
    
    <content type="html"><![CDATA[<h1 id="西風槽">西風槽</h1><ul><li>Westerlies 西風帶</li><li>westerly trough 西風槽</li><li>westerly ridge 西風脊</li></ul><p>首先我們要知道，地球上的空氣並不是靜止的，而是不停地流動。空氣流動的速度並不平均，流動方向亦會隨著時間及地點而改變。<strong>高空擾動是大氣高層氣流方向出現顯著變化的區域</strong>。</p><p>由於地球近赤道地區空氣受熱膨脹上升繼而流向兩極，加上地球自轉所產生的科里奧利力（Coriolis force）使在北半球移動的空氣向右偏移（在南半球移動的空氣則向左偏移），中緯度地區上空普遍吹西風（稱為西風帶），即是高空的氣流大致由西向東流動。 - 這些氣流有時彎曲地流動， - 在北半球沿氣流方向向左拐的地方便是「槽」，或稱為「<strong>西風槽</strong>」。 - 相反，向右拐的地方便是「脊」，或「<strong>西風脊</strong>」。</p><p>圖一顯示2015年11月21日上午8時約離地面五公里的高空觀測數據。藍線顯示高空流線，沿氣流方向向左拐彎突轉向(由藍色箭咀至黃色箭咀)的地方便是西風槽的槽軸（紅色虛線顯示）。西風槽的前方（黃色陰影顯示）普遍吹西南風，其後方普遍吹西北風（藍色箭咀顯示）。從與圖一相同時間的可見光及紅外光合併衛星雲圖可見（圖二），位於西風槽的前方水汽相對較多，雲團較為厚實，而槽後方的雲層則相對稀薄。一般而言，西風槽的前方有利低層空氣往上升，該區的大氣相對不穩定，較易產生雲和雨，甚至是雷暴，而槽的後方空氣由高空往下沉，大氣相對穩定，有利出現晴朗的天氣。</p><figure><img src="https://i.imgur.com/U6AMW53.png" alt="圖一 2015年11月21日上午8時在500百帕的高空觀測數據" width="400" /><figcaption>圖一 2015年11月21日上午8時在500百帕的高空觀測數據</figcaption></figure><p>受到不同大小的天氣系統影響，大氣的流動可以非常複雜，高空擾動有時亦會發生在地球較低緯度上空的偏東氣流中（特別在夏季）。一般來說，高空擾動代表附近有機會出現不穩定的天氣，所以分析高空擾動及估計其動向對預測天氣尤為重要。</p><figure><img src="https://i.imgur.com/udPgc1w.png" alt="圖二 跟圖一相同時間的可見光及紅外光合併衛星雲圖" width="400" /><figcaption>圖二 跟圖一相同時間的可見光及紅外光合併衛星雲圖</figcaption></figure><figure><img src="https://i.imgur.com/foKhfuJ.png" alt="高空擾動對大氣環流的影響。藍色曲線代表西風帶的流線，其向南的大幅波動稱為西風槽，而紅色虛線標示槽軸的位置。槽軸前（以東）的風速較高，氣流不穩定甚至會形成急流，有利該區下方空氣向上抬升。至於槽軸後（以西）的區域，一般會出現下沉氣流。" /><figcaption>高空擾動對大氣環流的影響。藍色曲線代表西風帶的流線，其向南的大幅波動稱為西風槽，而紅色虛線標示槽軸的位置。槽軸前（以東）的風速較高，氣流不穩定甚至會形成急流，有利該區下方空氣向上抬升。至於槽軸後（以西）的區域，一般會出現下沉氣流。</figcaption></figure><h1 id="西風槽低壓槽">西風槽/低壓槽</h1><p>西風槽不是天氣報告提到的低壓槽！大氣中層的西風槽與天氣報告經常提到的低壓槽不同，西風槽必定會順著西風帶自西向東移動，地面則未必出現兩股氣流匯聚，可以是受單一氣流影響。</p><p>西風槽向東南移動時代表正在增強，向東北移動時則代表減弱，向東移動代表強度維持。西風槽槽軸左邊是下沉氣流，代表好天區域，而西風槽槽軸右邊則代表上升氣流，有利對流發展。</p><p>而低壓槽則代表兩股氣流匯聚，對流主要在兩股氣流輻合之處發展。另外，低壓槽可以向西移動，移動規律與西風槽有分別。西風槽或低壓槽任何一個出現已可導致對流發展，不過兩者同時出現時對流發展會更為旺盛。</p><h2 id="低壓槽">低壓槽</h2><h1 id="references">References</h1><ol type="1"><li><a href="https://www.hko.gov.hk/tc/education/weather/meteorology-basics/00478-what-is-upperair-disturbance.html">甚麼是高空擾動？| HKO</a></li><li><a href="https://www.hko.gov.hk/tc/education/weather/rain/00549-rainstorm-development-mechanisms.html">淺談香港的暴雨產生機制 | HKO</a></li><li><a href="https://www.metwarn.com/news/posts/2021/02/%E8%A5%BF%E9%A2%A8%E6%A7%BD%E4%B8%8D%E6%98%AF%E5%A4%A9%E6%B0%A3%E5%A0%B1%E5%91%8A%E6%8F%90%E5%88%B0%E7%9A%84%E4%BD%8E%E5%A3%93%E6%A7%BD%EF%BC%81/">西風槽不是天氣報告提到的低壓槽！</a></li><li><a href="https://www.hko.gov.hk/tc/education/weather/meteorology-basics/00001-what-is-a-trough.html">低壓槽 | HKO</a></li><li><a href="https://www.mmets.org/?p=992">低壓槽是甚麼?</a></li></ol>]]></content>
    
    
    <categories>
      
      <category>Meteorology</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>WRF | MPAS Output for WRF IC/BC</title>
    <link href="/2024/11/13/WRF-MPAS-as-ICBC/"/>
    <url>/2024/11/13/WRF-MPAS-as-ICBC/</url>
    
    <content type="html"><![CDATA[<h1 id="using-mpas-output-for-wrf-initial-and-lateral-boundary-conditions">Using MPAS Output for WRF Initial and Lateral Boundary Conditions</h1><div class="note note-warning">            <p><a href="https://www2.mmm.ucar.edu/wrf/users/docs/user_guide_v4/v4.2/users_guide_chap3.html#_Using_MPAS_Output">Using MPAS Output for WRF Initial and Lateral Boundary Conditions</a></p>          </div><p><strong>copy as record</strong></p><h1 id="mpas-output-stream">MPAS output stream</h1><p><strong>Beginning with the v3.9 release of the WPS</strong>, the <code>metgrid.exe</code> program is capable of reading native, unstructured mesh output in netCDF format from the Model for Prediction Across Scales (<strong>MPAS</strong>; <a href="https://mpas-dev.github.io/" class="uri">https://mpas-dev.github.io/</a>); the metgrid.exe program can then horizontally interpolate the MPAS fields directly to any domain defined by the geogrid.exe program to produce output files that are usable by the WRF real.exe program in exatly the same way as metgrid output interpolated from intermediate files. In this way, output from MPAS may be used to provide initial and lateral boundary conditions for WRF. When running an MPAS simulation, an <strong>output stream</strong> must be set up to contain the minimum set of fields necessary to initialize a WRF simulation. <strong>The following output stream should be sufficient with the MPAS v5.x and later code</strong>.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs namelist">&lt;stream name=&quot;wrf_ic_bc&quot;<br>        type=&quot;output&quot;<br>        filename_template=&quot;MPAS.$Y-$M-$D_$h.nc&quot;<br>        output_interval=&quot;3:00:00&quot; &gt;<br><br> &lt;var name=&quot;xtime&quot;/&gt;<br> &lt;var_array name=&quot;scalars&quot;/&gt;<br> &lt;var name=&quot;pressure&quot;/&gt;<br> &lt;var name=&quot;zgrid&quot;/&gt;<br> &lt;var name=&quot;theta&quot;/&gt;<br> &lt;var name=&quot;uReconstructZonal&quot;/&gt;<br> &lt;var name=&quot;uReconstructMeridional&quot;/&gt;<br> &lt;var name=&quot;u10&quot;/&gt;<br> &lt;var name=&quot;v10&quot;/&gt;<br> &lt;var name=&quot;q2&quot;/&gt;<br> &lt;var name=&quot;t2m&quot;/&gt;<br> &lt;var name=&quot;skintemp&quot;/&gt;<br> &lt;var name=&quot;surface_pressure&quot;/&gt;<br> &lt;var name=&quot;mslp&quot;/&gt;<br> &lt;var name=&quot;tslb&quot;/&gt;<br> &lt;var name=&quot;smois&quot;/&gt;<br>&lt;/stream&gt;<br></code></pre></td></tr></table></figure><h1 id="metgrid-namelist">metgrid namelist</h1><p>After having run MPAS with a <strong>suitable output stream defined</strong>, a set of netCDF files containing fields on the native MPAS mesh will have been produced. Because these files do not contain fields describing the locations, geometry, and connectivity of the MPAS grid cells, this information must be provided to the metgrid program with a <code>“static”</code> file from the MPAS simulation. Therefore, it is necessary to specify MPAS netCDF files (prefixed with <code>‘mpas:’</code>) in the &amp;metgrid namelist record with both the <code>constants_name</code> and <code>fg_name</code> variables, e.g.,</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs namelist">&amp;metgrid<br> constants_name = ‘mpas:static.nc’<br> fg_name = ‘mpas:MPAS’<br>/<br></code></pre></td></tr></table></figure><p>In the above example, the metgrid.exe program would first read the MPAS <code>‘static.nc’</code> file to read mesh information and compute remapping weights from the MPAS mesh to the WRF domain defined by the geogrid.exe program, <strong>then all time periods of the MPAS files with a prefix of</strong> <code>‘MPAS’</code> <strong>(and a suffix of YYYY-MM-DD_HH.nc)</strong> would be processed. The real.exe program can then be run as usual.</p><p>Data from intermediate files created by the ungrib.exe program can be combined with MPAS data by the metgrid program. This may be useful, e.g., to use SST, sea ice, or land-surface fields from another source. An example of combining MPAS data with ERA-Interim intermediate files with soil data (with the prefix ‘ERAI_SOIL’) is shown below.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs namelist">&amp;metgrid<br>  constants_name = ‘mpas:static.nc’<br>  fg_name = ‘mpas:MPAS’, ‘ERAI_SOIL’<br>/<br></code></pre></td></tr></table></figure><p>Because the MPAS <code>‘zgrid’</code> field does not change in time, it can be omitted from the MPAS periodic output stream; in this case, however, the ‘zgrid’ field must be placed in its own netCDF file that must also define the dimension ‘Time’ as a netCDF unlimited dimension. Then, this file (say, ‘zgrid.nc’) can be supplied to the metgrid program using the constants_name namelist variable, e.g.,</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs namelist">&amp;metgrid<br> constants_name = ‘mpas:static.nc’, ‘mpas:zgrid.nc’<br> fg_name = ‘mpas:MPAS’<br>/<br></code></pre></td></tr></table></figure><p>Placing the ‘zgrid’ field in its own file can save considerable space when long MPAS simulations are run, or when the output stream to be used as WRF initial and boundary conditions is written out at high temporal frequency. The python script, below, may serve as an example of how to extract the ‘zgrid’ field to its own netCDF file.</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> netCDF4 <span class="hljs-keyword">import</span> Dataset<br>fin = Dataset(<span class="hljs-string">&#x27;init.nc&#x27;</span>)<br>fout = Dataset(<span class="hljs-string">&#x27;zgrid.nc&#x27;</span>,<span class="hljs-string">&#x27;w&#x27;</span>,<span class="hljs-built_in">format</span>=<span class="hljs-string">&#x27;NETCDF3_64BIT&#x27;</span>)<br>nCells = fin.dimensions[<span class="hljs-string">&#x27;nCells&#x27;</span>].size<br>nVertLevelsP1 = fin.dimensions[<span class="hljs-string">&#x27;nVertLevelsP1&#x27;</span>].size<br>fout.createDimension(dimname=<span class="hljs-string">&#x27;Time&#x27;</span>,size=<span class="hljs-literal">None</span>)<br>fout.createDimension(dimname=<span class="hljs-string">&#x27;nCells&#x27;</span>,size=nCells)<br>fout.createDimension(dimname=<span class="hljs-string">&#x27;nVertLevelsP1&#x27;</span>,size=nVertLevelsP1)<br>fout.createVariable(varname=<span class="hljs-string">&#x27;zgrid&#x27;</span>,datatype=<span class="hljs-string">&#x27;f&#x27;</span>,dimensions=(<span class="hljs-string">&#x27;nCells&#x27;</span>, <span class="hljs-string">&#x27;nVertLevelsP1&#x27;</span>))<br>fout.variables[<span class="hljs-string">&#x27;zgrid&#x27;</span>][:] = fin.variables[<span class="hljs-string">&#x27;zgrid&#x27;</span>][:]<br>fout.close()<br>fin.close()<br></code></pre></td></tr></table></figure><div class="note note-warning">            <p><strong>It is worth noting that the use of native MPAS output with metgrid.exe has not been thoroughly tested for parallel (i.e., “dmpar”) builds of the WPS; it is therefore recommended to run metgrid.exe in serial when processing MPAS datasets.</strong></p>          </div><p><strong>Please use 1 core (serial) to run metgrid.exe.</strong> Otherwise, the wrfout will be fail even (dmpar) of metgrid seems to be done.</p><div class="note note-danger">            <p><strong>sbatch -N 1 -n 1 run_metgrid.sh</strong></p>          </div><h1 id="for-large-mpas-meshes">For large MPAS meshes</h1><p>Also, in cases of large MPAS meshes, it may be necessary to increase the value of two constants in the metgrid code that <strong>are used to statically allocate several data structures used in the computation of remapping weights from the MPAS mesh to the WRF domain</strong>. These two constants, shown below, are located in the <code>WPS/src/metgrid/remapper.F</code> file.</p><figure class="highlight fortran"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs fortran"><span class="hljs-comment">! should be at least (earth circumference / minimum grid distance)</span><br><span class="hljs-keyword">integer</span>, <span class="hljs-keyword">parameter</span> :: max_queue_length    = <span class="hljs-number">2700</span><br><br><span class="hljs-comment">! should be at least (nCells/32)</span><br><span class="hljs-keyword">integer</span>, <span class="hljs-keyword">parameter</span> :: max_dictionary_size = <span class="hljs-number">82000</span>  <br></code></pre></td></tr></table></figure><p>After changing the value of these constants, <strong>metgrid must be recompiled</strong>.</p><h1 id="hands-on">Hands-on</h1><h2 id="mpas-output-nc-files">MPAS output nc files</h2><p>File name format of MPAS* and static.nc are,</p><figure class="highlight console"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs console">MPAS.2024-05-01_00.nc  MPAS.2024-05-01_09.nc  MPAS.2024-05-01_18.nc<br>MPAS.2024-05-01_01.nc  MPAS.2024-05-01_10.nc  MPAS.2024-05-01_19.nc<br>MPAS.2024-05-01_02.nc  MPAS.2024-05-01_11.nc  MPAS.2024-05-01_20.nc<br>MPAS.2024-05-01_03.nc  MPAS.2024-05-01_12.nc  MPAS.2024-05-01_21.nc<br>MPAS.2024-05-01_04.nc  MPAS.2024-05-01_13.nc  MPAS.2024-05-01_22.nc<br>MPAS.2024-05-01_05.nc  MPAS.2024-05-01_14.nc  MPAS.2024-05-01_23.nc<br>MPAS.2024-05-01_06.nc  MPAS.2024-05-01_15.nc  MPAS.2024-05-02_00.nc<br>MPAS.2024-05-01_07.nc  MPAS.2024-05-01_16.nc  static.nc<br>MPAS.2024-05-01_08.nc  MPAS.2024-05-01_17.nc  <br></code></pre></td></tr></table></figure><div class="note note-primary">            <p><strong>MPAS.2024-05-01_00.nc</strong></p>          </div><h2 id="wrf-metgrid">WRF metgrid</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs namelist">&amp;metgrid<br> constants_name = &#x27;mpas:static.nc&#x27;,<br> fg_name = &#x27;mpas:MPAS&#x27;,<br> io_form_metgrid = 2, <br> opt_metgrid_tbl_path = &#x27;./&#x27;<br>/<br></code></pre></td></tr></table></figure><p>Note: There is no ungrid part.</p><p>In WPS,</p><ul><li><a href="https://github.com/wrf-model/WPS/blob/335c76a111f84503e8b963abaf273ea8053645bb/metgrid/src/process_domain_module.F#L764">WPS/metgrid/src/process_domain_module.F</a></li></ul><figure class="highlight fortran"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs fortran"><span class="hljs-keyword">if</span> (<span class="hljs-built_in">index</span>(input_name, <span class="hljs-string">&#x27;mpas:&#x27;</span>) == <span class="hljs-number">1</span>) <span class="hljs-keyword">then</span><br>   <span class="hljs-keyword">call</span> process_mpas_fields(input_name, do_const_processing, temp_date, fg_data, got_this_field, &amp;<br>                            landmask, process_bdy_width, &amp;<br>                            u_field, v_field, &amp;<br>                            dom_dx, dom_dy, ...... )<br></code></pre></td></tr></table></figure><p>e.g. log file</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs log">Processing domain 1 of 2<br>    mpas:static.nc<br> Processing 2024-05-01_00<br>    mpas:MPAS<br> Processing 2024-05-01_03<br>    mpas:MPAS<br> Processing 2024-05-01_06<br>    mpas:MPAS<br>Processing domain 2 of 2<br>    mpas:static.nc<br> Processing 2024-05-01_00<br>    mpas:MPAS<br> Processing 2024-05-01_03<br>    mpas:MPAS<br> Processing 2024-05-01_06<br>    mpas:MPAS<br>!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!<br>!  Successful completion of metgrid.  !<br>!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!<br></code></pre></td></tr></table></figure><h2 id="wrf-realwrf">WRF real/wrf</h2><ul><li>SIZE MISMATCH: num_metgrid_levels --&gt; 56 (default of MPAS)</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs log">d01 2024-05-01_00:00:00  Yes, this special data is acceptable to use: OUTPUT FROM METGRID V4.3<br>d01 2024-05-01_00:00:00  Input data is acceptable to use: met_em.d01.2024-05-01_00:00:00.nc<br> metgrid input_wrf.F first_date_input = 2024-05-01_00:00:00<br> metgrid input_wrf.F first_date_nml = 2024-05-01_00:00:00<br>d01 2024-05-01_00:00:00  input_wrf.F: SIZE MISMATCH:  namelist num_metgrid_levels           =           34<br>d01 2024-05-01_00:00:00  input_wrf.F: SIZE MISMATCH:  input file BOTTOM-TOP_GRID_DIMENSION  =           56<br></code></pre></td></tr></table></figure><ul><li>p_top_requested &lt; grid%p_top</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs log">rsl.error.0020:25:p_top_requested &lt; grid%p_top possible from data<br>rsl.out.0016:31: p_top_requested =    1000.00000    <br>rsl.out.0016:32: allowable grid%p_top in data   =    1281.68921    <br>rsl.out.0016:35:p_top_requested &lt; grid%p_top possible from data<br><br>-------------- FATAL CALLED ---------------<br>FATAL CALLED FROM FILE:  &lt;stdin&gt;  LINE:    1219<br>p_top_requested &lt; grid%p_top possible from data<br>-------------------------------------------<br></code></pre></td></tr></table></figure><p>How? try to set <code>p_top_requested = 5000</code>. (leave homework)</p><h3 id="real.exe"><code>real.exe</code></h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs log">d01 2024-05-01_06:00:00 real_em: SUCCESS COMPLETE REAL_EM INIT<br></code></pre></td></tr></table></figure><h3 id="wrf.exe"><code>wrf.exe</code></h3><ul><li>Segmentation fault - invalid memory reference</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs log">==&gt; rsl.out.0025 &lt;==<br>d01 2024-05-01_00:00:00  Input data is acceptable to use:<br> Tile Strategy is not specified. Assuming 1D-Y<br>WRF TILE   1 IS      1 IE     20 JS     84 JE    100<br>WRF NUMBER OF TILES =   1<br> Flerchinger USEd in NEW version. Iterations=          10<br> Flerchinger USEd in NEW version. Iterations=          10<br><br>==&gt; rsl.error.0028 &lt;==<br>d01 2024-05-01_00:00:00  Input data is acceptable to use:<br> Tile Strategy is not specified. Assuming 1D-Y<br>WRF TILE   1 IS     61 IE     80 JS     84 JE    100<br>WRF NUMBER OF TILES =   1<br><br>Program received signal SIGSEGV: Segmentation fault - invalid memory reference.<br><br>Backtrace for this error:<br>#0  0x1488066c7b4f in ???<br><br>==&gt; rsl.out.0000 &lt;==<br>d01 2024-05-01_00:00:00        14241  points exceeded w_critical_cfl in domain d01 at time 2024-05-01_00:00:00 hours<br>d01 2024-05-01_00:00:00 Max   W:     74     24      2 W: *******  w-cfl:     Inf  dETA:    0.01<br></code></pre></td></tr></table></figure><p>Note: Be aware of the stability (here, MPAS-480km mesh is used).</p><p>Successful,</p><figure class="highlight console"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs console"><span class="hljs-meta prompt_"> $ </span><span class="language-bash"><span class="hljs-built_in">ls</span> wrf*</span><br>wrfbdy_d01  wrf.exe  wrfinput_d01  wrfout_d01_2024-05-01_00:00:00  wrfrst_d01_2024-05-01_06:00:0<br><br>==&gt; rsl. &lt;==<br>Timing for Writing restart for domain        1:   14.65449 elapsed seconds<br>d01 2024-05-01_06:00:00 wrf: SUCCESS COMPLETE WRF<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>WRF</category>
      
    </categories>
    
    
    <tags>
      
      <tag>WRF</tag>
      
      <tag>WPS</tag>
      
      <tag>MPAS</tag>
      
      <tag>IC/BC</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>NWP | ECMWF | IFS | Open data</title>
    <link href="/2024/11/12/ECMWF-IFS/"/>
    <url>/2024/11/12/ECMWF-IFS/</url>
    
    <content type="html"><![CDATA[<h1 id="open-dataset">Open Dataset</h1><ul><li><a href="https://www.ecmwf.int/en/about/media-centre/news/2025/ecmwf-achieve-fully-open-data-status-2025">ECMWF to achieve fully open data status in 2025 | 17 March 2025</a><ul><li><strong>ECMWF is bringing forward the full transition to open data by an entire year, to 1 October 2025</strong>, marking a significant milestone in its commitment to making weather data more accessible and impactful.</li></ul></li></ul><p>ECMWF now provides a much larger open dataset to the public, representing weather forecasts at a higher resolution and a reduction in some release times, after a <a href="https://www.ecmwf.int/en/about/media-centre/news/2022/ecmwf-makes-wide-range-data-openly-available">first set of data was made available in early 2022</a>.</p><p>The changes can be summarised as follows:</p><ul><li>Medium-range data of the <strong>Integrated Forecasting System (IFS)</strong> are provided at a resolution of <strong>0.25 x 0.25 degrees (28 x 28 km)</strong>, compared to 0.4 x 0.4 degrees before, and some additional parameters will be added.</li><li>Medium-range data of the latest beta version of the <strong>Artificial Intelligence/Integrated Forecasting System (AIFS)</strong> are also available at a <strong>resolution of 0.25 x 0.25 degrees</strong>.</li><li>ECMWF’s contribution to the sub-seasonal to seasonal (S2S) dataset, which is part of a global scheme, is now available with a 48-hour delay rather than the previous three-week delay.</li><li>All parameters of the EU’s Copernicus Atmosphere Monitoring Service (CAMS) that used to a have a six-day embargo are now available in real time.</li></ul><p>An <a href="https://www.ecmwf.int/en/forecasts/datasets/open-data">overview of open data</a> is given on the ECMWF website.</p><p>歐洲中期天氣預報中心 (ECMWF) 的 IFS 模式現在可以作為 0.25 度解析度的開放資料取得。從 2024 年 2 月 1 日 開始，IFS 開放資料分佈的解析度從 0.4 度提高到 0.25 度。這項改進顯著提高了數據精度，尤其是在沿海地區和山區。改進後的分辨率受到了廣泛歡迎，因為之前的 0.4 度分辨率對於許多應用來說太粗糙。</p><p>資料下載連結： <div class="note note-warning">            <p><a href="https://data.ecmwf.int/forecasts/" class="uri">https://data.ecmwf.int/forecasts/</a></p>          </div></p><p>規格如下：</p><ul><li>解析度從 0.4° 提升至 <strong>0.25°</strong></li><li>0.25° x 0.25° lat/lon grid or any multiple thereof (global or sub-area)</li><li>On model (Reduced Gaussian) n320 grid</li><li>地表變因：2 公尺氣溫、地表溫度、降水量、氣壓、10 公尺風速</li><li>9 個大氣壓力層位提供溫度、濕度或風速數據</li><li><strong>10 天預報，時間間隔 3 小時</strong></li><li>15 天集合預報，包含 51 個集合成員</li><li><strong>每天更新 4 次</strong> (00/06/12/18)</li><li>最新測試版的人工智慧/綜合預測系統（<strong>AIFS</strong>）的中尺度資料也可提供0.25 x 0.25度的解析度</li><li>歐洲中期天氣預報中心（ECMWF）對次季節到季節尺度（<strong>S2S</strong>）資料集的貢獻，作為全球計劃的一部分，<strong>現在可以在48小時延遲後獲取，而不是之前的三週延遲</strong><ul><li>歐洲中期天氣預報中心(ECMWF)在由世界氣象研究計畫(WWRP)和世界氣候研究計畫(WCRP)組織的預測計畫中，對次季節到季節尺度天氣預報也進行了大大減少的延遲。 ECMWF是此計畫的眾多預報中心之一。我們的預報現在只有48小時的延遲，而不是以前的三週延遲。計劃是鼓勵所有次季節性到季節尺度資料提供者同意減少他們的貢獻延遲。更多資訊可以在次季節性到季節尺度存檔頁面上找到（<a href="https://confluence.ecmwf.int/display/S2S/S2S+archive" class="uri">https://confluence.ecmwf.int/display/S2S/S2S+archive</a>）</li></ul></li><li>歐盟的哥白尼大氣監測服務（CAMS）的所有參數，原本需要六天的禁止發布期，現在都可以即時取得<ul><li>ECMWF每天提供全球大氣組成的預報，作為其CAMS產品組合的一部分。這些預報包括0.4 x 0.4度的所有氣象變數。這些預報的壓力層資料和一些地表場資料以前只能在六天後才能獲得。現在它們可以即時獲取，就像大氣組成產品一樣。有關CAMS資料的更多詳細信息，請參閱全球大氣組成預報資料文件頁面（<a href="https://confluence.ecmwf.int/display/CKB/CAMS%3A+Global+atmospheric+composition+forecast+data+documentation" class="uri">https://confluence.ecmwf.int/display/CKB/CAMS%3A+Global+atmospheric+composition+forecast+data+documentation</a>）。</li></ul></li><li>升級後的解析度已無縫整合到 Open-Meteo 天氣 API 中。現在您可以比較 18 個不同天氣模型的預報，評估預報的不確定性並選擇最符合您需求的模型。</li><li>0.25° 解析度的 51 個集合成員可以透過 Ensemble API 存取。有關 ECMWF IFS 開放資料計劃的更多詳細信息，請參閱 ECMWF 網站。</li></ul><p>憑藉 0.25° 的分辨率，新的 IFS 開放資料模型適用於 Google GraphCast <strong>機器學習模型</strong>的實際操作。先前，GraphCast 依賴歐洲地球觀測計畫的 <strong>ERA5 資料集，該資料集存在 5 天的延遲</strong>，使其不適用於即時預報應用。開放資料 IFS 0.25° 的發布現在允許您每 6 小時執行 GraphCast 並建立機器學習預報。唯一需要注意的是，高效運行 GraphCast 需要一個大型 GPU，但與超級電腦相比，這已經非常划算了。</p><ul><li>這些將實現有限區域建模和機器學習初始化。有關即時預測的文件可以在開放資料頁面找到。</li><li>最新測試版<strong>AIFS</strong>的中期數據也以0.25 x 0.25度的解析度提供。這是目前AIFS運作的解析度。有關AIFS的更多信息，包括訪問數據的鏈接，請參閱AIFS機器學習數據頁面（<a href="https://www.ecmwf.int/en/forecasts/dataset/aifs-machine-learning-data" class="uri">https://www.ecmwf.int/en/forecasts/dataset/aifs-machine-learning-data</a>）。</li></ul><h1 id="snapshot">Snapshot</h1><p><img src="https://i.imgur.com/onPeaOO.png" width="400" /></p><ul><li><strong>---Only few days Available---</strong> !!!</li><li>File format<ul><li>The files are in GRIB edition 2 format, except for trajectories which are in BUFR edition 4 format.</li></ul></li></ul><table><thead><tr class="header"><th>Grib Code</th><th>Mars Abbreviation</th><th>Long Name</th><th>Available model runs</th></tr></thead><tbody><tr class="odd"><td>1025</td><td>oper</td><td>Atmospheric model</td><td>00z, 12z</td></tr><tr class="even"><td>1026</td><td>scda</td><td>Atmospheric model (short cutoff)</td><td>06z, 18z</td></tr><tr class="odd"><td>1035</td><td>enfo</td><td>Ensemble prediction system</td><td>00z, 06z, 12z, 18z</td></tr><tr class="even"><td>1045</td><td>wave</td><td>Wave model</td><td>00z, 12z</td></tr><tr class="odd"><td>1081</td><td>waef</td><td>Wave ensemble forecast</td><td></td></tr></tbody></table><p>from <a href="https://codes.ecmwf.int/grib/format/mars/stream/" class="uri">https://codes.ecmwf.int/grib/format/mars/stream/</a></p><figure><img src="https://i.imgur.com/j5aMuFL.png" alt="Time available (UTC)" width="400" /><figcaption>Time available (UTC)</figcaption></figure><h2 id="ecmwf-open-data-real-time-forecasts-from-ifs-and-aifs-feb-26-2025">ECMWF open data: real-time forecasts from IFS and AIFS (Feb 26, 2025)</h2><ul><li><a href="https://confluence.ecmwf.int/display/DAC/ECMWF+open+data%3A+real-time+forecasts+from+IFS+and+AIFS">ECMWF open data: real-time forecasts from IFS and AIFS (Feb 26, 2025)</a></li></ul><p>Currently, ECMWF open real-time data are available from these locations:</p><ul><li><strong>ECMWF</strong>: <a href="https://data.ecmwf.int/forecasts" class="uri">https://data.ecmwf.int/forecasts</a></li><li><strong>Amazon's AWS</strong>: "<a href="https://ecmwf-forecasts.s3.eu-central-1.amazonaws.com" class="uri">https://ecmwf-forecasts.s3.eu-central-1.amazonaws.com</a>"</li><li><strong>Google Cloud</strong>: "<a href="https://console.cloud.google.com/marketplace/product/bigquery-public-data/open-data-ecmwf" class="uri">https://console.cloud.google.com/marketplace/product/bigquery-public-data/open-data-ecmwf</a>"</li><li><strong>Microsoft's Azure</strong>: "<a href="https://ai4edataeuwest.blob.core.windows.net/ecmwf" class="uri">https://ai4edataeuwest.blob.core.windows.net/ecmwf</a>" (warning) see below for access notes</li><li><strong>Open-meteo.com</strong>: "<a href="https://open-meteo.com/en/docs/ecmwf-api" class="uri">https://open-meteo.com/en/docs/ecmwf-api</a>"</li><li>ECMWF is happy to announce that IFS Open Data is now available from <strong>Oikolab</strong>!</li></ul><h3 id="file-format">File format</h3><p>The files are in <strong>GRIB edition 2 format</strong>, except for trajectories which are in BUFR edition 4 format. We recommend using ecCodes version 2.38.0 or newer to manipulate the GRIB and BUFR files.</p><h3 id="file-naming-convention">File-naming convention</h3><p>The files are provided with the following naming convention:</p><figure class="highlight console"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs console">[ROOT]/[yyyymmdd]/[HH]z/[model]/[resol]/[stream]/[yyyymmdd][HH]0000-[step][U]-[stream]-[type].[format]<br></code></pre></td></tr></table></figure><ul><li>[ROOT] is the top-level URL of one of the sites hosting the data. See the above for possible values.</li><li>[yyyymmdd] is the reference date of the forecasts (base date).</li><li>[HH] is the reference time of the forecasts. Values are 00, 06 , 12 and 18.</li><li>[model] is the production model (IFS or AIFS). <strong>Note: IFS and AIFS have different options, so please be review dataset pages to see what is available.</strong></li><li>[resol] is the horizontal resolution of the data. <strong>Options include: 0p25</strong></li><li>[stream] is the forecasting system that produces the data. Values are:<ul><li>oper - high-resolution forecast, atmospheric fields</li><li>enfo - ensemble forecast, atmospheric fields (not applicable for AIFS model)</li><li>waef - ensemble forecast, ocean wave fields, (not applicable for AIFS model)</li><li>wave - wave model, (not applicable for AIFS model)</li><li>scda - short cut-off high-resolution forecast, atmospheric fields (also known as "high-frequency products") (not applicable for AIFS model)</li><li>scwv - short cut-off high-resolution forecast, ocean wave fields (also known as "high-frequency products") (not applicable for AIFS model) and</li><li>mmsf - multi-model seasonal forecasts fields from the ECMWF model only (not applicable for AIFS model).<br /></li></ul></li><li>[step] is the forecast time step expressed in units U<br /></li><li>[U] is the unit used for the time step. Values are h for hours and m for month. The latter is only valid for seasonal forecasts (mmsf).</li><li>[type] is once of fc (forecast), ef (ensemble forecast), ep (ensemble probabilities) or tf (trajectory forecast for tropical cyclone tracks).</li><li>[format] is grib2 for all fields, and bufr for the trajectories.</li></ul><h3 id="the-valid-combinations-of-the-above-are">The valid combinations of the above are:</h3><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs text">format=bufr, type=tf <br>   HH=00/12 <br>    stream=enfo/oper, step=240h <br>   HH=06/18 <br>      stream=enfo, step=144h <br>      stream=scda, step=90h <br>format=grib2 <br>   HH=00/12 <br>      stream=enfo/waef <br>        type=ef, step=0h to 144h by 3h, 144h to 360h by 6h <br>        type=ep, step=240h/360h <br>      stream=oper, wave <br>        type=fc, step=0h to 144h by 3h, 144h to 240h by 6h <br>   HH=06/18 <br>      stream=enfo/waef <br>        type=ef, step=0h to 144h by 3h <br>      stream= scda /scwv <br>        type=fc, step=0h to 90h by 3h <br>   HH=00 <br>     stream=mmsf, type=fc, u=m, step=1m to 7m <br></code></pre></td></tr></table></figure><h3 id="via-herbie">via Herbie</h3><div class="note note-primary">            <ul><li><a href="https://waipangsze.github.io/2025/04/10/NWP-Herbie-Download-NWP-model-output-MPAS-WRF/"><strong>NWP | Herbie | Download NWP model output (grib2) | MPAS | WRF</strong></a></li></ul>          </div><h1 id="variables">Variables</h1><ul><li><a href="https://www.ecmwf.int/en/forecasts/datasets/set-ix">Deterministic AIFS forecast (Set IX - AIFS)</a></li></ul><h2 id="single-level---forecast">Single level - forecast</h2><table><thead><tr class="header"><th>Short Name</th><th>ID</th><th>Long Name</th><th>Units</th><th>Additional information</th></tr></thead><tbody><tr class="odd"><td>z</td><td>129</td><td>Geopotential</td><td>m^2 s^-2</td><td></td></tr><tr class="even"><td>msl</td><td>151</td><td>Mean sea level pressure</td><td>Pa</td><td></td></tr><tr class="odd"><td>sdor</td><td>160</td><td>Standard deviation of sub-gridscale orography</td><td>m</td><td></td></tr><tr class="even"><td>slor</td><td>163</td><td>Slope of sub-gridscale orography</td><td>Numeric</td><td></td></tr><tr class="odd"><td>10u</td><td>165</td><td>10 metre U wind component</td><td>m s^-1</td><td></td></tr><tr class="even"><td>10v</td><td>166</td><td>10 metre V wind component</td><td>m s^-1</td><td></td></tr><tr class="odd"><td>2t</td><td>167</td><td>2 metre temperature</td><td>K</td><td></td></tr><tr class="even"><td>2d</td><td>168</td><td>2 metre dewpoint temperature</td><td>K</td><td></td></tr><tr class="odd"><td>ssrd</td><td>169</td><td>Surface short-wave (solar) radiation downwards</td><td>J m^-2</td><td></td></tr><tr class="even"><td>lsm</td><td>172</td><td>Land-sea mask</td><td>(0-1)</td><td></td></tr><tr class="odd"><td>strd</td><td>175</td><td>Surface long-wave (thermal) radiation downwards</td><td>J m^-2</td><td></td></tr><tr class="even"><td>lcc</td><td>3073</td><td>Low cloud cover</td><td>%</td><td></td></tr><tr class="odd"><td>mcc</td><td>3074</td><td>Medium cloud cover</td><td>%</td><td></td></tr><tr class="even"><td>hcc</td><td>3075</td><td>High cloud cover</td><td>%</td><td></td></tr><tr class="odd"><td>rowe</td><td>231002</td><td>Runoff water equivalent (surface plus subsurface)</td><td>kg m^-2</td><td></td></tr><tr class="even"><td>cp</td><td>228143</td><td>Convective precipitation</td><td>kg m^-2</td><td></td></tr><tr class="odd"><td>sf</td><td>228144</td><td>Snowfall</td><td>kg m^-2</td><td></td></tr><tr class="even"><td>tcc</td><td>228164</td><td>Total cloud cover</td><td>%</td><td></td></tr><tr class="odd"><td>tp</td><td>228228</td><td>Total precipitation</td><td>kg m^-2</td><td></td></tr><tr class="even"><td>100u</td><td>228246</td><td>100 metre U wind component</td><td>m s^-1</td><td></td></tr><tr class="odd"><td>100v</td><td>228247</td><td>100 metre V wind component</td><td>m s^-1</td><td></td></tr></tbody></table><h2 id="pressure-level---forecast">Pressure level - forecast</h2><ul><li>All parameters are available at levels 1000, 925, 850, 700, 600, 500, 400, 300, 250, 200, 150, 100, 50 hPa</li></ul><table><thead><tr class="header"><th>SHORT NAME</th><th>ID</th><th>LONG NAME</th><th>UNITS</th><th>ADDITIONAL INFORMATION</th></tr></thead><tbody><tr class="odd"><td>z</td><td>129</td><td>Geopotential</td><td>m^2 s^-2</td><td></td></tr><tr class="even"><td>t</td><td>130</td><td>Temperature</td><td>K</td><td></td></tr><tr class="odd"><td>u</td><td>131</td><td>U component of wind</td><td>m s^-1</td><td></td></tr><tr class="even"><td>v</td><td>132</td><td>V component of wind</td><td>m s^-1</td><td></td></tr><tr class="odd"><td>q</td><td>133</td><td>Specific humidity</td><td>kg kg^-1</td><td></td></tr><tr class="even"><td>w</td><td>135</td><td>Vertical velocity</td><td>Pa s^-1</td><td></td></tr></tbody></table><h2 id="soil-level---forecast">Soil level - forecast</h2><ul><li>All parameters are available at levels 1, 2</li></ul><table><thead><tr class="header"><th>SHORT NAME</th><th>ID</th><th>LONG NAME</th><th>UNITS</th><th>ADDITIONAL INFORMATION</th></tr></thead><tbody><tr class="odd"><td>vsw</td><td>260199</td><td>Volumetric soil moisture</td><td>m^3 m^-3</td><td></td></tr><tr class="even"><td>sot</td><td>260360</td><td>Soil temperature</td><td>K</td><td></td></tr></tbody></table><h1 id="rda.ucar-ecmwf-ifs-high-resolution-operational-forecasts">rda.ucar: ECMWF IFS High-Resolution Operational Forecasts</h1><h2 id="from-rda.ucar-not-use">From rda.ucar (Not use)</h2><ul><li><a href="https://rda.ucar.edu/datasets/d113001/#" class="uri">https://rda.ucar.edu/datasets/d113001/#</a><ul><li>ECMWF has implemented a significant resolution upgrade and methodology for high-resolution forecasts (HRES) and ensemble forecasts (ENS) beginning January of 2016. HRES is now performed via a transform grid with a nominal grid point spacing of 9 kilometers (0.08 degrees), and is carried out with IFS (Integrated Forecast System).</li><li><strong>ECMWF Operational 6-hourly atmospheric surface forecast</strong></li><li><strong>ECMWF Operational 6-hourly atmospheric isobaric analysis</strong></li></ul></li></ul><p><img src="https://i.imgur.com/GvUcfD5.png" width="400" /></p><h1 id="herbie">Herbie</h1><p><a href="https://waipangsze.github.io/2025/04/10/NWP-Herbie-Download-NWP-model-output-MPAS-WRF/"><strong>NWP | Herbie | Download NWP model output (grib2) | MPAS | WRF</strong></a></p><h1 id="download-script">Download script</h1><ul><li><code>wget [ROOT]/20240301/00z/ifs/0p25/oper/20240301060000-24h-oper-fc.grib2</code></li><li><code>wget [ROOT]/20240301/06z/ifs/0p25/scda/20240301060000-24h-scda-fc.grib2</code></li><li><code>wget [ROOT]/20240301/12z/ifs/0p25/wave/20240301060000-12h-wave-fc.grib2</code></li><li><code>wget [ROOT]/20240301/06z/ifs/0p25/scwv/20240301060000-18h-scwv-fc.grib2</code></li></ul><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-meta">#!/bin/sh</span><br><span class="hljs-comment">#################################################################</span><br><span class="hljs-comment"># https://data.ecmwf.int/forecasts/20241117/00z/ifs/0p25/oper/</span><br><span class="hljs-comment"># https://data.ecmwf.int/forecasts/20241117/00z/ifs/0p25/oper/20241117000000-114h-oper-fc.grib2</span><br><span class="hljs-comment">#################################################################</span><br><br>yyyy=<span class="hljs-string">&#x27;2024&#x27;</span><br>mm=<span class="hljs-string">&#x27;11&#x27;</span><br><span class="hljs-built_in">dd</span>=<span class="hljs-string">&#x27;17&#x27;</span><br>hh=<span class="hljs-string">&#x27;00&#x27;</span><br>yyyymm=<span class="hljs-variable">$&#123;yyyy&#125;</span><span class="hljs-variable">$&#123;mm&#125;</span><br>yyyymmddhh=<span class="hljs-variable">$&#123;yyyy&#125;</span><span class="hljs-variable">$&#123;mm&#125;</span><span class="hljs-variable">$&#123;dd&#125;</span><span class="hljs-variable">$&#123;hh&#125;</span><br><br>tmp_dir=<span class="hljs-string">&quot;<span class="hljs-variable">$&#123;yyyy&#125;</span><span class="hljs-variable">$&#123;mm&#125;</span>/<span class="hljs-variable">$&#123;yyyy&#125;</span><span class="hljs-variable">$&#123;mm&#125;</span><span class="hljs-variable">$&#123;dd&#125;</span>&quot;</span><br><span class="hljs-built_in">mkdir</span> -p <span class="hljs-variable">$&#123;tmp_dir&#125;</span><br><span class="hljs-built_in">cd</span> <span class="hljs-variable">$&#123;tmp_dir&#125;</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;Current <span class="hljs-variable">$&#123;tmp_dir&#125;</span>&quot;</span><br><br>limit_cpu_core=15<br>count_cpu_core=1<br><br><span class="hljs-keyword">for</span> ifsfile <span class="hljs-keyword">in</span> $(<span class="hljs-built_in">seq</span> 0 3 6); <span class="hljs-keyword">do</span> <span class="hljs-comment"># Forecast time = 12, 24, 36, 48, 60, 72, 84, 96, 108, 130, 142, 154</span><br><br>    tmp_ifs_fname=<span class="hljs-string">&quot;<span class="hljs-variable">$&#123;yyyymmddhh&#125;</span>0000-<span class="hljs-variable">$&#123;ifsfile&#125;</span>h-oper-fc.grib2&quot;</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;Now, <span class="hljs-variable">$&#123;tmp_ifs_fname&#125;</span> ... &quot;</span><br>    <br>    <span class="hljs-keyword">if</span> [[ ! -f <span class="hljs-string">&quot;<span class="hljs-variable">$&#123;tmp_ifs_fname&#125;</span>&quot;</span> ]]; <span class="hljs-keyword">then</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;Downloading ... <span class="hljs-variable">$&#123;tmp_ifs_fname&#125;</span>&quot;</span><br>wget --no-check-certificate https://data.ecmwf.int/forecasts/<span class="hljs-variable">$&#123;yyyy&#125;</span><span class="hljs-variable">$&#123;mm&#125;</span><span class="hljs-variable">$&#123;dd&#125;</span>/<span class="hljs-variable">$&#123;hh&#125;</span>z/ifs/0p25/oper/<span class="hljs-variable">$&#123;tmp_ifs_fname&#125;</span><br><span class="hljs-keyword">else</span><br>    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;<span class="hljs-variable">$&#123;tmp_ifs_fname&#125;</span> exists ... &quot;</span><br>    <span class="hljs-keyword">fi</span><br>    <br>res=$(( <span class="hljs-variable">$&#123;count_cpu_core&#125;</span> % <span class="hljs-variable">$&#123;limit_cpu_core&#125;</span> ))<br><span class="hljs-keyword">if</span> [[ <span class="hljs-variable">$&#123;res&#125;</span> == 0 ]]; <span class="hljs-keyword">then</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;please wait <span class="hljs-variable">$&#123;tmp_ifs_fname&#125;</span>, <span class="hljs-variable">$&#123;count_cpu_core&#125;</span>, <span class="hljs-variable">$&#123;res&#125;</span>.&quot;</span><br><span class="hljs-built_in">wait</span><br><span class="hljs-keyword">fi</span><br>    <br><span class="hljs-keyword">done</span><br></code></pre></td></tr></table></figure><p>read_grib2.py</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/bin/python</span><br><span class="hljs-keyword">import</span> pygrib<br><br>grib_file = <span class="hljs-string">&quot;/home/wpsze/IFS/202411/20241117/20241117000000-0h-oper-fc.grib2&quot;</span><br>grbs = pygrib.<span class="hljs-built_in">open</span>(grib_file)<br><span class="hljs-keyword">for</span> grb <span class="hljs-keyword">in</span> grbs:<br>    <span class="hljs-built_in">print</span>(grb) <span class="hljs-comment"># long list</span><br></code></pre></td></tr></table></figure><h1 id="run-as-icbc">Run as ICBC</h1><p>I recognised that the Vtable.ECMWF you have mentioned was not suitable for the IFS forecast data, due to the data form of the IFS was grib2. But the Vtable.ECMWF was for grib.</p><p><a href="https://github.com/wrf-model/WPS/blob/master/ungrib/Variable_Tables/Vtable.ECMWF" class="uri">https://github.com/wrf-model/WPS/blob/master/ungrib/Variable_Tables/Vtable.ECMWF</a></p><ul><li><a href="https://forum.mmm.ucar.edu/threads/ecmwf-open-data-0p25-grib2-vtable.16523/">ECMWF open data 0p25 grib2 Vtable?</a><ul><li>Do we have Vtable suitable for ungribbing this new dataset? <strong>https://data.ecmwf.int/forecasts/YYYYMMDD/00z/ifs/0p25/oper/</strong></li><li>I'm not sure if the existing Vtables (perhaps Vtable.ECMWF?) are suitable. If you'd like to test them out and let us know, that would be great! If they don't work, you can try contacting the input data support group to see if they are able to help. You can also use the utilities, such as g2print.exe and g1print.exe to look at the codes given in the new data type, which can help you to modify an existing Vtable. If you are able to find one that works, feel free to share it so that it may help other users who are trying to use these data.</li><li>Provided Vtable.ECMWF unfortunatelly doesn't work as it expects grib1 format. I tried to convert grib2 to grib1 with cnvgrib but it fails too. I hoped that someone already has new Vtable, but ok, it looks I will need to create new one using tools you mentioned. Thank you anyway. If I succeed I will post here working solution later.</li><li>if g2print cannot process this dataset, it implies that the ECPDS data cannot be recognized by WPS. You will have to explore this data, create Vtable for it, and I guess it may be necessary to modify codes like ungrib.F and rd_grib2.F, etc.</li></ul></li><li><a href="https://forum.mmm.ucar.edu/threads/error-while-running-ungrib-exe-with-ifs-global-data.14439/">Error while running ungrib.exe with IFS global data (not solved)</a><ul><li>I've downloaded the IFS analysis files from RDA ds113.1 dataset.</li><li><a href="https://rda.ucar.edu/datasets/d113001/dataaccess/#" class="uri">https://rda.ucar.edu/datasets/d113001/dataaccess/#</a></li></ul></li><li><a href="https://forum.mmm.ucar.edu/threads/initializing-wrf-with-global-ecmwf.11131/">Initializing WRF with Global ECMWF (not solved)</a><ul><li>It is not possible to initialize the WRF with only these data available from the ECMWF because some important variables are missing, such as more levels of temperature and soil moisture;</li></ul></li><li><a href="https://forum.ecmwf.int/t/wrf-vtable-for-ecmwf-10-days-open-data/1167/1">WRF Vtable for ECMWF 10-days open data (not solved)</a></li><li><a href="https://forum.ecmwf.int/t/vtable-required-for-ecmwf-10-days-open-data/4438/1">Vtable required for ECMWF 10-days open data (not solved)</a></li><li><a href="https://forum.mmm.ucar.edu/threads/ecmwf-open-data-0p25-enfo-grib2-vtable.19236/">ECMWF open data 0p25 enfo grib2 Vtable?</a></li><li><a href="https://forum.mmm.ucar.edu/threads/help-with-ungrib-exe-when-applied-to-ecmwf-data-at-t1279-resolution.14475/#post-37949">help with ungrib.exe when applied to ecmwf data at T1279 resolution</a></li><li><a href="https://forum.mmm.ucar.edu/threads/error-when-ungrib-exe-the-ecmwf-ifs-0p25-dataset-257.18725/">Error when ungrib.exe the ECMWF IFS 0p25 dataset #257</a><ul><li>I agree that the ECPDS data may have unique GRIB structure that WPS/ungrib cannot recognize.</li></ul></li></ul><h2 id="mpaswrf">MPAS/WRF</h2><h3 id="ungrib">ungrib</h3><p>Solution:</p><ul><li><a href="https://forum.mmm.ucar.edu/threads/using-newer-ecmwf-data.19307/">Using Newer ECMWF Data | kwerner | Sep 28, 2024</a><ul><li>The <strong>new EC grib2 data requires an additional step to convert from EC grib2 data to grib2 data WPS supports</strong>. The conversion can be done by using the convert command in the ecCodes library which is available from ECMWF. The conversion step follows the following format: <figure class="highlight console"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs console">grib_set -r -w packingType=grid_ccsds -s packingType=grid_simple input.grib2 output.grib2<br></code></pre></td></tr></table></figure></li><li>The <a href="https://github.com/wrf-model/WPS/blob/v4.6.0/ungrib/Variable_Tables/Vtable.ECMWF"><strong>updated Vtable.ECMWF in WPS v4.6</strong></a> should work with the converted grib2 data.</li><li>I think this could be related to CCSDS compression. You can change the packing type by using eccodes for instance.</li><li>Hi Everyone, <strong>One of the problems with the EC data is that it's not all standardized like GFS data</strong>. Depending on where/how the data are obtained, they can be different. We've found that, for e.g., for one user, ungrib is unable to recognize the soil fields. A possible solution for this is to use GFS soil data, in addition to the EC data. We expect the output to still be reasonable, especially because the WRF LSMs are more like that used by GFS. We hope to have a better solution for this issue in the future. For additional information, see this thread in our GitHub code repository (I believe one of you is the one who was having the discussion with my colleague).</li></ul></li></ul>    <div class="fold">      <div class="fold-title fold-info collapsed" data-toggle="collapse" href="#collapse-90469042" role="button" aria-expanded="false" aria-controls="collapse-90469042">        <div class="fold-arrow">▶</div>Vtable.ECMWF      </div>      <div class="fold-collapse collapse" id="collapse-90469042">        <div class="fold-content">          <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs Vtable.ECMWF">GRIB1| Level| From |  To  | metgrid  | metgrid  | metgrid                                  |GRIB2|GRIB2|GRIB2|GRIB2|<br>Param| Type |Level1|Level2| Name     | Units    | Description                              |Discp|Catgy|Param|Level|<br>-----+------+------+------+----------+----------+------------------------------------------+-----------------------+<br> 129 | 100  |   *  |      | GEOPT    | m2 s-2   |                                          |  0  |  0  |     | 100 |<br> 156 | 100  |   *  |      | HGT      | m        | Height                                   |  0  |  3  |  5  | 100 |  <br> 130 | 100  |   *  |      | TT       | K        | Temperature                              |  0  |  0  |  0  | 100 |<br> 131 | 100  |   *  |      | UU       | m s-1    | U                                        |  0  |  2  |  2  | 100 |<br> 132 | 100  |   *  |      | VV       | m s-1    | V                                        |  0  |  2  |  3  | 100 |<br> 157 | 100  |   *  |      | RH       | %        | Relative Humidity                        |  0  |  1  |  1  | 100 |<br> 165 |  1   |   0  |      | UU       | m s-1    | U                    At 10 m             |  0  |  2  |  2  | 103 | <br> 166 |  1   |   0  |      | VV       | m s-1    | V                    At 10 m             |  0  |  2  |  3  | 103 | <br> 167 |  1   |   0  |      | TT       | K        | Temperature          At  2 m             |  0  |  0  |  0  | 103 |<br> 168 |  1   |   0  |      | DEWPT    | K        |                                          |  0  |  0  |  6  | 103 |<br>     |  1   |   0  |      | RH       | %        | Relative Humidity    At  2 m             |  0  |  0  |     | 103 | <br> 172 |  1   |   0  |      | LANDSEA  | 0/1 Flag | Land/Sea flag                            |  2  |  0  |  0  |  1  | <br> 129 |  1   |   0  |      | SOILGEO  | m2 s-2   |                                          |  0  |  0  |     | 103 | <br> 156 |  1   |   0  |      | SOILHGT  | m        | Terrain field of source analysis         |  0  |  0  |     | 106 | <br> 134 |  1   |   0  |      | PSFC     | Pa       | Surface Pressure                         |  0  |  3  |  0  |  1  |<br> 151 |  1   |   0  |      | PMSL     | Pa       | Sea-level Pressure                       |  0  |  3  |  0  | 101 |<br> 235 |  1   |   0  |      | SKINTEMP | K        | Sea-Surface Temperature                  |  0  |  3  |     | 101 |<br>  31 |  1   |   0  |      | SEAICE   | 0/1 Flag | Sea-Ice-Flag                             |  0  |  3  |     | 101 |<br>  34 |  1   |   0  |      | SST      | K        | Sea-Surface Temperature                  |  0  |  3  |     | 101 |<br> 141 |  1   |   0  |      | SNOW_EC  | m        |                                          |  0  |  3  |     | 101 |<br>     |  1   |   0  |      | SNOW     | kg m-2   |Water Equivalent of Accumulated Snow Depth|  0  |  3  |     | 101 |<br> 139 | 112  |   0  |   7  | ST000007 | K        | T of 0-7 cm ground layer                 |  2  |  0  |  2  | 106 | <br> 170 | 112  |   7  |  28  | ST007028 | K        | T of 7-28 cm ground layer                | 192 | 128 | 170 | 106 | <br> 183 | 112  |  28  | 100  | ST028100 | K        | T of 28-100 cm ground layer              | 192 | 128 | 183 | 106 | <br> 236 | 112  | 100  | 255  | ST100289 | K        | T of 100-289 cm ground layer             | 192 | 128 | 236 | 106 | <br>  39 | 112  |   0  |   7  | SM000007 | fraction | Soil moisture of 0-7 cm ground layer     | 192 | 128 | 39  | 106 | <br>  40 | 112  |   7  |  28  | SM007028 | fraction | Soil moisture of 7-28 cm ground layer    | 192 | 128 | 40  | 106 | <br>  41 | 112  |  28  | 100  | SM028100 | fraction | Soil moisture of 28-100 cm ground layer  | 192 | 128 | 41  | 106 | <br>  42 | 112  | 100  | 255  | SM100289 | fraction | Soil moisture of 100-289 cm ground layer | 192 | 128 | 42  | 106 | <br>-----+------+------+------+----------+----------+------------------------------------------+-----+-----+-----+-----+<br>#<br>#  Grib codes are from Table 128 <br>#  http://old.ecmwf.int/publications/manuals/d/gribapi/param/filter=grib1/order=paramId/order_type=asc/p=1/table=128/<br>#  <br>#  snow depth is converted to the proper units in rrpr.F<br>#<br>#  Tested on NCAR/RDA ds113.0 dataset. http://rda.ucar.edu/datasets/ds113.0/<br>#  Note that for ds113.0 there is one surface data file per day and 4 pressure-level files per day.<br></code></pre></td></tr></table></figure>        </div>      </div>    </div><ul><li><a href="https://github.com/wrf-model/WPS/issues/263">Vtable error of ECMWF,pls update it | Oct 13, 2024</a><ul><li>Surface data including soil data may come from grib 1 data. You may need to use eccodes to separate out grib 2 and grib 1 data first before running ungrib. We are not supporting the new enfo data yet. Please post further issue on the Forum.</li><li>they are <strong>loss soil data</strong>.</li><li><strong>It looks like the grib code for soil data has been messed up somehow</strong>. For the time being, <strong>you can try to use GFS soil data together with the EC atmospheric data. If you need help doing so, try reading the WPS section of the User's Guide</strong>.</li><li>Please read carefully this section of the <a href="https://www2.mmm.ucar.edu/wrf/users/wrf_users_guide/build/html/wps.html#using-multiple-meteorological-data-sources">User's Guide for using combined datasets</a>.</li></ul></li><li><a href="https://forum.mmm.ucar.edu/threads/change-in-soil-variables-from-ecmwf-cycle-49r1.19864/#post-48546">Change in soil variables from ECMWF Cycle 49r1 | Nov 14, 2024</a><ul><li>On <strong>Tuesday (November 12), ECMWF released the 49r1 version of the operational IFS</strong>. Despite all the improvements, they modified the soil variables (temperature and humidity) which stopped the ECMWF Vtable that had been released in the 4.6.0 version of the WPS.</li><li><strong>WPS still can't find the soil temperature and moisture variables</strong>.</li><li>I contacted the ECMWF team and they gave me this feedback. <strong>It is necessary to make a change within Ungrib</strong>, more specifically in the rd_grib2.F code so that it works with the <strong>new IFS soil variables</strong>.</li><li><em>[Jan 3, 2025]</em> Please take a look at <a href="https://github.com/wrf-model/WPS/pull/266">this document-Change in soil variables from ECMWF Cycle 49r1</a> , which fixes the issues related to the ECMWF 49r1 version of the operational IFS. ECMWF 49r1 is newly released and we haven't done sufficient tests to make sure it works fine for WRF. Please post any issues you may have, which will be helpful for us to implement this data for WRF modeling study. Thanks in advance.</li><li><em>[Jan 4, 2025]</em> Please <strong>download</strong> the <strong>modified code "rd_grib2.F"</strong> from the website update <a href="https://github.com/wrf-model/WPS/pull/266">era5/ifs soil field processing by jimbresch · Pull Request #266 · wrf-model/WPS</a>, <strong>recompile WPS, then rerun ungrib.exe</strong>.</li><li>IFS operational model data in the ECMWF open data repository are <strong>only available for the last 4 days.</strong></li><li><em>[Jan 15, 2025]</em> As requested, I am providing the corrected rd_grib2F file for WPS 4.5 and my Vtable.ECMWF_GRIB2 file. For the new WPS 4.6 version, I have not yet prepared a correction for the IFS model.</li><li><em>[Jan 16, 2025]</em> <strong>I run WPS using your rd_grib2.F and Vtable. All work fine</strong>. Thank you! The met-em file I generated only has 14 pressure levels in the vertical, --- is this what you got?</li><li><em>[Jan 16, 2025]</em> Yes, <strong>the IFS model provided by ECMWF has only 14 pressure levels</strong>. I made a simulation with the operational IFS model at 137 hybrid levels, which we have access to at the Institute of Meteorology and Water Management. The results are similar to the results from the IFS model, which is provided as open data. This is good news.</li><li><em>[14 Jan, 2025]</em> I have <strong>already tested this Vtable.ECMWF with the new operational IFS data and it doesn't work either</strong>. I reported this here.</li></ul></li></ul><div class="note note-primary">            <p><strong>recompile WPS, then rerun ungrib.exe</strong></p>          </div><ul><li>under <code>WPS-4.6.0/ungrib/src</code>,</li></ul>    <div class="fold">      <div class="fold-title fold-info collapsed" data-toggle="collapse" href="#collapse-738764b7" role="button" aria-expanded="false" aria-controls="collapse-738764b7">        <div class="fold-arrow">▶</div>rd_grib2.F      </div>      <div class="fold-collapse collapse" id="collapse-738764b7">        <div class="fold-content">          <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br><span class="line">635</span><br><span class="line">636</span><br><span class="line">637</span><br><span class="line">638</span><br><span class="line">639</span><br><span class="line">640</span><br><span class="line">641</span><br><span class="line">642</span><br><span class="line">643</span><br><span class="line">644</span><br><span class="line">645</span><br><span class="line">646</span><br><span class="line">647</span><br><span class="line">648</span><br><span class="line">649</span><br><span class="line">650</span><br><span class="line">651</span><br><span class="line">652</span><br><span class="line">653</span><br><span class="line">654</span><br><span class="line">655</span><br><span class="line">656</span><br><span class="line">657</span><br><span class="line">658</span><br><span class="line">659</span><br><span class="line">660</span><br><span class="line">661</span><br><span class="line">662</span><br><span class="line">663</span><br><span class="line">664</span><br><span class="line">665</span><br><span class="line">666</span><br><span class="line">667</span><br><span class="line">668</span><br><span class="line">669</span><br><span class="line">670</span><br><span class="line">671</span><br><span class="line">672</span><br><span class="line">673</span><br><span class="line">674</span><br><span class="line">675</span><br><span class="line">676</span><br><span class="line">677</span><br><span class="line">678</span><br><span class="line">679</span><br><span class="line">680</span><br><span class="line">681</span><br><span class="line">682</span><br><span class="line">683</span><br><span class="line">684</span><br><span class="line">685</span><br><span class="line">686</span><br><span class="line">687</span><br><span class="line">688</span><br><span class="line">689</span><br><span class="line">690</span><br><span class="line">691</span><br><span class="line">692</span><br><span class="line">693</span><br><span class="line">694</span><br><span class="line">695</span><br><span class="line">696</span><br><span class="line">697</span><br><span class="line">698</span><br><span class="line">699</span><br><span class="line">700</span><br><span class="line">701</span><br><span class="line">702</span><br><span class="line">703</span><br><span class="line">704</span><br><span class="line">705</span><br><span class="line">706</span><br><span class="line">707</span><br><span class="line">708</span><br><span class="line">709</span><br><span class="line">710</span><br><span class="line">711</span><br><span class="line">712</span><br><span class="line">713</span><br><span class="line">714</span><br><span class="line">715</span><br><span class="line">716</span><br><span class="line">717</span><br><span class="line">718</span><br><span class="line">719</span><br><span class="line">720</span><br><span class="line">721</span><br><span class="line">722</span><br><span class="line">723</span><br><span class="line">724</span><br><span class="line">725</span><br><span class="line">726</span><br><span class="line">727</span><br><span class="line">728</span><br><span class="line">729</span><br><span class="line">730</span><br><span class="line">731</span><br><span class="line">732</span><br><span class="line">733</span><br><span class="line">734</span><br><span class="line">735</span><br><span class="line">736</span><br><span class="line">737</span><br><span class="line">738</span><br><span class="line">739</span><br><span class="line">740</span><br><span class="line">741</span><br><span class="line">742</span><br><span class="line">743</span><br><span class="line">744</span><br><span class="line">745</span><br><span class="line">746</span><br><span class="line">747</span><br><span class="line">748</span><br><span class="line">749</span><br><span class="line">750</span><br><span class="line">751</span><br><span class="line">752</span><br><span class="line">753</span><br><span class="line">754</span><br><span class="line">755</span><br><span class="line">756</span><br><span class="line">757</span><br><span class="line">758</span><br><span class="line">759</span><br><span class="line">760</span><br><span class="line">761</span><br><span class="line">762</span><br><span class="line">763</span><br><span class="line">764</span><br><span class="line">765</span><br><span class="line">766</span><br><span class="line">767</span><br><span class="line">768</span><br><span class="line">769</span><br><span class="line">770</span><br><span class="line">771</span><br><span class="line">772</span><br><span class="line">773</span><br><span class="line">774</span><br><span class="line">775</span><br><span class="line">776</span><br><span class="line">777</span><br><span class="line">778</span><br><span class="line">779</span><br><span class="line">780</span><br><span class="line">781</span><br><span class="line">782</span><br><span class="line">783</span><br><span class="line">784</span><br><span class="line">785</span><br><span class="line">786</span><br><span class="line">787</span><br><span class="line">788</span><br><span class="line">789</span><br><span class="line">790</span><br><span class="line">791</span><br><span class="line">792</span><br><span class="line">793</span><br><span class="line">794</span><br><span class="line">795</span><br><span class="line">796</span><br><span class="line">797</span><br><span class="line">798</span><br><span class="line">799</span><br><span class="line">800</span><br><span class="line">801</span><br><span class="line">802</span><br><span class="line">803</span><br><span class="line">804</span><br><span class="line">805</span><br><span class="line">806</span><br><span class="line">807</span><br><span class="line">808</span><br><span class="line">809</span><br><span class="line">810</span><br><span class="line">811</span><br><span class="line">812</span><br><span class="line">813</span><br><span class="line">814</span><br><span class="line">815</span><br><span class="line">816</span><br><span class="line">817</span><br><span class="line">818</span><br><span class="line">819</span><br><span class="line">820</span><br><span class="line">821</span><br><span class="line">822</span><br><span class="line">823</span><br><span class="line">824</span><br><span class="line">825</span><br><span class="line">826</span><br><span class="line">827</span><br><span class="line">828</span><br><span class="line">829</span><br><span class="line">830</span><br><span class="line">831</span><br><span class="line">832</span><br><span class="line">833</span><br><span class="line">834</span><br><span class="line">835</span><br><span class="line">836</span><br><span class="line">837</span><br><span class="line">838</span><br><span class="line">839</span><br><span class="line">840</span><br><span class="line">841</span><br><span class="line">842</span><br><span class="line">843</span><br><span class="line">844</span><br><span class="line">845</span><br><span class="line">846</span><br><span class="line">847</span><br><span class="line">848</span><br><span class="line">849</span><br><span class="line">850</span><br><span class="line">851</span><br><span class="line">852</span><br><span class="line">853</span><br><span class="line">854</span><br><span class="line">855</span><br><span class="line">856</span><br><span class="line">857</span><br><span class="line">858</span><br><span class="line">859</span><br><span class="line">860</span><br><span class="line">861</span><br><span class="line">862</span><br><span class="line">863</span><br><span class="line">864</span><br><span class="line">865</span><br><span class="line">866</span><br><span class="line">867</span><br><span class="line">868</span><br><span class="line">869</span><br><span class="line">870</span><br><span class="line">871</span><br><span class="line">872</span><br><span class="line">873</span><br><span class="line">874</span><br><span class="line">875</span><br><span class="line">876</span><br><span class="line">877</span><br><span class="line">878</span><br><span class="line">879</span><br><span class="line">880</span><br><span class="line">881</span><br><span class="line">882</span><br><span class="line">883</span><br><span class="line">884</span><br><span class="line">885</span><br><span class="line">886</span><br><span class="line">887</span><br><span class="line">888</span><br><span class="line">889</span><br><span class="line">890</span><br><span class="line">891</span><br><span class="line">892</span><br><span class="line">893</span><br><span class="line">894</span><br><span class="line">895</span><br><span class="line">896</span><br><span class="line">897</span><br><span class="line">898</span><br><span class="line">899</span><br><span class="line">900</span><br><span class="line">901</span><br><span class="line">902</span><br><span class="line">903</span><br><span class="line">904</span><br><span class="line">905</span><br><span class="line">906</span><br><span class="line">907</span><br><span class="line">908</span><br><span class="line">909</span><br><span class="line">910</span><br><span class="line">911</span><br><span class="line">912</span><br><span class="line">913</span><br><span class="line">914</span><br><span class="line">915</span><br><span class="line">916</span><br><span class="line">917</span><br><span class="line">918</span><br><span class="line">919</span><br><span class="line">920</span><br><span class="line">921</span><br><span class="line">922</span><br><span class="line">923</span><br><span class="line">924</span><br><span class="line">925</span><br><span class="line">926</span><br><span class="line">927</span><br><span class="line">928</span><br><span class="line">929</span><br><span class="line">930</span><br><span class="line">931</span><br><span class="line">932</span><br><span class="line">933</span><br><span class="line">934</span><br><span class="line">935</span><br><span class="line">936</span><br><span class="line">937</span><br><span class="line">938</span><br><span class="line">939</span><br><span class="line">940</span><br><span class="line">941</span><br><span class="line">942</span><br><span class="line">943</span><br><span class="line">944</span><br><span class="line">945</span><br><span class="line">946</span><br><span class="line">947</span><br><span class="line">948</span><br><span class="line">949</span><br><span class="line">950</span><br><span class="line">951</span><br><span class="line">952</span><br><span class="line">953</span><br><span class="line">954</span><br><span class="line">955</span><br><span class="line">956</span><br><span class="line">957</span><br><span class="line">958</span><br><span class="line">959</span><br><span class="line">960</span><br><span class="line">961</span><br><span class="line">962</span><br><span class="line">963</span><br><span class="line">964</span><br><span class="line">965</span><br><span class="line">966</span><br><span class="line">967</span><br><span class="line">968</span><br><span class="line">969</span><br><span class="line">970</span><br><span class="line">971</span><br><span class="line">972</span><br><span class="line">973</span><br><span class="line">974</span><br><span class="line">975</span><br><span class="line">976</span><br><span class="line">977</span><br><span class="line">978</span><br><span class="line">979</span><br><span class="line">980</span><br><span class="line">981</span><br><span class="line">982</span><br><span class="line">983</span><br><span class="line">984</span><br><span class="line">985</span><br><span class="line">986</span><br><span class="line">987</span><br><span class="line">988</span><br><span class="line">989</span><br><span class="line">990</span><br><span class="line">991</span><br><span class="line">992</span><br><span class="line">993</span><br><span class="line">994</span><br><span class="line">995</span><br><span class="line">996</span><br><span class="line">997</span><br><span class="line">998</span><br><span class="line">999</span><br><span class="line">1000</span><br><span class="line">1001</span><br><span class="line">1002</span><br><span class="line">1003</span><br><span class="line">1004</span><br><span class="line">1005</span><br><span class="line">1006</span><br><span class="line">1007</span><br><span class="line">1008</span><br><span class="line">1009</span><br><span class="line">1010</span><br><span class="line">1011</span><br><span class="line">1012</span><br><span class="line">1013</span><br><span class="line">1014</span><br><span class="line">1015</span><br><span class="line">1016</span><br><span class="line">1017</span><br><span class="line">1018</span><br><span class="line">1019</span><br><span class="line">1020</span><br><span class="line">1021</span><br><span class="line">1022</span><br><span class="line">1023</span><br><span class="line">1024</span><br><span class="line">1025</span><br><span class="line">1026</span><br><span class="line">1027</span><br><span class="line">1028</span><br><span class="line">1029</span><br><span class="line">1030</span><br><span class="line">1031</span><br><span class="line">1032</span><br><span class="line">1033</span><br><span class="line">1034</span><br><span class="line">1035</span><br><span class="line">1036</span><br><span class="line">1037</span><br><span class="line">1038</span><br><span class="line">1039</span><br><span class="line">1040</span><br><span class="line">1041</span><br><span class="line">1042</span><br><span class="line">1043</span><br><span class="line">1044</span><br><span class="line">1045</span><br><span class="line">1046</span><br><span class="line">1047</span><br><span class="line">1048</span><br><span class="line">1049</span><br><span class="line">1050</span><br><span class="line">1051</span><br><span class="line">1052</span><br><span class="line">1053</span><br><span class="line">1054</span><br><span class="line">1055</span><br><span class="line">1056</span><br><span class="line">1057</span><br><span class="line">1058</span><br><span class="line">1059</span><br><span class="line">1060</span><br><span class="line">1061</span><br><span class="line">1062</span><br><span class="line">1063</span><br><span class="line">1064</span><br><span class="line">1065</span><br><span class="line">1066</span><br><span class="line">1067</span><br><span class="line">1068</span><br><span class="line">1069</span><br><span class="line">1070</span><br><span class="line">1071</span><br><span class="line">1072</span><br><span class="line">1073</span><br><span class="line">1074</span><br><span class="line">1075</span><br><span class="line">1076</span><br><span class="line">1077</span><br><span class="line">1078</span><br><span class="line">1079</span><br><span class="line">1080</span><br><span class="line">1081</span><br><span class="line">1082</span><br><span class="line">1083</span><br><span class="line">1084</span><br><span class="line">1085</span><br><span class="line">1086</span><br><span class="line">1087</span><br><span class="line">1088</span><br><span class="line">1089</span><br><span class="line">1090</span><br><span class="line">1091</span><br><span class="line">1092</span><br><span class="line">1093</span><br><span class="line">1094</span><br><span class="line">1095</span><br><span class="line">1096</span><br><span class="line">1097</span><br><span class="line">1098</span><br><span class="line">1099</span><br><span class="line">1100</span><br><span class="line">1101</span><br><span class="line">1102</span><br><span class="line">1103</span><br><span class="line">1104</span><br><span class="line">1105</span><br><span class="line">1106</span><br><span class="line">1107</span><br><span class="line">1108</span><br><span class="line">1109</span><br><span class="line">1110</span><br><span class="line">1111</span><br><span class="line">1112</span><br><span class="line">1113</span><br><span class="line">1114</span><br><span class="line">1115</span><br><span class="line">1116</span><br><span class="line">1117</span><br><span class="line">1118</span><br><span class="line">1119</span><br><span class="line">1120</span><br><span class="line">1121</span><br><span class="line">1122</span><br><span class="line">1123</span><br><span class="line">1124</span><br><span class="line">1125</span><br><span class="line">1126</span><br><span class="line">1127</span><br><span class="line">1128</span><br><span class="line">1129</span><br><span class="line">1130</span><br><span class="line">1131</span><br><span class="line">1132</span><br><span class="line">1133</span><br><span class="line">1134</span><br><span class="line">1135</span><br><span class="line">1136</span><br><span class="line">1137</span><br><span class="line">1138</span><br><span class="line">1139</span><br><span class="line">1140</span><br><span class="line">1141</span><br><span class="line">1142</span><br><span class="line">1143</span><br><span class="line">1144</span><br><span class="line">1145</span><br><span class="line">1146</span><br><span class="line">1147</span><br><span class="line">1148</span><br><span class="line">1149</span><br><span class="line">1150</span><br><span class="line">1151</span><br><span class="line">1152</span><br><span class="line">1153</span><br><span class="line">1154</span><br><span class="line">1155</span><br><span class="line">1156</span><br><span class="line">1157</span><br><span class="line">1158</span><br><span class="line">1159</span><br><span class="line">1160</span><br><span class="line">1161</span><br><span class="line">1162</span><br><span class="line">1163</span><br><span class="line">1164</span><br><span class="line">1165</span><br><span class="line">1166</span><br><span class="line">1167</span><br><span class="line">1168</span><br><span class="line">1169</span><br><span class="line">1170</span><br><span class="line">1171</span><br><span class="line">1172</span><br><span class="line">1173</span><br><span class="line">1174</span><br><span class="line">1175</span><br><span class="line">1176</span><br><span class="line">1177</span><br><span class="line">1178</span><br><span class="line">1179</span><br><span class="line">1180</span><br><span class="line">1181</span><br><span class="line">1182</span><br><span class="line">1183</span><br><span class="line">1184</span><br><span class="line">1185</span><br><span class="line">1186</span><br><span class="line">1187</span><br><span class="line">1188</span><br><span class="line">1189</span><br><span class="line">1190</span><br><span class="line">1191</span><br><span class="line">1192</span><br><span class="line">1193</span><br><span class="line">1194</span><br><span class="line">1195</span><br><span class="line">1196</span><br><span class="line">1197</span><br><span class="line">1198</span><br><span class="line">1199</span><br><span class="line">1200</span><br><span class="line">1201</span><br><span class="line">1202</span><br><span class="line">1203</span><br><span class="line">1204</span><br><span class="line">1205</span><br><span class="line">1206</span><br><span class="line">1207</span><br><span class="line">1208</span><br><span class="line">1209</span><br><span class="line">1210</span><br><span class="line">1211</span><br><span class="line">1212</span><br><span class="line">1213</span><br><span class="line">1214</span><br><span class="line">1215</span><br><span class="line">1216</span><br><span class="line">1217</span><br><span class="line">1218</span><br><span class="line">1219</span><br><span class="line">1220</span><br><span class="line">1221</span><br><span class="line">1222</span><br><span class="line">1223</span><br><span class="line">1224</span><br><span class="line">1225</span><br><span class="line">1226</span><br><span class="line">1227</span><br><span class="line">1228</span><br><span class="line">1229</span><br><span class="line">1230</span><br><span class="line">1231</span><br><span class="line">1232</span><br><span class="line">1233</span><br><span class="line">1234</span><br><span class="line">1235</span><br><span class="line">1236</span><br><span class="line">1237</span><br><span class="line">1238</span><br><span class="line">1239</span><br><span class="line">1240</span><br><span class="line">1241</span><br><span class="line">1242</span><br><span class="line">1243</span><br><span class="line">1244</span><br><span class="line">1245</span><br></pre></td><td class="code"><pre><code class="hljs rd_grib2.F">*****************************************************************************!<br>! Subroutine RD_GRIB2                                                         !<br>!                                                                             !<br>! Purpose:                                                                    !<br>!    Read one record from the input GRIB2 file.  Based on the information in  !<br>!    the GRIB2 header and the user-defined Vtable, decide whether the field in!<br>!    the GRIB2 record is one to process or to skip.  If the field is one we   !<br>!    want to keep, extract the data from the GRIB2 record, and store the data !<br>!    in the ungrib memory structure.                                          !<br>!                                                                             !<br>! Argument list:                                                              !<br>!    Input:                                                                   !<br>!       junit   : &quot;Unit Number&quot; to open and read from.  Not really a Fortran  !<br>!                 unit number, since we do not do Fortran I/O for the GRIB2   !<br>!                 files.  Nor is it a UNIX File Descriptor returned from a C  !<br>!                 OPEN statement.  It is really just an array index to the    !<br>!                 array (IUARR) where the UNIX File Descriptor values are     !<br>!                 stored.                                                     !<br>!       gribflnm     : File name to open, if it is not already open.          !<br>!       debug_level  : Integer for various amounts of printout.               !<br>!       pmin         : Minimum pressure level (Pa) to process.                !<br>!                                                                             !<br>!    Output:                                                                  !<br>!                                                                             !<br>!       hdate        : The (up to)19-character date of the field to process.  !<br>!       grib_edition : Version of the gribfile (1 or 2)                       !<br>!       ireaderr     : Error flag: 0 - no error on read from GRIB2 file.      !<br>!                              1 - Hit the end of the GRIB2 file.             !<br>!                              2 - The file GRIBFLNM we tried to open does    !<br>!                                  not exist.                                 !<br>!                                                                             !<br>!                                                                             !<br>! Author: Paula McCaslin, NOAA/FSL,   Sept 2004                               !<br>! Code is based on code developed by Steve Gilbert NCEP &amp; Kevin Manning NCAR  !<br>! Adapted for WPS: Jim Bresch, NCAR/MMM. Sept 2006                            !<br>!*****************************************************************************!<br>      <br>      SUBROUTINE rd_grib2(junit, gribflnm, hdate, <br>     &amp;  grib_edition, ireaderr, debug_level, pmin)<br><br>      use grib_mod<br>      use params<br>      use table          ! Included to define g2code<br>      use gridinfo       ! Included to define map%<br>      use storage_module ! Included sub put_storage<br>      use module_debug<br><br>      real, allocatable, dimension(:) :: hold_array<br>      parameter(msk1=32000,msk2=4000)<br>      character(len=1),allocatable,dimension(:) :: cgrib<br>      integer :: listsec0(3)<br>      integer :: listsec1(13)<br>      integer year, month, day, hour, minute, second, fcst<br>      character(len=*)  :: gribflnm<br>      character(len=*)  :: hdate<br>      character(len=8)  :: pabbrev<br>      character(len=20) :: labbrev<br>      character(len=80) :: tabbrev<br>      integer :: lskip, lgrib<br>      integer :: junit, itot, icount, iseek<br>      integer :: grib_edition<br>      integer :: i, j, ireaderr, ith , debug_level<br>      integer :: currlen<br>      logical :: unpack, expand<br>      type(gribfield) :: gfld<br>      ! For subroutine put_storage<br>      real :: level<br>      real :: scale_factor<br>      integer :: iplvl<br>      character (len=9) :: my_field<br>      character (len=8) :: tmp8<br>      ! For subroutine output<br>      integer , parameter :: maxlvl = 150<br>      real , dimension(maxlvl) :: plvl<br>      integer :: nlvl<br>      integer , dimension(maxlvl) :: level_array<br>      real :: glevel1, glevel2<br>      logical :: first = .true.<br>      real :: pmin<br><br>C - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -<br>C  SET ARGUMENTS<br><br>      unpack=.true.<br>      expand=.true.<br>      hdate = &#x27;0000-00-00_00:00:00&#x27;<br>      ierr=0<br>      itot=0<br>      icount=0<br>      iseek=0<br>      lskip=0<br>      lgrib=0<br>      currlen=0<br>      ith=1<br>      scale_factor = 1e6<br>      call mprintf(.true.,DEBUG,&quot;Begin rd_grib2&quot;, newline=.true.)<br><br>!/* IOS Return Codes from BACIO:  */<br>!/*  0    All was well                                   */<br>!/* -1    Tried to open read only _and_ write only       */<br>!/* -2    Tried to read and write in the same call       */<br>!/* -3    Internal failure in name processing            */<br>!/* -4    Failure in opening file                        */<br>!/* -5    Tried to read on a write-only file             */<br>!/* -6    Failed in read to find the &#x27;start&#x27; location    */<br>!/* -7    Tried to write to a read only file             */<br>!/* -8    Failed in write to find the &#x27;start&#x27; location   */<br>!/* -9    Error in close                                 */<br>!/* -10   Read or wrote fewer data than requested        */<br><br>!if ireaderr =1 we have hit the end of a file. <br>!if ireaderr =2 we have hit the end of all the files. <br> <br><br>      ! Open a byte-addressable file.<br>      CALL BAOPENR(junit,gribflnm,IOS)<br>      first = .true.<br>      if (ios.eq.0) then <br>      VERSION: do<br><br>         ! Search opend file for the next GRIB2 messege (record).<br>         call skgb(junit,iseek,msk1,lskip,lgrib)<br><br>         ! Check for EOF, or problem<br>         if (lgrib.eq.0) then<br>            exit <br>         endif<br><br>         ! Check size, if needed allocate more memory.<br>         if (lgrib.gt.currlen) then<br>            if (allocated(cgrib)) deallocate(cgrib)<br>            allocate(cgrib(lgrib),stat=is)<br>            !print *,&#x27;G2 allocate(cgrib(lgrib)) status: &#x27;,IS<br>            currlen=lgrib<br>         endif<br><br>         ! Read a given number of bytes from unblocked file.<br>         call baread(junit,lskip,lgrib,lengrib,cgrib)<br><br>         call mprintf ((lgrib.ne.lengrib),ERROR,<br>     &amp;    &quot;rd_grib2: IO Error. %i .ne. %i &quot;, newline=.true.,<br>     &amp;    i1=lgrib,i2=lengrib)<br><br>         iseek=lskip+lgrib<br>         icount=icount+1<br><br>         call mprintf (.true.,DEBUG,<br>     &amp;     &quot;G2 GRIB MESSAGE  %i starts at %i &quot;, newline=.true.,<br>     &amp;      i1=icount,i2=lskip+1)<br><br>         ! Unpack GRIB2 field<br>         call gb_info(cgrib,lengrib,listsec0,listsec1,<br>     &amp;                numfields,numlocal,maxlocal,ierr)<br>         call mprintf((ierr.ne.0),ERROR,<br>     &amp;     &quot; ERROR querying GRIB2 message = %i&quot;,newline=.true.,i1=ierr)<br>         itot=itot+numfields<br><br>         grib_edition=listsec0(2)<br>         if (grib_edition.ne.2) then<br>              exit VERSION<br>         endif<br>         <br>         ! Additional print statments for developer.<br>!MGD         if ( debug_level .GT. 100 ) then<br>!MGD     print *,&#x27;G2 SECTION 0: &#x27;,(listsec0(j),j=1,3)<br>!MGD         print *,&#x27;G2 SECTION 1: &#x27;,(listsec1(j),j=1,13)<br>!MGD         print *,&#x27;G2 Contains &#x27;,numlocal,&#x27; Local Sections &#x27;,<br>!MGD     &amp;           &#x27; and &#x27;,numfields,&#x27; data fields.&#x27;<br>!MGD         endif<br><br><br>         ! ----<br>         ! Once per file fill in date, model and projection values.<br><br>         if (first) then <br>           first = .false.<br><br>           ! Build the 19-character date string, based on GRIB2 header date<br>           ! and time information, including forecast time information:<br><br>           n=1<br>           call gf_getfld(cgrib,lengrib,n,.FALSE.,expand,gfld,ierr)<br><br><br>           year  =gfld%idsect(6)     !(FOUR-DIGIT) YEAR OF THE DATA<br>           month =gfld%idsect(7)     ! MONTH OF THE DATA<br>           day   =gfld%idsect(8)     ! DAY OF THE DATA<br>           hour  =gfld%idsect(9)     ! HOUR OF THE DATA<br>           minute=gfld%idsect(10)    ! MINUTE OF THE DATA<br>           second=gfld%idsect(11)    ! SECOND OF THE DATA<br><br>           fcst = 0<br><br>! Extract forecast time. Assume the first field&#x27;s valid time is true for all fields.<br>! This doesn&#x27;t have to be true, but ungrib is designed to decode one time-level at<br>! a time.<br><br>           if ( gfld%ipdtnum .ne. 8 ) then<br>     if ( gfld%ipdtmpl(8) .eq. 1 ) then       ! time units are hours<br>       fcst = gfld%ipdtmpl(9)<br>     else if ( gfld%ipdtmpl(8) .eq. 0 ) then  ! minutes<br>       fcst = gfld%ipdtmpl(9) / 60.<br>     else if ( gfld%ipdtmpl(8) .eq. 2 ) then  ! days<br>       fcst = gfld%ipdtmpl(9) * 24.<br>     else<br>               call mprintf(.true.,ERROR,<br>     &amp;           &quot;Time unit in ipdtmpl(8), %i is not suported&quot;,<br>     &amp;            newline=.true.,i1=gfld%ipdtmpl(8))<br>     endif<br>   else<br>!  pdt 4.8 data are time-averaged, accumulated, or min/max fields with the <br>!  ending (valid) time provided. <br>     year  =gfld%ipdtmpl(16) <br>     month =gfld%ipdtmpl(17)<br>     day   =gfld%ipdtmpl(18)<br>     hour  =gfld%ipdtmpl(19)<br>     minute=gfld%ipdtmpl(20) <br>     second=gfld%ipdtmpl(21) <br>     fcst = 0.<br>   endif<br><br>           if ( gfld%idsect(5) .eq. 2 ) fcst = 0.<br>           ! Compute valid time.<br><br>           !print *, &#x27;ymd&#x27;,gfld%idsect(6),gfld%idsect(7),gfld%idsect(8)<br>           !print *, &#x27;hhmm  &#x27;,gfld%idsect(9),gfld%idsect(10)<br>   <br>           call build_hdate(hdate,year,month,day,hour,minute,second)<br>           call mprintf(.true.,DEBUG,&quot;G2 hdate = %s &quot;, newline=.true.,<br>     &amp;                  s1=hdate)<br>           call geth_newdate(hdate,hdate,3600*fcst)<br>           call mprintf(.true.,DEBUG,&quot;G2 hdate (fcst?) = %s &quot;,<br>     &amp;                  newline=.true., s1=hdate)<br><br>           !--<br><br>           ! Indicator of the source (center) of the data.<br>           icenter = gfld%idsect(1)<br><br>           ! Indicator of model (or whatever) which generated the data.<br>           iprocess = gfld%ipdtmpl(5)<br><br><br>           if (icenter.eq.7) then<br>             if (iprocess.eq.81) then<br>               map%source = &#x27;NCEP GFS Analysis&#x27;<br>             elseif (iprocess.eq.82) then<br>               map%source = &#x27;NCEP GFS GDAS/FNL&#x27;<br>             elseif (iprocess.eq.83) then<br>               map%source = &#x27;NCEP HRRR Model&#x27;<br>             elseif (iprocess.eq.84) then<br>               map%source = &#x27;NCEP MESO NAM Model&#x27;<br>             elseif (iprocess.eq.89) then<br>               map%source = &#x27;NCEP NMM &#x27;<br>             elseif (iprocess.eq.96) then<br>               map%source = &#x27;NCEP GFS Model&#x27;<br>             elseif (iprocess.eq.86 .or. iprocess.eq.100) then<br>               map%source = &#x27;NCEP RUC Model&#x27;    ! 60 km<br>             elseif (iprocess.eq.101) then<br>               map%source = &#x27;NCEP RUC Model&#x27;    ! 40 km<br>             elseif (iprocess.eq.105) then<br>               if (year .gt. 2011) then<br>                 map%source = &#x27;NCEP RAP Model&#x27;<br>               else<br>                 map%source = &#x27;NCEP RUC Model&#x27;  ! 20 km<br>               endif<br>             elseif (iprocess.eq.107) then<br>               map%source = &#x27;NCEP GEFS&#x27;<br>             elseif (iprocess.eq.109) then<br>               map%source = &#x27;NCEP RTMA&#x27;<br>             elseif (iprocess.eq.140) then<br>               map%source = &#x27;NCEP NARR&#x27;<br>             elseif (iprocess.eq.44) then<br>               map%source = &#x27;NCEP SST Analysis&#x27;<br>             elseif (iprocess.eq.70) then<br>               map%source = &#x27;GFDL Hurricane Model&#x27;<br>             elseif (iprocess.eq.80) then<br>               map%source = &#x27;NCEP GFS Ensemble&#x27;<br>             elseif (iprocess.eq.107) then             ! renumbered as of 23 Feb 2010<br>               map%source = &#x27;NCEP GFS Ensemble&#x27;<br>             elseif (iprocess.eq.111) then<br>               map%source = &#x27;NCEP NMMB Model&#x27;<br>             elseif (iprocess.eq.112) then<br>               map%source = &#x27;NCEP WRF-NMM Model&#x27;<br>             elseif (iprocess.eq.116) then<br>               map%source = &#x27;NCEP WRF-ARW Model&#x27;<br>             elseif (iprocess.eq.129) then<br>               map%source = &#x27;NCEP GODAS&#x27;<br>             elseif (iprocess.eq.197) then<br>               map%source = &#x27;NCEP CDAS CFSV2&#x27;<br>             elseif (iprocess.eq.25) then<br>               map%source = &#x27;NCEP SNOW COVER ANALYSIS&#x27;<br>             else<br>               map%source = &#x27;unknown model from NCEP&#x27;<br>               call mprintf(.true.,STDOUT,<br>     &amp;            &quot;unknown model from NCEP %i &quot;,newline=.true.,<br>     &amp;            i1=iprocess)<br>               call mprintf(.true.,LOGFILE,<br>     &amp;            &quot;unknown model from NCEP %i &quot;,newline=.true.,<br>     &amp;            i1=iprocess)<br>             end if<br>           else if (icenter .eq. 57) then<br>             if (iprocess .eq. 87) then<br>               map%source = &#x27;AFWA AGRMET&#x27;<br>             else<br>               map%source = &#x27;AFWA&#x27;<br>             endif<br>           else if ( icenter .eq. 58 ) then<br>             map%source = &#x27;US Navy FNOC&#x27;<br>           else if (icenter .eq. 59) then<br>             if (iprocess .eq. 125) then<br>               map%source = &#x27;NOAA GSD Rapid Refresh Model&#x27;<br>             else if (iprocess .eq. 83) then<br>               map%source = &#x27;NOAA GSD HRRR Model&#x27;<br>             else if (iprocess .eq. 105) then<br>               map%source = &#x27;NOAA GSD&#x27;<br>             else <br>               print *,&#x27;Unknown GSD source&#x27;<br>               stop<br>             endif<br>           else if (icenter .eq. 60) then<br>             map%source = &#x27;NCAR&#x27;<br>           else if (icenter .eq. 98) then<br>             map%source = &#x27;ECMWF&#x27;<br>           else if (icenter .eq. 34) then<br>             map%source = &#x27;JMA&#x27;<br>           else if (icenter .eq. 74 .or. icenter .eq. 75 ) then<br>             map%source = &#x27;UKMO&#x27;<br>           else if (icenter .eq. 78 .or. icenter .eq. 79 ) then<br>             map%source = &#x27;DWD&#x27;<br>           else<br>             map%source = &#x27;unknown model and orig center&#x27;<br>           end if<br>           if (icenter.eq.7) then<br>             if (iprocess.eq.81 .or. iprocess.eq.82 .or.<br>     &amp;           iprocess.eq.96) then<br>!  pmin should not be 15 or 40 hPa for gfs files. Use the next highest level.<br>               if (pmin .eq. 1500.) then<br>                 pmin = 1000.<br>               else if (pmin .eq. 4000.) then<br>                 pmin = 3000.<br>               endif<br>             endif<br>           endif<br><br>           call mprintf(.true.,DEBUG,&quot;G2 source is = %s &quot;,<br>     &amp;                  newline=.true., s1=map%source)<br><br>           !--<br><br>           ! Store information about the grid containing the data.<br>           ! This stuff gets stored in the MAP variable, as defined in <br>           ! module GRIDINFO.<br><br>           map%startloc = &#x27;SWCORNER&#x27;<br>           map%grid_wind = .true.<br><br>           if (gfld%igdtnum.eq.0) then ! Lat/Lon grid aka Cylindrical Equidistant<br>              map%igrid = 0<br>              map%nx = gfld%igdtmpl(8)<br>              map%ny = gfld%igdtmpl(9)<br>              map%dx = gfld%igdtmpl(17)<br>              map%dy = gfld%igdtmpl(18)<br>              map%lat1 = gfld%igdtmpl(12)<br>              map%lon1 = gfld%igdtmpl(13)<br>              write(tmp8,&#x27;(b8.8)&#x27;) gfld%igdtmpl(14)<br>              if (tmp8(5:5) .eq. &#x27;0&#x27;) map%grid_wind = .false.<br>              map%r_earth = earth_radius (gfld%igdtmpl(1),<br>     &amp;                         gfld%igdtmpl(2),gfld%igdtmpl(3))<br><br>! Fix for NCEP 1/12 degree grids (e.g. rtgsst)<br>              if (icenter .eq. 7 .and. map%dx .eq. 83000. .and. map%nx <br>     &amp;              .eq. 4320) then<br>                map%lat1 = 89958333.<br>                map%lon1 = 41667.<br>                map%dx = 83333.333 * sign(1.0,map%dx)<br>                map%dy = 83333.333 * sign(1.0,map%dy)<br>              endif<br><br>              if ((gfld%igdtmpl(10) .eq. 0).OR.<br>     &amp;            (gfld%igdtmpl(10) .eq. 255)) THEN<br>          ! Scale lat/lon values to 0-180, default range is 1e6.<br>                map%lat1 = map%lat1/scale_factor<br>                map%lon1 = map%lon1/scale_factor<br>          ! Scale dx/dy values to degrees, default range is 1e6.<br>                map%dx = map%dx/scale_factor<br>                map%dy = map%dy/scale_factor<br>              else<br>          ! Basic angle and subdivisions are non-zero (not tested)<br>                map%lat1 = map%lat1 *<br>     &amp;                     (gfld%igdtmpl(11)/gfld%igdtmpl(10))<br>                map%lon1 = map%lon1 *<br>     &amp;                     (gfld%igdtmpl(11)/gfld%igdtmpl(10))<br>                map%dx = map%dx * <br>     &amp;                     (gfld%igdtmpl(11)/gfld%igdtmpl(10))<br>                map%dy = map%dy * <br>     &amp;                     (gfld%igdtmpl(11)/gfld%igdtmpl(10))<br>               call mprintf(.true.,STDOUT,&quot;WARNING - Basic angle option <br>     &amp;has not been tested, continuing anyway&quot;)<br>               call mprintf(.true.,LOGFILE,&quot;WARNING - Basic angle option <br>     &amp; has not been tested, continuing anyway&quot;)<br>              endif<br><br><br>! The following is needed for NCEP GFS, 0.5 degree output. The j-scan is in the -y direction.<br>! In WPS, the sign of dy indicates the direction of the scan.<br>              write(tmp8,&#x27;(b8.8)&#x27;) gfld%igdtmpl(19)<br>              read(tmp8,&#x27;(1x,i1)&#x27;) jscan<br>              if ( jscan .eq. 0 .and. map%dy .gt. 0. ) then<br>                map%dy = -1. * map%dy<br>              endif<br>!             if ( map%lat1 .gt. gfld%igdtmpl(15) .and. <br>!    &amp;               map%dy .gt. 0. ) then<br>!               map%dy = -1. * map%dy<br>!               write(6,*) &#x27;Resetting map%dy for iprocess = &#x27;,iprocess<br>!             endif<br><br>           elseif (gfld%igdtnum.eq.10) then ! Mercator Grid.<br>              map%igrid = 1<br>              map%nx = gfld%igdtmpl(8)<br>              map%ny = gfld%igdtmpl(9)<br>              map%lov = 0.<br>              map%truelat1 = gfld%igdtmpl(13) / scale_factor<br>              map%truelat2 = 0.<br>              map%dx = gfld%igdtmpl(18) / scale_factor<br>              map%dy = gfld%igdtmpl(19) / scale_factor<br>              map%lat1 = gfld%igdtmpl(10) / scale_factor<br>              map%lon1 = gfld%igdtmpl(11) / scale_factor<br>              write(tmp8,&#x27;(b8.8)&#x27;) gfld%igdtmpl(12)<br>              if (tmp8(5:5) .eq. &#x27;0&#x27;) map%grid_wind = .false.<br>              map%r_earth = earth_radius (gfld%igdtmpl(1),<br>     &amp;                       gfld%igdtmpl(2),gfld%igdtmpl(3))<br><br>           elseif (gfld%igdtnum.eq.20) then ! Polar-Stereographic Grid.<br>              map%igrid = 5<br>              map%nx = gfld%igdtmpl(8)<br>              map%ny = gfld%igdtmpl(9)<br>              map%lov = gfld%igdtmpl(14) / scale_factor<br>              map%truelat1 = 60.<br>              map%truelat2 = 91.<br>              map%dx = gfld%igdtmpl(15) / scale_factor<br>              map%dy = gfld%igdtmpl(16) / scale_factor<br>              map%lat1 = gfld%igdtmpl(10) / scale_factor<br>              map%lon1 = gfld%igdtmpl(11) / scale_factor<br>              write(tmp8,&#x27;(b8.8)&#x27;) gfld%igdtmpl(12)<br>              if (tmp8(5:5) .eq. &#x27;0&#x27;) map%grid_wind = .false.<br>              map%r_earth = earth_radius (gfld%igdtmpl(1),<br>     &amp;                       gfld%igdtmpl(2),gfld%igdtmpl(3))<br><br>           elseif (gfld%igdtnum.eq.30) then ! Lambert Conformal Grid<br>              map%igrid = 3<br>              map%nx = gfld%igdtmpl(8)<br>              map%ny = gfld%igdtmpl(9)<br>              map%lov = gfld%igdtmpl(14) / scale_factor<br>              map%truelat1 = gfld%igdtmpl(19) / scale_factor<br>              map%truelat2 = gfld%igdtmpl(20) / scale_factor<br>              map%dx = gfld%igdtmpl(15) / scale_factor<br>              map%dy = gfld%igdtmpl(16) / scale_factor<br>              map%lat1 = gfld%igdtmpl(10) / scale_factor<br>              map%lon1 = gfld%igdtmpl(11) / scale_factor<br>              write(tmp8,&#x27;(b8.8)&#x27;) gfld%igdtmpl(12)<br>              if (tmp8(5:5) .eq. &#x27;0&#x27;) map%grid_wind = .false.<br>              map%r_earth = earth_radius (gfld%igdtmpl(1),<br>     &amp;                       gfld%igdtmpl(2),gfld%igdtmpl(3))<br><br>           elseif(gfld%igdtnum.eq.40) then ! Gaussian Grid (we will call it lat/lon)<br>              map%igrid = 4<br>              map%nx = gfld%igdtmpl(8)     ! Ni - # of points along a parallel<br>              map%ny = gfld%igdtmpl(9)     ! Nj - # of points along meridian<br>              map%dx = gfld%igdtmpl(17)    ! Di - i direction increment<br>              map%dy = gfld%igdtmpl(18)    ! N - # of parallels between pole and equator<br>              map%lat1 = gfld%igdtmpl(12)  ! La1 - lat of 1st grid point<br>              map%lon1 = gfld%igdtmpl(13)  ! Lo1 - lon of 1st grid point<br>              write(tmp8,&#x27;(b8.8)&#x27;) gfld%igdtmpl(14)  ! resolution/component flag<br>              if (tmp8(5:5) .eq. &#x27;0&#x27;) map%grid_wind = .false.<br>              map%r_earth = earth_radius (gfld%igdtmpl(1),<br>     &amp;                       gfld%igdtmpl(2),gfld%igdtmpl(3))<br><br>              ! Scale dx/dy values to degrees, default range is 1e6.<br>              if (map%dx.gt.10000) then <br>                 map%dx = map%dx/scale_factor<br>              endif<br>              if (map%dy.gt.10000) then <br>                 map%dy = (map%dy/scale_factor)*(-1)<br>              endif<br><br>              ! Fix for zonal shift in CFSR data, following a similar fix <br>              ! for global lat-lon data in rd_grib1.F<br>              if ( ABS(map%nx * map%dx - 360.0) &lt; 1.0 ) then<br>                 if (ABS(map%dx - (360./real(map%nx))) &gt; 0.00001) then<br>                    write(0,*) &#x27;CFSR fix: recomputing delta-longitude&#x27;<br>                    map%dx = 360./real(map%nx)<br>                 endif<br>              endif<br><br>              ! Scale lat/lon values to 0-180, default range is 1e6.<br>              if (abs(map%lat1).ge.scale_factor) then<br>                 map%lat1 = map%lat1/scale_factor<br>              endif<br>              if (map%lon1.ge.scale_factor) then <br>                 map%lon1 = map%lon1/scale_factor<br>              endif<br>              if ( debug_level .gt. 2 ) then<br>              call mprintf(.true.,DEBUG,<br>     &amp;     &quot;Gaussian Grid: Dx,Dy,lat,lon,nlats %f %f %f %f %i &quot;,<br>     &amp;     newline=.true.,f1=map%dx,f2=map%dy,f3=map%lat1,f4=map%lon1,<br>     &amp;     i1=nint(map%dy))<br>              end if<br>           elseif (gfld%igdtnum.eq.32769) then ! Arakawa Non-E Staggered grid.<br>              map%igrid = 6               <br>              map%nx = gfld%igdtmpl(8)        <br>              map%ny = gfld%igdtmpl(9)        <br>              map%dx = gfld%igdtmpl(17)        <br>              map%dy = gfld%igdtmpl(18)       <br>              map%lat1 = gfld%igdtmpl(12)        <br>              map%lon1 = gfld%igdtmpl(13)        <br>              map%lat0 = gfld%igdtmpl(15)        <br>              map%lon0 = gfld%igdtmpl(16)        <br>              map%r_earth = earth_radius (gfld%igdtmpl(1),<br>     &amp;                         gfld%igdtmpl(2),gfld%igdtmpl(3))<br>              if ((gfld%igdtmpl(10) .eq. 0).OR.<br>     &amp;            (gfld%igdtmpl(10) .eq. 255)) THEN<br>                map%lat1 = map%lat1/scale_factor<br>                map%lon1 = map%lon1/scale_factor<br>                map%lat0 = map%lat0/scale_factor<br>                map%lon0 = map%lon0/scale_factor<br>                map%dx = map%dx/scale_factor/1.e3<br>                map%dy = map%dy/scale_factor/1.e3<br>              else<br>          ! Basic angle and subdivisions are non-zero (not tested)<br>                map%lat1 = map%lat1 *<br>     &amp;                     (gfld%igdtmpl(11)/gfld%igdtmpl(10))<br>                map%lon1 = map%lon1 *<br>     &amp;                     (gfld%igdtmpl(11)/gfld%igdtmpl(10))<br>                map%dx = map%dx * <br>     &amp;                     (gfld%igdtmpl(11)/gfld%igdtmpl(10))<br>                map%dy = map%dy * <br>     &amp;                     (gfld%igdtmpl(11)/gfld%igdtmpl(10))<br>               call mprintf(.true.,STDOUT,&quot;WARNING - Basic angle option <br>     &amp;has not been tested, continuing anyway&quot;)<br>               call mprintf(.true.,LOGFILE,&quot;WARNING - Basic angle option <br>     &amp; has not been tested, continuing anyway&quot;)<br>              endif<br><br>           else<br>              call mprintf(.true.,STDOUT,&quot;GRIB2 Unknown Projection: %i&quot;,<br>     &amp;          newline=.true.,i1=gfld%igdtnum)<br>              call mprintf(.true.,STDOUT,<br>     &amp;          &quot;ungrib understands projections 0, 20, 30, and 40&quot;, <br>     &amp;          newline=.true.)<br>              call mprintf(.true.,LOGFILE,<br>     &amp;          &quot;GRIB2 Unknown Projection: %i&quot;,<br>     &amp;          newline=.true.,i1=gfld%igdtnum)<br>              call mprintf(.true.,LOGFILE,<br>     &amp;          &quot;ungrib understands projections 0, 10, 20, 30, and 40&quot;, <br>     &amp;          newline=.true.)<br>       ! If the projection is not known, then it can&#x27;t be processed by metgrid/plotfmt<br>                stop &#x27;Stop in rd_grib2&#x27;<br>           endif<br><br>           call mprintf(.true.,DEBUG,&quot;G2 igrid = %i ,  dx = %f ,  dy = %<br>     &amp;f &quot;, newline=.true., i1 = map%igrid, f1=map%dx, f2=map%dy)<br>         <br>           if (icenter.eq.7) then<br>             call ncep_grid_num (gfld%igdtnum)<br>           endif<br><br>           ! Deallocate arrays decoding GRIB2 record.<br>           call gf_free(gfld)<br><br>         endif   ! &quot;first&quot; if-block<br><br>         ! ----<br><br>         ! Continue to unpack GRIB2 field.<br>         NUM_FIELDS: do n = 1, numfields <br>   ! e.g. U and V would =2, otherwise its usually =1<br>           call gf_getfld(cgrib,lengrib,n,.FALSE.,expand,gfld,ierr)<br>           if (ierr.ne.0) then<br>             write(*,*) &#x27; ERROR extracting field gf_getfld = &#x27;,ierr<br>             cycle<br>           endif<br><br>! The JMA GSM has two different grids in the same GRIB file, so we need<br>! to process the map info for each field separately. If any other centers do<br>! this, then processing will need to be added here, too.<br><br>            if (icenter .eq. 34 .and. gfld%igdtnum.eq.0) then<br>              map%nx = gfld%igdtmpl(8)<br>              map%ny = gfld%igdtmpl(9)<br>              map%dx = gfld%igdtmpl(17)<br>              map%dy = gfld%igdtmpl(18)<br>              ! Scale dx/dy values to degrees, default range is 1e6.<br>              if (map%dx.gt.10000) then<br>                 map%dx = map%dx/scale_factor<br>              endif<br>              if (map%dy.gt.10000) then<br>                 map%dy = map%dy/scale_factor<br>              endif<br>              write(tmp8,&#x27;(b8.8)&#x27;) gfld%igdtmpl(19)<br>              read(tmp8,&#x27;(1x,i1)&#x27;) jscan<br>              write(0,*) &#x27;gfld%igdtmpl(19) = &#x27;,gfld%igdtmpl(19),<br>     &amp;   &#x27; jscan = &#x27;,jscan<br>              if ( jscan .eq. 0 .and. map%dy .gt. 0. ) then<br>                map%dy = -1. * map%dy<br>              endif<br>            endif             ! JMA spectral<br><br>! ------------------------------------<br>         ! Additional print information for developer.<br>         if ( debug_level .GT. 1000 ) then<br>!MGD           print *<br>!MGD           print *,&#x27;G2 FIELD &#x27;,n<br>!MGD           if (n==1) then<br>!MGD            print *,&#x27;G2 SECTION 0: &#x27;,gfld%discipline,gfld%version<br>!MGD            print *,&#x27;G2 SECTION 1: &#x27;,(gfld%idsect(j),j=1,gfld%idsectlen)<br>!MGD           endif<br>!MGD           if ( associated(gfld%local).AND.gfld%locallen.gt.0 ) then<br>!MGD              print *,&#x27;G2 SECTION 2: &#x27;,(gfld%local(j),j=1,gfld%locallen)<br>!MGD           endif<br>!MGD           print *,&#x27;G2 SECTION 3: &#x27;,gfld%griddef,gfld%ngrdpts,<br>!MGD     &amp;                            gfld%numoct_opt,gfld%interp_opt,<br>!MGD     &amp;                            gfld%igdtnum<br>!MGD           print *,&#x27;G2 GRID TEMPLATE 3.&#x27;,gfld%igdtnum,&#x27;: &#x27;,<br>!MGD     &amp;            (gfld%igdtmpl(j),j=1,gfld%igdtlen)<br>!MGD           if ( gfld%num_opt .eq. 0 ) then<br>!MGD             print *,&#x27;G2 NO Section 3 List Defining No. of Data Points.&#x27;<br>!MGD           else<br>!MGD             print *,&#x27;G2 Section 3 Optional List: &#x27;,<br>!MGD     &amp;                (gfld%list_opt(j),j=1,gfld%num_opt)<br>!MGD           endif<br>!MGD           print *,&#x27;G2 PRODUCT TEMPLATE 4.&#x27;,gfld%ipdtnum,&#x27;: &#x27;,<br>!MGD     &amp;          (gfld%ipdtmpl(j),j=1,gfld%ipdtlen)<br><br>           pabbrev=param_get_abbrev(gfld%discipline,gfld%ipdtmpl(1),<br>     &amp;                              gfld%ipdtmpl(2))<br>           !call prlevel(gfld%ipdtnum,gfld%ipdtmpl,labbrev)<br>           !call prvtime(gfld%ipdtnum,gfld%ipdtmpl,listsec1,tabbrev)<br>!MGD            print *,&#x27;G2 TEXT: &#x27;,pabbrev,trim(labbrev),&quot; &quot;,trim(tabbrev)<br><br>!MGD           if ( gfld%num_coord .eq. 0 ) then<br>!MGD             print *,&#x27;G2 NO Optional Vertical Coordinate List.&#x27;<br>!MGD           else<br>!MGD             print *,&#x27;G2 Section 4 Optional Coordinates: &#x27;,<br>!MGD     &amp;             (gfld%coord_list(j),j=1,gfld%num_coord)<br>!MGD           endif<br>           if ( gfld%ibmap .ne. 255 ) then<br>              call mprintf(.true.,DEBUG, <br>     &amp;             &#x27;G2 Num. of Data Points = %i with BIT-MAP %i&#x27;, <br>     &amp;             newline=.true., i1=gfld%ndpts, i2=gfld%ibmap)<br>           else<br>              call mprintf(.true.,DEBUG, <br>     &amp;             &#x27;G2 Num. of Data Points = %i NO BIT-MAP&#x27;, <br>     &amp;             newline=.true., i1=gfld%ndpts)<br>           endif<br>!MGD           print *,&#x27;G2 DRS TEMPLATE 5.&#x27;,gfld%idrtnum,&#x27;: &#x27;,<br>!MGD     &amp;          (gfld%idrtmpl(j),j=1,gfld%idrtlen)<br>         endif ! Additional Print information <br>! ------------------------------------<br><br>!         do i = 1, maxvar<br>!           write(6,&#x27;(a10,4i8)&#x27;) namvar(i),(g2code(j,i),j=1,4)<br>!         enddo<br>!MGD      if (debug_level .gt. 50) then<br>!MGD          write(6,*) &#x27;looking for &#x27;,gfld%discipline,gfld%ipdtmpl(1),<br>!MGD     &amp;       gfld%ipdtmpl(2),gfld%ipdtmpl(10)<br>!MGD          endif<br>           call mprintf(.true.,DEBUG,&quot;G2 Searching the g2code array (Vta<br>     &amp;ble) for this grib field %i %i %i %i %i %i &quot;, newline=.true.,<br>     &amp; i1 = gfld%discipline, i2 = gfld%ipdtmpl(1),<br>     &amp; i3 = gfld%ipdtmpl(2), i4 = gfld%ipdtmpl(10),<br>     &amp; i5 = gfld%ipdtmpl(12), i6 = gfld%ipdtnum )<br><br><br>         ! Test this data record against list of desired variables <br>         ! found in Vtable.<br>         ! ----<br>         MATCH_LOOP: do i=1,maxvar ! Max variables found in Vtable,<br>                                   ! maxvar is defined in table.mod<br><br>           if ( gfld%discipline .eq. g2code(1,i) .and.   !Discipline <br>     &amp;          gfld%ipdtmpl(1) .eq. g2code(2,i) .and.   !Category<br>     &amp;          gfld%ipdtmpl(2) .eq. g2code(3,i) .and.   !Parameter<br>     &amp;          gfld%ipdtmpl(10) .eq. g2code(4,i) .and.  !Elevation<br>     &amp;          gfld%ipdtnum    .eq. g2code(5,i)) then   !Template<br><br>            call gf_free(gfld)<br>            call gf_getfld(cgrib,lengrib,n,.TRUE.,expand,gfld,ierr)<br>            pabbrev=param_get_abbrev(gfld%discipline,gfld%ipdtmpl(1),<br>     &amp;                               gfld%ipdtmpl(2))<br><br>              !my_field (e.g. RH, TMP, similar to, but not the same as pabbrev)<br>              my_field=namvar(i) <br><br>!MGD    if (debug_level .gt. 50) then<br>!MGD     write(6,*) &#x27;namvar(i) = &#x27;,namvar(i),&#x27; pabbrev = &#x27;,pabbrev<br>!MGD     write(6,*) &#x27;Parameter = &#x27;,gfld%ipdtmpl(2)<br>!MGD    endif<br>!  The following if-block is commented out since equivalent info can be obtained from g2print<br>!       if (debug_level .gt. 1000) then<br>!          fldmax=gfld%fld(1)<br>!          fldmin=gfld%fld(1)<br>!          sum=gfld%fld(1)<br>!          do j=2,gfld%ndpts<br>!            if (gfld%fld(j).gt.fldmax) fldmax=gfld%fld(j)<br>!            if (gfld%fld(j).lt.fldmin) fldmin=gfld%fld(j)<br>!            sum=sum+gfld%fld(j)<br>!          enddo ! gfld%ndpts<br>!          call mprintf(.true.,DEBUG,&#x27;G2 FIELD=%s MIN=%f AVG=%f MAX=%f&#x27;,<br>!    &amp;         newline=.true., s1=pabbrev, f1=fldmin, f2=sum/gfld%ndpts,<br>!    &amp;         f3=fldmax)<br>!       endif<br><br>! need to match up soil levels with those requested.<br>! For the Vtable levels, -88 = all levels, -99 = missing. The units<br>! vary depending on the level code (e.g. 106 = cm, 103 = m).<br>! The grib2 standard allows scaling of the units, so make sure the soil level<br>! units are in cm (as used in the Vtable).<br>!<br>!              if ( gfld%ipdtmpl(10) .eq. 106 ) then<br>              if (( gfld%ipdtmpl(10) .eq. 106 ) .or. <br>     &amp;           ( gfld%ipdtmpl(10) .eq. 151 )) then              !! Added by Prof. Mariusz Figurski, 20250110<br>                if ( ( gfld%ipdtmpl(14) .EQ. -1*(2**07-1) ) .AND.<br>!    &amp;               ( gfld%ipdtmpl(15) .EQ. -1*(2**31-1) ) ) THEN ! Some compilers cannot<br>                                                                   ! handle the initial 2**31<br>                                                                   ! part of the computation, <br>                                                                   ! which is an arithmetic <br>                                                                   ! overflow on 32 bit signed ints<br>     &amp;               ( gfld%ipdtmpl(15) .EQ. -2147483647  ) ) THEN<br>! special UM grib2<br>                   glevel1 = gfld%ipdtmpl(12)<br>                   glevel2 = gfld%ipdtmpl(11)<br>                else<br>                   glevel1 = 100. * gfld%ipdtmpl(12)*<br>     &amp;                         (10.**(-1.*gfld%ipdtmpl(11)))<br>                   glevel2 = 100. * gfld%ipdtmpl(15)*<br>     &amp;                         (10.**(-1.*gfld%ipdtmpl(14)))<br>!The following if-block accounts for the 2024 changes to IFS soil fields. They use a local table. 10.01.2024 <br>!! Added by Prof. Mariusz Figurski, 20250110<br>                  if (icenter .eq. 98 .and.<br>     &amp;                gfld%discipline .eq. 2 .and.     !! Added by Prof. Mariusz Figurski, 20250110<br>     &amp;                (gfld%ipdtmpl(1) .eq. 3 .or.      !! Added by Prof. Mariusz Figurski, 20250110<br>     &amp;                gfld%ipdtmpl(1) .eq. 0) .and.      !! Added by Prof. Mariusz Figurski, 20250110<br>     &amp;                gfld%ipdtmpl(10).eq. 151) then    !! Added by Prof. Mariusz Figurski, 20250110<br>!     &amp;                gfld%discipline .eq. 192 .and.<br>!     &amp;                gfld%ipdtmpl(1) .eq. 128 .and.<br>!     &amp;                gfld%ipdtmpl(10).eq. 106) then<br>                      glevel1 = gfld%ipdtmpl(12)<br>                      glevel2 = gfld%ipdtmpl(15)                      <br>!!    Added by Prof. Mariusz Figurski, 20250110  start special for IFS grib2<br>                      if ( gfld%ipdtmpl(12) .eq. 0) then<br>                          glevel1 = 0<br>                      elseif ( gfld%ipdtmpl(12) .eq. 1) then<br>                          glevel1 = 7<br>                      elseif ( gfld%ipdtmpl(12) .eq. 2) then<br>                          glevel1 = 28<br>                      elseif ( gfld%ipdtmpl(12) .eq. 3) then<br>                          glevel1 = 100<br>                      elseif ( gfld%ipdtmpl(12) .eq. 4) then<br>                          glevel1 = 289<br>                      endif<br><br>                      if ( gfld%ipdtmpl(15) .eq. 0) then<br>                          glevel2 = 0<br>                      elseif ( gfld%ipdtmpl(15) .eq. 1) then<br>                          glevel2 = 7<br>                      elseif ( gfld%ipdtmpl(15) .eq. 2) then<br>                          glevel2 = 28<br>                      elseif ( gfld%ipdtmpl(15) .eq. 3) then<br>                          glevel2 = 100<br>                      elseif ( gfld%ipdtmpl(15) .eq. 4) then<br>                          glevel2 = 289<br>                      endif<br>!!   end special block for IFS grib2<br><br>                      if ( glevel1 .eq. 100. .and.<br>     &amp;                     glevel2 .lt. -1.e+9 ) then<br>                        glevel2 = 255.<br>                      endif<br>                  endif<br>                end if<br>                TMP8LOOP: do j = 1, maxvar<br>                  if (((g2code(4,j) .eq. 106) .or. <br>     &amp;               (g2code(4,j) .eq. 151)) .and.              !! Added by Prof. Mariusz Figurski, 20250110<br>     &amp;               (gfld%ipdtmpl(1) .eq. g2code(2,j)) .and.   !! Added by Dr. Haiqing SONG, 20181201<br>     &amp;               (gfld%ipdtmpl(2) .eq. g2code(3,j)) .and.<br>     &amp;               (glevel1 .eq. level1(j)) .and.<br>     &amp;               ((glevel2 .eq. level2(j)) .or.<br>     &amp;                                   (level2(j) .le. -88))) then<br>                    my_field = namvar(j)<br>                    exit TMP8LOOP<br>                  endif<br>                enddo TMP8LOOP<br>                if (j .gt. maxvar ) then<br>                  write(6,&#x27;(a,i6,a)&#x27;) &#x27;Subsoil level &#x27;,<br>     &amp;               gfld%ipdtmpl(12), <br>     &amp;           &#x27; in the GRIB2 file, was not found in the Vtable&#x27;<br>                  cycle MATCH_LOOP<br>                endif<br>!MGD         if (debug_level .gt. 50) write(6,*) &#x27;my_field is now &#x27;,my_field<br>              endif<br><br>              ! Level (eg. 10000 mb)<br>              if(gfld%ipdtmpl(10).eq.100) then<br>                 ! Pressure level (range from 1000mb to 0mb)<br>                 level=gfld%ipdtmpl(12) *<br>     &amp;                           (10. ** (-1. * gfld%ipdtmpl(11)))<br> if ( level .lt. pmin ) cycle MATCH_LOOP<br>              elseif((gfld%ipdtmpl(10).eq.105).or.<br>     &amp;               (gfld%ipdtmpl(10).eq.118).or.<br>     &amp;               (gfld%ipdtmpl(10).eq.150))then<br>                 ! Hybrid level (range from 1 to N)<br>                 level=gfld%ipdtmpl(12)<br>              elseif(gfld%ipdtmpl(10).eq.104) then<br>                 ! Sigma level (range from 10000 to 0)<br>                 level=gfld%ipdtmpl(12)<br>              elseif(gfld%ipdtmpl(10).eq.101) then<br>                 ! MSL<br>                 level=201300.<br>              elseif(gfld%ipdtmpl(10).eq.103) then<br>         ! Height above ground (m)<br> if (gfld%ipdtmpl(12) .eq. 2. .or. <br>     &amp;               gfld%ipdtmpl(12) .eq. 1000. .or.     ! temp fix for hrrr maxref<br>     &amp;               gfld%ipdtmpl(12) .eq. 10. ) then<br>                   level=200100.<br> else<br>                   cycle MATCH_LOOP<br> endif<br>              elseif((gfld%ipdtmpl(10).ge.206 .and.<br>     &amp;               gfld%ipdtmpl(10).le.234) .or.<br>     &amp;              (gfld%ipdtmpl(10).ge.242 .and.     <br>     &amp;               gfld%ipdtmpl(10).le.254) .or.<br>     &amp;              (gfld%ipdtmpl(10).eq.200) .or.<br>     &amp;              (gfld%ipdtmpl(10).eq.10) ) then<br>                 ! NCEP cloud layers used for plotting<br>                   level=200100.<br>              elseif(gfld%ipdtmpl(10).eq.106 .or. <br>     &amp;               gfld%ipdtmpl(10).eq.151 .or.       !! Added by Prof. Mariusz Figurski, 20250110<br>     &amp;               gfld%ipdtmpl(10).eq.1) then<br>                 ! Misc near ground/surface levels<br>                 level=200100.<br>              elseif(gfld%ipdtmpl(10).eq.6) then<br>                 ! Level of Max wind<br>                 level=200100.  <br>              elseif(gfld%ipdtmpl(10).eq.7) then<br>                 ! Tropopause<br>                 level=200100.<br>              else<br>                 ! If we are here then the Vtable contains a level code<br>                 ! which we cannot handle. Write an info message and skip it.<br>                 call mprintf(.true.,INFORM,&quot;Rd_grib2 does not know abou<br>     &amp;t level code %i (field = %s). Skipping this field. If you want thi<br>     &amp;s level, rd_grib2.F must be modified&quot;, i1 = gfld%ipdtmpl(10),<br>     &amp; s1 =  my_field )<br>                 cycle MATCH_LOOP<br>              endif<br>              iplvl = int(level)<br><br>              ! Store the unpacked 2D slab from the GRIB2 record<br>              allocate(hold_array(gfld%ngrdpts))<br>              do j=1,gfld%ngrdpts<br>                 hold_array(j)=gfld%fld(j)<br>              enddo<br><br>!   Some grids need to be reordered. Until we get an example, this is<br>!   a placeholder<br>!             call reorder_it (hold_array, map%nx, map%ny, map%dx, <br>!    &amp;                 map%dy, iorder)<br><br>              ! When we have reached this point, we have a data array ARRAY <br>              ! which has some data we want to save, with field name FIELD <br>              ! at pressure level LEVEL (Pa).  Dimensions of this data are <br>              ! map%nx and map%ny.  Put this data into storage.<br><br>              !print *,&#x27;call put_storage&#x27;,iplvl,my_field,hold_array(55),ith<br>              !e.g. call put_storage(200100, &#x27;RH&#x27;, my_field, 1, ith)<br>!             call mprintf(.true.,DEBUG,&quot;Calling put_storage for<br>!    &amp;level = %i , field = %s , g2level = %i &quot;, newline=.true.,<br>!    &amp; i1 = iplvl, s1 = my_field, i2 = gfld%ipdtmpl(12) )<br><br>              call put_storage(iplvl,my_field,<br>     &amp;           reshape(hold_array(1:map%nx*map%ny),<br>     &amp;           (/map%nx, map%ny/)), map%nx,map%ny)<br>              deallocate(hold_array)<br><br>              ! If Specific Humidity is present on hybrid levels AND <br>              ! upper-air RH is missing, see if we can compute RH from <br>              ! Specific Humidity.<br>              if (.not. is_there(iplvl, &#x27;RH&#x27;) .and.<br>     &amp;            is_there(iplvl, &#x27;SH&#x27;) .and.<br>     &amp;            is_there(iplvl, &#x27;TT&#x27;) .and.<br>     &amp;            is_there(iplvl, &#x27;P&#x27;)) then<br>                  call g2_compute_rh_spechumd_upa(map%nx,map%ny,iplvl)<br>                 !call llstor_remove(iplvl, &#x27;SH&#x27;) !We are done with SH<br>              endif<br><br>              ! If Specific Humidity is present on hybrid levels AND <br>              ! upper-air RH is missing, see if we can compute RH from <br>              ! Specific Humidity - v2<br>              if (.not. is_there(iplvl, &#x27;RH&#x27;) .and.<br>     &amp;            is_there(iplvl, &#x27;SPECHUMD&#x27;) .and.<br>     &amp;            is_there(iplvl, &#x27;THETA&#x27;) .and.<br>     &amp;            is_there(iplvl, &#x27;TT&#x27;)) then<br>                  call g2_compute_rh_spechumd_upa2(map%nx,map%ny,iplvl)<br>              endif<br><br>              ! If Temperature and Theta are present on hybrid levels AND<br>              ! upper-air PRESSURE is missing, see if we can compute PRESSURE from<br>              ! Temperature and Theta<br>              if (.not. is_there(iplvl, &#x27;PRESSURE&#x27;) .and.<br>     &amp;            is_there(iplvl, &#x27;THETA&#x27;) .and.<br>     &amp;            is_there(iplvl, &#x27;TT&#x27;)) then<br>                  call g2_compute_pressure_tth_upa(map%nx,map%ny,iplvl)<br>              endif<br><br>              ith=ith+1<br>              exit MATCH_LOOP<br><br>           endif ! Selected param.<br><br><br>         enddo MATCH_LOOP<br><br>         ! Deallocate arrays decoding GRIB2 record.<br>         call gf_free(gfld)<br><br>         enddo NUM_FIELDS<br><br><br>      enddo VERSION ! skgb<br><br><br>       if ( debug_level .gt. 100 ) then<br>         call mprintf (.true.,DEBUG,<br>     &amp;   &quot;G2 total number of fields found = %i &quot;,newline=.true.,i1=itot)<br>       end if<br><br>       CALL BACLOSE(junit,IOS)<br><br>       nullify(gfld%local)            ! must be nullified before opening next file<br>       ireaderr=1<br>      else <br>        call mprintf (.true.,DEBUG,&quot;open status failed because %i &quot;,<br>     &amp;                newline=.true., i1=ios)<br>        hdate = &#x27;9999-99-99_99:99:99&#x27;<br>        ireaderr=2<br>      endif ! ireaderr check <br><br>      END subroutine rd_grib2<br><br>!*****************************************************************************!<br>! Subroutine edition_num                                                      !<br>!                                                                             !<br>! Purpose:                                                                    !<br>!    Read one record from the input GRIB2 file.  Based on the information in  !<br>!    the GRIB2 header and the user-defined Vtable, decide whether the field in!<br>!    the GRIB2 record is one to process or to skip.  If the field is one we   !<br>!    want to keep, extract the data from the GRIB2 record, and pass the data  !<br>!    back to the calling routine.                                             !<br>!                                                                             !<br>! Argument list:                                                              !<br>!    Input:                                                                   !<br>!       JUNIT   : &quot;Unit Number&quot; to open and read from.  Not really a Fortran  !<br>!                 unit number, since we do not do Fortran I/O for the GRIB2   !<br>!                 files.  Nor is it a UNIX File Descriptor returned from a C  !<br>!                 OPEN statement.  It is really just an array index to the    !<br>!                 array (IUARR) where the UNIX File Descriptor values are     !<br>!                 stored.                                                     !<br>!       GRIB2FILE: File name to open, if it is not already open.              !<br>!                                                                             !<br>!    Output:                                                                  !<br>!       GRIB_EDITION: Set to 1 for GRIB and set to 2 for GRIB2                ! <br>!       IERR     : Error flag: 0 - no error on read from GRIB2 file.          !<br>!                              1 - Hit the end of the GRIB2 file.             !<br>!                              2 - The file GRIBFLNM we tried to open does    !<br>!                                  not exist.                                 !<br>! Author: Paula McCaslin                                                      !<br>! NOAA/FSL                                                                    !<br>! Sept 2004                                                                   !<br>!*****************************************************************************!<br>      <br>      SUBROUTINE edition_num(junit, gribflnm, <br>     &amp;  grib_edition, ireaderr)<br><br>      use grib_mod<br>      use params<br>      use module_debug<br><br>      parameter(msk1=32000,msk2=4000)<br>      character(len=1),allocatable,dimension(:) :: cgrib<br>      integer :: listsec0(3)<br>      integer :: listsec1(13)<br>      character(len=*)  :: gribflnm<br>      integer :: lskip, lgrib<br>      integer :: junit<br>      integer :: grib_edition<br>      integer :: i, j, ireaderr<br>      integer :: currlen<br><br>      character(len=4) :: ctemp<br>      character(len=4),parameter :: grib=&#x27;GRIB&#x27;,c7777=&#x27;7777&#x27;<br><br>C - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -<br>C  SET ARGUMENTS<br><br>      itot=0<br>      icount=0<br>      iseek=0<br>      lskip=0<br>      lgrib=0<br>      currlen=0<br><br>!/* IOS Return Codes from BACIO:  */<br>!/*  0    All was well                                   */<br>!/* -1    Tried to open read only _and_ write only       */<br>!/* -2    Tried to read and write in the same call       */<br>!/* -3    Internal failure in name processing            */<br>!/* -4    Failure in opening file                        */<br>!/* -5    Tried to read on a write-only file             */<br>!/* -6    Failed in read to find the &#x27;start&#x27; location    */<br>!/* -7    Tried to write to a read only file             */<br>!/* -8    Failed in write to find the &#x27;start&#x27; location   */<br>!/* -9    Error in close                                 */<br>!/* -10   Read or wrote fewer data than requested        */<br><br>!if ireaderr =1 we have hit the end of a file. <br>!if ireaderr =2 we have hit the end of all the files. <br>!if ireaderr =3 beginning characters &#x27;GRIB&#x27; not found<br><br>      ! Open a byte-addressable file.<br>      CALL BAOPENR(junit,gribflnm,IOS)<br>      if (ios.eq.0) then <br><br>         ! Search opend file for the next GRIB2 messege (record).<br>         call skgb(junit,iseek,msk1,lskip,lgrib)<br><br>         ! Check for EOF, or problem<br>         call mprintf((lgrib.eq.0),ERROR,<br>     &amp;     &quot;Grib2 file or date problem, stopping in edition_num.&quot;,<br>     &amp;     newline=.true.)<br> <br>         ! Check size, if needed allocate more memory.<br>         if (lgrib.gt.currlen) then<br>            if (allocated(cgrib)) deallocate(cgrib)<br>            allocate(cgrib(lgrib),stat=is)<br>            currlen=lgrib<br>         endif<br><br>         ! Read a given number of bytes from unblocked file.<br>         call baread(junit,lskip,lgrib,lengrib,cgrib)<br><br>         ! Check for beginning of GRIB message in the first 100 bytes<br>         istart=0<br>         do j=1,100<br>            ctemp=cgrib(j)//cgrib(j+1)//cgrib(j+2)//cgrib(j+3)<br>            if (ctemp.eq.grib ) then<br>              istart=j<br>              exit<br>            endif<br>         enddo<br>         if (istart.eq.0) then<br>            ireaderr=3<br>            print*, &quot;The beginning 4 characters &gt;GRIB&lt; were not found.&quot;<br>         endif<br>   <br>         ! Unpack Section 0 - Indicator Section to extract GRIB edition field<br>         iofst=8*(istart+5)<br>         call gbyte(cgrib,discipline,iofst,8)     ! Discipline<br>         iofst=iofst+8<br>         call gbyte(cgrib,grib_edition,iofst,8)   ! GRIB edition number<br><br>!        print *, &#x27;ungrib - grib edition num&#x27;,  grib_edition<br>         CALL BACLOSE(junit,IOS)<br>         ireaderr=1<br>      else if (ios .eq. -4) then<br>        call mprintf(.true.,ERROR, <br>     &amp;    &quot;edition_num: unable to open %s&quot;,newline=.true.,s1=gribflnm)<br>      else <br>         print *,&#x27;edition_num: open status failed because&#x27;,ios,gribflnm<br>         ireaderr=2<br>      endif ! ireaderr check <br><br>      END subroutine edition_num<br><br>!*****************************************************************************!<br><br>      SUBROUTINE g2_compute_rh_spechumd_upa(ix, jx, iiplvl)<br>      ! Compute relative humidity from specific humidity in the upper air.<br>      use storage_module<br>      implicit none<br>      integer :: ix, jx<br>      integer :: iiplvl<br>      real :: lat1, lon1, dx, dy<br>      real, dimension(ix,jx) :: T, P, RH, Q<br>    <br>      real, parameter :: svp1=611.2<br>      real, parameter :: svp2=17.67<br>      real, parameter :: svp3=29.65<br>      real, parameter :: svpt0=273.15<br>      real, parameter :: eps = 0.622<br>    <br>      real startlat, startlon, deltalat, deltalon<br><br>      call get_storage(iiplvl, &#x27;P&#x27;, P, ix, jx)<br>      call get_storage(iiplvl, &#x27;TT&#x27;, T, ix, jx)<br>      call get_storage(iiplvl, &#x27;SH&#x27;, Q, ix, jx)<br>    <br>      rh=1.E2*(p*q/(q*(1.-eps)+eps))/(svp1*exp(svp2*(t-svpt0)/(T-svp3)))<br>     <br>      call put_storage(iiplvl, &#x27;RH&#x27;, rh, ix, jx)<br>    <br>      end subroutine g2_compute_rh_spechumd_upa<br><br>!*****************************************************************************!<br><br>      SUBROUTINE g2_compute_rh_spechumd_upa2(ix, jx, iiplvl)<br>      ! Compute relative humidity from specific humidity in the upper air.<br>      use storage_module<br>      implicit none<br>      integer :: ix, jx<br>      integer :: iiplvl<br>      real :: lat1, lon1, dx, dy<br>      real, dimension(ix,jx) :: T, TH, RH, Q, P<br>    <br>      real, parameter :: svp1=611.2<br>      real, parameter :: svp2=17.67<br>      real, parameter :: svp3=29.65<br>      real, parameter :: svpt0=273.15<br>      real, parameter :: eps = 0.622<br>    <br>      real startlat, startlon, deltalat, deltalon<br><br>      call get_storage(iiplvl, &#x27;THETA&#x27;, TH, ix, jx)<br>      call get_storage(iiplvl, &#x27;TT&#x27;, T, ix, jx)<br>      call get_storage(iiplvl, &#x27;SPECHUMD&#x27;, Q, ix, jx)<br>    <br>      p=1.e5*(t/th)**(1005/287.05)<br>     <br>      rh=1.E2*(p*q/(q*(1.-eps)+eps))/(svp1*exp(svp2*(t-svpt0)/(T-svp3)))<br>     <br>      call put_storage(iiplvl, &#x27;RH&#x27;, rh, ix, jx)<br>    <br>      end subroutine g2_compute_rh_spechumd_upa2<br><br>!*****************************************************************************!<br><br>      SUBROUTINE g2_compute_pressure_tth_upa(ix, jx, iiplvl)<br>      ! Compute relative humidity from specific humidity in the upper air.<br>      use storage_module<br>      implicit none<br>      integer :: ix, jx<br>      integer :: iiplvl<br>      real :: lat1, lon1, dx, dy<br>      real, dimension(ix,jx) :: T, TH, P<br>    <br>      real, parameter :: svp1=611.2<br>      real, parameter :: svp2=17.67<br>      real, parameter :: svp3=29.65<br>      real, parameter :: svpt0=273.15<br>      real, parameter :: eps = 0.622<br>    <br>      real startlat, startlon, deltalat, deltalon<br><br>      call get_storage(iiplvl, &#x27;THETA&#x27;, TH, ix, jx)<br>      call get_storage(iiplvl, &#x27;TT&#x27;, T, ix, jx)<br>    <br>      p=1.e5*(t/th)**(1005/287.05)<br>     <br>      call put_storage(iiplvl, &#x27;PRESSURE&#x27;, p, ix, jx)<br>    <br>      end subroutine g2_compute_pressure_tth_upa<br><br>!*****************************************************************************!<br><br>      subroutine ncep_grid_num (pnum)<br>!<br>!  Find the grib number for descriptive  labelling.<br>!  Grib2 doesn&#x27;t have a grid-number entry, so we have to figure it out<br>!  from the parameters. <br>!<br>      use gridinfo       ! Included to define map%<br>      integer :: pnum<br>      real, parameter :: eps = .01<br>      character (len=8) :: tmp8<br><br>!     write(6,*) &#x27;begin ncep_grid_num&#x27;<br>!     write(6,*) &#x27;dx = &#x27;,map%dx,&#x27; pnum = &#x27;,pnum,&#x27; nx = &#x27;,map%nx<br>      tmp8 = &#x27;        &#x27;<br>      if (pnum .eq. 30) then            ! lambert conformal<br>        if ( abs(map%dx - 12.19058) .lt. eps .and. map%nx .eq. 614) then<br>          write(tmp8,&#x27;(&quot;GRID 218&quot;)&#x27;) <br>        else if (abs(map%dx - 40.63525) .lt. eps <br>     &amp;     .and. map%nx .eq. 185) then<br>          write(tmp8,&#x27;(&quot;GRID 212&quot;)&#x27;) <br>        else if (abs(map%dx - 40.63525) .lt. eps <br>     &amp;     .and. map%nx .eq. 151) then<br>          write(tmp8,&#x27;(&quot;GRID 236&quot;)&#x27;) <br>        else if (abs(map%dx - 81.2705) .lt. eps <br>     &amp;     .and. map%nx .eq. 93) then<br>          write(tmp8,&#x27;(&quot;GRID 211&quot;)&#x27;) <br>        else if (abs (map%dx - 32.46341) .lt. eps <br>     &amp;     .and. map%nx .eq. 349) then<br>          write(tmp8,&#x27;(&quot;GRID 221&quot;)&#x27;) <br>        else if (abs(map%dx - 20.317625) .lt. eps <br>     &amp;     .and. map%nx .eq. 301) then<br>          write(tmp8,&#x27;(&quot;GRID 252&quot;)&#x27;) <br>        else if (abs(map%dx - 13.545087) .lt. eps <br>     &amp;     .and. map%nx .eq. 451) then<br>          write(tmp8,&#x27;(&quot;GRID 130&quot;)&#x27;) <br>        endif<br>      else if (pnum .eq. 20) then     ! polar stereographic<br>        if (abs(map%dx - 15.0) .lt. eps) then<br>          write(tmp8,&#x27;(&quot;GRID  88&quot;)&#x27;) <br>        endif<br>      else if (pnum .eq. 0) then      ! lat/lon<br>        if (abs(map%dx - 1.) .lt. eps .and. map%nx .eq. 360) then<br>          write(tmp8,&#x27;(&quot;GRID   3&quot;)&#x27;) <br>        else if (abs(map%dx - 0.5) .lt. eps .and. map%nx .eq. 720) then<br>          write(tmp8,&#x27;(&quot;GRID   4&quot;)&#x27;) <br>        endif<br>      endif<br>      map%source(25:32) = tmp8<br>!     write(6,*) &#x27;map%source = &#x27;,map%source<br>      end subroutine ncep_grid_num<br>!*****************************************************************************!<br><br>      function earth_radius (icode, iscale, irad_m)<br>! Grib2 Code Table 3.2. Returns the spherical earth&#x27;s radius in km.<br>      use module_debug<br>      real :: earth_radius<br>      integer :: icode<br>      integer :: iscale, irad_m<br>      if ( icode .eq. 0 ) then<br>        earth_radius = 6367470. * .001<br>      else if ( icode .eq. 1) then<br>        earth_radius = 0.001 * float(irad_m) / 10**iscale<br>      else if ( icode .eq. 6 ) then<br>        earth_radius = 6371229. * .001<br>      else if ( icode .eq. 8 ) then<br>        earth_radius = 6371200. * .001<br>      else<br>        call mprintf(.true.,ERROR,<br>     &amp;    &quot;unknown earth radius for code %i&quot;,newline=.true.,i1=icode)<br>      endif<br>      end function earth_radius<br></code></pre></td></tr></table></figure>        </div>      </div>    </div>    <div class="fold">      <div class="fold-title fold-info collapsed" data-toggle="collapse" href="#collapse-dfb167e8" role="button" aria-expanded="false" aria-controls="collapse-dfb167e8">        <div class="fold-arrow">▶</div>Vtable.ECMWF_GRIB2      </div>      <div class="fold-collapse collapse" id="collapse-dfb167e8">        <div class="fold-content">          <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs Vtable.ECMWF_GRIB2">GRIB1| Level| From |  To  | metgrid  | metgrid  | metgrid                                  |GRIB2|GRIB2|GRIB2|GRIB2|<br>Param| Type |Level1|Level2| Name     | Units    | Description                              |Discp|Catgy|Param|Level|<br>-----+------+------+------+----------+----------+------------------------------------------+-----------------------+<br> 129 | 100  |   *  |      | HGT      | m        | Height                                   |  0  |  3  |  5  | 100 |<br> 130 | 100  |   *  |      | TT       | K        | Temperature                              |  0  |  0  |  0  | 100 |<br> 131 | 100  |   *  |      | UU       | m s-1    | U                                        |  0  |  2  |  2  | 100 |<br> 132 | 100  |   *  |      | VV       | m s-1    | V                                        |  0  |  2  |  3  | 100 |<br> 157 | 100  |   *  |      | RH       | %        | Relative Humidity                        |  0  |  1  |  1  | 100 |<br> 165 |  1   |   0  |      | UU       | m s-1    | U                 at 10 m                |  0  |  2  |  2  | 103 |<br> 166 |  1   |   0  |      | VV       | m s-1    | V                 at 10 m                |  0  |  2  |  3  | 103 |<br> 167 |  1   |   0  |      | TT       | K        | Temperature       at  2 m                |  0  |  0  |  0  | 103 |<br> 168 |  1   |   0  |      | DEWPT    | K        |                                          |  0  |  0  |  6  | 103 |<br>     |  1   |   0  |      | RH       | %        | Relative Humidity at 2 m                 |  0  |  1  |  1  | 103 |<br> 172 |  1   |   0  |      | LANDSEA  | 0/1 Flag | Land/Sea flag (1=land, 0 or 2=sea)       |  2  |  0  |  0  |   1 |<br> 134 |  1   |   0  |      | PSFC     | Pa       | Surface Pressure                         |  0  |  3  |  0  |   1 |<br> 151 |  1   |   0  |      | PMSL     | Pa       | Sea-level Pressure                       |  0  |  3  |  0  | 101 |<br> 235 |  1   |   0  |      | SKINTEMP | K        | Skin temperature                         |  0  |  0  | 17  |   1 |<br>  18 | 112  |   0  |   7  | ST000007 | K        | T of 0-7 cm  ground layer                |  2  |  3  |  18 | 151 | <br>  18 | 112  |   7  |  28  | ST007028 | K        | T of 7-28 cm ground layer                |  2  |  3  |  18 | 151 | <br>  18 | 112  |  28  | 100  | ST028100 | K        | T of 28-100 cm ground layer              |  2  |  3  |  18 | 151 | <br>  18 | 112  | 100  | 289  | ST100289 | K        | T of 100-289 cm ground layer             |  2  |  3  |  18 | 151 | <br>  25 | 112  |   0  |   7  | SM000007 | m3 m-3   | Soil moisture of 0-7 cm ground layer     |  2  |  0  |  25 | 151 | <br>  25 | 112  |   7  |  28  | SM007028 | m3 m-3   | Soil moisture of 7-28 cm ground layer    |  2  |  0  |  25 | 151 | <br>  25 | 112  |  28  | 100  | SM028100 | m3 m-3   | Soil moisture of 28-100 cm ground layer  |  2  |  0  |  25 | 151 | <br>  25 | 112  | 100  | 289  | SM100289 | m3 m-3   | Soil moisture of 100-289 cm ground layer |  2  |  0  |  25 | 151 | <br>-----+------+------+------+----------+---------+-----------------------------------------+-------------------------+<br>#<br></code></pre></td></tr></table></figure>        </div>      </div>    </div><h4 id="vtable.ecmwf_grib2vtable.ecmwf">Vtable.ECMWF_GRIB2/Vtable.ECMWF</h4><figure class="highlight console"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs console">-rw-rw-r-- 1 wpsze wpsze 321M Apr  1 16:27 ERA5:2025-03-26_00-ECMWF_GRIB2<br>-rw-rw-r-- 1 wpsze wpsze 286M Apr  1 14:26 ERA5:2025-03-26_00-Vtable.ECMWF<br></code></pre></td></tr></table></figure><ul><li>The intermediate file (ERA5.xxx) by Vtable.ECMWF_GRIB2 is larger file size than that of Vtable.ECMWF</li><li>ERA5.xxx by Vtable.ECMWF is fail in init_atmosphere_model step.</li></ul><h3 id="init_atmosphere_model">init_atmosphere_model</h3><h4 id="error">Error</h4><ul><li>MPASv7.3 init_atmosphere_model</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs log">ERROR: extrap_type == 2 not implemented for target_z &gt;= zf(1,nz)<br>ERROR: *****************************************************************<br>ERROR: Error in interpolation of t(k,iCell) for k=  46, iCell=         1<br>CRITICAL ERROR: ********************************************************<br></code></pre></td></tr></table></figure><ul><li>set 'linear',</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs namelist">&amp;interpolation_control<br>    config_extrap_airtemp = &#x27;linear&#x27;<br>/<br></code></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs log">CRITICAL ERROR: Error in interpolation of st_fg to MPAS grid: num_st = 27244<br></code></pre></td></tr></table></figure><ul><li><a href="https://forum.mmm.ucar.edu/threads/error-creating-initial-conditions-with-ncep-fnl-ds083-2.17113/">Error creating initial conditions with NCEP FNL ds083.2 | May 8, 2024</a><ul><li>I'm trying to create the initial conditions file for MPAS (v8.1) using data obtained from the NCEP FNL ds083.2</li><li>Just had to change <code>config_nfgsoillevels</code> to <strong>2</strong> and <code>config_extrap_airtemp</code> to <strong>linear</strong> in <code>namelist.init_atmosphere</code>. Once those two modifications were made <code>init_atmosphere_model</code> and <code>atmosphere_model</code> ran without issues.</li><li>Note that <strong>FNL data only contains 2-level of soil information</strong>, which is why we need to set <strong>config_nfgsoillevels=2</strong>. <strong>The top of the FNL data is 10 hpa, and therefore extrapolation is needed if MPAS top level is above 10 hpa</strong>.</li><li>For the option of <code>config_extrap_airtemp</code>, would you please let me know what is the model top of your MPAS run? Thanks.</li></ul></li><li><a href="https://forum.mmm.ucar.edu/threads/initial-condition-critical-error-error-in-interpolation-of-st_fg-to-mpas.15807/">Initial condition CRITICAL ERROR: Error in interpolation of st_fg to MPAS | Feb 16, 2024</a></li><li><a href="https://forum.mmm.ucar.edu/threads/error-in-interpolation-of-st_fg-to-mpas-grid-with-variable-resolution-mesh-simulation.9387/">'Error in interpolation of st_fg to MPAS grid' with variable-resolution mesh simulation | Jul 23, 2020</a><ul><li>The error message generally indicates that there are grid cells that have a soil temperature value less than or equal to zero.</li><li>I solved the problem by downloading the "Vtable from the RDR page/WRF" and using WPS version 4.0 or higher.</li></ul></li><li><a href="https://forum.mmm.ucar.edu/threads/critical-error-error-in-interpolation-of-st_fg-to-mpas-grid.5382/">CRITICAL ERROR: Error in interpolation of st_fg to MPAS grid | Start dateMay 3, 2019</a><ul><li>This error message is an indication that there were one or more points in the MPAS mesh that received a zero or negative value for soil temperature.</li><li>Can you also verify that there are soil moisture and soil temperature fields in your WPS intermediate file, and that the number of soil levels in your intermediate files matches the value of the config_nfgsoillevels in your namelist.init_atmosphere file?</li></ul></li><li><a href="https://forum.mmm.ucar.edu/threads/critical-error-error-in-interpolation-of-st_fg-to-mpas-grid-num_st-18642.12857/">CRITICAL ERROR: Error in interpolation of st_fg to MPAS grid: num_st = 18642 | Apr 12, 2023</a><ul><li><strong>MPAS can only process soil data at specific levels with specific field names. If your input soil data are on levels or with names unrecognized by MPAS, then it won't work</strong>.</li><li>Please take a look at the code <strong>"mpas_init_atm_cases.F"</strong>, and the lines 3908 - 4118 process soil temperature data. This might give you some idea how MPAS works.</li></ul></li><li><a href="https://forum.mmm.ucar.edu/threads/trying-to-use-rap-as-ic-bc.5549/">Trying to Use RAP as IC/BC | Start dateJun 26, 2019</a><ul><li>The message "Error in interpolation of st_fg to MPAS grid: num_st = XXXX" is <strong>generally indicative of an issue with the soil temperature</strong>. Would it be possible to use some of the utilities that come with the WRF Pre-processing System (WPS) to check that there are valid soil temperature data in your intermediate file? Specifically, you could use the "<code>rd_intermediate</code>" utility to check that there are fields named, e.g., ST000010, and you could use the "<code>int2nc</code>" utility to convert the intermediate file to netCDF format, where it would be easier to view the soil fields with, e.g., <code>ncview</code>.</li></ul></li><li><strong>Use WPSv4.6 with above renewed Vtable and rd_grib2.F</strong></li></ul><h4 id="one-more-issue-資料集可用性-2024-11-12t120000z2025-04-16t120000z">One more issue, 資料集可用性 2024-11-12T12:00:00Z–2025-04-16T12:00:00Z</h4><ul><li><strong>資料集可用性 2024-11-12T12:00:00Z–2025-04-16T12:00:00Z</strong></li><li>The grib files from <code>ecmwf.ini</code> and from <code>aws</code> are different. It will make different/debug on the <code>ungrib</code> step and <code>init_atmosphere_model</code> step.<ul><li>Not all different.</li></ul></li></ul><p>It is because,</p><ul><li><a href="https://developers.google.com/earth-engine/datasets/catalog/ECMWF_NRT_FORECAST_IFS_OPER?hl=zh-TW">ECMWF Near-Realtime IFS Atmospheric Forecasts | Earth Engine Data Catalog</a><ul><li><strong>資料集可用性 2024-11-12T12:00:00Z–2025-04-16T12:00:00Z</strong></li><li><strong>自 2024/11/12 推出Cycle 49r1 以來</strong>，Earth Engine 就會提供產品；早期產品則不包含在內。<ul><li>old one: 145 items</li><li>new one: 160 items</li></ul></li></ul></li><li><a href="https://waipangsze.github.io/2025/04/10/NWP-Herbie-Download-NWP-model-output-MPAS-WRF/#problem" class="uri">https://waipangsze.github.io/2025/04/10/NWP-Herbie-Download-NWP-model-output-MPAS-WRF/#problem</a></li></ul><h1 id="parameter-config_nfglevels">parameter "config_nfglevels"</h1><ul><li><a href="https://forum.mmm.ucar.edu/threads/configuration-problem-for-parameter-config_nfglevels.10690/">configuration problem for parameter "config_nfglevels" | Sep 2, 2021</a><ul><li><strong>If you have 37 isobaric levels of atmospheric data, plus surface fields (u10, v10, t2, etc.), that would give a total of 38 levels</strong> from the perspective of the init_atmosphere_model program. As the error message states, config_nfglevels <strong>must therefore be set to at least 38</strong> -- so value of 38, 39, 40, 41, etc. should all work.</li><li>Internally, the 'config_nfglevels' namelist option is used by the init_atmosphere_model program to allocate 3-d arrays to hold the horizontally interpolated first-guess ("fg" in the config_nfglevels name) fields. Allocating too few vertical levels in these 3-d arrays is problematic, but allocating extra levels -- which will simply go unused -- isn't a problem, though it does waste memory.</li></ul></li></ul><h4 id="done">Done</h4><figure class="highlight console"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs console">MPAS-120km_2022063000.init.nc<br></code></pre></td></tr></table></figure><p>and MPASv7.3 runs (./atmosphere_model) with IFS successfully as well (<strong>both with Vtable.ECMWF_GRIB2 above</strong>).</p><h1 id="cronjob">cronjob</h1><p>For <code>00z</code>,</p>    <div class="fold">      <div class="fold-title fold-info collapsed" data-toggle="collapse" href="#collapse-c21ca059" role="button" aria-expanded="false" aria-controls="collapse-c21ca059">        <div class="fold-arrow">▶</div>wpsze_download_IFS-cronjob-00z.sh      </div>      <div class="fold-collapse collapse" id="collapse-c21ca059">        <div class="fold-content">          <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-meta">#!/bin/sh</span><br><span class="hljs-comment">#################################################################</span><br><span class="hljs-comment"># https://data.ecmwf.int/ecpds/home/opendata/20250402/00z/ifs/0p25/oper/20250402000000-0h-oper-fc.grib2</span><br><span class="hljs-comment">#################################################################</span><br><span class="hljs-built_in">source</span> /home/wpsze/micromamba/etc/profile.d/micromamba.sh<br>micromamba activate venv<br><br>BASE_DIR=$(<span class="hljs-built_in">pwd</span>)<br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;Base Dir = <span class="hljs-variable">$&#123;BASE_DIR&#125;</span>&quot;</span><br><br><span class="hljs-keyword">for</span> ifsday <span class="hljs-keyword">in</span> $(<span class="hljs-built_in">seq</span> 0 1 3); <span class="hljs-keyword">do</span> <span class="hljs-comment"># day-shift = 0, 1, 2, 3</span><br><br>    YYYYMMDDHH=$(<span class="hljs-built_in">date</span> -d <span class="hljs-string">&quot;today - <span class="hljs-variable">$&#123;ifsday&#125;</span> day&quot;</span> +%Y%m%d00)<br><br>    yyyy=<span class="hljs-variable">$&#123;YYYYMMDDHH:0:4&#125;</span><br>    mm=<span class="hljs-variable">$&#123;YYYYMMDDHH:4:2&#125;</span><br>    <span class="hljs-built_in">dd</span>=<span class="hljs-variable">$&#123;YYYYMMDDHH:6:2&#125;</span><br>    hh=<span class="hljs-variable">$&#123;YYYYMMDDHH:8:2&#125;</span><br><br>    yyyymm=<span class="hljs-variable">$&#123;yyyy&#125;</span><span class="hljs-variable">$&#123;mm&#125;</span><br>    yyyymmdd=<span class="hljs-variable">$&#123;yyyy&#125;</span><span class="hljs-variable">$&#123;mm&#125;</span><span class="hljs-variable">$&#123;dd&#125;</span><br><br>    tmp_dir=<span class="hljs-string">&quot;./<span class="hljs-variable">$&#123;yyyy&#125;</span><span class="hljs-variable">$&#123;mm&#125;</span>/<span class="hljs-variable">$&#123;yyyy&#125;</span><span class="hljs-variable">$&#123;mm&#125;</span><span class="hljs-variable">$&#123;dd&#125;</span>&quot;</span><br>    <span class="hljs-built_in">mkdir</span> -p <span class="hljs-variable">$&#123;tmp_dir&#125;</span><br>    <span class="hljs-built_in">cd</span> <span class="hljs-variable">$&#123;tmp_dir&#125;</span><br>    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;Current Dir: <span class="hljs-subst">$(pwd)</span>&quot;</span><br><br>    limit_cpu_core=15<br>    count_cpu_core=1<br><br>    <span class="hljs-comment">#============== 00z ===================================</span><br>    tmp_ifs_fname=<span class="hljs-string">&quot;<span class="hljs-variable">$&#123;YYYYMMDDHH&#125;</span>0000-0h-oper-fc.grib2&quot;</span><br><br>    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;Now, <span class="hljs-variable">$&#123;tmp_ifs_fname&#125;</span> ... &quot;</span><br><br>    <span class="hljs-keyword">if</span> [[ ! -f <span class="hljs-string">&quot;<span class="hljs-variable">$&#123;tmp_ifs_fname&#125;</span>&quot;</span> ]]; <span class="hljs-keyword">then</span><br>    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;Downloading ... <span class="hljs-variable">$&#123;tmp_ifs_fname&#125;</span>&quot;</span><br>    <span class="hljs-comment">#wget --no-check-certificate https://data.ecmwf.int/forecasts/$&#123;yyyy&#125;$&#123;mm&#125;$&#123;dd&#125;/00z/ifs/0p25/oper/$&#123;tmp_ifs_fname&#125;</span><br>    wget --no-check-certificate https://data.ecmwf.int/ecpds/home/opendata/<span class="hljs-variable">$&#123;yyyy&#125;</span><span class="hljs-variable">$&#123;mm&#125;</span><span class="hljs-variable">$&#123;dd&#125;</span>/00z/ifs/0p25/oper/<span class="hljs-variable">$&#123;tmp_ifs_fname&#125;</span><br>    <span class="hljs-keyword">else</span><br>        <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;<span class="hljs-variable">$&#123;tmp_ifs_fname&#125;</span> exists ... &quot;</span><br>    <span class="hljs-keyword">fi</span><br><br>    res=$(( <span class="hljs-variable">$&#123;count_cpu_core&#125;</span> % <span class="hljs-variable">$&#123;limit_cpu_core&#125;</span> ))<br>    <span class="hljs-keyword">if</span> [[ <span class="hljs-variable">$&#123;res&#125;</span> == 0 ]]; <span class="hljs-keyword">then</span><br>    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;please wait <span class="hljs-variable">$&#123;tmp_ifs_fname&#125;</span>, <span class="hljs-variable">$&#123;count_cpu_core&#125;</span>, <span class="hljs-variable">$&#123;res&#125;</span>.&quot;</span><br>    <span class="hljs-built_in">wait</span><br>    <span class="hljs-keyword">fi</span><br>    <br>    <span class="hljs-built_in">cd</span> <span class="hljs-variable">$&#123;BASE_DIR&#125;</span><br><span class="hljs-keyword">done</span>    <br></code></pre></td></tr></table></figure>        </div>      </div>    </div><h2 id="dissemination-schedule">Dissemination schedule</h2><figure><img src="https://i.imgur.com/j5aMuFL.png" alt="Time available (UTC)" width="400" /><figcaption>Time available (UTC)</figcaption></figure><ul><li><strong>HKT = UTC + 8</strong></li><li>How to set the crontab: <code>$ crontab -e</code></li></ul><figure class="highlight console"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs console"><span class="hljs-meta prompt_">$ </span><span class="language-bash">crontab -l</span><br>30 17 * * * cd /home/wpsze/mpas/IFS; sh wpsze_download_IFS-cronjob-00z.sh <br></code></pre></td></tr></table></figure><h1 id="references">References</h1><ol type="1"><li><a href="https://www.ecmwf.int/en/about/media-centre/news/2024/ecmwf-releases-much-larger-open-dataset">ECMWF releases a much larger open dataset | 29 February 2024</a></li><li><a href="https://www.ecmwf.int/en/forecasts/datasets/open-data">Open data | ECMWF real-time forecast data</a></li><li><a href="https://mp.weixin.qq.com/s/Fgmgjk1_bJdmLWQfttuT0g">ECMWF IFS 免费开放预报升级到 0.25° 分辨率 | 2024年02月26日</a></li><li><a href="https://mp.weixin.qq.com/s/keUhCa-y7xLj6I_xNfJcCw">重大升级！欧洲中期天气预报中心AI加持下免费开放了更高分辨率、更多参数的气象数据！| 2024年03月01日</a></li></ol>]]></content>
    
    
    <categories>
      
      <category>NWP</category>
      
    </categories>
    
    
    <tags>
      
      <tag>WRF</tag>
      
      <tag>WPS</tag>
      
      <tag>MPAS</tag>
      
      <tag>IC/BC</tag>
      
      <tag>ECMWF</tag>
      
      <tag>IFS</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>WRF | topo-wind</title>
    <link href="/2024/11/02/wrf-topo-wind/"/>
    <url>/2024/11/02/wrf-topo-wind/</url>
    
    <content type="html"><![CDATA[<h1 id="introduction">Introduction</h1><ul><li>The Developmental Testbed Center WRFv3.4.1+ Surface Drag Parameterization Sensitivity Test Plan Points of Contact: Hongli Jiang, Michelle Harrold and Jamie Wolff November 28, 2012</li></ul><p>It is widely acknowledged that the Weather Research and Forecasting (WRF) model has a high surface wind speed bias, especially over plains and valleys. In recent versions of WRF, two new surface drag parameterization schemes, <strong>both associated with the Yonsei University (YSU) planetary boundary layer (PBL) scheme</strong>, have been developed. The Developmental Testbed Center (DTC) will be performing testing and evaluation of three WRF model configurations with the Advanced Research WRF (ARW) core (Skamarock et al. 2008). The baseline configuration will be run with the physics suite being used in the ARW High-Resolution Window (HIRESW) forecast system being run operationally at the National Centers for Environmental Prediction (NCEP). The two comparative configurations will be testing the effects of the surface drag parameterization scheme namelist option, topo_wind, which aims to correct the high wind bias seen in WRF. One configuration will be run with <strong>topo_wind=1 (TWIND1; Jimenez and Dudhia 2011)</strong>, which is based on the concept of a momentum sink term and makes use of the standard deviation of the subgrid-scale orography as well as the Laplacian of the topographic field. The second configuration will be run with <strong>topo_wind=2 (TWIND2; Mass and Ovens 2012)</strong>, which determines the subgrid terrain variance and makes the surface drag or roughness used in the model dependent on it; it also includes additional consideration for stability and wind speed. The baseline configuration will have <strong>topo_wind=0 (turned off)</strong>. These runs will be cold start cases initialized every 36 hours and run out to 48 hours for one full year.</p><p>The Weather Research and Forecasting (WRF)model (Skamarock et al. 2008) has presented a <strong>high surface wind speed bias over land</strong> since the early versions of the model (Cheng and Steenburgh 2005). The bias still persists in more recent versions (e.g., Bernardet et al. 2005; Roux et al. 2009; Mass and Ovens 2010, 2011) and represents a limitation for the high demand of accurate surface wind estimations by different sectors such as wind-energy applications or air-quality studies.</p><ul><li>The wind speed is higher in plains and valleys,</li><li>The wind speed is lower in mountains and hills.</li></ul><p>WRF模式對風速變化趨勢模擬較好，但是風速值偏差較大，主要是因為 WRF 沒有對次網格地形阻力進行參數化，致使</p><div class="note note-primary">            <ul><li>平原和山谷風速偏大，</li><li>高山和丘陵風速偏小。</li></ul>          </div><p>從WRFv3.4開始，WRF提供了與YSU PBL方案相關聯的TopoWind模式，以改善地形對近地面風的影響。 YSU PBL方案共有三種方案：</p><ul><li>topo_wind = 0，在近地面風計算中不包括TopoWind模式的附加地形效應；</li><li>topo_wind = 1，將亞柵格尺度地形的標準差納入近地面風計算；</li><li>topo_wind = 2，採用與topowind = 1 相同的方法計算近地面風，但同時透過加入亞格點地形變化加強了摩擦速度的計算。</li></ul><h1 id="wrf">WRF</h1><ul><li>topo-wind=1 → varsso (Jimenez 2011)</li><li>topo-wind=2 → var/var2d (Mass 2012)</li></ul><p>and geog data,</p><ul><li>varsso=0.924km (0.5m)</li><li>varsso_2m=3.7km</li><li>varsso_5m=9.25km</li><li>varsso_10m=18.5km</li></ul><h1 id="jiménez-2011">Jiménez 2011</h1><ul><li>Jiménez, P. A., &amp; Dudhia, J. (2012). Improving the representation of resolved and unresolved topographic effects on surface wind in the WRF model. Journal of Applied Meteorology and Climatology, 51(2), 300-316.<ul><li>The proposed parameterization is based on the concept of a momentum sink term and makes use of the <strong>standard deviation of the subgrid-scale orography</strong> as well as the <strong>Laplacian of the topographic field</strong>.</li><li>u = stands for the zonal wind component <strong>at the first model level</strong></li><li>Figure 4 shows the <strong>standard deviation of the subgrid-scale orography</strong> <span class="math inline">\(\sigma_{sso}\)</span> within each grid cell (2 km). The standard deviation provides an idea of the variability and, thus, the complexity of the terrain.</li></ul></li></ul><p><img src="https://i.imgur.com/JrR5M9h.png" alt="The differentiation has been accomplished by applying the following operator to the topographic field h" width="600" /> <img src="https://i.imgur.com/3r4P6Uh.png" width="600" /> <img src="https://i.imgur.com/1lSVGvw.png" width="600" /> <img src="https://i.imgur.com/4F3m0BK.png" width="600" /></p><h1 id="mass-and-ovens-2012">Mass and Ovens 2012</h1><p>topo_wind=2 (TWIND2; Mass and Ovens 2012)</p><ul><li>Fixing WRF's High Speed Wind Bias: A New Subgrid Scale Drag Parameterization and the Role of Detailed Verification (91st American Meteorological Society Annual Meeting)<ul><li><a href="https://ams.confex.com/ams/91Annual/webprogram/Paper180011.html" class="uri">https://ams.confex.com/ams/91Annual/webprogram/Paper180011.html</a></li></ul></li><li><a href="https://www2.mmm.ucar.edu/wrf/users/workshops/WS2010/presentations/session%204/4-1_WRFworkshop2010Final.pdf" class="uri">https://www2.mmm.ucar.edu/wrf/users/workshops/WS2010/presentations/session%204/4-1_WRFworkshop2010Final.pdf</a></li></ul><h1 id="wrf-code">WRF code</h1><ul><li>WRF/dyn_em/start_em.F</li></ul><figure class="highlight fortran"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><code class="hljs fortran"><span class="hljs-comment">!</span><br><span class="hljs-comment">! paj: computes ct and ct2 for topo_wind</span><br><span class="hljs-comment">!</span><br>       grid%ctopo=<span class="hljs-number">1.</span><br>       grid%ctopo2=<span class="hljs-number">1.</span><br><span class="hljs-comment">!</span><br>       <span class="hljs-keyword">if</span> (config_flags%topo_wind.eq<span class="hljs-number">.1</span>) <span class="hljs-keyword">then</span><br>         <span class="hljs-keyword">DO</span> j = jts,<span class="hljs-built_in">min</span>(jte,jde-<span class="hljs-number">1</span>)<br>         <span class="hljs-keyword">DO</span> i = its, <span class="hljs-built_in">min</span>(ite,ide-<span class="hljs-number">1</span>)<br>            <span class="hljs-keyword">if</span>(grid%xland(i,j).lt<span class="hljs-number">.1</span><span class="hljs-number">.5</span>)grid%ctopo(i,j)=<span class="hljs-built_in">sqrt</span>(grid%var_sso(i,j))<br>            <span class="hljs-keyword">if</span> (grid%ctopo(i,j).le<span class="hljs-number">.2</span><span class="hljs-number">.718</span>) <span class="hljs-keyword">then</span><br>            grid%ctopo(i,j)=<span class="hljs-number">1.</span><br>            <span class="hljs-keyword">else</span><br>            grid%ctopo(i,j)=<span class="hljs-built_in">alog</span>(grid%ctopo(i,j))<br>            <span class="hljs-keyword">endif</span><br><span class="hljs-comment">!</span><br>            <span class="hljs-keyword">if</span> (grid%lap_hgt(i,j)<span class="hljs-keyword">.gt.</span>-<span class="hljs-number">10.</span>) <span class="hljs-keyword">then</span><br>              grid%ctopo(i,j)=grid%ctopo(i,j)<br>            <span class="hljs-keyword">else</span><br>               <span class="hljs-keyword">if</span> (grid%lap_hgt(i,j)<span class="hljs-keyword">.ge.</span>-<span class="hljs-number">20</span>) <span class="hljs-keyword">then</span><br>                 alpha=(grid%lap_hgt(i,j)+<span class="hljs-number">20.</span>)/<span class="hljs-number">10.</span><br>                 grid%ctopo(i,j)=alpha*grid%ctopo(i,j)+(<span class="hljs-number">1</span>-alpha)<br>               <span class="hljs-keyword">else</span><br>                  <span class="hljs-keyword">if</span> (grid%lap_hgt(i,j)<span class="hljs-keyword">.ge.</span>-<span class="hljs-number">30.</span>) <span class="hljs-keyword">then</span><br>                  grid%ctopo(i,j)=(grid%lap_hgt(i,j)+<span class="hljs-number">30.</span>)/<span class="hljs-number">10.</span><br>                  grid%ctopo2(i,j)=(grid%lap_hgt(i,j)+<span class="hljs-number">30.</span>)/<span class="hljs-number">10.</span><br>                  <span class="hljs-keyword">else</span><br>                  grid%ctopo(i,j)=<span class="hljs-number">0.</span><br>                  grid%ctopo2(i,j)=<span class="hljs-number">0.</span><br>                  <span class="hljs-keyword">endif</span><br>               <span class="hljs-keyword">endif</span><br>            <span class="hljs-keyword">endif</span><br>         <span class="hljs-keyword">ENDDO</span><br>         <span class="hljs-keyword">ENDDO</span><br><span class="hljs-comment">!       if topo_wind==2 (D.Ovens, C.Mass)</span><br>       <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (config_flags%topo_wind.eq<span class="hljs-number">.2</span>) <span class="hljs-keyword">then</span><br>         <span class="hljs-keyword">DO</span> j = jts,<span class="hljs-built_in">min</span>(jte,jde-<span class="hljs-number">1</span>)<br>         <span class="hljs-keyword">DO</span> i = its, <span class="hljs-built_in">min</span>(ite,ide-<span class="hljs-number">1</span>)<br>           <span class="hljs-keyword">if</span> (grid%xland(i,j).lt<span class="hljs-number">.1</span><span class="hljs-number">.5</span>) <span class="hljs-keyword">then</span><br>              vfac = <span class="hljs-built_in">amin1</span>(<span class="hljs-number">1.575</span>,(grid%var2d(i,j)*<span class="hljs-number">0.4</span>/<span class="hljs-number">200.</span>+<span class="hljs-number">1.175</span>))<br>              vfac = vfac * vfac<br>           <span class="hljs-keyword">else</span>                      <span class="hljs-comment">! over water, leave it alone</span><br>              vfac = <span class="hljs-number">1.</span><br>           <span class="hljs-keyword">endif</span><br><span class="hljs-comment">!          print *, j,i,grid%ctopo(i,j),vfac</span><br>           grid%ctopo(i,j)=grid%ctopo(i,j)*vfac<br>         <span class="hljs-keyword">ENDDO</span><br>         <span class="hljs-keyword">ENDDO</span><br>       <span class="hljs-keyword">endif</span><br></code></pre></td></tr></table></figure><ul><li>Versions of WPS prior to V3.4 did not include VAR_SSO static data. This is necessary for running the topo_wind option in WRF (also introduced in version 3.4). <a href="https://github.com/wrf-model/WRF/pull/10">link</a></li><li>Remark, <strong>ctopo2 = 1</strong> in topo_wind2.</li></ul><div class="note note-primary">            <p>u10, v10 (no modify in topo_wind=2)<br />Modify u10, v10 ⇒ Effective in topo_wind=1 only<br />In topo_wind=2, No Modify u10, v10</p>          </div><h2 id="convective-velocity-and-pbl-height">convective velocity and PBL height</h2><ul><li><a href="https://github.com/wrf-model/WRF/pull/116" class="uri">https://github.com/wrf-model/WRF/pull/116</a></li><li><strong>WRFv3.8.1 and before, don't consider convective velocity and PBL height</strong></li><li>It is found that this scheme can improve the simulated surface winds, especially at night, <strong>but it can underestimate the winds during daytime.</strong><ul><li>Lorente-Plazas, R., Jiménez, P. A., Dudhia, J., &amp; Montávez, J. P. (2016). Evaluating and Improving the Impact of the Atmospheric Stability and Orography on Surface Winds in the WRF Model. Monthly Weather Review, 144(7), 2685-2693. <a href="https://doi.org/10.1175/MWR-D-15-0449.1" class="uri">https://doi.org/10.1175/MWR-D-15-0449.1</a></li><li><a href="https://journals.ametsoc.org/view/journals/mwre/144/7/mwr-d-15-0449.1.xml" class="uri">https://journals.ametsoc.org/view/journals/mwre/144/7/mwr-d-15-0449.1.xml</a></li></ul></li><li>In the daytime,<ul><li>if higher PBLH, then consider less ctopo effect</li><li>new_topo ~ off_ctopo in daytime</li></ul></li><li>Uses convective velocity and PBL height to determine instability</li><li>Extra code is added to compute tke, hybrid PBL height and convective velocity within the YSU PBL</li></ul><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs text">TYPE: enhancement<br><br>KEYWORDS: topo_wind=1, diurnal cycle improvement, YSU PBL only<br><br>SOURCE: internal + Raquel Lorente (formerly RAL) and Pedro Jimenez (RAL)<br><br>PURPOSE: To improve diurnal behavior of surface wind when topo_wind=1 is<br>activated. This replaces the topo_wind=1 and is not a new option.<br><br>DESCRIPTION OF CHANGES:<br><br>Follows paper Lorente-Plazas et al. (2016, MWR) by decreasing effects of<br>topo_wind=1 option when unstable boundary-layer conditions prevail. Uses<br>convective velocity and PBL height to determine instability. PBL height uses a<br>hybrid tke-theta method copied from the MYNN PBL, but for YSU tke is computed<br>diagnostically.<br>Extra code is added to compute tke, hybrid PBL height and convective velocity<br>within the YSU PBL, so this is the only module affected.<br><br>LIST OF MODIFIED FILES :<br><br>M phys/module_bl_ysu.F<br></code></pre></td></tr></table></figure><h2 id="module_bl_ysu.f">module_bl_ysu.F</h2><ul><li><p><a href="https://github.com/wrf-model/WRF/blob/v4.5/phys/module_bl_ysu.F" class="uri">https://github.com/wrf-model/WRF/blob/v4.5/phys/module_bl_ysu.F</a></p></li><li><p>! paj: ctopo=1 if topo_wind=0 (default)</p></li></ul><figure class="highlight fortran"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs fortran"><span class="hljs-keyword">real</span>(<span class="hljs-keyword">kind</span>=kind_phys),     <span class="hljs-keyword">dimension</span>( its: )                               , &amp;<br>          <span class="hljs-keyword">optional</span>                                                        , &amp;<br>          <span class="hljs-keyword">intent</span>(<span class="hljs-keyword">in</span>   )   ::                                         ctopo, &amp;<br>                                                                    ctopo2<br></code></pre></td></tr></table></figure><figure class="highlight fortran"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs fortran"><span class="hljs-comment">!--- end of paj tke</span><br><span class="hljs-comment">! compute vconv</span><br><span class="hljs-comment">!      Use Beljaars over land</span><br>        <span class="hljs-keyword">if</span> (xland(i).lt<span class="hljs-number">.1</span><span class="hljs-number">.5</span>) <span class="hljs-keyword">then</span><br>        fluxc = <span class="hljs-built_in">max</span>(sflux(i),<span class="hljs-number">0.0</span>)<br>        vconvc=<span class="hljs-number">1.</span><br>        VCONV = vconvc*(g/thvx(i,<span class="hljs-number">1</span>)*pblh_ysu(i)*fluxc)**<span class="hljs-number">.33</span><br>        <span class="hljs-keyword">else</span><br><span class="hljs-comment">! for water there is no topo effect so vconv not needed</span><br>        VCONV = <span class="hljs-number">0.</span><br>        <span class="hljs-keyword">endif</span><br>        vconvfx(i) = vconv<br><span class="hljs-comment">!raquel</span><br><span class="hljs-comment">!ctopo stability correction</span><br>      fric(i,<span class="hljs-number">1</span>)=ust(i)**<span class="hljs-number">2</span>/wspd1(i)*rhox(i)*g/del(i,<span class="hljs-number">1</span>)*dt2         &amp;<br>        *(wspd1(i)/wspd(i))**<span class="hljs-number">2</span><br>      <span class="hljs-keyword">if</span>(<span class="hljs-built_in">present</span>(ctopo)) <span class="hljs-keyword">then</span><br>        vconvnew=<span class="hljs-number">0.9</span>*vconvfx(i)+<span class="hljs-number">1.5</span>*(<span class="hljs-built_in">max</span>((pblh_ysu(i)-<span class="hljs-number">500</span>)/<span class="hljs-number">1000.0</span>,<span class="hljs-number">0.0</span>))<br>        vconvlim = <span class="hljs-built_in">min</span>(vconvnew,<span class="hljs-number">1.0</span>)<br>        ad(i,<span class="hljs-number">1</span>) = <span class="hljs-number">1.</span>+fric(i,<span class="hljs-number">1</span>)*vconvlim+ctopo(i)*fric(i,<span class="hljs-number">1</span>)*(<span class="hljs-number">1</span>-vconvlim)<br>        ad(i,<span class="hljs-number">1</span>) = ad(i,<span class="hljs-number">1</span>) - bepswitch*frc_urb1d(i)* &amp;<br>                     (fric(i,<span class="hljs-number">1</span>)*vconvlim+ctopo(i)*fric(i,<span class="hljs-number">1</span>)*(<span class="hljs-number">1</span>-vconvlim))<br><span class="hljs-comment">!       ad(i,1) = 1.+(1.-bepswitch*frc_urb1d(i))* &amp;</span><br><span class="hljs-comment">!                    (fric(i,1)*vconvlim+ctopo(i)*fric(i,1)*(1-vconvlim))</span><br>      <span class="hljs-keyword">else</span><br>        ad(i,<span class="hljs-number">1</span>) = <span class="hljs-number">1.</span>+fric(i,<span class="hljs-number">1</span>)<br>      <span class="hljs-keyword">endif</span><br>     f1(i,<span class="hljs-number">1</span>) = ux(i,<span class="hljs-number">1</span>)+uoxl(i)*ust(i)**<span class="hljs-number">2</span>*rhox(i)*g/del(i,<span class="hljs-number">1</span>)*dt2/wspd1(i)*(wspd1(i)/wspd(i))**<span class="hljs-number">2</span><br>     f2(i,<span class="hljs-number">1</span>) = vx(i,<span class="hljs-number">1</span>)+voxl(i)*ust(i)**<span class="hljs-number">2</span>*rhox(i)*g/del(i,<span class="hljs-number">1</span>)*dt2/wspd1(i)*(wspd1(i)/wspd(i))**<span class="hljs-number">2</span><br>   <span class="hljs-keyword">enddo</span><br></code></pre></td></tr></table></figure><ul><li>ux=u3d(ims,kms,j),vx=v3d(ims,kms,j)</li></ul><figure class="highlight fortran"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs fortran"><span class="hljs-comment">!</span><br><span class="hljs-comment">! paj: ctopo2=1 if topo_wind=0 (default)</span><br><span class="hljs-comment">!</span><br>   <span class="hljs-keyword">do</span> i = its,ite<br>     <span class="hljs-keyword">if</span>(<span class="hljs-built_in">present</span>(ctopo)<span class="hljs-keyword">.and.</span><span class="hljs-built_in">present</span>(ctopo2)) <span class="hljs-keyword">then</span> <span class="hljs-comment">! mchen for NMM</span><br>       u10(i) = ctopo2(i)*u10(i)+(<span class="hljs-number">1</span>-ctopo2(i))*ux(i,<span class="hljs-number">1</span>)<br>       v10(i) = ctopo2(i)*v10(i)+(<span class="hljs-number">1</span>-ctopo2(i))*vx(i,<span class="hljs-number">1</span>)<br>     <span class="hljs-keyword">endif</span> <span class="hljs-comment">!mchen</span><br>   <span class="hljs-keyword">enddo</span><br></code></pre></td></tr></table></figure><h1 id="references">References</h1><ol type="1"><li>Topo Wind Intercomparison<ol type="1"><li><a href="https://dtcenter.ucar.edu/eval/meso_mod/topo_wind/" class="uri">https://dtcenter.ucar.edu/eval/meso_mod/topo_wind/</a></li><li>Topo Wind Intercomparsion Test</li><li>Statistically/Practically Significant Table Reports</li><li>Publications<ol type="1"><li>Investigating the impact of surface parameterization schemes available in WRF on surface winds</li><li>Investigating seasonal and regional differences if the WRF-ARW HIRES Window physics suite</li></ol></li></ol></li><li>Lee, J., Shin, H. H., Hong, S. Y., Jiménez, P. A., Dudhia, J., &amp; Hong, J. (2015). Impacts of subgrid‐scale orography parameterization on simulated surface layer wind and monsoonal precipitation in the high‐resolution WRF model. Journal of Geophysical Research: Atmospheres, 120(2), 644-653.<ol type="1"><li>For accurate surface wind simulations, the subgrid-scale (SGS) orography parameterization scheme was employed. It was found that the simulated surface wind showed negative (positive) bias over mountainous (flat) regions when the SGS orography parameterization was excluded.</li><li>After inclusion of the SGS orography parameterization, <strong>wind speed</strong> over mountainous (flat) regions increased (decreased), implying that the bias was mitigated. <strong>Moisture divergence (convergence)</strong> over the mountains (on the leeward side of the mountains) was induced, and <strong>surface latent heat flux</strong> increased along the mountain ranges following the improvement in the representation of the surface wind by the inclusion of the SGS orography parameterization.</li><li>ventually, excessive <strong>precipitation</strong> simulated over mountainous areas of East Asia, which is a feature commonly observed in numerical model studies, was alleviated because of the moisture divergence and increased surface latent heat flux.</li></ol></li><li>Lorente-Plazas, R., Jiménez, P. A., Dudhia, J., &amp; Montávez, J. P. (2016). Evaluating and Improving the Impact of the Atmospheric Stability and Orography on Surface Winds in the WRF Model. Monthly Weather Review, 144(7), 2685-2693. <a href="https://doi.org/10.1175/MWR-D-15-0449.1" class="uri">https://doi.org/10.1175/MWR-D-15-0449.1</a></li><li>杨鹏武, 王学锋, 王麟, &amp; 朱勇. (2016). WRF_TopoWind 模式对中国低纬高原高山风速模拟的适用性研究. 云南大学学报 (自然科学版), 38(5), 766-772.<ol type="1"><li><a href="http://www.yndxxb.ynu.edu.cn/yndxxbzrkxb/en/article/pdf/preview/10.7540/j.ynu.20160060.pdf" class="uri">http://www.yndxxb.ynu.edu.cn/yndxxbzrkxb/en/article/pdf/preview/10.7540/j.ynu.20160060.pdf</a></li></ol></li><li>刘郁珏, 苗世光, 刘磊, 胡非. 修正WRF次网格地形方案及其对风速模拟的影响. 应用气象学报, 2019, 30(1): 70-81.<ol type="1"><li>复杂地形区域风场模拟的准确率一直是风能研究领域的难点和重点。WRF模式是目前风能评估领域应用最广泛的天气数值模式之一，<strong>但该模式在复杂地形区域存在对平原、山谷风速高估且对山顶风速低估的系统性误差</strong>，并有研究建立次网格地形方案以订正误差。而次网格地形方案在不同水平分辨率下常出现错误的修正结果，该文基于高精度地形高程数据分析了方案失效的主要原因，发现其方程组中判断山体形态特征的阈值-20在过低和过高水平分辨率下均失去参考性。针对这一原因，将方案中影响关键参数Ct的地形高度算子与模式水平分辨率进行拟合，形成地形高度算子与水平分辨率相依赖的线性关系，获得不同分辨率下更适合的山体形态阈值。通过与自动气象站10 m风速对比分析了修正前后WRF对低层风速的模拟效果，结果显示：修正后的次网格地形方案能够分别在较低和较高分辨率下，部分矫正原方案错误的订正结果，使低层风速模拟更接近实况。修正后的次网格地形方案可为复杂地形区域开展高分辨率风场模拟提供参考。</li></ol></li></ol>]]></content>
    
    
    <categories>
      
      <category>WRF</category>
      
    </categories>
    
    
    <tags>
      
      <tag>NWP</tag>
      
      <tag>WRF</tag>
      
      <tag>MPAS</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>WRF | WPS | WRFDomainWizard</title>
    <link href="/2024/10/30/WPS-draw-domain-WRFDomainWizard/"/>
    <url>/2024/10/30/WPS-draw-domain-WRFDomainWizard/</url>
    
    <content type="html"><![CDATA[<h1 id="wrf-wrfdomainwizard更简单的确定区域和网格">WRF | WRFDomainWizard：更简单的确定区域和网格</h1><ul><li><a href="https://mp.weixin.qq.com/s/GxUqMWWyKeOXN4DbuSDubQ" class="uri">https://mp.weixin.qq.com/s/GxUqMWWyKeOXN4DbuSDubQ</a></li></ul><p>WRF模拟中目标区域确定后，确定网格数目一直是一个比较烦人的问题，单层网格还好，嵌套网格尤其麻烦（eg. 要确定嵌套网格的数据、不同层网格的起始点等）。因此，本篇向大家介绍一个很好的工具，可以更简单的确定网格的相关参数。</p><p>该工具为：<a href="https://jiririchter.github.io/WRFDomainWizard/" class="uri">https://jiririchter.github.io/WRFDomainWizard/</a></p><p>from <a href="https://github.com/JiriRichter/WRFDomainWizard" class="uri">https://github.com/JiriRichter/WRFDomainWizard</a></p><p>该工具可以在地图上进行手动地勾画，勾画的同时会在左边同时形成相关参数，可以更方便的确定网格的相关参数，可能略有的不足就是只有一些地点名的标识，没有明确的省界、县级等区域边界，具体情况还请自己探索吧。</p><p><img src="https://i.imgur.com/4nQVELM.jpeg" /> <img src="https://i.imgur.com/yRo6vyN.png" /> <img src="https://i.imgur.com/e9Xd5Z3.png" /></p>]]></content>
    
    
    <categories>
      
      <category>WRF</category>
      
    </categories>
    
    
    <tags>
      
      <tag>HPC</tag>
      
      <tag>NWP</tag>
      
      <tag>WRF</tag>
      
      <tag>WPS</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>MPAS | NCL High-resolution coastlines</title>
    <link href="/2024/10/30/NCL-high-resolution-dataset/"/>
    <url>/2024/10/30/NCL-high-resolution-dataset/</url>
    
    <content type="html"><![CDATA[<h1 id="ncl">NCL</h1><h2 id="high-resolution-coastlines">High-resolution coastlines</h2><p>One way to get <strong>high-resolution coastlines</strong> in your NCL maps is by downloading and installing the multi-resolution coastline database RANGS (Regionally Accessible Nested Global Shorelines), developed by Rainer Feistel from Wessel and Smith's GSHHS (Global Self-consistent Hierarchical High-resolution Shoreline) database. Note: do not use the high-resolution database for global data, as you will get streaks across your plot. This database is intended only for regional data.</p><p>NCL also supports <a href="https://www.ncl.ucar.edu/Applications/shapefiles.shtml">shapefiles</a>, if you need to add map outlines that NCL doesn't have.</p><p>To use this database, you must first download it from:</p><ul><li><a href="https://www.io-warnemuende.de/rangs-en.html" class="uri">https://www.io-warnemuende.de/rangs-en.html</a></li></ul><p>On this page you should see a table with ten *.zip files to download:</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs stylus"><span class="hljs-function"><span class="hljs-title">rangs</span><span class="hljs-params">(<span class="hljs-number">0</span>)</span></span><span class="hljs-selector-class">.zip</span>     <span class="hljs-built_in">gshhs</span>(<span class="hljs-number">0</span>)<span class="hljs-selector-class">.zip</span><br><span class="hljs-function"><span class="hljs-title">rangs</span><span class="hljs-params">(<span class="hljs-number">1</span>)</span></span><span class="hljs-selector-class">.zip</span>     <span class="hljs-built_in">gshhs</span>(<span class="hljs-number">1</span>)<span class="hljs-selector-class">.zip</span><br><span class="hljs-function"><span class="hljs-title">rangs</span><span class="hljs-params">(<span class="hljs-number">2</span>)</span></span><span class="hljs-selector-class">.zip</span>     <span class="hljs-built_in">gshhs</span>(<span class="hljs-number">2</span>)<span class="hljs-selector-class">.zip</span><br><span class="hljs-function"><span class="hljs-title">rangs</span><span class="hljs-params">(<span class="hljs-number">3</span>)</span></span><span class="hljs-selector-class">.zip</span>     <span class="hljs-built_in">gshhs</span>(<span class="hljs-number">3</span>)<span class="hljs-selector-class">.zip</span><br><span class="hljs-function"><span class="hljs-title">rangs</span><span class="hljs-params">(<span class="hljs-number">4</span>)</span></span><span class="hljs-selector-class">.zip</span>     <span class="hljs-built_in">gshhs</span>(<span class="hljs-number">4</span>).zip<br></code></pre></td></tr></table></figure><p>You must download all ten of these files, unzip them, and either put them in the directory</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk"><span class="hljs-variable">$NCARG_ROOT</span><span class="hljs-regexp">/lib/</span>ncarg<span class="hljs-regexp">/database/</span>rangs<br></code></pre></td></tr></table></figure><p>like micromamba/envs/venv/lib/ncarg/database/rangs/</p><p>(which NCL will look in by default), or put them somewhere else and set the environment variable NCARG_RANGS to this directory. The files take up <strong>about 140 megabytes</strong>, unzipped.</p><figure class="highlight sml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs sml">xxx/micromamba/envs/venv/lib/ncarg/database/rangs<br>$ ls<br><span class="hljs-symbol">&#x27;gshhs</span>(<span class="hljs-number">0</span>).rim&#x27;  <span class="hljs-symbol">&#x27;gshhs</span>(<span class="hljs-number">2</span>).rim&#x27;  <span class="hljs-symbol">&#x27;gshhs</span>(<span class="hljs-number">4</span>).rim&#x27;  <span class="hljs-symbol">&#x27;rangs</span>(<span class="hljs-number">0</span>).zip&#x27;  <span class="hljs-symbol">&#x27;rangs</span>(<span class="hljs-number">2</span>).cat&#x27;  <span class="hljs-symbol">&#x27;rangs</span>(<span class="hljs-number">3</span>).cel&#x27;  <span class="hljs-symbol">&#x27;rangs</span>(<span class="hljs-number">4</span>).zip&#x27;<br><span class="hljs-symbol">&#x27;gshhs</span>(<span class="hljs-number">0</span>).zip&#x27;  <span class="hljs-symbol">&#x27;gshhs</span>(<span class="hljs-number">2</span>).zip&#x27;  <span class="hljs-symbol">&#x27;gshhs</span>(<span class="hljs-number">4</span>).zip&#x27;  <span class="hljs-symbol">&#x27;rangs</span>(<span class="hljs-number">1</span>).cat&#x27;  <span class="hljs-symbol">&#x27;rangs</span>(<span class="hljs-number">2</span>).cel&#x27;  <span class="hljs-symbol">&#x27;rangs</span>(<span class="hljs-number">3</span>).zip&#x27;<br><span class="hljs-symbol">&#x27;gshhs</span>(<span class="hljs-number">1</span>).rim&#x27;  <span class="hljs-symbol">&#x27;gshhs</span>(<span class="hljs-number">3</span>).rim&#x27;  <span class="hljs-symbol">&#x27;rangs</span>(<span class="hljs-number">0</span>).cat&#x27;  <span class="hljs-symbol">&#x27;rangs</span>(<span class="hljs-number">1</span>).cel&#x27;  <span class="hljs-symbol">&#x27;rangs</span>(<span class="hljs-number">2</span>).zip&#x27;  <span class="hljs-symbol">&#x27;rangs</span>(<span class="hljs-number">4</span>).cat&#x27;<br><span class="hljs-symbol">&#x27;gshhs</span>(<span class="hljs-number">1</span>).zip&#x27;  <span class="hljs-symbol">&#x27;gshhs</span>(<span class="hljs-number">3</span>).zip&#x27;  <span class="hljs-symbol">&#x27;rangs</span>(<span class="hljs-number">0</span>).cel&#x27;  <span class="hljs-symbol">&#x27;rangs</span>(<span class="hljs-number">1</span>).zip&#x27;  <span class="hljs-symbol">&#x27;rangs</span>(<span class="hljs-number">3</span>).cat&#x27;  <span class="hljs-symbol">&#x27;rangs</span>(<span class="hljs-number">4</span>).cel&#x27;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>MPAS</category>
      
    </categories>
    
    
    <tags>
      
      <tag>HPC</tag>
      
      <tag>NWP</tag>
      
      <tag>WRF</tag>
      
      <tag>MPAS</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>MPAS | HPC file system failure or MPI failure</title>
    <link href="/2024/10/29/HPC-file-system-failure/"/>
    <url>/2024/10/29/HPC-file-system-failure/</url>
    
    <content type="html"><![CDATA[<p>When having simulation on new cluster, we have issue about the failure of multiple nodes.</p><ol type="1"><li>node up infinite 2 idle node-[1,2]</li><li>submit by 1 node, it is successful.</li><li>submit by 2 nodes, it hangs.</li><li>node-[1,3] fails as well.</li></ol><p>stops here, no respond and still occupy nodes, <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh">Using io_type Parallel-NetCDF (CDF-5, large variable support) <span class="hljs-keyword">for</span> mesh stream<br>  ** Attempting to bootstrap MPAS framework using stream: input<br></code></pre></td></tr></table></figure></p><p>Or,</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sh">Segmentation fault (signal 11)<br><br>insert_addr_table_roots_only() /build/impi/_buildspace/release/../../src/mpid/ch4/netmod/ofi/ofi_init.c<br></code></pre></td></tr></table></figure><p>Or,</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sh">This requires fcntl(2) to be implemented. As of 8/25/2011 it is not. Generic MPICH Message: File locking failed <span class="hljs-keyword">in</span> ADIOI_GEN_SetLock(fd 1B,cmd F_SETLKW64/7,<span class="hljs-built_in">type</span> F_RDLCK/0,<span class="hljs-built_in">whence</span> 0) with <span class="hljs-built_in">return</span> value FFFFFFFF and errno 26.<br>- If the file system is NFS, you need to use NFS version 3, ensure that the lockd daemon is running on all the machines, and mount the directory with the <span class="hljs-string">&#x27;noac&#x27;</span> option (no attribute caching).<br>- If the file system is LUSTRE, ensure that the directory is mounted with the <span class="hljs-string">&#x27;flock&#x27;</span> option.<br></code></pre></td></tr></table></figure><p>Solution:</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-meta">#!/bin/bash</span><br><br><span class="hljs-built_in">ulimit</span> -s unlimited<br><span class="hljs-built_in">export</span> OMP_STACKSIZE=1G<br><span class="hljs-built_in">export</span> I_MPI_FABRICS=<span class="hljs-string">&quot;shm:ofi&quot;</span><br><br><span class="hljs-comment"># for multiple nodes,</span><br><span class="hljs-comment"># Enable parallel filesystem support</span><br><span class="hljs-built_in">export</span> I_MPI_EXTRA_FILESYSTEM=<span class="hljs-built_in">enable</span><br><span class="hljs-comment"># Enable cross node communication in partition</span><br><span class="hljs-built_in">export</span> FI_PROVIDER=tcp<br>...<br></code></pre></td></tr></table></figure><p>to allow extra filesystem and use <code>tcp</code> that be slower a bit.</p>]]></content>
    
    
    <categories>
      
      <category>MPAS</category>
      
    </categories>
    
    
    <tags>
      
      <tag>HPC</tag>
      
      <tag>NWP</tag>
      
      <tag>WRF</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>MPAS | Minimum computer resources for running MPAS</title>
    <link href="/2024/10/28/Minimum-computer-resources-for-running-MPAS/"/>
    <url>/2024/10/28/Minimum-computer-resources-for-running-MPAS/</url>
    
    <content type="html"><![CDATA[<h1 id="mpas-a">MPAS-A</h1><div class="note note-primary">            <p><strong>Amount of memory needed</strong> to run a particular simulation is to multiply the number of horizontal cells in the mesh by <strong>0.175 MB/cell</strong></p>          </div><div class="note note-primary">            <p>We find that on Cheyenne, MPAS-A scales with around <strong>70% parallel efficiency down to around 100 grid columns per MPI task</strong></p>          </div><ul><li><a href="https://forum.mmm.ucar.edu/threads/minimum-computer-requirements-for-running-mpas.10047/">Feb 16, 2021 | Minimum computer requirements for running MPAS | mgduda</a><ul><li>Regarding memory requirements, we've found that a reasonable way to estimate the <strong>amount of memory needed to run a particular simulation is to multiply the number of horizontal cells in the mesh by 0.175 MB/cell</strong>; this estimate is based on a single-precision model run with around 55 vertical levels. So, for example, a global, quasi-uniform 30-km simulation might require around 655362 cells * 0.175 MB/cell = 115,000 MB of memory. Note that this is the aggregate amount of memory across all nodes of a computing cluster, and not the amount of memory on each node. Also, this is a rough estimate only, and the amount of memory required for a simulation can vary a little based on, for example, your choice of physics parameterizations.</li><li>In principle, there is no minimum requirement for the number of processors (as long as there is at least one processor), since using fewer processors simply means that a simulation will take longer to run. If one were patient enough, and if enough memory were available, a single processor could be used for any simulation. For a few notes on estimating simulation throughput with MPAS-Atmosphere with different numbers of processors, <a href="https://forum.mmm.ucar.edu/phpBB3/viewtopic.php?f=12&amp;t=9002&amp;p=16332&amp;hilit=core+hours#p16332">this forum thread</a> may be helpful.</li><li>Regarding the kind of system to use, I can offer that we have run MPAS-Atmosphere on a wide variety of computing systems: Raspberry Pi single-board computers, macOS laptops, linux desktops with 4 or 8 cores, and some large clusters like Cheyenne and Summit. So there isn't necessarily a specific system that I could recommend -- all come with pros and cons (cost, reliability, performance). One point worth mentioning, however, is that a higher-performance interconnect between nodes would generally be beneficial, as MPI communication is performed extensively throughout each time step in the model.</li><li>Again, the 0.175 MB/cell figure is a rough estimate. Using more cores will generally increase the model simulation rate</li><li>It may be a bit difficult to accurately calculate the memory required by a simulation at the init_atmosphere stage, since we don't yet know, e.g., which physics schemes will be used in the simulation or which diagnostics will be requested in output streams. In principle this could be done when the atmosphere_model program starts, but gauging memory requirements of physics and diagnostics would still be quite a challenge, I think.</li><li>I do agree that it would be nice to give better indications of out-of-memory errors. One tractable step in this direction might be to check the status of all major memory allocations in the model; for example, just checking allocations of model fields defined in the Registry.xml file might help. We'll give this some serious consideration, and if you have any other suggestions, we'd be glad to hear them</li></ul></li><li><a href="https://forum.mmm.ucar.edu/threads/computing-power-necessary-for-global-wrf-mpas.9002/#p16332">Apr 2, 2020 | Computing power necessary for global WRF/MPAS</a><ul><li>For both WRF and MPAS, <strong>the computational costs scale more or less linearly with the number of grid cells, and inversely with the integration time step</strong>. So, if you have the computational cost for one simulation, you can quickly estimate the cost of other simulations.</li><li>On the <strong>NWSC Cheyenne computer</strong>, the <strong>computational cost for a global, quasi-uniform 15-km simulation with 2,621,442 grid</strong> columns and 56 vertical layers is about <strong>530 core-hours per simulated day</strong>. This includes no file output and the default "mesoscale reference" suite of physics parameterizations, with the radiation schemes called once every 15 simulated minutes; the model integration time step is 90 seconds.</li><li>For example, then, if we were to estimate the cost of a global, variable-resolution simulation on a mesh with <strong>6,488,066 grid</strong> columns and a <strong>minimum grid distance of 3 km</strong>, which would probably dictate an integration time step of around <strong>18 seconds</strong>, a rough estimate would be:<ul><li>530 core-hours/day * (6488066 / 2621442) * (90 / 18) = 6559 core-hours per simulated day</li></ul></li><li>A few other factors that influence computational cost include:<ul><li>The suite of physics parameterizations that are used in the simulation.</li><li>The amount of model output written to the filesystem: more file output implies more time spent writing data.</li><li>The compiler used to build the model executables, as well as the optimization flags used for that compiler.</li><li>The number of MPI tasks used to run the model: there is a general downward trend in parallel efficiency as more MPI tasks are used in a model simulation. <strong>We find that on Cheyenne, MPAS-A scales with around 70% parallel efficiency down to around 100 grid columns per MPI task</strong>.</li><li>The simulation length: there is a cost associated with "starting up" the model (reading initial conditions, allocating memory, initializing data structures, etc.), and longer simulations will allow that start-up cost to be amortized over more integration time steps.</li></ul></li></ul></li></ul>]]></content>
    
    
    <categories>
      
      <category>MPAS</category>
      
    </categories>
    
    
    <tags>
      
      <tag>NWP</tag>
      
      <tag>WRF</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Coriolis force | 科氏力</title>
    <link href="/2024/10/26/Coriolis-force/"/>
    <url>/2024/10/26/Coriolis-force/</url>
    
    <content type="html"><![CDATA[<p>In physics, the <strong>Coriolis force</strong> is an inertial (or fictitious) force that acts on objects in motion within a frame of reference that rotates with respect to an inertial frame. In a reference frame with clockwise rotation, the force acts to the left of the motion of the object. In one with anticlockwise (or counterclockwise) rotation, the force acts to the right. Deflection of an object due to the Coriolis force is called the Coriolis effect. Though recognized previously by others, the mathematical expression for the Coriolis force appeared in an 1835 paper by French scientist Gaspard-Gustave de Coriolis, in connection with the theory of water wheels. Early in the 20th century, the term Coriolis force began to be used in connection with meteorology.</p><figure><img src="https://i.imgur.com/knTtXP0.jpeg" alt="If the air began to move in response to that force, however, the Coriolis force would deflect it, to the right of the motion in the northern hemisphere or to the left in the southern hemisphere." width="400" /><figcaption>If the air began to move in response to that force, however, the Coriolis force would deflect it, to the right of the motion in the northern hemisphere or to the left in the southern hemisphere.</figcaption></figure><div class="group-image-container"><div class="group-image-row"><div class="group-image-wrap"><img src="https://i.imgur.com/lTrDNpz.jpeg" width="400" /></div><div class="group-image-wrap"><img src="https://i.imgur.com/6p5PJ2P.jpeg" /></div></div></div><h1 id="derivation">Derivation</h1><p><span class="math display">\[\begin{align*}\mathbf{r} = x\hat{\mathbf{i}} + y\hat{\mathbf{j}} + z\hat{\mathbf{k}} \end{align*}\]</span></p><p>Specify subscript <span class="math inline">\(r\)</span> to represent <strong>a body-fixed system (The Earth)</strong> as basis <span class="math inline">\(\hat{\mathbf{i}}, \hat{\mathbf{j}}, \hat{\mathbf{k}}\)</span>,</p><p><span class="math display">\[\begin{align*} \left( \dfrac{d \mathbf{r}}{dt} \right)_r &amp;= \dfrac{dx}{dt}\hat{\mathbf{i}} + \dfrac{dy}{dt}\hat{\mathbf{j}} + \dfrac{dz}{dt}\hat{\mathbf{k}} \end{align*} \]</span></p><p>When a <strong>space-fixed system</strong> is considered,</p><p><span class="math display">\[\begin{align*}\left( \dfrac{d \mathbf{r}}{dt} \right)_s &amp;= \dfrac{dx}{dt}\hat{\mathbf{i}} + \dfrac{dy}{dt}\hat{\mathbf{j}} + \dfrac{dz}{dt}\hat{\mathbf{k}} + x\dfrac{d \hat{\mathbf{i}}}{dt} + y\dfrac{d \hat{\mathbf{j}}}{dt} + z\dfrac{d \hat{\mathbf{z}}}{dt} \\&amp; = \left( \dfrac{d \mathbf{r}}{dt} \right)_r + x\dfrac{d \hat{\mathbf{i}}}{dt} + y\dfrac{d \hat{\mathbf{j}}}{dt} + z\dfrac{d \hat{\mathbf{z}}}{dt} \end{align*} \]</span></p><p>What are last three terms?</p><p><span class="math display">\[\begin{align*}\dfrac{d \hat{\mathbf{i}}}{dt} &amp;= \mathbf{\omega} \times \hat{\mathbf{i}} \\\dfrac{d \hat{\mathbf{j}}}{dt} &amp;= \mathbf{\omega} \times \hat{\mathbf{j}} \\\dfrac{d \hat{\mathbf{z}}}{dt} &amp;= \mathbf{\omega} \times \hat{\mathbf{z}} \\\end{align*} \]</span></p><p>then,</p><p><span class="math display">\[\begin{align*}\left( \dfrac{d \mathbf{r}}{dt} \right)_s &amp; = \left( \dfrac{d \mathbf{r}}{dt} \right)_r + \mathbf{\omega} \times \mathbf{r} \\\end{align*} \]</span></p><p>it is generalized to any vector <span class="math inline">\(\mathbf{A}\)</span>,</p><p><span class="math display">\[\begin{align*}\left( \dfrac{d \mathbf{A}}{dt} \right)_s &amp; = \left( \dfrac{d \mathbf{A}}{dt} \right)_r + \mathbf{\omega} \times \mathbf{A} \\\end{align*} \]</span></p><p>consider velocity <span class="math inline">\(\mathbf{v_s} = \left( \dfrac{d \mathbf{r}}{dt} \right)_s = \mathbf{v_r} + \mathbf{\omega} \times \mathbf{r}\)</span>,</p><p><span class="math display">\[\begin{align*}\mathbf{a_s} = \left( \dfrac{d \mathbf{v_s}}{dt} \right)_s &amp; = \left( \dfrac{d \mathbf{v_s}}{dt} \right)_r + \mathbf{\omega} \times \mathbf{v_s} \\&amp; = \left( \dfrac{d (\mathbf{\mathbf{v_r} + \mathbf{\omega} \times \mathbf{r}})}{dt} \right)_r + \mathbf{\omega} \times (\mathbf{v_r} + \mathbf{\omega} \times \mathbf{r}) \\&amp; = \mathbf{a_r} + \dfrac{d \mathbf{\omega}}{dt} \times \mathbf{r} +\mathbf{\omega} \times \mathbf{v_r} + \mathbf{\omega} \times \mathbf{v_r} + \mathbf{\omega} \times (\mathbf{\omega} \times \mathbf{r})\end{align*} \]</span></p><p>let <span class="math inline">\(\omega\)</span> is indepenent of time,</p><p><span class="math display">\[\begin{align*}\mathbf{a_s} &amp;= \mathbf{a_r} + 2\mathbf{\omega} \times \mathbf{v_r} + \mathbf{\omega} \times (\mathbf{\omega} \times \mathbf{r})\end{align*} \]</span></p><p>The equation of motion on space-fixed system is,</p><p><span class="math display">\[\begin{align*}\mathbf{F} = m \mathbf{a_s}\end{align*} \]</span></p><p>and converted to body-fixed system (<strong>The Earth</strong>) is,</p><p><span class="math display">\[\begin{align*}\mathbf{F} - 2 m \mathbf{\omega} \times \mathbf{v_r} - m \mathbf{\omega} \times (\mathbf{\omega} \times \mathbf{r}) = m \mathbf{a_r} \end{align*} \]</span></p><p>For the observer in the body-fixed or rotating system (<strong>The Earth</strong>), he/she will be suffered a Force/effective Force,</p><div class="note note-primary">            <p><span class="math display">\[\begin{align*}\mathbf{F_{eff}} = m \mathbf{a_r} = \mathbf{F} - 2 m \mathbf{\omega} \times \mathbf{v_r} - m \mathbf{\omega} \times (\mathbf{\omega} \times \mathbf{r}) \end{align*} \]</span></p>          </div><p>The second term <span class="math inline">\(- 2 m \mathbf{\omega} \times \mathbf{v_r}\)</span> called the <strong>Coriolis force</strong>, is present when a particle is moving in the rotating co-ordinate system. This is also not a real force, but a fictitious one. Another feature of this force is that it does no work, since it acts in a direction perpendicular to velocity.</p><p>The third term <span class="math inline">\(- m \mathbf{\omega} \times (\mathbf{\omega} \times \mathbf{r})\)</span> is <strong>centrifugal force</strong> that <span class="math inline">\(| m \mathbf{\omega} \times (\mathbf{\omega} \times \mathbf{r})| = mr \omega^2 \sin \theta\)</span>. he negative sign indicates that the centrifugal force is directed away from the centre of rotation. It is not a real force, but a fictitious one. It is present only if we refer to moving coordinates in space.</p><h1 id="coriolis-parameter-rossby-number">Coriolis parameter &amp; Rossby number</h1><p>The time, space, and velocity scales are important in determining the importance of the Coriolis force. Whether rotation is important in a system can be determined by its Rossby number, which is the ratio of the <strong>velocity</strong>, <span class="math inline">\(U\)</span>, of a system to the product of the <strong>Coriolis parameter</strong>,</p><div class="note note-primary">            <p><span class="math display">\[f=2\omega \sin \varphi\]</span></p>          </div><p>,and the <span class="math inline">\(\omega = 7.2921 × 10^{−5}\)</span> rad/s can be calculated as <span class="math inline">\(2\pi / T\)</span> radians per second, the <strong>length scale</strong>, <span class="math inline">\(L\)</span>, <strong>latitude</strong> <span class="math inline">\(\varphi\)</span> of the motion:</p><p><span class="math display">\[Ro = \frac{U}{fL}\]</span></p><p>In the midlatitudes, the typical value for <span class="math inline">\(f\)</span> is about <span class="math inline">\(10^{−4}\)</span> rad/s.</p><p>Hence, it is the ratio of inertial to Coriolis forces; <strong>a small Rossby number indicates a system is strongly affected by Coriolis forces</strong>, and <strong>a large Rossby number indicates a system in which inertial forces dominate</strong>. For example, in tornadoes, the Rossby number is large, so in them the Coriolis force is negligible, and balance is between pressure and centrifugal forces. In low-pressure systems the Rossby number is low, as the centrifugal force is negligible; there, the balance is between Coriolis and pressure forces. In oceanic systems the Rossby number is often around 1, with all three forces comparable.</p><ul><li><strong>An atmospheric system moving at U = 10 m/s (22 mph) occupying a spatial distance of L = 1,000 km (621 mi), has a Rossby number of approximately 0.1</strong></li><li>A baseball pitcher may throw the ball at U = 45 m/s (100 mph) for a distance of L = 18.3 m (60 ft). The Rossby number in this case would be 32,000 (at latitude 31°47'46.382").</li></ul><h1 id="rossby-parameter">Rossby parameter</h1><p>In stability calculations, the rate of change of <span class="math inline">\(f\)</span> along the meridional direction becomes significant. This is called the Rossby parameter and is usually denoted</p><p><span class="math display">\[\beta = \frac{\partial f}{\partial y}\]</span></p><p>where <span class="math inline">\(y\)</span> is the in the local direction of increasing meridian. This parameter becomes important, for example, in calculations involving Rossby waves.</p><h1 id="f-plane-approximation">f-plane approximation</h1><p>In geophysical fluid dynamics, the <strong>f-plane approximation</strong> is an approximation where the <strong>Coriolis parameter</strong>, denoted <span class="math inline">\(f\)</span>, is set to a constant value.</p><p><span class="math display">\[\begin{align*}f &amp;= f_0 = 2\Omega\sin(\phi_0)\end{align*}\]</span></p><ul><li>This approximation is frequently used for the analysis of highly idealized tropical cyclones.</li><li>f-plane approximation is not appropriate when considering flows which span large changes in latitude.</li><li>The f-plane approximation is also poor near the equator.</li></ul><h1 id="beta-plane-approximation">beta-plane approximation</h1><p>In geophysical fluid dynamics, an approximation whereby the <strong>Coriolis parameter</strong>, <span class="math inline">\(f\)</span>, is set to <strong>vary linearly</strong> in space is called a <strong>beta plane approximation</strong>.</p><p><span class="math display">\[\begin{align*}f &amp;= f_0 + \beta y \\\beta &amp;= (\mathrm{d}f/\mathrm{d}y)|_{\phi_0} = 2\Omega\cos(\phi_0)/R\end{align*}\]</span></p><p>where <span class="math inline">\(f_{0}\)</span> is the Coriolis parameter at <span class="math inline">\(\phi _{0}\)</span>.</p><p>The beta plane approximation is useful for the theoretical analysis of many phenomena in geophysical fluid dynamics since <strong>it makes the equations much more tractable</strong>, yet retains the important information that the Coriolis parameter varies in space. In particular, Rossby waves, the most important type of waves if one considers large-scale atmospheric and oceanic dynamics, depend on the variation of f as a restoring force; they do not occur if the Coriolis parameter is approximated only as a constant.</p><ul><li>Ripa, P. (1997). “Inertial” Oscillations and the β-Plane Approximation(s). Journal of Physical Oceanography, 27(5), 633-647. https://doi.org/10.1175/1520-0485(1997)027&lt;0633:IOATPA&gt;2.0.CO;2</li></ul><h1 id="references">References</h1><ol type="1"><li><a href="https://magadhmahilacollege.org/wp-content/uploads/2020/09/Coriolis-Force.pdf">Coriolis-Force.pdf</a></li><li><a href="https://en.wikipedia.org/wiki/Rotating_reference_frame#Relating_rotating_frames_to_stationary_frames">wiki</a></li></ol>]]></content>
    
    
    <categories>
      
      <category>Meteorology</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>Geostrophic wind | 地轉風</title>
    <link href="/2024/10/26/Geostrophic-wind/"/>
    <url>/2024/10/26/Geostrophic-wind/</url>
    
    <content type="html"><![CDATA[<h1 id="地轉風geostrophic-wind">地轉風(Geostrophic wind)</h1><p><strong>地轉風(Geostrophic wind)</strong> 是一種科氏力和氣壓梯度力 (<strong>Coriolis force and the pressure gradient force</strong>)巧妙平衡下產生的一種理論上的風。這個狀況稱為「<strong>地轉平衡</strong>」 (<strong>geostrophic equilibrium or geostrophic balance</strong>)。</p><ul><li><strong>地轉風的方向和等壓線平行</strong>。</li><li>這種平衡在自然界中很少出現。真正的風幾乎總是由地面摩擦力等其他力量產生，與地轉風不同。因此，在自然中要實現地轉風只有無摩擦力和等壓線是完美直線的狀況下。</li></ul><p>A useful heuristic is to imagine air starting from rest, experiencing a force directed from areas of high pressure toward areas of low pressure, called the pressure gradient force. If the air began to move in response to that force, however, the Coriolis force would deflect it, <strong>to the right of the motion in the northern hemisphere</strong> or to the left in the southern hemisphere. As the air accelerated, the deflection would increase until the Coriolis force's strength and direction balanced the pressure gradient force, a state called geostrophic balance.</p><p><img src="https://upload.wikimedia.org/wikipedia/commons/thumb/d/dd/Geostrophic_current.pdf/page1-800px-Geostrophic_current.pdf.jpg" width="400" /> <img src="https://i.imgur.com/knTtXP0.jpeg" alt="If the air began to move in response to that force, however, the Coriolis force would deflect it, to the right of the motion in the northern hemisphere or to the left in the southern hemisphere." width="400" /> <img src="https://www.researchgate.net/profile/A-Giez/publication/356592145/figure/fig11/AS:11431281113717374@1674053965153/Left-panel-schematic-view-of-the-Geostrophic-wind-The-pressure-gradient-force-FP-is.jpg" alt="Left panel: schematic view of the Geostrophic wind. The pressure gradient force (FP) is equal in strength but in the opposite direction to the Coriolis force (Fc). The geostrophic wind (vg) is blowing along the isobars with the lower pressure on the left-hand side on the northern hemisphere. Right panel: example pressure distribution in the free atmosphere over Europe." /> <img src="https://i.imgur.com/B5gSHR9.png" alt="Friction allows surface wind to attain a cross-baric component directing from high to low" width="600" /> <img src="https://i.imgur.com/fE4uVhn.png" /></p><h1 id="hko-geostrophic-wind"><a href="https://www.hko.gov.hk/en/education/weather/meteorology-basics/00010-geostrophic-wind.html">HKO | Geostrophic Wind</a></h1><p><img src="https://www.hko.gov.hk/en/education/images/fig_00010_geostrophicwind_2e.jpg" alt="Schematic diagram of geostrophic wind formation: Geostrophic wind is the wind that will be blowing parallel to the isobars, when Coriolis force is balanced by the pressure gradient force" width="400" /> <img src="https://www.hko.gov.hk/en/education/images/fig_00010_geostrophicwind_3e.jpg" alt="The balance between the pressure gradient force and the resultant (dotted line) of Coriolis force and frictional force" width="400" /></p><h1 id="formulation">Formulation</h1><p><span class="math display">\[\begin{align}\frac{\mathrm{D}\boldsymbol{U}}{\mathrm{D}t} = -2\boldsymbol{\Omega} \times \boldsymbol{U} - \frac{1}{\rho} \nabla P + \mathbf{g} + \mathbf{F}_\mathrm{r}\end{align}\]</span> Here <span class="math inline">\(U\)</span> is the velocity field of the air, <span class="math inline">\(\Omega\)</span> is the angular velocity vector of the planet, <span class="math inline">\(\rho\)</span> is the density of the air, <span class="math inline">\(P\)</span> is the air pressure, <span class="math inline">\(F_r\)</span> is the friction, <span class="math inline">\(g\)</span> is the acceleration vector due to gravity and ⁠<span class="math inline">\(\dfrac{D}{Dt}\)</span> is the material derivative.</p><p>Why use <span class="math inline">\(\dfrac{D}{Dt}\)</span> instead of partial derivative? Becuase the veloctiy of air mass can be zero that we move along with this air mass and feel no velocity change, in other words, kinetic energy is conserved. In contrast, partial derivative consider a fixed point in space that velocity of this fixed point can be varied.</p><p>Locally this can be expanded in Cartesian coordinates, with a positive <span class="math inline">\(u\)</span> representing an eastward direction and a positive <span class="math inline">\(v\)</span> representing a northward direction. Neglecting friction and vertical motion.</p><p><span class="math display">\[\begin{align}\frac{\mathrm{d}u}{\mathrm{d}t} &amp;= -\frac{1}{\rho}\frac{\partial P}{\partial x} + f \cdot v \\[5px]\frac{\mathrm{d}v}{\mathrm{d}t} &amp;= -\frac{1}{\rho}\frac{\partial P}{\partial y} - f \cdot u \\[5px]0 &amp;= -g -\frac{1}{\rho}\frac{\partial P}{\partial z}\end{align}\]</span></p><p>With <span class="math inline">\(f = 2 \Omega \sin \phi\)</span> the Coriolis parameter (approximately <span class="math inline">\(10^{−4} s^{−1}\)</span>, varying with latitude).</p><p>Assuming geostrophic balance, the system is stationary and the first two equations become:</p><p><span class="math display">\[\begin{align}f \cdot v &amp;= \;\;\,\frac{1}{\rho}\frac{\partial P}{\partial x} \\[5px]f \cdot u &amp;= -\frac{1}{\rho}\frac{\partial P}{\partial y}\end{align}\]</span></p><p>By substituting using the third equation above, we have:</p><p><span class="math display">\[\begin{align}f \cdot v &amp;= -g\frac{\; \frac{\partial P}{\partial x} \;}{\; \frac{\partial P}{\partial z} \;} = g\frac{\partial Z}{\partial x} \\[5px]f \cdot u &amp;= g\frac{\; \frac{\partial P}{\partial y} \;}{\; \frac{\partial P}{\partial z} \;} = -g\frac{\partial Z}{\partial y}\end{align}\]</span></p><p>with <span class="math inline">\(Z\)</span> the height of the constant pressure surface (geopotential height), satisfying</p><p><span class="math display">\[\frac{\partial P}{\partial x}\mathrm{d}x + \frac{\partial P}{\partial y}\mathrm{d}y + \frac{\partial P}{\partial z}\mathrm{d}Z = 0\]</span></p><p>This leads us to the following result for the geostrophic wind components <span class="math inline">\((u_g, v_g)\)</span>:</p><p><span class="math display">\[\begin{align}u_\mathrm{g} &amp;= -\frac{g}{f} \frac{\partial Z}{\partial y} \\[5px]v_\mathrm{g} &amp;= \;\;\,\frac{g}{f} \frac{\partial Z}{\partial x}\end{align}\]</span></p><p>The validity of this approximation depends on the local Rossby number. It is invalid at the equator, because <span class="math inline">\(f\)</span> is equal to zero there, and therefore generally not used in the tropics.</p><h2 id="rossby-number">Rossby number</h2><p>The time, space, and velocity scales are important in determining the importance of the Coriolis force. Whether rotation is important in a system can be determined by its Rossby number, which is the ratio of the velocity, <span class="math inline">\(U\)</span>, of a system to the product of the Coriolis parameter, <span class="math inline">\(f=2\omega \sin \varphi\)</span>, and the length scale, <span class="math inline">\(L\)</span>, of the motion:</p><p><span class="math display">\[Ro = \frac{U}{fL}\]</span></p><p>Hence, it is the ratio of inertial to Coriolis forces; <strong>a small Rossby number indicates a system is strongly affected by Coriolis forces</strong>, and <strong>a large Rossby number indicates a system in which inertial forces dominate</strong>. For example, in tornadoes, the Rossby number is large, so in them the Coriolis force is negligible, and balance is between pressure and centrifugal forces. In low-pressure systems the Rossby number is low, as the centrifugal force is negligible; there, the balance is between Coriolis and pressure forces. In oceanic systems the Rossby number is often around 1, with all three forces comparable.</p><ul><li><strong>An atmospheric system moving at U = 10 m/s (22 mph) occupying a spatial distance of L = 1,000 km (621 mi), has a Rossby number of approximately 0.1</strong></li><li>A baseball pitcher may throw the ball at U = 45 m/s (100 mph) for a distance of L = 18.3 m (60 ft). The Rossby number in this case would be 32,000 (at latitude 31°47'46.382").</li></ul><h1 id="references">References</h1><ol type="1"><li><a href="https://userfiles-secure.educatorpages.com/userfiles/jlindsay/Meteorology/IX.%20Geostrophic%20Winds.pdf">IX. GEOSTROPHIC WINDS</a></li><li><a href="https://www.soest.hawaii.edu/MET/Faculty/businger/notes/force-wind-2.pdf">force-wind-2.pdf</a></li></ol>]]></content>
    
    
    <categories>
      
      <category>Meteorology</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>Jet Stream | 高速氣流</title>
    <link href="/2024/10/26/Jet-stream/"/>
    <url>/2024/10/26/Jet-stream/</url>
    
    <content type="html"><![CDATA[<p><strong>高速氣流(Jet Stream)</strong>，或稱噴射氣流、高空急流、極鋒噴流、噴流、激流，是行星尺度的大氣環流。在地球上，指數條圍繞地球的<strong>強而窄的高速氣流帶，集中在對流層頂</strong>，在中高緯西風帶內或在低緯度地區都可出現。其水平長度達上萬公里，寬數百公里，厚數公里。<strong>中心風速有時可達每小時200至300公里的偏西風</strong>，而且可以有一個或多個風速極大中心，具有強大的水平風切變和垂直風切變。高速氣流附近亦有強大風切變，這也是所謂飛機上的亂流。</p><p>The first indications of this phenomenon came from American professor Elias Loomis (1811–1889), when he proposed the hypothesis of a powerful air current in the upper air blowing west to east across the United States as an explanation for the behaviour of major storms. After the 1883 eruption of the Krakatoa volcano, weather watchers tracked and mapped the effects on the sky over several years. They labelled the phenomenon the "equatorial smoke stream". 噴射氣流是在1920年代，由日本氣象學家大石和三郎（Wasaburo Oishi）發現的。他在富士山附近的某個地點進行追蹤了飛行員氣球，也稱為pibals（用來測定高層風的氣球），當它們升高至對流層頂時發現到噴射氣流的存在。大石的論文在日本以外的國家廣為人知。</p><p>在北半球，<strong>極鋒噴流(Polar Jet Stream)</strong>對於航空界跟氣象預報來說，是很重要的。因為極鋒噴流的速度比<strong>副熱帶噴射氣流(Subtropical Jet Stream)</strong>來的快，且出現在比較低的高度。且極鋒噴流涵蓋了北半球的大部份國家。相較之下，南半球的極鋒噴流徘徊在南極洲，或有時出現在南美洲。</p><div class="group-image-container"><div class="group-image-row"><div class="group-image-wrap"><img src="https://upload.wikimedia.org/wikipedia/commons/3/3e/Jetcrosssection.jpg" alt="1" /></div></div><div class="group-image-row"><div class="group-image-wrap"><img src="https://upload.wikimedia.org/wikipedia/commons/6/6b/Jetstreamconfig.jpg" alt="2" width="400" /></div><div class="group-image-wrap"><img src="https://upload.wikimedia.org/wikipedia/commons/thumb/9/9c/Earth_Global_Circulation_-_en.svg/2560px-Earth_Global_Circulation_-_en.svg.png" alt="3" width="300" /></div></div></div><ul><li><strong>極地高空急流</strong>一般出現在大氣層250百帕，即海拔7至12公里（23,000至39,000呎）處。</li><li>更弱的<strong>亞熱帶高空急流</strong>的高度更高，海拔10至16公里（33,000至52,000呎）。夏季，北半球極地急流偏北；冬季，北半球極地急流偏南。高空急流的寬度為數百公里，厚度小於5公里。</li></ul><div class="note note-primary">            <ul><li>All these facts are consequences of the <strong>thermal wind</strong> relation. The balance of forces acting on an atmospheric air parcel in the vertical direction is primarily between the gravitational force acting on the mass of the parcel and the buoyancy force, or the difference in pressure between the top and bottom surfaces of the parcel.</li><li><strong>極地到赤道溫度梯度相關的熱成風</strong>是形成對流層上層急流的主要物理解釋</li></ul>          </div><h1 id="videoes">Videoes</h1><ul><li>Met office | What is the jet stream and how does it affect the weather? <iframe width="560" height="315" src="https://www.youtube.com/embed/Lg91eowtfbw?si=s3XE7WSCbhaOmELh" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen></iframe></li></ul><h1 id="study">Study</h1><ul><li>高空急流附近的晴空湍流<ul><li><a href="https://www.hko.gov.hk/tc/aviat/turbulence/Jetstream.htm" class="uri">https://www.hko.gov.hk/tc/aviat/turbulence/Jetstream.htm</a></li></ul></li></ul><figure><img src="https://www.hko.gov.hk/tc/aviat/turbulence/images/JetStream.png" alt="圖為香港天文台為離港航班提供的天氣圖，顯示了距離地面30,000呎（約9公里）上空的風和溫度。圖中紅線標誌風速超過80海里（約每小時150公里）的區域，即該高度的高空急流所在。" width="300" /><figcaption>圖為香港天文台為離港航班提供的天氣圖，顯示了距離地面30,000呎（約9公里）上空的風和溫度。圖中紅線標誌風速超過80海里（約每小時150公里）的區域，即該高度的高空急流所在。</figcaption></figure><ul><li><p>高空急流是距離地面數公里高的狹窄強風帶。空氣在高空急速流動，就好像水在猛急河流中流動一樣，<strong>當猛急的河水遇上河岸旁緩緩的水流時，便會產生波浪和漩渦</strong>。當這些波浪和漩渦愈來愈大，水流便變得湍急。同樣情況也出現在高空急流之中，所以當飛機遇上高空急流附近的晴空湍流，飛機會變得顛簸不定。 下圖為香港天文台為離港航班提供的天氣圖，顯示了距離地面30,000呎（約9公里）上空的風和溫度。圖中紅線標誌風速超過80海里（約每小時150公里）的區域，即該高度的高空急流所在。</p></li><li><a href="https://popopo.medium.com/%E5%A6%82%E4%BD%95%E8%A7%A3%E9%87%8B%E5%99%B4%E5%B0%84%E6%A2%9D-jet-streak-%E7%9A%84%E8%BC%BB%E5%90%88-convergence-%E8%88%87%E8%BC%BB%E6%95%A3-divergence-%E5%88%86%E4%BD%88-277c6732e247">如何解釋噴流條(Jet Streak)的輻合(Convergence)與輻散(Divergence)分佈?</a><ul><li>關於噴射氣流的成因，一般可以用<strong>熱力風平衡(Thermal wind balance)來做第一層解釋</strong></li></ul></li><li><p><a href="https://www.meted.ucar.edu/labs/synoptic/jets_ageo_circ/navmenu.php">UCAR | Analyzing Jet Stream Circulations</a></p></li></ul><div class="group-image-container"><div class="group-image-row"><div class="group-image-wrap"><img src="https://www.meted.ucar.edu/labs/synoptic/jets_ageo_circ/media/graphics/global_200_winds_15aug2012.jpg" width="400" /></div></div><div class="group-image-row"><div class="group-image-wrap"><img src="https://www.meted.ucar.edu/labs/synoptic/jets_ageo_circ/media/graphics/jetstreaks_australia.jpg" width="400" /></div></div></div>]]></content>
    
    
    <categories>
      
      <category>Meteorology</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>Maths | PDE | Overview</title>
    <link href="/2024/10/25/maths-PDE-introduction/"/>
    <url>/2024/10/25/maths-PDE-introduction/</url>
    
    <content type="html"><![CDATA[<p>In mathematics, a <strong>partial differential equation (PDE)</strong> is an equation which computes a function between various partial derivatives of a multivariable function.</p><h1 id="classification">Classification</h1><p>A PDE is called <strong>linear</strong> if it is linear in the unknown and its derivatives. For example, for a function <span class="math inline">\(u\)</span> of <span class="math inline">\(x\)</span> and <span class="math inline">\(y\)</span>, a second order linear PDE is of the form</p><p><span class="math display">\[\begin{align*} a_1(x,y)u_{xx} + a_2(x,y)u_{xy} + a_3(x,y)u_{yx} + a_4(x,y)u_{yy} + a_5(x,y)u_x + a_6(x,y)u_y + a_7(x,y)u = f(x,y)\end{align*} \]</span></p><p>where <span class="math inline">\(a_i\)</span> and <span class="math inline">\(f\)</span> are functions of the independent variables <span class="math inline">\(x\)</span> and <span class="math inline">\(y\)</span> only. (Often the mixed-partial derivatives <span class="math inline">\(u_{xy}\)</span> and <span class="math inline">\(u_{yx}\)</span> will be equated, but this is not required for the discussion of linearity.)</p><ul><li>If the <span class="math inline">\(a_i\)</span> are constants (independent of <span class="math inline">\(x\)</span> and <span class="math inline">\(y\)</span>) then the PDE is called <strong>linear</strong> with constant coefficients.</li><li>If <span class="math inline">\(f\)</span> is zero everywhere then the linear PDE is <strong>homogeneous</strong>, otherwise it is <strong>inhomogeneous</strong>. (This is separate from asymptotic homogenization, which studies the effects of high-frequency oscillations in the coefficients upon solutions to PDEs.</li></ul><p>Nearest to linear PDEs are <strong>semi-linear PDEs</strong>, where only the highest order derivatives appear as linear terms, with coefficients that are functions of the independent variables. The lower order derivatives and the unknown function may appear arbitrarily. For example, a general second order semi-linear PDE in two variables is</p><p><span class="math display">\[\begin{align*} a_1(x,y)u_{xx} + a_2(x,y)u_{xy} + a_3(x,y)u_{yx} + a_4(x,y)u_{yy} + f(u_x, u_y, u, x, y) = 0\end{align*} \]</span></p><p>In a <strong>quasilinear PDE</strong> the highest order derivatives likewise appear only as linear terms, but with coefficients possibly functions of the unknown and lower-order derivatives:</p><p><span class="math display">\[\begin{align*} a_1(u_x, u_y, u, x, y)u_{xx} + a_2(u_x, u_y, u, x, y)u_{xy} + a_3(u_x, u_y, u, x, y)u_{yx} + a_4(u_x, u_y, u, x, y)u_{yy} + f(u_x, u_y, u, x, y) = 0\end{align*} \]</span></p><p>Many of the fundamental PDEs <strong>in physics are quasilinear</strong>, such as the <strong>Einstein equations</strong> of general relativity and the <strong>Navier–Stokes equations</strong> describing fluid motion.</p><p>A PDE without any linearity properties is called <strong>fully nonlinear</strong>, and possesses nonlinearities on one or more of the highest-order derivatives. An example is the <strong>Monge–Ampère equation</strong>, which arises in differential geometry.</p><h1 id="second-order-pde-classification">Second order PDE Classification</h1><ul><li><a href="https://en.wikipedia.org/wiki/Partial_differential_equation#Second_order_equations">wiki</a></li><li><a href="https://web.stanford.edu/class/math220a/handouts/secondorder.pdf">Levandosky, Julie. "Classification of Second-Order Equations"</a></li><li><a href="https://www.fluid.tuwien.ac.at/322042?action=AttachFile&amp;do=get&amp;target=Classification_v2.pdf">Classification of PDEs</a></li></ul><p>The <strong>elliptic/parabolic/hyperbolic classification</strong> provides a guide to appropriate initial- and boundary conditions and to the smoothness of the solutions. Assuming <span class="math inline">\(u_{xy} = u_{yx}\)</span>, the general linear second-order PDE in two independent variables has the form</p><p><span class="math display">\[\begin{align*} Au_{xx} + Bu_{xy} + Cu_{yy} + Du_x + Eu_y + Fu +G= 0    \end{align*} \tag{1}\]</span> where <span class="math inline">\(A,B,C,D,E,F,G\)</span> may be functions of <span class="math inline">\(x,y\)</span>. Caution: <span class="math inline">\(A\)</span> and <span class="math inline">\(C\)</span> must be non-zero for this method to work! If this is not the case, then use the generic method for second-order PDEs.</p><table><thead><tr class="header"><th>Type</th><th>Discriminant</th><th>is reducible to</th><th>Example</th><th>Example equation</th></tr></thead><tbody><tr class="odd"><td><code>Elliptic</code></td><td><span class="math inline">\(B^2 - 4 AC &lt; 0\)</span></td><td><span class="math inline">\(u_{xx} + u_{yy} + ...= 0\)</span></td><td>Laplace's equation</td><td><span class="math inline">\(u_{xx} + u_{yy} = 0\)</span></td></tr><tr class="even"><td><code>Parabolic</code></td><td><span class="math inline">\(B^2 - 4 AC = 0\)</span></td><td><span class="math inline">\(u_{xx} + ...= 0\)</span></td><td>Heat equation</td><td><span class="math inline">\(u_t - u_{xx} = 0\)</span></td></tr><tr class="odd"><td><code>Hyperbolic</code></td><td><span class="math inline">\(B^2 - 4 AC &gt; 0\)</span></td><td><span class="math inline">\(u_{xx} - u_{yy} + ...= 0\)</span></td><td>Wave equation</td><td><span class="math inline">\(u_{tt} - u_{xx} = 0\)</span></td></tr></tbody></table><p>The three equations in Example above are of particular interest not only because they are derived from physical principles, but also because <strong>every second-order linear equation of the form (1) can be reduced to an equation of one of those forms (plus lower-order terms) by making a change of variables</strong>.</p><p>From the numerical point of view,</p><table><thead><tr class="header"><th></th><th></th><th>Types</th><th>Computational Concern</th></tr></thead><tbody><tr class="odd"><td>Initial Value Problem</td><td>Time evolution</td><td>Parabolic or Hyperbolic</td><td><strong>Stability</strong></td></tr><tr class="even"><td>Boundary Value Problem</td><td>Static solution</td><td>Elliptic</td><td><strong>Efficiency</strong></td></tr></tbody></table><h2 id="navier-stokes-equations-ns-equations"><strong>Navier-Stokes equations (NS equations)</strong></h2><p>The <strong>Navier-Stokes equations (NS equations)</strong>, which describe the motion of fluid substances (like liquids and gases), are a set of nonlinear partial differential equations (PDEs). Their type depends on how they're applied and simplified for specific contexts. Here’s a breakdown:</p><h3 id="classification-based-on-context">1. <strong>Classification Based on Context</strong></h3><p>PDEs are classified as <strong>elliptic</strong>, <strong>parabolic</strong>, or <strong>hyperbolic</strong>, depending on the system's properties. The Navier-Stokes equations can exhibit any of these behaviors depending on the conditions.</p><h4 id="a-parabolic-type-diffusion-dominated">a) <strong>Parabolic Type</strong> (Diffusion-Dominated)</h4><ul><li>When viscous (diffusive) terms dominate over inertial terms (<span class="math inline">\((\mathbf{u} \cdot \nabla) \mathbf{u}\)</span>) in low Reynolds number (<span class="math inline">\(Re\)</span>) flows.</li><li>Example: Slow, creeping flows like those governed by the <strong>Stokes equation</strong> (a simplification of Navier-Stokes for very low <span class="math inline">\(Re\)</span>).</li></ul><h4 id="b-elliptic-type-steady-state-solutions">b) <strong>Elliptic Type</strong> (Steady-State Solutions)</h4><ul><li>For steady flows (<span class="math inline">\(\partial \mathbf{u} / \partial t = 0\)</span>), the Navier-Stokes equations can become elliptic.</li><li>Pressure fields are determined elliptically in incompressible flows due to the coupling of velocity and pressure.</li></ul><h4 id="c-hyperbolic-type-advection-dominated-or-compressible-regimes">c) <strong>Hyperbolic Type</strong> (Advection-Dominated) or compressible regimes</h4><ul><li>For high Reynolds number flows, where inertial terms dominate viscous terms, the flow becomes advection-dominated.</li><li>Inviscid (frictionless) Navier-Stokes equations reduce to the <strong>Euler equations</strong>, which are hyperbolic.</li></ul><h2 id="properties-of-different-types-of-pdes">Properties of different types of PDEs</h2><ul><li><code>Elliptic</code><ul><li>Boundary conditions must be prescribed all along the boundary</li><li><strong>Local change of the boundary data influences the solution everywhere</strong></li><li><strong>No propagation of waves</strong></li><li>No real characteristics</li></ul></li><li><code>Parabolic</code><ul><li>Parabolic equations arise by adding time dependence <span class="math inline">\(u_t\)</span> to equation which was originally elliptic.</li><li>Waves can propagate in one specific direction only, corresponding to time-like variable</li><li>Equivalent system of <span class="math inline">\(n\)</span> first-order equations has <span class="math inline">\(1\)</span> to <span class="math inline">\(n-1\)</span> real characteristics</li><li>Boundary conditions are required in space, initial condition in time</li><li><strong>Local change in boundary conditions affects immediately the solution at all positions in space, but only in future times</strong></li></ul></li><li><code>Hyperbolic</code><ul><li>Waves can reflect from boundaries</li><li>Equivalent system of <span class="math inline">\(n\)</span> first-order equations has <span class="math inline">\(n\)</span> real characteristics.</li><li>Boundary conditions are required in space, initial condition in time</li><li><strong>Information about local change of boundary condition travels through space with finite speed.</strong></li></ul></li></ul><h3 id="local-changes-and-their-effects">Local Changes and Their Effects</h3><p>Local modifications to boundary data can influence solutions in several ways, depending on the type of PDE:</p><ul><li><code>Elliptic PDEs</code>, such as Laplace's equation, are characterized by their boundary conditions being prescribed over the entire boundary of the domain. The effects of local changes in boundary conditions on elliptic equations are profound:<ul><li><strong>Immediate Influence</strong>: A local change in boundary data will affect the solution throughout the entire domain immediately. This is due to the smoothing properties of elliptic equations, where solutions tend to be continuous and smooth across the domain. For instance, if a Dirichlet boundary condition is altered at one point, the solution will adjust in a way that reflects this change throughout the entire region.</li><li><strong>No Propagation Delay</strong>: Unlike hyperbolic equations, there is no wave propagation; thus, changes do not require time to influence distant points in the domain. Instead, they affect all points instantaneously.</li></ul></li><li><code>Parabolic PDEs</code>, such as the heat equation, exhibit different characteristics regarding local changes in boundary conditions:<ul><li><strong>Temporal Influence</strong>: Changes to boundary conditions will affect the solution at all spatial locations but only at future times. This means that while a local alteration might not immediately impact distant points, over time, these changes will propagate through the domain.</li><li><strong>Initial Conditions Matter</strong>: In parabolic problems, both initial conditions and boundary conditions are crucial. A local change can lead to an evolution of the solution that reflects this change as time progresses. For example, if the temperature at a boundary is increased, it will eventually influence the temperature distribution throughout the domain as heat diffuses.</li></ul></li><li><code>Hyperbolic PDEs</code>, such as wave equations, have unique properties concerning local changes:<ul><li><strong>Directional Propagation</strong>: Local changes in boundary conditions can influence solutions through wave propagation. The effects of such changes are constrained by the speed of waves; thus, alterations at one boundary may take time to reach other parts of the domain depending on their distance and direction.</li><li><strong>Reflection and Interaction</strong>: Waves can reflect off boundaries, which means that local changes can create complex interactions within the domain as waves bounce back and forth. This can lead to intricate patterns in the solution that depend on both initial and boundary conditions.</li></ul></li></ul><div class="note note-danger">            <p>The effects of local changes in boundary data on PDE solutions vary significantly across different types of equations.</p><ul><li>Elliptic equations respond instantaneously throughout the domain,</li><li>Parabolic equations show temporal propagation effects, and</li><li>Hyperbolic equations exhibit directional influence based on wave behavior.</li></ul><p>Understanding these dynamics is essential for accurately modeling physical phenomena described by PDEs and for ensuring stability and reliability in numerical simulations.</p>          </div><ol type="1"><li><a href="https://math.stackexchange.com/questions/3937288/information-propagation-rate-in-2nd-order-pdes">Information propagation rate in 2nd-order PDEs</a><ul><li>Propagation of information generally refers to how local changes in the initial/boundary data is reflected in the corresponding solution.</li><li>In the elliptic and parabolic cases, local changes to initial/boundary data can change the solution at every point, which is what we mean by infinite speed of propagation.</li><li>For wave equations this is not the case however, and changes to initial data is propagates along a 'wave cone.'</li><li>Why would some systems result in finite information propagation rate and others necessarily have infinite information propagation rate?</li></ul></li></ol><h3 id="information-propagation-in-the-heat-equation">Information Propagation in the Heat Equation</h3><p>The heat equation, a fundamental parabolic partial differential equation, describes how heat diffuses through a medium over time. Its mathematical formulation is typically given as:</p><p><span class="math display">\[\frac{\partial T}{\partial t} = \alpha \frac{\partial^2 T}{\partial x^2}\]</span></p><p>where $ T(x, t) $ is the temperature at position $ x $ and time $ t $, and $ $ is the thermal diffusivity constant. Understanding how information propagates in this context is key to grasping the equation's implications in physical scenarios.</p><h4 id="key-characteristics-of-information-propagation"><strong>Key Characteristics of Information Propagation</strong></h4><ol type="1"><li><strong>Infinite Speed of Propagation</strong>:<ul><li>Unlike hyperbolic equations (e.g., the wave equation), which have a finite speed of propagation, the heat equation exhibits an <strong>infinite speed of propagation</strong>. This means that changes in temperature at any point in the medium affect all other points instantaneously. For example, if a sudden change occurs at one point, the entire domain feels this change immediately, leading to a smoothing effect across the temperature distribution.<ul><li>Intuitively, <strong>Brownian motion</strong> has infinite propagation speed, as it has a <strong>non-zero probability of reaching any point in any arbitrarily short time</strong>. This is due to the fact that the probability density of the normal distribution is strictly greater than zero over the entire space.</li></ul></li></ul></li><li><strong>Smoothing Effect</strong>:<ul><li>The heat equation inherently smooths out temperature distributions over time. Initially sharp changes or discontinuities in temperature will become less pronounced as time progresses. This behavior can be observed in the solution to the heat equation, where initial conditions are represented by a Dirac delta function, leading to solutions that spread and flatten out over time.</li></ul></li><li><strong>Loss of Information</strong>:<ul><li>As time progresses, information about the initial temperature distribution gradually dissipates. The solution approaches a steady state where temperature differences diminish, reflecting a loss of information about the initial conditions. This contrasts with hyperbolic equations where information is preserved along characteristic lines.</li></ul></li><li><strong>Mathematical Representation</strong>:<ul><li>The fundamental solution (or heat kernel) for the heat equation illustrates these properties mathematically. In one dimension, it can be expressed as:</li></ul><p><span class="math display">\[S(x, t) = \frac{1}{\sqrt{4\pi \alpha t}} e^{-\frac{x^2}{4\alpha t}}\]</span></p><p>This solution shows that as $ t $ increases, the peak of the Gaussian becomes flatter and approaches zero for fixed $ x $, indicating that localized heat effects spread out and diminish over time.</p></li></ol><h4 id="implications-of-infinite-propagation-speed"><strong>Implications of Infinite Propagation Speed</strong></h4><p>The notion of infinite speed of propagation can be counterintuitive:</p><ul><li><strong>Physical Interpretation</strong>: While it might seem that changes propagate instantaneously, this does not imply actual physical movement at infinite speeds. Instead, it reflects how thermal energy diffuses uniformly across the medium due to local interactions at the molecular level.</li><li><strong>Practical Considerations</strong>: In real-world applications, such as heat conduction in solids or fluids, this model simplifies analysis but may not account for delays due to physical constraints or material properties.</li></ul><h4 id="conclusion"><strong>Conclusion</strong></h4><p>The heat equation's characteristics—specifically its infinite speed of propagation and smoothing effect—highlight its unique role among PDEs. Understanding these properties is crucial for modeling thermal processes accurately and recognizing how initial conditions influence long-term behavior in systems governed by diffusion phenomena.</p><h3 id="chatgpt">ChatGPT</h3><p>The statement "heat equation exhibits infinite speed of propagation" refers to a mathematical property of the classical <strong>heat equation</strong>, which describes how heat diffuses through a medium over time. The heat equation is typically written as:</p><p><span class="math display">\[\frac{\partial u}{\partial t} = \alpha \nabla^2 u\]</span></p><p>where:</p><ul><li>$ u = u(x,t) $ is the temperature distribution,</li><li><span class="math inline">\(\alpha &gt; 0\)</span> is the thermal diffusivity,</li><li><span class="math inline">\(\nabla^2\)</span> is the Laplacian operator.</li></ul><h4 id="meaning-of-infinite-speed-of-propagation">Meaning of Infinite Speed of Propagation</h4><p>In the heat equation, even if the initial temperature distribution <span class="math inline">\(u(x,0)\)</span> has compact support (nonzero only in a finite region of space), the solution <span class="math inline">\(u(x,t)\)</span> for <span class="math inline">\(t &gt; 0\)</span> becomes nonzero everywhere, even arbitrarily far from the initial region. This means that information about the temperature change "propagates" instantaneously to all parts of the medium, albeit with exponentially small magnitude at large distances.</p><h4 id="why-does-this-happen">Why Does This Happen?</h4><p>This property arises from the mathematical nature of the heat equation:</p><ol type="1"><li>The heat equation is a <strong>parabolic partial differential equation</strong>.</li><li>Parabolic equations do not have a finite propagation speed for disturbances because they involve second-order spatial derivatives without any mechanism limiting the spread of effects.</li></ol><h4 id="physical-implications">Physical Implications</h4><p>In real-world systems, the infinite speed of propagation predicted by the classical heat equation is not physically realistic because no physical process can propagate at infinite speed. <strong>The discrepancy arises because the heat equation is a continuum approximation and does not account for physical constraints such as the finite speed of thermal energy transport at the atomic or molecular level</strong>.</p><h4 id="modified-theories">Modified Theories</h4><p>To address this issue, <strong>hyperbolic heat equations</strong> or <strong>Cattaneo's equation</strong> are sometimes used. These models incorporate a finite speed of propagation by introducing a relaxation time for heat flux. For example, Cattaneo's equation modifies the heat equation to include a delay effect:</p><p><span class="math display">\[\tau \frac{\partial q}{\partial t} + q = -k \nabla u\]</span></p><p>where <span class="math inline">\(\tau\)</span> is the relaxation time, <span class="math inline">\(q\)</span> is the heat flux, and <span class="math inline">\(k\)</span> is the thermal conductivity. This modification ensures finite propagation speed.</p><h4 id="if-heat-equation-exhibits-infinite-speed-of-propagation-how-can-we-apply-finite-difference-method">If heat equation exhibits infinite speed of propagation , how can we apply finite difference method?</h4><p>Applying the finite difference method (FDM) to the heat equation is possible and commonly done, even though the equation exhibits infinite speed of propagation. This works because the infinite speed of propagation is a mathematical idealization that does not directly affect numerical methods. Here's why FDM can still be applied effectively:</p><h4 id="key-considerations-for-fdm-and-infinite-speed-of-propagation">Key Considerations for FDM and Infinite Speed of Propagation</h4><ol type="1"><li><strong>Locality of Computation</strong>:<ul><li>In FDM, the temperature at a grid point is updated based on values from neighboring points within a small finite region (e.g., using a stencil in space and time).</li><li>Although the theoretical solution predicts nonzero values everywhere, these values are often exponentially small and do not significantly affect computation beyond a finite domain.</li></ul></li><li><strong>Truncation of the Domain</strong>:<ul><li>In practice, computations are performed on a finite spatial domain, often with boundary conditions applied to simulate the effects of the surrounding infinite domain.</li><li>Any influence from distant points outside the computational domain is negligible due to the rapid decay of the solution in space.</li></ul></li><li><strong>Temporal Resolution</strong>:<ul><li>The FDM uses small time steps to advance the solution, which aligns with the localized propagation of numerical updates.</li><li>Even though theoretically, information propagates instantaneously, the numerical scheme respects the finite time step, ensuring stable and accurate progression.</li></ul></li><li><strong>Stability and Convergence</strong>:<ul><li>Stability conditions, such as the <strong>CFL condition</strong> (Courant-Friedrichs-Lewy), are enforced to ensure that the numerical solution behaves well.</li><li>For the explicit FDM for the heat equation, the time step size <span class="math inline">\(\Delta t\)</span> and spatial grid size <span class="math inline">\(\Delta x\)</span> must satisfy the condition: <span class="math display">\[\Delta t \leq \frac{\Delta x^2}{2\alpha}\]</span> This condition limits the temporal and spatial resolution, mitigating issues from infinite propagation speed.</li></ul></li><li><strong>Practical Approximations</strong>:<ul><li>In numerical simulations, small initial perturbations may diffuse quickly, but their contributions are bounded by the numerical resolution and truncation errors.</li><li>The numerical approximation only captures behavior within the computational grid and time resolution, effectively ignoring the infinite speed aspect.</li></ul></li></ol><h4 id="how-fdm-works-in-practice">How FDM Works in Practice</h4><p>To solve the 1D heat equation:</p><p><span class="math display">\[\frac{\partial u}{\partial t} = \alpha \frac{\partial^2 u}{\partial x^2},\]</span></p><p>we discretize it using finite difference approximations:</p><ul><li><strong>Time derivative</strong>: <span class="math inline">\(\frac{\partial u}{\partial t} \approx \frac{u_i^{n+1} - u_i^n}{\Delta t}\)</span>,</li><li><strong>Second spatial derivative</strong>: <span class="math inline">\(\frac{\partial^2 u}{\partial x^2} \approx \frac{u_{i+1}^n - 2u_i^n + u_{i-1}^n}{\Delta x^2}\)</span>.</li></ul><p>Substituting these into the equation gives:</p><p><span class="math display">\[\frac{u_i^{n+1} - u_i^n}{\Delta t} = \alpha \frac{u_{i+1}^n - 2u_i^n + u_{i-1}^n}{\Delta x^2}.\]</span></p><p>Rearranging, we obtain the update rule:</p><p><span class="math display">\[u_i^{n+1} = u_i^n + \frac{\alpha \Delta t}{\Delta x^2} (u_{i+1}^n - 2u_i^n + u_{i-1}^n).\]</span></p><h4 id="handling-infinite-propagation-numerically">Handling Infinite Propagation Numerically</h4><ul><li>The numerical scheme is inherently local, updating <span class="math inline">\(u_i^{n+1}\)</span> based only on immediate neighbors (<span class="math inline">\(u_{i-1}^n\)</span>, <span class="math inline">\(u_i^n\)</span>, <span class="math inline">\(u_{i+1}^n\)</span>).</li><li>The effects of distant changes are limited by the numerical grid and do not cause instability or spurious results if the scheme is stable.</li></ul><h4 id="conclusion-1">Conclusion</h4><p>The infinite speed of propagation in the heat equation is a theoretical concern that does not prevent FDM from being applied. Numerical schemes operate on a discretized version of the problem, which respects finite grid and time step sizes. With appropriate domain size, boundary conditions, and stability checks, FDM provides accurate solutions for practical problems involving the heat equation.</p><h2 id="generalizing-to-higher-dimensions">Generalizing to Higher Dimensions</h2><p>If there are n independent variables x1, x2 , …, xn, a general linear partial differential equation of second order has the form,</p><p><span class="math display">\[\begin{align*} L u =\sum_{i=1}^n\sum_{j=1}^n a_{i,j} \frac{\partial^2 u}{\partial x_i \partial x_j} \quad+ \text{lower-order terms} = 0\end{align*} \]</span></p><p>The classification depends upon the signature of the eigenvalues of the coefficient matrix <span class="math inline">\(A = a_{i,j}\)</span>.</p><ul><li><code>Elliptic</code>: the eigenvalues are all positive or all negative.</li><li><code>Parabolic</code>: the eigenvalues are all positive or all negative, except one that is zero.</li><li><code>Hyperbolic</code>: there is only one negative eigenvalue and all the rest are positive, or there is only one positive eigenvalue and all the rest are negative.</li><li><code>Ultrahyperbolic</code>: there is more than one positive eigenvalue and more than one negative eigenvalue, and there are no zero eigenvalues.</li></ul><p>However, the classification only depends on linearity of the second-order terms and is therefore applicable to semi- and quasilinear PDEs as well.</p><h1 id="references">References</h1><ol type="1"><li><a href="https://www.ljll.fr/frey/cours/UdC/ma691/ma691_ch3.pdf">Partial differential equations</a></li><li><a href="http://www.fluid.tuwien.ac.at/322042?action=AttachFile&amp;do=get&amp;target=Classification_v2.pdf">Classification of PDEs</a></li><li><a href="https://cns.gatech.edu/~predrag/courses/PHYS-6124-12/StGoChap6.pdf">Chapter 6 Partial Differential Equations</a><ol type="1"><li>domain of influence</li><li>domain of dependence</li></ol></li><li><a href="https://web.math.sinica.edu.tw/media/pdf/d172/17201.pdf">丘成桐院士演講: 偏微分方程的方法 (<strong>推薦</strong>)</a><ol type="1"><li>探討了偏微分方程在動態和靜態問題中的應用，特別是如何利用這些方程來理解系統的行為</li><li>引入了「極限環」的概念，描述當時間足夠長時，系統會趨近於某一穩定軌道</li><li>當系統慢慢接近這一軌道時，可以得到一個與時間無關的方程，這個方程在機率上僅與 $ f $ 本身有關</li><li>研究如<strong>熱方程</strong>和<strong>波動方程</strong>等工具的重要性，以便更好地理解 <strong>Laplace 方程</strong>及其解的整體行為</li></ol></li><li><a href="https://www.ljll.fr/frey/ftp/finite-differences.pdf">The finite difference method</a><ol type="1"><li>It is well-known that solving the initial-value problem for the heat equation forward in time takes a discontinuous initial temperature <span class="math inline">\(u\)</span> at time <span class="math inline">\(t_0\)</span> into a temperature which is instantly smooth as soon as the times <span class="math inline">\(t &gt; t_0\)</span> . This may not be physically possible, since there would then be information propagation at infinite speed, which is in contradiction with the <strong>causality</strong> principle. Therefore this is a theoretical property of the mathematical equation.</li></ol></li></ol>]]></content>
    
    
    <categories>
      
      <category>Maths</category>
      
    </categories>
    
    
    <tags>
      
      <tag>NWP</tag>
      
      <tag>AI</tag>
      
      <tag>ML</tag>
      
      <tag>PDE</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Maths | Boundary Conditions</title>
    <link href="/2024/10/25/maths-Boundary-conditions/"/>
    <url>/2024/10/25/maths-Boundary-conditions/</url>
    
    <content type="html"><![CDATA[<p>In the study of differential equations, a boundary-value problem is a differential equation subjected to constraints called boundary conditions. A solution to a boundary value problem is a solution to the differential equation which also satisfies the boundary conditions.</p><p>Summary of boundary conditions for the unknown function, <span class="math inline">\(y\)</span>, constants <span class="math inline">\(c_0\)</span> and <span class="math inline">\(c_1\)</span> specified by the boundary conditions, and known scalar functions <span class="math inline">\(f\)</span> and <span class="math inline">\(g\)</span> pecified by the boundary conditions.</p><table><thead><tr class="header"><th style="text-align: center;">Name</th><th style="text-align: center;">Form on 1st part of boundary</th><th style="text-align: center;">Form on 2nd part of boundary</th></tr></thead><tbody><tr class="odd"><td style="text-align: center;">Dirichlet</td><td style="text-align: center;"><span class="math inline">\(y = f\)</span></td><td style="text-align: center;"></td></tr><tr class="even"><td style="text-align: center;">Neumann</td><td style="text-align: center;"><span class="math inline">\(\dfrac{\partial y}{\partial n} = f\)</span></td><td style="text-align: center;"></td></tr><tr class="odd"><td style="text-align: center;">Robin</td><td style="text-align: center;"><span class="math inline">\(c_0 y + c_1 \dfrac{\partial y}{\partial n} = f\)</span></td><td style="text-align: center;"></td></tr><tr class="even"><td style="text-align: center;">Mixed</td><td style="text-align: center;"><span class="math inline">\(y = f\)</span></td><td style="text-align: center;"><span class="math inline">\(c_0 y + c_1 \dfrac{\partial y}{\partial n} = g\)</span></td></tr><tr class="odd"><td style="text-align: center;">Cauchy</td><td style="text-align: center;">both <span class="math inline">\(y = f\)</span> and <span class="math inline">\(\dfrac{\partial y}{\partial n} = g\)</span></td><td style="text-align: center;"></td></tr></tbody></table><ul><li>根據條件的形式，邊值條件分以下三類<ul><li>第一類邊值條件：也稱為狄利克雷邊界條件，直接描述物理系統邊界上的物理量，例如振動的弦兩端與平衡位置的距離；</li><li>第二類邊值條件：也稱為諾伊曼邊界條件，描述物理系統邊界上物理量垂直邊界的導數的情況，例如導熱細杆端點的熱流；</li><li>第三類邊值條件：物理系統邊界上物理量與垂直邊界導數的線性組合，例如，細杆端點的自由冷卻，溫度、熱流均不確定，但是二者的關係確定，即可列出二者線性組合而成的邊值條件。</li></ul></li></ul><table><thead><tr class="header"><th>Boundary type</th><th>Formal Name</th><th>Mathematical form</th></tr></thead><tbody><tr class="odd"><td>Type 1</td><td>Dirichlet</td><td><span class="math inline">\(h(x,y,z,t) = constant\)</span></td></tr><tr class="even"><td>Type 2</td><td>Neumann</td><td><span class="math inline">\(\dfrac{\partial h}{\partial n} = constant\)</span></td></tr><tr class="odd"><td>Type 3</td><td>Cauchy</td><td><span class="math inline">\(\dfrac{\partial h}{\partial n} + c h= constant\)</span></td></tr></tbody></table><p>邊值條件也可以根據邊值問題對應的微分算子來分類：若是使用橢圓算子，則問題為橢圓邊值問題；使用雙曲線算子，則問題為雙曲線邊值問題。依微分算子還可以將問題再細分為線性及非線性等。</p>]]></content>
    
    
    <categories>
      
      <category>Maths</category>
      
    </categories>
    
    
    <tags>
      
      <tag>NWP</tag>
      
      <tag>AI</tag>
      
      <tag>ML</tag>
      
      <tag>PDE</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ML | DeepONet</title>
    <link href="/2024/10/24/ML-DeepONet/"/>
    <url>/2024/10/24/ML-DeepONet/</url>
    
    <content type="html"><![CDATA[<h1 id="deeponet">DeepONet</h1><p>DeepONet is a novel deep learning architecture designed to approximate nonlinear operators, which are mappings from one function space to another. Developed by researchers at Brown University, DeepONet represents a significant advancement in the field of machine learning, particularly in its ability to handle complex mathematical operations typically associated with differential equations.</p><h2 id="architecture">Architecture</h2><p>The DeepONet framework consists of two main components:</p><ul><li><strong>Branch Network</strong>: This network encodes the input function space, capturing data from discrete sensor locations.</li><li><strong>Trunk Network</strong>: This network encodes the output function space, determining how the input data is transformed into outputs.</li></ul><p>Together, these networks enable DeepONet to learn a mapping between functions rather than just pointwise values, which is a common limitation of traditional neural networks.</p><h2 id="key-features">Key Features</h2><ul><li><strong>Universal Approximation</strong>: DeepONet is grounded in the universal approximation theorem for operators, allowing it to approximate any continuous nonlinear operator with high accuracy. This capability extends beyond what standard neural networks can achieve.</li><li><strong>Speed and Efficiency</strong>: Once trained, DeepONet can perform real-time predictions significantly faster than conventional solvers used for differential equations. It can handle complex systems and make predictions in fractions of a second, which is particularly useful in applications like autonomous vehicles and digital twins for real-time modeling.</li><li><strong>Versatility</strong>: The architecture can be applied across various domains, including climate modeling, robotics, and even nuclear energy systems. Its ability to generalize from training data allows it to predict outcomes for new inputs that were not part of the training set.</li></ul><h2 id="applications">Applications</h2><p>DeepONet has promising applications in:</p><ul><li><strong>Autonomous Vehicles</strong>: Real-time predictions can enhance decision-making processes.</li><li><strong>Digital Twins</strong>: It enables accurate modeling of physical systems without the need for extensive retraining under varying conditions.</li><li><strong>Complex Systems Simulation</strong>: The architecture can represent intricate behaviors in dynamic environments, making it suitable for tasks such as climate modeling and engineering design.</li></ul><h1 id="universal-approximation-theorem">Universal Approximation Theorem</h1><p><strong>Definition</strong></p><p>The theorem states that for <strong>any continuous function</strong> $ f: ^n  $ defined on a compact subset of $ ^n $, there exists a neural network $ g $ such that the difference between $ f $ and $ g $ can be made arbitrarily small. Formally, for any $ &gt; 0 $, there exists a neural network with a finite number of neurons such that:</p><p><span class="math display">\[| f(x) - g(x) | &lt; \epsilon\]</span></p><p>for all $ x $ in the domain of interest.</p><p><strong>Historical Background</strong></p><p>The theorem was independently proven by George Cybenko in 1989, who focused on networks using sigmoid activation functions, and later by Kurt Hornik in 1991, who generalized it to include other activation functions like ReLU (Rectified Linear Unit).</p><p><strong>Implications</strong></p><p>It has profound implications for the design and understanding of neural networks:</p><ul><li><strong>Expressive Power</strong>: It guarantees that neural networks can model complex relationships in data, making them suitable for tasks like image classification, function approximation, and more.</li><li><strong>Architecture Design</strong>: The theorem informs users about the necessary architecture (e.g., number of layers and neurons) required to achieve desired approximations.</li></ul><p><strong>Limitations</strong></p><p>While the UAT provides a theoretical foundation, it does not address practical aspects such as:</p><ul><li><strong>Generalization</strong>: The ability of a network to perform well on unseen data is not guaranteed by the theorem alone. Techniques like regularization and cross-validation are necessary to improve generalization.</li><li><strong>Computational Feasibility</strong>: The theorem does not specify how to construct the network or find the optimal parameters effectively. In practice, training methods like backpropagation are used, but they may not always reach the global optimum.</li></ul><p><strong>Reading</strong></p><ul><li><a href="https://www.deep-mind.org/2023/03/26/the-universal-approximation-theorem/">The Universal Approximation Theorem</a></li><li><a href="https://mitliagkas.github.io/ift6085-2020/ift-6085-lecture-10-notes.pdf">Expressivity and Universal Approximation Theorems Part 1</a></li></ul><h1 id="maths">Maths</h1><ul><li><a href="https://citeseerx.ist.psu.edu/document?repid=rep1&amp;type=pdf&amp;doi=d5cbb7a8ae0e4ac907515b901d5a3af7f68c98a3">Chen, T., &amp; Chen, H. (1995). Universal approximation to nonlinear operators by neural networks with arbitrary activation functions and its application to dynamical systems. IEEE transactions on neural networks, 6(4), 911-917.</a></li></ul><p>Theorem 5: Suppose that <span class="math inline">\(g\in (TW)\)</span>, <span class="math inline">\(X\)</span> is a Banach Space, <span class="math inline">\(K_1 X, K_2 R^n\)</span> are two compact sets in <span class="math inline">\(X\)</span> and <span class="math inline">\(R^n\)</span> respectively, <span class="math inline">\(V\)</span> is a compace set in <span class="math inline">\(C(K_1)\)</span>, <span class="math inline">\(G\)</span> is a nonlinear continuous operator, which maps <span class="math inline">\(V\)</span> into <span class="math inline">\(C(K_2)\)</span>, then for any $&gt;0 $, there are positive integers <span class="math inline">\(M, N, m\)</span> constants <span class="math inline">\(c_i^k, \zeta_k, \xi_{ij}^k \in R^n\)</span>, <span class="math inline">\(x_j \in K_1, i=1,...,M, k=1,...,N, j=1,...,m\)</span>, such that</p><p><span class="math display">\[\begin{align*} | G(u)(y) - \sum_{k=1}^N \sum_{i=1}^M c_i^k g( \sum_{j=1}^m \xi_{ij}^k u(x_{j}) + \theta_i^k) g(\omega_k \cdot y + \xi_k)| &lt; \epsilon, \qquad \forall u \in U \end{align*}\]</span></p><p>More details,</p><figure><img src="https://media.springernature.com/m685/springer-static/image/art%3A10.1038%2Fs42256-021-00302-5/MediaObjects/42256_2021_302_Fig1_HTML.png" alt="DeepONet" /><figcaption>DeepONet</figcaption></figure><p><span class="math display">\[\begin{align*} G(u)(y) &amp;= G(u) \otimes (y) \\&amp;= \sum_{k=1}^p b_k t_k \\&amp;= \sum_{k=1}^p b_k \sigma(w_k \cdot y + \zeta_k) \\&amp;= \sum_{k=1}^p \sum_{i=1}^n c_i^k  \sigma(\sum_{j=1}^m \xi_{ij}^k u(x_j) + \theta_i^k) \sigma(w_k \cdot y + \zeta_k) \\\end{align*} \]</span></p><p>For a trunk net,</p><p><span class="math display">\[\begin{align*} t_k &amp;= \sigma(w_k \cdot y + \zeta_k) \in \mathbb{R} \\\{t_k\}_{k=1,...,p} &amp;= \{\sigma(w_k \cdot y + \zeta_k)\} \in \mathbb{R}^p \\\end{align*} \]</span></p><p>For one branch net (num of neuron = <span class="math inline">\(n\)</span>) , all coefficients are dependent on <span class="math inline">\(k\)</span>,</p><p><span class="math display">\[\begin{align*} b_k = \sum_{i=1}^n c_i^k  \sigma(\sum_{j=1}^m \xi_{ij}^k u(x_j) + \theta_i^k) \in \mathbb{R}\end{align*} \]</span></p>]]></content>
    
    
    <categories>
      
      <category>ML</category>
      
    </categories>
    
    
    <tags>
      
      <tag>AI</tag>
      
      <tag>PINN</tag>
      
      <tag>DeepONet</tag>
      
      <tag>ML</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ML | Automatic Differentiation</title>
    <link href="/2024/10/22/ML-Automatic-Differentiation/"/>
    <url>/2024/10/22/ML-Automatic-Differentiation/</url>
    
    <content type="html"><![CDATA[<p>In mathematics and computer algebra, automatic differentiation (auto-differentiation, autodiff, or AD), also called algorithmic differentiation, computational differentiation, is a set of techniques to <strong>evaluate the partial derivative of a function specified</strong> by a computer program.</p><p>Automatic differentiation exploits the fact that every computer calculation, no matter how complicated, executes a sequence of elementary arithmetic operations (addition, subtraction, multiplication, division, etc.) and elementary functions (exp, log, sin, cos, etc.). By applying the chain rule repeatedly to these operations, partial derivatives of arbitrary order can be computed automatically, accurately to working precision, and using at most a small constant factor of more arithmetic operations than the original program.</p><ul><li>計算一個函數<strong>導數</strong>的方法</li><li>自動微分是利用電腦自動化<strong>求導</strong>的技術</li></ul><h1 id="references">References</h1><ol type="1"><li><a href="https://huggingface.co/blog/andmholm/what-is-automatic-differentiation">What's Automatic Differentiation?</a></li><li><a href="https://fancyerii.github.io/books/autodiff/">自动微分</a></li><li><a href="https://indico.ihep.ac.cn/event/17315/attachments/64130/75771/%E8%87%AA%E5%8A%A8%E5%BE%AE%E5%88%86.pdf">自动微分</a></li><li><a href="https://vlight.me/2018/04/01/curvature-and-automatic-differentiation/">曲率与自动微分</a></li></ol>]]></content>
    
    
    <categories>
      
      <category>ML</category>
      
    </categories>
    
    
    <tags>
      
      <tag>AI</tag>
      
      <tag>PINN</tag>
      
      <tag>DeepONet</tag>
      
      <tag>ML</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ML | Gaussian-Process (GP)</title>
    <link href="/2024/10/21/ML-Gaussian-Processes/"/>
    <url>/2024/10/21/ML-Gaussian-Processes/</url>
    
    <content type="html"><![CDATA[<p>In probability theory and statistics, a Gaussian process is a stochastic process (a collection of random variables indexed by time or space), such that every finite collection of those random variables has a multivariate normal distribution. The distribution of a Gaussian process is the joint distribution of all those (infinitely many) random variables, and as such, it is a distribution over functions with a continuous domain, e.g. time or space.</p><p>From the above derivation, you can view Gaussian process as a <strong>generalization of multivariate Gaussian distribution to infinitely many variables</strong>. Here we also provide the textbook definition of GP, in case you had to testify under oath:</p><div class="note note-warning">            <p>A Gaussian process is a collection of random variables, any finite number of which have consistent Gaussian distributions.</p>          </div><p><span class="math display">\[f(x) \sim \mathcal{G}\mathcal{P}(m(x), K(x, x&#39;))\]</span></p><div class="note note-warning">            <p>A Gaussian process is a probability distribution over possible functions that fit a set of points.</p>          </div><p>Just like a Gaussian distribution is specified by its mean and variance, a Gaussian process is completely defined by</p><ul><li><ol type="1"><li>a mean function <span class="math inline">\(m(x)\)</span> telling you the mean at any point of the input space and</li></ol></li><li><ol start="2" type="1"><li>a covariance function <span class="math inline">\(K(x,x&#39;)\)</span> that sets the covariance between points.</li></ol></li></ul><p>The mean can be any value and the covariance matrix should be positive definite.</p><p>The GP approach, in contrast, is a non-parametric approach, in that it finds a distribution over the possible functions <span class="math inline">\(f(x)\)</span> that are consistent with the observed data. As with all Bayesian methods it begins with a prior distribution and updates this as data points are observed, producing the posterior distribution over functions.</p><p><span class="math display">\[\begin{align}p(\mathbf{y} | \Sigma ) \approx \exp (-\frac{1}{2} \mathbf{y}^T \Sigma \mathbf{y})\end{align}\]</span></p><p><span class="math display">\[\Sigma (x_1, x_2) = K(x_1, x_2) + I \sigma_y^2\]</span></p><p>The covariance matrices in all the above examples are computed using the <strong>Radial Basis Function (RBF)</strong> kernel and <span class="math inline">\(\sigma_y\)</span> can be noise term.</p><ul><li>Here is an example of a 2D Gaussian distribution with mean 0, with the oval contours denoting points of constant probability.</li><li>we can now visualize the sampling operation in a new way by taking multiple "random points"</li><li>For conditioning, we can simply fix one of the endpoint on the index graph (in below plots, fix y1 to 1) and sample from y2</li></ul><div class="group-image-container"><div class="group-image-row"><div class="group-image-wrap"><img src="https://user-images.githubusercontent.com/18204038/60500191-ccc33380-9cb1-11e9-8f80-5b695d896000.png" alt="Here is an example of a 2D Gaussian distribution with mean 0, with the oval contours denoting points of constant probability." /></div><div class="group-image-wrap"><img src="https://user-images.githubusercontent.com/18204038/68397330-eba76a00-016a-11ea-9950-d1dec3ee1285.gif" alt="we can now visualize the sampling operation in a new way by taking multiple &quot;random points&quot;" /></div></div><div class="group-image-row"><div class="group-image-wrap"><img src="https://user-images.githubusercontent.com/18204038/68397339-ee09c400-016a-11ea-94c9-a3121f725deb.gif" alt="For conditioning, we can simply fix one of the endpoint on the index graph (in below plots, fix y1 to 1) and sample from y2" /></div><div class="group-image-wrap"><img src="https://user-images.githubusercontent.com/18204038/60500477-4f4bf300-9cb2-11e9-9a90-7fc316f64468.png" /></div></div><div class="group-image-row"><div class="group-image-wrap"><img src="https://user-images.githubusercontent.com/18204038/68397345-f235e180-016a-11ea-9ebb-a81bb34d2033.gif" /></div><div class="group-image-wrap"><img src="https://user-images.githubusercontent.com/18204038/68397346-f2ce7800-016a-11ea-96d2-cce9ee1c8116.gif" /></div></div></div><p>Conditional probability is,</p><p><span class="math display">\[\begin{align}P(A|B) = \frac{P(A \cap B)}{P(B)}\end{align}\tag{1}\]</span></p><h2 id="get-real-number">Get real number</h2><p>It feels like all the points on the x-axis have to be integers because they are indices, while in reality, we want to model observations with real values.</p><p>We can calculate this covariance matrix for any real-valued <span class="math inline">\(x_1\)</span> and <span class="math inline">\(x_2\)</span> by simply plugging them in. The real-valued x's effectively result in an infinite-dimensional Gaussian defined by the covariance matrix.</p><h1 id="useful-reading">Useful reading</h1><ul><li><a href="https://thegradient.pub/gaussian-process-not-quite-for-dummies/" class="uri">https://thegradient.pub/gaussian-process-not-quite-for-dummies/</a></li><li><a href="https://katbailey.github.io/post/gaussian-processes-for-dummies/" class="uri">https://katbailey.github.io/post/gaussian-processes-for-dummies/</a></li></ul><iframe width="560" height="315" src="https://www.youtube.com/embed/92-98SYOdlY?si=onEyPw4YKVl68G4p" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen></iframe>]]></content>
    
    
    <categories>
      
      <category>ML</category>
      
    </categories>
    
    
    <tags>
      
      <tag>AI</tag>
      
      <tag>PINN</tag>
      
      <tag>DeepONet</tag>
      
      <tag>ML</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>NWP | ECMWF</title>
    <link href="/2024/10/18/ecmwf-introduction/"/>
    <url>/2024/10/18/ecmwf-introduction/</url>
    
    <content type="html"><![CDATA[<p>The organisation was <strong>established in 1975</strong> and now employs around 500 staff from more than 30 countries. ECMWF is one of the six members of the Co-ordinated Organisations, which also include the North Atlantic Treaty Organisation (NATO), the Council of Europe (CoE), the European Space Agency (ESA), the Organisation for Economic Co-operation and Development (OECD), and the European Organisation for the Exploitation of Meteorological Satellites (EUMETSAT).</p><p><strong>ECMWF is headquartered in Reading, UK, with additional sites in Bologna, Italy, and Bonn, Germany</strong>.</p><p>The European Centre for Medium-Range Weather Forecasts (ECMWF) is an independent intergovernmental organisation supported by most of the nations of Europe. It is based at three sites: Shinfield Park, Reading, United Kingdom; Bologna, Italy; and Bonn, Germany. It operates one of the largest supercomputer complexes in Europe and the world's largest archive of numerical weather prediction data.</p><h1 id="major-changes-introduced-with-cy48r1-spring-2023">Major changes introduced with Cy48r1 Spring 2023</h1><p><a href="https://confluence.ecmwf.int/display/FUG/Section+2.1.2+Model+Configurations">Some major changes were made to the IFS with the introduction of the Cy48r1 in Spring 2023.</a></p><p>After the introduction of Cy48r1 in Spring 2023 the:</p><p><strong>High Resolution (HRES)</strong>:</p><ul><li>is run four times daily:<ul><li>base times 00 UTC and 12 UTC, producing a 10 day forecast (T+0 to T+240).</li><li>base times 06UTC and 18UTC, producing a 3.75 day forecast (T+0 to T+90).</li></ul></li><li>has <strong>horizontal resolution of 9 km</strong> and vertical resolution of <strong>137</strong> model levels.</li></ul><p><strong>Medium range ensemble (ENS)</strong>:</p><ul><li>is run four times daily:<ul><li>base times 00 UTC and 12 UTC, producing a 10 day forecast (T+0 to T+240) and also a 15 day forecast (T+0 to T+360).</li><li>base times 06UTC and 18UTC, producing a 6 day forecast (T+0 to T+144). Results from these runs are:</li></ul></li><li>used in Early cut off analysis (SCDA) and Long window data analysis (LWDA).</li><li>disseminated T+0 to T+72.</li><li>has <strong>horizontal resolution of 9 km</strong> and vertical resolution of <strong>137</strong> model levels. These values are the same as those of the High Resolution (HRES).</li><li>has <strong>50 ensemble members</strong> plus an unperturbed control member (CTRL).</li><li>the unperturbed control member (CTRL) corresponds to the High Resolution (HRES) in earlier IFS versions. CTRL forecasts maintain continuity of output for users.</li></ul><p><strong>Extended range ensemble</strong>:</p><ul><li>is run once daily, base time 00 UTC, producing a 46 day forecast (Day0 to Day46).<ul><li>has <strong>horizontal resolution of 36 km</strong> and vertical resolution of <strong>137</strong> model levels.<br /></li><li>has <strong>100 members</strong> plus an unperturbed control member.</li></ul></li></ul><h1 id="ecmwf-ifs-9km-computing-resource-requirements-2024">ECMWF IFS 9km computing resource requirements (2024)</h1><ul><li><a href="https://mp.weixin.qq.com/s/Qu8JSdAMSJywmlCJM6QDzw" class="uri">https://mp.weixin.qq.com/s/Qu8JSdAMSJywmlCJM6QDzw</a><ul><li>根据ECMWF官网“How to optimise the computing aspects of numerical weather forecasts”文章, IFS 9km模式预报15天需要大约50个计算节点</li><li>推算IFS预报一天能够在3.6分钟墙钟时间内完成。</li><li>IFS运行计算机应该是博洛尼亚计算中心机器，每个计算节点为128核心，总计算资源数大概在6784核左右。</li></ul></li></ul>]]></content>
    
    
    <categories>
      
      <category>NWP</category>
      
    </categories>
    
    
    <tags>
      
      <tag>NWP</tag>
      
      <tag>WRF</tag>
      
      <tag>MPAS</tag>
      
      <tag>ECMWF</tag>
      
      <tag>AI</tag>
      
      <tag>ML</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>LaTex | Figures</title>
    <link href="/2024/10/17/latex-figure-format/"/>
    <url>/2024/10/17/latex-figure-format/</url>
    
    <content type="html"><![CDATA[<h1 id="figuresgraphics">Figures/Graphics</h1><h2 id="vector-files.">Vector files.</h2><p>Mathematical formulas establish points on a grid to build vector images. Versatility is key for vector files because they can adjust in size countless times without losing resolution. That’s great for images that need to be regularly resized. Learn more about vector files: <strong>SVG files, STL files, EPS files.</strong></p><h2 id="raster-files.">Raster files.</h2><p>A raster image file is comprised of a fixed number of color pixels. This means if the file is resized, its resolution could be compromised. Most images found online and in print are raster image files, which can be opened with many programs. Read more about raster files: <strong>GIF files, PNG files, JPEG files.</strong></p><h2 id="what-is-all-this-important">What is all this important?</h2><p>Graphics are different from text fonts, they can't be handled by TeX's font mechanisms; instead, there are special LaTeX packages to deal with them. But, like fonts, there's still a fundamental difference between device-independent or vector graphics (like PostScript drawings) and raster graphics, which are resolution- or device-dependent. Different mechanisms (and different packages) are needed to include the different kinds of graphic files.</p><p>Because the graphicx package used with the</p><ul><li><strong>latex command</strong> requires all graphics to be in <strong>EPS format</strong>;</li><li><strong>pdflatex command</strong>, perversely, requires graphics to be <strong>either JPEG, TIFF, PNG, or PDF — but not EPS</strong>.</li></ul><p>So if you compile your LaTeX source file with the latex command, you'll have to convert any non-EPS files to EPS format.</p><div class="note note-warning">            <p><strong>But, if you use pdflatex, you'll have to convert any EPS files to either PNG or (preferably) PDF format.</strong></p>          </div><h2 id="in-latex">In LaTex,</h2><figure class="highlight latex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs latex"><span class="hljs-keyword">\usepackage</span>&#123;float&#125;<br><span class="hljs-keyword">\usepackage</span>&#123;graphicx&#125;<br><br><span class="hljs-keyword">\begin</span>&#123;figure&#125;[H]<br><span class="hljs-keyword">\centering</span><br><span class="hljs-keyword">\includegraphics</span>[scale=0.5]&#123;universe&#125;<br><span class="hljs-comment">%\includegraphics[width=\textwidth]&#123;universe&#125;</span><br><span class="hljs-comment">%\includegraphics[scale=1.2, angle=45]&#123;universe&#125;</span><br><span class="hljs-keyword">\caption</span>&#123;The Universe&#125;<br><span class="hljs-keyword">\label</span>&#123;fig:universe&#125;<br><span class="hljs-keyword">\end</span>&#123;figure&#125;<br></code></pre></td></tr></table></figure><table><thead><tr class="header"><th>Parameter</th><th>Action</th></tr></thead><tbody><tr class="odd"><td>H</td><td>Place exactly at spot in source text</td></tr><tr class="even"><td>h</td><td>Place approximately at spot in source test</td></tr><tr class="odd"><td>t</td><td>Place at top of page</td></tr><tr class="even"><td>b</td><td>Place at bottom of page</td></tr><tr class="odd"><td>p</td><td>Place on page for floats only</td></tr><tr class="even"><td>!</td><td>Override internal LaTeX parameters for determining float position</td></tr></tbody></table><h2 id="high-quality-images">High quality images</h2><div class="note note-warning">            <p>Warning! Notice that this picture looks pixelated, especially at this scale. One must be careful to use high enough quality images. Preferable are <strong>vectorized graphics</strong> which will scale without pixelation.</p>          </div><div class="note note-warning">            <p><strong>Save as .pdf</strong></p>          </div><figure><img src="https://i.imgur.com/3zjwQQS.jpeg" alt="Difference between .png and .pdf (zoom in 500%). For printing purposes, the best file pdf format to use is a PDF." /><figcaption>Difference between .png and .pdf (zoom in 500%). For printing purposes, the best file pdf format to use is a PDF.</figcaption></figure><h2 id="subfigures">Subfigures</h2><ul><li><a href="https://www1.cmc.edu/pages/faculty/aaksoy/latex/latexfive.html" class="uri">https://www1.cmc.edu/pages/faculty/aaksoy/latex/latexfive.html</a></li></ul><p>When one wants to put multiple subfigures inside a subfigure, one must use two packages, <strong>caption and subcaption</strong>. There are other packages such as <em>subfigure and subfig, however, these are no longer considered standard</em>.</p><p>Try the code below to see three subfigures within a figure, each with a separate caption in addition to a global caption.</p><figure class="highlight latex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs latex"><span class="hljs-keyword">\documentclass</span>&#123;article&#125;<br><span class="hljs-keyword">\usepackage</span>&#123;float&#125;<br><span class="hljs-keyword">\usepackage</span>&#123;graphicx&#125;<br><span class="hljs-keyword">\usepackage</span>&#123;caption&#125;<br><span class="hljs-keyword">\usepackage</span>&#123;subcaption&#125;<br><br><span class="hljs-keyword">\begin</span>&#123;document&#125;<br><span class="hljs-keyword">\begin</span>&#123;figure&#125;[H]<br><span class="hljs-keyword">\centering</span><br><span class="hljs-keyword">\begin</span>&#123;subfigure&#125;&#123;.3<span class="hljs-keyword">\textwidth</span>&#125;<br><span class="hljs-keyword">\includegraphics</span>[width=<span class="hljs-keyword">\textwidth</span>]&#123;atom.png&#125;<br><span class="hljs-keyword">\caption</span>&#123;Atom 1&#125;<br><span class="hljs-keyword">\end</span>&#123;subfigure&#125;<br><span class="hljs-comment">%%%%%%%%%%%%%%</span><br><span class="hljs-keyword">\begin</span>&#123;subfigure&#125;&#123;.3<span class="hljs-keyword">\textwidth</span>&#125;<br><span class="hljs-keyword">\includegraphics</span>[width=<span class="hljs-keyword">\textwidth</span>]&#123;atom.png&#125;<br><span class="hljs-keyword">\caption</span>&#123;Atom 2&#125;<br><span class="hljs-keyword">\end</span>&#123;subfigure&#125;<br><span class="hljs-comment">%%%%%%%%%%%%%%</span><br><span class="hljs-keyword">\begin</span>&#123;subfigure&#125;&#123;.3<span class="hljs-keyword">\textwidth</span>&#125;<br><span class="hljs-keyword">\includegraphics</span>[width=<span class="hljs-keyword">\textwidth</span>]&#123;atom.png&#125;<br><span class="hljs-keyword">\caption</span>&#123;Atom 3&#125;<br><span class="hljs-keyword">\end</span>&#123;subfigure&#125;<br><span class="hljs-keyword">\caption</span>&#123;Atoms are fun!&#125;<br><span class="hljs-keyword">\end</span>&#123;figure&#125;<br><span class="hljs-keyword">\end</span>&#123;document&#125;<br></code></pre></td></tr></table></figure><h2 id="wrapping-text-around-figures">Wrapping text around figures</h2><ul><li><a href="https://www.overleaf.com/learn/latex/Inserting_Images" class="uri">https://www.overleaf.com/learn/latex/Inserting_Images</a></li></ul><p>For the commands in the example to work, you have to import the <strong>wrapfig</strong> package. To use <strong>wrapfig</strong>, include the following line in the document preamble:</p><figure class="highlight latex"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs latex"><span class="hljs-keyword">\usepackage</span>&#123;wrapfig&#125;<br></code></pre></td></tr></table></figure><p>This makes the wrapfigure environment available and we can place an \includegraphics command inside it to create a figure around which text will be wrapped. Here is how we can specify a wrapfigure environment:</p><figure class="highlight latex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs latex"><span class="hljs-keyword">\begin</span>&#123;wrapfigure&#125;[lineheight]&#123;position&#125;&#123;width&#125;<br>  ...<br><span class="hljs-keyword">\end</span>&#123;wrapfigure&#125;<br></code></pre></td></tr></table></figure><table><thead><tr class="header"><th>Specifier</th><th>Specifier</th><th>Actioin</th></tr></thead><tbody><tr class="odd"><td>r</td><td>R</td><td>right side of the text</td></tr><tr class="even"><td>l</td><td>L</td><td>left side of the text</td></tr><tr class="odd"><td>i</td><td>I</td><td>inside edge–near the binding (in a twoside document)</td></tr><tr class="even"><td>o</td><td>O</td><td>outside edge–far from the binding</td></tr></tbody></table><p><strong>The uppercase version allows the figure to float. The lowercase version means exactly here.</strong></p><p>It's also possible to wrap the text around a figure. When the document contains small pictures this makes it look better.</p><figure class="highlight latex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs latex"><span class="hljs-keyword">\begin</span>&#123;wrapfigure&#125;&#123;r&#125;&#123;0.25<span class="hljs-keyword">\textwidth</span>&#125; <span class="hljs-comment">%this figure will be at the right</span><br>    <span class="hljs-keyword">\centering</span><br>    <span class="hljs-keyword">\includegraphics</span>[width=0.25<span class="hljs-keyword">\textwidth</span>]&#123;mesh&#125;<br><span class="hljs-keyword">\end</span>&#123;wrapfigure&#125;<br><br>There are several ways to plot a function of two variables, <br>depending on the information you are interested in. For <br>instance, if you want to see the mesh of a function so it <br>easier to see the derivative you can use a plot like the <br>one on the left.<br></code></pre></td></tr></table></figure><figure><img src="https://sharelatex-wiki-cdn-671420.c.cdn77.org/learn-scripts/images/a/ac/InsertingImagesEx8Overleaf.png" alt="Wrapping text around figures" /><figcaption>Wrapping text around figures</figcaption></figure><h1 id="journals-graphics-requirements">Journals | Graphics Requirements</h1><h2 id="american-geophysical-union-agu">American Geophysical Union (AGU)</h2><ul><li>https://www.agu.org/publications/authors/journals/text-graphics-requirements#figures</li></ul><p>Figures</p><p>AGU recommends that figures be prepared in one of the following formats:</p><ul><li><strong>JPG, TIFF, EPS, PS or PDF. </strong></li></ul><p>Figures should be embedded in the main manuscript for submission but uploaded separately at resubmission or revision (because separate files are needed for production). For revision, each figure file must be complete and contain all parts of a single numbered figure. In other words, a figure with multiple parts must be consolidated into a single cohesive file. Do not include figure captions or figure titles (e.g., “Figure 1”) as any part of the graphic itself. Separate files for different parts of a figure cannot be accommodated.</p><h1 id="references">References</h1><ol type="1"><li><a href="https://www.adobe.com/hk_zh/creativecloud/file-types/image/vector/ps-file.html">PS 檔案</a><ol type="1"><li><strong>PS 代表 PostScript，是一種向量圖形檔案</strong>。其特點是可以將數位圖形和文字備妥進行列印。您可以將 PS 檔案直接傳送至印表機，而無需使用應用程式開啟檔案。不過，只有為數不多的選項可以開啟 PS 檔案，使其成為影像方面功能最少的檔案類型之一。由於 PS 檔案比部分相關檔案類型稍舊，使用者經常將 PS 檔案轉換成 PDF，讓處理工作更簡單流暢。Adobe 在 1980 年代開發 PS 檔案，協助電腦使用者輕鬆將文字和圖形轉換成印刷副本。這在當時是一大創舉，對方才萌芽的桌面排版 (Desktop Publishing，DTP) 產業來說更是如此。因此，當早期的 Apple 印表機搭載 PostScript 功能時，DTP 在全球出現爆炸性成長，記者、學生和業餘愛好者都可以將手動打字的稿件轉化成令人耳目一新的出版品。現在，除了專門出版品之外，出版品直接在網路上發行的比率已超越印刷形式，使得 PS 檔案格式不再像以往普遍使用。不過，作為圖形格式，PS 仍是最直覺易用的檔案類型之一。</li><li><strong>PDF 在網路和印刷領域上，是 PS 檔案最廣受支援的下一代檔案</strong>。</li><li>傳統的的文件慣用 PS 或 EPS 圖檔，這種所謂的「描邊圖檔」非常適合數學或統計圖，可以為圖形加上文字或其他線條，檔案小而且清晰，編譯完成的檔案也是 PS 檔（近年來逐漸改成 PDF 檔，以利網路傳輸）。因為網路興起及多媒體的表現日漸重要，才有壓縮圖檔的出現，其中以 JPG 圖檔最為流行，適合各種靜態圖形。</li></ol></li><li><a href="https://www.adobe.com/hk_zh/creativecloud/file-types/image/vector/eps-file.html">EPS 檔案</a><ol type="1"><li>壓縮式 PostScript (Encapsulated PostScript) 於 1980 年代晚期由 Adobe 推出後，便成為設計產業早期選用的影像格式。此格式的設計宗旨是協助影像和插圖與佔有主要比重的文字創作相整合。</li><li><strong>雖然 EPS 檔案大多已由 PDF 等更新的檔案格式取代</strong>，這種幾乎相容於所有系統和軟體的舊版格式仍具備實用性。</li><li><strong>PDF 可編輯且相容於更多作業系統</strong>。但是，如果您使用較舊的列印裝置，可能會發現 EPS 是更理想的選擇。</li></ol></li><li><a href="https://www.adobe.com/hk_zh/creativecloud/file-types/image/vector/svg-file.html">SVG 檔案</a><ol type="1"><li>可縮放向量圖形 (SVG) 是一種適合網頁使用的<strong>向量檔案格式</strong>。與 JPEG 等像素型點陣檔案有所不同，向量檔案是透過以網格點線為基礎的數學公式儲存影像。這表示 SVG <strong>這類向量檔可以大幅調整尺寸卻不會損失品質</strong>，<strong>因此很適合用於標誌及複雜的線上圖形</strong>。</li><li>SVG 檔案的歷史可追溯到 1990 年代晚期，全球資訊網協會 (W3C) 曾邀請開發人員針對新的向量圖形格式提案。當時協會收到六項提案，最後成功協助 W3C 推出 SVG 格式。</li><li>SVG 花了一段時間累積知名度。這種格式在過去鮮少人使用；直到 2017 年，人們發現在新型網頁瀏覽器上使用 SVG 的好處，這種格式才逐漸受到歡迎。現在，SVG 已廣泛用於 2D 網站影像，因為大多數使用向量檔案的瀏覽器和繪圖應用程式都可輕鬆處理此檔案格式。</li></ol></li><li><a href="https://www.adobe.com/hk_zh/creativecloud/file-types/image/raster/tiff-file.html">TIFF 檔案</a><ol type="1"><li>TIFF 代表標籤影像檔案格式 (Tag Image File Format)，是一種用於儲存點陣圖形和影像資訊的電腦檔案。TIFF 是攝影師偏好使用的格式。如果您想避免失真檔案格式，TIFF 便是編輯作業前相當易用的高品質影像儲存格式。</li><li><strong>是一種不失真的檔案壓縮形式，這表示其檔案大小比多數同類檔案來得大，但影像品質不會受損</strong>。</li><li>Aldus Corporation 於 1980 年代中期推出 TIFF 檔案格式，用於桌面排版。TIFF 不僅能保留高品質資料，也可以直接從電腦發布內容。這種檔案設計成桌上型掃描器的通用格式；而之前的作業硬體 (視品牌和型號而定) 只支援數量有限的檔案格式。</li></ol></li><li><a href="https://www.adobe.com/hk_zh/creativecloud/file-types/image/raster/png-file.html">PNG 檔案</a><ol type="1"><li>PNG 的全名為可攜式網路圖形 (Portable Network Graphic)，是一種點陣影像檔案。因為 PNG 檔案類型能夠處理有透明或半透明背景的圖形，因此特別受到網頁設計師的喜愛。此檔案格式未申請專利，因此可使用任何影像編輯軟體開啟 PNG 檔案，而無需取得授權。</li><li>PNG 影像格式在 1995 年推出，由 IT 專家 Oliver Fromme 取名為 PING，隨後縮短為 PNG。</li><li>PNG 的發展傳承自 GIF 格式，這種格式在 PNG 首度推出時已存在八年。GIF 有幾項缺點，像是需要專利授權、色彩種類有限 (僅 256 色)，導致發展速度無法跟上不斷進步的電腦螢幕解析度。為了避免這類問題，PNG 檔案採用無專利設計，並提供更加豐富的色彩選擇。與 GIF 不同的是，PNG 是單一影像格式，不支援動畫。</li></ol></li><li><a href="https://www.adobe.com/hk_zh/creativecloud/file-types/image/raster/gif-file.html">GIF 檔案</a><ol type="1"><li>GIF 代表圖形交換格式 (Graphics Interchange Format)。GIF 是一種點陣檔案格式，專為主要出現在網際網路上的較基本影像所設計。<strong>每個檔案最多可支援每個像素 8 位元</strong>，而且可包含 256 種索引顏色。<strong>GIF 檔案也允許合併影像或影格，以建立基本動畫</strong>。</li><li>GIF 檔案格式是由電腦科學家 Steve Wilhite 和他在美國科技公司 CompuServe 的團隊於 1987 年 6 月所打造的。</li><li>GIF 檔案已進化成能夠提供更多<strong>動畫功能</strong>。例如，1995 年 Netscape Navigator 瀏覽器問世之後，創作者獲得了循環播放 GIF 動畫的能力。Facebook 在 2015 年開始支援 GIF，Instagram 則是在 2018 年開始支援。</li></ol></li><li><a href="https://www.adobe.com/hk_zh/creativecloud/file-types/image/raster/jpeg-file.html">JPEG 檔案</a><ol type="1"><li>JPEG 代表聯合圖像專家小組 (Joint Photographic Experts Group)，這個國際組織在 1980 年代末和 1990 年代初對此格式進行了標準化。自從攝影師開始在數位相機和其他複印設備上拍攝及儲存影像以來，JPEG 就一直是數位影像的首選檔案格式。</li><li>在 1986 年，顯示器技術還無法產生螢幕上的圖形。就在那時候，一個稱為國際標準化組織 (ISO) 的團隊開始研究如何將逼真的圖片帶到世界各地的小螢幕上。</li><li><strong>失真壓縮可能會節省空間，但是在處理高度壓縮的影像時，品質會受到影響</strong>。具有清晰邊緣和線條的影像在壓縮後會失去一些清晰度。</li><li>嚴謹的攝影師仍然不願以 JPEG 格式拍攝，因為他們想要保留所有影像細節以供後製處理或列印使用。不過，這種檔案格式仍然是主流人士的最愛。</li></ol></li></ol>]]></content>
    
    
    <categories>
      
      <category>LaTex</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>LaTex | Overview</title>
    <link href="/2024/10/17/latex-intro/"/>
    <url>/2024/10/17/latex-intro/</url>
    
    <content type="html"><![CDATA[<h1 id="latex">LaTeX</h1><p>LaTeX is a software system for typesetting documents. LaTeX is widely used in academia for the communication and publication of <strong>scientific documents and technical note-taking in many fields</strong>, owing partially to its support for complex mathematical notation. It also has a prominent role in the preparation and publication of books and articles that contain complex multilingual materials, such as Arabic and Greek. The typesetting system offers programmable desktop publishing features and extensive facilities for automating most aspects of typesetting and desktop publishing, including numbering and cross-referencing of tables and figures, chapter and section headings, graphics, page layout, indexing and bibliographies.</p><h1 id="texmaker">Texmaker</h1><ul><li><a href="https://www.xm1math.net/texmaker/" class="uri">https://www.xm1math.net/texmaker/</a></li></ul><p>Texmaker is a free and open-source LaTeX editor with an integrated PDF viewer compatible with Linux, macOS, and Windows. Written entirely as a Qt app, it features many tools needed to develop documents with LaTeX.</p><p>Texmaker是一款跨平台的開源LaTeX編輯器，它介面乾淨併集成有PDF閱讀器。</p><ul><li>Texmaker is a free, modern and cross-platform LaTeX editor for linux, macosx and windows systems that integrates many tools needed to develop documents with LaTeX, in just one application.</li><li>Texmaker includes unicode support, spell checking, auto-completion, code folding and a built-in pdf viewer with synctex support and continuous view mode.</li><li>Texmaker is easy to use and to configure.</li><li>Texmaker is released under the GPL license .</li></ul><figure><img src="https://upload.wikimedia.org/wikipedia/commons/6/66/TeXmaker_Interface.png" alt="TeXmaker interface" /><figcaption>TeXmaker interface</figcaption></figure><h1 id="overleaf">Overleaf</h1><ul><li><a href="https://www.overleaf.com/" class="uri">https://www.overleaf.com/</a></li></ul><div class="note note-warning">            <p>Overleaf是一個雲端協作式LaTeX編輯器，可用於編寫和發佈論文</p>          </div><p>Overleaf是一個雲端協作式LaTeX編輯器，可用於編寫和發佈論文。這一編輯器與很多科學雜誌出版商有合作關係，不但提供官方期刊的LaTeX模板，還能直接將文件提交至這些出版社。Overleaf由2011年兩名數學家John Hammersley和John Lees-Miller共同建立的公司WriteLaTeX Limited開發，他們憑藉自己在學術界的經驗開發了這一平台，因此Overleaf比其他LaTex編輯器更具優勢</p><p>The benefits of using Overleaf include:</p><ul><li>Instant access: no installation, real-time collaborative editing</li><li>Efficient handling complex documents: create mathematical equations and tables etc and easily manage footnotes, citations and references</li><li>Streamline publishing workflow: allow to submit manuscript within Overleaf project</li><li>Wide range of packages and templates: specifically made for different document types and citation styles</li></ul><figure><img src="https://github.com/overleaf/overleaf/raw/main/doc/screenshot.png" alt="A screenshot of a project being edited in Overleaf Community Edition" /><figcaption>A screenshot of a project being edited in Overleaf Community Edition</figcaption></figure><p>Overleaf is a collaborative cloud-based LaTeX editor used for writing, editing and publishing scientific documents.</p><h2 id="an-open-source-online-real-time-collaborative-latex-editor.">An open-source online real-time collaborative LaTeX editor.</h2><ul><li><a href="https://github.com/overleaf/overleaf" class="uri">https://github.com/overleaf/overleaf</a></li></ul><h3 id="community-edition">Community Edition</h3><p>Overleaf is an open-source online real-time collaborative LaTeX editor. We run a hosted version at &lt;www.overleaf.com&gt;, but <strong>you can also run your own local version, and contribute to the development of Overleaf</strong>.</p><ul><li>Installation<ul><li>We have detailed installation instructions in the <a href="https://github.com/overleaf/toolkit/">Overleaf Toolkit</a>.</li><li><a href="https://github.com/overleaf/toolkit/blob/master/doc/quick-start-guide.md" class="uri">https://github.com/overleaf/toolkit/blob/master/doc/quick-start-guide.md</a></li></ul></li><li>Upgrading<ul><li>If you are upgrading from a previous version of Overleaf, please see the <a href="https://github.com/overleaf/overleaf/wiki#release-notes">Release Notes section on the Wiki</a> for all of the versions between your current version and the version you are upgrading to.</li></ul></li></ul><h2 id="bibliography-styles">Bibliography Styles</h2><p>Bibliography Styles (<a href="https://libguides.lb.polyu.edu.hk/c.php?g=965525&amp;p=7014655">ref1</a>)</p><p>There are three bibliography styles in Overleaf:</p><ul><li>BibTeX - Ease of Use and Compatibility</li><li>Natbib - Author-year and numerical citations, simple documents that require traditional citation styles</li><li>BibLaTeX - Complex documents, multilingual documents, more customization in citations</li></ul><h1 id="latex-template">LaTeX template</h1><ul><li>American Physical Society (APS)<ul><li><a href="https://journals.aps.org/revtex">REVTeX Home Page</a></li><li>REVTeX 4.2 is a set of macro packages designed to be used with LaTeX2e and is well-suited for preparing manuscripts for submission to the journals of the American Physical Society (APS) and American Institute of Physics (AIP).</li><li>The REVTeX 4.2 may be downloaded directly from here as <a href="https://cdn.journals.aps.org/test/345f0cd4-cab7-4271-9a46-7331fb57618a/revtex-tds-2023-05-30.zip">revtex-tds-2023-05-30.zip</a></li></ul></li><li>American Geophysical Union (AGU)<ul><li><a href="https://www.agu.org/publications/authors/journals" class="uri">https://www.agu.org/publications/authors/journals</a></li><li><a href="https://www.agu.org/publications/authors/-/media/4090218dcdb64a5597361820016462ed.ashx">Template for manuscript (LaTeX)</a></li></ul></li></ul>]]></content>
    
    
    <categories>
      
      <category>LaTex</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>NWP | MPAS | Cold Start/Spin up/Warm Start</title>
    <link href="/2024/10/16/wrf-spin-up-cold-start/"/>
    <url>/2024/10/16/wrf-spin-up-cold-start/</url>
    
    <content type="html"><![CDATA[<h1 id="cold-startwarm-start">Cold Start/Warm Start</h1><h2 id="ncar">NCAR</h2><ul><li><a href="https://ral.ucar.edu/solutions/products/real-time-four-dimensional-data-assimilation-rt-fdda">NCAR | Real-Time Four-Dimensional Data Assimilation (RT-FDDA)</a></li></ul><div class="note note-warning">            <p>Simulation is initialized using a <strong>'cold start'</strong> methodology. This means that they <strong>start with no cloud and precipitation systems, or local thermally-driven circulations</strong>.</p>          </div><p>Therefore, a certain amount of model <strong>'spin up' time</strong> is required for the atmosphere to begin responding to the mesoscale forcing resulting from variations in the local complex physiography.</p><h2 id="wrf-code">WRF code</h2><p>For use with <strong>cold start (zero cloud fields)</strong>,</p><p>WRF/run/README.namelist</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs text">&amp;physics<br> insert_init_cloud                   = .false., ! Default<br>                                     = .true.,  ! For use with cold start (zero cloud fields), this option will<br>                                                  use the icloud=3 scheme to produce initial cloud water and cloud<br>                                                  ice fields as well as ensure initial water vapor field matches<br>                                                  saturation, which retains clouds beyond the first few timesteps.<br></code></pre></td></tr></table></figure><h2 id="developing-spin-up-time-framework-...">2023 | Developing spin-up time framework ...</h2><ol type="1"><li>Liu, Y., Zhuo, L., &amp; Han, D. (2023). <strong>Developing spin-up time framework for WRF extreme precipitation simulations</strong>. Journal of Hydrology, 620, 129443.<ol type="1"><li>In fact, the length of spin-up <strong>depends on the quality of initial inputs and the soil conditions</strong> because the soil moisture content and latent heat flux will influence precipitation processes</li><li>For example, <strong>soil moisture responds much slower</strong> than atmospheric variables to dynamical and thermo-dynamical processes</li><li>In WRF extreme precipitation simulations, spin-up time allows the model to adjust from the IC to a state that is consistent with its own numerics and physics and to develop appropriate large-scale circulations</li><li>Therefore, spin-up time is the required execution time that allows the WRF to reach a physical equilibrium state following the path defined by the BC, while forgetting about the IC</li><li>The greater the inconsistencies between IC and model physics, the longer the spin-up time required</li></ol></li></ol><h2 id="forecast-of-low-clouds-...">2021 | Forecast of Low Clouds ...</h2><ul><li>Hagman, M., Svensson, G., &amp; Angevine, W. M. (2021). Forecast of Low Clouds over a Snow Surface in the Arctic Using the WRF Model. Monthly Weather Review, 149(8), 2559-2579. https://doi.org/10.1175/MWR-D-20-0396.1</li></ul><p>The model is <strong>cold-started</strong> for every simulation...Our experiments show that the problems arise in the initialization of the model. When the SAF WRF forecast begins,</p><ul><li>it is initialized with specific humidity, winds, temperature and skin temperature from IFS HRES, <strong>but no cloud information is passed from the host model</strong>.</li><li>When low clouds are present in reality, they increase the downwelling longwave radiation to the surface. This energy source at the surface is especially important in a stably stratified environment with sharp surface inversions as it affects the energy budget at the surface, which, in turn, sets the skin temperature and temperature in the lowest layer of the atmosphere.</li><li><strong>When no cloud information is available at the initial time in WRF</strong>, this energy is lacking during the first hours when <strong>WRF has to spin up its own clouds from the initialized humidity, a slow process in winter at high latitudes</strong>. With less downwelling longwave radiation, the deficit of energy at the surface leads to a <strong>rapid, unphysical drop in the skin temperature</strong>. Drops of 20°C in 20 s (one time step) have been noted.</li></ul><h2 id="sensitivity-of-initialcondition-and-cloud-microphysics-...">2018 | Sensitivity of initial‐condition and cloud microphysics ...</h2><ul><li>Sikder, M. S., &amp; Hossain, F. (2018). Sensitivity of initial‐condition and cloud microphysics to the forecasting of monsoon rainfall in South Asia. Meteorological Applications, 25(4), 493-509.</li></ul><p>Besides the sensitivity test of the MP schemes in the WRF forecast, the performance of <strong>four different WRF model initialization techniques</strong> was tested in this study.</p><ul><li>In the first experiment case, the <strong>traditional “cold-start” technique</strong> was used to initiate the WRF model using the GFS forecast (e.g. Givati et al., 2012). The IC of the WRF model was directly taken from the GFS forecast in this case.</li><li>The second case was also a <strong>cold-start set-up, but the first-hour GFS forecast data were replaced by the GFS-FNL data</strong> which are expected to represent a more accurate IC given the higher number of assimilated observations. Thus, the IC of the model is derived from the GFS-FNL and simulation was continued using the GFS forecast data as the model boundary.</li></ul><div class="note note-warning">            <p><strong>Exclusion of the first 6 hr</strong> simulation output of a cold-start model is a common practice used to eliminate the model “spin-up” time error.</p>          </div><p>Although the first two cases involved cold-start initialization, the spin-up effect was not considered in this study to evaluate the advantages of other initialization techniques.</p><p>The next two cases were based on a <strong>“warm start”</strong> (<strong>often called a “hot start”</strong>) approach (e.g. Jankov et al., 2007).</p><ul><li>The output of a <strong>one-day pre-simulated WRF model</strong> was used to initiate the WRF forecast model in these cases. In this way, the uncertainty related to model instability during the so-called spin-up time is expected to be reduced. The GFS-FNL data were used as the initial and boundary condition for this one-day pre-simulation (i.e. hindcast), since they contain more observed data than the operational GFS. <strong>Thereafter, the WRF forecast model was initiated with the restart generated from this hindcast model, and continued with the GFS forecast data as the boundary condition</strong> in the third experiment case.</li><li>The last experimental case was almost similar to the third experimental case. The only difference was <strong>the first-hour GFS forecast data were replaced by the GFS-FNL data in the WRF forecast simulation</strong>. Therefore, the last case is the fusion of the second and third experimental cases.</li></ul><p>These four experiment cases are denoted here by IC and a serial number denoting the experimental case. Hereafter, the IC1 means the first experiment case to initiate the WRF model; and IC2, IC3 and IC4 the second, third and fourth experimental cases, respectively.</p><h2 id="wrfda-point-of-view">WRFDA point of view</h2><h3 id="cycling-wrf-and-wrfda">Cycling WRF and WRFDA</h3><ul><li>Q1: What is "cycling" exactly? How do I set up cycling for WRF and WRFDA?<ul><li>A1: "Cycling" is the process by which the output of a previous WRF forecast is used to initialize a new WRF forecast, rather than taking the initial conditions from some other analysis/forecast through WPS/real. This is usually done in the context of real-time forecast You can find detailed instructions on cycling with WRF/WRFDA in the <a href="http://www2.mmm.ucar.edu/wrf/users/wrfda/Docs/user_guide_V3.9/users_guide_chap6.htm#_Cycling_with_WRF_1%3C/a">relevant section of the Users Guide</a></li></ul></li><li>Q2: What is the difference between <strong>"warm-start"</strong> and <strong>"cold-start"</strong> forecasts?<ul><li>A2: These terms are widely used in the field of atmospheric modeling and data assimilation, however, to quote this site from <a href="http://www.oc.nps.edu/nom/modeling/initial.html">the Naval Postgraduate School</a>, "The terms cold start and warm start may mean slightly different things to different people." In the context of WRF and WRFDA, a <strong>"cold-start" forecast is when the first guess (fg) file</strong> provided to WRFDA is a wrfinput file from WPS/real, while a <strong>"warm-start" forecast is one where the first guess is a WRF forecast file (wrfout)</strong>.</li></ul></li></ul><p>Because of the ambiguity in what constitutes a cold-start or warm-start, we try to avoid using these terms in the official documentation.</p><h2 id="wrf-mpas-a-support-forum">WRF &amp; MPAS-A Support Forum</h2><ul><li><a href="https://forum.mmm.ucar.edu/threads/when-should-i-consider-spin-up-for-wrf-predictions.13821/">When should I consider spin-up for WRF predictions?</a><ul><li><strong>Usually 9-12 hours of spin-up time will be sufficient</strong>. Note that WRF is under strong constraints of lateral forcing and changes in surface static data could be more important for long-term climate simulation.</li></ul></li><li><a href="https://forum.mmm.ucar.edu/threads/long-term-wrf-run.5241/">long-term WRF run</a><ul><li>I don't believe the length of the run should make a difference. <strong>The spin-up time is simply to ensure that the model has had ample time to stabilize so that the results can become reliable</strong>, and are not just simply based on the initial and boundary conditions. Once this happens, the model can go forward to generate estimations for forecasting purposes.</li></ul></li><li><a href="https://forum.mmm.ucar.edu/threads/long-time-wrf-simulation.10067/">Long-time WRF simulation</a><ul><li>Q: I want to do a 1-year WRF simulation with analysis nudging using ERA5 hourly reanalysis data. Take 2019 for example, should I run WRF from Dec,2018 to Dec,2019, taking Dec in 2018 as spin-up period? If so, does nudging set in Dec,2018?</li><li>A: <strong>You shouldn't need more than about 24-48 hours for spin-up</strong>, so if you're interested in the data from 1 Jan 2019, you can just start it Dec 30 or 31 and it should be okay.</li><li><strong>Nudging is beneficial throughout the whole simulation</strong>, especially for larger/continental sized domains. It's less necessary for smaller domains that are more constrained by the boundaries.</li><li><strong>As for long simulations, the only other thing that comes to mind is to make sure you have some additional SST input data</strong>. The GFS provides SST data with their files, but the resolution is temporally coarse. You will want something with higher temporal resolution. You may already have some, or a resource for it, but if you need additional resources, you can see slide 6 from this <a href="https://www2.mmm.ucar.edu/wrf/users/tutorial/202101/werner_data_util_pp.pdf">presentation</a>.</li></ul></li><li><a href="https://forum.mmm.ucar.edu/threads/altering-mpass-initial-conditions.13680/">Altering MPAS's initial conditions</a><ul><li>Q: I am now considering changing initial conditions for the global MPAS run (60-3km mesh). Do you have any idea about the approximate spin-up time for changing different initial variables? For non-change run, I will spin up for about 6 hours and timestep is about 15 seconds. If I change the vegation type (say vegetation fraction), do I need to increase my spin-up time, e.g., a few hours more or even several days?</li><li>A: Based on our experience with WRF model, 9-12 hours of spin-up time is sufficient. Note that WRF is a limited-area model under constraints of large scale forcing. The spin-up time for MPAS global model could be different. A few papers have mentioned the spin-up issue for MPAS. For example, the spin-up time is set to 24h in the <a href="https://macmaq.aqrc.ucdavis.edu/sites/g/files/dgvnsk6036/files/inline-files/Kemal%20Gurer_Poster.pdf">study</a>. Please refer to the literature for more information.</li></ul></li></ul><h1 id="spin-up-time">Spin-Up Time</h1><p>In numerical weather prediction (NWP), <strong>spin-up time</strong> refers to the period required for a model to <strong>adjust from its initial state to a more stable and representative equilibrium state</strong>. This adjustment is crucial for achieving accurate forecasts, as it allows the model to correct any discrepancies in the initial conditions and dynamics.</p><h2 id="key-characteristics-of-spin-up-time">Key Characteristics of Spin-Up Time</h2><h3 id="dynamic-and-thermal-adjustments">Dynamic and Thermal Adjustments</h3><ul><li><p><strong>Initial Phase</strong>: During the spin-up phase, the model undergoes significant dynamic and thermal adjustments. These adjustments are necessary for the model to align with the physical processes governing atmospheric behavior.</p></li><li><p><strong>Duration</strong>: Spin-up time can vary widely depending on the type of model and its configuration. For short-term weather forecast models, spin-up times typically range from several hours to about a dozen hours. In contrast, climate models may require spin-up periods extending from months to even decades.</p></li></ul><h3 id="impact-on-forecast-accuracy">Impact on Forecast Accuracy</h3><ul><li><strong>Forecast Reliability</strong>: The forecasts produced during the spin-up phase are often considered unreliable. Many studies recommend disregarding results from this period when evaluating model performance[1]. This is due to potential inaccuracies caused by transient phenomena, such as spurious gravity waves, which can lead to increased errors in forecast variables.</li><li><strong>Computational Resources</strong>: Extended spin-up times can consume significant computational resources, particularly in climate models or ocean models. Reducing spin-up time is therefore essential for improving efficiency and forecast accuracy.</li></ul><h3 id="factors-influencing-spin-up-time">Factors Influencing Spin-Up Time</h3><ul><li><strong>Model Type</strong>: Different models exhibit varying spin-up characteristics based on their design and purpose. For instance, global climate models generally have longer spin-up times compared to regional models.</li><li><strong>Initial Conditions</strong>: The quality of initial conditions derived from observational data or reanalysis influences how quickly a model can reach equilibrium. Models initialized with better data tend to have shorter spin-up periods.</li></ul><p>In summary, spin-up time in NWP is a critical aspect that affects the accuracy and reliability of weather forecasts. Understanding and optimizing this period is essential for enhancing model performance and resource efficiency.</p><h2 id="spin-up-characteristics-...">2021 Spin-up characteristics ...</h2><ul><li>Ma, Z., Zhao, C., Gong, J., Zhang, J., Li, Z., Sun, J., Liu, Y., Chen, J., and Jiang, Q.: Spin-up characteristics with three types of initial fields and the restart effects on forecast accuracy in the GRAPES global forecast system, Geosci. Model Dev., 14, 205–221, <a href="https://doi.org/10.5194/gmd-14-205-2021" class="uri">https://doi.org/10.5194/gmd-14-205-2021</a>, 2021.</li><li><a href="https://gmd.copernicus.org/articles/14/205/2021/gmd-14-205-2021.pdf" class="uri">https://gmd.copernicus.org/articles/14/205/2021/gmd-14-205-2021.pdf</a></li></ul><p>This process is called the spin-up in numerical modeling, and</p><ul><li>the time required to reach a new equilibrium state is called the spin-up time (Wolcott and Warner, 1981; Kasahara et al., 1992; Séférian et al., 2016; Sheng et al., 2006; Liu et al., 2008; Xue et al., 2017).</li><li>During the dynamic and thermal adjustment in the spin-up, spurious gravity waves can be triggered, causing a rapid increase in the root-mean-square error of the forecast variables in the model and an underestimation of the forecast precipitation (Wehbe et al., 2019; Qian et al., 2003). It leads to unreliable forecast results during the spin-up.</li><li>Therefore, many studies generally do not consider the forecast results during the spin-up when evaluating the model forecasts (Lo et al., 2008; Kleczke et al., 2014; Xie et al., 2013; Zhao et al., 2012).</li><li>If the spin-up time is too long in the operational model, it would inevitably affect the forecast accuracy of the model.</li><li>In addition, the overlong spin-up in the climate model or the ocean model can consume excessive computing resources (Duben et al., 2014).</li><li>Therefore, studying the spin-up characteristics and reducing the spin-up time are of great significance for improving the model forecast and saving computing resources.</li></ul><h2 id="關於數值模式spin-up的一些說明">關於數值模式spin up的一些說明</h2><ul><li>From <a href="https://mp.weixin.qq.com/s/4osE0V9fxZO695N8AifxmA" class="uri">https://mp.weixin.qq.com/s/4osE0V9fxZO695N8AifxmA</a></li></ul><p>由於難以得到理想的準確的初始場，模式初始場各變數之間，或與外部條件之間存在不平衡或不匹配。因此模式啟動後，需要運行一段時間，以達到所需的「平衡狀態」。而達到這個狀態所需的時間，稱為spin up time（起轉時間）。在完成spin up之前，模式的輸出結果往往是不可信的。</p><p>對於不同的研究對像或不同模式，其spin up所關注的重點與所需的時間是不一樣的。</p><p>對於中小尺度氣像模式，例如WRF，初始場各變數特別是濕度場，往往過於平滑，使得模式的初始時刻的輻散場、非絕熱加熱與濕度場之間缺乏一致性，動力、熱力過程與水分循環不協調。<strong>且中小尺度模式一般是由無雲初始場開始的，所以開始需要一定的時間產生相應的雲水信息，冷啟動之後往往需要若干小時才能產生符合實際的雲水信息</strong>。</p><p>一般認為，WRF模式在6小時即可完成spin up（也許更短，6小時是一個比較保守的估計）。由於spin up的存在，限制了數值模式在短臨預報的應用。因此有不少資料同化的工作，追求盡可能同化雲水相關的觀測訊息，縮短模式spin up時間。</p><p>而在氣候模擬中，spin up的時間更長。例如在CMIP6的高解析度模式比較計劃 （HighResMIP）中，其第二層級 （Tier-2）試驗為1950—2050 年的百年耦合試驗。為了在試驗前盡可能達到海-氣準平衡態，HighResMIP工作小組建議先進行約 50年的spin up，之後再以「熱啟動」(restart) 的方式完成該段試驗。大氣的回饋過程較快，而海洋的狀態調整和回饋相對較慢。在海洋模式中，spin-up需要的時間更久。海洋模型需要多長時間才能達到平衡？ 與所關注的研究對象和使用的模型密切相關。</p><p>在海盆尺度和全球尺度的海洋環流模式中，模式要達到平衡狀態較難，可能需要數百年的時間。海洋模型以目前的海洋狀態（氣候態）初始化，並向前積分，直到環流結構和密度場等平衡匹配。深海海洋需要數百年的適應，上層海洋只需要大約50年左右。例如要研究上層海洋過程（如厄爾尼諾），則一般只需上層海洋（在主溫躍層之上）達到平衡狀態。</p><p>實際上，spin up時間尺度是第一和第二模態的長羅斯貝波（大規模行星波）從東到西穿過盆地、影響水流並最終影響水團特性所需的時間。沿著赤道，第一模態斜壓羅斯貝波橫渡太平洋約需9個月；然而，第二模態的長羅斯貝波斜壓性更強，傳播得更慢。因此，在赤道中需要spin up幾年時間才能達到平衡。</p><p>在中緯度地區，長波傳播得更慢。羅斯貝波橫渡太平洋大約需要 11 年。對於全球海洋模型，需要幾十年才能在海洋上層達到平衡。如果只考慮正壓模式，或者模型是二維的，那麼spin up調整時間會更快，大約幾天，因為正壓波傳播得更快。</p><p>如果想縮短spin up時間，還可以透過資料同化（nudge）的方式，使得模式狀態不斷逼近觀測。例如在正壓模型中，可以使用海表面高度資料（SSH）。</p><p>此外，如果只關心風力驅動的水循環，例如由 Ekman 抽吸引起的海面斜坡產生的流動，那麼幾天的spin up時間可能就足夠了。</p><h1 id="atmospheric-kinetic-energy-spectra----spinup-time">** Atmospheric Kinetic Energy Spectra --&gt; spinup time</h1><ul><li><strong>The KE spectrum has a canonical structure characterized by different slopes at various wavenumbers</strong>. <strong>Initially, higher-wavenumber components have low energy, which gradually increases as the model spins up</strong>. This adjustment is essential for accurately representing atmospheric dynamics, particularly for phenomena like monsoon rainfall</li><li>The KE spectra in numerical simulations typically require a spin-up period of 12 to 18 hours to stabilize, as indicated by previous studies. This time is crucial for the model to adjust its initial conditions and reach a more representative state.</li><li><strong>During the spin-up phase, spurious gravity waves may be generated</strong>, leading to increased errors in forecast variables and underestimations of precipitation. The KE spectra help identify these discrepancies by showing how energy cascades through different scales, which can affect forecast reliability.</li><li><strong>Atmospheric kinetic energy spectra provide valuable insights into the spin-up issue by illustrating how energy transitions through various scales during initialization</strong>. This understanding is vital for improving forecast accuracy and optimizing model configurations in NWP systems.</li></ul><p>The paper is,</p><ul><li>Skamarock, W. C., Park, S., Klemp, J. B., &amp; Snyder, C. (2014). Atmospheric Kinetic Energy Spectra from Global High-Resolution Nonhydrostatic Simulations. Journal of the Atmospheric Sciences, 71(11), 4369-4381. https://doi.org/10.1175/JAS-D-14-0114.1</li></ul><figure><img src="https://journals.ametsoc.org/view/journals/atsc/71/11/full-jas-d-14-0114.1-f8.jpg" alt="Fig. 8. Tropospheric and stratospheric kinetic energy spectra for the 3-km MPAS simulations at simulation times 0, 6, 12, and 18 h. The day 5–15 averages are plotted for reference." /><figcaption>Fig. 8. Tropospheric and stratospheric kinetic energy spectra for the 3-km MPAS simulations at simulation times 0, 6, 12, and 18 h. The day 5–15 averages are plotted for reference.</figcaption></figure><ul><li>Atmospheric prediction systems are designed and configured in part based on an understanding of these dynamics that, for example, have implications for forecast error growth and spinup time scales and filtering and subfilter-scale physics</li><li>The KE spectra reveal that the MPAS configuration produces an effective model resolution (filter scale) of approximately 6Δx</li><li>The spinup time is found to be somewhat less than a day, consistent with MPAS results presented in Fig. 8</li><li>The spinup time should be comparable to an eddy turnover time.</li></ul><h1 id="references">References</h1><ol type="1"><li>Wolcott, S. W., &amp; Warner, T. T. (1981). A moisture analysis procedure utilizing surface and satellite data. Monthly Weather Review, 109(9), 1989-1998.</li><li>Kasahara, A., Mizzi, A. P., &amp; Donner, L. J. (1992). Impact of cumulus initialization on the <strong>spinup</strong> of precipitation forecasts in the tropics. Monthly weather review, 120(7), 1360-1380.</li><li>Séférian, R., Gehlen, M., Bopp, L., Resplandy, L., Orr, J. C., Marti, O., ... &amp; Romanou, A. (2016). Inconsistent strategies to <strong>spin up</strong> models in CMIP5: Implications for ocean biogeochemical model performance assessment. Geoscientific Model Development, 9(5), 1827-1851.</li><li>Sheng, C., Pu, Y., and Gao, S.: Effect of Chinese Doppler radar data on nowcasting output of mesoscale model, Chin. J. Atmos. Sci., 30, 93–107, 2006 (in Chinese).</li><li>Liu, S., Jiang, H., Hu, F., Zhang, C., Liu, H., Liang, F., Xin, G., and Wang, J.: Research of <strong>spin-up processes</strong> of land surface model of RAMs for different initial soil parameters, Acta Meteorol. Sin., 66, 351–358, 2008 (in Chinese).</li><li>Xue, C., Chen, X., Wu, Y., Xu, X., and Gao, Y.: Application of radar assimilation in local severe convective weather forecast, Chin. J. Atmos. Sci., 41, 673–690, 2017 (in Chinese).</li><li>Wehbe, Y., Temimi, M., Weston, M., Chaouch, N., Branch, O., Schwitalla, T., ... &amp; Al Mandous, A. (2019). Analysis of an extreme weather event in a hyper-arid region using WRF-Hydro coupling, station, and satellite data. Natural Hazards and Earth System Sciences, 19(6), 1129-1149.</li><li>Qian, J. H., Seth, A., &amp; Zebiak, S. (2003). Reinitialized versus continuous simulations for regional climate downscaling. Monthly Weather Review, 131(11), 2857-2874.</li><li>Lo, J. C. F., Yang, Z. L., &amp; Pielke Sr, R. A. (2008). Assessment of three dynamical climate downscaling methods using the Weather Research and Forecasting (WRF) model. Journal of Geophysical Research: Atmospheres, 113(D9).</li><li>Weiss, S. J., Pyle, M. E., Janjic, Z., Bright, D. R., Kain, J. S., &amp; DiMego, G. J. (2008, October). The operational high resolution window WRF model runs at NCEP: Advantages of multiple model runs for severe convective weather forecasting. In Preprints, 24th Conf. on Severe Local Storms, Savannah, GA, Amer. Meteor. Soc. P (Vol. 10).</li><li>Branch, O., Schwitalla, T., Temimi, M., Fonseca, R., Nelli, N., Weston, M., ... &amp; Wulfmeyer, V. (2020). Seasonal and diurnal performance of daily forecasts with WRF-NOAHMP V3. 8.1 over the United Arab Emirates. Geoscientific Model Development Discussions, 2020, 1-40.<ol type="1"><li>The first 6 h of each forecast (18:00 to 00:00 UTC) were then discarded from the analysis. <strong>The 6 h allows time for the atmosphere to spin up after each cold start – in particular for the residual boundary layer to develop and dissipate before the convective boundary layer starts to develop after sunrise (∼ 06:00 LT), and for potential cloud development</strong>.</li></ol></li></ol>]]></content>
    
    
    <categories>
      
      <category>NWP</category>
      
    </categories>
    
    
    <tags>
      
      <tag>NWP</tag>
      
      <tag>WRF</tag>
      
      <tag>MPAS</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Linux | Terminal Command</title>
    <link href="/2024/10/15/Linux-terminal/"/>
    <url>/2024/10/15/Linux-terminal/</url>
    
    <content type="html"><![CDATA[<p>Linux</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs sh"><br><span class="hljs-comment"># -m displays percentages</span><br><span class="hljs-comment"># -N displays line numbers</span><br><span class="hljs-comment"># -i ignores case when searching</span><br><span class="hljs-comment"># h Display the help interface</span><br><span class="hljs-comment"># Q quits less command</span><br>less -miN file <span class="hljs-comment"># alias less=&#x27;less -miN&#x27;</span><br><br>sh run.sh | <span class="hljs-built_in">tee</span> output.txt<br><span class="hljs-comment"># If you want to print the error output to the screen and the file at the same time</span><br>sh run.sh 2&gt;&amp;1 | <span class="hljs-built_in">tee</span> lsls.log<br><br><span class="hljs-built_in">nohup</span> sh run.sh &gt;/dev/null 2&gt;&amp;1 &amp;<br>sh run.sh &gt;/dev/null 2&gt;&amp;1 &amp;<br><br><span class="hljs-comment"># -C : Print Around Lines</span><br>grep -irn -C 3 <span class="hljs-string">&quot;xxx&quot;</span> file<br>grep -irn -C 3 <span class="hljs-string">&quot;xxx&quot;</span> ./*<br>grep -irn <span class="hljs-string">&#x27;pattern1\|pattern2&#x27;</span> fileName_or_filePath<br><br>find ./ -name <span class="hljs-string">&quot;xxx&quot;</span><br>find - L ./ -name <span class="hljs-string">&quot;xxx&quot;</span> <span class="hljs-comment"># -L :Follow symbolic links</span><br>find ./ -<span class="hljs-built_in">type</span> f | <span class="hljs-built_in">wc</span> -l <span class="hljs-comment"># count how many files</span><br>find ./ -size +1M       <span class="hljs-comment"># large 1MB size</span><br><br>ldd xxx<br><br>rename IMG img IMG* <span class="hljs-comment"># IMG001.jpg to img001.jpg</span><br></code></pre></td></tr></table></figure><table><thead><tr class="header"><th>执行命令</th><th>状态</th><th></th></tr></thead><tbody><tr class="odd"><td>./mylog.sh</td><td>结果会输出到终端 使用Ctrl + C发送SIGINT信号或关闭session发送SIGHUP信号，程序关闭</td><td></td></tr><tr class="even"><td>./mylog.sh &amp;</td><td>结果会输出到终端 使用Ctrl + C发送SIGINT信号，程序免疫 关闭session发送SIGHUP信号，程序关闭</td><td></td></tr><tr class="odd"><td>nohup ./mylog.sh</td><td>结果默认会输出到nohup.out 使用Ctrl + C发送SIGINT信号，程序关闭 关闭session发送SIGHUP信号，程序免疫</td><td></td></tr><tr class="even"><td>nohup ./mylog.sh &amp;</td><td>同时免疫SIGINT和SIGHUP信号</td><td></td></tr></tbody></table><ul><li>Form <a href="https://www.cnblogs.com/mianbaoshu/p/12073028.html">nohup &amp;的用法、进程查看以及终止</a></li></ul><h1 id="find-delete">Find &amp; Delete</h1><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># Find files smaller than 100M: -print or -delete</span><br>find . -<span class="hljs-built_in">type</span> f -name <span class="hljs-string">&quot;*.nc&quot;</span> -size -100M -<span class="hljs-built_in">print</span><br>find . -<span class="hljs-built_in">type</span> f -name <span class="hljs-string">&quot;*.nc&quot;</span> -size -100M -delete<br><br><span class="hljs-comment"># Find files larger than 100M: -print or -delete</span><br>find . -<span class="hljs-built_in">type</span> f -name <span class="hljs-string">&quot;*.nc&quot;</span> -size +100M -<span class="hljs-built_in">print</span><br>find . -<span class="hljs-built_in">type</span> f -name <span class="hljs-string">&quot;*.nc&quot;</span> -size +100M -delete<br><br><span class="hljs-comment"># if your &quot;find&quot; does not support delete:</span><br>find . -<span class="hljs-built_in">type</span> f ! -name <span class="hljs-string">&#x27;*.mp3&#x27;</span> ! -name <span class="hljs-string">&#x27;*.mp4&#x27;</span> -size +1M -<span class="hljs-built_in">exec</span> <span class="hljs-built_in">rm</span> &#123;&#125; \;<br></code></pre></td></tr></table></figure><h1 id="for-client-node">For client node,</h1><ul><li>create a file <code>.info</code> on home directory</li><li>copy all below into <code>.info</code></li><li>drectly <code>source .info</code> or write <code>source .info</code> into <code>.bashrc</code></li></ul><h2 id="how-can-i-display-the-absolute-path-in-bash-prompt">How can I display the absolute path in bash prompt?</h2><ul><li><a href="https://superuser.com/questions/202212/how-can-i-display-the-absolute-path-in-bash-prompt" class="uri">https://superuser.com/questions/202212/how-can-i-display-the-absolute-path-in-bash-prompt</a></li></ul><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs routeros"><span class="hljs-built_in">export</span> <span class="hljs-attribute">PS1</span>=<span class="hljs-string">&quot;\[\`if [[ \$? = &quot;</span>0&quot; ]]; then echo <span class="hljs-string">&#x27;\e[32m\h\e[0m&#x27;</span>; <span class="hljs-keyword">else</span> echo <span class="hljs-string">&#x27;\e[31m\h\e[0m&#x27;</span> ; fi\`:\`pwd\`\n\$ <span class="hljs-string">&quot;</span><br></code></pre></td></tr></table></figure><p>better is,</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># set a fancy prompt (non-color, unless we know we &quot;want&quot; color)</span><br><span class="hljs-keyword">case</span> <span class="hljs-string">&quot;<span class="hljs-variable">$TERM</span>&quot;</span> <span class="hljs-keyword">in</span><br>    xterm-color|*-256color) color_prompt=<span class="hljs-built_in">yes</span>;;<br><span class="hljs-keyword">esac</span><br><br><span class="hljs-comment"># uncomment for a colored prompt, if the terminal has the capability; turned</span><br><span class="hljs-comment"># off by default to not distract the user: the focus in a terminal window</span><br><span class="hljs-comment"># should be on the output of commands, not on the prompt</span><br><span class="hljs-comment">#force_color_prompt=yes</span><br><br><span class="hljs-keyword">if</span> [ -n <span class="hljs-string">&quot;<span class="hljs-variable">$force_color_prompt</span>&quot;</span> ]; <span class="hljs-keyword">then</span><br>    <span class="hljs-keyword">if</span> [ -x /usr/bin/tput ] &amp;&amp; tput setaf 1 &gt;&amp;/dev/null; <span class="hljs-keyword">then</span><br><span class="hljs-comment"># We have color support; assume it&#x27;s compliant with Ecma-48</span><br><span class="hljs-comment"># (ISO/IEC-6429). (Lack of such support is extremely rare, and such</span><br><span class="hljs-comment"># a case would tend to support setf rather than setaf.)</span><br>color_prompt=<span class="hljs-built_in">yes</span><br>    <span class="hljs-keyword">else</span><br>color_prompt=<br>    <span class="hljs-keyword">fi</span><br><span class="hljs-keyword">fi</span><br><br><span class="hljs-keyword">if</span> [ <span class="hljs-string">&quot;<span class="hljs-variable">$color_prompt</span>&quot;</span> = <span class="hljs-built_in">yes</span> ]; <span class="hljs-keyword">then</span><br>    PS1=<span class="hljs-string">&#x27;$&#123;debian_chroot:+($debian_chroot)&#125;\[\033[01;32m\]\u@\h\[\033[00m\]:\[\033[01;36m\]$PWD\[\033[00m\]\n\$ &#x27;</span><br><span class="hljs-keyword">else</span><br>    PS1=<span class="hljs-string">&#x27;$&#123;debian_chroot:+($debian_chroot)&#125;\u@\h:\w\$ &#x27;</span><br><span class="hljs-keyword">fi</span><br><span class="hljs-built_in">unset</span> color_prompt force_color_prompt<br><br><span class="hljs-comment"># If this is an xterm set the title to user@host:dir</span><br><span class="hljs-keyword">case</span> <span class="hljs-string">&quot;<span class="hljs-variable">$TERM</span>&quot;</span> <span class="hljs-keyword">in</span><br>xterm*|rxvt*)<br>    PS1=<span class="hljs-string">&quot;\[\e]0;<span class="hljs-variable">$&#123;debian_chroot:+($debian_chroot)&#125;</span>\u@\h: \w\a\]<span class="hljs-variable">$PS1</span>&quot;</span><br>    ;;<br>*)<br>    ;;<br><span class="hljs-keyword">esac</span><br></code></pre></td></tr></table></figure><h2 id="is-there-a-directory-history-for-bash">** Is there a directory history for bash?</h2><ul><li><a href="https://superuser.com/questions/299694/is-there-a-directory-history-for-bash" class="uri">https://superuser.com/questions/299694/is-there-a-directory-history-for-bash</a></li></ul><p>You can build your own <code>cd</code> command with <code>pushd</code>, <code>popd</code>, <code>dirs</code> , <code>dirs -v</code> builtin commands.</p><p>Usage</p><ul><li><p><code>cd --</code> ( list current history )</p></li><li><p><code>cd -num</code> ( go to num directory )</p></li><li><p><code>cd -</code> ( go to previous directory )</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-keyword">function</span> <span class="hljs-function"><span class="hljs-title">cd</span></span> () <br>&#123; <br>    <span class="hljs-built_in">local</span> hnum=16;<br>    <span class="hljs-built_in">local</span> new_dir index <span class="hljs-built_in">dir</span> cnt;<br>    <span class="hljs-keyword">if</span> ! [ <span class="hljs-variable">$#</span> -eq 0 ]; <span class="hljs-keyword">then</span><br>        <span class="hljs-keyword">if</span> [[ <span class="hljs-variable">$#</span> -eq 2 &amp;&amp; <span class="hljs-variable">$1</span> = <span class="hljs-string">&quot;--&quot;</span> ]]; <span class="hljs-keyword">then</span><br>            <span class="hljs-built_in">shift</span>;<br>        <span class="hljs-keyword">else</span><br>            <span class="hljs-keyword">if</span> ! &#123; <br>                [ <span class="hljs-variable">$#</span> -eq 1 ] &amp;&amp; [[ <span class="hljs-variable">$1</span> =~ ^(-[0-9]&#123;,2&#125;|-|--|[^-].*)$ ]]<br>            &#125;; <span class="hljs-keyword">then</span><br>                <span class="hljs-built_in">builtin</span> <span class="hljs-built_in">cd</span> <span class="hljs-string">&quot;<span class="hljs-variable">$@</span>&quot;</span>;<br>                <span class="hljs-built_in">return</span>;<br>            <span class="hljs-keyword">fi</span>;<br>        <span class="hljs-keyword">fi</span>;<br>    <span class="hljs-keyword">fi</span>;<br>    [ <span class="hljs-string">&quot;<span class="hljs-variable">$1</span>&quot;</span> = <span class="hljs-string">&quot;--&quot;</span> ] &amp;&amp; &#123; <br>        <span class="hljs-built_in">dirs</span> -v;<br>        <span class="hljs-built_in">return</span><br>    &#125;;<br>    new_dir=<span class="hljs-variable">$&#123;1:-<span class="hljs-variable">$HOME</span>&#125;</span>;<br>    <span class="hljs-keyword">if</span> [[ <span class="hljs-string">&quot;<span class="hljs-variable">$new_dir</span>&quot;</span> =~ ^-[0-9]&#123;,2&#125;$ ]]; <span class="hljs-keyword">then</span><br>        index=<span class="hljs-variable">$&#123;new_dir:1&#125;</span>;<br>        <span class="hljs-keyword">if</span> [ -z <span class="hljs-string">&quot;<span class="hljs-variable">$index</span>&quot;</span> ]; <span class="hljs-keyword">then</span><br>            new_dir=<span class="hljs-variable">$OLDPWD</span>;<br>        <span class="hljs-keyword">else</span><br>            new_dir=$(<span class="hljs-built_in">dirs</span> -l +<span class="hljs-variable">$index</span>) || <span class="hljs-built_in">return</span>;<br>        <span class="hljs-keyword">fi</span>;<br>    <span class="hljs-keyword">fi</span>;<br>    <span class="hljs-built_in">pushd</span> -- <span class="hljs-string">&quot;<span class="hljs-variable">$new_dir</span>&quot;</span> &gt; /dev/null || <span class="hljs-built_in">return</span>;<br>    <span class="hljs-built_in">popd</span> -n +<span class="hljs-variable">$hnum</span> &amp;&gt; /dev/null || <span class="hljs-literal">true</span>;<br>    new_dir=<span class="hljs-variable">$PWD</span> cnt=1;<br>    <span class="hljs-keyword">while</span> <span class="hljs-built_in">dir</span>=$(<span class="hljs-built_in">dirs</span> -l +<span class="hljs-variable">$cnt</span> 2&gt; /dev/null); <span class="hljs-keyword">do</span><br>        <span class="hljs-keyword">if</span> [ <span class="hljs-string">&quot;<span class="hljs-variable">$dir</span>&quot;</span> = <span class="hljs-string">&quot;<span class="hljs-variable">$new_dir</span>&quot;</span> ]; <span class="hljs-keyword">then</span><br>            <span class="hljs-built_in">popd</span> -n +<span class="hljs-variable">$cnt</span> &gt; /dev/null;<br>            <span class="hljs-built_in">continue</span>;<br>        <span class="hljs-keyword">fi</span>;<br>        <span class="hljs-built_in">let</span> cnt++;<br>    <span class="hljs-keyword">done</span><br>&#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>Linux</category>
      
    </categories>
    
    
    <tags>
      
      <tag>HPC</tag>
      
      <tag>shell script</tag>
      
      <tag>bashrc</tag>
      
      <tag>Linux</tag>
      
      <tag>Terminal</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>WRF | ncview/ncvis -- a NetCDF visual browser</title>
    <link href="/2024/10/10/ncview/"/>
    <url>/2024/10/10/ncview/</url>
    
    <content type="html"><![CDATA[<h1 id="ncview">ncview</h1><ul><li><a href="https://cirrus.ucsd.edu/~pierce/software/ncview/index.html">ncview website | David W. Pierce</a></li><li>ncmaps brings scientific colormaps to ncview. <a href="https://github.com/TomLav/ncmaps/tree/main" class="uri">https://github.com/TomLav/ncmaps/tree/main</a></li></ul><p><strong>Ncview is designed to be the fastest way to see what's in a netCDF file</strong>. Of course I'm biased since I wrote the thing, but I think everybody who works with netCDF files can benefit from having ncview in their toolkit. Ncview doesn't replace existing analysis packages, such as IDL, NCL, Matlab, Ferret, or R; instead it supplements them by providing a quick and easy way to get an enormous amount of information from your netCDF file.</p><h2 id="installation">Installation</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">conda install conda-forge::ncview<br></code></pre></td></tr></table></figure><h2 id="command-prompt">Command prompt</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">ncview xxx.nc<br></code></pre></td></tr></table></figure><figure><img src="https://i.imgur.com/lGIE5ba.png" alt="ncview" /><figcaption>ncview</figcaption></figure><p>In particular, the following attributes are taken into account:</p><ul><li><strong>missing_value</strong>: This attribute, which must be of the same type as the variable it is associated with, is an important one to set if you have missing values that are indicated by some “special” number such as -999.9, 1.0e35, or whatever. If you don’t set this attribute, ncview will not work properly.</li><li><strong>units</strong>: A character-type attribute that gives the units of the variable it is associated with. For example, “meters” or “Years”.</li><li><strong>long_name</strong>: A character-type attribute that gives the extended, or more descriptive, name of the variable it is associated with. For instance, if the variable’s name is “Lon”, its long_name might be “Longitude”.</li><li><strong>title</strong>: This global character-type attribute gives some short, descriptive summary of the meaning or parameters of the data file. For instance, it might be “Run 017: dx=4, dy=5, nT=45 yrs” or “El Nino Simulation, no mixed layer, D. Pierce SIO/CRD”.</li><li><strong>add_offset, scale_factor</strong>: Ncview respects these attributes, transparently scaling and offsetting the data as specified. See the netCDF documentation on these attributes for details. In essence, these attributes let you implement a form of data packing.</li></ul><h1 id="packed-data-values">Packed Data Values</h1><p>What are <strong>add_offset, scale_factor</strong> ?</p><ul><li><a href="https://www.unidata.ucar.edu/software/netcdf/workshops/2010/bestpractices/Packing.html" class="uri">https://www.unidata.ucar.edu/software/netcdf/workshops/2010/bestpractices/Packing.html</a></li></ul><div class="note note-warning">            <p>Conventions for packing numeric data to <strong>save space</strong> have some subtleties.</p>          </div><p>Packed data is stored in a netCDF file using a smaller data type than the original data, for example, packing doubles into shorts. The netCDF library itself does not do packing and unpacking, but the Java-netCDF library will do automatic unpacking, see class VariableDS.</p><p>Recommendations:</p><p>For each variable with packed data, add two attributes called scale_factor and add_offset, such that</p><blockquote><p>unpacked_value = packed_value * scale_factor + add_offset</p></blockquote><p>The type of the stored variable is the type of the packed data type, typically byte, short, or int.</p><p>The type of the scale_factor and add_offset attributes should be the type that you want the unpacked data to be, typically float or double.</p><p>To compute the scale and offset for maximum precision packing of a set of numbers, use:</p><blockquote><p>add_offset = dataMin<br />scale_factor = (dataMax - dataMin) / (2^n - 1)</p></blockquote><p>where n is the number of bits of the packed (integer) data type.</p><p>To avoid introducing a bias into the unpacked values due to truncation when packing, round to the nearest integer rather than just truncating towards zero:</p><blockquote><p>packed_value = nint((unpacked_value - add_offset) / scale_factor)</p></blockquote><p>The precision of the data will be</p><blockquote><p>1.0 / scale_factor.</p></blockquote><p>Example, packing 32-bit floats into 16-bit shorts:</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs text">variables:<br>  short data(z, y, x) ;<br>    data:scale_offset = 34.02f ;<br>    data:add_offset = 1.54f ;<br></code></pre></td></tr></table></figure><h1 id="ncvis">ncvis</h1><ul><li><a href="https://github.com/SEATStandards/ncvis" class="uri">https://github.com/SEATStandards/ncvis</a></li></ul><p>NetCDF Visualizer</p><p>Developed by Paul A. Ullrich</p><div class="note note-warning">            <p>In order for ncvis to run the resources directory must be in the same folder as ncvis or the NCVIS_RESOURCE_DIR environment variable must be set to the path of the ncvis resources folder. This directory is where ncvis stores <strong>fonts</strong>, <strong>colormaps</strong> and <strong>shapefiles</strong>.</p>          </div><figure><img src="https://user-images.githubusercontent.com/5330916/187129223-b9d47718-fff3-4fd9-8efb-4f71bd86d3e2.png" alt="ncvis" /><figcaption>ncvis</figcaption></figure><h2 id="from-source-code">from source code</h2><ul><li>https://github.com/SEATStandards/ncvis</li></ul><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs sh">conda create -n ncvis -c conda-forge wxwidgets libnetcdf<br>conda activate ncvis<br>conda install conda-forge::cxx-compiler<br>conda install -c anaconda libxxf86vm-cos6-x86_64<br></code></pre></td></tr></table></figure><p>Then,</p><ul><li>soft-link micromamba/envs/ncvis-v1/x86_64-conda_cos6-linux-gnu/sysroot/usr/lib64/libXxf86vm.so.1 to /home/wpsze/micromamba/envs/ncvis-v1/lib</li></ul><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs sh">$ sh ./build.sh<br><span class="hljs-comment"># check</span><br>$ ldd ncvis |grep not<br><span class="hljs-comment"># set</span><br><span class="hljs-built_in">alias</span> ncvis=/home/wpsze/share/ncvis/ncvis<br></code></pre></td></tr></table></figure><div class="note note-warning">            <p>ncvis uses degree for lat lon but MPAS uses radian</p>          </div>]]></content>
    
    
    <categories>
      
      <category>WRF</category>
      
    </categories>
    
    
    <tags>
      
      <tag>NWP</tag>
      
      <tag>WRF</tag>
      
      <tag>MPAS</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>NWP | AI for Numerical Weather Prediction (NWP)</title>
    <link href="/2024/10/09/NWP-AI-for-Numerical-Weather-Prediction-NWP/"/>
    <url>/2024/10/09/NWP-AI-for-Numerical-Weather-Prediction-NWP/</url>
    
    <content type="html"><![CDATA[<h1 id="introduction-to-ai-in-numerical-weather-prediction">Introduction to AI in Numerical Weather Prediction</h1><p>Artificial Intelligence (AI) is transforming the field of Numerical Weather Prediction (NWP), significantly enhancing the accuracy and efficiency of weather forecasting. Traditional NWP relies on complex physical models to simulate atmospheric processes, but the integration of AI and machine learning (ML) is introducing new methodologies that leverage vast datasets to improve predictions.</p><p>AI technologies, particularly machine learning algorithms, excel at analyzing large volumes of meteorological data from diverse sources, including satellites, radar systems, and surface sensors. These algorithms can identify intricate patterns and correlations that may be overlooked by conventional methods, leading to more precise forecasts. For instance, models like Google DeepMind's GraphCast can predict weather conditions up to ten days in advance in less than a minute, outperforming traditional systems that require hours on supercomputers.</p><div class="note note-warning">            <p><a href="https://www.ecmwf.int/en/about/media-centre/aifs-blog">ECMWF | AIFS Blog</a></p>          </div><ul><li><a href="https://charts.ecmwf.int/products/plwww_3m_fc_aifs_wp_mean?area=Northern%20Extra-tropics&amp;parameter=Geopotential%20500hPa&amp;score=Root%20mean%20square%20error">Scores of forecasts of upper-air parameters by AIFS - experimental machine learning model</a> <!-- - [Scores of forecasts of upper-air parameters by experimental machine learning models](https://charts.ecmwf.int/streaming/20241009-0750/81/ps2png-worker-commands-76f744c54b-4xnd6-6fe5cac1a363ec1525f54343b6cc9fd8-zisedq81.png)![ECMWF | Scores of forecasts of upper-air parameters by experimental machine learning models **(Higher is better)**](https://charts.ecmwf.int/streaming/20241009-0750/81/ps2png-worker-commands-76f744c54b-4xnd6-6fe5cac1a363ec1525f54343b6cc9fd8-zisedq81.png)![ECMWF | Scores of forecasts of upper-air parameters by experimental machine learning models **(Lower is better)**](https://charts.ecmwf.int/streaming/20241009-0710/e3/ps2png-worker-commands-76f744c54b-rk8tn-6fe5cac1a363ec1525f54343b6cc9fd8-ue79gh2y.png) --></li></ul><h1 id="run-ai-models-yourself-from-ecmwf-open-data">Run AI models yourself from ECMWF open data</h1><p>26 September 2024<br />The AIFS team</p><ul><li><a href="https://www.ecmwf.int/en/about/media-centre/aifs-blog/2024/run-ai-models-yourself-ecmwf-open-data" class="uri">https://www.ecmwf.int/en/about/media-centre/aifs-blog/2024/run-ai-models-yourself-ecmwf-open-data</a></li><li>To announce that users can now run AI models using ECMWF's open data themselves. This breakthrough democratizes access to cutting-edge weather forecasting technology and opens new possibilities for research, education, and application development.</li><li>success of machine learning models like FourCastNet, Pangu-Weather, GraphCast and FuXi, ECMWF is now empowering users to harness these AI tools directly.</li></ul><h2 id="the-power-of-open-data-and-ai">The power of open data and AI</h2><p>By combining ECMWF's high-quality open data with state-of-the-art AI models, users can:</p><ul><li>generate rapid forecasts on their own computer</li><li>explore multi-model ensemble forecasting techniques with AI</li><li>conduct research on model performance and intercomparison without any accounts/licences.</li><li><strong>Plugins already exist for Pangu-Weather, FourCastNet (versions 1 and 2), GraphCast, FuXi and, most recently, Aurora.</strong></li><li><a href="https://github.com/ecmwf-lab/ai-models" class="uri">https://github.com/ecmwf-lab/ai-models</a></li></ul><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs sh">pip install ai-models <br><br>pip install ai-models-panguweather <span class="hljs-comment"># Or another model </span><br>pip install ai-models-fourcastnet<br>pip install ai-models-graphcast  <span class="hljs-comment"># Install details at https://github.com/ecmwf-lab/ai-models-graphcast</span><br>pip install ai-models-fourcastnetv2 <br><br>ai-models panguweather --input ecmwf-open-data <br></code></pre></td></tr></table></figure><p>See</p><ul><li><a href="https://github.com/ecmwf-lab/ai-models-panguweather">ai-models-panguweather</a>,</li><li><a href="ai-models-fourcastnet">ai-models-fourcastnet</a>,</li><li><a href="ai-models-fourcastnetv2">ai-models-fourcastnetv2</a> and</li><li><a href="ai-models-graphcast">ai-models-graphcast</a></li></ul><p>for more details about these models.</p><div class="note note-warning">            <p>To fix ONNX or version issue, we suggest that you <strong>install ai-models in a conda environment and install the CUDA libraries in that environment</strong>.</p>          </div><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs sh">conda create -n ai-models python=3.10<br>conda activate ai-models<br>conda install cudatoolkit<br>pip install ai-models<br>...<br></code></pre></td></tr></table></figure><h3 id="running-the-models">Running the models</h3><p>To run model, make sure it has been installed, then simply run:</p><div class="note note-warning">            <p>By default, the model will be run for <strong>a 10-day lead time (240 hours)</strong>, using <strong>yesterday's 12Z analysis</strong> from ECMWF's MARS archive.</p>          </div><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs sh">ai-models &lt;model-name&gt;<br><br><span class="hljs-comment"># To produce a 15 days forecast, use the --lead-time HOURS option:</span><br>ai-models --lead-time 360 &lt;model-name&gt;<br></code></pre></td></tr></table></figure><h3 id="performances-considerations">Performances Considerations</h3><p>The AI models can run on a CPU; however, they perform significantly better on a GPU.</p><div class="note note-warning">            <p><strong>A 10-day forecast can take several hours on a CPU but only around one minute on a modern GPU.</strong></p>          </div><div class="note note-warning">            <p><strong>We strongly recommend running these models on a computer equipped with a GPU for optimal performance.</strong></p>          </div><p>It you see the following message when running a model, it means that the <strong>ONNX runtime was not able to find a the CUDA libraries on your system</strong>:</p><blockquote><p>[W:onnxruntime:Default, onnxruntime_pybind_state.cc:541 CreateExecutionProviderInstance] Failed to create CUDAExecutionProvider. Please reference https://onnxruntime.ai/docs/reference/execution-providers/CUDA-ExecutionProvider.html#requirements to ensure all dependencies are met.</p></blockquote><h3 id="assets">Assets</h3><p>The AI models rely on weights and other assets created during training. The first time you run a model, you will need to download the <strong>trained weights</strong> and <strong>any additional required assets</strong>.</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># To download the assets before running a model, use the following command:</span><br>ai-models --download-assets &lt;model-name&gt;<br><br><span class="hljs-comment"># The assets will be downloaded if needed and stored in the current directory. You can provide a different directory to store the assets:</span><br>ai-models --download-assets --assets &lt;some-directory&gt; &lt;model-name&gt;<br><br><span class="hljs-comment"># Then, for running, later on, simply use:</span><br>ai-models --assets &lt;some-directory&gt;  &lt;model-name&gt;<br><span class="hljs-comment"># or </span><br><span class="hljs-built_in">export</span> AI_MODELS_ASSETS=&lt;some-directory&gt;<br>ai-models &lt;model-name&gt;<br></code></pre></td></tr></table></figure><p>For better organisation of the assets directory, you can use the <strong>--assets-sub-directory</strong> option. This option will store the assets of each model in its own subdirectory within the specified assets directory.</p><h3 id="input-data">Input data</h3><p>The models require input data (initial conditions) to run. You can provide the input data using different sources, as described below:</p><h4 id="from-mars">From MARS</h4><div class="note note-warning">            <p>By default, <strong>ai-models use yesterday's 12Z analysis from ECMWF</strong>, fetched from the Centre's MARS archive using the <a href="https://www.ecmwf.int/en/computing/software/ecmwf-web-api">ECMWF WebAPI</a>. <strong>You will need an ECMWF account to access that service</strong>.</p>          </div><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># To change the date or time, use the --date and --time options, respectively:</span><br><br>ai-models --<span class="hljs-built_in">date</span> YYYYMMDD --time HHMM &lt;model-name&gt;<br></code></pre></td></tr></table></figure><h4 id="from-the-cds-era5">From the CDS (ERA5)</h4><p>You can start the models <strong>using ERA5 (ECMWF Reanalysis version 5) data</strong> for the <a href="https://cds.climate.copernicus.eu/">Copernicus Climate Data Store (CDS)</a>. You will need to create an account on the CDS. The data will be downloaded using the <a href="https://cds.climate.copernicus.eu/api-how-to">CDS API</a>).</p><p>To access the CDS, simply add <strong>--input cds</strong> on the command line. <strong>Please note that ERA5 data is added to the CDS with a delay</strong>, so you will also have to provide a date with --date YYYYMMDD.</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">ai-models --input cds --<span class="hljs-built_in">date</span> 20230110 --time 0000 &lt;model-name&gt;<br></code></pre></td></tr></table></figure><h4 id="from-a-grib-file">From a GRIB file</h4><p>If you have input data in the GRIB format, you can provide the file using the <strong>--file</strong> option:</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">ai-models --file &lt;some-grib-file&gt; &lt;model-name&gt;<br></code></pre></td></tr></table></figure><div class="note note-warning">            <p>The GRIB file can contain more fields than the ones required by the model. The ai-models command will automatically select the necessary fields from the file.</p>          </div><div class="note note-warning">            <p>GFS grib files?</p>          </div><p>To find out the list of fields needed by a specific model as initial conditions, use the following command:</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">ai-models --fields &lt;model-name&gt;<br></code></pre></td></tr></table></figure><h3 id="output">Output</h3><p>By default, the model output will be written in GRIB format in a file called <strong>&lt;model-name&gt;.grib</strong>. You can change the file name with the option <strong>--path <file-name></strong>. If the path you specify contains placeholders between { and }, multiple files will be created based on the <a href="https://confluence.ecmwf.int/display/ECC">eccodes</a> keys. For example:</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">ai-models --path <span class="hljs-string">&#x27;out-&#123;step&#125;.grib&#x27;</span> &lt;model-name&gt;<br></code></pre></td></tr></table></figure><p><strong>This command will create a file for each forecasted time step.</strong></p><p>If you want to disable writing the output to a file, use the <strong>--output none</strong> option.</p><h3 id="command-line-options">Command line options</h3><p>It has the following options:</p><ul><li><code>--help</code>: Displays this help message.</li><li><code>--models</code>: Lists all installed models.</li><li><code>--debug</code>: Turns on debug mode. This will print additional information to the console.</li></ul><h4 id="input">Input</h4><ul><li><code>--input INPUT</code>: The input source for the model. This can be a <code>mars</code>, <code>cds</code> or <code>file</code>.</li><li><p><code>--file FILE</code>: The specific file to use as input. This option will set <code>--source</code> to <code>file</code>.</p></li><li><code>--date DATE</code>: The analysis date for the model. This defaults to yesterday.</li><li><p><code>--time TIME</code>: The analysis time for the model. This defaults to 1200.</p></li></ul><h4 id="output-1">Output</h4><ul><li><code>--output OUTPUT</code>: The output destination for the model. Values are <code>file</code> or <code>none</code>.</li><li><code>--path PATH</code>: The path to write the output of the model.</li></ul><h4 id="run">Run</h4><ul><li><code>--lead-time HOURS</code>: The number of hours to forecast. The default is 240 (10 days).</li></ul><h4 id="assets-management">Assets management</h4><ul><li><code>--assets ASSETS</code>: Specifies the path to the directory containing the model assets. The default is the current directory, but you can override it by setting the <code>$AI_MODELS_ASSETS</code> environment variable.</li><li><code>--assets-sub-directory</code>: Enables organising assets in <code>&lt;assets-directory&gt;/&lt;model-name&gt;</code> subdirectories.</li><li><code>--download-assets</code>: Downloads the assets if they do not exist.</li></ul><h4 id="misc.-options">Misc. options</h4><ul><li><code>--fields</code>: Print the list of fields needed by a model as initial conditions.</li><li><code>--expver EXPVER</code>: The experiment version of the model output.</li><li><code>--class CLASS</code>: The 'class' metadata of the model output.</li><li><code>--metadata KEY=VALUE</code>: Additional metadata metadata in the model output</li></ul><h1 id="available-products">Available products</h1><p>The output of these ML models are forecasts with 6-hourly time steps out to 10 days initialised from the ECMWF operational analysis. All forecasts are produced on a 0.25 x 0.25-degree grid.</p><h2 id="fourcastnetv2-small">FourCastNetv2-small:</h2><p>Upper-air fields are z (geopotential), r (relative humidity), t (temperature), u (U component of wind), and v (V component of wind) on the following pressure levels: 1000hPa, 925hPa, 850hPa, 700hPa, 600hPa, 500hPa, 400hP, 300hPa, 250hPa, 200hPa, 150hPa, 100hPa and 50hPa</p><p>The single-level fields are msl (mean sea level pressure), sp (surface pressure), 10u (10 metre U wind component), 10v (10 metre U wind component), 100u (100 metre U wind component), 100v (100 metre V wind component, 2t (2 metre temperature) and tcwv (total column vertically-integrated water vapour).</p><ul><li><strong>NVIDIA</strong></li><li><a href="https://arxiv.org/pdf/2202.11214.pdf?trk=public_post_comment-text">Pathak, J., Subramanian, S., Harrington, P., Raja, S., Chattopadhyay, A., Mardani, M., ... &amp; Anandkumar, A. (2022). Fourcastnet: A global data-driven high-resolution weather model using adaptive fourier neural operators. arXiv preprint arXiv:2202.11214.</a></li><li><a href="https://proceedings.mlr.press/v202/bonev23a/bonev23a.pdf">Bonev, B., Kurth, T., Hundt, C., Pathak, J., Baust, M., Kashinath, K., &amp; Anandkumar, A. (2023, July). Spherical fourier neural operators: Learning stable dynamics on the sphere. In International conference on machine learning (pp. 2806-2823). PMLR.</a></li><li><strong>Fourier Neural Operators (FNOs)</strong> have proven to be an efficient and effective method for <strong>resolution independent operator learning</strong> in a broad variety of application areas across scientific machine learning.</li><li><a href="https://zhuanlan.zhihu.com/p/669083609">智能模式系列｜一文读懂FourCastNet：首个全球高分辨率人工智能天气预报模型 (<strong>推薦</strong>)</a></li><li>FourCastNet 的网络模型使用了 AFNO 网络，该网络此前常用于图像分割任务。这个网络通过 FNO 弥补了 ViT 网络的缺点，使用傅立叶变换完成不同 token 信息交互，显著减少了高分辨率下 ViT 中 self-attention 的计算量。</li><li>由于完整复现 FourCastNet 需要 5TB+ 的存储空间和 64 卡的 GPU 资源，需要的存储资源比较多 <a href="https://paddlescience-docs.readthedocs.io/zh-cn/latest/zh/examples/fourcastnet/#5">link</a></li></ul><div class="group-image-container"><div class="group-image-row"><div class="group-image-wrap"><img src="https://i.imgur.com/5I6TxUo.png" width="600" /></div><div class="group-image-wrap"><img src="https://i.imgur.com/8KnDz1x.png" width="600" /></div></div></div><h2 id="graphcast">Graphcast:</h2><p>Upper-air fields are z (geopotential), q (specific humidity), t (temperature), u (U component of wind), v (V component of wind), w (vertical wind component) on the following pressure levels: 1000hPa, 925hPa, 850hPa, 700hPa, 600hPa, 500hPa, 400hP, 300hPa, 250hPa, 200hPa, 150hPa, 100hPa and 50hPa</p><p>The single-level fields are msl (mean sea level pressure), 10u (10 metre U wind component), 10v (10 metre U wind component), and 2t (2 metre temperature).</p><ul><li><a href="https://www.science.org/stoken/author-tokens/ST-1550/full">Lam, R., Sanchez-Gonzalez, A., Willson, M., Wirnsberger, P., Fortunato, M., Alet, F., ... &amp; Battaglia, P. (2023). Learning skillful medium-range global weather forecasting. Science, 382(6677), 1416-1421.</a></li><li>GraphCast 利用所謂 <strong>圖神經網路(Graph Neural Network，GNN)</strong> 的機器學習架構，以超過 40 年的 ECMWF 天氣歷史資料訓練模型。它能處理當下和 6 小時前全球大氣狀態，並在 1 分鐘內以搭載 TPU v4 的雲端電腦產生 10 天天氣預報。</li></ul><p><img src="https://i.imgur.com/ysa2HNE.png" width="600" /></p><h2 id="pangu-weather">Pangu-Weather:</h2><p>Upper-air fields are z (geopotential), q (specific humidity), t (temperature), u (U component of wind), and v (V component of wind) on the following pressure levels: 1000hPa, 925hPa, 850hPa, 700hPa, 600hPa, 500hPa, 400hPa, 300hPa, 250hPa, 200hPa, 150hPa, 100hPa and 50hPa</p><p>The single-level fields are msl (mean sea level pressure), 10u (10 metre U wind component), 10v (10 metre U wind component) and 2t (2 metre temperature).</p><p>华为云盘古气象大模型</p><ul><li><a href="https://www.nature.com/articles/s41586-023-06185-3">Bi, K., Xie, L., Zhang, H., Chen, X., Gu, X., &amp; Tian, Q. (2023). Accurate medium-range global weather forecasting with 3D neural networks. Nature, 619(7970), 533-538.</a></li><li><strong>2023年11月中旬</strong>發表在《自然》（Nature）上的研究顯示，由人工智慧驅動的伏羲氣候氣象大模型可以提前15天預測全球天氣變化，比如氣溫、風速和氣壓等天氣參數。該模型的預報精度優於被譽為「黃金標準」的歐洲中期天氣預報中心（ECMWF），生成結果的速度也比傳統模型快千倍。</li><li>华为云盘古大模型研发团队发现，AI气象预报模型的精度不足主要有两个原因：<ul><li>第一，原有的AI气象预报模型都是基于2D神经网络，<strong>无法很好地处理不均匀的3D气象数据</strong>；</li><li>第二，<strong>AI方法缺少数学物理机理约束</strong>，因此在迭代的过程中会不断积累迭代误差。为此，团队创造性地提出了适应地球坐标系统的 <strong>三维神经网络（3D Earth-Specific Transformer）</strong> 来处理复杂的不均匀3D气象数据，并且使用层次化时域聚合策略来减少预报迭代次数，从而减少迭代误差。通过在43年的全球天气数据上训练深度神经网络，盘古气象大模型在精度和速度方面超越传统数值预测方法。</li><li>该网络由<strong>8个编码器</strong>和<strong>8个解码器</strong>的结构构成，每个编码器-解码器层是一个3DEST块，利用了transformer的变体（<strong>swin transformer</strong>）来继承窗口注意力机制</li><li>采用了标准的编码器-解码器设计结构</li></ul></li><li><a href="https://www.huawei.com/cn/news/2024/3/pangu-weather">华为云和深圳市气象局发布人工智能区域预报模型“智霁”1.0</a><ul><li>华为云联合深圳气象局率先开展人工智能区域预报模型联创研发</li><li>“智霁”区域模型以华为云盘古气象大模型为基础，融合区域高质量气象数据集，可快速得到<strong>未来5天深圳及周边地区空间分辨率为3公里</strong></li><li>克服了三个技术难题：<ul><li>一是对多源和多尺度数据的融合性处理，包含3公里及25公里不同尺度再分析数据以及多源观测数据等作为输入；</li><li>二是联合创新了全球模型与区域模型的融合架构，可以更好地处理区域边界，充分考虑区域外有效信息对区域内预测结果的影响；</li><li>三是利用3DEST神经网络自监督学习特征，将全量数据集合预训练，提升预报精度。</li><li>由中国气象局广东省区域数值天气预报重点实验室研发，<strong>广州超算中心支撑广东省气象局构建的“9-3-1”高分辨率天气模式系统</strong>，预报能力已进入国际领先行列，推动了精细化天气预报技术的深入发展。该模式系统多年来，在<strong>广州超算中心“天河二号”</strong>超算系统上业务级稳定运行，实现了关键核心技术的自主可控，为台风、暴雨和强对流等天气的精准预报提供了科技支撑，也为城市防灾减灾、区域生态文明建设、大气污染联防联控提供了科学决策支持。</li></ul></li></ul></li><li><strong>地球座標系統適應性</strong>：該模型特別設計用於氣象數據，考慮到地球表面的不規則性，引入了與緯度和高度相關的絕對<strong>位置編碼</strong>，以更好地捕捉氣象數據中的不均勻性和複雜物理規律，如科氏力。</li><li><strong>三維結構</strong>：與傳統的2D神經網路不同，3D Earth-Specific Transformer採用<strong>三維結構來處理</strong>氣象資料的多維度特性，包括垂直高度上的不同氣壓層和地表氣像要素。</li><li><strong>創新位置編碼</strong>：引入了<strong>Earth-Specific位置編碼</strong>，這種編碼方式能夠更好地處理氣象資料中的空間不均勻性，有助於學習到氣象資料背後的複雜物理規律。</li></ul><p><img src="https://i.imgur.com/Ql7iIb9.png" width="600" /></p><h2 id="fuxi">Fuxi:</h2><h3 id="addition-of-fuxi-ai-model-forecast-products-on-the-earth-weather-webpage"><a href="https://www.hko.gov.hk/en/Whats-New/108763/Addition-of-Fuxi-AI-Model-Forecast-Products-on-the-Earth-Weather-Webpage">Addition of “Fuxi” AI Model Forecast Products on the “Earth Weather” Webpage</a></h3><ul><li><a href="https://www.nature.com/articles/s41612-023-00512-1">Chen, L., Zhong, X., Zhang, F., Cheng, Y., Xu, Y., Qi, Y., &amp; Li, H. (2023). FuXi: A cascade machine learning forecasting system for 15-day global weather forecast. npj Climate and Atmospheric Science, 6(1), 190.</a></li><li>复旦大学人工智能创新与产业研究院、上海科学智能研究院李昊研究员与漆远教授团队携手中国气象局气候研究开放实验室陆波研究员团队在国际权威综合性期刊《Nature Communications》杂志发表题为“A machine learning model that outperforms conventional global subseasonal forecast models”的研究论文，详细介绍 <strong>“伏羲”次季节-季节预测模型 (FuXi-S2S)</strong>。</li><li>由<strong>上海科学智能研究院、复旦大学、中国国家气候中心</strong>联手打造的“伏羲”次季节大模型，在技术难题上实现大突破，将对气候变化风险应对，起到至关重要的作用</li><li>伏羲電腦模式 由<strong>復旦大學人工智能創新與產業研究院</strong>提供。</li><li>2023年11月中旬發表在《自然》（Nature）上的研究顯示，由人工智慧驅動的伏羲氣候氣象大模型可以提前15天預測全球天氣變化，比如氣溫、風速和氣壓等天氣參數。該模型的預報精度優於被譽為「黃金標準」的歐洲中期天氣預報中心（ECMWF），生成結果的速度也比傳統模型快千倍。<strong>在此基礎上，研究團隊進一步優化伏羲氣候氣象大模型，終於推出預測周期長達45天之久的伏羲次季節大模型</strong>。相較於伏羲中短期模型，三倍的預測周期時長充滿變數。於是，伏羲大模型先把隨機採樣引入與ChatGPT類似的<strong>Transformer架構</strong>，再通過<strong>集合預報</strong>反映次季節預測的不確定性。</li></ul><div class="group-image-container"><div class="group-image-row"><div class="group-image-wrap"><img src="https://i.imgur.com/pCL58bw.png" /></div><div class="group-image-wrap"><img src="https://i.imgur.com/g65NHvJ.png" /></div></div></div><h1 id="hands-on">Hands-on</h1><h1 id="ecmwf-anemoi">ECMWF: Anemoi</h1><h2 id="gnn-for-glogal-regional-or-limited-area-modeling">GNN for Glogal-regional or Limited Area Modeling</h2><ul><li>Oskarsson, J., Landelius, T., &amp; Lindsten, F. (2023). Graph-based Neural Weather Prediction for Limited Area Modeling. <a href="https://arxiv.org/pdf/2309.17370">arXiv preprint arXiv:2309.17370</a>.<ul><li><a href="https://github.com/mllam/neural-lam" class="uri">https://github.com/mllam/neural-lam</a></li><li>adapt the graph-based NeurWP approach to the limited area setting and propose a multi-scale hierarchical model extension</li><li>utilize Graph Neural Networks (GNNs) to produce forecasts</li><li>Global: GraphCast model</li><li>Hierarchical Graph Neural Networks (MultiScale MeshGraphNets: <a href="https://arxiv.org/pdf/2210.00612" class="uri">https://arxiv.org/pdf/2210.00612</a>)</li></ul></li></ul><h1 id="references">References</h1><ol type="1"><li><a href="https://www.ecmwf.int/en/about/media-centre/aifs-blog">ECMWF | AIFS Blog</a></li><li><a href="https://www.ecmwf.int/en/about/media-centre/aifs-blog/2024/run-ai-models-yourself-ecmwf-open-data">ECMWF | 2024 Run AI models yourself from ECMWF open data</a></li><li><a href="https://www.ecmwf.int/en/about/media-centre/aifs-blog/2024/data-driven-regional-modelling">ECMWF | 2024 Data-driven regional modelling</a><ul><li>some great work for limited-area modelling with Neural-LAM (Oskarsson et al. 2023).</li><li>In contrast to Neural-LAM, the approach we are currently testing keeps a global model. Over the domain where high-resolution data are available, here the Nordics, a finer-resolution graph is used in the model, to be able to ingest and output data from high-resolution regional analysis, reanalysis or forecast datasets.</li></ul></li><li><a href="https://www.ecmwf.int/en/about/media-centre/aifs-blog/2024/enter-ensembles">ECMWF | 2024 Enter the ensembles</a></li><li><a href="https://www.ecmwf.int/en/forecasts/dataset/machine-learning-model-data">ECMWF | 2023 Machine Learning model data</a></li><li><a href="https://news.qq.com/rain/a/20241227A04YGV00">AI预报天气很行，但是也没那么行 | 中科院物理所 | 2024-12-27 12:21</a><ol type="1"><li>除了上文提到的进入《Nature》正刊的华为盘古大模型、谷歌GraphCast模型以外，还有英伟达FourCastNet模型、微软ClimaX模型、复旦大学伏羲大模型、上海人工智能实验室“风乌”GHR大模型、清华大学和中国气象局的NowcastNet预报大模型等等。而华为的盘古大模型已经在欧洲中期天气预报中心（ECMWF）实现业务运行，此外作为全世界最先进的天气预报机构，ECMWF也发布了大模型AIFS。</li></ol></li></ol>]]></content>
    
    
    <categories>
      
      <category>NWP</category>
      
    </categories>
    
    
    <tags>
      
      <tag>NWP</tag>
      
      <tag>AI</tag>
      
      <tag>ML</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>WRF | Reduce the amount of wrfout data</title>
    <link href="/2024/10/08/reduce-wrfout-size/"/>
    <url>/2024/10/08/reduce-wrfout-size/</url>
    
    <content type="html"><![CDATA[<h1 id="how-to-reduce-the-amount-of-wrfout-data">How to reduce the amount of wrfout data</h1><ul><li><a href="https://forum.mmm.ucar.edu/threads/how-to-reduce-the-amount-of-wrfout-data.8642/">How to reduce the amount of wrfout data</a></li></ul><p>Two methods,</p><ul><li>Go into the WRF/Registry/Registry.EM_COMMON file, and then look for the variables you don’t want. You can remove the ‘h’ from out I/O column. After you do this for all of the variables you want removed, you will need to save the file, go back to the WRF/ directory, issue a ‘clean -a’ and then reconfigure and recompile</li><li>You can also use the Runtime I/O option, which will allow you to add a couple lines to your namelist, and create a text file that the model will read when it is run. With this method, you don't have to recompile the code, but you have to be careful to type everything correctly, and have no spaces in the text file. You can read about it here: <a href="http://www2.mmm.ucar.edu/wrf/users/docs/user_guide_v4/v4.1/users_guide_chap5.html#runtimeio" class="uri">http://www2.mmm.ucar.edu/wrf/users/docs/user_guide_v4/v4.1/users_guide_chap5.html#runtimeio</a></li></ul><div class="note note-warning">            <p>Just be careful removing variables. If you ever want to go back and plot specific things, or if you will use the files for anything else later, you may be missing something you didn't realize you would need.</p>          </div><h1 id="iofields_filename-not-working-wrfv4">iofields_filename not working WRFv4</h1><ul><li><a href="https://forum.mmm.ucar.edu/threads/iofields_filename-not-working-wrfv4.12353/#post-29058">iofields_filename not working WRFv4</a></li><li>iofields_filename = 'myoutfields.txt','youtfields.txt','myoutfields.txt','myoutfields.txt',</li><li>Your 'myoutfields.txt' file is set up like <figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs text">-:h:0:Times,LU_INDEX,ZS,DZS,FNM<br>-:h:0:FNP,RDNW,RDN,DNW,DN,CFN<br>-:h:0:CFN1,THIS_IS_AN_IDEAL_RUN<br>-:h:0:CF1,CF2,CF3,ITIMESTEP<br>-:h:0:SHDMAX,SHDMIN,SNOALB,TSLB<br>-:h:0:SMOIS,SH2O,SMCREL,SFROFF<br></code></pre></td></tr></table></figure></li></ul><p>But it should all be on a single line. Change the file so that it's in the following format:</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs text">-:h:0:Times,LU_INDEX,ZS,DZS,FNM,FNP,RDNW,RDN,DNW,DN,CFN,CFN1,THIS_IS_AN_IDEAL_RUN,CF1,CF2,CF3,ITIMESTEP<br></code></pre></td></tr></table></figure><div class="note note-warning">            <p>I also had to remove the variable "Times" from the myoutfields.txt file to get it to run correctly, so you may need to do that, as well. Hopefully these will fix the problem.</p>          </div><h1 id="減少wrfout輸出變數">減少wrfout輸出變數</h1><ul><li><a href="https://mp.weixin.qq.com/s/wIeD4TjlZus-3HeHQRxfvw">減少wrfout輸出變數</a></li><li>具體方法在userguide中也提到過，可以透過修改Registry來實現，ARW核心對應的是Registry/Registry.EM_COMMON文件，對其修改，然後再重新編譯（clean -a、configure、compile）。</li><li>但在3.2版本後，可以透過直接在namelist.input中可以指定剔除不需要輸出的變量，即： <figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs text">&amp;time_control<br>iofields_filename = &quot;my_file_d01.txt&quot;, &quot;my_file_d02.txt&quot;<br>ignore_iofields_warning = .true.,<br></code></pre></td></tr></table></figure></li></ul><p>在my_file_d01.txt檔案中，可以指明需要刪除的變數有哪些，具體內容如下：</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs text">-:h:0:RAINC,RAINNC<br></code></pre></td></tr></table></figure><ul><li><p><strong>-</strong> 表示刪除，<strong>+</strong> 表示增加；</p></li><li><p><strong>h</strong> 表示history，這裡可以理解為輸出，i表示輸入；</p></li><li><p><strong>0-24</strong> ：表示經過的通道，一般 <strong>預設0</strong> ；</p></li></ul><p>可以直接進行換行，但每一行的開頭需要類似 <strong>-:h:0:格式</strong>，然後後面的變數之間用英文逗號隔開。</p><ul><li>ignore_iofields_warning表示碰到錯誤時如何處理，如果設定為.true.則會列印警告訊息且繼續運行，如果設定為.false.時碰到錯誤會直接中斷，建議設定為.true.，所有的domain都通用，不用單獨設定。</li></ul><p>其中註意事項包括：</p><ul><li>多個domain可以使用同一個控製文件，類似上面的 my_file_d01.txt;</li><li>my_file_d01.txt檔案中的變數需完全正確，如果某個變數設定不正確，可以正常執行，但會出現warning，如下：WARNING: Unable to modify mask for wdntc. Variable not found. File: my_file_d01.txt at line 4，根據報錯可以發現第4行的wdntc不正確，重新修改以後可以正常運作。</li></ul>]]></content>
    
    
    <categories>
      
      <category>WRF</category>
      
    </categories>
    
    
    <tags>
      
      <tag>wrfout</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Map of Local Climate Zones (LCZs)</title>
    <link href="/2024/10/07/Global-LCZ-for-Urban/"/>
    <url>/2024/10/07/Global-LCZ-for-Urban/</url>
    
    <content type="html"><![CDATA[<h1 id="local-climate-zones-lczs">Local Climate Zones (LCZs)</h1><p>Local Climate Zones (LCZs) are a classification system designed to characterize urban and natural environments based on their surface cover, structure, material, and human activity. <strong>Developed by Stewart and Oke in 2012</strong>, the LCZ framework includes <strong>17 distinct classes</strong>, with <strong>10 specifically categorized as urban zones</strong>. This system facilitates the study of <strong>urban heat islands</strong> and other climatic phenomena by</p><ul><li>providing a <strong>standardized method</strong> for observing and documenting urban temperature variations across different regions globally</li></ul><p><img src="https://i.imgur.com/NhJokqg.png" width="400" /></p><h2 id="key-features-of-local-climate-zones">Key Features of Local Climate Zones</h2><ul><li><strong>Uniformity</strong>: Each LCZ represents areas with uniform characteristics, spanning hundreds of meters to several kilometers. This uniformity allows for effective comparisons between different urban settings.</li><li><strong>Classification Basis</strong>: The classification is primarily based on properties such as building height, density, and surface cover types (pervious vs. impervious) which influence local climate conditions.</li><li><strong>Applications</strong>: LCZs are utilized in various fields including urban planning, energy consumption studies, and assessments of urban thermal comfort. They serve as a critical tool for researchers aiming to understand the impacts of urbanization on local climates</li></ul><h2 id="methods">Methods</h2><ul><li>In-Situ Measurements</li><li>Geographic Information System (GIS)-Based Methods</li><li>Remote Sensing Image-Based Methods</li></ul><h3 id="wudapt">WUDAPT</h3><p>The <a href="https://www.wudapt.org/wudapt/">World Urban Database and Access Portal Tools (WUDAPT)</a> plays a significant role in the classification of Local Climate Zones (LCZs) by providing a structured framework and tools for urban data collection and analysis. <strong>WUDAPT enhances LCZ classification by providing a standardized methodology, facilitating data collection, offering analytical tools, fostering community involvement, and producing multi-level data products that support diverse applications in urban climate research.</strong></p><h2 id="literature-review">Literature review</h2><ul><li><a href="https://www.nature.com/articles/s41599-024-03072-8.pdf">Han, Jie, et al. "Advancing the local climate zones framework: a critical review of methodological progress, persisting challenges, and future research prospects." Humanities and Social Sciences Communications 11.1 (2024): 1-18.</a></li></ul><p><img src="https://i.imgur.com/COxJJaB.png" width="600" /> <img src="https://i.imgur.com/D37oEFf.png" width="600" /> <img src="https://i.imgur.com/kZ208oW.png" width="600" /></p><h1 id="m-global-map-of-local-climate-zones-wrfofficial">100m Global map of Local Climate Zones (WRF/Official)</h1><ul><li><a href="https://zenodo.org/records/8419340" class="uri">https://zenodo.org/records/8419340</a></li></ul><h2 id="description">Description</h2><figure><img src="https://i.imgur.com/46uEI6Z.png" alt="A global 100 m spatial resolution Local Climate Zone (LCZ) map" /><figcaption>A global 100 m spatial resolution Local Climate Zone (LCZ) map</figcaption></figure><p>A global 100 m spatial resolution Local Climate Zone (LCZ) map, derived from multiple earth observation datasets and expert LCZ class labels.</p><p>The LCZ map is based on the LCZ typology (Stewart and Oke, 2012) that distinguish urban surfaces accounting for their typical combination of micro-scale land-covers and associated physical properties. The LCZ scheme is distinguished from other land use / land cover schemes by its focus on urban and rural landscape types, which can be described by any of the 17 classes in the LCZ scheme.</p><p>Out of the 17 LCZ classes, 10 reflect the 'built' environment, and each LCZ type is associated with generic numerical descriptions of key urban canopy parameters critical to model atmospheric responses to urbanisation. In addition, since LCZs were originally designed as a new framework for urban heat island studies (Stewart and Oke, 2012), they also contain a limited set (7) of 'natural' land-cover classes that can be used as 'control' or 'natural reference' areas. As these seven natural classes in the LCZ scheme can not capture the heterogeneity of the world’s existing natural ecosystems, we advise users - if required - to combine the built LCZ classes with any other land-cover product that provides a wider range of natural land-cover classes.</p><ul><li>Stewart ID, Oke TR. (2012). Local Climate Zones for Urban Temperature Studies. Bull Am Meteorol Soc. 93(12):1879-1900. doi:10.1175/BAMS-D-11-00019.1</li></ul><h2 id="versions">Versions</h2><p>If there are there multiple versions of the dataset, list the file updated, when and why update was made:</p><ul><li>_v1: initial release of the data (20220222)</li><li>_v2: add LCZ map of Iceland, consistent with the global LCZ map procedure (20221115)</li><li>_v3: Mosaicing two Global Forest Canopy Height products two cover remote areas (eg. islands) (20231008)</li></ul><h2 id="files-and-brief-description">Files and brief description</h2><p>Files and brief description:</p><ol type="1"><li><strong>lcz_filter_v3.tif</strong></li></ol><div class="note note-primary">            <p>The recommended global LCZ map, compressed as GeoTIFF, with LCZ classes indicated by numbers 1-17</p>          </div><p><strong>The recommended global LCZ map, compressed as GeoTIFF, with LCZ classes indicated by numbers 1-17</strong>. LCZ labels are obtained after applying the morphological Gaussian filter described in Demuzere et al. (2020). The official color scheme - as indicated in the table below - is embedded into the GeoTIFF.</p><figure><img src="https://i.imgur.com/pRByENm.jpeg" alt="Official class description" /><figcaption>Official class description</figcaption></figure><p>The table below describes,</p><table><thead><tr class="header"><th style="text-align: left;">LCZ class number</th><th style="text-align: center;">Official class description</th><th style="text-align: left;">Official hex color</th></tr></thead><tbody><tr class="odd"><td style="text-align: left;">LCZ 1</td><td style="text-align: center;">Compact highrise</td><td style="text-align: left;">'#910613'</td></tr><tr class="even"><td style="text-align: left;">LCZ 2</td><td style="text-align: center;">Compact midrise</td><td style="text-align: left;">'#D9081C'</td></tr><tr class="odd"><td style="text-align: left;">LCZ 3</td><td style="text-align: center;">Compact lowrise</td><td style="text-align: left;">'#FF0A22'</td></tr><tr class="even"><td style="text-align: left;">LCZ 4</td><td style="text-align: center;">Open highrise</td><td style="text-align: left;">'#C54F1E'</td></tr><tr class="odd"><td style="text-align: left;">LCZ 5</td><td style="text-align: center;">Open midrise</td><td style="text-align: left;">'#FF6628'</td></tr><tr class="even"><td style="text-align: left;">LCZ 6</td><td style="text-align: center;">Open lowrise</td><td style="text-align: left;">'#FF985E'</td></tr><tr class="odd"><td style="text-align: left;">LCZ 7</td><td style="text-align: center;">Lightweight low-rise</td><td style="text-align: left;">'#FDED3F'</td></tr><tr class="even"><td style="text-align: left;">LCZ 8</td><td style="text-align: center;">Large lowrise</td><td style="text-align: left;">'#BBBBBB'</td></tr><tr class="odd"><td style="text-align: left;">LCZ 9</td><td style="text-align: center;">Sparsely built</td><td style="text-align: left;">'#FFCBAB'</td></tr><tr class="even"><td style="text-align: left;">LCZ 10</td><td style="text-align: center;">Heavy Industry</td><td style="text-align: left;">'#565656'</td></tr><tr class="odd"><td style="text-align: left;">LCZ 11 (A)</td><td style="text-align: center;">Dense trees</td><td style="text-align: left;">'#006A18'</td></tr><tr class="even"><td style="text-align: left;">LCZ 12 (B)</td><td style="text-align: center;">Scattered trees</td><td style="text-align: left;">'#00A926'</td></tr><tr class="odd"><td style="text-align: left;">LCZ 13 (C)</td><td style="text-align: center;">Bush, scrub</td><td style="text-align: left;">'#628432'</td></tr><tr class="even"><td style="text-align: left;">LCZ 14 (D)</td><td style="text-align: center;">Low plants</td><td style="text-align: left;">'#B5DA7F'</td></tr><tr class="odd"><td style="text-align: left;">LCZ 15 (E)</td><td style="text-align: center;">Bare rock or paved</td><td style="text-align: left;">'#000000'</td></tr><tr class="even"><td style="text-align: left;">LCZ 16 (F)</td><td style="text-align: center;">Bare soil or sand</td><td style="text-align: left;">'#FCF7B1'</td></tr><tr class="odd"><td style="text-align: left;">LCZ 17 (G)</td><td style="text-align: center;">Water</td><td style="text-align: left;">'#656BFA'</td></tr></tbody></table><p>Other characteristics: - Projection: World Geodetic System 1984 (EPSG:4326) - Size: 389620, 155995 - Spatial Resolution: 0.000898° (~ 100 m) - Representative for the nominal year of 2018</p><ol type="1"><li>lcz_v3.tif</li></ol><p>Same as 1., but presenting the raw LCZ map, <strong>before applying the morphological Gaussian filter.</strong></p><ol start="3" type="1"><li>lcz_probability_v3.tif</li></ol><p>A probability layer (%) that identifies how often the modal LCZ was chosen per pixel (e.g. a probability of 60% means that the modal LCZ class was mapped 30 times out of 50 LCZ models). This is a pixel-based probability, derived from the lcz_v3.tif map.</p><h2 id="lczs-for-wrf">LCZs For WRF</h2><ul><li><a href="https://zenodo.org/records/7670792">Technical documentation for the hybrid 100-m global land cover dataset with Local Climate Zones for WRF</a><ul><li>Demuzere_etal_2023_TD_CGLC-MODIS-LCZ-dataset.pdf</li></ul></li><li>This technical documentation describes the development of a hybrid 100-m global land cover dataset and its implementation in the state-of-the-art Weather Research and Forecasting <strong>(WRF) model version 4.5</strong>.</li><li>This hybrid CGLC-MODIS-LCZ dataset is based on<ul><li><ol type="1"><li>the Copernicus Global Land Service Land Cover (CGLC) product resampled to MODIS IGBP classes (CGLC-MODIS), and</li></ol></li><li><ol start="2" type="1"><li>the global map of Local Climate Zones (LCZ) that describes the heterogeneous urban land surface. Both the CGLC and LCZ products are available at a 100-m spatial resolution, are representative for the year 2018, and cover -180°W to 180°E and -60°S to 78°N. Remaining areas are filled with the MODIS land cover classes.</li></ol></li></ul></li><li>This dataset has been implemented into the WRF Preprocessing System (WPS) as <a href="https://www2.mmm.ucar.edu/wrf/users/download/get_sources_wps_geog.html">tiled binary data files</a> with <a href="https://github.com/wrf-model/WPS/blob/develop/geogrid/GEOGRID.TBL.ARW_LCZ">a new GEOGRID table entry</a> to allow WRF/WPS users to flexibly use this dataset in their studies particularly relevant for urban modeling applications.</li></ul><p>在WRFv4.4.2之前，LCZ1-10在WRF-UCM土地利用类型中主要对应31-41，但是这种分类方法与NLCD，即美国国家土地覆盖数据集重复，因此WRFv4.4.2版本之后，LCZ1-10在WRF-UCM土地利用类型中主要对应51-61。</p><p><img src="https://i.imgur.com/lJsZzLv.png" width="500" /> <img src="https://i.imgur.com/rvG3Rgq.png" width="500" /> <img src="https://i.imgur.com/TteNH37.png" width="500" /></p><h3 id="issues">Issues</h3><div class="note note-primary">            <p>100m CGLC-MODIS keep their "natural CGLC-MODIS" category value.</p>          </div><ul><li>If MODIS is wrong ?<ul><li>like no Hong Kong International Airport (HKIA) 3rd runway</li></ul></li></ul><p><img src="https://i.imgur.com/Awi17Na.png" /></p><h1 id="convert-tif-to-netcdf">Convert tif to netcdf</h1><p>GDAL is a translator library for raster and vector geospatial data formats that is released under an MIT style Open Source License by the Open Source Geospatial Foundation</p><p>https://gdal.org/</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh">micromamba <span class="hljs-built_in">env</span> create -n gdal<br>micromamba install -c conda-forge gdal=3.6.1<br></code></pre></td></tr></table></figure><p>and then,</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs sh">whereis gdal_translate<br><br><span class="hljs-comment"># for checking</span><br>gdal_translate --long-usage<br><br>gdal_translate -of netCDF -co <span class="hljs-string">&quot;FOMRAT=NC4&quot;</span> lcz_filter_v3.tif lcz_filter_v3.nc <br></code></pre></td></tr></table></figure><p>The detail of file,</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs text">netcdf lcz_filter_v3 &#123;<br>dimensions:<br>lon = 389620 ;<br>lat = 155995 ;<br>variables:<br>char crs ;<br>crs:grid_mapping_name = &quot;latitude_longitude&quot; ;<br>crs:long_name = &quot;CRS definition&quot; ;<br>crs:longitude_of_prime_meridian = 0. ;<br>crs:semi_major_axis = 6378137. ;<br>crs:inverse_flattening = 298.257223563 ;<br>crs:spatial_ref = &quot;GEOGCS[\&quot;WGS 84\&quot;,DATUM[\&quot;WGS_1984\&quot;,SPHEROID[\&quot;WGS 84\&quot;,6378137,298.257223563,AUTHORITY[\&quot;EPSG\&quot;,\&quot;7030\&quot;]],AUTHORITY[\&quot;EPSG\&quot;,\&quot;6326\&quot;]],PRIMEM[\&quot;Greenwich\&quot;,0,AUTHORITY[\&quot;EPSG\&quot;,\&quot;8901\&quot;]],UNIT[\&quot;degree\&quot;,0.0174532925199433,AUTHORITY[\&quot;EPSG\&quot;,\&quot;9122\&quot;]],AXIS[\&quot;Latitude\&quot;,NORTH],AXIS[\&quot;Longitude\&quot;,EAST],AUTHORITY[\&quot;EPSG\&quot;,\&quot;4326\&quot;]]&quot; ;<br>crs:crs_wkt = &quot;GEOGCS[\&quot;WGS 84\&quot;,DATUM[\&quot;WGS_1984\&quot;,SPHEROID[\&quot;WGS 84\&quot;,6378137,298.257223563,AUTHORITY[\&quot;EPSG\&quot;,\&quot;7030\&quot;]],AUTHORITY[\&quot;EPSG\&quot;,\&quot;6326\&quot;]],PRIMEM[\&quot;Greenwich\&quot;,0,AUTHORITY[\&quot;EPSG\&quot;,\&quot;8901\&quot;]],UNIT[\&quot;degree\&quot;,0.0174532925199433,AUTHORITY[\&quot;EPSG\&quot;,\&quot;9122\&quot;]],AXIS[\&quot;Latitude\&quot;,NORTH],AXIS[\&quot;Longitude\&quot;,EAST],AUTHORITY[\&quot;EPSG\&quot;,\&quot;4326\&quot;]]&quot; ;<br>crs:GeoTransform = &quot;-170.0007776279147 0.000898315284119518 0 80.03809518448114 0 -0.000898315284119518 &quot; ;<br>double lat(lat) ;<br>lat:standard_name = &quot;latitude&quot; ;<br>lat:long_name = &quot;latitude&quot; ;<br>lat:units = &quot;degrees_north&quot; ;<br>double lon(lon) ;<br>lon:standard_name = &quot;longitude&quot; ;<br>lon:long_name = &quot;longitude&quot; ;<br>lon:units = &quot;degrees_east&quot; ;<br>byte Band1(lat, lon) ;<br>Band1:long_name = &quot;GDAL Band Number 1&quot; ;<br>Band1:_Unsigned = &quot;true&quot; ;<br>Band1:valid_range = 0s, 255s ;<br>Band1:_FillValue = 0b ;<br>Band1:grid_mapping = &quot;crs&quot; ;<br><br>// global attributes:<br>:GDAL_AREA_OR_POINT = &quot;Area&quot; ;<br>:Conventions = &quot;CF-1.5&quot; ;<br>:GDAL = &quot;GDAL 3.6.1, released 2022/12/14&quot; ;<br>:history = &quot;Mon Oct 07 12:05:03 2024: GDAL CreateCopy( lcz_filter_v3.nc, ... )&quot; ;<br>&#125;<br></code></pre></td></tr></table></figure><h1 id="some-regional-lcz-datasets">Some regional LCZ datasets</h1><p>Global tiff is large, and if we only consider a specific area like GBA/Tokyo/Houston.</p><p>Fast and easy Local Climate Zone mapping</p><p><a href="https://lcz-generator.rub.de/" class="uri">https://lcz-generator.rub.de/</a></p><ul><li>China, People's Republic of - Hong Kong-Macau-Guangdong Greater Bay Area:<ul><li><a href="https://lcz-generator.rub.de/factsheets/c672ca892c88d1e078a81e7a085913396172f81c/c672ca892c88d1e078a81e7a085913396172f81c_factsheet.html" class="uri">https://lcz-generator.rub.de/factsheets/c672ca892c88d1e078a81e7a085913396172f81c/c672ca892c88d1e078a81e7a085913396172f81c_factsheet.html</a></li></ul></li><li>Japan - Tokyo:<ul><li><a href="https://lcz-generator.rub.de/factsheets/67a3371158ad3ac12d720fde089622c259e8e400/67a3371158ad3ac12d720fde089622c259e8e400_factsheet.html" class="uri">https://lcz-generator.rub.de/factsheets/67a3371158ad3ac12d720fde089622c259e8e400/67a3371158ad3ac12d720fde089622c259e8e400_factsheet.html</a></li></ul></li><li>United States of America - Houston:<ul><li><a href="https://lcz-generator.rub.de/factsheets/037c80744fc1034b8472f594d829c53ce1cccfa7/037c80744fc1034b8472f594d829c53ce1cccfa7_factsheet.html" class="uri">https://lcz-generator.rub.de/factsheets/037c80744fc1034b8472f594d829c53ce1cccfa7/037c80744fc1034b8472f594d829c53ce1cccfa7_factsheet.html</a></li></ul></li></ul><p><img src="" /></p><div class="group-image-container"><div class="group-image-row"><div class="group-image-wrap"><img src="https://i.imgur.com/4pyAoGS.jpeg" alt="GBA" /></div></div><div class="group-image-row"><div class="group-image-wrap"><img src="https://i.imgur.com/rO8Cz9d.jpeg" alt="Tokyo" /></div><div class="group-image-wrap"><img src="https://i.imgur.com/b3plh7O.jpeg" alt="Houston" /></div></div></div><figure><img src="https://i.imgur.com/lGIE5ba.png" alt="ncview" /><figcaption>ncview</figcaption></figure><h1 id="w2w">W2W</h1><p>A python tool that ingests WUDAPT's Local Climate Zone information into WRF.</p><ul><li><a href="https://pypi.org/project/w2w/">w2w</a></li><li><a href="https://joss.theoj.org/papers/10.21105/joss.04432">W2W: A Python package that injects WUDAPT's Local Climate Zone information in WRF | Paper</a></li></ul><figure class="highlight console"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs console">pip install w2w<br></code></pre></td></tr></table></figure><p><img src="https://i.imgur.com/lugUZim.png" width="500" /></p><h1 id="soil-category">Soil category ?</h1><p>Do we have to modify corresponding soil category?</p><h1 id="references">References</h1><ol type="1"><li>Demuzere, M., Kittner, J., &amp; Bechtel, B. (2021). LCZ Generator: a web application to create Local Climate Zone maps. Frontiers in Environmental Science, 9, 637455.</li><li>Zhao, N., Ma, A., Zhong, Y., Zhao, J., &amp; Cao, L. (2019). Self-training classification framework with spatial-contextual information for local climate zones. Remote Sensing, 11(23), 2828.</li><li>杨俊, 任嘉义, 于文博. 局地气候分区视角下城市气候与人居环境研究进展. 生态学报, 2024, 44(11): 4489-4506.<ol type="1"><li>了解人居环境中的气候问题是主动改善和提升的首要条件。这在传统研究中已有大量成果, 如基于“城-郊”二元框架计算城市热岛强度并探讨城郊热力差异[4—6]；结合土地利用/土地覆被分析城市热力景观时空特征[7—9]；分析长时间序列下极端天气、热浪事件发生频率和持续时间[10—12]；探究空气污染与城市功能区的耦合关系[13—15]；以及定量评价气候变化导致的热风险和生态风险等[16—18]。研究普遍以城市行政边界或人口梯度为基准, 忽视了相似地理单元的空间特性。2012年Stewart和Oke提出将局地气候分区(Local Climate Zones, LCZ)作为城市气候研究的通用框架[19], 填补了传统气候分类在中/微观尺度研究中的局限, 得到广泛运用。</li><li>局地气候分区根据城市形态、地表覆盖、地表结构及材质等差异, 将城市下垫面划分为17个基本区域, 包括10个建筑类型和7个自然类型。每个LCZ都有特定范围的相关气候参数, 不同LCZ类型具有不同的局部气候条件(图 1)。LCZ分类体系提出用两个LCZ之间的温差定义并计算城市热岛强度[19—20], 克服了传统研究中城乡的刻板边界。同时建立了城市气候研究基础框架, 规范了全球城市气候研究范式。目前世界各地研究绘制了丰富的LCZ地图, 本研究将对往期文献中LCZ地图制作数据源、方法和已有LCZ数据集进行全面梳理。</li></ol></li><li>许亘昱, 石玉蓉, &amp; 张宇峰. (2023). 规划控制要素视角下城市热环境的测度与优化——以广州中心城区为例. 热带地理, 43(6), 1070-1082.<ol type="1"><li>城市下垫面类别和土地开发强度的多样性造成了城市内部热岛强度的差异。Stewart等（2012）在充分论证传统城郊二元法研究城市热岛问题的不足后，提出了局地气候分区（Local Climate Zone，下文简称LCZ）体系。LCZ将城市下垫面分为10种建成类型和7种自然类型（图4），以天空角系数、高宽比、建筑密度、不透水表面积占比、透水表面积占比、粗糙元高度、地形粗糙类型、热导纳、反射率和人为热等的区间为属性。LCZ用定量方法区分城市的土地构成，相较于传统规划领域方法—从土地利用功能角度出发的定性分类方法，其能更好地体现功能相同的土地利用类型在地块的建筑密度、容积率和绿地率等方面的差异，且具有分析比较的普适性（Bechtel et al., 2015），以LCZ为基础的城市热岛强度分类已通过经验和模型得到证实（Fenner et al., 2014; Stewart et al., 2014; Leconte et al., 2015）。</li></ol></li></ol>]]></content>
    
    
    <categories>
      
      <category>NWP</category>
      
    </categories>
    
    
    <tags>
      
      <tag>WRF</tag>
      
      <tag>MPAS</tag>
      
      <tag>Urban</tag>
      
      <tag>UCM</tag>
      
      <tag>LCZs</tag>
      
      <tag>UCPs</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Polar Vortex | 極地渦旋</title>
    <link href="/2024/10/04/Polar-Vortex/"/>
    <url>/2024/10/04/Polar-Vortex/</url>
    
    <content type="html"><![CDATA[<h1 id="極地渦旋">極地渦旋</h1><p>極地渦旋（Polar Vortex；或極地漩渦），是<strong>一種發生於極地的，介於對流層與平流層的中、上部的</strong>，持續性且大規模的氣旋。這種渦旋在冬季極夜的時候最為強大，因為此時的溫度梯度最大；隨後會持續縮減，到夏季極晝前後甚至會消失。</p><ul><li><strong>兩極對流層中層至平流層的低氣壓系統</strong></li></ul><table><thead><tr class="header"><th style="text-align: left;">典型的極地漩渦（2013年11月）</th><th style="text-align: left;">弱勢的極地漩渦（2014年1月5日）</th></tr></thead><tbody><tr class="odd"><td style="text-align: left;"><img src="https://upload.wikimedia.org/wikipedia/commons/thumb/7/76/November2013_polar_vortex_geopotentialheight_mean_Large.jpg/300px-November2013_polar_vortex_geopotentialheight_mean_Large.jpg" /></td><td style="text-align: left;"><img src="https://upload.wikimedia.org/wikipedia/commons/thumb/b/bb/Jan52014_polar_vortex_geopotentialheight_mean_Large.jpg/300px-Jan52014_polar_vortex_geopotentialheight_mean_Large.jpg" /></td></tr></tbody></table><p>極地渦旋（Polar Vortex）是長期存在於<strong>兩極對流層中層至平流層的低氣壓系統</strong>，一般分為數個中心，分佈於不同經度，每個系統直徑不超過1000公里。極地渦旋在冬季增強，在夏季減弱，當極地渦旋增強並向南擴展時，冷空氣便會迅速南下影響中緯度地區。</p><ul><li><strong>在極地渦旋南面是西風帶地區，兩者交界處常常出現高空急流（jet stream），風力特別強勁，風速往往達每小時200公里以上</strong>。</li><li>極地渦旋出現於北極地帶，它是一股股強風，<strong>位於大氣層高處，將極冷的空氣鎖在北極地區</strong>。</li><li>極地渦旋是<strong>空氣極冷的低壓帶，在北極地區上空旋轉</strong>。</li><li>高速氣流的擾動和較暖的空氣入侵，可能會打亂極地渦旋，將北極地區的空氣向南送至中緯度地區。</li></ul><p><img src="https://i.imgur.com/n2Z0yr3.jpeg" /></p><ul><li><strong>極地渦旋：距地表 16-48 公里</strong></li><li><strong>極地急流：距地表 8-15 公里</strong></li></ul><p><img src="https://i.imgur.com/LFYWREb.png" /></p><h2 id="原理">原理</h2><p>From <a href="http://www.metapp.org.tw/index.php/bossweathernews/293-test" class="uri">http://www.metapp.org.tw/index.php/bossweathernews/293-test</a>,</p><p>北極在冷季時，地表的長短波輻射損失的能量遠大於永夜所能吸收的太陽短波輻射，</p><ul><li>地表降溫，再由於混合、擴散使得其上的冷氣團向上發展，但由於空氣較冷、較重會使氣柱收縮，而在中高層大氣呈現凹陷，</li><li>它的特點是<strong>旋轉的冷空氣團可以從對流層中部延伸到平流層，通常在地表以上 10 至 50 公里</strong>（6 至 30 英里）的高度之間, (It is characterized by a rotating mass of cold air that can extend from the middle troposphere into the stratosphere, typically between altitudes of 10 to 50 kilometers (6 to 30 miles) above the surface)</li><li><strong>地面冷重的高氣壓</strong>即所謂「北極氣團」，而其<strong>中高層凹陷的相對低氣壓</strong>，</li></ul><p>近年來被冠以「北極渦旋」。所以它是地表熱力不平衡而被動產生。它是果不是因。</p><p>如果北極變冷，中緯度氣溫不變，兩者之間的溫度對比差異變大，西風的強度增強，即所謂的「噴射氣流」將圍繞北極渦旋(極區)旋轉，所謂「正相北極震盪」成型。此時冷氣團仍盤據在極區，中緯度未受其影響而偏暖。或有以冷氣團因「噴流鎖住」而無法南下，而造成中緯度偏暖來做詮釋，其謬誤處在於噴流是本是溫度對比而產生，且能量僅佔可用位能的一小部份，細繩如何綁住大象。</p><p><strong>輻射不平衡造成地表能量喪失的效應並不僅只在北極，高緯度大的陸塊如亞洲的西伯利亞、蒙古，北美大陸、北歐皆有同樣的效應，在低層大氣形成「極地大陸冷氣團」，在地面因冷重的大氣而呈現高氣壓，氣柱收縮中高層亦有「極地渦旋」伴隨</strong>。當北極氣團與極地大陸冷氣團同時存在或僅有極地大陸冷氣團，且有一定強度時，中高層也會同時有「渦旋」伴隨，西風噴流圍繞而行，呈現噴流減弱，南北風增加的現象，轉變成「負相北極震盪」。</p><p>當強冷氣團南移過程，通過的地區帶來寒流，但比較暖濕環境也使它減弱，最終冷氣團或渦旋都會減弱消失。但是高緯度的能量消失仍會持續進行，但是其後將轉變為正相還是維持負相則是不一定的，還是要看北極或極地冷氣團的發展情況而定，因果關係是很清楚的。本來原已存在的「氣團學說」再配合「大氣動力」的理論，對於冬季的天氣變化已有完整的詮釋，新創的名詞並無高明之處，徒增困擾而已。</p><h2 id="metoffice-what-is-the-polar-vortex"><a href="https://youtu.be/XGPLHwARPSY">Metoffice | What is the Polar Vortex?</a></h2><ul><li>The <strong>polar vortex is a circulation of winds high up in the stratosphere</strong>, up to <strong>30 miles (50 km) above the earth</strong>. It is present in winter, and is not a new phenomenon, scientists have known about it for many years.</li><li>The winds regularly <strong>exceed 155 miles per hour (250 km per hour)</strong> – the strength of the winds in the strongest hurricanes (known as Category 5).</li><li>A strong polar vortex favours a <strong>strong jet stream</strong>. The jet stream is a fast moving ribbon of air around <strong>5 to 7 miles (8 to 11km) above the earth</strong> that drives weather systems from the Atlantic towards the UK.</li></ul><iframe width="560" height="315" src="https://www.youtube.com/embed/XGPLHwARPSY?si=yd2MGyNa0GhkBkCs" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen></iframe><h1 id="北極濤動-arctic-oscillation-ao">北極濤動 Arctic Oscillation (AO)</h1><ul><li><a href="https://www.weather.gov.hk/tc/whatsnew/d4_whatsnew_20160226.htm">香港天文台 |『氣象冷知識』：北極濤動</a></li></ul><iframe width="560" height="315" src="https://www.youtube.com/embed/qQnb9LNs2GE?si=OO2XSn5VoD4Jmasm" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen></iframe><p><a href="https://www.weather.gov.hk/tc/climate_change/ao.htm">北極濤動（AO）</a> (又稱北極震盪) 是指北半球中緯度地區（約北緯45度）與北極地區氣壓形勢差別的變化。它是一個代表北極地區大氣環流的重要氣候指數，可分為正位相和負位相。</p><p>北極通常受低氣壓系統支配，而高氣壓系統則位於中緯度地區。</p><ul><li>當AO處於正位相時，<strong>這些系統的氣壓差較正常強</strong>，限制了極區冷空氣向南擴展；</li><li>當AO處於負位相時，<strong>這些系統的氣壓差較正常弱</strong>，冷空氣較易向南侵襲。</li></ul><p>有關北極濤動的最新情況可參考： - <a href="https://www.cpc.ncep.noaa.gov/products/precip/CWlink/daily_ao_index/ao.shtml" class="uri">https://www.cpc.ncep.noaa.gov/products/precip/CWlink/daily_ao_index/ao.shtml</a></p><figure><img src="https://www.cpc.ncep.noaa.gov/products/precip/CWlink/daily_ao_index/ao.gefs.fcst.png" alt="The daily AO index and its forecasts using GFS and Ensemble mean forecast data are shown for the previous 120 days as indicated. Each daily value has been standardized by the standard deviation of the monthly AO index from 1979-2000." /><figcaption>The daily AO index and its forecasts using GFS and Ensemble mean forecast data are shown for the previous 120 days as indicated. Each daily value has been standardized by the standard deviation of the monthly AO index from 1979-2000.</figcaption></figure><h1 id="分析和文獻綜述">分析和文獻綜述</h1><h2 id="香港天文台-2014年3月-北半球極地渦旋的扭曲"><a href="https://www.hko.gov.hk/tc/education/articles/ele_140304.htm">香港天文台 | 2014年3月 北半球極地渦旋的扭曲</a></h2><ul><li>在正常情況下，由於北半球冬天極地和中高緯度地區地面出現較大的溫差，<strong>地面氣溫緊密梯度促使高空急流的產生。急流由西向東環繞地球高速流動，而在北極附近受高空急流所包圍的渦旋通常被稱為極地渦旋</strong>。若急流的速度較高，急流會隨較平直的路徑流動(圖一)，地面上的冷空氣會集中在極地或較高緯度地區，較少機會南下。</li><li>但近年主要因為北極海冰融化，以致極地吸收更多太陽輻射，北極地區氣溫上升的速度較中高緯度的為高，這使地面氣溫梯度減弱，高空急流的流速亦較為減慢，其流動方向便變得彎彎曲曲(圖二)，隨之讓極地渦旋變得較為扭曲。這情況就如一道洶湧的河川流到平原地區時，河水流速減慢，河道便變得彎曲。高空急流迂迴的南北流動，使部分地區持續受冷空氣南下所影響，而另一些地區則受暖空氣北上而出現變暖現象，整體來說促使了地域上溫度的分佈趨向互異和極端。</li></ul><table><thead><tr class="header"><th style="text-align: left;">正常情況</th><th style="text-align: left;">極地渦旋變得較為扭曲</th></tr></thead><tbody><tr class="odd"><td style="text-align: left;"><img src="https://i.imgur.com/nHubAl9.png" /></td><td style="text-align: left;"><img src="https://i.imgur.com/jzQOoXg.png" /></td></tr></tbody></table><h2 id="澳門氣象學會-2022-12-11-什麼是極地渦旋"><a href="https://www.mmets.org/?p=1735">澳門氣象學會 | 2022-12-11 什麼是「極地渦旋」?</a></h2><p>冬季到來的時候，北極沒有太陽照射，變得越來越寒冷，冷空氣漸漸堆積並“逆時針”旋轉起來，稱為「極地渦旋」。</p><figure><img src="https://i.imgur.com/lyvOTHn.jpeg" alt="極地渦旋, 北極濤動" /><figcaption>極地渦旋, 北極濤動</figcaption></figure><ul><li>冬季因冷空氣較多，「極地渦旋」範圍比夏天大很多。它在極區對流層及平流層的中、上層形成一股很強的圍繞整個極區的環流，由於環流是自西向東旋轉，而且風速可達每小時 160 公里，一般稱之為西風噴流，能鎖住極地冷空氣，不讓冷空氣輕易跑到中、低緯度地區，這情況氣象學上稱為“正”北極濤動(上左圖)。</li><li>相反，“負”北極濤動則表示，極地渦旋偏弱，圍繞極區的西風噴流減慢，變得曲曲折折，無法鎖住冷空氣，大家可想像成冰箱門沒關好，極區冷空氣順勢而下，跑到中、低緯度地區(上右圖)。</li></ul><p>立即來個簡單實戰，這是 2022 年 12 月 15 日早上 8 時的ECMWF預報圖，<strong>等值線是500hPa重力位高度，因高空沒有地面的摩擦力，風幾乎平行等值線</strong>，因此大家見到曲曲折折的粗紅線，代表“負”北極濤動，西風噴流速度慢，北極大冰箱的門已經打門。至於冷空氣的流向，則可以看上圖的顏色(850 hPa 溫度)，藍、紫色代表非常寒冷的空氣，圖中所見，這次極地冷空氣主要流向了東亞及歐洲。</p><figure><img src="https://i.imgur.com/9S3O3ER.jpeg" alt="2022 年 12 月 15 日早上 8 時的ECMWF預報圖，等值線是500hPa重力位高度" /><figcaption>2022 年 12 月 15 日早上 8 時的ECMWF預報圖，等值線是500hPa重力位高度</figcaption></figure><h2 id="香港天文台-2014年1月29日-溫暖的北極寒冷的大陸"><a href="https://www.hko.gov.hk/tc/blog/00000155.htm">香港天文台 | 2014年1月29日 溫暖的北極．寒冷的大陸</a></h2><ul><li>氣候變暖使北極海冰和陸地雪蓋減少，降低了地球的反射率。本來海冰和雪蓋的反射率遠較海洋和陸地高，能有效地把太陽光反射回太空，但海冰和雪蓋減少會暴露更多的海洋和陸地表面，增加了地球吸收太陽熱量的能力，這些額外的熱力令海水及陸地進一步升溫而促使更多的海冰及雪蓋融化，形成惡性循環。</li><li><strong>北極地區變暖的速度也因此較北半球其它地方快，極地與熱帶地區之間的溫差減少，導致北半球高空西風氣流減慢，容易出現蜿蜒起伏的波動</strong>。</li><li>波動西側的偏北氣流把極地冷空氣往南輸送，東側的偏南氣流則把熱帶區域的暖空氣推向更北的地方。</li><li>高空西風氣流減慢也會容易引發大氣阻塞形勢，出現移動緩慢的反氣旋，天氣系統在時間和空間上的演變會變得停滯不前。視乎相對於阻塞形勢的位置而定，某些地方可能長時間天晴，但另一些地方則可能被困在風暴的走道軌跡上，經歷一段陰雨的日子。假如阻塞形勢發生在冬季，受影響地區的異常寒冷或溫暖天氣可能持續數天至數週。近年印象猶新的例子是 2008 年年初影響中國大部分地區的寒潮，當時在阻塞形勢的驅動下西伯利亞的冷空氣長時間不斷向南擴散至香港。</li></ul><h2 id="香港天文台-2019年2月27日-全球變暖下的極地渦旋"><a href="https://www.hko.gov.hk/tc/blog/00000219.htm">香港天文台 | 2019年2月27日 全球變暖下的「極地渦旋」</a></h2><ul><li>極地渦旋是大氣高層的緊密旋轉氣流，它把冷空氣限制在北極地區。假如極地渦旋偏弱，西風急流會減慢，容易出現較多波動，這有利北極氣團南侵並為中緯度地區帶來嚴寒天氣。</li><li>近期一項研究發現在全球變暖的背景下，過去四十年極地渦旋的偏弱狀態越趨持續。科學家認為由於北極海冰的縮減，暴露出來的海洋釋放更多熱量到大氣中，因而影響了大氣環流。透過「氣候—反射率」的回饋機制，北極海冰的縮減亦助長北極的暖化：較少海冰 -&gt; 較深色的海洋暴露出來 -&gt; 吸收更多太陽熱力 -&gt; 海冰進一步減少。</li><li>目前，北極的暖化速度是這連結會以新視窗打開。全球平均的兩倍。</li><li>這個暖化速度的差異使極區與赤道之間的溫差減少，繼而減弱了極地渦旋和西風急流，使西風急流較為波動，有利北極冷空氣南侵。</li></ul><h2 id="中国气象报社-2023年12月21日-全球变暖了为何秋冬冷空气还那么强"><a href="https://www.cma.gov.cn/2011xwzx/2011xqxxw/2011xqxyw/202312/t20231221_5965542.html">中国气象报社 | 2023年12月21日 全球变暖了，为何秋冬冷空气还那么强？</a></h2><p>不是說全球暖化了嗎？為什麼秋冬的冷空氣還那麼強？</p><p>這與極地渦旋（以下簡稱「極渦」）有關。赤道與極地之間存在著巨大溫差，這種差異促使極圈外圍形成了一圈強勁的西風，稱為西風急流。西風急流就像「圍欄」一樣，約束極地的冷空氣，穩定的極渦能夠被強大的西風急流限制在北極地區。在全球暖化背景下，北極地區增溫速度是全球的2—3倍。北極地區增溫，其與中低緯度間的氣溫差減弱，難以維持強大的西風急流，極渦內的冷空氣變得“躁動不安”，更容易分裂南下。北極來的冷空氣，其溫度遠低於人們所處的中低緯度地區，因此導致多次寒潮天氣。</p><p>此外，根據歷史資料統計分析，厄爾尼諾背景下我國冬季氣溫整體偏暖，但階段性冷空氣活動較為頻繁，也就是說冷暖起伏比較明顯。</p><p>但是，冷空氣過程強度不僅受厄爾尼諾影響，也與極渦的分裂和中高緯西風帶的擾動有很大關係。今年12月中旬以來，極渦分裂為雙中心，分別位於格陵蘭島和西伯利亞上空。伴隨著歐亞大陸上空西風帶的劇烈扭曲，西伯利亞高壓異常增強，我國大部地區由前期盛行偏南風轉為偏北風，冷空氣南下，導致氣溫驟降。</p><p>另一方面，厄爾尼諾激發的菲律賓異常反氣旋將熱帶水汽向我國陸地輸送，來自中高緯的寒潮過程配合來自低緯的豐沛水汽條件，引起了我國中東部較大範圍的降雪過程。此外，地面積雪造成的晴空反照率增加也使得後期回溫較慢。</p><h2 id="年2021年歐亞大陸寒潮"><a href="https://zh.wikipedia.org/wiki/2020%E5%B9%B4%E2%80%942021%E5%B9%B4%E6%AD%90%E4%BA%9E%E5%A4%A7%E9%99%B8%E5%AF%92%E6%BD%AE">2020年－2021年歐亞大陸寒潮</a></h2><p>中國氣象局解釋是因北極高空急流減弱，挾帶大量極地冷氣團的極地渦旋（Polar vortex）南下導致的。在全球變暖的背景下，極地漩渦等天氣系統不穩定，加劇了極端天氣的可能性，極地漩渦本來會將冷空氣鎖定於高緯度地區，由於北極氣溫上升，和高緯度及低緯度的溫差減少，讓極地漩渦的範圍出現改變，冷空氣也隨之南下，觸發嚴重寒潮。</p><p>大家都知道北極冷，它不僅是地球的冷極之一，也是大氣的冷源，那裡聚集了大量冷氣團，導致極地低空形成冷性高壓，高空則形成冷性低壓，這個極地高空的冷性大型渦旋系統，就是極地渦旋，它也是影響我國的冷空氣來源之一。</p><p>在冬季，當極地渦旋四周的高空急流實力強，極地渦旋就老實窩在北極地區上空逆時針轉圈圈，極地以外地區的寒潮、冷空氣就相對不會那麼活躍，那麼這一年就可能是暖冬了；當高空急流減弱，裹挾了大量極地冷氣團的極地渦旋就有了南下的機會，影響北半球的冷空氣就更為​​活躍。</p><p>之前的跨年寒潮和這次凍哭我們的寒潮，之所以這麼冷，一方面是因為兩次寒潮間隔時間不遠，前一波剛凍透了土地，還沒來得及回暖，後一波緊跟而至，基礎氣溫本就低，再降溫，就雪上加霜，冷上加冷了。</p><p>另一方面是因為它們實力強勁，這兩股寒潮都是極地渦旋的部分主體南下，路過西伯利亞地區這個冷空氣「加油站」積蓄了更多能量，讓冷氣團的氣溫更低，降溫能力更強。</p>]]></content>
    
    
    <categories>
      
      <category>Meteorology</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>Siberian high | 蒙古西伯利亞高壓</title>
    <link href="/2024/10/04/Siberian-high/"/>
    <url>/2024/10/04/Siberian-high/</url>
    
    <content type="html"><![CDATA[<h1 id="siberian-high-蒙古西伯利亞高壓">Siberian high | 蒙古西伯利亞高壓</h1><p><strong>西伯利亞高壓（Siberian High），又稱蒙古高壓、蒙古冷高壓、西伯利亞反氣旋 冷高壓（Siberian Anticyclone）</strong>，是一種位於歐亞大陸東北區域，發生在<strong>九月到次年四月的半永久性大陸反氣旋</strong>。在夏季，溫暖潮濕的氣流自太平洋流向西伯利亞。而在冬季則正好相反。這種變化是因為海洋和陸地的比熱熔差異，再加上歐亞大陸非常特殊的地理環境而造就的。<strong>從而在東亞和南亞地區形成了地球上範圍最大的季候風氣候。冬季在蒙古、西伯利亞一帶大範圍堆積形成冷高壓，其通常在一月份前後達到極盛</strong>。西伯利亞高壓是四個北半球主要的季節性大氣活動中心之一，勢力強盛可影響整個歐亞大陸，成為北半球覆蓋面積最廣的高壓。</p><ul><li>位於蒙古境內，氣壓值：1036hPa ~ 1050hPa，最強時可達1075hPa</li></ul><figure><img src="https://i.imgur.com/FG2FYYk.png" alt="西伯利亞高壓、蒙古冷高壓" /><figcaption>西伯利亞高壓、蒙古冷高壓</figcaption></figure><ul><li>北半球冬季時，歐亞大陸由於降溫快，在俄羅斯西伯利亞與蒙古一帶形成的高壓帶。</li><li>此高壓帶由於溫度低，又被稱為冷高壓。</li><li>隨著空氣由西伯利亞高氣壓流向海上低氣壓，形成亞洲的冬季季風。</li></ul><figure><img src="https://i.imgur.com/8jGvBCC.jpeg" alt="西伯利亞高壓示意圖、蒙古冷高壓示意圖" /><figcaption>西伯利亞高壓示意圖、蒙古冷高壓示意圖</figcaption></figure><h2 id="亚欧大陆冬季冷空气的策源地">亚欧大陆冬季冷空气的策源地？</h2><ul><li><a href="https://mp.weixin.qq.com/s/QEm7hwk_BACqcOQLx5t5lQ">蒙古和西伯利亚地区，为什么会成为亚欧大陆冬季冷空气的策源地？</a></li></ul><p>氣候可分為許多要素，常見的氣候要素包括氣溫、降水、光照等內容。就氣溫要素而言，世界各地冷熱不同，氣溫的分佈有很大的差異。影響氣溫的因素很多，包括緯度位置、海陸位置、地形海拔、大氣環流、洋流因素、下墊面因素以及人類活動因素等，其中緯度因素是影響氣溫最重要的因素。</p><p><strong>隨著緯度的增加，年平均正午太陽高度角就不斷降低，獲得太陽輻射的能量就減少，全球氣溫整體由赤道往兩極地區遞減</strong>。</p><figure><img src="https://i.imgur.com/us3UXq1.png" alt="隨著緯度的增加，年平均正午太陽高度角就不斷降低，獲得太陽輻射的能量就減少，全球氣溫整體由赤道往兩極地區遞減" /><figcaption>隨著緯度的增加，年平均正午太陽高度角就不斷降低，獲得太陽輻射的能量就減少，全球氣溫整體由赤道往兩極地區遞減</figcaption></figure><p>不過，在北半球最冷的地點並不在緯度最高的北極點，而是在西伯利亞東部的奧伊米亞康，極端最低氣溫達到-71.2℃，被稱為北半球「寒極」。此外，蒙古和西伯利亞地區，也被稱為亞歐大陸冬季冷空氣的策源地，這是為什麼？</p><ul><li>海陸的比熱差異</li></ul><p>我們知道，影響氣溫高低的因素很多，而緯度只是其中的一個因素，北極雖然地處高緯度地區，但是這一區域並不是陸地，而是分佈著北冰洋。在夏季季節，海水能夠儲存較多的熱量，從而到了冬季季節降溫就較慢，這就是由於海陸的比熱差異而產生的。反觀世界上最大的大陸亞歐大陸，由於是陸地比熱較小，夏季升溫快，同樣的冬季時降溫也快。</p><p>因此，到了冬季季節，亞歐大陸內部的氣溫明顯比同緯度的太平洋和大西洋地區低。除了比熱對氣溫的影響之外，地形海拔也起到了一定的影響作用，在對流層大氣中，海拔越高氣溫越低，大約海拔每升高1000米，氣溫就會下降大約6℃，而蒙古和西伯利亞地區的地形單元主要為蒙古高原、中西伯利亞高原和東西伯利亞山地，這些地區海拔相對較高，從而更降低了這一地區的氣溫。亞歐大陸內部大範圍的低溫區域，使得這一地區形成了一個範圍十分巨大的“冷高壓”，也被稱為“亞洲高壓”。</p><p>由於其中心主要位於蒙古和西伯利亞地區，所以也常被稱為“蒙古西伯利亞高壓”，<strong>由於這個高壓的存在，就把副極地低氣壓帶給切斷了，使之只保留在海洋上，位於太平洋上的稱為“阿留申低壓”，而位於大西洋上的稱為“冰島低壓”</strong>。亞洲高壓屬於典型的“極地大陸氣團”，其勢力十分巨大，可以影響到幾乎整個亞歐大陸。我們知道水平方向的空氣始終遵循從高壓流向低壓，因此在冬半年，<strong>近地面空氣就會從氣壓最高的蒙古西伯利亞高壓向四周流出。</strong></p><p>由於該區域往北是北冰洋，冬季氣溫也非常低，兩地間的氣壓差較小，因此往北的氣流並不十分明顯。同時，由於蒙古西伯利亞地區所在的緯度，主要受盛行西風帶控制，所以往西流出的氣流也不十分強大。而從蒙古西伯利亞高壓往東和往南流出的氣流則十分強勁，在地轉偏向力的影響下，在東亞地區形成了西北季風，在南亞和東南亞地區形成了東北季風。而來自蒙古西伯利亞高壓的西北季風就是影響我國冬半年大幅降溫的主要因素，也就是我們熟稱的「冷空氣」。</p><figure><img src="https://i.imgur.com/NxUfgIP.jpeg" alt="一月份海平面等壓線分佈圖" /><figcaption>一月份海平面等壓線分佈圖</figcaption></figure><h1 id="分析和文獻綜述">分析和文獻綜述</h1><h2 id="年1月東亞冷冬的綜觀天氣分析預報"><a href="https://www.science.ntu.edu.tw/fiveyears/newsletter35/Atmos-Yang.php?NumId=354">2018年1月東亞冷冬的綜觀天氣分析預報</a></h2><p>北半球在冬季時，由於陸地與海洋的比熱差異使得陸地上常形成性質較乾冷的大陸型冷高壓型態的氣團。對於東亞地區冬季氣候平均地面天氣型態而言，大陸型冷高壓的中心位置經常位於蒙古或西伯利亞地區，因此被稱之為蒙古高壓或西伯利亞高壓。在氣象分析上<strong>常以1020百帕(hPa)等壓線來界定蒙古高壓的氣團涵蓋範圍</strong>。</p><p>台灣冬季的寒流跟蒙古高壓的強度消長有很大的關係，但實際上影響台灣地區的冷空氣並不是蒙古高壓直接壟罩台灣，而是由蒙古高壓所分離出來的分裂高壓所造成的。我們可以想像成沙丘堆累積到一定的高度會崩落一小部分，在周圍形成小沙丘，而這個周圍的小沙丘就類似分裂高壓。乾冷的分裂高壓自蒙古往東南方向移動，當它分裂高壓的位置越靠近台灣，表示台灣受到冷高壓的影響就越顯著，氣溫通常也會降得更低。當分裂高壓與南方空氣相會時，南方潮濕的空氣遇上乾冷的分裂高壓抬升造成水氣凝結，經常導致台灣東北部降水甚至山區降雪的現象；反之，若南方水氣供應較不充足的情況下，台灣就處於較乾冷的天氣。</p><ul><li>地面天氣分析圖</li></ul><p>圖1: (a)韓國氣象廳(KMA) 2018年2月1日 0000UTC和 (b) 2018年2月3日 1200UTC 的地面天氣分析圖。</p><table><thead><tr class="header"><th style="text-align: left;">2018年2月1日 0000UTC</th><th style="text-align: left;">2018年2月3日 1200UTC</th></tr></thead><tbody><tr class="odd"><td style="text-align: left;"><img src="https://www.science.ntu.edu.tw/fiveyears/newsletter35/Images/1a.png" alt="1a" /></td><td style="text-align: left;"><img src="https://www.science.ntu.edu.tw/fiveyears/newsletter35/Images/1b.png" alt="1b" /></td></tr></tbody></table><p>除了地面天氣圖之外，氣象學家也會分析中高層等壓面上的高空天氣圖(如圖2)。等壓面上可以看到像波動般彎曲的等高線(見圖2的黑色實線)，<strong>由於高空風不受摩擦力的影響，所以高空風平行等高線吹拂</strong>。在高空天氣圖顯示中緯度地區等高線會在不同緯度間南北擺盪，這種波動現象稱之為「西風波」。以北半球的大氣環流而言，西風波高度場較高的波峰處稱作「脊」，高度場較低的波谷處稱作「槽」。槽前不穩定的大氣環境將會帶動地面的溫帶氣旋移動，槽後穩定的大氣環境則可以帶動地面的高壓氣團移動。因此在中緯度地區地面天氣圖中分裂高壓的移動，主要受到高空西風波動的牽引，因此高空西風帶中槽脊線的位置和移動對於台灣冬季的綜觀尺度(Synoptic Scale)天氣預報有著顯著的影響。2018年一月底至二月中旬一波接著一波不停歇的低溫寒流，<strong>與北太平洋白令海高空出現阻塞高壓有關(圖2)。這段期間西風偏弱，使得阻塞高壓和其西方的槽線系統移動減慢，槽後的地面高壓氣團及其挾帶的冷空氣便往低緯度地區移動，造成這次臺灣將近兩星期長時間的寒流現象。</strong></p><ul><li>500hPa 之高度(黑色實線)及溫度(紅色虛線)分析圖</li></ul><p>圖2: (a)韓國氣象廳(KMA) 2018年2月1日 0000UTC和 (b) 2018年2月3日 1200UTC 500hPa 之高度(黑色實線)及溫度(紅色虛線)分析圖，阻塞高壓位在白令海北邊。</p><table><thead><tr class="header"><th style="text-align: left;">2018年2月1日 0000UTC</th><th style="text-align: left;">2018年2月3日 1200UTC</th></tr></thead><tbody><tr class="odd"><td style="text-align: left;"><img src="https://www.science.ntu.edu.tw/fiveyears/newsletter35/Images/2a.png" alt="1a" /></td><td style="text-align: left;"><img src="https://www.science.ntu.edu.tw/fiveyears/newsletter35/Images/2b.png" alt="1b" /></td></tr></tbody></table><h2 id="秋-冬转换时期西伯利亚高压建立气候态和年际变化机理研究"><a href="https://iap.cas.cn/gb/xwdt/kyjz/202407/t20240709_7214328.html">2024 | 秋-冬转换时期西伯利亚高压建立气候态和年际变化机理研究</a></h2><p>东亚冬季风是全球最强的冬季风，也是北半球冬季北极冷空气向南运输的最主要通道。我国地处东亚季风区，显著地受到东亚冬季风的影响。西伯利亚高压是东亚冬季风环流系统的重要成员，探究西伯利亚高压对理解东亚冬季风和我国冬季天气气候至关重要。</p><p>西伯利亚高压又称“蒙古高压”，是北半球冬季位于欧亚大陆上的半永久性高压中心。存在显著的年循环特征：在秋季建立，冬季盛行（图1）。目前，较多的研究集中于分析西伯利亚高压在冬季盛期的变化，较少关注其在秋季的建立；而探究西伯利亚高压的建立对于理解东亚冬季风环流的建立和我国冬季次季节时间尺度的预报具有重要意义。</p><p>1. 客观定义“秋-冬转换时期西伯利亚高压建立”</p><figure><img src="https://iap.cas.cn/gb/xwdt/kyjz/202407/W020240709346896451892_ORIGIN.jpg" alt="欧亚大陆气候态海平面气压的逐月演变。" /><figcaption>欧亚大陆气候态海平面气压的逐月演变。</figcaption></figure><p>2. 西伯利亚高压建立的气候态特征和机理分析</p><figure><img src="https://iap.cas.cn/gb/xwdt/kyjz/202407/W020240709346896802817_ORIGIN.png" alt="西伯利亚高压建立气候态的热动力特征和机理示意图" /><figcaption>西伯利亚高压建立气候态的热动力特征和机理示意图</figcaption></figure><p>3. 西伯利亚高压建立年际变化的机理分析</p><figure><img src="https://iap.cas.cn/gb/xwdt/kyjz/202407/W020240709346897199095_ORIGIN.jpg" alt="西伯利亚高压建立偏早年的环流特征和机理示意图（偏晚年相反" /><figcaption>西伯利亚高压建立偏早年的环流特征和机理示意图（偏晚年相反</figcaption></figure><h1 id="references">References</h1><ol type="1"><li>侯亚红,杨修群,李刚.冬季西伯利亚高压变化特征及其与中国气温的关系[J].气象科技,2007,35(5):646~650</li><li><a href="https://www.cwa.gov.tw/Data/climate/Knowledge/pdf/201101-1.pdf">中央氣象局 | 2011-01 寒流與凍雨</a></li></ol>]]></content>
    
    
    <categories>
      
      <category>Meteorology</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>Subtropical high | 副熱帶高壓</title>
    <link href="/2024/10/03/Subtropical-high/"/>
    <url>/2024/10/03/Subtropical-high/</url>
    
    <content type="html"><![CDATA[<h1 id="副熱帶高壓">副熱帶高壓</h1><p>亞熱帶高壓（Subtropical high，又稱亞熱帶高氣壓、副熱帶高壓、副熱帶高氣壓），<strong>其脊線稱為副熱帶高壓脊</strong>，氣象學名詞，是指活躍於亞熱帶地區的高壓脊，分佈於南北緯30°左右，是一股經常存在但位置不固定的溫暖氣團。它的位置以及內裏氣流的流向可以影響到熱帶氣旋的生成和走向。</p><p>為動力成因，地球在赤道附近接收的熱輻射最大，導致出現沿熱帶輻合帶的大量對流。這裏的氣團上升然後發散，受地轉偏向力影響，分別向北和南兩個方向遠離赤道。隨着空氣向赤道兩側的中緯度地區移動，它會冷卻下沉並形成下沉氣流。這在兩個半球的30度平行線附近產生了一個高壓脊。下沉的空氣再次發散，一些空氣返回赤道，形成了<strong>哈德來環流(Hadley cell)</strong>。</p><p><strong>太陽輻射和地轉偏向力是最主要的原因。</strong>赤道地區的太陽輻射比較強烈，該區的空氣會上升，到了高空後就會向極地方向流動。而地轉偏向力使得氣流不斷發生偏移，隨著緯度的升高，地轉偏向力就越大，致使在副熱帶地區（北緯30度附近），氣流基本變成了自西向東流動，並對後續空氣進行阻礙。這一阻礙使得其他上空空氣聚集並且被迫下沉，於是便產生了副熱帶高壓。</p><p><strong>西北太平洋副高是常年存在的永久性暖性深厚系統（它從低到高都是高壓，因而氣象上稱之為深厚系統）</strong>，其強度和位置隨著季節產生變化。由於副高本身是個暖性高壓，加上其盛行的下沉氣流增溫效應，<strong>中心地帶（稱為脊線）</strong> 天氣基本格調是晴熱乾燥的，因此副高所在位置的天氣高溫少雨，如果副高穩定控制一個地區，這裏就非常容易出現乾旱和高溫天氣。</p><figure><img src="https://upload.wikimedia.org/wikipedia/commons/2/21/%E5%A4%A7%E6%B0%A3%E7%92%B0%E6%B5%81.png" alt="哈德來環流(Hadley cell)" /><figcaption>哈德來環流(Hadley cell)</figcaption></figure><p>副熱帶高壓影響下的氣候一般是高溫，且層結穩定，對流很不旺盛，所以降水較少。副熱帶高壓的西部層結較為不穩定，東部相對穩定。所以副熱帶高壓西部降水稍多，東部降水比較少。由於太陽輻射和地球自轉產生的地轉偏向力，南、北半球的副熱帶地區均存在一條高壓帶。又因為海陸分佈的影響，高壓帶分裂成若干高壓單體。</p><p>說到副熱帶高壓，有一個概念不得不提──那就是588線。實際預報業務中表徵副高活動的方法主要有兩種，一種是副高的脊線（副高內部東西風的分界線），而500hPa等壓面上588位勢什米這條等高線卻是預報員最常用、最關注的一條線，因為它雖然看不見、摸不著，卻能表徵副高的強度和位置變化，對我國的天氣影響巨大。</p><p>588線是預報員在高空500百帕等壓面上（約5500公尺高空）繪製的一條等位勢高度線。這條等值線圍起來的區域就是預報員常常提到的氣象名詞「副熱帶高壓」。它向西向北擴展，代表副高向西向北推移，它包含的範圍擴大時，表示副高強度增強等等。</p><h2 id="副高脊線控制">副高脊線控制</h2><p>在副高脊線控制的地區，往往以晴朗少雲的高溫天氣為主，如果副高強盛，則該地區還會出現乾旱災害。</p><ul><li>副高脊線的北側與西風帶鋒區相鄰，西風帶系統攜帶的冷空氣，與副高外圍引導輸送的水汽匯合，容易產生氣旋和鋒面活動，從而形成強降水。</li><li>副高脊線南側為東風氣流，沒有氣旋發展時，天氣晴好，但當有東風波和颱風等熱帶天氣系統活動時，則會出現雷暴大風、強降水等惡劣天氣。</li></ul><figure><img src="https://i.imgur.com/WA9G4fo.png" alt="副高脊線的南北側" /><figcaption>副高脊線的南北側</figcaption></figure><figure><img src="https://i.imgur.com/qso2WKa.png" alt="副高脊線" /><figcaption>副高脊線</figcaption></figure><ul><li><a href="https://www.hko.gov.hk/tc/whatsnew/d4_whatsnew_20160701.htm">香港天文台 |『氣象冷知識』：副熱帶高壓脊</a></li><li><a href="https://www.cwa.gov.tw/V8/C/C/Taiwan/taiwan_5_3.html">中華民國交通部中央氣象署 | 太平洋高壓</a><ul><li>比較近幾十年太平洋高壓於夏季(6月至8月)的強度變化(如圖)，可發現早期在1950至1970年代最西只到達東經135度左右，但近年來太平洋高壓有越來越往西延伸的趨勢，西伸的位置已覆蓋至臺灣上空，近10年西伸位置甚至接近中國華南，副高強度增強使得近年來夏季平均溫度偏高，極端高溫日數也有偏多的趨勢。</li></ul></li></ul><figure><img src="https://www.cwa.gov.tw/V8/C/K/Encyclopedia/climate/imgs/pacific_5_3_2.png" alt="夏季500百帕重力位高度場5870線的平均位置(代表太平洋高壓勢力範圍)，不同的數字代表不同的年代(10年)平均" /><figcaption>夏季500百帕重力位高度場5870線的平均位置(代表太平洋高壓勢力範圍)，不同的數字代表不同的年代(10年)平均</figcaption></figure><h1 id="颱風-熱帶氣旋-副熱帶高壓">颱風 熱帶氣旋 副熱帶高壓</h1><p>副高也是引導熱帶氣旋移動的主要天氣系統之一</p><ul><li><a href="https://www.hko.gov.hk/tc/%E5%A4%A9%E6%96%87%E5%8F%B0%E7%B6%B2%E8%AA%8C/106962/%E5%90%91%E6%9D%B1%E8%B5%B0%E7%9A%84%E3%80%8C%E7%9B%A7%E7%A2%A7%E3%80%8D">香港天文台 | 2022年5月11日 向東走的「盧碧」</a></li></ul><h1 id="中國降水帶的南北移動與副高的季節活動密切相關">中國降水帶的南北移動與副高的季節活動密切相關</h1><p>中國降水帶的南北移動與副高的季節活動密切相關：從每年3、4月份開始，我國陸續出現華南前汛期（4月至6月）、江南-長江中下游-江淮梅雨季節（6月至7月）、華北東北雨季（7月至8月）等</p><p>忙碌了整個夏季後，副高通常會在9月啟程回到西北太平洋養精蓄銳，等待來年再「衝業績」。但退場時，副高還會在南方地區停留，帶來「秋老虎」高溫天氣；此時副高位置偏西，冷暖空氣交彙的主戰場轉移到了華西地區，拉開了「華西秋雨」大幕。</p><p>在這幾個月裡，副高聯手夏季風為我國大部帶來豐沛的雨水、充足的陽光和適宜的氣溫，人們應季而作、應季而收，用勤勞和智慧打造了魚米之鄉、中原糧倉、北大倉… <img src="https://i.imgur.com/EexaFHc.gif" alt="中國降水帶的南北移動與副高的季節活動密切相關" /></p><figure><img src="https://i.imgur.com/stm6qRa.jpeg" alt="中國降水帶的南北移動與副高的季節活動密切相關" /><figcaption>中國降水帶的南北移動與副高的季節活動密切相關</figcaption></figure><p>捉摸不透的雨帶</p><p>副高西北側盛行偏南和西南暖濕氣流，是低層暖濕空氣輻合上升運動區，容易出現雷陣雨天氣，尤其北側是西風帶，經常帶來北方較冷的空氣，與暖空氣結合更容易形成激烈的天氣。</p><p>西北太平洋副高的強弱及位置，與我國中東部地區的天氣氣候以及旱澇等關係極其密切，決定了我國中東部地區的雨帶分佈。</p><figure><img src="https://i.imgur.com/wdGlty9.jpeg" alt="捉摸不透的雨帶" /><figcaption>捉摸不透的雨帶</figcaption></figure><h1 id="酷熱-降雨案例">酷熱, 降雨案例</h1><ul><li><a href="https://www.hko.gov.hk/tc/%E5%A4%A9%E6%B0%A3%E9%9A%A8%E7%AD%86/108835/%E3%80%8C%E7%86%B1%E3%80%8D%E9%AC%A7%E7%9A%84%E5%8D%97%E6%B5%B7">香港天文台 | 2024年7月11日「熱」鬧的南海</a><ul><li>受副熱帶高壓脊影響，過去一兩星期本港天氣持續酷熱，天文台在7月1日發出酷熱天氣警告至今已生效超過10日。最新預報顯示，副熱帶高壓脊南側的廣闊低壓槽在週末及下週將逐漸變得活躍，而低壓槽上亦可能有低壓區形成，甚至發展為熱帶氣旋。</li><li>(上) 衛星圖像可見南海中南部及菲律賓以東海域有兩組較明顯的對流雲團；</li><li>(下) 副熱帶高壓脊會在下週初向西伸展。</li></ul></li></ul><figure><img src="https://www.hko.gov.hk/tc/forecaster_blog/images/potentail_TC_pic1_v2.png" alt="(上) 衛星圖像可見南海中南部及菲律賓以東海域有兩組較明顯的對流雲團； (下) 副熱帶高壓脊會在下週初向西伸展。" /><figcaption>(上) 衛星圖像可見南海中南部及菲律賓以東海域有兩組較明顯的對流雲團； (下) 副熱帶高壓脊會在下週初向西伸展。</figcaption></figure><ul><li><a href="https://news.dayoo.com/society/202407/08/140000_54686673.htm">中国天气网 | 2024-07-08 副热带高压位置移动，全国天气将有这些变化</a><ul><li>今天（8日），冷、暖气流在四川盆地交汇形成了西南涡、在河南至苏皖北部的交汇形成了切变线。因此这一线还是强降雨重心，并且多伴随雷暴大风等强对流天气。</li></ul></li></ul><figure><img src="https://i.imgur.com/QYigRdk.jpeg" alt="2024-07-08 强降雨" /><figcaption>2024-07-08 强降雨</figcaption></figure><figure><img src="https://dayooimg.dayoo.com/Society/202407/08/54686673_bc0b3f49-404f-4fa6-b8b3-f7747104a1ae.gif" alt="2024-07-08 强降雨 FY-4B" /><figcaption>2024-07-08 强降雨 FY-4B</figcaption></figure><ul><li><a href="https://news.weather.com.cn/2024/06/3787477.shtml">中国天气网 | 2024-06-20 “教科书”级的梅雨形势即将出现，新一轮暴雨大暴雨最猛烈时段来了</a><ul><li>今年的梅雨开场即不同凡响。昨天，安徽芜湖、铜陵、宣城、黄山，浙江杭州、嘉兴，江西上饶、宜春，湖南长沙、常德、怀化等地局地均出现大暴雨（100～265毫米）。</li><li>今天夜间开始，随着北方冷涡引导冷空气南下与暖湿气流结合，同时副热带高压西伸北抬，低层急流加强催生出低涡并东移，将在贵州至江汉江淮一带激发出一条呈东北-西南走向的猛烈暴雨大暴雨区域。</li><li>这就是最典型的梅雨形势，接下来几天的情况跟它高度贴合，不过副高位置更偏北，强降雨集中区域也更为集中在江淮、江汉一带。</li></ul></li></ul><figure><img src="https://i.imgur.com/rTf08YT.jpeg" alt="2024-06-20 典型的梅雨形势" /><figcaption>2024-06-20 典型的梅雨形势</figcaption></figure><h1 id="沙漠-和火爐">沙漠 和「火爐」</h1><p>熱帶沙漠氣候：副熱帶高壓常年控制此地區，故其氣候終年高溫乾燥。</p><p>每年平均降雨量低於兩百五十公釐的地區就稱為沙漠，在沙漠裡最缺乏食物和水。大部分的沙漠分佈再南北韓十五度到三十五度間，在這緯度間為『副熱帶高壓帶』，由赤道上升向南北流動的空氣在緯度三十度左右下降，愈降愈轉暖，下降的暖空氣吸收濕氣，使地面乾燥，晴朗無雲加上炎陽高照，這一帶內的背風地區便成為沙漠。</p><figure><img src="https://i.imgur.com/YsjNaIl.jpeg" alt="我國的幾大沙漠和夏季傳統的四大「火爐」圖片來源：中國國家地理" /><figcaption>我國的幾大沙漠和夏季傳統的四大「火爐」圖片來源：中國國家地理</figcaption></figure><figure><img src="https://www.chiding.com.tw/upload/users/image/%E7%86%B1%E5%B8%B6%E3%80%81%E6%BA%AB%E5%B8%B6%E6%B2%99%E6%BC%A0%E5%88%86%E5%B8%83%E5%9C%96.jpg" alt="熱帶沙漠跟溫帶沙漠差在哪裡呢？ 圖片來源：奇鼎事業" /><figcaption>熱帶沙漠跟溫帶沙漠差在哪裡呢？ 圖片來源：奇鼎事業</figcaption></figure><h1 id="references">References</h1><ol type="1"><li><a href="http://tsw.hhups.tp.edu.tw/jyfen/ecology/209.htm">仙人掌的家--沙漠</a></li></ol>]]></content>
    
    
    <categories>
      
      <category>Meteorology</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>Google Map</title>
    <link href="/2024/10/02/google-map/"/>
    <url>/2024/10/02/google-map/</url>
    
    <content type="html"><![CDATA[<h1 id="embed-google-maps">Embed Google Maps</h1><p>Easily embed and customize Google Maps on your web page or blog by setting the Google.</p><p>To use the Maps Embed API on your web page, set the URL you've built as the value of an iframe's src attribute. Control the map's size with the iframe's height and width attributes, for example:</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">iframe</span></span><br><span class="hljs-tag">  <span class="hljs-attr">width</span>=<span class="hljs-string">&quot;640&quot;</span></span><br><span class="hljs-tag">  <span class="hljs-attr">height</span>=<span class="hljs-string">&quot;480&quot;</span></span><br><span class="hljs-tag">  <span class="hljs-attr">frameborder</span>=<span class="hljs-string">&quot;0&quot;</span> <span class="hljs-attr">style</span>=<span class="hljs-string">&quot;border:0&quot;</span></span><br><span class="hljs-tag">  <span class="hljs-attr">referrerpolicy</span>=<span class="hljs-string">&quot;no-referrer-when-downgrade&quot;</span></span><br><span class="hljs-tag">  <span class="hljs-attr">src</span>=<span class="hljs-string">&quot;https://www.google.com/maps/d/embed?mid=1Dmw1V2OwTV5C7KWjAhHR5bEZugqMnCA&amp;ehbc=2E312F&quot;</span></span><br><span class="hljs-tag">  <span class="hljs-attr">allowfullscreen</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">iframe</span>&gt;</span><br></code></pre></td></tr></table></figure><iframe width="640" height="480" frameborder="0" style="border:0" referrerpolicy="no-referrer-when-downgrade" src="https://www.google.com/maps/d/embed?mid=1Dmw1V2OwTV5C7KWjAhHR5bEZugqMnCA&amp;ehbc=2E312F" allowfullscreen></iframe><h1 id="references">References</h1><ol type="1"><li><a href="https://developers.google.com/maps/documentation/embed/embedding-map">Embedding Map</a></li><li><a href="https://www.tsg.com.tw/blog-detail2-173-0-google-maps.htm">Google Map如何嵌入網頁？地圖、路線地圖嵌入教學｜天矽科技客製化網頁設計</a></li></ol>]]></content>
    
    
    <categories>
      
      <category>NWP</category>
      
    </categories>
    
    
    <tags>
      
      <tag>NWP</tag>
      
      <tag>WRF</tag>
      
      <tag>MPAS</tag>
      
      <tag>Google</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>WMO Information System 2.0 (WIS 2.0)</title>
    <link href="/2024/10/02/WISv2-WMO/"/>
    <url>/2024/10/02/WISv2-WMO/</url>
    
    <content type="html"><![CDATA[<h1 id="wis-2.0---world-meteorological-organization-wmo">WIS 2.0 - World Meteorological Organization WMO</h1><ul><li><a href="https://community.wmo.int/en/activity-areas/wis/WIS2-overview">WMO | WIS2 Overview</a> (<strong>Recommendation</strong>)</li><li><a href="https://community.wmo.int/en/activity-areas/wis">WMO | WMO Information System (WIS) v2</a></li><li><a href="https://community.wmo.int/en/activity-areas/wis/wis2-implementation">WMO | wis2 implementation</a></li><li><a href="https://community.wmo.int/en/activity-areas/wis/wis2-demonstration-projects">WMO | WIS 2.0 Demonstration Projects</a></li><li><a href="https://www.wis-jma.go.jp/cms/gisc_tokyo/workshop/file/2023/JMA-WS2023_Item04_WIS2.0-Architecture-and-Global-Services.pdf">Japan | Introduction to WIS2 (JMA WIS – Workshop 11.2023)</a> (<strong>Recommendation</strong>)</li><li><a href="https://www.ecmwf.int/en/newsletter/176/computing/wis-20-wmo-data-sharing-21st-century">ECMWF | WIS 2.0: WMO data sharing in the 21st century</a><ul><li><a href="https://www.ecmwf.int/sites/default/files/elibrary/072023/81382-wis-2-0-wmo-data-sharing-in-the-21st-century.pdf">pdf</a></li></ul></li><li><a href="https://www.cma.gov.cn/en/research/news/202305/t20230529_5537194.html">CMA | Congress acclaims WMO Information System as basis for data sharing</a></li></ul><figure><img src="https://community.wmo.int/sites/default/files/inline-images/WIS2_diagram.png" alt="WIS2 Global Services" /><figcaption>WIS2 Global Services</figcaption></figure><p>The WMO Information System 2.0 (WIS 2.0) is the framework for WMO data sharing in the 21st century for all WMO domains and disciplines. It supports the WMO Unified Data policy, the Global Basic Observing Network (GBON) and makes international, regional, and national data sharing simple, effective, and inexpensive. The idea that no Member should be left behind and the objective of lowering the barrier to adoption has been at the core of WIS 2.0 development. These objectives inspire the principles underpinning the WIS 2.0 technical framework, such as adopting open standards and Web technologies to facilitate sharing of increasing variety and volume of real-time data.</p><figure><img src="https://www.ecmwf.int/sites/default/files/styles/wide/public/2023-07/NL176_Giraud_C1-Figure-1.jpg?itok=wCpKEBKG" alt="In the WIS 2.0 Pilot phase, a number of Centres are operating one service. This map shows the situation in May 2023. (Image source: ECMWF)" /><figcaption>In the WIS 2.0 Pilot phase, a number of Centres are operating one service. This map shows the situation in May 2023. (Image source: ECMWF)</figcaption></figure><ul><li>WMO Information System 2.0(WIS 2.0), which is the framework for Earth Systems (meteorological, hydrological, climate and ocean) data sharing in the 21st century. It is based on the principle that no Member should be left behind.</li><li>The <strong>WIS 2.0 pilot phase started in the December 2022 and is scheduled for completion by the end of 2023.</strong> WIS 2.0 supports theWMO Unified Data policy, theGlobal Basic Observing Network (GBON)and makes international, regional, and national data sharing simple, effective, and inexpensive.</li><li>Training and capacity-building workshops are accompanying the rollout of WIS 2.0. Its new data-sharing infrastructure will <strong>gradually replace the Global Telecommunication System (GTS)</strong>.</li><li>The users of WIS 2.0 will be able to access data in real-time by subscribing to a Global Broker and receiving notifications when new data are available for download from a Global Cache or from the data provider. They will also be able to access data directly through Web APIs (application programming interfaces), connecting their software (or their browser) and processing or visualising data of their interest.</li><li>WMO has developed the <strong>open-source software “WIS2 in a box”</strong> to support Least Developed Countries and Small Island Developing States in implementing WIS 2.0.</li></ul><h1 id="wis-2.0-in-a-box">WIS 2.0 in a box</h1><p><a href="https://community.wmo.int/en/wis2box">WMO | WMO INFORMATION SYSTEM (WIS) 2.0 IN A BOX</a></p><p>The WIS2-in-a-box project was started in November 2021 to provide a system to share data using the WIS2 framework.</p><p>The WIS2box-software is implemented such as to offer the flexibility of being deployed both on private/public cloud or on-premises systems. The main features are:</p><ul><li>based on existing open-source software widely used in the operations of some WMO Members.</li><li>allows Members to share data internationally and nationally using message queuing protocols (MQP) and Web services in compliance with WIS2 technical regulations</li><li>provides Web APIs complying with Open Geospatial Consortium (OGC) standards, making access to data extremely easy from all common languages (Python, R, ...) and many open-source and proprietary programs (Excel).</li></ul><p>Demonstration instances of WIS2-in-a-box can be viewed at <a href="https://demo.wis2box.wis.wmo.int" class="uri">https://demo.wis2box.wis.wmo.int</a>.</p><h2 id="hosting-your-own-wis2-in-a-box">Hosting your own WIS2-in-a-box</h2><ul><li>The WIS2-in-box user guide, detailing how to setup your own WIS2 box, is available here: <a href="https://docs.wis2box.wis.wmo.int" class="uri">https://docs.wis2box.wis.wmo.int</a></li></ul><h2 id="example">Example</h2><p>WIS2 in a box is a reference implementation of a WMO WIS2 Node</p><ul><li>Many countries<ul><li><a href="https://demo.wis2box.wis.wmo.int/" class="uri">https://demo.wis2box.wis.wmo.int/</a></li></ul></li><li>CMA<ul><li><a href="https://wis2node.wis.cma.cn/" class="uri">https://wis2node.wis.cma.cn/</a></li></ul></li><li>Republic of Korea<ul><li><a href="https://wis2box.kma.go.kr/" class="uri">https://wis2box.kma.go.kr/</a></li></ul></li><li>Poland<ul><li><a href="https://wis2-pilot.imgw.pl/" class="uri">https://wis2-pilot.imgw.pl/</a></li></ul></li></ul><h1 id="hko-cma-wis-2.0">HKO-CMA-WIS 2.0</h1><ul><li><a href="https://www.hko.gov.hk/en/education/weather/data-and-technology/00704-Meteorological-information-sharing-in-the-21st-century.html">HKO | Meteorological Information Sharing in the 21st Century (December 2023)</a></li></ul><p>The Hong Kong Observatory (HKO) has recently <strong>set up a WIS 2.0 system on a public cloud and interfaced</strong> with the WIS 2.0 system operated by the China Meteorological Administration (CMA). Collaboration and partnership with CMA to develop and implement WIS 2.0 was underway.</p><ul><li>A conceptual diagram of information publish and subscribe under the framework of WIS 2.0.</li></ul><figure><img src="https://www.hko.gov.hk/en/education/weather/data-and-technology/images/703_fig1_data_exchange_e.png" alt="A conceptual diagram of information publish and subscribe under the framework of WIS 2.0" /><figcaption>A conceptual diagram of information publish and subscribe under the framework of WIS 2.0</figcaption></figure><figure><img src="https://www.hko.gov.hk/tc/education/weather/data-and-technology/images/703_fig1_data_exchange_c.png" alt="WIS 2.0框架下信息發布和訂閱概念圖" /><figcaption>WIS 2.0框架下信息發布和訂閱概念圖</figcaption></figure><h1 id="building-the-wis-2.0-global-weather-cache-on-aws">Building the WIS 2.0 global weather cache on AWS</h1><ul><li><a href="https://aws.amazon.com/blogs/publicsector/building-the-wis-2-0-global-weather-cache-on-aws/">Building the WIS 2.0 global weather cache on AWS</a></li></ul><p>The World Meteorological Organization (WMO) wants to build and modernize a global weather framework with WMO Information Systems (WIS) 2.0 to enable and democratize unified access to critical, up-to-date weather data across the world. Currently, lack of observations, easy access to data, computing power, human and capital resources, capacity, and budget hinders accurate and timely forecasts</p><figure><img src="https://d2908q01vomqb2.cloudfront.net/9e6a55b6b4563e652a23be9d623ca5055c356940/2024/06/24/wis2.0_header.png" alt="Building the WIS 2.0 global weather cache on AWS" /><figcaption>Building the WIS 2.0 global weather cache on AWS</figcaption></figure><p>WIS 2.0 data viewed in the WIS 2.0 in a box application. The map below shows US weather data observation locations in a map along with an observation location’s weather data.</p><figure><img src="https://d2908q01vomqb2.cloudfront.net/9e6a55b6b4563e652a23be9d623ca5055c356940/2024/06/24/wis2.0_figure2.png" alt="The map shows US weather data observation locations in a map along with an observation location’s weather data" /><figcaption>The map shows US weather data observation locations in a map along with an observation location’s weather data</figcaption></figure><h1 id="referecnes">Referecnes</h1><ol type="1"><li><a href="http://gisc.wis.cma.cn/wis/portal.pub?LA=en_US">For WIS.v1 CMA-WIS portal (Beijing Global Information System Center)</a></li></ol>]]></content>
    
    
    <categories>
      
      <category>NWP</category>
      
    </categories>
    
    
    <tags>
      
      <tag>NWP</tag>
      
      <tag>WRF</tag>
      
      <tag>MPAS</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Pseudo-Global Warming (PGW) - Future Projection</title>
    <link href="/2024/09/30/PGW/"/>
    <url>/2024/09/30/PGW/</url>
    
    <content type="html"><![CDATA[<h1 id="pseudo-global-warming-pgw">Pseudo-Global Warming (PGW)</h1><h2 id="definition-and-concept">Definition and Concept</h2><p>Pseudo-Global Warming (PGW) is a regional climate modeling approach that involves imposing large-scale climate changes derived from global climate models (GCMs) onto a control regional climate simulation. This method contrasts with traditional dynamic downscaling, where regional models are driven directly by GCM outputs. Instead, PGW modifies the boundary conditions of a historical simulation to reflect projected future changes, allowing for a more flexible and computationally efficient analysis of climate impacts.</p><figure><img src="https://i.imgur.com/1PLI5DB.png" alt="Shared Socioeconomic Pathways (SSPs) are climate change scenarios of projected socioeconomic global changes up to 2100 as defined in the IPCC." /><figcaption>Shared Socioeconomic Pathways (SSPs) are climate change scenarios of projected socioeconomic global changes up to 2100 as defined in the IPCC.</figcaption></figure><p>To perform future projections using the <strong>Pseudo-Global Warming (PGW)</strong> approach, follow these key steps:</p><h2 id="methodology-for-pgw-projections">Methodology for PGW Projections</h2><h3 id="understanding-pgw-concept"><strong>1. Understanding PGW Concept</strong></h3><p>The PGW method involves modifying historical climate simulations by imposing future climate changes directly onto them. This is achieved by adjusting the boundary conditions of a control simulation based on projected changes derived from global climate models (GCMs).</p><h3 id="mathematical-representation"><strong>2. Mathematical Representation</strong></h3><p>The PGW approach can be mathematically expressed as:</p><p><span class="math display">\[\text{PGW} = \text{HIST} + \Delta\]</span></p><p>where:</p><ul><li><strong>HIST</strong> represents the current or historical climate conditions.</li><li><strong>Δ</strong> (Delta) is the perturbation derived from future climate projections,</li></ul><p>calculated as:</p><p><span class="math display">\[\Delta = \text{SCEN} - \text{CTRL}\]</span></p><p>Here, <strong>SCEN</strong> is a future climate scenario, and <strong>CTRL</strong> is the corresponding historical baseline.</p><div class="note note-warning">            <p>Both SCEN and HIST periods must be chosen to be long enough to reduce the effects of internal variability (average of ∼ 30 years).</p>          </div><figure><img src="https://eurec4a.eu/fileadmin/user_upload/eurec4a/Simulations/PGW.jpg" alt="Schematics of the principles of the Pseudo Global Warming (PGW) framework (image from EUREC4A)" /><figcaption>Schematics of the principles of the Pseudo Global Warming (PGW) framework (image from EUREC4A)</figcaption></figure><ul><li>Chow, T. N., Tam, C. Y., Chen, J., &amp; Hu, C. (2024). Effects of Background Synoptic Environment in Controlling South China Sea Tropical Cyclone Intensity and Size Changes in Pseudo–Global Warming Experiments. <a href="https://journals.ametsoc.org/view/journals/clim/37/5/JCLI-D-23-0503.1.xml">Journal of Climate, 37(5), 1811-1832.</a></li><li>Zhao, R., Tam, C. Y., Lee, S. M., &amp; Chen, J. (2024). Attributing extreme precipitation characteristics in South China Pearl River Delta region to anthropogenic influences based on pseudo global warming. <a href="https://agupubs.onlinelibrary.wiley.com/doi/10.1029/2023EA003266">Earth and Space Science, 11(3), e2023EA003266.</a><ul><li>In the second PGW experiment, human‐induced perturbations are computed as the monthly averages of the <strong>30‐year (1986–2005)</strong> mean differences between historical and historicalNat runs of CMIP5 seven‐model ensemblemean.</li><li>The perturbed fields include <strong>SST, air temperature, specific humidity, and horizontal wind components</strong>.</li></ul></li><li>Brogli, R., Heim, C., Mensch, J., Sørland, S. L., &amp; Schär, C. (2023). The pseudo-global-warming (PGW) approach: methodology, software package PGW4ERA5 v1. 1, validation, and sensitivity analyses. <a href="https://gmd.copernicus.org/articles/16/907/2023/">Geoscientific Model Development, 16(3), 907-926.</a><ul><li>Both SCEN and HIST periods must be chosen to be long enough to reduce the effects of internal variability (average of ∼ 30 years).</li><li>After applying Δ to the thermodynamic variables, it is thus essential to restore this balance using an adequate pressure adjustment</li></ul></li><li><a href="https://eurec4a.eu/eurec4a-multi-day-model-intercomparison-project/methodology">Pseudo Global Warming: Methodology</a><ul><li>The perturbation fields Delta are meant to be based on 30-year monthly means of the driving GCM. The required GCM fields include three-dimensional fields of temperature, specific humidity and wind (T, qv, u, v), as well as the geopotential height field (phi) on at least one pressure level. Monthly mean changes of these fields are linearly interpolated to the target date, and then merged with ERA5 information.</li></ul></li></ul><h3 id="data-requirements"><strong>3. Data Requirements</strong></h3><p>To implement PGW, you need:</p><ul><li>Historical climate data (e.g., from reanalysis datasets like ERA5).</li><li>Future climate projections from GCMs, typically focusing on thermodynamic and dynamic variables such as temperature, humidity, wind, and geopotential height.</li></ul><h3 id="simulation-setup"><strong>4. Simulation Setup</strong></h3><ul><li><strong>Select a GCM</strong>: Choose a transient GCM that provides future climate scenarios relevant to your region of interest.</li><li><strong>Derive Δ</strong>: Compute the perturbations (Δ) based on 30-year monthly means from the GCM outputs.</li><li><strong>Modify Boundary Conditions</strong>: Apply Δ to the historical data to create new boundary conditions for your regional climate model (RCM) simulations.</li></ul><h3 id="running-simulations"><strong>5. Running Simulations</strong></h3><ul><li>Execute the RCM with the modified boundary conditions. The PGW approach allows for shorter simulation periods (less than 30 years), which can be beneficial for high-resolution climate projections.</li><li>Ensure that interannual variability is not included in these projections since PGW assumes a consistent seasonal cycle.</li></ul><h3 id="analyzing-results"><strong>6. Analyzing Results</strong></h3><p>After running the simulations:</p><ul><li>Assess changes in key climate variables such as temperature, precipitation, and extreme weather events.</li><li>Compare results with traditional dynamic downscaling methods to validate the PGW approach's effectiveness in capturing plausible future scenarios.</li></ul><h2 id="advantages-of-pgw">Advantages of PGW</h2><ul><li><strong>Computational Efficiency</strong>: PGW requires less computational power compared to traditional methods, making it suitable for high-resolution studies.</li><li><strong>Flexibility</strong>: It allows researchers to easily modify simulation parameters and assess various future scenarios.</li></ul><h2 id="challenges-and-considerations">Challenges and Considerations</h2><p>Despite its advantages, implementing PGW poses challenges:</p><ul><li><strong>Complexity of Implementation</strong>: Care must be taken to ensure that modifications do not compromise the physical realism of the regional model. Adjustments to pressure and geopotential fields are critical for maintaining consistency between thermodynamic and dynamic changes.</li><li><strong>Interannual Variability</strong>: The PGW method typically does not account for changes in interannual variability, which can limit its applicability in certain contexts.</li><li><strong>Sensitivity to Initial Conditions</strong>: The effectiveness of PGW simulations can be sensitive to the choice of initial conditions and boundary settings, necessitating careful calibration.</li></ul><p>By following this structured methodology, researchers can effectively utilize the PGW approach to project future climate conditions while addressing specific regional impacts of global warming.</p><h1 id="example">Example</h1><h2 id="zhao-francis-tam-prd">2024 | Zhao &amp; Francis Tam | PRD</h2><ul><li><a href="https://agupubs.onlinelibrary.wiley.com/doi/10.1029/2023EA003266">Zhao, R., Tam, C. Y., Lee, S. M., &amp; Chen, J. (2024). Attributing extreme precipitation characteristics in South China Pearl River Delta region to anthropogenic influences based on pseudo global warming. Earth and Space Science, 11(3), e2023EA003266.</a></li></ul><p>Experiment Setup,</p><ul><li><strong>WRF model v3.8.1</strong> (Skamarock et al., 2008) in a one-way nesting setup</li><li><strong>50 km × 50 km, covering most of southeast Asia, 10 km × 10 km (136 × 116 grid cells) and 2 km × 2 km</strong> (181 × 166 grid cells), respectively. There are 45 vertical layers from the surface up to 50 hPa, with 18 layers in the lowest 1.5 km, to resolve the planetary boundary layer (PBL) dynamics.</li><li><strong>Spectral nudging</strong> is applied to <strong>zonal and meridional wind components above 500 hPa over the outermost domain</strong> (Liu et al., 2012; Ma et al., 2016), at the <strong>scale of about 1,300 km (1,500 km)</strong> in the zonal (meridional) direction.</li><li>2 Experiments<ul><li>In the <strong>first set of experiments</strong>, or the control (CTL) run, the initial and boundary conditions (IBCs) are taken from ERA-Interim reanalysis</li><li>in the second set of experiments (denoted as the NAT run), the model is forced by the counterfactual IBCs with human-induced climatic perturbations being absent, following the pseudo global warming (PGW) method</li><li>In the <strong>second PGW experiment</strong>, human-induced perturbations are computed as the <strong>monthly averages of the 30-year (1986–2005) mean differences between historical and historicalNat runs of CMIP5 seven-model ensemble mean</strong>.</li><li>The perturbed fields include <strong>SST, air temperature, specific humidity, and horizontal wind components</strong> (Figure S4 in Supporting Information S1).</li><li>The use of a multi-model ensemble mean can minimize the model uncertainty and internal climate variability from the CMIP5 individual models (Liu et al., 2017).</li><li>We define a ratio of observations to seven-model ensemble-mean projections of ST trends as the scale factor that is multiplied by the ensemble-mean perturbations, to resolve more realistic anthropogenic perturbations. ?</li><li>Finally, these perturbations were <strong>interpolated linearly on each model grid over the outermost domain</strong> and <strong>then subtracted from ERA-Interim to generate counterfactual IBCs</strong> in WRF.</li><li>This method allows one to estimate anthropogenic influences on a specific extreme event, which makes it easier to perform event attribution analysis based on dynamical downscaling</li></ul></li></ul><h2 id="chow-cuhk-essc-m.phil.-thesis">2022 | Chow | CUHK ESSC M.Phil. thesis</h2><ul><li>Tsun Ngai CHOW</li><li>M.Phil. thesis: Effects of Background Synoptic Environment in Controlling the Tropical Cyclone Intensity and Size Changes in South China Sea in Pseudo-Global Warming Experiments</li><li><a href="https://atmosphericdynamicsgroup.github.io/publications.html" class="uri">https://atmosphericdynamicsgroup.github.io/publications.html</a></li><li><a href="https://atmosphericdynamicsgroup.github.io/theses/Tsun%20Ngai%20CHOW.pdf#page=48.40" class="uri">https://atmosphericdynamicsgroup.github.io/theses/Tsun%20Ngai%20CHOW.pdf#page=48.40</a></li></ul><p>Experiment Setup,</p><figure><img src="https://i.imgur.com/xK1AzZr.png" alt="Experiment Setup" /><figcaption>Experiment Setup</figcaption></figure><ul><li>total of <strong>31 and 5 models from the CMIP5</strong> were selected to obtain the projected future changes following the <strong>RCP8.5 and RCP4.5 emission scenario</strong> respectively.</li><li>The climate conditions in the <strong>1975 – 1999</strong> were selected as the reference of the historical climate while the climate conditions in the <strong>2036 – 2065</strong> and <strong>2075 – 2099</strong> were selected as the near future and the far future climate respectively.</li><li>The <strong>SST, land surface temperature, atmospheric temperature and the specific humidity profiles</strong> in the historical climate, as well as in the projected near future and the far future climate were averaged across that period for each month separately to obtain the <strong>mean monthly climatic condition in the historical, near future and far future period</strong>.</li><li>After that, <strong>the SST, land surface temperature, atmospheric temperature and specific humidity in the near future and the far future were subtracted by the historical climate conditions</strong>, obtaining the change of surface temperature, atmospheric temperature and the specific humidity profile in the near and the far future relative to the historical period.</li><li>Then, the change in the monthly mean SST, land surface temperature, atmospheric temperature profile and the specific humidity profile in the near future and the far future relative to the historical climate were superimposed on the historical environment of the 25 selected TCs according to the month of occurrence in the past for each TC to create a total of 4 warming experiments, each contain 25 TC cases. Therefore, there are 1 control simulation and 4 warming experiments for each of the 25 TC cases, and a total of 125 simulations.</li><li><strong>Moreover, the reason for not imposing the projected change in wind field in the future climate to the TCs were to examine the change in thermodynamical environment due to global warming to the intensity and the size of the TCs, while not changing the track of the TC</strong>. The author aimed to reduce the complexity brought by the possible changes of the TC track in the future environment due to a change of steering wind, which then allowed a comparison between the response of different TCs in a warmed climate by attributing the different in the percentage change of TC intensity and size to the difference in the historical environment and the imposed warming signal.</li><li><strong>WRF-ARW version 3.7, ERA-20C and EAR5</strong> as the initial and boundary conditions of the control run</li><li>2 nested domains were set up with one-way nesting, with 15 km and 3 km (the domain size is 339 × 249 and 400 × 580 grid), 45 eta levels across the vertical direction</li></ul><h2 id="gutmann-changes-in-hurricanes-...">2018 | Gutmann | Changes in hurricanes ...</h2><ul><li><a href="https://journals.ametsoc.org/view/journals/clim/31/9/jcli-d-17-0391.1.xml?tab_body=pdf">Gutmann, E. D., Rasmussen, R. M., Liu, C., Ikeda, K., Bruyere, C. L., Done, J. M., ... &amp; Veldore, V. (2018). Changes in hurricanes from a 13-yr convection-permitting pseudo–global warming simulation. Journal of Climate, 31(9), 3643-3657.</a></li></ul><p>Experiment Setup,</p><ul><li>The future simulations were forced with the same input data after adding a climate change signal to the data using the pseudo–global warming (PGW) method.</li><li>In these simulations we applied a PGW change for the following input variables: <strong>zonal and meridional wind speed, sea level pressure, geopotential height, air temperature, relative humidity, and sea surface temperature as well as initial soil temperatures and the bottom boundary condition in the soil</strong>.</li><li>We compute the change signal over a 95-yr time period using data from the representative concentration pathway 8.5 <strong>(RCP8.5)</strong> scenario for 19 models in the CMIP5 archive. This is calculated by averaging the period 2070–99 and subtracting from it the average over the period 1976–2005. <strong>This change signal is calculated independently for every variable at every grid point in space, and for every month of the year</strong>.</li><li>Changes are temporally interpolated between month midpoints. For example, the change signal for 15 May of all years is computing by averaging the change signal over the period 1–30 May. The resulting change signal has a mean warming signal of 3–6 deg C and an increase in water vapor mixing ratio of 20%–40%, consistent with the Clausius–Clapeyron relationship.</li></ul><h2 id="rasmussen">2011 | Rasmussen</h2><ul><li><a href="https://journals.ametsoc.org/view/journals/clim/24/12/2010jcli3985.1.xml">Rasmussen, R., Liu, C., Ikeda, K., Gochis, D., Yates, D., Chen, F., ... &amp; Gutmann, E. (2011). High-resolution coupled climate runoff simulations of seasonal snowfall over Colorado: A process study of current and warmer climate. Journal of Climate, 24(12), 3015-3048.</a></li></ul><p>Experiment Setup,</p><ul><li>The PGW methodology consists of adding a climate perturbation signal to a contemporary high-resolution analysis of the atmosphere during the future period of interest. (provides a <strong>first-order estimate</strong> of the potential climate warming impacts)</li><li>The climate perturbation’s primary impact is on the large-scale planetary waves and associated thermodynamics, while the weather patterns entering the domain boundary remain structurally identical in both simulations in terms of frequency and intensity. The weather events, however, can evolve within the regional model domain due to the altered planetary flow and thermodynamics.</li><li>The monthly climatology’s are the decadal monthly averages for the future and current decades resulting in regional values of mean <strong>temperature, vapor mixing ratio, geopotential height, and wind</strong> at each vertical level in the model in the domain of the high-resolution simulations.</li><li>The climate perturbation field is added to the current weather field for the selected years by <strong>linearly interpolating</strong> from the monthly climatologies to each time period in the NARR analysis assuming that the monthly mean is valid on the 16th of the month.</li><li>At the surface, <strong>deep-soil temperatures</strong> are also perturbed with the same methodology.</li><li>Both the initial conditions and time-evolving lateral and lower boundary conditions from NARR are therefore perturbed with the climate change signal.</li><li>The significant benefit of this is that the climate perturbation signal can be added to the NARR analysis while maintaining hydrostatic and geostrophic balances because the difference of two balanced mean fields retains the linear relationships between the virtual temperature, geopotential height, and horizontal wind perturbation fields. Therefore, adding this difference retains the consistency in the large-scale fields, while also preserving the small-scale weather patterns and imbalances of the period of interest.</li></ul><h2 id="臺灣空氣品質變化與氣候變遷">臺灣空氣品質變化與氣候變遷</h2><ul><li><a href="https://tccip.ncdr.nat.gov.tw/km_newsletter_one.aspx?nid=20191202172107">臺灣空氣品質變化與氣候變遷</a> 計畫流程示意圖。預計將進行對照組（CTRL）及實驗組（Pseudo-Global Warming, PGW），分別以WRF及CMAQ模擬現在及未來氣候狀態的空氣品質。橘色框為WRF初始及邊界條件，CTRL使用ECMWF ERA5資料，PGW則考慮未來氣候變化差異。</li></ul><figure><img src="https://tccip.ncdr.nat.gov.tw/upload/ckfinder/images/TCCIP%E7%AC%AC34%E6%9C%9F%E9%9B%BB%E5%AD%90%E5%A0%B1_%E5%9C%963.png" alt="流程示意圖" /><figcaption>流程示意圖</figcaption></figure><h1 id="codesoftware">Code/Software</h1><h2 id="software-package-pgw4era5-v1.1">** Software package PGW4ERA5 v1.1</h2><ul><li><a href="https://gmd.copernicus.org/articles/16/907/2023/">Brogli, R., Heim, C., Mensch, J., Sørland, S. L., &amp; Schär, C. (2023). The pseudo-global-warming (PGW) approach: methodology, software package PGW4ERA5 v1. 1, validation, and sensitivity analyses. Geoscientific Model Development, 16(3), 907-926.</a></li><li>The term “pseudo-global warming” (PGW) refers to a simulation strategy in regional climate modeling. The strategy consists of directly imposing large-scale changes in the climate system on a control regional climate simulation (usually representing current conditions) by modifying the boundary conditions.</li><li>Both SCEN and HIST periods must be chosen to be long enough to reduce the effects of internal variability (average of ∼ 30 years).</li><li><strong>At first glance it is surprising that one can change the driving fields of an RCM simulation in an ad hoc fashion as depicted above without introducing serious inconsistencies in the atmospheric dynamics</strong>. ... However, the PGW approach rests on a solid theoretical foundation....In essence, the balanceof forces is unchanged...</li></ul><div class="note note-warning">            <p>As to be demonstrated later (see Sect. 4.3), <strong>it is advantageous to use relative humidity (RH) rather than qv; if only the latter is available, qv is converted into RH.</strong> There are alternative approaches to treat the humidity change, such as the assumption of no change in RH with warming</p>          </div><figure><img src="https://gmd.copernicus.org/articles/16/907/2023/gmd-16-907-2023-t01-web.png" alt="Table 1Data requirements: pressure-level monthly-mean data from the driving GCM." width="400" /><figcaption>Table 1Data requirements: pressure-level monthly-mean data from the driving GCM.</figcaption></figure><h2 id="cmip5_to_wrf">CMIP5_to_WRF</h2><ul><li><a href="https://github.com/mgrover1/CMIP5_to_WRF" class="uri">https://github.com/mgrover1/CMIP5_to_WRF</a></li></ul><h1 id="bias-corrected-gcmscmip6-global-dataset">Bias-corrected GCMs/CMIP6 Global dataset</h1><h2 id="calibration-and-bias-correction">Calibration and bias correction</h2><ul><li><a href="https://eprints.whiterose.ac.uk/77973/10/challinor14.pdf">Hawkins, E., Osborne, T. M., Ho, C. K., &amp; Challinor, A. J. (2013). Calibration and bias correction of climate projections for crop modelling: An idealised case study over Europe. Agricultural and forest meteorology, 170, 19-31.</a></li></ul><p><img src="https://i.imgur.com/3JIZp97.png" width="400" /> <img src="https://i.imgur.com/5TipePD.png" width="600" /> <img src="https://i.imgur.com/ixHudQn.png" width="600" /></p><div class="note note-warning">            <ul><li><strong>Eqn. A.2 is a mapping</strong> <span class="math inline">\(f: X_1 \mapsto X_2\)</span> with providing estimates of <span class="math inline">\(M_{1,2}\)</span> and <span class="math inline">\(\sigma_{1,2}\)</span>.</li><li>then, we can map any input and get corresponding f(input) with providing estimates of <span class="math inline">\(M_{1,2}\)</span> and <span class="math inline">\(\sigma_{1,2}\)</span>.</li><li>like $ T_{BC} (t) = f(T_{RAW}(t))$ with providing estimates of <span class="math inline">\(M_{1,2}\)</span> and <span class="math inline">\(\sigma_{1,2}\)</span>.</li></ul>          </div><h2 id="an-evaluation-of-statistical-and-dynamical-techniques-for-downscaling-local-climate">An Evaluation of Statistical and Dynamical Techniques for Downscaling Local Climate</h2><ul><li><a href="https://journals.ametsoc.org/view/journals/clim/12/8/1520-0442_1999_012_2256_aeosad_2.0.co_2.xml?tab_body=pdf">Murphy, J. (1999). An Evaluation of Statistical and Dynamical Techniques for Downscaling Local Climate. Journal of Climate, 12(8), 2256-2284. https://doi.org/10.1175/1520-0442(1999)012&lt;2256:AEOSAD&gt;2.0.CO;2</a></li></ul><p><img src="https://i.imgur.com/IS1r7mb.png" width="400" /></p><h2 id="建立環流模式推估能力評比之方法">建立環流模式推估能力評比之方法</h2><ul><li>連宛渝, 童慶斌, 何宜昕, 戴嘉慧, &amp; 莊立昕. (2013). 建立環流模式推估能力評比之方法. <a href="https://www.twaes.org.tw/ae/htmdata/20120904.pdf">農業工程學報, 59(1), 1-14.</a><ul><li>GCM 模擬結果與地面測站資料存在著誤差，在進行簡易降尺度之前，必須藉由誤差修正(Bias Correction)才能去除模式與地面測站之間的系統誤差。</li><li>假設GCM 之輸出資料. 與地面測站資料有相同之統計特性，亦即具有相. 同之機率值的情況下，GCM 之逐月資料與歷史. 逐月資料之關係可由式(1)表示</li><li>By <span class="math inline">\(pdf = \frac{1}{\sqrt{2\pi\sigma^2}} e^{-\frac{(x - \mu)^2}{2\sigma^2}}\)</span></li><li><span class="math inline">\(\frac{X_{obs} - \mu_{obs}}{\sigma_{obs}} = \frac{X_{GCM} - \mu_{GCM}}{\sigma_{GCM}}\)</span></li></ul></li></ul><h2 id="bias-corrected-cmip6-global-dataset-for-dynamical-downscaling-of-the-historical-and-future-climate-19792100">Bias-corrected CMIP6 global dataset for dynamical downscaling of the historical and future climate (1979–2100)</h2><ul><li>Xu, Z., Han, Y., Tam, C. Y., Yang, Z. L., &amp; Fu, C. (2021). Bias-corrected CMIP6 global dataset for dynamical downscaling of the historical and future climate (1979–2100). Scientific Data, 8(1), 293.<ul><li><strong>General Circulation Model (GCM) is/are known to have significant biases</strong>, which propagate into RCMs through the lateral boundary and thus degrade the downscaled simulations.<ul><li><a href="https://waipangsze.github.io/2024/09/30/climate-model/#climate-model-bias">Climate model bias</a></li></ul></li><li>We constructed a bias-corrected global dataset based on 18 models from the <strong>Coupled Model Intercomparison Project Phase 6 (CMIP6)</strong> and the European Centre for Medium-Range Weather Forecasts Reanalysis 5 (<strong>ERA5</strong>) dataset.</li><li>The bias-corrected data have an ERA5-based <strong>mean climate and interannual variance</strong>, but with a <strong>non-linear trend</strong> from the ensemble mean of the 18 CMIP6 models.</li><li>The dataset spans the historical time period 1979–2014 and future scenarios (SSP245 and SSP585) for 2015–2100 with a horizontal grid spacing of (<strong>1.25° × 1.25°</strong>) at six-hourly intervals.</li><li>However, GCMs are known to have significant biases, which propagate into RCMs through the lateral boundary and thus degrade the downscaled simulations</li><li>Our method takes advantage of the <strong>non-linear trend</strong> of <strong>the ensemble mean of 18 Coupled Model Intercomparison Project Phase 6 (CMIP6)</strong> models to give a more reliable projection of the long-term climate trend.</li><li>In addition, we also correct the <strong>GCM climatological mean and interannual variance biases</strong> based on the European Centre for Medium-Range Weather Forecasts Reanalysis 5 (<strong>ERA5</strong>) dataset.</li></ul></li></ul><p><img src="https://i.imgur.com/YPVCv5g.png" width="600" /> <img src="https://i.imgur.com/siOQMBO.png" width="600" /></p><h2 id="基于-cmip6-耦合-wrf-的黄河上游复合干旱热浪事件演变规律.-水利学报-558-908-919.">基于 CMIP6 耦合 WRF 的黄河上游复合干旱热浪事件演变规律. 水利学报, 55(8), 908-919.</h2><ul><li>门宝辉, 吕行, 陈仕豪, &amp; 王红瑞. (2024). 基于 CMIP6 耦合 WRF 的黄河上游复合干旱热浪事件演变规律. 水利学报, 55(8), 908-919.<ul><li><a href="http://jhe.ches.org.cn/jhe/ch/reader/create_pdf.aspx?file_no=20240803&amp;flag=1&amp;journal_id=jhe&amp;year_id=2024#page=1.00&amp;gsr=0" class="uri">http://jhe.ches.org.cn/jhe/ch/reader/create_pdf.aspx?file_no=20240803&amp;flag=1&amp;journal_id=jhe&amp;year_id=2024#page=1.00&amp;gsr=0</a></li><li>本文提出了一种基于第六次国际耦合模式比较计划CMIP6耦合天气预报研究模式WRF的未来气象数据动力降尺度方法</li><li>精度验证<ul><li>采用研究区域内10个气象站（如图1所示）1979-2014年的实测数据及5种原始CMIP6数据集对bc-CMIP6的模拟精度进行检验和对比</li></ul></li></ul></li></ul><p><img src="https://i.imgur.com/asBspN2.png" width="600" /> <img src="https://i.imgur.com/YqeSZn4.png" width="600" /></p>]]></content>
    
    
    <categories>
      
      <category>NWP</category>
      
    </categories>
    
    
    <tags>
      
      <tag>NWP</tag>
      
      <tag>WRF</tag>
      
      <tag>MPAS</tag>
      
      <tag>PGW</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Climate Models</title>
    <link href="/2024/09/30/climate-model/"/>
    <url>/2024/09/30/climate-model/</url>
    
    <content type="html"><![CDATA[<h1 id="climate-models">Climate models</h1><p>Climate models are systems of differential equations based on the basic laws of physics, fluid motion, and chemistry. To "run" a model, scientists divide the planet into a 3-dimensional grid, apply the basic equations, and evaluate the results. Atmospheric models calculate winds, heat transfer, radiation, relative humidity, and surface hydrology within each grid and evaluate interactions with neighboring points.</p><figure><img src="https://celebrating200years.noaa.gov/breakthroughs/climate_model/AtmosphericModelSchematic.png" alt="(Image source: NOAA)" /><figcaption>(Image source: NOAA)</figcaption></figure><h2 id="the-complexity-of-the-climate-models">The complexity of the climate models</h2><p>As computing power has increased since the 1970s, so has the complexity of the computer models used to simulate Earth's climate. Components are first developed separately and later coupled into comprehensive models.</p><figure><img src="https://climate.nasa.gov/rails/active_storage/blobs/redirect/eyJfcmFpbHMiOnsibWVzc2FnZSI6IkJBaHBBa2NqIiwiZXhwIjpudWxsLCJwdXIiOiJibG9iX2lkIn19--81d8c831c0e77e9a03d7575233db6494080cbf46/evolution_743px.jpg?disposition=inline" alt="(From NASA)" /><figcaption>(From NASA)</figcaption></figure><h2 id="climate-model-bias">Climate model bias</h2><p>Climate model bias is the difference between the statistics of the observations for the reference period and the statistics of the climate model simulation for the same period.</p><p>The bias of a climate model is determined by comparing the climate model output for a past period with observational data for that same period. For example the annual and seasonal climatological averages for all relevant climate variables are compared, the probability of certain extremes, variability, trends, etc. The smaller the bias, the higher the model skill to simulate the observed climate correctly. This skill is often used as a measure of quality. <strong>Model biases are determined by comparing the statistics of observational records for a certain period (often 30 years) with the simulated climate for the same period in the past (for projections). Biases can not be determined by comparing e.g. the weather on certain dates or in certain years in the past!</strong></p><ul><li>Gupta, A. S., Jourdain, N. C., Brown, J. N., &amp; Monselesan, D. (2013). Climate Drift in the CMIP5 Models. Journal of Climate, 26(21), 8597-8615. https://doi.org/10.1175/JCLI-D-12-00521.1<ul><li>Model drift refers to spurious long-term changes in general circulation models that are unrelated to either changes in external forcing or internal low-frequency variability. Drift can be caused by a number of factors. For example, a simulation's initial state may not be in dynamical balance with the representation of physics in the model; “coupling shock” may occur during the coupling of model components resulting in discontinuities in surface fluxes (e.g., Rahmstorf 1995) or numerical errors may exist in the model that mean that heat or moisture is not fully conserved</li></ul></li></ul><p>Climate model bias refers to the systematic differences between the outputs of climate models and actual observed climate statistics. These biases can arise from several factors, including:</p><h3 id="definition-of-climate-model-bias"><strong>1. Definition of Climate Model Bias</strong></h3><ul><li>Climate model bias is defined as the difference between a simulated climate statistic (from a model) and the corresponding real-world climate statistic (observations) for the same period. This can include discrepancies in temperature, precipitation, and other climate variables over time.</li></ul><h3 id="causes-of-bias"><strong>2. Causes of Bias</strong></h3><ul><li><strong>Spatial Resolution</strong>: Many climate models operate on large grid sizes, which can lead to inaccuracies in representing local climate features.</li><li><strong>Simplified Thermodynamic Processes and Physics</strong>: Models may oversimplify complex physical processes, such as convection or land-atmosphere interactions, leading to incorrect simulations of climate dynamics.</li><li><strong>Incomplete Understanding</strong>: The current understanding of the climate system is not exhaustive, which can result in biases in model outputs.</li></ul><h3 id="types-of-bias"><strong>3. Types of Bias</strong></h3><ul><li><strong>Mean Bias</strong>: The average difference between model outputs and observations.</li><li><strong>Variance Bias</strong>: Differences in variability, such as how extreme weather events are represented.</li><li><strong>Temporal Bias</strong>: Issues related to timing, such as incorrect seasonal patterns or shifts in monsoon timings.</li></ul><h3 id="implications-of-bias"><strong>4. Implications of Bias</strong></h3><p>Using uncorrected climate model outputs for impact assessments can yield unrealistic results. For example, if a model consistently underestimates rainfall extremes, it could misinform water resource management or flood risk assessments.</p><h3 id="bias-correction-methods"><strong>5. Bias Correction Methods</strong></h3><p>To address these biases, various statistical methods have been developed:</p><ul><li><strong>Delta Change Method</strong>:<ul><li>Adjusts historical observations based on projected changes from models (e.g., adding a predicted temperature increase to historical data).</li><li>The simplest approach is the Delta change method, which is often used in climate impact research. This approach uses the GCM or RCM response to climate change to modify observations. E.g. if the climate model predicts 3°C higher temperatures, 3°C is added to all historic observations to construct a new time series for the future climate. For rainfall usually a percentage change is calculated. If the climate model predicts a 20% increase in rainfall, a new time-series will be made by multiplying the historic rainfall by 1.2. For different months or seasons different delta factors can be defined. Note: this method does not take into account changes in climate variability such as increasing extreme rainfall or longer dry spells.</li></ul></li><li><strong>Quantile Mapping</strong>: A more sophisticated method that maps the cumulative distribution functions (CDFs) of observed and modeled data to adjust for biases across all quantiles.</li><li><strong>Linear Regression</strong>: Uses historical data to create a statistical relationship between observed and modeled outputs for future projections.</li></ul><p>Both the delta change and linear regression method are suitable to bias adjust relative humidity, humidity, wind speed and radiation.</p><p>Climate models produce area-average data, whereas many observations are point measurements. In order to determine the skill, climate model data should be compared with area-average data, otherwise the bias may be affected by the difference between area-average and point data. This is especially important for climate variables where large spatial differences are observed within a grid cell, e.g. precipitation. For this reason reanalysis data are often used to determine the skill of climate models. The quality of climate data for the future cannot be assessed in a direct way, since no observational data set is available for the future. It is generally assumed that the bias/skill for the future is the same as for the past/current climate (although this is not necessarily true). When the skill is good for the current climate, we generally have more confidence in the results for the future.</p><h3 id="challenges-with-bias-correction"><strong>6. Challenges with Bias Correction</strong></h3><p>While bias correction methods aim to improve model outputs, they have limitations:</p><ul><li>They may not fully correct underlying physical process misrepresentations.</li><li>They can introduce new artifacts or inconsistencies in spatial and temporal data.</li><li>The assumption that present-day biases will remain constant over time can be problematic, especially for variables like precipitation that may exhibit non-stationarity.</li></ul><p>In summary, understanding and correcting climate model bias is essential for improving the reliability of climate projections and their applications in impact studies.</p><h1 id="downscaling-climate-models">Downscaling climate models</h1><p>Downscaling climate models is a crucial process for obtaining localized climate information from global climate models (GCMs), which typically operate at coarse spatial resolutions. Below is an overview of how to perform downscaling and the associated challenges.</p><figure><img src="https://climateextremes.org.au/wp-content/uploads/Screenshot-2023-04-13-at-4.01.03-pm-1.png" alt="Downscaled temperature over south-east Australia. Data: NARCLiM" /><figcaption>Downscaled temperature over south-east Australia. Data: NARCLiM</figcaption></figure><ul><li><a href="https://tccip.ncdr.nat.gov.tw/km_column_one.aspx?kid=20230725084802">什麼是降尺度? 為什麼降尺度不是越細越好?</a></li></ul><h2 id="methods-of-downscaling">Methods of Downscaling</h2><h3 id="types-of-downscaling"><strong>1. Types of Downscaling</strong></h3><ul><li><strong>Dynamical Downscaling</strong>: This method uses regional climate models (RCMs) that are forced by GCM outputs. RCMs operate on finer spatial scales (typically &lt;50 km) and can capture local climate features more accurately by incorporating detailed physical processes.</li><li><strong>Statistical Downscaling</strong>: This approach establishes statistical relationships between large-scale climate variables from GCMs and local observations. It is less computationally intensive than dynamical downscaling and includes methods such as:<ul><li><strong>Bias Correction with Spatial Disaggregation (BCSD)</strong>: Adjusts GCM outputs based on historical data.</li><li><strong>Quantile Mapping</strong>: Corrects the distribution of model outputs to match observed data distributions.</li><li><strong>Localized Constructed Analogs (LOCA)</strong>: Finds analogous historical weather patterns to generate fine-resolution outputs.</li></ul></li></ul><h3 id="steps-for-downscaling"><strong>2. Steps for Downscaling</strong></h3><ol type="1"><li><strong>Select a GCM</strong>: Choose a suitable global climate model and the relevant emission scenario.</li><li><strong>Obtain Historical Data</strong>: Gather historical climate data for the region of interest to establish baseline conditions.</li><li><strong>Choose a Downscaling Method</strong>: Decide between dynamical or statistical downscaling based on available resources and required precision.</li><li><strong>Run the Downscaling Model</strong>:<ul><li>For dynamical downscaling, set up the RCM with appropriate boundary conditions from the GCM.</li><li>For statistical downscaling, develop statistical relationships using historical data and apply them to future GCM projections.</li></ul></li><li><strong>Validate Outputs</strong>: Compare downscaled results with observed data to assess accuracy and make necessary adjustments.</li></ol><h2 id="challenges-of-downscaling">Challenges of Downscaling</h2><h3 id="computational-demands"><strong>1. Computational Demands</strong></h3><ul><li>Both dynamical and statistical downscaling can be computationally intensive, especially when multiple RCMs or scenarios are involved. This can strain resources for many research groups, limiting their ability to conduct extensive simulations.</li></ul><h3 id="bias-issues"><strong>2. Bias Issues</strong></h3><ul><li>GCMs often have systematic biases in their outputs, which can propagate through the downscaling process. If not adequately addressed, these biases can lead to misleading local projections.</li></ul><h3 id="uncertainty-in-atmospheric-circulation"><strong>3. Uncertainty in Atmospheric Circulation</strong></h3><ul><li>The accuracy of downscaled projections is heavily reliant on the atmospheric circulation patterns provided by GCMs. Any uncertainty in these patterns can significantly affect regional climate outcomes.</li></ul><h3 id="limitations-of-statistical-methods"><strong>4. Limitations of Statistical Methods</strong></h3><ul><li>Statistical downscaling relies on historical relationships that may not hold true under future climate conditions, leading to potential inaccuracies in projections. Additionally, assumptions made during statistical modeling can introduce further biases.</li></ul><h3 id="scale-mismatch"><strong>5. Scale Mismatch</strong></h3><ul><li>The coarse resolution of GCMs may not adequately represent localized phenomena such as orographic precipitation or extreme weather events, which are vital for impact assessments.</li></ul><p>In summary, while downscaling is essential for obtaining high-resolution climate information necessary for local impact studies, it comes with significant challenges that need careful consideration and management to ensure reliable projections.</p><h1 id="references">References</h1><ul><li><a href="https://climate.copernicus.eu/sites/default/files/2021-12/10-c3s-uls-data-resources-climate-models.pdf">C3S User Learning Services Data Resources - Climate Models</a> ((<strong>Recommendation</strong>))</li><li><a href="https://climateextremes.org.au/a-closer-look-at-climate-modelling/">climateextremes.org.au: Types of models</a> ((<strong>Recommendation</strong>))</li><li><a href="https://skepticalscience.com/weather-forecasts-vs-climate-models-predictions.htm">The difference between weather and climate</a></li><li><a href="https://blogs.reading.ac.uk/weather-and-climate-at-reading/2022/weather-vs-climate-prediction/">Weather and Climate @ Reading: Weather vs. Climate Prediction</a></li><li><a href="https://www.climate.gov/maps-data/climate-data-primer/predicting-climate/climate-models">Climate gov: Climate Models</a></li><li><a href="https://www.earth-scan.com/blog/weather-vs-climate">earth-scan: weather-vs-climate</a></li><li><a href="https://climate.copernicus.eu/sites/default/files/2021-01/infosheet7.pdf">Copernicus Climate Change Service – Global Impacts: What is bias correction?</a></li><li>Kotamarthi R, Hayhoe K, Mearns LO, Wuebbles D, Jacobs J, Jurado J. <strong>Empirical-Statistical Downscaling</strong>. In: Downscaling Techniques for High-Resolution Climate Projections: From Global Change to Local Impacts. Cambridge University Press; 2021:82-101. (<a href="https://sci-hub.se/https://doi.org/10.1017/9781108601269.006">link</a>)</li><li>Xu, Z., Y. Han, C.-Y. Tam, Z.-L. Yang and C. Fu, 2021: <strong>A bias-corrected CMIP6 global dataset. for dynamical downscaling of future climate, 1979–2100</strong>, Scientific Data, doi: 10.1038/s41597-021-01079-3. <a href="https://atmosphericdynamicsgroup.github.io/database/cmip6.html" class="uri">https://atmosphericdynamicsgroup.github.io/database/cmip6.html</a></li><li><a href="https://probablefutures.org/zh/science/climate-models/">Probable Futures 是一项非营利性气候扫盲计划</a></li></ul>]]></content>
    
    
    <categories>
      
      <category>NWP</category>
      
    </categories>
    
    
    <tags>
      
      <tag>NWP</tag>
      
      <tag>WRF</tag>
      
      <tag>MPAS</tag>
      
      <tag>PGW</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Differences Between Weather Models and Climate Models</title>
    <link href="/2024/09/30/weather-model-vs-climate-model/"/>
    <url>/2024/09/30/weather-model-vs-climate-model/</url>
    
    <content type="html"><![CDATA[<h2 id="differences-between-weather-models-and-climate-models">Differences Between Weather Models and Climate Models</h2><p>Understanding the distinctions between weather models and climate models is crucial for grasping how meteorologists and climate scientists predict atmospheric conditions over varying timescales. Here are the key differences:</p><h3 id="time-scale-of-predictions"><strong>1. Time Scale of Predictions</strong></h3><ul><li><strong>Weather Models</strong>: These models focus on short-term predictions, typically ranging from a few hours to about 15 days. They provide detailed forecasts for specific locations, such as whether it will rain tomorrow or if a storm is approaching.</li><li><strong>Climate Models</strong>: In contrast, climate models project conditions over much longer periods, often decades to hundreds of years. They analyze trends and averages rather than specific events, such as predicting whether summers will become drier in the next 50 years.</li></ul><h3 id="initial-vs.-foreced-boundary-value-problems"><strong>2. Initial vs. Foreced Boundary Value Problems</strong></h3><ul><li><strong>Weather Models</strong>: They operate as initial value problems, meaning they require precise initial conditions (like current temperature and pressure) to generate accurate forecasts. Small changes in these initial conditions can significantly impact the forecast outcome.</li><li><p><strong>Climate Models</strong>: In a climate model, you get climate variables for every day, but you don't care exactly on which day and exact location you get a certain value for this variable as long as the long term statistics are correct for the location and reference. This does not depend on the initial conditions of the simulation, but it depends on the parameters in the model itself or how the climate system is modelled (this is called a boundary value problem). These are "Foreced" boundary value problems, focusing on long-term changes influenced by factors like greenhouse gas concentrations and land use changes. The initial state is less critical; instead, the model uses projected future conditions to assess climate evolution.</p></li><li>預測未來氣候系統的演變是氣候科學的核心。如前所述，氣候預測是一個邊界值問題。模型必須假設長期限制氣候演變的條件將如何演變，例如對未來溫室氣體排放做出有根據的猜測。相反，天氣預報是一個初始值問題，首先取決於對天氣系統當前狀態的準確了解。氣候預測是一個邊界值的問題，在氣候案例中，最大的不確定性在於確定從太陽接收的能量（邊界值）如何在系統的各個組成部分（即大氣、海洋、陸地和冰凍圈）中分佈。<ul><li>Bracco, A., Brajard, J., Dijkstra, H. A., Hassanzadeh, P., Lessig, C., &amp; Monteleoni, C. (2024). Machine Learning for the Physics of Climate. arXiv preprint arXiv:2408.09627</li></ul></li><li><p>氣候變遷的預測不同於天氣預報，後者主要依賴初值，而前者既依賴初始條件,也依​​賴邊界條件或完全依賴邊界條件。短期氣候預測，就是依賴以上兩種條件，這種可預報性被洛崙茲稱為第一類可預報性。對於長期(幾十年或幾百年)的氣候變遷預測，如由人類活動造成的溫室氣體增加引起的全球氣候變化，將不依賴於大氣的初始條件，這是由於在模式長期積分之後，將完全喪失對初條件的記憶，因而失去它的影響。這種完全依賴詳細邊界條件變化的氣候預測被洛崙茲稱為第二類可預報性，其可預報性決定於外界強迫變化的時間尺度。由於氣候系統的慣性，即使施加於邊界的外強迫消失之後很久,氣候系統還將繼續變化相當長的時間，甚至長達千年以上，海平面上升的反應就是一個例子。雖然氣候本質上是一種混沌現象,表現為湍流或非週期現象，但有些情況下也表現出相當程度的週期性或準週期性，這就大大增加了氣候的可預測性。目前在氣候分析中廣泛使用的如子波分析法等,就是為揭示其不同時空尺度的周期性而進行的，另外一個氣候週期性著名的例子是地球軌道參數的米蘭科維奇循環。<a href="https://gd.weather.com.cn/climate/qhbhyw/11/1196273.shtml">link</a></p></li></ul><h3 id="resolution"><strong>3. Resolution</strong></h3><ul><li><strong>Weather Models</strong>: They typically have a finer spatial and temporal resolution, allowing for detailed predictions over smaller areas (often at a scale of 1 km or less). This granularity is essential for short-term forecasting.</li><li><strong>Climate Models</strong>: While they can also achieve high resolution, climate models generally operate on coarser grids (often around 50 km) due to the longer timeframes they analyze. The focus is on broader patterns rather than localized events.</li></ul><h3 id="data-assimilation"><strong>4. Data Assimilation</strong></h3><ul><li><strong>Weather Models</strong>: These models assimilate real-time observational data from satellites, weather stations, and radar to continuously update forecasts. This real-time data integration enhances accuracy for short-term predictions.</li><li><strong>Climate Models</strong>: Climate models do not incorporate real-time observations but instead rely on historical data and projections of future conditions based on various scenarios (e.g., different levels of greenhouse gas emissions) to simulate long-term trends.</li></ul><h3 id="purpose-and-application"><strong>5. Purpose and Application</strong></h3><ul><li><strong>Weather Models</strong>: Primarily used for immediate forecasting needs such as daily weather reports, severe weather warnings, and event planning. They help individuals and organizations prepare for short-term atmospheric conditions.</li><li><strong>Climate Models</strong>: Climate models are used to determine how the average and extreme conditions will change. Used to understand long-term climate change impacts, assess risks associated with global warming, and inform policy decisions regarding environmental management and sustainability. Their outputs guide infrastructure planning and disaster preparedness over extended periods.</li></ul><h3 id="summary-table">Summary Table</h3><table><thead><tr class="header"><th style="text-align: left;">Feature</th><th style="text-align: left;">Weather Models</th><th style="text-align: left;">Climate Models</th></tr></thead><tbody><tr class="odd"><td style="text-align: left;">Time Scale</td><td style="text-align: left;">Hours to 15 days</td><td style="text-align: left;">Decades to hundreds of years</td></tr><tr class="even"><td style="text-align: left;">Problem Type</td><td style="text-align: left;">Initial value problem</td><td style="text-align: left;">Boundary value problem</td></tr><tr class="odd"><td style="text-align: left;">Resolution</td><td style="text-align: left;">High (1 km or less)</td><td style="text-align: left;">Coarse (typically 50 km)</td></tr><tr class="even"><td style="text-align: left;">Data Assimilation</td><td style="text-align: left;">Real-time observational data</td><td style="text-align: left;">Historical data and future projections</td></tr><tr class="odd"><td style="text-align: left;">Purpose</td><td style="text-align: left;">Short-term forecasting</td><td style="text-align: left;">Long-term climate change analysis</td></tr></tbody></table><p>In summary, while both weather and climate models share foundational scientific principles, they serve different purposes and operate under distinct methodologies tailored to their respective timeframes and objectives.</p><figure><img src="https://www.esa.int/var/esa/storage/images/esa_multimedia/images/2021/04/weather_versus_climate_at_a_glance/23267896-1-eng-GB/Weather_versus_climate_at_a_glance_article.jpg" alt="‘Weather’ refers to short-term changes, and ‘climate’ to weather conditions averaged over at least 30 years (image source: ESA)." /><figcaption>‘Weather’ refers to short-term changes, and ‘climate’ to weather conditions averaged over at least 30 years (image source: ESA).</figcaption></figure><h1 id="references">References</h1><ul><li><a href="https://climate.copernicus.eu/sites/default/files/2021-12/10-c3s-uls-data-resources-climate-models.pdf">C3S User Learning Services Data Resources - Climate Models</a> ((<strong>Recommendation</strong>))</li><li><a href="https://climateextremes.org.au/a-closer-look-at-climate-modelling/">climateextremes.org.au: Types of models</a> ((<strong>Recommendation</strong>))</li><li><a href="https://skepticalscience.com/weather-forecasts-vs-climate-models-predictions.htm">The difference between weather and climate</a></li><li><a href="https://blogs.reading.ac.uk/weather-and-climate-at-reading/2022/weather-vs-climate-prediction/">Weather and Climate @ Reading: Weather vs. Climate Prediction</a></li><li><a href="https://www.climate.gov/maps-data/climate-data-primer/predicting-climate/climate-models">Climate gov: Climate Models</a></li><li><a href="https://www.earth-scan.com/blog/weather-vs-climate">earth-scan: weather-vs-climate</a></li><li><a href="https://climate.copernicus.eu/sites/default/files/2021-01/infosheet7.pdf">Copernicus Climate Change Service – Global Impacts: What is bias correction?</a></li><li>Kotamarthi R, Hayhoe K, Mearns LO, Wuebbles D, Jacobs J, Jurado J. <strong>Empirical-Statistical Downscaling</strong>. In: Downscaling Techniques for High-Resolution Climate Projections: From Global Change to Local Impacts. Cambridge University Press; 2021:82-101. (<a href="https://sci-hub.se/https://doi.org/10.1017/9781108601269.006">link</a>)</li><li>Xu, Z., Y. Han, C.-Y. Tam, Z.-L. Yang and C. Fu, 2021: <strong>A bias-corrected CMIP6 global dataset. for dynamical downscaling of future climate, 1979–2100</strong>, Scientific Data, doi: 10.1038/s41597-021-01079-3. <a href="https://atmosphericdynamicsgroup.github.io/database/cmip6.html" class="uri">https://atmosphericdynamicsgroup.github.io/database/cmip6.html</a></li></ul>]]></content>
    
    
    <categories>
      
      <category>NWP</category>
      
    </categories>
    
    
    <tags>
      
      <tag>NWP</tag>
      
      <tag>WRF</tag>
      
      <tag>MPAS</tag>
      
      <tag>PGW</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Data assimilation (DA)</title>
    <link href="/2024/09/24/DA-intro/"/>
    <url>/2024/09/24/DA-intro/</url>
    
    <content type="html"><![CDATA[<ul><li><a href="https://waipangsze.github.io/2024/09/24/DA-intro/"><strong>Data assimilation (DA)</strong></a></li><li><a href="https://waipangsze.github.io/2025/04/02/NWP-DA-Kalman-Filter/"><strong>NWP | DA | Kalman Filter</strong></a></li><li><a href="https://waipangsze.github.io/2025/03/20/NWP-DA-4Dvar/"><strong>NWP | DA | 4D-Var</strong></a></li></ul><hr /><h1 id="data-assimilation-da">Data assimilation (DA)</h1><p>Data assimilation (DA) (數據同化，或稱資料同化) is a technique by which numerical model data and observations are combined to obtain an analysis that best represents the state of the atmospheric phenomena of interest</p><h1 id="history">History</h1><ul><li>In 1901 Cleveland Abbe founded the United States Weather Bureau. He suggested that the atmosphere followed the principles of thermodynamics and hydrodynamics</li><li>In 1904, Vilhelm Bjerknes proposed a two-step procedure formodel-based weather forecasting. First, a analysis step of data assimilation to generate initial conditions, then a forecasting step solving the initial value problem.</li><li>In 1922, Lewis Fry Richardson carried out the first attempt to perform the weather forecast numerically.</li><li>In 1950, a team of the American meteorologists Jule Charney, Philip Thompson, Larry Gates, and Norwegian meteorologist Ragnar Fj ̈ortoft and the applied mathematician John von Neumann, succeeded in the first numerical weather forecast using the ENIAC digital computer.</li><li>In September 1954, Carl-Gustav Rossby’s group at the Swedish Meteorological and Hydrological Institute produced the first operational forecast (i.e. routine predictions for practical use) based on the barotropic equation. Operational numerical weather prediction in the United States began in 1955 under the Joint Numerical Weather Prediction Unit (JNWPU), a joint project by the U.S. Air Force, Navy, and Weather Bureau.</li><li>In 1959, Karl-Heinz Hinkelmann produced the first reasonable primitive equation forecast, 37 years after Richardson’s failed attempt. Hinkelmann did so by removing high-frequency noise from the numerical model during initialization.</li><li>In 1966, West Germany and the United States began producing operational forecasts based on primitive-equation models, followed by the United Kingdom in 1972, and Australia in 1977.</li></ul><h2 id="polynomial-fitting-of-panofsky">Polynomial Fitting of Panofsky</h2><blockquote><p>Panofsky, R. A. (1949). Objective weather-map analysis. Journal of Atmospheric Sciences, 6(6), 386-392.</p></blockquote><p><span class="math display">\[\begin{equation}\begin{split}p(x,y) = \sum_{i,j} a_{ij} x^i y^j, \qquad  i+j \leq 3\end{split}\end{equation}\tag{2}\]</span></p><ul><li>A field of 10 observations can be fitted accurately by a third-degree polynomial, with no smoothing of data.</li><li>The amount of smoothing will depend on the nature of the variable analyzed.</li></ul><h2 id="successive-correction-method-scm-of-cressman">Successive Correction Method (SCM) of Cressman</h2><blockquote><p>Cressman G P, 1959. An operational objective analysis system[J]. Mon Wea Rev, 87: 367-374.</p></blockquote><ul><li>Purpose:<ul><li>SCM is designed to improve the accuracy of gridded meteorological data by integrating observations from various sources, such as weather stations, into a coherent grid. This method is particularly useful in situations where observational data is sparse or unevenly distributed.</li></ul></li><li>Basic Principle:<ul><li>The method operates on the principle of iteratively correcting a background field (initial guess) using available observational data. Each iteration refines the grid values based on nearby observations, effectively merging the observational data with the background field.</li></ul></li><li>Weighting Function:<ul><li>Cressman's SCM employs a specific weighting function that determines how much influence each observation has on the grid point being corrected. This function typically decreases with distance from the observation point, allowing closer observations to have a greater impact on the grid value than those further away.</li></ul></li><li>Computational Efficiency:<ul><li>One of the advantages of SCM is its computational simplicity and efficiency, making it suitable for real-time applications in weather forecasting and analysis. It does not require complex background error covariance matrices or assumptions about error distributions, which simplifies its implementation compared to other assimilation methods like Optimal Interpolation (OI) or Variational methods.</li></ul></li></ul><h1 id="inverse-problem">Inverse Problem</h1><p>DA consists of using the actual result of some measurements to infer the values of the parameters that characterize the system.</p><h1 id="random-variable">Random Variable</h1><h2 id="bayesian">Bayesian</h2><h2 id="mathematics">Mathematics</h2><h1 id="algorithms">Algorithms</h1><p>The specific data assimilation algorithms can be divided into two main categories:</p><ol type="1"><li><strong>Continuous Data Assimilation Algorithms</strong>: This includes <strong>Three-Dimensional Variational (3DVar)</strong> and <strong>Four-Dimensional Variational (4DVar)</strong> methods, which optimize the model trajectory within the assimilation window to make the model results closer to the observed data.<ol type="1"><li><span class="math display">\[x^a = x^b+BH^T(R+HBH^T)^{-1}(y-Hx^b) \qquad (1)\]</span></li><li><span class="math display">\[J(x)=\frac12(x-x^\mathrm{b})B^{-1}(x-x^\mathrm{b})^\mathrm{T}+\frac12(y-Hx^\mathrm{b})R^{-1}(y-Hx^\mathrm{b}) \qquad (2)\]</span></li></ol></li><li><strong>Sequential Data Assimilation Algorithms</strong>: Represented by the <strong>Ensemble Kalman Filter (EnKF)</strong>, these methods dynamically update the model state to integrate observed data in real time.<ol type="1"><li><strong>Sequential?</strong> 在後續的模式積分過程中，我們不光需要積分模式，也需要將分析誤差協方差矩陣 "積分" (誤差協方差矩陣也進行"更新")，以獲得下次觀測時刻的背景誤差協方差。</li><li><strong>Extended Kalman filter (EKF)</strong> <span class="math display">\[ \begin{aligned} &amp;\boldsymbol{x}_{k} =\boldsymbol{Mx}_{k-1},  \qquad (3) \\ &amp;\boldsymbol{y}_k =\boldsymbol{Hx}_k,  \qquad \quad (4)\\ \hline &amp;\boldsymbol{K}=\boldsymbol{P}_k^\mathrm{f}\boldsymbol{H}^\mathrm{T}\left[\boldsymbol{H}\boldsymbol{P}_k^\mathrm{f}\boldsymbol{H}^\mathrm{T}+\boldsymbol{R}\right]^{-1} \qquad (5)\\ &amp;\boldsymbol{x}_k^\mathrm{a}=\boldsymbol{x}_k^\mathrm{f}+\boldsymbol{K}\left[\boldsymbol{y}_k-\boldsymbol{H}\boldsymbol{x}_k^\mathrm{f}\right] \qquad \quad  (6) \\ &amp;\boldsymbol{P}_k^\mathrm{a}=(\mathbf{I}-\boldsymbol{K}\boldsymbol{H})\boldsymbol{P}_k^\mathrm{f} \qquad \qquad\qquad  (7) \\ \hline &amp;\boldsymbol{x}_{k+1}^\mathrm{f}=\boldsymbol{M}\boldsymbol{x}_{k}^\mathrm{a} \qquad\qquad (8)  \\ &amp;\boldsymbol{P}_{k+1}^\mathrm{f}=\boldsymbol{M}\boldsymbol{P}_{k}^\mathrm{a}\boldsymbol{M}^\mathrm{T}+\boldsymbol{Q} \quad (9)\\ \hline \end{aligned} \]</span></li><li>Take Lorenz63 as example, <strong>Extended Kalman filter (EKF)</strong> <span class="math display">\[   \begin{aligned}   &amp;\frac{dx}{dt}=\sigma(y-x) \qquad (10)\\   &amp;\frac{dy}{dt}=\rho x-y-xz \qquad (11)\\   &amp;\frac{dz}{dt}=xy-\beta z \qquad (12)\\   \hline   &amp;\boldsymbol{x}_{k} =\mathcal{M}(\boldsymbol{x}_{k-1}),  \qquad (13) \\   &amp;\boldsymbol{y}_k =h(\boldsymbol{x}_k),  \qquad \quad (14)  \\   \hline   &amp;x_{k}^{\mathrm{f}}=\mathcal{M}\big(x_{k-1}^{\mathrm{a}}\big) \qquad (15)\\   &amp;M=\frac{\partial\mathcal{M}}{\partial x}\bigg|_{x_{k-1}^{\mathrm{a}}} \qquad (16)\\   &amp;P_{k}^{\mathrm{f}}=MP_{k-1}^{\mathrm{a}}\boldsymbol{M}^{\mathrm{T}}+\boldsymbol{Q}\qquad (17)\\   \hline   &amp;H={\frac{\partial h}{\partial x}}\bigg|_{x_{k}^{\mathrm{f}}} \qquad (18)\\   &amp;K=P_{k}^{\mathrm{f}}H^{\mathrm{T}}\left(HP_{k}^{\mathrm{f}}H^{\mathrm{T}}+R\right)^{-1} \qquad (19)\\   &amp;x_{k}^{\mathrm{a}}=x_{k}^{\mathrm{f}}+K\left[y_{k}-h\left(x_{k}^{\mathrm{f}}\right)\right]\qquad (20) \\   &amp;P_{k}^{\mathrm{a}}=(\mathbf{I}-\mathbf{K}\mathbf{H})P_{k}^{\mathrm{f}}\qquad (21)\\   \hline   &amp;\boldsymbol{M}=\frac{\partial\boldsymbol{f}}{\partial\boldsymbol{x}}=\begin{bmatrix}\frac{\partial f_1}{\partial x}&amp;\frac{\partial f_1}{\partial y}&amp;\frac{\partial f_1}{\partial z}\\\frac{\partial f_2}{\partial x}&amp;\frac{\partial f_2}{\partial y}&amp;\frac{\partial f_2}{\partial z}\\\frac{\partial f_3}{\partial x}&amp;\frac{\partial f_3}{\partial y}&amp;\frac{\partial f_3}{\partial z}\end{bmatrix}=\begin{bmatrix}-\sigma&amp;\sigma&amp;0\\\rho-z&amp;-1&amp;-x\\y&amp;x&amp;-\beta\end{bmatrix}   \end{aligned}   \]</span></li><li><strong>集合卡尔曼滤波器（Ensemble Kalman Filter, EnKF)</strong><ol type="1"><li>EKF的不足</li><li>有沒有特別的辦法讓 <span class="math inline">\(B\)</span> 矩陣可以演化，又不需要切線模式 <span class="math inline">\(M\)</span>，最好又能不佔用龐大的內容來保存 <span class="math inline">\(B\)</span> 呢？</li><li>EnKF 的基本想法是使用機率空間內的點表示狀態變數的一種可能。在這個想法下，EnKF最具革命性的工作是<strong>使用集合來估計預報誤差協方差矩陣</strong>。</li><li>在EnKF中，流依賴性不是體現在更新協方差裡面，而是更新狀態集合，然後<strong>利用不斷變化的狀態集合來用隨時計算協方差</strong>。</li><li>Lorenz63模式無法提現其中的計算成本。但如前面說的，實際模式中，切線模式的積分是平方倍的計算量，變數數多的時候會變成天文數值。而在EnKF中，其實 N只要有數十個或數百個就行了。還是比較有限的計算量。兩者對比，<strong>還是EnKF可行性更高。此外，EnKF不涉及切線模式的截斷誤差，對於非線性模式也沒有太大障礙</strong>。</li><li>EnKF的不足: 需要透過添加擾動來產生集合</li></ol></li></ol></li></ol><p>The computational cost of variational assimilation lies in the multiple iterations of the optimization algorithm and the potential for non-convergence. In contrast, the cost of sequential assimilation comes from the need to use ensembles to estimate uncertainty, resulting in a significant computational load from integrating multiple model runs.</p><h1 id="disturbation-method">Disturbation method</h1><ul><li>典型的擾動方式是<strong>奇異向量（Singular Vector）擾動</strong>，即先計算初始場中的快速增長模態（奇異向量），然後在這些方向上添加擾動。這種方法能夠<strong>有效捕捉初始場中不確定性成長最快的模式，進而提高集合預報的離散度</strong>。</li><li>另一個熱門的擾動方式為<strong>隨機擾動參數化傾向方案（Stochastically Perturbed Parameterization Tendencies，SPPT）</strong>，透過在物理參數化方案的傾向項中引入隨機擾動，來表徵模式不確定性。相較於完全隨機的擾動方式，上述方法產生的擾動場通常具有空間和時間上的自相關性，並確保一定的物理合理性。</li></ul><p>對於集合預報的結果，集合成員的平均值被視為確定性預報，主要用於評估集合預報的平均表現。確定性預報指標包括平均絕對誤差（MAE），均方根誤差（RMSE）等。而機率預報指標用於評估集合預報的機率分佈特性，衡量預報的可靠性和不確定性，包括 <strong>連續排位機率評分（CRPS），可靠性（Reliability），集合離散度（Spread）</strong>等。其中集合離散度通常由集合成員的標準差表示，用於衡量集合成員與集合平均值之間的差異。在集合預報中，集合離散度與集合平均的均方根誤差（RMSE）之間的關係被用來衡量集合預報系統的可靠性。理論上，一個可靠的集合預報系統的集合離散度應與集合平均預報誤差大致相當。這種特性在集合預報領域通常被稱為一致性（Consistency）。</p><h1 id="the-inremental-method-增量法">The inremental method (增量法)</h1><ul><li><a href="https://link.zhihu.com/?target=https%3A//rmets.onlinelibrary.wiley.com/doi/10.1002/qj.49712051912">Courtier et al. 1994, A strategy for operational implementation of 4D-Var, using an incremental approach</a></li></ul><p>增量法由 Courtier 提出，此方法主要應用在三維或四維變分同化中，特別是在四維變分同化（4DVar）時。在把4DVar業務化的過程中，要考慮同化的時效性，而同化中 <span class="math inline">\(x\)</span> 向量的維度可達 <span class="math inline">\(10^7\)</span> 到 <span class="math inline">\(10^9\)</span> 。4DVar 中伴隨模式後向積分的計算量是傳統數值模式（NWP）計算量的兩倍，從而使4DVar進行一次迭代的計算量是數值模式計算量的三倍。再加上數值模式本身的非線性特點，使得同化中損失函數的收斂速度很慢。<strong>增量法理論上是用精確度換時間的方法（a cost-benefit trade-off）</strong>。增量法的使用要結合變分求解時所使用的<strong>內循環 (inner loop)</strong> 和 <strong>外循環 (outer loop)</strong> 過程。</p><h1 id="references">References</h1><ol type="1"><li>朱国富, 2015. 数值天气预报中分析同化基本方法的历史发展脉络和评述. 气象, 41(8): 986-996. DOI: 10.7519/j.issn.1000-0526.2015.08.008.</li><li>朱国富, 2015. 理解大气资料同化的根本概念[J]. 气象, 41(4): 456-463. DOI:10.7519/j.issn.1000-0526.2015.04.008</li><li><a href="https://indico.cern.ch/event/289770/contributions/664473/attachments/541326/746202/DA_CERN_Perianez.pdf">2014: Data Assimilation in Numerical Weather Prediction models</a></li><li><a href="https://www.cwa.gov.tw/Data/climate/Info/lectures/100/20180517_Chen.pdf">2018: 中央氣象局全球資料同化系統</a></li><li><a href="https://curian127.github.io/From3dVarToEnKF.html">数据同化的算法演变：3DVar、EKF、EnKF (<strong>推薦</strong>)| 海洋学院，沈浙奇，2024年6月</a></li><li><a href="https://zhuanlan.zhihu.com/p/410765956">资料同化中的增量法（The inremental method）</a></li></ol>]]></content>
    
    
    <categories>
      
      <category>DA</category>
      
    </categories>
    
    
    <tags>
      
      <tag>NWP</tag>
      
      <tag>WRF</tag>
      
      <tag>MPAS</tag>
      
      <tag>DA</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ML | ONNX Open Neural Network Exchange</title>
    <link href="/2024/09/23/ONNX/"/>
    <url>/2024/09/23/ONNX/</url>
    
    <content type="html"><![CDATA[<h1 id="onnx-open-neural-network-exchange">ONNX Open Neural Network Exchange</h1><p>ONNX is an open format built to represent machine learning models. ONNX defines a common set of operators - the building blocks of machine learning and deep learning models - and a common file format to enable AI developers to use models with a variety of frameworks, tools, runtimes, and compilers.</p><ul><li>ONNX was originally named Toffee and was developed by the PyTorch team at Facebook. In September 2017 it was renamed to ONNX and announced by Facebook and Microsoft. Later, IBM, Huawei, Intel, AMD, Arm and Qualcomm announced support for the initiative.</li><li>In October 2017, Microsoft announced that it would add its Cognitive Toolkit and Project Brainwave platform to the initiative.</li><li>In November 2019 ONNX was accepted as graduate project in Linux Foundation AI.</li><li>In October 2020 Zetane Systems became a member of the ONNX ecosystem.</li></ul><p>隨著深度學習技術的發展，越來越多的框架被開發出來以滿足不同的需求。然而，不同的框架之間缺乏互通性可能會限制模型的部署和遷移能力。 Open Neural Network Exchange (ONNX) 格式旨在解決這個問題，它提供了一種標準化的方法來表示機器學習模型，從而實現了不同框架之間的模型轉換和共用。本文將探討如何在不同的深度學習框架之間有效率地轉換和部署模型，並提供一些實際的程式碼範例。</p><p>ONNX 是一種開放格式，用於表示機器學習模型，支援各種框架之間的模型轉換。 ONNX 支援多種常見的神經網路結構和操作，包括卷積、池化、活化函數等。透過 ONNX，開發者可以在一個框架中訓練模型，然後將其轉換為 ONNX 格式，最後在另一個框架中載入並執行。</p><h1 id="pytorch">Pytorch</h1><p>PyTorch export model with ONNX format</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs python">PyTorch 匯出模型<br><span class="hljs-keyword">import</span> torch<br><span class="hljs-keyword">import</span> torchvision.models <span class="hljs-keyword">as</span> models<br>從 torch.onnx <span class="hljs-keyword">import</span> export<br><br><span class="hljs-comment"># 載入預先訓練的 ResNet-18 模型</span><br>model = models.resnet18(pretrained=<span class="hljs-literal">True</span>)<br>model.<span class="hljs-built_in">eval</span>()<br><br><span class="hljs-comment"># 匯出模型到 ONNX 格式</span><br>dummy_input = torch.randn(<span class="hljs-number">1</span>, <span class="hljs-number">3</span>, <span class="hljs-number">224</span>, <span class="hljs-number">224</span>)<br>export(model, dummy_input, <span class="hljs-string">&quot;resnet18.onnx&quot;</span>, verbose=<span class="hljs-literal">True</span>, opset_version=<span class="hljs-number">11</span>)<br></code></pre></td></tr></table></figure><p>Loading ONNX models by PyTorch</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> onnxruntime <span class="hljs-keyword">as</span> ort<br><br><span class="hljs-comment"># 載入 ONNX 模型</span><br>ort_session = ort.InferenceSession(<span class="hljs-string">&quot;resnet18.onnx&quot;</span>)<br><br><span class="hljs-comment"># 預處理輸入數據</span><br>data = torch.randn(<span class="hljs-number">1</span>, <span class="hljs-number">3</span>, <span class="hljs-number">224</span>, <span class="hljs-number">224</span>).numpy()<br><br><span class="hljs-comment"># 運行模型</span><br>ort_inputs = &#123;<br> ort_session.get_inputs()[<span class="hljs-number">0</span>].name: data&#125;<br>ort_outs = ort_session.run(<span class="hljs-literal">None</span>, ort_inputs)<br><br><span class="hljs-comment"># 輸出預測結果</span><br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Output:&quot;</span>, ort_outs)<br></code></pre></td></tr></table></figure><h1 id="最佳實踐">最佳實踐</h1><ul><li>選擇合適的 ONNX 版本：ONNX 不斷更新以支援新的操作和改進效能。選擇最新的 ONNX 版本通常可以獲得更好的支援和效能。</li><li>驗證模型轉換：轉換模型後，應確保 ONNX 模型的行為與原生模型一致。可以透過比較兩個模型在相同輸入上的輸出來進行驗證。</li><li>檢查模型相容性：不是所有的框架都支援所有 ONNX 操作。確保目標框架支援你的模型中使用的操作。</li><li>最佳化模型：在匯出為 ONNX 格式之前，請考慮使用框架提供的工具進行模型最佳化，例如量化、剪枝等。</li><li>文件和測試：記錄轉換過程中的重要步驟，並進行充分的測試以確保模型的正確性和效能。</li></ul><h1 id="references">References</h1><ol type="1"><li><a href="https://onnx.ai/">https://onnx.ai/</a></li><li><a href="https://developer.aliyun.com/article/1598009">ONNX 模型互操作性的最佳实践</a></li><li><a href="https://learn.microsoft.com/zh-tw/azure/machine-learning/concept-onnx?view=azureml-api-2">ONNX 與 Azure Machine Learning</a></li><li><a href="https://datawhalechina.github.io/thorough-pytorch/%E7%AC%AC%E4%B9%9D%E7%AB%A0/9.1%20%E4%BD%BF%E7%94%A8ONNX%E8%BF%9B%E8%A1%8C%E9%83%A8%E7%BD%B2%E5%B9%B6%E6%8E%A8%E7%90%86.html#id7">9.1 使用ONNX进行部署并推理</a></li></ol>]]></content>
    
    
    <categories>
      
      <category>ML</category>
      
    </categories>
    
    
    <tags>
      
      <tag>AI</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>HPC 高性能计算平台</title>
    <link href="/2024/09/21/HPC/"/>
    <url>/2024/09/21/HPC/</url>
    
    <content type="html"><![CDATA[<h1 id="為什麼-hpc-如此重要">為什麼 HPC 如此重要？</h1><p>高效能運算 (HPC) 已不是新鮮事。數十年來，HPC 工作站和超級電腦在學術研究中扮演著不可或缺的角色，解決了複雜的問題並激發了發現和創新。近年來，數據量迅速激增，許多新的應用程式受益於 HPC 的強大功能，即跨共享資源執行運算密集型操作的能力，相較於傳統運算以更少的時間和更低的成本獲得結果。與此同時，HPC 硬體和軟體變得更容易獲得並且廣泛分佈。科學家、工程師和研究人員在一系列使用案例中仰賴著 HPC，包括天氣預報、石油和天然氣勘探、物理學、量子力學以及學術研究和商業應用的其他領域。</p><p>對於每一個涉及計算的課題組來說，購買超算機時還是建立自己的伺服器集群，成為了每個課題組的考量。筆者建議課題組針對專案需求，兩者靈活配置，不存在東風壓倒西風的說法；對於超算資源來說，短時間以較小的經費就可以撬動極大的計算資源，對於專案驗證或緊急的專案需求都是非常好的補充，對於許多大型專案的進展，沒有超算談何開展。當然回歸到課題組的實際需求，自建伺服器集群才是每個課題組最划算的算力投資。</p><h2 id="flops">FLOPS</h2><p>超級電腦速度以每秒浮點運算次數 <strong>"FLOPS" (floating-point operations per second, flops)</strong>來作量度單位，常見的表示電腦中的峰值或速度用的單位英漢對照如下：</p><ul><li>一個MFLOPS（megaFLOPS）等於每秒100萬（=<span class="math inline">\(10^6\)</span>）次的浮點運算</li><li>一個GFLOPS（gigaFLOPS）等於每秒10億（=<span class="math inline">\(10^9\)</span>）次的浮點運算</li><li>一個TFLOPS（teraFLOPS）等於每秒1兆（=<span class="math inline">\(10^{12}\)</span>）次的浮點運算</li><li>一個PFLOPS（petaFLOPS）等於每秒1千兆（=<span class="math inline">\(10^{15}\)</span>）次的浮點運算</li><li>一個EFLOPS（exaFLOPS）等於每秒100京（=<span class="math inline">\(10^{18}\)</span>）次的浮點運算</li></ul><p>此外，由於浮點積和熔加運算或乘積累加是兩次的浮點運算（每條FMA指令包括加/減及乘），因此當處理器支援FMA指令時，峰值是兩倍每秒所能執行FMA指令的數目。</p><h3 id="cpu-flops">CPU flops</h3><ul><li>计算节点 1, 每个节点配置2颗intel Xeon Gold 6248 CPU, 双精度浮点计算性能 3.20 Tflops</li><li>计算节点 1, 每个节点配置2颗intel Xeon Platinum 8358 CPU, 双精度浮点计算性能 5.32 Tflops</li><li>計算節點：2顆 Intel® Xeon® Platinum 8280 2.4GHz CPU (28 Cores/CPU) 與 192GB 主記憶體, 3 Tflops</li><li>計算節點：2顆 Intel® Xeon® Platinum 8480+ 2.0GHz CPU (56 Cores/CPU) 與 512GB 主記憶體, 6.27 Tflops</li></ul><h3 id="gpu-flops">GPU flops</h3><ul><li>NVIDIA Tesla V100，双精度浮点计算能力 924 Tflops</li></ul><h2 id="top500">TOP500</h2><ul><li><a href="https://top500.org/" class="uri">https://top500.org/</a></li></ul><h1 id="文章">文章</h1><h2 id="超級電腦爭霸戰的新一頁開始了exascale10-的-18-次方之戰-20220910"><a href="https://pansci.asia/archives/352429">超級電腦爭霸戰的新一頁開始了：Exascale（10 的 18 次方）之戰 | 2022/09/10</a></h2><ul><li>超級電腦的架構，可以說是非常的簡單：用網路線連結各台主機，讓主機間互相溝通，才能夠進行平行運算。</li><li><strong>考驗硬體的處理能力、主機間節點的連線架構、資料讀寫能力，更甚者，則是軟體是否具有 Exascale 的使用能力，也就是硬體與軟體都必須要能夠良好的契合才行。</strong></li><li>地球系統模擬中，其中一個挑戰便是進行模擬時程：挑戰一日（24 小時）的超級電腦計算可以得到多少年的模擬結果（<strong>simulated years per wall-clock day, SYPD</strong>），而此地球系統的精度為水平方向僅一公里的超高解析度，用來進行最終極的地球系統模擬：<strong>數位攣生（Digital Twins</strong>）。</li><li>Neumann 等人也預計在 2030 年代後，進行 1 公里等級的超高精度計算也將不是夢想，而在 Exascale 主機降臨前的這個年代，有些超級計算中心已經以節點（Node）做為計算資源耗費的單位（<strong>Node per hour</strong>），而非 CPU per hour，顯示出大型主機對計算資源消耗的想法以從 CPU 規模上升到了 Node 規模。</li></ul><div class="note note-danger">            <p>目前已經有部份超級電腦都在進行 SYPD 的挑戰，如中國的神威太湖之光，其已完成了每日 3.4 年的地球系統模擬，只不過其地面僅有 25 公里的水平精度，海面僅 10 公里的水平精度，還有非常多的進步空間。只可惜，這個實驗並沒有進行進行資料輸出，無法得到正確的效能結果（資料的寫入與輸出也是非常費時的），以及真正的運算結果：因為沒有資料，就沒有辦法分析。</p>          </div><h1 id="超算-價格">超算: 價格</h1><p>超算中心產品的特點：完備的軟體運行環境及豐富的軟體選擇，穩定的技術支持，按需使用，靈活充值；缺點：昂貴且不易於管理，容易不知不覺就消耗了寶貴的科研經費（筆者接觸過課題組購置數萬機時，沒有有效管理，學生學習與試誤的過程中，就消耗殆盡；）</p><ul><li>1毛 = 1/10元 (人民幣)</li><li>超算中心價格基本上在0.1-0.3元一個核時(人民幣)，單價看起來還是不貴。</li><li>通常超算中心中主流的64核心節點，一般單價在0.1元每核心時，基於此計算一台64核心的伺服器長期租用，他的成本將會是：</li><li>每天的費用：64x0.1x24=153.6元；每年的費用可能高達56064元；目前一台超算中心的64核心節點，基本市場價格也就在5萬左右；我們也核算過各類伺服器配置，基本上超算同類的運算伺服器，租賃1年的費用，就等於您訂購這台伺服器費用了。</li><li>顯然從長期使用運算資源的角度來說，顯然自建自己的伺服器叢集是課題組更划算的選擇。</li><li>其次：自有的伺服器資源，可以做到更靈活的使用，軟體安裝也非常自由；文件資料本地存儲，使用快捷簡易等優點。</li></ul><p>首先说现在的超算价格：<a href="https://www.zhihu.com/question/523757254/answer/2530239695?utm_psn=1821112184379412482">link</a></p><ul><li>以北京超级云计算中心为代表的，主流超算中心，价格通常不超过0.1元每核时（搞活动的时候0.08元左右），按照题主描述，10万核时约需要8000~1万元。论性价比的话，</li><li>我更推荐一些不太知名的，价格从0.05到0.08元每核时不等。</li><li>其次，题主描述的10万核时应该是按照自己的18核至强计算出来的。不同CPU的性能差距很大，举个例子，<strong>AMD 7601计算1小时的，AMD 7452可能40分钟甚至半小时就算完了</strong>。最后，讨论下自己搭机器与租超算的优缺点。自己搭建机器，肯定无法兼顾性能与价格，例如预算6000以内的话，估计只能买1台双路AMD 7601，可能无法满足短时间内算完全部算例的需求。好处就是机器实打实的是自己的，这10万核时的任务算完了以后，机器还可以干别的用途，甚至卖了回血也可以。而超算与之相反，可以提供最高的算力，满足短期内大量的计算需求。缺点就是算完以后自己啥都留不下。</li></ul><p>实际上并行科技早就已经将超算商业化了，对于普通人也非常友好。我有个同学，自己有计算需求，但是课题组其他人没兴趣，她就自费只充了100块钱就够用了。就像充话费一样简单，使用也非常方便，超算就是一台远程linux电脑，远没有多数人想象的多么高冷神秘。<a href="https://www.zhihu.com/question/280917515/answer/1487285453">Link</a></p><p>例子:</p><ul><li>10万核时，0.1元每核时，需要1万人民币。</li></ul><h2 id="集群">集群</h2><ul><li><a href="http://www.chinahpc.com/">北京东方超算科技有限公司, ChinaHPC</a><ul><li>成立于2013年，创始团队来自于北京市计算中心和中国科学院超级计算中心，注册资金1000万元，坐落在北京市海淀区上地信息产业基地。</li><li><a href="http://www.chinahpc.cn/">东方超算云</a><ul><li>东方超算云的大规模算力集群位于全国一体化算力网络国家枢纽节点<strong>内蒙古自治区</strong></li><li>一期建设360个18KW高密度机柜，计算节点2000台，56000CPU核心，20PB分布式并行存储容量</li><li><a href="https://cloud.chinahpc.cn/#/login">Login website</a></li><li>公共计算平台服务资源<ul><li><strong>A区资源（0.1元核心小时）</strong>; 面向HPC、AI客户; 160节点; 处理器:2*Intel® Xeon® Platinum 9242 Processor（48核心、96线程、基础主频2.3GHz）; 内存：24x16GB 2933MHz，共384GB</li><li><strong>B区资源（0.08元核心小时）</strong>：面向大规模分布式并行，追求性价比用户; 1000节点; 处理器： Intel® Xeon® Processor E5-2680 v4 （28核心，基础主频2.4GHz，最大睿频3.3GHz); 内存：8*16GB ,共128GB 内存; 网络：Mellanox FDR 56Gb Infiniband</li></ul></li></ul></li></ul></li><li><a href="https://www.nscc-tj.cn/">国家超级计算天津中心, 天河一号</a><ul><li>中國人民解放軍國防科學技術大學和天津濱海新區提供的異構超級電腦</li><li>啟用時間: 天河-1：2009年10月29日，天河-1A：2010年10月28日</li><li>天河-1A使用的開源軟體包括：Linux作業系統，SLURM作業調度系統，Lustre叢集檔案系統</li><li>0.07元/核时，配置：单节点12核 , Intel Hexa Core Xeon X5670 ；主频 2.93GHz, 内存48G，私有高速网络，免费存储1TB</li></ul></li><li><a href="http://nscc-gz.cn/Product/HighPerformanceComputingService/ServiceCharacteristics.html">国家超级计算广州中心, 天河二号</a><ul><li>中山大學廣州校區東校園</li><li>啟用時間: 2013年</li><li><code>天河二号</code>拥有约<strong>17920个计算节点</strong>，每节点配备两颗Xeon E5系列12核心的中央处理器、三个Xeon Phi 57核心的协处理器（运算加速卡），总内存容量约1.4PB，全局存储总容量约12.4PB。</li><li>0.1元/核时，配置：单节点24核 , Intel Xeon E5-2692 v2 ；主频 2.2GHz, 内存64G，内存频率：DDR3 1333MHz，免费存储500GB</li><li><a href="https://www.gov.cn/xinwen/2015-11/18/content_2967705.htm">54.9PFLOPS（理論峰值）, 实际运算速度33.86PFlops</a></li><li><a href="https://itlanyan.com/tianhe-ii-guide/">天河二号使用教程</a></li></ul></li><li><a href="https://www.nscc-tj.cn/cjjs_zy_th3">国家超级计算天津中心同国防科技大学联合研制, 天河三号, （E级）超级计算机</a><ul><li>https://baike.baidu.com/item/%E5%A4%A9%E6%B2%B3%E4%B8%89%E8%99%9F/22052788</li><li><a href="https://www.weidunews.com/article/2024-02-18/1340.html">科技媒体解构中国迄今为止最强大的超级计算机</a></li></ul></li><li><a href="https://nscc.hnu.edu.cn/info/1058/1063.htm">国家超级计算长沙中心</a><ul><li>中心拥有“天河”系列超级计算机、“天河·天马”计算集群等计算平台。其中2022年建成的天河新一代主机系统采用全国产设备，峰值计算性能达200P Flops（64 位精度），可提供1000P Ops人工智能算力（16位精度）</li><li>“天河一号”高性能计算系统, 单节点配置：2*6核Intel Xeon Westmere EP，主频2.93GHz，内存48GB，1块Nvidia M2050 GPU</li><li>CPU：0.10元/核/小时；GPU：2元/块/小时；纯CPU（120核包年）：5万元/年。含GPU（120核包年）：10万元/年。<a href="https://nscc.hnu.edu.cn/info/1004/1414.htm">国家超级计算长沙中心2019年收费基本执行标准 2019</a></li><li>存储服务：天河存储0.5万元/TB/年；其它存储0.3万元/TB/年</li></ul></li><li><a href="http://www.nsccsz.cn/nsccsz2024/index.shtml">国家超级计算深圳中心(深圳云计算中心)</a><ul><li>深圳超算一期, 深圳超算二期</li><li>高性能计算集群约有3000余计算节点，CPU约70000核，总内存容量约230TB，全局存储总容量约20PB</li></ul></li><li><a href="https://www.nsccwx.cn/">神威·太湖之光</a><ul><li>啟用時間: 2015年12月31日</li><li>部署在江蘇省無錫市的國家超級計算無錫中心，由清華大學負責營運</li><li>整机处理器个数 40960个</li><li>峰值性能为 125.436 PFlops</li><li>它的浮点运算速度达到了 90.83 PFlops（1PFlops为每秒1千万亿次浮点运算），超越第二名“天河二号”（33.06PFlops）近两倍。而且，与“天河二号”使用Intel芯片有所不同，它使用的芯片具有中国自主知识产权。<a href="https://www.cma.gov.cn/2011xwzx/2011xqxxw/2011xqxyw/201606/t20160622_314708.html">Link</a></li></ul></li><li><a href="http://www.blsc.cn/aboutus/">北京超级云计算中心</a><ul><li>成立于2011年，中国科学院和北京市政府共建，由北京北龙超级云计算有限责任公司运营</li><li>推荐使用T6区，配置：单节点96核，按核计费，Intel Xeon Platinum 9242@2.3GHz，384G内存，100Gps 高速网，免费存储500G，价格1毛/核时=0.1/核时。（用的多会有一些折扣）</li></ul></li><li><a href="https://hpc.pku.edu.cn/about.html">北京大学高性能计算校级公共平台</a><ul><li><a href="https://hpc.pku.edu.cn/ug/">北京大学高性能计算校级公共平台用户文档</a></li><li>每个CPU时0.06元, <a href="https://hpc.pku.edu.cn/guide_6.html">收费标准</a></li></ul></li><li><a href="http://hpc.ncpgr.cn/">作物遗传改良全国重点实验室生物信息计算平台</a><ul><li>生物信息高性能计算平台为华中农业大学作物遗传改良全国重点实验室公共技术平台，专注为实验室及全校用户提供高通量测序数据的存储和计算服务。</li><li>平台由155个刀片计算节点、2个GPU节点、6个八路大内存胖节点、多套并行存储组成，总体计算能力理论峰值为380万亿次，CPU核心数为5600核，存储硬件12.7PB(可用容量8.8PB)，主存储读写带宽超过45GB/s。平台预装了1000余款各类生物信息分析软件及相关使用文档、各类常用生物信息数据库，用户可使用本平台进行转录调控测序、单细胞测序、三维基因组测序、表观组测序、基因组组装注释等各类常见组学数据分析。可加速大规模重测序数据分析、复杂大基因组组装注释等需消耗大量资源的分析项目。</li><li>每个CPU时0.1元，并行存储空间每GB每月0.05元。重点室用户3折；重点实验室之外的用户不打折。根据用户上报的上一年度的文章，决定本年度的集群机时折扣。</li></ul></li><li><a href="https://hpc.whu.edu.cn/index.htm">武汉大学超级计算中心</a><ul><li>由475台CPU服务器、168台KNL服务器和174台GPU服务器组成</li><li>武汉大学超级计算中心收费办法（试行）2024年03月29日 <a href="https://hpc.whu.edu.cn/info/1008/1057.htm">link</a></li><li>普通节点 用户类型 CPU机时收费标准（元/CPU核小时）校内用户 0.06; 校外用户 0.10 <a href="https://hpc.whu.edu.cn/info/1008/1057.htm">link</a></li><li>存储空间租用服务</li><li>用户类型 收费标准（元/T年) 校内用户 120; 校外用户 500</li></ul></li><li><a href="https://scc.ustc.edu.cn/2010/0304/c386a1641/page.htm">中国科学技术大学超级计算中心</a><ul><li>瀚海 22 超级计算系统, 瀚海 20 超级计算系统, 曙光 TC4600 百万亿次超级计算系统</li><li><a href="https://scc.ustc.edu.cn/zlsc/user_doc/html/introduction/hanhai22-introduction.html">中国科大超算中心用户使用手册</a></li><li><a href="https://scc.ustc.edu.cn/2024/0228/c416a630736/page.htm">中国科学技术大学超级计算中心收费标准2023年11月15日版</a></li><li>CPU节点 0.02元/CPU核小时</li><li>免费使用1TB的存储容量，超过1TB后为30.00元/TB月</li><li>校外用户收费为校内用户的3倍</li></ul></li><li><a href="https://hpc.nuaa.edu.cn/xnpz/list.htm">南京航空航天大学 - 硬件资源 - 高性能计算中心</a><ul><li>长空1号：2020年6月建成，包含CPU计算节点62个，每个节点配置2颗intel Xeon Gold 6248 CPU，合计2480核，双精度浮点计算性能198.4Tflops；GPU节点有12个（3台4卡节点），配置均为NVIDIA Tesla V100，双精度浮点计算能力924Tflops。</li><li>长空2号：2022年9月建成，包含CPU计算节点256个，每个节点配置2颗intel Xeon Platinum 8358 CPU，合计16384核心，双精度浮点计算性能1363.15Tflops。</li><li>AI深度学习平台：AI深度学习平台是基于学校高性能计算平台硬件基础，面向人工智能、深度学习、大模型训练等领域的算力调度平台，功能涵盖数据集、算法、框架和模型的分类管理，并提供TensorFlow、PyTorch等常用深度学习框架和库。平台2024年5月正式上线运行，包含64张NVIDIA Tesla V100 GPU卡(16台4卡GPU节点)，适合开展大规模数据处理与分析、复杂算法训练等。</li></ul></li><li><a href="https://sc.hdu.edu.cn/">杭州电子科技大学超算中心</a><ul><li>曙光TC6000高性能计算集群有CPU计算节点68个</li><li><a href="https://sc.hdu.edu.cn/wp-content/uploads/2024/05/%E5%85%B3%E4%BA%8E%E5%85%AC%E5%B8%832024%E5%B9%B4%E5%BA%A6%E8%B6%85%E7%AE%97%E4%B8%AD%E5%BF%83%E6%94%B6%E8%B4%B9%E6%A0%87%E5%87%86%E7%9A%84%E9%80%9A%E7%9F%A5.pdf">关于公布 2024 年度超算中心收费标准的通知</a></li><li>校内用户 CPU 节点 0.06 元／核·小时; 存储空间 超出 200GB 部分，每100GB 费用为 10 元/月</li><li>校外用户 CPU 节点 0.12 元／核·小时; 存储空间 超出 200GB 部分，每100GB 费用为 20 元/月</li></ul></li></ul><h1 id="cpu">CPU</h1><ul><li><strong>Intel Xeon Phi 7250</strong> is designed for highly parallel workloads with a significant number of threads.</li><li><strong>E5-2680 v3 and v4</strong> are part of the Xeon E5 family, providing a balance of performance and efficiency for data center applications.</li><li><strong>Gold 6248R and 6342</strong> are part of the Xeon Gold series, offering high core counts and advanced memory capabilities, suitable for demanding HPC tasks.</li></ul><table><thead><tr class="header"><th>Name</th><th>Launch Date</th><th>Base Frequency (GHz)</th><th>Physical Cores</th><th>Threads</th><th>Cache (MB)</th><th>Price (Approx.)</th><th>TDP (W)</th><th>Max Memory Size</th><th>Memory Types</th><th>Instruction Set Extensions</th></tr></thead><tbody><tr class="odd"><td>Intel Xeon Phi CPU 7250</td><td>Q2'16</td><td>1.40</td><td>68</td><td>272</td><td>34</td><td>~$2,500</td><td>215</td><td>384 GB</td><td>MCDRAM, DDR4-2400</td><td>AVX-512</td></tr><tr class="even"><td>Intel Xeon CPU E5-2680 v3</td><td>Q3'14</td><td>2.50</td><td>12</td><td>24</td><td>30</td><td>~$1,745</td><td>120</td><td>768 GB</td><td>DDR4-2133</td><td>AVX 2.0</td></tr><tr class="odd"><td>Intel Xeon CPU E5-2680 v4</td><td>Q1'16</td><td>2.40</td><td>14</td><td>28</td><td>35</td><td>~$1,745</td><td>120</td><td>1.5 TB</td><td>DDR4-2400</td><td>AVX 2.0</td></tr><tr class="even"><td>Intel Xeon Gold 6248R CPU</td><td>Q1'20</td><td>3.00</td><td>24</td><td>48</td><td>35.75</td><td>~$2,700</td><td>205</td><td>1 TB</td><td>DDR4-2933</td><td>AVX-512</td></tr><tr class="odd"><td>Intel Xeon Gold 6342 CPU</td><td>Q2'21</td><td>2.80</td><td>24</td><td>48</td><td>36</td><td>~$2,529</td><td>230</td><td>6 TB</td><td>DDR4-3200</td><td>AVX-512</td></tr></tbody></table>]]></content>
    
    
    <categories>
      
      <category>HPC</category>
      
    </categories>
    
    
    <tags>
      
      <tag>HPC</tag>
      
      <tag>NWP</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Singularity (Apptainer) Container</title>
    <link href="/2024/09/21/Singularity-Container/"/>
    <url>/2024/09/21/Singularity-Container/</url>
    
    <content type="html"><![CDATA[<h1 id="what-is-singularity">What is Singularity</h1><p>Singularity is a container platform to run complex applications on HPC clusters in a simple, portable, and reproducible way. It supports Docker images and is an alternative to Docker, whose security model and execution mode are not well-suited in an HPC environment.</p><p>Major features:</p><ul><li>Verifiable reproducibility and security, using cryptographic signatures, an immutable container image format, and in-memory decryption.</li><li>Integration over isolation by default. Easily make use of GPUs, high speed networks, parallel filesystems on a cluster or server by default.</li><li>Mobility of compute. The single file SIF container format is easy to transport and share.</li><li>A simple, effective security model. You are the same user inside a container as outside, and cannot gain additional privilege on the host system by default.</li></ul><p>容器是一種在隔離環境中運行應用程式的技術。與傳統虛擬機器 （VM） 相比，它們具有多項優勢，例如 更快的部署時間和可重複性。容器還允許開發人員建置和部署軟體，無需擔心底層基礎設施或作業系統詳細資訊。在生物資訊分析中，使用Singularity 容器技術具有以下優點：</p><ul><li>環境一致性和可重複性：專案常常依賴特定版本的軟體和函式庫。 Singularity 容器可以將軟體及其相依性打包在一起，確保分析環境的一致性，無論是在本機、伺服器或雲端平台。這對於實驗的可重複性至關重要，因為它保證了其他研究者可以準確地複製實驗條件，驗證和復現研究結果。</li><li>高效能運算（HPC）友善：Singularity 特別設計來支援高效能運算環境。<strong>它允許使用者以非特權方式運行容器，與 HPC 系統的安全模型相容。這意味著使用者可以在不需要管理員權限的情況下部署和執行容器，這對於多使用者的HPC環境是非常重要的。</strong></li><li>移植性：Singularity 容器可以在任何支援 Singularity 的系統上運行，不受作業系統版本限制。這種高度的移植性確保了生物資訊分析可以輕鬆地從一個運算環境遷移到另一個，無論是從個人電腦到雲端平台，還是在不同的研究機構之間共享。</li><li>資料和資源存取：Singularity 容器可以直接存取宿主機上的檔案系統和網絡，這簡化了資料的管理和傳輸過程。對於需要處理大量資料的生物資訊分析來說，能夠無縫存取外部資料儲存非常重要。</li><li>安全性：與其他容器技術相比，Singularity 提供了更強的安全保障。它防止了容器內的使用者取得宿主機的 root 權限，減少了安全風險。這一點對於確保生物資訊學資料的安全性尤其重要，特別是在處理敏感或受保護的資料時。</li></ul><p>From <a href="https://hpc.pku.edu.cn/_book/guide/soft/singularity.html">北京大學高效能運算平台</a>, <a href="https://hpc.pku.edu.cn/ug/guide/soft/singularity/">北京大學高效能運算校級公共平台使用者文檔</a></p><p>容器技術是一種以應用軟體為中心的虛擬化技術。以應用軟體為單元，將軟體及所有的依賴性打包成容器鏡像，打包後的容器鏡像可直接拷貝到不同的Linux主機上運作。透過容器技術，可以很好的解決安裝軟體時，依賴庫的安裝問題、軟體環境的隔離以及軟體環境的移植問題。</p><ul><li>Singularity為勞倫斯伯克利國家實驗室開發專門用於高效能運算場景的容器技術，Singularity完全基於可移植性進行虛擬化，更加輕量級，部署更快，Singularity目前被廣泛地各高效能運算中心。</li><li>透過Singularity來滿足作業運行的軟體環境，首先是創建或取得軟體鏡像，再將創建好的軟體鏡像上傳到叢集上運行；</li><li><strong>透過Singularity建立軟體映像，需要在有root權限的Linux主機上，或是在配置好fakeroot的Linux主機上以「fakeroot」的身份進行。</strong></li></ul><p>使用容器部署和使用軟體環境的步驟如下： 建構容器鏡像，建構容器鏡像的方式有三種：</p><ul><li>在本機擁有 root 權限的 Linux 主機上安裝 Singularity， 並使用 Singularity 部署容器鏡像；</li><li>在支援 fakeroot 的伺服器上，使用 Singularity 部署容器鏡像；</li><li>直接從倉庫中拉取已經建置好的容器鏡像；</li><li>將容器鏡像上傳到集群，透過 singularity 指令使用建構好的容器鏡像。</li></ul><p>容器的優點和缺點(相較於編譯安裝以及 conda 安裝管理軟體，容器有幾個十分明顯的優勢)</p><p>容器的優勢</p><ul><li>可移植性，透過容器部署好運算環境後，可以直接上傳到社會上高效能運算叢集上使用，也可以直接將容器鏡像分享給課題組的其他成員直接使用，大幅減少了部署環境的時間。</li><li>可複現性，尤其是一些生信軟體，依賴不同的計算工具，換個人安裝，雖然安裝的軟體版本相同，但是依賴的計算工具版本不同，都可能導致計算結果存在差異，而容器的使用可以很好的避免這個問題。</li><li><strong>易管理，不同容器相互隔絕，不存在依賴衝突等問題，例如平台上使用conda 打包了ncl、nco 和ncview，因為這些工具在安裝的時候同時也打包了netcdf 庫，如果用戶在編譯如cesm 和wrf等依賴netcdf 環境的軟體，可能會導致編譯和使用過程出現衝突。</strong></li></ul><p>容器有著這麼多的優點，效能損耗還低，有時候甚至還優於裸機效能，是否就代表所用運算軟體環境都適合用容器部署？答案是否定的，容器其實也有一些缺點需要使用者留意：</p><p>容器的缺點</p><ul><li>使用難度高，相較於裸機上安裝和使用軟體，容器概念的理解、接受還有使用還是需要一定門檻的</li><li><strong>跨節點應用由於要呼叫宿主機的 mpi ，相容性有一定的要求，可移植性需要驗證。</strong> 當然，平台也在致力於跨節點應用容器化的測試與打包</li><li><strong>最佳化問題，例如為了讓軟體運行更快，Intel 編譯軟體過程中可能會使用-Host 參數，讓編譯器根據主機CPU 型號進行指令優化，或者編譯過程中加入AVX512 的支持，這時候如果將鏡像移植到舊款架構的CPU 主機上，可能會導致鏡像無法正常運作軟體環境</strong></li></ul><h2 id="singularity---apptainer">Singularity -&gt; Apptainer</h2><p><strong>Apptainer (formerly Singularity)</strong> simplifies the creation and execution of containers, ensuring software components are encapsulated for portability and reproducibility.</p><ul><li>Original Singularity project (i.e. the one before Sylabs fork) is officially moving into the Linux Foundation, becoming Apptainer</li><li>Sylabs’s SingularityCE and Linux Foundation’s Singularity (i.e. Apptainer) will co-exist</li><li>SingularityCE = Apptainer (for now)</li><li>For us: <code>SingularityCE = Apptainer = Singularity</code></li></ul><h1 id="sifsingularity-image-file-sandbox">SIF（Singularity Image File）&amp; Sandbox</h1><p>兩種建立客製化 image 的方法。Singularity 的 image 支持兩種模式 sif 及 sandbox，兩者最大的差異就是 sandbox 會保留用戶在環境中，安裝的軟體及設定的參數。而 sif 則比較接近唯獨模式，僅提供環境運行所需要的套件，但當運行結束後不會保留在過程中安裝的套件。</p><ul><li>SIF（Singularity Image File）：壓縮的讀（read-only）的Singularity鏡件，是⽣產使⽤的主形式。</li><li>Sandbox 可 (writable)的器在形式，是件統中的⼀⽬錄，常⽤於開發或創建⾃⼰的容器，是開發使⽤的主形式。</li></ul><div class="note note-primary">            <p>SIF and sandbox images can be converted to each other.</p>          </div><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># 1. Convert the SIF format container to sandbox;</span><br>singularity build --sandbox centos76 centos76.sif<br><br><span class="hljs-comment"># 2. Convert the sandbox container image to SIF format;</span><br>singularity build centos76.sif centos76<br></code></pre></td></tr></table></figure><h2 id="singularity-container-image">Singularity Container Image</h2><p><a href="https://www.cuhk.edu.hk/itsc/hpc/singularity.html" class="uri">https://www.cuhk.edu.hk/itsc/hpc/singularity.html</a></p><div class="note note-primary">            <p>Note that Singularity versions prior to 3.0 used a slightly different image format, characterised by the extension .simg. You can still find these around in the web; newer Singularity versions are still able to run them.</p>          </div><p>By default, Singularity containers are <strong>read-only image file</strong> that usually end in <strong>.simg</strong>. You can copy the singuarity image file directly from others pre-build container with any copy file command like cp or scp. You can also pull the container from Docker Hub or Sinularity Hub repositories. Base on the container on the repositories, you may custom your own container desire for your job nature.</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment">#From Docker Hub</span><br>singularity pull docker://ubuntu:latest<br>singularity build centos7_python35.simg docker://centos/python-35-centos7<br>            <br><span class="hljs-comment">#From Singularity Hub</span><br>singularity pull shub://singularityhub/centos<br>singularity build tensorflow.simg shub://opensciencegrid/osgvo-tensorflow<br></code></pre></td></tr></table></figure><h1 id="installing-singularity-platform">Installing Singularity platform</h1><p><a href="https://docs.sylabs.io/guides/3.8/user-guide/quick_start.html" class="uri">https://docs.sylabs.io/guides/3.8/user-guide/quick_start.html</a></p><div class="note note-primary">            <p><strong>Docker and Singularity server installation requires root privileges</strong>, so you can choose to install Docker on your local personal computer to create an image, and then upload it to the server to run it with Singularity.</p>          </div><h2 id="install-development-libraries">install development libraries</h2><p>SingularityCE is a container platform. It allows you to create and run containers that package up pieces of software in a way that is portable and reproducible. You can build a container using SingularityCE on your laptop, and then run it on many of the largest HPC clusters in the world, local university or company clusters, a single server, in the cloud, or on a workstation down the hall. Your container is a single file, and you don’t have to worry about how to install all the software you need on each different operating system.</p><p>SingularityCE的使用不需要管理員權限,但安裝需要管理員權限</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs sh">$ <span class="hljs-built_in">sudo</span> apt-get update &amp;&amp; <span class="hljs-built_in">sudo</span> apt-get install -y \<br>    build-essential \<br>    libssl-dev \<br>    uuid-dev \<br>    libgpgme11-dev \<br>    squashfs-tools \<br>    libseccomp-dev \<br>    wget \<br>    pkg-config \<br>    git \<br>    cryptsetup<br></code></pre></td></tr></table></figure><h2 id="install-go">Install Go</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs sh">$ <span class="hljs-built_in">export</span> VERSION=1.16.4 OS=linux ARCH=amd64 &amp;&amp; \  <span class="hljs-comment"># Replace the values as needed</span><br>  wget https://dl.google.com/go/go<span class="hljs-variable">$VERSION</span>.<span class="hljs-variable">$OS</span>-<span class="hljs-variable">$ARCH</span>.tar.gz &amp;&amp; \ <span class="hljs-comment"># Downloads the required Go package</span><br>  <span class="hljs-built_in">sudo</span> tar -C /usr/local -xzvf go<span class="hljs-variable">$VERSION</span>.<span class="hljs-variable">$OS</span>-<span class="hljs-variable">$ARCH</span>.tar.gz &amp;&amp; \ <span class="hljs-comment"># Extracts the archive</span><br>  <span class="hljs-built_in">rm</span> go<span class="hljs-variable">$VERSION</span>.<span class="hljs-variable">$OS</span>-<span class="hljs-variable">$ARCH</span>.tar.gz    <span class="hljs-comment"># Deletes the ``tar`` file</span><br><br>$ <span class="hljs-built_in">echo</span> <span class="hljs-string">&#x27;export PATH=/usr/local/go/bin:$PATH&#x27;</span> &gt;&gt; ~/.bashrc &amp;&amp; \<br>  <span class="hljs-built_in">source</span> ~/.bashrc<br></code></pre></td></tr></table></figure><h2 id="download-singularityce-from-a-release">Download SingularityCE from a release</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs sh">$ <span class="hljs-built_in">export</span> VERSION=3.8.1 &amp;&amp; <span class="hljs-comment"># adjust this as necessary \</span><br>    wget https://github.com/sylabs/singularity/releases/download/v<span class="hljs-variable">$&#123;VERSION&#125;</span>/singularity-ce-<span class="hljs-variable">$&#123;VERSION&#125;</span>.tar.gz &amp;&amp; \<br>    tar -xzf singularity-ce-<span class="hljs-variable">$&#123;VERSION&#125;</span>.tar.gz &amp;&amp; \<br>    <span class="hljs-built_in">cd</span> singularity-ce-<span class="hljs-variable">$&#123;VERSION&#125;</span><br></code></pre></td></tr></table></figure><p>then, Compile</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sh">$ ./mconfig &amp;&amp; \<br>    make -C builddir &amp;&amp; \<br>    <span class="hljs-built_in">sudo</span> make -C builddir install<br></code></pre></td></tr></table></figure><p>Finally, check</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh">$ singularity --version<br>$ singularity <span class="hljs-built_in">help</span><br></code></pre></td></tr></table></figure><p>it has shown,</p><figure class="highlight vbnet"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs vbnet">Linux container platform optimized <span class="hljs-keyword">for</span> High Performance Computing (HPC) <span class="hljs-built_in">and</span><br>Enterprise Performance Computing (EPC)<br><br><span class="hljs-symbol">Usage:</span><br>  singularity [<span class="hljs-keyword">global</span> options...]<br><br><span class="hljs-symbol">Description:</span><br>......<br></code></pre></td></tr></table></figure><h1 id="building-singularity-images">Building Singularity images</h1><div class="note note-primary">            <p>當鏡像庫平台沒有找到適用的現成鏡像，使用者可以在本地將軟體打包成鏡像，上傳到超算上運行。<strong>請注意，使用者只能在自己的電腦上製作鏡像，不能在超算上製作鏡像。</strong></p>          </div><h2 id="example-build-jedi-environment-with-singularity">Example: Build JEDI environment with Singularity</h2><p>From <a href="https://wiki.ucar.edu/display/JEDI/Build+JEDI+environment+with+Singularity" class="uri">https://wiki.ucar.edu/display/JEDI/Build+JEDI+environment+with+Singularity</a></p><h3 id="jcsda-singularity-latest">JCSDA-singularity-latest</h3><p>From <a href="https://singularityhub.github.io/singularityhub-archive/containers/JCSDA-singularity-latest/" class="uri">https://singularityhub.github.io/singularityhub-archive/containers/JCSDA-singularity-latest/</a></p><p>From <a href="https://singularityhub.github.io/singularityhub-archive/containers/MBlaschek-singularity-jupyter-jedi/" class="uri">https://singularityhub.github.io/singularityhub-archive/containers/MBlaschek-singularity-jupyter-jedi/</a></p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs sh">$ singularity --version<br><br>$ singularity pull shub://MBlaschek/singularity-jupyter:jedi<br>$ ll<br>963M Sep 22 14:10 singularity-jupyter_jedi.sif<br><br>$ singularity <span class="hljs-built_in">exec</span> singularity-jupyter_jedi.sif <span class="hljs-built_in">cat</span> /etc/os-release<br>NAME=<span class="hljs-string">&quot;Ubuntu&quot;</span><br>VERSION=<span class="hljs-string">&quot;16.04.6 LTS (Xenial Xerus)&quot;</span><br>ID=ubuntu<br>ID_LIKE=debian<br>PRETTY_NAME=<span class="hljs-string">&quot;Ubuntu 16.04.6 LTS&quot;</span><br>VERSION_ID=<span class="hljs-string">&quot;16.04&quot;</span><br>HOME_URL=<span class="hljs-string">&quot;http://www.ubuntu.com/&quot;</span><br>SUPPORT_URL=<span class="hljs-string">&quot;http://help.ubuntu.com/&quot;</span><br>BUG_REPORT_URL=<span class="hljs-string">&quot;http://bugs.launchpad.net/ubuntu/&quot;</span><br>VERSION_CODENAME=xenial<br>UBUNTU_CODENAME=xenial<br><br>$ singularity inspect singularity-jupyter_jedi.sif<br>MAINTAINER: Mark Miesch<br>SPECIES: JEDI<br>org.label-schema.build-date: Thursday_5_December_2019_10:5:35_UTC<br>org.label-schema.schema-version: 1.0<br>org.label-schema.usage.singularity.deffile.bootstrap: docker<br>org.label-schema.usage.singularity.deffile.from: jcsda/docker_base-gnu-openmpi-dev:latest<br>org.label-schema.usage.singularity.version: 3.4.2<br><br>$ singularity shell -e singularity-jupyter_jedi.sif<br></code></pre></td></tr></table></figure><p>What's inside the JEDI docker image? (note: seems not full set)</p><figure class="highlight smali"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><code class="hljs smali">When you start a Singularity container<span class="hljs-built_in"> instance </span>from the xinzhang8noaa-singularity-master.simg, we already prepapre the gnu version 7.2 compilers<span class="hljs-built_in"> and </span>most of the necessary libraiestools for GSI, OOPS, WRF etc., all libraries are installed under /usr/local, which include<br><br>git<br>git flow<br>emacs<br>open-mpi v2.1.0<br>zlib v1.2.11<br>szip v2.1.1<br>jpeg v9b<br>png v1.4.19<br>jasper v1.900.2<br>hdf5 v1.8.17<br>freetype v2.5.5<br>netcdf-c v4.4.11<br>netcdf-fortran v4.4.4<br>lapack v3.7.0<br>parallel-netcdf v1.8.1<br>xerces-c v3.1.4<br>esmf v7.0.0<br>udunites-2 v2.2.24<br>nco v4.6.6<br>grib_api v1.21.0<br>cdo v1.8.2<br>boost v1.65.1<br>eigen3 v3.3.4<br>pio 1.7.1<br>ecbuild<br>eckit<br>fckit<br><br>The major NCEP libraries are also installed at<span class="hljs-keyword"> :</span><br><br>/nwprod/lib/bacio/v2.0.1/libbacio_v2.0.1_4.a<br>/nwprod/lib/bacio/v2.0.1/libbacio_v2.0.1_8.a<br>/nwprod/lib/ip/v2.0.0/libip_v2.0.0_4.a<br>/nwprod/lib/ip/v2.0.0/libip_v2.0.0_8.a<br>/nwprod/lib/ip/v2.0.0/libip_v2.0.0_d.a<br>/nwprod/lib/sigio/v2.0.1/lib/libsigio_v2.0.1_4.a<br>/nwprod/lib/sigio/v2.0.1/libsigio_v2.0.1_4.a<br>/nwprod/lib/sp/v2.0.2/libsp_v2.0.2_4.a<br>/nwprod/lib/sp/v2.0.2/libsp_v2.0.2_8.a<br>/nwprod/lib/sp/v2.0.2/libsp_v2.0.2_d.a<br>/nwprod/lib/w3emc/v2.2.0/libw3emc_v2.2.0_4.a<br>/nwprod/lib/w3emc/v2.2.0/libw3emc_v2.2.0_8.a<br>/nwprod/lib/w3emc/v2.2.0/libw3emc_v2.2.0_d.a<br>/nwprod/lib/w3nco/v2.0.6/libw3nco_v2.0.6_4.a<br>/nwprod/lib/w3nco/v2.0.6/libw3nco_v2.0.6_8.a<br>/nwprod/lib/w3nco/v2.0.6/libw3nco_v2.0.6_d.a<br></code></pre></td></tr></table></figure><ul><li>Download WRF and WPS</li><li>Build WRF and WPS code</li><li>Download MPAS code</li><li>Build MPAS code</li><li>Test MPAS</li></ul><h2 id="example-lammps">Example: LAMMPS</h2><p>LAMMPS 是由桑迪亞國家實驗室開發的一套分子動力學類比的開源程式包。 LAMMPS使用MPI實現多機器平行計算，在新的版本中，支援基於CUDA和OpenCL的GPU計算。其以GNU通用公眾授權條款釋出，因而開源自由。 LAMMPS最初為一美國政府與私人機構合作專案，由美國能源部與另外三所私有企業實驗室合作開發。</p><p>LAMMPS is a classical molecular dynamics code with a focus on materials modeling. It's an acronym for Large-scale Atomic/Molecular Massively Parallel Simulator.</p><p>From <a href="http://docs.hpc.whu.edu.cn/files/whuhpcdocs.wiki/sbatch/singularity.html" class="uri">http://docs.hpc.whu.edu.cn/files/whuhpcdocs.wiki/sbatch/singularity.html</a></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 创建sandbox；</span><br><span class="hljs-comment"># 这里将创建的sandbox命名为ubuntu20_lammps,并使用docker hub上现有的容器 ubuntu:20.04 作为基础镜像。</span><br>singularity build --sandbox ./ubuntu20_lammps docker://ubuntu:20.04 <span class="hljs-comment"># sudo ??</span><br><br><span class="hljs-comment"># 进入创建好的sandbox，并进行修改；</span><br><span class="hljs-comment"># 其中-w表示可写。进入后singularity会自动挂载的HOME目录，如果是用root用户进入，则会挂载/root目录</span><br>singularity shell -w ./ubuntu20_lammps<br><br><span class="hljs-comment"># Ubuntu下安装LAMMPS并行版需要安装必要的依赖包</span><br>apt update &amp;&amp; apt upgrade -y<br>apt install openmpi-bin openmpi-doc libopenmpi-dev -y<br>apt install gcc g++ gfortran make wget vim -y<br><br><span class="hljs-comment"># 安装fftw</span><br>wget http://www.fftw.org/fftw-3.3.9.tar.gz<br>tar zxvf fftw-3.3.9.tar.gz<br><span class="hljs-built_in">cd</span> fftw-3.3.9<br>./configure --prefix=/opt/software/fftw_3.3.9 --enable-shared --enable-static --enable-fma<br>make -j &amp;&amp; make install<br><br><span class="hljs-comment"># 设置临时fftw环境变量</span><br><span class="hljs-built_in">export</span> PATH=/opt/software/fftw_3.3.9/bin:<span class="hljs-variable">$PATH</span><br><span class="hljs-built_in">export</span> LD_LIBRARY_PATH=/opt/software/fftw_3.3.9/lib:<span class="hljs-variable">$LD_LIBRARY_PATH</span><br><br><span class="hljs-comment"># 安装lammps</span><br>wget https://lammps.sandia.gov/tars/lammps-10Feb21.tar.gz<br>tar zxvf lammps-10Feb21.tar.gz<br><span class="hljs-built_in">cd</span> lammps-10Feb21<br><span class="hljs-built_in">cd</span> src<br>vim MAKE/OPTIONS/Makefile.g++_openmpi <span class="hljs-comment"># 修改如下行</span><br>  FFT_INC = -DFFT_FFTW -I/opt/software/fftw_3.3.9/include<br>  FFT_PATH = -L/opt/software/fftw_3.3.9/lib<br>  FFT_LIB = -lfftw3<br><br>make yes-std<br>make no-lib<br>make -j g++_openmpi<br><br><span class="hljs-built_in">mkdir</span> /opt/software/lammps<br><span class="hljs-built_in">cp</span> ./lmp_g++_openmpi /opt/software/lammps/<br><br><span class="hljs-comment"># 设置临时lammps环境变量</span><br><span class="hljs-built_in">export</span> PATH=/opt/software/lammps:<span class="hljs-variable">$PATH</span><br><br><span class="hljs-comment"># 验证(容器内)</span><br><span class="hljs-built_in">cd</span> /root<br><span class="hljs-built_in">cp</span> /opt/lammps-10Feb21/bench/in.lj .<br>mpirun --allow-run-as-root -np 2 --mca btl ^openib lmp_g++_openmpi -<span class="hljs-keyword">in</span> in.lj<br><br><br><span class="hljs-comment"># 退出容器，设置永久环境变量(宿主机)</span><br>vim ./ubuntu20_lammps/environment<br><span class="hljs-comment"># 加入下面两行</span><br><span class="hljs-built_in">export</span> PATH=/opt/software/fftw_3.3.9/bin:/opt/software/lammps:<span class="hljs-variable">$PATH</span><br><span class="hljs-built_in">export</span> LD_LIBRARY_PATH=/opt/software/fftw_3.3.9/lib:<span class="hljs-variable">$LD_LIBRARY_PATH</span><br><br><span class="hljs-comment"># 验证(宿主机)</span><br>singularity <span class="hljs-built_in">exec</span> ./ubuntu20_lammps mpirun --allow-run-as-root -np 2 --mca btl ^openib lmp_g++_openmpi -<span class="hljs-keyword">in</span> in.lj<br><br><span class="hljs-comment"># 把修改好的sandbox打包成sif格式；</span><br><span class="hljs-comment"># 删除不必要的安装包, 如 fftw-3.3.9.tar.gz lammps-10Feb21.tar.gz</span><br><span class="hljs-comment"># 使用前面创建的sandbox目录生成singularity image file格式镜像。</span><br>singularity build ubuntu20_lammps.sif ./ubuntu20_lammps<br></code></pre></td></tr></table></figure><p>then, run it on HPC,</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-meta">#!/bin/bash</span><br><br><span class="hljs-comment">#SBATCH --partition=hpxg</span><br><span class="hljs-comment">#SBATCH --nodes=1</span><br><span class="hljs-comment">#SBATCH --ntasks-per-node=2</span><br><span class="hljs-comment">#SBATCH --time=1:00:00</span><br><br><span class="hljs-comment"># 加载超算平台预安装的 singularity</span><br>module load singularity<br><span class="hljs-comment"># or load by micromamba</span><br><br><span class="hljs-comment"># 测试in.lj算例</span><br>singularity <span class="hljs-built_in">exec</span> ubuntu20_lammps.sif mpirun -np 2 --mca btl ^openib lmp_g++_openmpi -<span class="hljs-keyword">in</span> in.lj<br></code></pre></td></tr></table></figure><h2 id="customize-definition-file-.def">Customize Definition File .def</h2><p>File 內容主要分為 Header 和 Sections 兩部分：</p><ul><li>Header：定義 base 映像檔的來源 (例：docker, library, yum…等)。</li><li>Sections：有多種選項可設定，主要會使用以下 2 個項目：<ul><li>%post：建立容器後將執行的內容。</li><li>%environment：容器建立好後，會將程式的環境變數會放到 /environment 內。</li></ul></li></ul><p>Execute definition file to create a container,</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">$ <span class="hljs-built_in">sudo</span> singularity build &lt;CONTAINER_NAME&gt;.sif &lt;DEF_FILE_NAME&gt;.def<br></code></pre></td></tr></table></figure><p>Header,</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh">Bootstrap: library<br>From: debian:7<br></code></pre></td></tr></table></figure><p>Preferred bootstrap agents</p><ul><li>library (images hosted on the Container Library)</li><li>docker (images hosted on Docker Hub)</li><li>shub (images hosted on Singularity Hub)</li><li>oras (images from supporting OCI registries)</li><li>scratch (a flexible option for building a container from scratch)</li></ul><p>Here is an example definition file that uses every available section. We will discuss each section in turn. It is not necessary to include every section (or any sections at all) within a def file. Furthermore, multiple sections of the same name can be included and will be appended to one another during the build process.</p><p><a href="https://docs.sylabs.io/guides/3.7/user-guide/definition_files.html" class="uri">https://docs.sylabs.io/guides/3.7/user-guide/definition_files.html</a></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs bash">Bootstrap: library<br>From: ubuntu:18.04<br>Stage: build<br><br>%setup<br>    <span class="hljs-built_in">touch</span> /file1<br>    <span class="hljs-built_in">touch</span> <span class="hljs-variable">$&#123;SINGULARITY_ROOTFS&#125;</span>/file2<br><br>%files<br>    /file1<br>    /file1 /opt<br><br>%environment<br>    <span class="hljs-built_in">export</span> LISTEN_PORT=12345<br>    <span class="hljs-built_in">export</span> LC_ALL=C<br><br>%post<br>    apt-get update &amp;&amp; apt-get install -y netcat<br>    NOW=`<span class="hljs-built_in">date</span>`<br>    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;export NOW=\&quot;<span class="hljs-variable">$&#123;NOW&#125;</span>\&quot;&quot;</span> &gt;&gt; <span class="hljs-variable">$SINGULARITY_ENVIRONMENT</span><br><br>%runscript<br>    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;Container was created <span class="hljs-variable">$NOW</span>&quot;</span><br>    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;Arguments received: $*&quot;</span><br>    <span class="hljs-built_in">exec</span> <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;<span class="hljs-variable">$@</span>&quot;</span><br><br>%startscript<br>    nc -lp <span class="hljs-variable">$LISTEN_PORT</span><br><br>%<span class="hljs-built_in">test</span><br>    grep -q NAME=\&quot;Ubuntu\&quot; /etc/os-release<br>    <span class="hljs-keyword">if</span> [ $? -eq 0 ]; <span class="hljs-keyword">then</span><br>        <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;Container base is Ubuntu as expected.&quot;</span><br>    <span class="hljs-keyword">else</span><br>        <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;Container base is not Ubuntu.&quot;</span><br>        <span class="hljs-built_in">exit</span> 1<br>    <span class="hljs-keyword">fi</span><br><br>%labels<br>    Author d@sylabs.io<br>    Version v0.0.1<br><br>%<span class="hljs-built_in">help</span><br>    This is a demo container used to illustrate a def file that uses all supported sections.<br></code></pre></td></tr></table></figure><h3 id="case">case:</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><code class="hljs sh">BootStrap: library<br>From: ubuntu:18.04<br><br>%post<br>    apt-get -y update<br>    apt-get -y upgrade<br><br>    apt-get install -y \<br>    build-essential \<br>    vim \<br>    wget \<br>    curl \<br>    libssl-dev \<br>    git \<br>    tar \<br>    openssh-client \<br>    gzip \<br>    ca-certificates<br><br>    apt-get install -y bzip2<br><br>    apt-get clean<br><br>    <span class="hljs-built_in">export</span> SHELL=/bin/bash<br>    <span class="hljs-built_in">export</span> PATH=/root/.local/bin:<span class="hljs-variable">$PATH</span><br>    <br>    wget micro.mamba.pm/install.sh<br>    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;All paths are default.&quot;</span><br>    sed -i -e <span class="hljs-string">&#x27;s/-t 0/1 == 0/g&#x27;</span> install.sh<br>    <span class="hljs-built_in">chmod</span> +x install.sh<br>    bash install.sh<br><br>    <span class="hljs-comment"># &gt;&gt;&gt; mamba initialize &gt;&gt;&gt;</span><br>    <span class="hljs-comment"># !! Contents within this block are managed by &#x27;mamba init&#x27; !!</span><br>    <span class="hljs-built_in">export</span> MAMBA_EXE=<span class="hljs-string">&#x27;/root/.local/bin/micromamba&#x27;</span>;<br>    <span class="hljs-built_in">export</span> MAMBA_ROOT_PREFIX=<span class="hljs-string">&#x27;/root/micromamba&#x27;</span>;<br>    __mamba_setup=<span class="hljs-string">&quot;<span class="hljs-subst">$(<span class="hljs-string">&quot;<span class="hljs-variable">$MAMBA_EXE</span>&quot;</span> shell hook --shell bash --root-prefix <span class="hljs-string">&quot;<span class="hljs-variable">$MAMBA_ROOT_PREFIX</span>&quot;</span> 2&gt; /dev/null)</span>&quot;</span><br>    <span class="hljs-keyword">if</span> [ $? -eq 0 ]; <span class="hljs-keyword">then</span><br>        <span class="hljs-built_in">eval</span> <span class="hljs-string">&quot;<span class="hljs-variable">$__mamba_setup</span>&quot;</span><br>    <span class="hljs-keyword">else</span><br>        <span class="hljs-built_in">alias</span> micromamba=<span class="hljs-string">&quot;<span class="hljs-variable">$MAMBA_EXE</span>&quot;</span>  <span class="hljs-comment"># Fallback on help from mamba activate</span><br>    <span class="hljs-keyword">fi</span><br>    <span class="hljs-built_in">unset</span> __mamba_setup<br><br>    micromamba <span class="hljs-built_in">env</span> list<br><br>%environment<br>    <span class="hljs-built_in">export</span> SHELL=/bin/bash<br>    <span class="hljs-built_in">export</span> LC_ALL=C<br>    <span class="hljs-built_in">export</span> PATH=/usr/local/bin:<span class="hljs-variable">$PATH</span><br>    <span class="hljs-built_in">export</span> PATH=/root/.local/bin:<span class="hljs-variable">$PATH</span><br><br>    <span class="hljs-comment"># &gt;&gt;&gt; mamba initialize &gt;&gt;&gt;</span><br>    <span class="hljs-comment"># !! Contents within this block are managed by &#x27;mamba init&#x27; !!</span><br>    <span class="hljs-built_in">export</span> MAMBA_EXE=<span class="hljs-string">&#x27;/root/.local/bin/micromamba&#x27;</span>;<br>    <span class="hljs-built_in">export</span> MAMBA_ROOT_PREFIX=<span class="hljs-string">&#x27;/root/micromamba&#x27;</span>;<br>    __mamba_setup=<span class="hljs-string">&quot;<span class="hljs-subst">$(<span class="hljs-string">&quot;<span class="hljs-variable">$MAMBA_EXE</span>&quot;</span> shell hook --shell bash --root-prefix <span class="hljs-string">&quot;<span class="hljs-variable">$MAMBA_ROOT_PREFIX</span>&quot;</span> 2&gt; /dev/null)</span>&quot;</span><br>    <span class="hljs-keyword">if</span> [ $? -eq 0 ]; <span class="hljs-keyword">then</span><br>        <span class="hljs-built_in">eval</span> <span class="hljs-string">&quot;<span class="hljs-variable">$__mamba_setup</span>&quot;</span><br>    <span class="hljs-keyword">else</span><br>        <span class="hljs-built_in">alias</span> micromamba=<span class="hljs-string">&quot;<span class="hljs-variable">$MAMBA_EXE</span>&quot;</span>  <span class="hljs-comment"># Fallback on help from mamba activate</span><br>    <span class="hljs-keyword">fi</span><br>    <span class="hljs-built_in">unset</span> __mamba_setup<br><br>%runscript<br>    hostname<br><br>%labels<br>    Author wpsze<br>    Version v0.0.1<br><br>%<span class="hljs-built_in">help</span><br>  Singularity image used get dependencies from micromamba.<br></code></pre></td></tr></table></figure><p>(Fail, why??) then,</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">$ <span class="hljs-built_in">sudo</span> singularity build test.sif test.def<br></code></pre></td></tr></table></figure><h2 id="by-sanbox">By Sanbox</h2><p>建立沙盒容器</p><p>若需測試套件是否與容器環境相容時，您可以建立「沙盒容器」，既不影響原容器映像檔內容，也無需重建立容器，又可在容器內安裝或進行操作：</p><p>請先建立沙盒資料夾，放入容器映像檔的所有內容</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">$ <span class="hljs-built_in">sudo</span> singularity build --sandbox &lt;FOLDER_NAME&gt; docker://nvidia/cuda:10.1-devel-ubuntu18.04<br></code></pre></td></tr></table></figure><p><strong>使用 shell 方式進入沙盒容器內，並具有寫入的權限。</strong></p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">$ <span class="hljs-built_in">sudo</span> singularity shell --writable &lt;FOLDER_NAME&gt;/<br></code></pre></td></tr></table></figure><p>即可利用 apt 使用以下指令更新並安裝套件</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh">$ apt-get update<br>$ apt-get install wget<br></code></pre></td></tr></table></figure><p>使用沙盒建立 Singularity 容器映像檔</p><div class="note note-primary">            <p>附註：由於沙盒未將套件寫入 definition file，您無法紀錄容器內有哪些套件，維護不易，較不推薦使用此方式建立容器映像檔。建議使用客製化 Singularity 容器之方式。</p>          </div><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">$ <span class="hljs-built_in">sudo</span> singularity build &lt;CONTAINER_NAME&gt;.sif &lt;FOLDER_NAME&gt;/<br></code></pre></td></tr></table></figure><ul><li>Assume that the sandbox image to be deleted is named molspin</li><li>First, enter the image to be deleted in readable mode<ul><li>singularity shell --fakeroot -w molspin</li></ul></li><li>Delete all files created based on fakeroot in the container<ul><li>rm -rf /* 1&gt;/dev/null 2&gt;&amp;1</li></ul></li><li>Exit the image<ul><li>exit</li></ul></li><li>Upload the created software image to the high-performance computing cluster and load the singularity software environment</li><li>Delete the rest<ul><li>rm -rf molspin</li></ul></li></ul><h2 id="example-nmap">Example: nmap</h2><h1 id="conda-install-singularity">Conda install singularity</h1><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sh">$ micromamba <span class="hljs-built_in">env</span> create -n singularity<br>$ micromamba activate singularity<br>$ micromamba install conda-forge::singularity<br></code></pre></td></tr></table></figure><p>version = linux-ppc64le/singularity-3.8.7-hff88825_0.tar.bz2?</p><h1 id="running-singularity-images">Running Singularity images</h1><h2 id="build-or-pull">build or pull</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs sh">$ singularity build ./jason-tensorflow.sif docker://tensorflow/tensorflow:latest-gpu<br>$ singularity pull ./jason-tensorflow.sif docker://tensorflow/tensorflow:latestgpu<br>$ singularity pull library://lolcow<br>$ <span class="hljs-built_in">ls</span><br>lolcow_latest.sif<br></code></pre></td></tr></table></figure><div class="note note-primary">            <ul><li>Inspect will show you labels, environment variables, and scripts associated with the image determined by the flags you pass.</li></ul>          </div><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">$ singularity inspect my-container.sif<br></code></pre></td></tr></table></figure><h2 id="run-exec-shell">run, exec, shell</h2><div class="note note-primary">            <p>singularity run Run the user-defined default command within a container</p>          </div><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs sh">$ singularity run my-container.sif<br><br>$ singularity run lolcow_latest.sif <br> ______________________________<br>&lt; Sun Sep 22 00:17:43 HKT 2024 &gt;<br> ------------------------------<br>        \   ^__^<br>         \  (oo)\_______<br>            (__)\       )\/\<br>                ||----w |<br>                ||     ||<br></code></pre></td></tr></table></figure><div class="note note-primary">            <p>singularity exec Run a command within a container</p>          </div><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs sh">$ singularity <span class="hljs-built_in">exec</span> my-container.sif my-command<br><br>$ singularity <span class="hljs-built_in">exec</span> lolcow_latest.sif cowsay WRF-MPAS<br> __________<br>&lt; WRF-MPAS &gt;<br> ----------<br>        \   ^__^<br>         \  (oo)\_______<br>            (__)\       )\/\<br>                ||----w |<br>                ||     ||<br></code></pre></td></tr></table></figure><div class="note note-primary">            <p>singularity shell Run a shell within a container</p>          </div><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs sh">$ singularity shell my-container.sif<br><br>$ singularity shell lolcow_latest.sif <br>Singularity&gt; cowsay here is shell<br> _______________<br>&lt; here is shell &gt;<br> ---------------<br>        \   ^__^<br>         \  (oo)\_______<br>            (__)\       )\/\<br>                ||----w |<br>                ||     ||<br>Singularity&gt; cowsay going <br> _______<br>&lt; going &gt;<br> -------<br>        \   ^__^<br>         \  (oo)\_______<br>            (__)\       )\/\<br>                ||----w |<br>                ||     ||<br>Singularity&gt; <span class="hljs-built_in">exit</span><br><span class="hljs-built_in">exit</span><br></code></pre></td></tr></table></figure><h1 id="bug">Bug</h1><h2 id="root-filesystem-extraction-failed-failed-to-copy-content-in-staging-file-write-tmprootfs">root filesystem extraction failed: failed to copy content in staging file: write /tmp/rootfs</h2><ul><li><a href="https://github.com/apptainer/singularity/issues/5711">root filesystem extraction failed: command error: while getting library dependencies: exit status 127</a></li><li><a href="https://docs.sylabs.io/guides/3.7/user-guide/build_env.html#temporary-folders">Temporary Folders</a><ul><li>The location for temporary directories defaults to <code>/tmp</code>. Singularity will also respect the environment variable <code>TMPDIR</code>, and both of these locations can be overridden by setting the environment variable <code>SINGULARITY_TMPDIR</code>.</li><li>The temporary directory used during a build must be on a filesystem that has <strong>enough space to hold the entire container image</strong>, uncompressed, including any temporary files that are created and later removed during the build.</li><li>You may need to set <code>SINGULARITY_TMPDIR</code> when building a large container on a system which has a small <code>/tmp</code> filesystem.</li><li><code>$ ls -a /tmp</code></li><li>cleanup: <code>rm -r rootfs*</code></li></ul></li><li>try to add<ul><li><code>export SINGULARITY_TMPDIR="/home/wpsze/ML/NVIDIA-Modulus/singularity_tmp"</code></li><li><code>-B $SINGULARITY_TMPDIR:/tmp</code></li></ul></li></ul><h1 id="specifying-bind-paths">Specifying bind paths</h1><p>開發容器的目的之一主要是為了解決依賴函式庫的安裝、軟體環境的隔離、以及軟體環境的移植問題。因此，<strong>容器的核心特性之一就是它們的檔案系統與宿主機相隔離。</strong> 如果我們查看一個 singularity 容器的根目錄，也會看到與 Linux 主機根目錄相似的結構。這意味著容器內的應用程式只能看到（並與之互動）這個封閉環境中的檔案和目錄。與 Linux 下掛載（mount）外接硬碟設備類似，容器同樣需要透過掛載 (bind) 的操作與我們宿主機上的檔案系統互動。<a href="https://juejin.cn/post/7345293582365868041">link</a></p><p>當呼叫容器時，Singularity 會將主機作業系統 “swap” 為容器中的作業系統，導致我們無法存取主機檔案系統。<strong>然而，在日常使用場景中，已安裝至容器中的應用程式的輸入和輸出檔案往往儲存在主機檔案系統中，因此，我們需要從容器內讀取和寫入主機系統上的檔案。</strong></p><ul><li>singularity 使用 --bind/-B 宿主機目錄:容器內目錄 選項將主機系統上的目錄對應到容器內的目錄。這允許我們從容器內部存取主機上的文件，從而在主機系統上讀寫資料。</li></ul><p>如需要將多個目錄綁定到 Singularity 容器中，並且長期保持不變，我們可以進一步將這個變數寫入 .bashrc 檔案中。</p><p>Here’s an example of using the --bind option and binding /data on the host to /mnt in the container (/mnt does not need to already exist in the container):</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs sh">$ <span class="hljs-built_in">ls</span> /data<br>bar  foo<br><br>$ singularity <span class="hljs-built_in">exec</span> --<span class="hljs-built_in">bind</span> /data:/mnt my_container.sif <span class="hljs-built_in">ls</span> /mnt<br>bar  foo<br></code></pre></td></tr></table></figure><p>You can bind multiple directories in a single command with this syntax:</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">$ singularity shell --<span class="hljs-built_in">bind</span> /opt,/data:/mnt my_container.sif<br></code></pre></td></tr></table></figure><p>or</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sh">$ <span class="hljs-built_in">export</span> SINGULARITY_BIND=<span class="hljs-string">&quot;/opt,/data:/mnt&quot;</span><br><br>$ singularity shell my_container.sif<br></code></pre></td></tr></table></figure><h1 id="references">References</h1><ol type="1"><li><a href="https://docs.sylabs.io/guides/2.6/user-guide/singularity_and_docker.html">Singularity and Docker</a></li><li><a href="https://hpc.nih.gov/apps/apptainer.html">Apptainer (the Linux Foundation variant of Singularity)</a></li><li><a href="https://hpc.hku.hk/hpc/software/singularity-container/">HKU Singularity Container</a></li><li><a href="https://itso.hkust.edu.hk/services/academic-teaching-support/high-performance-computing/superpod/singularity-apptainer">HKUST SuperPOD - Apptainer (Singularity)</a></li><li><a href="https://cloud.sylabs.io/library">Sylabs Cloud</a><ol type="1"><li>singularity pull ubuntu.sif library://library/default/ubuntu:21.04</li></ol></li><li><a href="https://ngc.nvidia.com/">NVIDIA NGC</a><ol type="1"><li>NVIDIA官方自己构建的pytorch和TensorFlow的容器镜像，每个里面包含了cuda、显卡驱动以及cudnn，据说比自己装的速度要快，使用时singularity需要 --nv 选项。</li></ol></li><li><a href="https://hub.docker.com/">Docker Hub</a><ol type="1"><li>singularity pull ubuntu.sif docker://ubuntu:latest</li></ol></li><li><a href="https://singularityhub.github.io/singularityhub-archive/">Singularity Hub Archive</a></li><li><a href="https://www.cnblogs.com/dechinphy/p/pytorch.html">从零开始制作PyTorch的Singularity容器镜像</a></li><li><a href="https://man.twcc.ai/@twccdocs/howto-twnia2-create-sglrt-container-zh">建立台灣杉二號的容器</a></li><li><a href="https://sysbiobig.dei.unipd.it/wp-content/uploads/2023/03/2-Singularity.pdf">Singularity | Giacomo Baruzzo, PhD</a></li><li><a href="https://zhuanlan.zhihu.com/p/671679662">基于singularity构建可移植的生信工作站</a></li><li><a href="https://link.springer.com/article/10.1007/s11227-024-06893-1">Singularity to deploy HPC applications: a study case with WRF | 2025</a></li></ol>]]></content>
    
    
    <categories>
      
      <category>Linux</category>
      
    </categories>
    
    
    <tags>
      
      <tag>HPC</tag>
      
      <tag>NWP</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>WRF | Predicting lightning activity using WRF-ELEC model</title>
    <link href="/2024/09/20/wrf4-elec-lightning/"/>
    <url>/2024/09/20/wrf4-elec-lightning/</url>
    
    <content type="html"><![CDATA[<h1 id="wrf-elec-model">WRF-ELEC model</h1><p>WRF-ELEC provides basic electrification and <strong>lightning using the NSSL microphysics scheme</strong>. The electrification parameterizations are based on past work in modeling. The basics of the charge separation schemes comes from Mansell et al. (2005). Their use in the <strong>NSSL 2-moment microphysics</strong> is shown in Mansell et al. 2010 and Mansell and Ziegler (2013). First implementation into WRF is described by Fierro et al. (2013), which includes details of the basic discharge scheme (cylindrical discharge regions centered on lightning initiation points).</p><ul><li>Mansell et al. 2005: Charge structure and lightning sensitivity in a simulated multicell thunderstorm. J. Geophys. Res., 110, D12101, doi:10.1029/2004JD005287</li><li>Mansell, E. R., C. L. Ziegler, and E. C. Bruning, 2010: Simulated electrification of a small thunderstorm with two-moment bulk microphysics. J. Atmos. Sci., 67, 171-194, doi:10. 1175/2009JAS2965.1.</li><li><strong>Fierro, A. O., E.R. Mansell, C. Ziegler and D. R. MacGorman 2013: The implementation of an explicit charging and discharge lightning scheme within the WRF-ARW model: Benchmark simulations of a continental squall line, a tropical cyclone and a winter storm. Monthly Weather Review, Volume 141, 2390-2415</strong> (see below)</li></ul><p>If you have trouble with this option please contact the developers directly (i.e., not wrf_help):</p><blockquote><p>Ted Mansell (Ted.Mansell <em>at</em> noaa.gov)<br />Alexandre Fierro (Alex.Fierro <em>at</em> noaa.gov)</p></blockquote><h2 id="boxmg">BoxMG</h2><ul><li>Black Box Multigrid (BoxMG) algorithm</li></ul><p>From <a href="https://github.com/MicroTed/wrf4-elec/blob/7c90e71bdc4db527d0ec034804e4fd200cdacf28/doc/README.electricity#L41" class="uri">https://github.com/MicroTed/wrf4-elec/blob/7c90e71bdc4db527d0ec034804e4fd200cdacf28/doc/README.electricity#L41</a>,</p><p>The <strong>BoxMG elliptic equation solver</strong> is required for WRF-ELEC to calculate the 3D electric potential. This library is distributed at the moment as a source code archive at</p><ul><li><a href="http://sourceforge.net/projects/boxmg4wrf/" class="uri">http://sourceforge.net/projects/boxmg4wrf/</a></li></ul><p>The git repository is recommended as the most up-to-date. Note that the code has only been compiled for Intel/AMD (non-Itanium) architecture under Linux and OS X using either Intel Fortran or GNU compilers. (For problems, contact <a href="mailto:ted.mansell@noaa.gov" class="email">ted.mansell@noaa.gov</a>)</p><div class="note note-primary">            <p><strong>BoxMG needs to be installed before configuring WRF.</strong></p>          </div><p>Install the code where you want the libraries to be and then follow the instructions in the INSTALL document:</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sh">$ git <span class="hljs-built_in">clone</span> https://git.code.sf.net/p/boxmg4wrf/git boxmg4wrf<br>$ ll<br>34M boxmg4wrf<br></code></pre></td></tr></table></figure><ul><li><a href="https://sourceforge.net/p/boxmg4wrf/git/ci/main/tree/" class="uri">https://sourceforge.net/p/boxmg4wrf/git/ci/main/tree/</a><ul><li>Branches: main, boxmg4wrf-0.1, master, release0.0</li></ul></li></ul><p>git logg (2024-09-24)</p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">* d8e89bc (HEAD -&gt; master, origin/master, origin/HEAD)  Fix mpi calls <span class="hljs-keyword">to</span> use single <span class="hljs-keyword">or</span> <span class="hljs-type">double</span> <span class="hljs-type">precision</span> <span class="hljs-keyword">as</span> <span class="hljs-keyword">set</span> <span class="hljs-keyword">by</span> RKIND (<span class="hljs-number">11</span> months ago) &lt;Ted Mansell&gt;<br>* <span class="hljs-number">817</span>df7a  <span class="hljs-keyword">Update</span> <span class="hljs-keyword">to</span> compile <span class="hljs-keyword">on</span> M1 mac (assumes <span class="hljs-keyword">using</span> gfortran <span class="hljs-keyword">as</span> compiler) (<span class="hljs-number">2</span> years ago) &lt;Ted Mansell&gt;<br>* <span class="hljs-number">3</span>cee0c8 (origin/boxmg4wrf<span class="hljs-number">-0.1</span>) Added <span class="hljs-keyword">comment</span> (<span class="hljs-number">2</span> years, <span class="hljs-number">9</span> months ago) &lt;Ted Mansell&gt;<br>* <span class="hljs-number">71</span>c38c1 - Added a <span class="hljs-keyword">check</span> <span class="hljs-keyword">for</span> gcc <span class="hljs-keyword">version</span> <span class="hljs-number">10</span> <span class="hljs-keyword">or</span> greater <span class="hljs-keyword">to</span> <span class="hljs-keyword">add</span> the -fallow-argument-mismatch compile flag - Updates <span class="hljs-keyword">to</span> test example ex_direct_1_f90 (e.g., <span class="hljs-type">double</span> quotes <span class="hljs-keyword">on</span> preprocessed <span class="hljs-keyword">include</span> files) (<span class="hljs-number">2</span> years, <span class="hljs-number">9</span> months ago) &lt;Ted Mansell&gt;<br>* <span class="hljs-number">0e19676</span> erm: <span class="hljs-keyword">add</span> sgl/dbl suffix <span class="hljs-keyword">for</span> libs (<span class="hljs-number">3</span> years, <span class="hljs-number">7</span> months ago) &lt;Ted Mansell&gt;<br>* <span class="hljs-number">6682023</span> erm: turn <span class="hljs-keyword">off</span> <span class="hljs-keyword">all</span> but the one that works (currently) (<span class="hljs-number">3</span> years, <span class="hljs-number">7</span> months ago) &lt;Ted Mansell&gt;<br>* <span class="hljs-number">3644096</span> erm: added dependcies <span class="hljs-keyword">for</span> &quot;check&quot; (<span class="hljs-number">3</span> years, <span class="hljs-number">7</span> months ago) &lt;Ted Mansell&gt;<br>* d98ff35 erm: Minor changes <span class="hljs-keyword">for</span> clarity (hopefully) (<span class="hljs-number">3</span> years, <span class="hljs-number">7</span> months ago) &lt;Ted Mansell&gt;<br>* aaaa34c erm: minor updates (<span class="hljs-number">3</span> years, <span class="hljs-number">7</span> months ago) &lt;Ted Mansell&gt;<br>* b54bb70 erm: added .gitignore file (<span class="hljs-number">3</span> years, <span class="hljs-number">7</span> months ago) &lt;Ted Mansell&gt;<br>* d96cb63 (origin/release0<span class="hljs-number">.0</span>) Initial <span class="hljs-keyword">commit</span> (<span class="hljs-number">3</span> years, <span class="hljs-number">7</span> months ago) &lt;Ted Mansell&gt;<br></code></pre></td></tr></table></figure><p>Compile:</p><ul><li>wrf_env.sh: go to <a href="https://waipangsze.github.io/2023/04/25/WRF_installation_on_a_Linux_based_machine/" class="uri">https://waipangsze.github.io/2023/04/25/WRF_installation_on_a_Linux_based_machine/</a></li></ul><p>To check environment variables,</p><ul><li>/ARCH/machine</li></ul><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs perl">ife<span class="hljs-string">q (<span class="hljs-variable">$(</span>findstring x86_64,<span class="hljs-variable">$(</span>UNAME_M)</span>),x86_64)<br><br>  BOXMG_CPU = AMD64<br></code></pre></td></tr></table></figure><ul><li>add these to Makefile to print variables,</li></ul><figure class="highlight gams"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs gams"><span class="hljs-symbol">$</span>(info <span class="hljs-symbol">$</span><span class="hljs-symbol">$</span>BOXMG_OS is [<span class="hljs-symbol">$</span>&#123;BOXMG_OS&#125;])<br><span class="hljs-symbol">$</span>(info <span class="hljs-symbol">$</span><span class="hljs-symbol">$</span>BOXMG_CPU is [<span class="hljs-symbol">$</span>&#123;BOXMG_CPU&#125;])<br><span class="hljs-symbol">$</span>(info <span class="hljs-symbol">$</span><span class="hljs-symbol">$</span>BOXMG_COMPILER is [<span class="hljs-symbol">$</span>&#123;BOXMG_COMPILER&#125;])<br><span class="hljs-symbol">$</span>(info <span class="hljs-symbol">$</span><span class="hljs-symbol">$</span>BOXMG_ARCHmake is [<span class="hljs-symbol">$</span>&#123;BOXMG_ARCHmake&#125;])<br><span class="hljs-symbol">$</span>(info <span class="hljs-symbol">$</span><span class="hljs-symbol">$</span>BOXMG_ARCH is [<span class="hljs-symbol">$</span>&#123;BOXMG_ARCH&#125;])<br><span class="hljs-symbol">$</span>(info <span class="hljs-symbol">$</span><span class="hljs-symbol">$</span>BOXMG_PRECISION is [<span class="hljs-symbol">$</span>&#123;BOXMG_PRECISION&#125;])<br><span class="hljs-symbol">$</span>(info <span class="hljs-symbol">$</span><span class="hljs-symbol">$</span>BOXMG_MPI is [<span class="hljs-symbol">$</span>&#123;BOXMG_MPI&#125;])<br></code></pre></td></tr></table></figure><ul><li>$ make</li></ul><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs stylus"> $ uname -<span class="hljs-selector-tag">a</span><br>Linux xxx <span class="hljs-number">4.18</span>.<span class="hljs-number">0</span>-<span class="hljs-number">477.10</span>.<span class="hljs-number">1</span><span class="hljs-selector-class">.el8_8</span><span class="hljs-selector-class">.x86_64</span> #<span class="hljs-number">1</span> SMP Tue May <span class="hljs-number">16</span> <span class="hljs-number">11</span>:<span class="hljs-number">38</span>:<span class="hljs-number">37</span> UTC <span class="hljs-number">2023</span> x86_64 x86_64 x86_64 GNU/Linux<br><br><span class="hljs-variable">$BOXMG_OS</span> is <span class="hljs-selector-attr">[Linux]</span><br><span class="hljs-variable">$BOXMG_CPU</span> is <span class="hljs-selector-attr">[AMD64]</span><br><span class="hljs-variable">$BOXMG_COMPILER</span> is <span class="hljs-selector-attr">[gnu]</span><br><span class="hljs-variable">$BOXMG_ARCHmake</span> is <span class="hljs-selector-attr">[./ARCH]</span><br><span class="hljs-variable">$BOXMG_ARCH</span> is <span class="hljs-selector-attr">[Linux-AMD64]</span><br><span class="hljs-variable">$BOXMG_PRECISION</span> is <span class="hljs-selector-attr">[SINGLE]</span><br><span class="hljs-variable">$BOXMG_MPI</span> is <span class="hljs-selector-attr">[yes]</span><br></code></pre></td></tr></table></figure><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-meta">#!/bin/bash</span><br><span class="hljs-built_in">export</span> WRF_ENV=<span class="hljs-string">&quot;/home/wpsze/WRF/WRFv440/wrf_env.sh&quot;</span><br><span class="hljs-built_in">source</span> <span class="hljs-variable">$&#123;WRF_ENV&#125;</span><br><br>gcc --version<br>gfortran --version<br>mpirun --version<br><span class="hljs-built_in">which</span> mpif90 &amp; mpif90 --version<br><span class="hljs-built_in">which</span> mpif77 <span class="hljs-comment"># Must</span><br><br><span class="hljs-built_in">export</span> BOXMG_MPI=<span class="hljs-built_in">yes</span><br>make<br></code></pre></td></tr></table></figure><div class="note note-success">            <p>The libraries ( libboxmg_opt_sgl.a, libboxmg-extras_opt_sgl.a ) will be in ./lib.</p>          </div><p>install process:</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs sh">.......<br>.......<br>gfortran   -funderscoring -DRKIND=4  -Waliasing -Wsurprising -O3  -c -o BMG_rand.o BMG_rand.f<br>ar csrv  ../../lib/libboxmg-extras_opt_sgl.a BMG_rand.o<br>a - BMG_rand.o<br><span class="hljs-built_in">rm</span> BMG_rand.o<br><br> $ ll lib<br>total 1.6M<br>drwxrwxr-x  2 wpsze wpsze  33K Sep 23 16:32 ./<br>drwxrwxr-x 11 wpsze wpsze  33K Sep 23 16:28 ../<br>-rw-rw-r--  1 wpsze wpsze    0 Sep 23 16:13 .keepme<br>-rw-rw-r--  1 wpsze wpsze 1.4M Sep 23 16:32 libboxmg-extras_opt_sgl.a<br>-rw-rw-r--  1 wpsze wpsze 1.4M Sep 23 16:30 libboxmg_opt_sgl.a<br></code></pre></td></tr></table></figure><ul><li><a href="https://forum.mmm.ucar.edu/threads/error-while-making-boxmg.12977/">Error while Making BoxMG?</a></li></ul><h3 id="test-boxmg">Test BoxMG</h3><ol type="1"><li>Go to /tests and make</li></ol><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-meta">#!/bin/bash</span><br><span class="hljs-built_in">export</span> WRF_ENV=<span class="hljs-string">&quot;/home/wpsze/WRF/WRFv440/wrf_env.sh&quot;</span><br><span class="hljs-built_in">source</span> <span class="hljs-variable">$&#123;WRF_ENV&#125;</span><br><br>gcc --version<br>gfortran --version<br>mpirun --version<br><span class="hljs-built_in">which</span> mpif90 &amp; mpif90 --version<br><span class="hljs-built_in">which</span> mpif77<br><br><span class="hljs-built_in">export</span> LDFLAGS=-L/home/wpsze/WRF/WRF4-elec/wrf_install/boxmg4wrf/lib<br><span class="hljs-built_in">export</span> LD_LIBRARY_PATH=/home/wpsze/WRF/WRF4-elec/wrf_install/boxmg4wrf/lib:<span class="hljs-variable">$LD_LIBRARY_PATH</span><br><span class="hljs-built_in">export</span> CPPFLAGS=-I/home/wpsze/WRF/WRF4-elec/wrf_install/boxmg4wrf/include<br><span class="hljs-built_in">echo</span> <span class="hljs-variable">$&#123;LD_LIBRARY_PATH&#125;</span><br><br><span class="hljs-built_in">export</span> BOXMG_MPI=<span class="hljs-built_in">yes</span><br><br>make<br></code></pre></td></tr></table></figure><p>it shows,</p><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs mipsasm">- <span class="hljs-keyword">building </span><span class="hljs-keyword">boxmg-sym-std-2D </span>objects in libboxmg_opt_sgl.a ... <br>- <span class="hljs-keyword">building </span><span class="hljs-keyword">boxmg-sym-std-3D </span>objects in libboxmg_opt_sgl.a ... <br>- linking objects .... <br>- the executable ex_direct_1_f90 has <span class="hljs-keyword">been </span>created.<br></code></pre></td></tr></table></figure><ul><li>boxmg-sym-std-3D/ex_direct_1_f90 is successful.</li><li>All the rest fails. (why? related RKIND issue.)</li></ul><h3 id="configurecompile-wrf">Configure/compile WRF</h3><div class="note note-danger">            <p>Important note:<br />Compile WRF using <strong>only one core</strong> with BoxMG !!!<br />./compile -j 1 em_real 2&gt;&amp;1 | tee compile.log</p>          </div><p>To configure WRF, two environment variables must be set: WRF_ELEC and BOXMG</p><p>For bash:</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-built_in">export</span> WRF_ELEC=1<br><span class="hljs-built_in">export</span> BOXMGLIBDIR=[path to boxmg directory]<br></code></pre></td></tr></table></figure><p>For example, if the boxmg library directory is /home/wpsze/WRF/WRF4-elec/wrf_install/boxmg4wrf/lib, then (for bash)</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-built_in">export</span> BOXMGLIBDIR=/home/wpsze/WRF/WRF4-elec/wrf_install/boxmg4wrf/<br></code></pre></td></tr></table></figure><p>Then run 'configure' in the WRF main directory and select an option for <strong>'dmpar' (distributed memory parallel)</strong>. The code is set up only to use the MPI parallel solver from BoxMG, so do not compile for serial mode. (It can still be run on a single processor, however.)</p><h2 id="microtedwrf4-elec">MicroTed/wrf4-elec</h2><p><a href="https://github.com/MicroTed/wrf4-elec" class="uri">https://github.com/MicroTed/wrf4-elec</a></p><p>The impact of initial conditions in predicting lightning activity using the Weather Research and Forecasting (WRF) with the electrification (ELEC) extra package, known as WRF-ELEC model, has been investigated.</p><h3 id="an-example-of-namelist.input">An example of namelist.input</h3><p><a href="https://github.com/MicroTed/wrf4-elec/blob/7c90e71bdc4db527d0ec034804e4fd200cdacf28/test/em_quarter_ss/electest/namelist.input#L55" class="uri">https://github.com/MicroTed/wrf4-elec/blob/7c90e71bdc4db527d0ec034804e4fd200cdacf28/test/em_quarter_ss/electest/namelist.input#L55</a></p><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs makefile">&amp;physics<br>mp_physics                          = 18,     1,     1,<br>elec_physics                        = 1,<br>nssl_ipelec                         = 2,<br>nssl_cccn                           = 0.8e9,<br>nssl_isaund                         = 11,<br>nssl_iscreen                        = 1,<br>nssl_idischarge                     = 1,<br>nssl_ibrkd                          = 4,<br>ra_lw_physics                       = 0,     0,     0,<br>ra_sw_physics                       = 0,     0,     0,<br>radt                                = 30,    30,    30,<br>sf_sfclay_physics                   = 0,     0,     0,<br>sf_surface_physics                  = 0,     0,     0,<br>bl_pbl_physics                      = 0,     0,     0,<br>bldt                                = 0,     0,     0,<br>cu_physics                          = 0,     0,     0,<br>cudt                                = 5,     5,     5,<br>num_soil_layers                     = 5,<br>/<br></code></pre></td></tr></table></figure><h2 id="readme.electricity">README.electricity</h2><div class="note note-primary">            <p><a href="https://github.com/MicroTed/wrf4-elec/blob/7c90e71bdc4db527d0ec034804e4fd200cdacf28/doc/README.electricity#L41" class="uri">https://github.com/MicroTed/wrf4-elec/blob/7c90e71bdc4db527d0ec034804e4fd200cdacf28/doc/README.electricity#L41</a></p>          </div><h2 id="wrf4-elecs-registry.elec">wrf4-elec's registry.elec</h2><p><a href="https://github.com/MicroTed/wrf4-elec/blob/main/Registry/registry.elec" class="uri">https://github.com/MicroTed/wrf4-elec/blob/main/Registry/registry.elec</a></p><div class="note note-primary">            <p>Look at namelist !!</p>          </div><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-comment"># SPACE CHARGE EXPLICIT LIGHTNING</span><br><span class="hljs-attribute">state</span>   real    scr            ikjftb  scalar      <span class="hljs-number">1</span>         -     \<br>   <span class="hljs-attribute">i0rhusdf</span>=(bdy_interp:dt)    <span class="hljs-string">&quot;SCR&quot;</span>       <span class="hljs-string">&quot;Rain space charge mixing ratio&quot;</span> <span class="hljs-string">&quot;# C kg(-1)&quot;</span><br><span class="hljs-attribute">state</span>   real    scw            ikjftb  scalar      <span class="hljs-number">1</span>         -     \<br>   <span class="hljs-attribute">i0rhusdf</span>=(bdy_interp:dt)    <span class="hljs-string">&quot;SCW&quot;</span>       <span class="hljs-string">&quot;cloud water space charge mixing ratio&quot;</span> <span class="hljs-string">&quot;# C kg(-1)&quot;</span><br><span class="hljs-attribute">state</span>   real    sci            ikjftb  scalar      <span class="hljs-number">1</span>         -     \<br>   <span class="hljs-attribute">i0rhusdf</span>=(bdy_interp:dt)    <span class="hljs-string">&quot;SCI&quot;</span>       <span class="hljs-string">&quot;cloud ice space charge mixing ratio&quot;</span> <span class="hljs-string">&quot;# C kg(-1)&quot;</span><br><span class="hljs-attribute">state</span>   real    scs            ikjftb  scalar      <span class="hljs-number">1</span>         -     \<br>   <span class="hljs-attribute">i0rhusdf</span>=(bdy_interp:dt)    <span class="hljs-string">&quot;SCS&quot;</span>       <span class="hljs-string">&quot;snow space charge mixing ratio&quot;</span> <span class="hljs-string">&quot;# C kg(-1)&quot;</span><br><span class="hljs-attribute">state</span>   real    sch            ikjftb  scalar      <span class="hljs-number">1</span>         -     \<br>   <span class="hljs-attribute">i0rhusdf</span>=(bdy_interp:dt)    <span class="hljs-string">&quot;SCH&quot;</span>       <span class="hljs-string">&quot;graupel water space charge mixing ratio&quot;</span> <span class="hljs-string">&quot;# C kg(-1)&quot;</span><br><span class="hljs-attribute">state</span>   real    schl           ikjftb  scalar      <span class="hljs-number">1</span>         -     \<br>   <span class="hljs-attribute">i0rhusdf</span>=(bdy_interp:dt)    <span class="hljs-string">&quot;SCHL&quot;</span>       <span class="hljs-string">&quot;hail water space charge mixing ratio&quot;</span> <span class="hljs-string">&quot;# C kg(-1)&quot;</span><br><span class="hljs-attribute">state</span>   real    sciona          ikjftb  scalar      <span class="hljs-number">1</span>         -     \<br>   <span class="hljs-attribute">i0rhusdf</span>=(bdy_interp:dt)    <span class="hljs-string">&quot;SCIONA&quot;</span>       <span class="hljs-string">&quot;Passive net ion space charge&quot;</span> <span class="hljs-string">&quot;# C kg(-1)&quot;</span><br><span class="hljs-attribute">state</span>   real    clnox          ikjftb  scalar      <span class="hljs-number">1</span>         -     \<br>   <span class="hljs-attribute">i0rhusdf</span>=(bdy_interp:dt)    <span class="hljs-string">&quot;CLNOX&quot;</span>      <span class="hljs-string">&quot;Lightning NOx concentration&quot;</span> <span class="hljs-string">&quot;# moles kg(-1)&quot;</span><br><span class="hljs-comment"># END SPACE CHARGE EXPLICIT LIGHTNING</span><br><br><span class="hljs-comment"># EXPLICIT LIGHTNING</span><br><span class="hljs-comment">#</span><br><span class="hljs-attribute">state</span>    real    rscghis_2d      ij   misc    <span class="hljs-number">1</span>         -     irh         <span class="hljs-string">&quot;rscghis_2d&quot;</span>             <span class="hljs-string">&quot;MAX NONINDUCTIVE CHARGING 2D&quot;</span>     <span class="hljs-string">&quot;C m-2&quot;</span><br><span class="hljs-attribute">state</span>    real    induc           ikj  misc    <span class="hljs-number">1</span>         -     irh         <span class="hljs-string">&quot;induc&quot;</span>                  <span class="hljs-string">&quot;TOTAL INDUCTIVE CHARGING &quot;</span>     <span class="hljs-string">&quot;C m-3&quot;</span><br><span class="hljs-attribute">state</span>    real    noninduc        ikj  misc    <span class="hljs-number">1</span>         -     irh         <span class="hljs-string">&quot;noninduc&quot;</span>               <span class="hljs-string">&quot;TOTAL NONINDUCTIVE CHARGING&quot;</span>     <span class="hljs-string">&quot;C m-3&quot;</span><br><span class="hljs-attribute">state</span>    real    sctot           ikj  misc    <span class="hljs-number">1</span>         -     irh         <span class="hljs-string">&quot;sctot&quot;</span>                  <span class="hljs-string">&quot;Total Space Charge Density&quot;</span>     <span class="hljs-string">&quot;C m-3&quot;</span><br><span class="hljs-attribute">state</span>    real    elecmag         ikj  misc    <span class="hljs-number">1</span>         -     irh         <span class="hljs-string">&quot;elecmag&quot;</span>                <span class="hljs-string">&quot;EFIELD MAGNITUDE&quot;</span>     <span class="hljs-string">&quot;V m-1&quot;</span><br><span class="hljs-attribute">state</span>    real    elecx           ikj  misc    <span class="hljs-number">1</span>         -     irh         <span class="hljs-string">&quot;elecx&quot;</span>                  <span class="hljs-string">&quot;EFIELD X-Component&quot;</span>     <span class="hljs-string">&quot;V m-1&quot;</span><br><span class="hljs-attribute">state</span>    real    elecy           ikj  misc    <span class="hljs-number">1</span>         -     irh         <span class="hljs-string">&quot;elecy&quot;</span>                  <span class="hljs-string">&quot;EFIELD Y-Component&quot;</span>     <span class="hljs-string">&quot;V m-1&quot;</span><br><span class="hljs-attribute">state</span>    real    elecz           ikj  misc    <span class="hljs-number">1</span>         -     irh         <span class="hljs-string">&quot;elecz&quot;</span>                  <span class="hljs-string">&quot;EFIELD Z-Component&quot;</span>     <span class="hljs-string">&quot;V m-1&quot;</span><br><span class="hljs-attribute">state</span>    real    pot             ikj  misc    <span class="hljs-number">1</span>         -     irh         <span class="hljs-string">&quot;pot&quot;</span>                    <span class="hljs-string">&quot;POTENTIAL&quot;</span>     <span class="hljs-string">&quot;V&quot;</span><br><span class="hljs-attribute">state</span>    real    light            ij  misc    <span class="hljs-number">1</span>         -     irh         <span class="hljs-string">&quot;light&quot;</span>                  <span class="hljs-string">&quot;lightning flash initiations&quot;</span>         <span class="hljs-string">&quot;flash origin density&quot;</span><br><span class="hljs-attribute">state</span>    real    lightdens        ij  misc    <span class="hljs-number">1</span>         -     irh         <span class="hljs-string">&quot;lightdens&quot;</span>              <span class="hljs-string">&quot;lightning flash density&quot;</span>    <span class="hljs-string">&quot;flash column-1&quot;</span><br><span class="hljs-attribute">state</span>    real    lightfod         ij  misc    <span class="hljs-number">1</span>         -     irh         <span class="hljs-string">&quot;lightfod&quot;</span>               <span class="hljs-string">&quot;normalized lightning flash origin density&quot;</span>   <span class="hljs-string">&quot;flash column-1&quot;</span><br><span class="hljs-attribute">state</span>    real    flshfedic        ij  misc    <span class="hljs-number">1</span>         -     irh         <span class="hljs-string">&quot;flshfedic&quot;</span>              <span class="hljs-string">&quot;IC lightning flash extent density&quot;</span>         <span class="hljs-string">&quot;flash column-1&quot;</span><br><span class="hljs-attribute">state</span>    real    flshfedicp       ij  misc    <span class="hljs-number">1</span>         -     irh         <span class="hljs-string">&quot;flshfedicp&quot;</span>             <span class="hljs-string">&quot;IC pos lightning flash extent density&quot;</span>         <span class="hljs-string">&quot;flash column-1&quot;</span><br><span class="hljs-attribute">state</span>    real    flshfedicn       ij  misc    <span class="hljs-number">1</span>         -     irh         <span class="hljs-string">&quot;flshfedicn&quot;</span>             <span class="hljs-string">&quot;IC neg lightning flash extent density&quot;</span>         <span class="hljs-string">&quot;flash column-1&quot;</span><br><span class="hljs-attribute">state</span>    real    flshfedcg        ij  misc    <span class="hljs-number">1</span>         -     irh         <span class="hljs-string">&quot;flshfedcg&quot;</span>              <span class="hljs-string">&quot;CG lightning flash extent density&quot;</span>         <span class="hljs-string">&quot;flash column-1&quot;</span><br><span class="hljs-attribute">state</span>    real    flshfedcgn       ij  misc    <span class="hljs-number">1</span>         -     irh         <span class="hljs-string">&quot;flshfedcgn&quot;</span>             <span class="hljs-string">&quot;CG neg lightning flash extent density&quot;</span>         <span class="hljs-string">&quot;flash column-1&quot;</span><br><span class="hljs-attribute">state</span>    real    flshfedcgp       ij  misc    <span class="hljs-number">1</span>         -     irh         <span class="hljs-string">&quot;flshfedcgp&quot;</span>             <span class="hljs-string">&quot;CG pos lightning flash extent density&quot;</span>         <span class="hljs-string">&quot;flash column-1&quot;</span><br><span class="hljs-attribute">state</span>    real    lightdis         ij  misc    <span class="hljs-number">1</span>         -     irh         <span class="hljs-string">&quot;lightdis&quot;</span>               <span class="hljs-string">&quot;lightning source density&quot;</span>     <span class="hljs-string">&quot;Source column-1&quot;</span><br><span class="hljs-attribute">state</span>    real    flshi           ikj  misc    <span class="hljs-number">1</span>         -     irh         <span class="hljs-string">&quot;flshi&quot;</span>                  <span class="hljs-string">&quot;Lightning init points&quot;</span>     <span class="hljs-string">&quot;count&quot;</span><br><span class="hljs-attribute">state</span>    real    flshn           ikj  misc    <span class="hljs-number">1</span>         -     irh         <span class="hljs-string">&quot;flshn&quot;</span>                  <span class="hljs-string">&quot;Negative channels&quot;</span>     <span class="hljs-string">&quot;count&quot;</span><br><span class="hljs-attribute">state</span>    real    flshp           ikj  misc    <span class="hljs-number">1</span>         -     irh         <span class="hljs-string">&quot;flshp&quot;</span>                  <span class="hljs-string">&quot;Positive channels&quot;</span>     <span class="hljs-string">&quot;count&quot;</span><br><span class="hljs-comment"># END EXPLICIT LIGHTNING</span><br><br><br><span class="hljs-comment"># Explicit lightning</span><br><span class="hljs-attribute">rconfig</span>   integer  nssl_ipelec            namelist,physics      max_domains   <span class="hljs-number">0</span>       rh       <span class="hljs-string">&quot;Electrification selection&quot;</span>  <span class="hljs-string">&quot;&quot;</span>      <span class="hljs-string">&quot;&quot;</span><br><span class="hljs-attribute">rconfig</span>   integer  nssl_isaund            namelist,physics      <span class="hljs-number">1</span>             <span class="hljs-number">12</span>      rh       <span class="hljs-string">&quot;Charge separation selection&quot;</span>  <span class="hljs-string">&quot;&quot;</span>      <span class="hljs-string">&quot;&quot;</span><br><span class="hljs-attribute">rconfig</span>   integer  nssl_iscreen           namelist,physics      <span class="hljs-number">1</span>             <span class="hljs-number">0</span>       rh       <span class="hljs-string">&quot;Screening layer parameterization flag&quot;</span>  <span class="hljs-string">&quot;&quot;</span>      <span class="hljs-string">&quot;&quot;</span><br><span class="hljs-attribute">rconfig</span>   real     nssl_lightrad          namelist,physics      <span class="hljs-number">1</span>             <span class="hljs-number">12000</span>   rh       <span class="hljs-string">&quot;discharge cylinder radius (m)&quot;</span>  <span class="hljs-string">&quot;&quot;</span>      <span class="hljs-string">&quot;&quot;</span><br><span class="hljs-attribute">rconfig</span>   integer  nssl_idischarge        namelist,physics      <span class="hljs-number">1</span>             <span class="hljs-number">1</span>       rh       <span class="hljs-string">&quot;lightning discharge flag&quot;</span>  <span class="hljs-string">&quot;&quot;</span>      <span class="hljs-string">&quot;&quot;</span><br><span class="hljs-attribute">rconfig</span>   integer  nssl_ibrkd             namelist,physics      <span class="hljs-number">1</span>             <span class="hljs-number">4</span>       rh       <span class="hljs-string">&quot;Critical Breakeven Efield profile selection&quot;</span>  <span class="hljs-string">&quot;&quot;</span>      <span class="hljs-string">&quot;&quot;</span><br><span class="hljs-attribute">rconfig</span>   real     nssl_elgtfestop        namelist,physics      <span class="hljs-number">1</span>             <span class="hljs-number">0</span>.<span class="hljs-number">8</span>     rh       <span class="hljs-string">&quot;3D lightning initial channel stopping fraction&quot;</span>  <span class="hljs-string">&quot;&quot;</span>      <span class="hljs-string">&quot;&quot;</span><br><span class="hljs-attribute">rconfig</span>   real     nssl_ecrit             namelist,physics      <span class="hljs-number">1</span>             <span class="hljs-number">120000</span>  rh       <span class="hljs-string">&quot;Critical Breakeven Efield magnitude for discharge (V/m) assuming height-constant Ecrit profile&quot;</span>  <span class="hljs-string">&quot;&quot;</span>      <span class="hljs-string">&quot;&quot;</span><br><span class="hljs-attribute">rconfig</span>   real     nssl_disfrac           namelist,physics      <span class="hljs-number">1</span>             <span class="hljs-number">0</span>.<span class="hljs-number">3</span>     rh       <span class="hljs-string">&quot;percentile of charge removed upon discharge (BLM)&quot;</span>  <span class="hljs-string">&quot;&quot;</span>      <span class="hljs-string">&quot;&quot;</span><br><span class="hljs-attribute">rconfig</span>   real     nssl_einternal         namelist,physics      <span class="hljs-number">1</span>           <span class="hljs-number">200</span>.<span class="hljs-number">0</span>     rh       <span class="hljs-string">&quot;Lightning channel internal field (MSZ)&quot;</span>  <span class="hljs-string">&quot;&quot;</span>      <span class="hljs-string">&quot;&quot;</span><br><span class="hljs-attribute">rconfig</span>   real     nssl_tgrnd             namelist,physics      <span class="hljs-number">1</span>           <span class="hljs-number">266</span>.<span class="hljs-number">16</span>    rh       <span class="hljs-string">&quot;Temperature threshold for CG (MSZ)&quot;</span>  <span class="hljs-string">&quot;&quot;</span>      <span class="hljs-string">&quot;&quot;</span><br><span class="hljs-attribute">rconfig</span>   real     nssl_zgrnd             namelist,physics      <span class="hljs-number">1</span>             -<span class="hljs-number">1</span>.     rh       <span class="hljs-string">&quot;Height threshold for CG (MSZ)&quot;</span>  <span class="hljs-string">&quot;&quot;</span>      <span class="hljs-string">&quot;&quot;</span><br><span class="hljs-attribute">rconfig</span>   integer  nssl_clnox             namelist,physics      <span class="hljs-number">1</span>             <span class="hljs-number">0</span>       rh       <span class="hljs-string">&quot;Lightning NOX prediction flag&quot;</span>  <span class="hljs-string">&quot;&quot;</span>      <span class="hljs-string">&quot;&quot;</span><br><span class="hljs-comment"># end Explicit lightning</span><br><br><span class="hljs-attribute">rconfig</span>   integer  elec_physics           namelist,physics      <span class="hljs-number">1</span>            <span class="hljs-number">0</span>       irh       <span class="hljs-string">&quot;elec_physics&quot;</span>            <span class="hljs-string">&quot;&quot;</span>      <span class="hljs-string">&quot;&quot;</span><br><br><span class="hljs-comment"># external WRF-ELEC package</span><br><span class="hljs-attribute">package</span>   noelec             elec_physics==<span class="hljs-number">0</span>             -             -<br><span class="hljs-attribute">package</span>   eleclgt            elec_physics==<span class="hljs-number">1</span>             -             scalar:scr,scw,sci,scs,sch,schl,sciona;state:rscghis_2d,sctot,noninduc,induc,pot,elecmag,elecx,elecy,elecz,light,lightdens,lightdis<br><span class="hljs-comment"># for case of no hail (nssl_2momg)</span><br><span class="hljs-attribute">package</span>   eleclgtg           elec_physics==<span class="hljs-number">11</span>            -             scalar:scr,scw,sci,scs,sch,sciona;state:rscghis_2d,sctot,noninduc,induc,pot,elecmag,elecx,elecy,elecz,light,lightdens,lightdis,lightfod<br><br><span class="hljs-attribute">package</span> lightning1d          nssl_idischarge==<span class="hljs-number">1</span>   -    state:lightfod<br><span class="hljs-attribute">package</span> lightning3d          nssl_idischarge==<span class="hljs-number">2</span>   -    state:flshi,flshn,flshp,flshfedic,flshfedicp,flshfedicn,flshfedcg,flshfedcgp,flshfedcgn<br><span class="hljs-comment"># package lightning3da         nssl_idischarge==3   -    state:flshi,flshn,flshp</span><br><br><span class="hljs-attribute">package</span> nssl_cnox_off nssl_clnox==<span class="hljs-number">0</span>   -   -<br><span class="hljs-attribute">package</span> nssl_cnox_on  nssl_clnox==<span class="hljs-number">1</span>   -   scalar:clnox<br></code></pre></td></tr></table></figure><p>here noted,</p><!-- <style>tr:nth-child(even) {  background-color: #b2b2b2!important;  !color: #f4f4f4!important;}</style> --><table><thead><tr class="header"><th style="text-align: left;">elec_physics</th><th style="text-align: center;">nssl_ipelec</th><th style="text-align: center;">nssl_idischarge</th><th style="text-align: left;">outputs</th></tr></thead><tbody><tr class="odd"><td style="text-align: left;">1</td><td style="text-align: center;">2</td><td style="text-align: center;">1</td><td style="text-align: left;">?</td></tr><tr class="even"><td style="text-align: left;">1</td><td style="text-align: center;">3</td><td style="text-align: center;">1</td><td style="text-align: left;">scalar:scr,scw,sci,scs,sch,schl,sciona; <br> state:rscghis_2d,sctot,noninduc,induc,pot, <br> elecmag,elecx,elecy,elecz,light,lightdens,lightdis</td></tr><tr class="odd"><td style="text-align: left;">1</td><td style="text-align: center;">3</td><td style="text-align: center;">2</td><td style="text-align: left;">state:flshi,flshn,flshp,flshfedic, <br> flshfedicp,flshfedicn,flshfedcg,flshfedcgp,flshfedcgn</td></tr></tbody></table><h2 id="specific-namelist.input-options">Specific namelist.input options</h2><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><code class="hljs csharp">Specific namelist.input options are given below, along <span class="hljs-keyword">with</span> a list of output fields.<br><br><br>Electrification only works <span class="hljs-keyword">with</span> the NSSL <span class="hljs-number">2</span>-<span class="hljs-function">moment <span class="hljs-title">options</span> (<span class="hljs-params"><span class="hljs-keyword">with</span> hail</span>):</span><br><span class="hljs-function"></span><br><span class="hljs-function"> <span class="hljs-title">mp_physics</span>(<span class="hljs-params">max_dom</span>)</span><br>                                     = <span class="hljs-number">17</span>, NSSL <span class="hljs-number">2</span>-moment <span class="hljs-number">4</span>-<span class="hljs-function">ice <span class="hljs-title">scheme</span> (<span class="hljs-params">steady background CCN</span>)</span><br>                                     = <span class="hljs-number">18</span>, NSSL <span class="hljs-number">2</span>-moment <span class="hljs-number">4</span>-<span class="hljs-function">ice scheme <span class="hljs-keyword">with</span> predicted <span class="hljs-title">CCN</span> (<span class="hljs-params">better <span class="hljs-keyword">for</span> idealized than real cases</span>)</span><br>                                       ; to <span class="hljs-keyword">set</span> a <span class="hljs-keyword">global</span> CCN <span class="hljs-keyword">value</span>, use<br>                                     = <span class="hljs-number">22</span>, NSSL <span class="hljs-number">2</span>-moment <span class="hljs-number">3</span>-ice (hail species turned off)<br>                                       <br>Other variables <span class="hljs-keyword">in</span> the &amp;physics namelist:<br><br> elec_physics                        = <span class="hljs-number">0</span>, electrification (<span class="hljs-keyword">and</span> charge arrays) <span class="hljs-function">turned <span class="hljs-title">off</span> (<span class="hljs-params">DEFAULT</span>)</span><br>                                     = <span class="hljs-number">1</span>, <span class="hljs-function">electrification turned <span class="hljs-title">on</span> (<span class="hljs-params">only works <span class="hljs-keyword">with</span> mp_physics = <span class="hljs-number">17</span>, <span class="hljs-number">18</span>, <span class="hljs-keyword">or</span> <span class="hljs-number">22</span> i.e., <span class="hljs-number">2</span>-moment NSSL schemes</span>)</span><br><span class="hljs-function"></span><br><span class="hljs-function"> <span class="hljs-title">nssl_ipelec</span> (<span class="hljs-params">max_dom</span>)     ! NOTE: only <span class="hljs-keyword">set</span> <span class="hljs-keyword">this</span> to a nonzero <span class="hljs-keyword">value</span> <span class="hljs-keyword">on</span> the innermost domain</span><br>                                     = <span class="hljs-number">0</span>, <span class="hljs-function">charging turned <span class="hljs-title">off</span> (<span class="hljs-params">DEFAULT</span>)</span><br>                                     = <span class="hljs-number">2</span>, non-inductive charging only<br>                                     = <span class="hljs-number">3</span>, non-inductive + inductive charging<br>                                     = <span class="hljs-number">1</span>, <span class="hljs-function"><span class="hljs-keyword">not</span> <span class="hljs-title">used</span> (<span class="hljs-params">reserved <span class="hljs-keyword">for</span> future use</span>)</span><br><span class="hljs-function"></span><br><span class="hljs-function"> nssl_idischarge</span>                     = <span class="hljs-number">0</span>, no discharge<br>                                     = <span class="hljs-number">1</span>, Cylindrical <span class="hljs-string">&quot;1D&quot;</span> <span class="hljs-function">lightning scheme based <span class="hljs-keyword">on</span> Ziegler <span class="hljs-keyword">and</span> <span class="hljs-title">MacGorman</span> (<span class="hljs-params"><span class="hljs-number">1994</span>, JAS</span>)</span> <br>                                     = <span class="hljs-number">2</span>, <span class="hljs-number">3</span>D discrete discharge adapted <span class="hljs-keyword">from</span> MacGorman et al. (<span class="hljs-number">2001</span>)<br><br> nssl_iscreen                        = <span class="hljs-number">0</span>, <span class="hljs-function">no screening <span class="hljs-title">layer</span> (<span class="hljs-params">DEFAULT</span>)</span><br>                                     = <span class="hljs-number">1</span>, screening layer scheme of Ziegler et al. (<span class="hljs-number">1991</span>, JGR)<br>                                     = <span class="hljs-number">2</span>, <span class="hljs-function">screening layer only applied at cloud <span class="hljs-title">top</span> (<span class="hljs-params">seems to be better <span class="hljs-keyword">for</span> storm complexes <span class="hljs-keyword">and</span> large storms</span>)</span><br><span class="hljs-function"></span><br><span class="hljs-function"> nssl_ibrkd</span>                          = breakdown electric field profile to initiate lightning<br>                                     = <span class="hljs-number">1</span>, constant profile <span class="hljs-keyword">with</span> height <span class="hljs-keyword">with</span> <span class="hljs-keyword">value</span> <span class="hljs-keyword">set</span> <span class="hljs-keyword">by</span> nssl_ecrit<br>                                     = <span class="hljs-number">2</span> to <span class="hljs-number">5</span>, <span class="hljs-function">variants of vertical Ecrit profile of <span class="hljs-title">Dwyer</span> (<span class="hljs-params"><span class="hljs-number">2003</span>, GRL</span>) - &#x27;4&#x27; <span class="hljs-keyword">is</span> <span class="hljs-title">recommended</span> (<span class="hljs-params">DEFAULT <span class="hljs-keyword">is</span> <span class="hljs-number">4</span></span>).</span><br><span class="hljs-function"></span><br><span class="hljs-function"> nssl_isaund</span>                         = <span class="hljs-function">Calls the appropriate version of the <span class="hljs-title">UMIST</span> (<span class="hljs-params">e.g., Saunders et al. <span class="hljs-number">1991</span> scheme</span>)</span><br>                                     = <span class="hljs-number">-5</span> : Saunders etal <span class="hljs-number">1991</span> (following Helsdon et al. <span class="hljs-number">2001</span>, but use normal charging instead of <span class="hljs-string">&#x27;anomalous&#x27;</span> zones)<br>                                     = <span class="hljs-number">0</span> : Saunders <span class="hljs-number">1991</span> (modified <span class="hljs-keyword">as</span> <span class="hljs-keyword">in</span> Wojcik <span class="hljs-number">1994</span>)<br>                                     = <span class="hljs-number">2</span> : <span class="hljs-function">RR <span class="hljs-title">scheme</span> (<span class="hljs-params"> no extra factor </span>) (<span class="hljs-params">Mansell et al. <span class="hljs-number">2005</span>, JGR</span>)</span><br>                                     = <span class="hljs-number">4</span> : <span class="hljs-function">Saunders <span class="hljs-keyword">and</span> Peck <span class="hljs-title">Scheme</span> (<span class="hljs-params"> no extra factor </span>) (<span class="hljs-params">Mansell et al. <span class="hljs-number">2005</span>, JGR</span>)</span><br>                                     = <span class="hljs-number">9</span> : <span class="hljs-function">Saunders <span class="hljs-keyword">and</span> Peck <span class="hljs-title">Scheme</span> (<span class="hljs-params"> no extra factor, cutoff at <span class="hljs-number">-32.47</span> <span class="hljs-keyword">as</span> orig eq. <span class="hljs-keyword">from</span> sp98 </span>) (<span class="hljs-params">Mansell et al. <span class="hljs-number">2010</span>, JAS</span>)</span><br>                                     = <span class="hljs-number">10</span> : Brooks et al. RARcrit <span class="hljs-keyword">for</span> T &gt; <span class="hljs-number">-15</span> <span class="hljs-function"><span class="hljs-keyword">using</span> <span class="hljs-title">saund2</span> (<span class="hljs-params">otherwise same <span class="hljs-keyword">as</span> isaund=<span class="hljs-number">2</span></span>) (<span class="hljs-params"><span class="hljs-keyword">set</span> rarfac to negative <span class="hljs-keyword">in</span> saund2</span>)</span><br>                                     = <span class="hljs-number">11</span> : Brooks et al. RARcrit <span class="hljs-keyword">for</span> T &gt; <span class="hljs-number">-15</span> <span class="hljs-function"><span class="hljs-keyword">using</span> <span class="hljs-title">saund6</span> (<span class="hljs-params">otherwise same <span class="hljs-keyword">as</span> isaund=<span class="hljs-number">4</span></span>)</span><br>                                     = <span class="hljs-number">12</span> : Brooks et al. RARcrit <span class="hljs-keyword">for</span> T &gt; <span class="hljs-number">-15</span> <span class="hljs-function"><span class="hljs-keyword">using</span> <span class="hljs-title">saund6</span> (<span class="hljs-params">otherwise same <span class="hljs-keyword">as</span> isaund=<span class="hljs-number">9</span></span>) (<span class="hljs-params">DEFAULT</span>)</span><br>                                     = <span class="hljs-number">13</span> : Brooks et al. RARcrit <span class="hljs-keyword">for</span> T &gt; <span class="hljs-number">-15</span> <span class="hljs-function"><span class="hljs-keyword">using</span> <span class="hljs-title">saund8</span> (<span class="hljs-params">cosine roll-off function <span class="hljs-keyword">for</span> smoother approach to zero at low temperature</span>)</span><br><span class="hljs-function">                                   For <span class="hljs-title">Takahashi</span> (<span class="hljs-params"><span class="hljs-number">1978</span>, <span class="hljs-number">1984</span></span>) charge <span class="hljs-title">separation</span> (<span class="hljs-params">see below</span>)</span><br>                                     = <span class="hljs-number">1</span> : Takahashi <span class="hljs-number">1984</span> <span class="hljs-keyword">with</span> factors <span class="hljs-keyword">for</span> crystal size <span class="hljs-keyword">and</span> impact speed<br>                                     = <span class="hljs-number">3</span> : Takahashi <span class="hljs-number">1984</span> WITHOUT factors <span class="hljs-keyword">for</span> crystal size <span class="hljs-keyword">and</span> impact speed<br><br><br> nssl_lightrad                       = <span class="hljs-number">12000</span>, radius (m) of discharge cylinder <span class="hljs-keyword">for</span> <span class="hljs-number">1</span>-D discharge scheme<br><br> nssl_disfrac                        = <span class="hljs-number">0.3</span>, <span class="hljs-function">nominal fraction of charge removed per <span class="hljs-title">discharge</span> (<span class="hljs-params"><span class="hljs-keyword">for</span> <span class="hljs-number">1</span>D lightning</span>)</span><br><span class="hljs-function"></span><br><span class="hljs-function"> nssl_ecrit</span>                          = <span class="hljs-number">120000</span>, <span class="hljs-function">breakdown electric <span class="hljs-title">field</span> (<span class="hljs-params">Volts/m</span>) to initiate <span class="hljs-title">lightning</span> (<span class="hljs-params">i.e., constant <span class="hljs-keyword">value</span> <span class="hljs-keyword">with</span> height</span>). (<span class="hljs-params"><span class="hljs-keyword">for</span> nssl_ibrkd=<span class="hljs-number">1</span></span>)</span><br><span class="hljs-function"></span><br><span class="hljs-function"> 3D discharge namelist options</span><br><span class="hljs-function"> NSSL_EINTERNAL</span>  =   <span class="hljs-number">200.0000</span>  : <span class="hljs-function"><span class="hljs-keyword">internal</span> field <span class="hljs-keyword">for</span> channel <span class="hljs-title">resistance</span> (<span class="hljs-params">V/m</span>)</span><br><span class="hljs-function"> NSSL_TGRND</span>      =   <span class="hljs-number">266.1600</span>  : Temperature threshold <span class="hljs-keyword">for</span> considering CG flash<br> NSSL_ZGRND      =  <span class="hljs-number">-1.000000</span>  : <span class="hljs-function">Altitude threshold <span class="hljs-keyword">for</span> considering CG <span class="hljs-title">flash</span> (<span class="hljs-params">only <span class="hljs-keyword">if</span> &gt; <span class="hljs-number">0</span>, otherwise uses temperature</span>)</span><br><span class="hljs-function"></span><br><span class="hljs-function">The <span class="hljs-title">Takahashi</span> (<span class="hljs-params"><span class="hljs-number">1978</span>, <span class="hljs-number">1984</span></span>) charge separation requires a lookup table to be read <span class="hljs-keyword">in</span>. </span><br><span class="hljs-function">The table file <span class="hljs-keyword">is</span> &#x27;takahashi.txt&#x27; <span class="hljs-keyword">and</span> needs to be copied <span class="hljs-keyword">from</span> WRF/elec to the working </span><br><span class="hljs-function">directory. To use <span class="hljs-keyword">this</span> option, the NSSL microphysics can read an <span class="hljs-keyword">internal</span> namelist, </span><br><span class="hljs-function">which needs &#x27;nonigrd</span> = <span class="hljs-number">-1&#x27;</span>:<br><br>&amp;nssl_mp_params<br>  nonigrd = <span class="hljs-number">-1</span><br>/<br><br>Also <span class="hljs-keyword">set</span> the <span class="hljs-keyword">value</span> nssl_isaund=<span class="hljs-number">1</span><br></code></pre></td></tr></table></figure><h2 id="output-fields">Output fields</h2><figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs livecodeserver"><span class="hljs-number">2</span>D, <span class="hljs-built_in">time</span>-dependent:<br><br>  LIGHT      : Sum <span class="hljs-keyword">of</span> lightning initations <span class="hljs-keyword">in</span> <span class="hljs-keyword">the</span> column (For <span class="hljs-number">1</span>D discharge, this counts all points that <br>                 have electric field magnitude that exceeds <span class="hljs-keyword">the</span> initiation threshold<br>  LIGHTDENS  : Flash extent density (FED; <span class="hljs-built_in">sum</span> <span class="hljs-keyword">of</span> <span class="hljs-keyword">the</span> <span class="hljs-built_in">number</span> <span class="hljs-keyword">of</span> flashes that extend <span class="hljs-keyword">into</span> <span class="hljs-keyword">the</span> grid column)<br>  LIGHTDIS   : A kind <span class="hljs-keyword">of</span> <span class="hljs-string">&quot;source point&quot;</span> density that adds up <span class="hljs-keyword">the</span> <span class="hljs-built_in">number</span> <span class="hljs-keyword">of</span> points <span class="hljs-keyword">in</span> <span class="hljs-keyword">a</span> column where<br>                 lightning charge is deposited<br>  rscghis_2d : column <span class="hljs-built_in">sum</span> <span class="hljs-keyword">of</span> charge separation (magnitude) over <span class="hljs-keyword">the</span> history interval<br><br>  For <span class="hljs-number">3</span>D lightning:<br><br>   flshfedic - FED <span class="hljs-built_in">from</span> IC flashes<br>   flshfedicp - FED <span class="hljs-built_in">from</span> IC flashes (pos. channels)<br>   flshfedicn - FED <span class="hljs-built_in">from</span> IC flashes (neg. channels)<br>   flshfedcg - FED <span class="hljs-built_in">from</span> CG flashes<br>   flshfedcgp - FED <span class="hljs-built_in">from</span> CG flashes (pos. channels)<br>   flshfedcgn - FED <span class="hljs-built_in">from</span> CG flashes (neg. channels)<br>   <br><span class="hljs-number">3</span>D, <span class="hljs-built_in">time</span>-dependent:<br><br>  POT         : Electric potential (Volts)<br>  ELECMAG     : Electric field magnitude (V/m)<br>  ELECX       : x-component <span class="hljs-keyword">of</span> E (V/m)<br>  ELECY       : y-component <span class="hljs-keyword">of</span> E (V/m)<br>  ELECZ       : z-component <span class="hljs-keyword">of</span> E (V/m)<br>  INDUC       : Inductive charge separation rate (C m^<span class="hljs-number">-3</span> s^<span class="hljs-number">-1</span>)<br>  NONINDUC    : Net noninductive charge separation rate (C m^<span class="hljs-number">-3</span> s^<span class="hljs-number">-1</span>)<br>  SCW         : Charge density carried <span class="hljs-keyword">by</span> cloud droplets (C/kg, i.e., <span class="hljs-string">&#x27;charge mixing ratio&#x27;</span>)<br>  SCR         : Charge density carried <span class="hljs-keyword">by</span> rain (C/kg)<br>  SCI         : Charge density carried <span class="hljs-keyword">by</span> cloud ice (C/kg)<br>  SCS         : Charge density carried <span class="hljs-keyword">by</span> snow (C/kg)<br>  SCH         : Charge density carried <span class="hljs-keyword">by</span> graupel (C/kg)<br>  SCHL        : Charge density carried <span class="hljs-keyword">by</span> hail (C/kg)<br>  SCTOT       : Net charge density (C m^<span class="hljs-number">-3</span>) Is NOT mixing ratio<br>  SCIONA      : Residual charge <span class="hljs-built_in">from</span> lightning <span class="hljs-keyword">and</span> evaporating hydrometeors that has <span class="hljs-keyword">not</span> been reattached <span class="hljs-built_in">to</span> another species (C/kg)<br><br>  For <span class="hljs-number">3</span>D lightning:<br>    FLSHN, FLSHP : Negative/positive <span class="hljs-string">&quot;channel&quot;</span> points<br>    FLSHI : Flash initiation points<br></code></pre></td></tr></table></figure><h2 id="sourceforege">sourceforege</h2><p><a href="https://sourceforge.net/projects/wrfelec/files/" class="uri">https://sourceforge.net/projects/wrfelec/files/</a></p><p>Source: README.wrfelec, updated 2015-05-04</p><h1 id="compilation-process-details">Compilation process details</h1><ul><li>BoxMG directory: /home/wpsze/WRF/WRF4-elec/wrf_install/boxmg4wrf/</li></ul><div class="note note-danger">            <p>Important note:<br />Compile WRF using <strong>only one core</strong> with BoxMG !!!<br />./compile -j 1 em_real 2&gt;&amp;1 | tee compile.log</p>          </div><p>part of script is shown below,</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-built_in">export</span> WRF_ELEC=1<br><span class="hljs-built_in">export</span> BOXMGLIBDIR=/home/wpsze/WRF/WRF4-elec/wrf_install/boxmg4wrf<br><br><span class="hljs-built_in">cd</span> wrf4-elec/<br><br>./clean -a<br>./configure <br><span class="hljs-comment">##  9 (dmpar) GNU [gfortran/gcc]</span><br><br>sed -i <span class="hljs-string">&quot;s/\s\stime\s//g&quot;</span> configure.wrf<br>./compile -j 1 em_real 2&gt;&amp;1 | <span class="hljs-built_in">tee</span> compile.log<br></code></pre></td></tr></table></figure><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><code class="hljs sh">checking <span class="hljs-keyword">for</span> perl5... no<br>checking <span class="hljs-keyword">for</span> perl... found /usr/bin/perl (perl)<br>Will use NETCDF <span class="hljs-keyword">in</span> <span class="hljs-built_in">dir</span>: /home/wpsze/WRF/WRFv440/Library/<br>ADIOS2 not <span class="hljs-built_in">set</span> <span class="hljs-keyword">in</span> environment. Will configure WRF <span class="hljs-keyword">for</span> use without.<br>Will use HDF5 <span class="hljs-keyword">in</span> <span class="hljs-built_in">dir</span>: /home/wpsze/WRF/WRFv440/Library/<br>PHDF5 not <span class="hljs-built_in">set</span> <span class="hljs-keyword">in</span> environment. Will configure WRF <span class="hljs-keyword">for</span> use without.<br>Building WRF with electrification option<br>!-DWRF_ELEC=1<br>Will use BoxMG <span class="hljs-keyword">in</span> <span class="hljs-built_in">dir</span>: /home/wpsze/WRF/WRF4-elec/wrf_install/boxmg4wrf/<br>Will use <span class="hljs-string">&#x27;time&#x27;</span> to report timing information<br><span class="hljs-built_in">set</span> sw_boxmg_path<br>WRF_ELEC was found <span class="hljs-keyword">in</span>  -DWRF_ELEC=1<br><span class="hljs-variable">$JASPERLIB</span> or <span class="hljs-variable">$JASPERINC</span> not found <span class="hljs-keyword">in</span> environment, configuring to build without grib2 I/O...<br>------------------------------------------------------------------------<br>Please <span class="hljs-keyword">select</span> from among the following Linux x86_64 options:<br><br>  1. (dmpar)   PGI (pgf90/gcc)<br>  2. (dmpar)   PGI (pgf90/pgcc): SGI MPT<br>  3. (dmpar)   PGI (pgf90/gcc): PGI accelerator<br>  4. (dmpar)   INTEL (ifort/icc)<br>               INTEL (ifort/icc): Xeon Phi (MIC architecture)<br>  5. (dmpar)   INTEL (ifort/icc): Xeon (SNB with AVX mods)<br>  6. (dmpar)   INTEL (ifort/icc): SGI MPT<br>  7. (dmpar)   INTEL (ifort/icc): IBM POE<br>  8. (dmpar)   PATHSCALE (pathf90/pathcc)<br>  9. (dmpar)   GNU (gfortran/gcc)<br> 1.  (dmpar)   IBM (xlf90_r/cc_r)<br> 2.  (dmpar)   PGI (ftn/gcc): Cray XC CLE<br> 3.  (dmpar)   CRAY CCE (ftn $(NOOMP)/cc): Cray XE and XC<br> 4.  (dmpar)   INTEL (ftn/icc): Cray XC<br> 5.  (dmpar)   PGI (pgf90/pgcc)<br> 6.  (dmpar)   PGI (pgf90/gcc): -f90=pgf90<br> 7.  (dmpar)   PGI (pgf90/pgcc): -f90=pgf90<br> 8.  (dmpar)   INTEL (ifort/icc): HSW/BDW<br> 9.  (dmpar)   INTEL (ifort/icc): KNL MIC<br> 10. (dmpar)   AMD (flang/clang) :  AMD ZEN1/ ZEN2/ ZEN3 Architectures<br> 11. (dmpar)   FUJITSU (frtpx/fccpx): FX10/FX100 SPARC64 IXfx/Xlfx<br><br>Enter selection [1-20] : 9<br><br>......<br><br><span class="hljs-comment">######################</span><br>------------------------------------------------------------------------<br>Settings listed above are written to configure.wrf.<br>If you wish to change settings, please edit that file.<br>If you wish to change the default options, edit the file:<br>     <span class="hljs-built_in">arch</span>/configure.defaults<br>NetCDF <span class="hljs-built_in">users</span> note:<br> This installation of NetCDF supports large file support.  To DISABLE large file<br> support <span class="hljs-keyword">in</span> NetCDF, <span class="hljs-built_in">set</span> the environment variable WRFIO_NCD_NO_LARGE_FILE_SUPPORT<br> to 1 and run configure again. Set to any other value to avoid this message.<br>  <br><br>Testing <span class="hljs-keyword">for</span> NetCDF, C and Fortran compiler<br><br>This installation of NetCDF is 64-bit<br>                 C compiler is 64-bit<br>           Fortran compiler is 64-bit<br>              It will build <span class="hljs-keyword">in</span> 64-bit<br> <br>NetCDF version: 4.7.4<br>Enabled NetCDF-4/HDF-5: <span class="hljs-built_in">yes</span><br>NetCDF built with PnetCDF: no<br></code></pre></td></tr></table></figure><p>there is an extra folder called "elec",</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs sh"> $ <span class="hljs-built_in">ls</span> wrf4-elec/elec/<br>binwrf.pl                           module_discharge.F<br>depend.elec                         module_discharge_msz.F<br>include_microphysics_driver_elec.F  module_mp_nssl_2mom_elec.F<br>include_solve_lightningnudge.F      module_nudge_light.F<br>Makefile                            module_screen.F<br>module_boxmgsetup.F                 takahashi.txt<br>module_commasmpi.F<br></code></pre></td></tr></table></figure><h1 id="compile-errors">Compile Errors</h1><ol type="1"><li>Error NoahMP submodule files not populating WRF directories.<ol type="1"><li><a href="https://waipangsze.github.io/2024/06/04/WRF_install_Error_NoahMP_submodule_files/" class="uri">https://waipangsze.github.io/2024/06/04/WRF_install_Error_NoahMP_submodule_files/</a></li><li>Download noahmp @ xxxx folder to your local /WRF/phys/</li><li>wrf4-elec is noahmp @ 3be0b28</li></ol></li><li>time No such file or directory.<ol type="1"><li><a href="https://waipangsze.github.io/2024/05/29/WRF_install_time_error/" class="uri">https://waipangsze.github.io/2024/05/29/WRF_install_time_error/</a></li></ol></li></ol><h1 id="done">Done</h1><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs sh">---&gt;                  Executables successfully built                  &lt;---<br> <br>-rwxrwxr-x 1 wpsze wpsze 44236440 Sep 24 14:26 main/ndown.exe<br>-rwxrwxr-x 1 wpsze wpsze 44121776 Sep 24 14:26 main/real.exe<br>-rwxrwxr-x 1 wpsze wpsze 43532016 Sep 24 14:26 main/tc.exe<br>-rwxrwxr-x 1 wpsze wpsze 50585304 Sep 24 14:25 main/wrf.exe<br><br> $ <span class="hljs-built_in">ls</span> run/*exe<br>run/ndown.exe  run/real.exe  run/tc.exe  run/wrf.ex<br></code></pre></td></tr></table></figure><h1 id="wrf-elec-outputs">WRF-ELEC outputs</h1><p>It is important to note that the FOD and reflectivity are derived from ELEC, whereas the LPI originates from WRF-ARW simulations.</p><h2 id="simulated-radar-reflectivity">simulated radar reflectivity</h2><p>radar reflectivity is diagnosed.</p><ul><li><a href="https://wrf-python.readthedocs.io/en/latest/user_api/generated/wrf.dbz.html" class="uri">https://wrf-python.readthedocs.io/en/latest/user_api/generated/wrf.dbz.html</a></li><li>This function computes equivalent reflectivity factor [dBZ] at each model grid point assuming spherical particles of constant density, with exponential size distributions. This function is based on “dbzcalc.f” in RIP.</li></ul><p>or on namelist,</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sh">&amp;physics<br>...<br>do_radar_ref = 0, ; 1 = allows radar reflectivity to be computed using mp-scheme-specific parameters.  Currently works <span class="hljs-keyword">for</span> mp_physics = 2,4,6,7,8,10,14,16<br></code></pre></td></tr></table></figure><p>with do_radar_reflectivity=1 and after running got the REFL_10cm variable. But this variable REFL_10cm is giving the estimated 10 cm wavelength (S-band) radar reflectivity in dB relative to reflectivity (dBZ) as produced by the WRF microphysics scheme.</p><blockquote><p>but, above mp_physics = 17 or 18?</p></blockquote><h2 id="lightning_option-from-wrf-arw">lightning_option (from WRF-ARW)</h2><p>Lightning parameterization option to allow flash rate prediction without chemistry.</p><p><a href="https://ruc.noaa.gov/wrf/wrf-chem/Users_guide.pdf">WRF-Chem Version 4.4 User's Guide: Appendix C: Using the Lightning-NOx Parameterization in WRF-Chem</a></p><div class="note note-primary">            <p>(for convection resolved runs; must also use do_radar_ref = 1, and mp_physics = 2,4,6,7,8,10,14, or 16)</p>          </div><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">lightning_option (max_dom)                       Lightning parameterization <span class="hljs-keyword">option</span> <span class="hljs-keyword">to</span> allow flash rate prediction <span class="hljs-keyword">without</span> chemistry<br>                                    = <span class="hljs-number">0</span>        ! <span class="hljs-keyword">off</span><br>                                    = <span class="hljs-number">1</span>        ! PR92 based <span class="hljs-keyword">on</span> maximum w, redistributes flashes <span class="hljs-keyword">within</span> dBZ &gt; <span class="hljs-number">20</span> (<span class="hljs-keyword">for</span> convection resolved runs; must <span class="hljs-keyword">also</span> use <br>                     do_radar_ref = <span class="hljs-number">1</span>, <span class="hljs-keyword">and</span> mp_physics = <span class="hljs-number">2</span>,<span class="hljs-number">4</span>,<span class="hljs-number">6</span>,<span class="hljs-number">7</span>,<span class="hljs-number">8</span>,<span class="hljs-number">10</span>,<span class="hljs-number">14</span>, <span class="hljs-keyword">or</span> <span class="hljs-number">16</span>)<br>                                    = <span class="hljs-number">2</span>        ! PR92 based <span class="hljs-keyword">on</span> <span class="hljs-number">20</span> dBZ top, redistributes flashes <span class="hljs-keyword">within</span> dBZ &gt; <span class="hljs-number">20</span> (<span class="hljs-keyword">for</span> convection resolved runs; must <span class="hljs-keyword">also</span> use <br>                     do_radar_ref = <span class="hljs-number">1</span>, <span class="hljs-keyword">and</span> mp_physics = <span class="hljs-number">2</span>,<span class="hljs-number">4</span>,<span class="hljs-number">6</span>,<span class="hljs-number">7</span>,<span class="hljs-number">8</span>,<span class="hljs-number">10</span>,<span class="hljs-number">14</span>, <span class="hljs-keyword">or</span> <span class="hljs-number">16</span>)<br>                                    = <span class="hljs-number">3</span>        ! Predicting the potential <span class="hljs-keyword">for</span> lightning activity (based <span class="hljs-keyword">on</span> Yair et al, <span class="hljs-number">2010</span>, J. Geophys. Res., <span class="hljs-number">115</span>, D04205, doi:<span class="hljs-number">10.1029</span>/<span class="hljs-number">2008</span>JD010868) <br>                                    = <span class="hljs-number">11</span>       ! PR92 based <span class="hljs-keyword">on</span> <span class="hljs-keyword">level</span> <span class="hljs-keyword">of</span> neutral buoyancy <span class="hljs-keyword">from</span> convective parameterization (<span class="hljs-keyword">for</span> scales<br>                                                <span class="hljs-keyword">where</span> a CPS <span class="hljs-keyword">is</span> used, intended <span class="hljs-keyword">for</span> use at <span class="hljs-number">10</span> &lt; dx &lt; <span class="hljs-number">50</span> km; must <span class="hljs-keyword">also</span> use cu_physics = <span class="hljs-number">5</span> <span class="hljs-keyword">or</span> <span class="hljs-number">93</span>)<br>lightning_dt  (max_dom)             = <span class="hljs-number">0.</span>       ! <span class="hljs-type">time</span> <span class="hljs-type">interval</span> (seconds) <span class="hljs-keyword">for</span> calling lightning parameterization. <span class="hljs-keyword">Default</span> uses model <span class="hljs-type">time</span> step<br>lightning_start_seconds (max_dom)   = <span class="hljs-number">0.</span>       ! <span class="hljs-keyword">Start</span> <span class="hljs-type">time</span> <span class="hljs-keyword">for</span> calling lightning parameterization. Recommends at least <span class="hljs-number">10</span> minutes <span class="hljs-keyword">for</span> spin-up.<br>flashrate_factor  (max_dom)         = <span class="hljs-number">1.0</span>      ! Factor <span class="hljs-keyword">to</span> adjust the predicted number <span class="hljs-keyword">of</span> flashes. Recommends <span class="hljs-number">1.0</span> <span class="hljs-keyword">for</span> lightning_option = <span class="hljs-number">11</span><br>                                                <span class="hljs-keyword">between</span> dx=<span class="hljs-number">10</span> <span class="hljs-keyword">and</span> <span class="hljs-number">50</span> km. Manual tuning recommended <span class="hljs-keyword">for</span> <span class="hljs-keyword">all</span> other <span class="hljs-keyword">options</span> independently<br>                                                <span class="hljs-keyword">for</span> <span class="hljs-keyword">each</span> nest.<br>cellcount_method (max_dom)                       <span class="hljs-keyword">Method</span> <span class="hljs-keyword">for</span> counting storm cells. Used <span class="hljs-keyword">by</span> CRM <span class="hljs-keyword">options</span> (lightning_options=<span class="hljs-number">1</span>,<span class="hljs-number">2</span>).<br>                                    = <span class="hljs-number">0</span>,       ! model determines <span class="hljs-keyword">method</span> used<br>                                    = <span class="hljs-number">1</span>,       ! tile-wide, appropriate <span class="hljs-keyword">for</span> <span class="hljs-keyword">large</span> domains<br>                                    = <span class="hljs-number">2</span>,       ! <span class="hljs-keyword">domain</span>-wide, appropriate <span class="hljs-keyword">for</span> sing-storm domains<br>cldtop_adjustment (max_dom)         = <span class="hljs-number">0.</span>       ! Adjustment <span class="hljs-keyword">from</span> LNB <span class="hljs-keyword">in</span> km. Used <span class="hljs-keyword">by</span> lightning_option=<span class="hljs-number">11.</span> <span class="hljs-keyword">Default</span> <span class="hljs-keyword">is</span> <span class="hljs-number">0</span>, but recommends <span class="hljs-number">2</span> km<br>iccg_method (max_dom)                            IC:CG partitioning <span class="hljs-keyword">method</span> (IC: intra-cloud; CG: cloud-<span class="hljs-keyword">to</span>-ground)<br>                                    = <span class="hljs-number">0</span>        ! <span class="hljs-keyword">Default</span> <span class="hljs-keyword">method</span> depending <span class="hljs-keyword">on</span> lightning <span class="hljs-keyword">option</span>, currently <span class="hljs-keyword">all</span> <span class="hljs-keyword">options</span> use iccg_method=<span class="hljs-number">2</span> <span class="hljs-keyword">by</span> default<br>                                    = <span class="hljs-number">1</span>        ! <span class="hljs-keyword">Constant</span> everywhere, <span class="hljs-keyword">set</span> <span class="hljs-keyword">with</span> namelist <span class="hljs-keyword">options</span> iccg_prescribed (num|den)#, <span class="hljs-keyword">default</span> <span class="hljs-keyword">is</span> <span class="hljs-number">0.</span>/<span class="hljs-number">1.</span> (<span class="hljs-keyword">all</span> CG).<br>                                    = <span class="hljs-number">2</span>        ! Coarsely prescribed <span class="hljs-number">1995</span><span class="hljs-number">-1999</span> NLDN/OTD climatology based <span class="hljs-keyword">on</span> Boccippio et al. (<span class="hljs-number">2001</span>)<br>                                    = <span class="hljs-number">3</span>        ! Parameterization <span class="hljs-keyword">by</span> Price <span class="hljs-keyword">and</span> Rind (<span class="hljs-number">1993</span>) based <span class="hljs-keyword">on</span> cold-cloud depth<br>                                    = <span class="hljs-number">4</span>        ! Gridded <span class="hljs-keyword">input</span> via arrays iccg_in_(num|den) <span class="hljs-keyword">from</span> wrfinput <span class="hljs-keyword">for</span> monthly mapped ratios. <br>                                                Points <span class="hljs-keyword">with</span> <span class="hljs-number">0</span>/<span class="hljs-number">0</span> <span class="hljs-keyword">values</span> use ratio defined <span class="hljs-keyword">by</span> iccg_prescribed_(num|den)<br>iccg_prescribed_num (max_dom)       = <span class="hljs-number">0.</span>       ! Numerator <span class="hljs-keyword">of</span> <span class="hljs-keyword">user</span>-specified prescribed IC:CG<br>iccg_prescribed_den (max_dom)       = <span class="hljs-number">1.</span>       ! Denominator <span class="hljs-keyword">of</span> <span class="hljs-keyword">user</span>-specified prescribed IC:CG<br>ltng_temp_upper                     = <span class="hljs-number">-45.</span>     ! Temperature (C) <span class="hljs-keyword">of</span> upper peak <span class="hljs-keyword">of</span> LNOx vertical distribution <span class="hljs-keyword">for</span> IC lightning (used <span class="hljs-keyword">by</span> &amp;chem lnox_opt=<span class="hljs-number">2</span>).<br>ltng_temp_lower                     = <span class="hljs-number">-15.</span>     ! Temperatures (C) <span class="hljs-keyword">of</span> lower peak <span class="hljs-keyword">of</span> LNOx vertical distribution <span class="hljs-keyword">for</span> <span class="hljs-keyword">both</span> IC <span class="hljs-keyword">and</span> CG lightning (used <span class="hljs-keyword">by</span> &amp;chem lnox_opt=<span class="hljs-number">2</span>).<br></code></pre></td></tr></table></figure><p>From WRF-MPAS-A forum,</p><ul><li><a href="https://forum.mmm.ucar.edu/threads/wrf-lightning-scheme-only-being-run-at-model-output-times.16207/#post-40290">WRF lightning scheme only being run at model output times?</a></li><li><a href="https://forum.mmm.ucar.edu/threads/lightning-option.13017/#post-31892">Lightning option</a></li><li><a href="https://forum.mmm.ucar.edu/threads/large-differences-of-simulated-fields-u-v-w-t-with-lightning_option-3-lpi-on-and-off.9338/#post-22147">Large differences of simulated fields (U, V, W, T) with lightning_option = 3 (LPI) on and off</a><ul><li>An alternative is to calculate the LPI from the model output. This can be done quite simply using an NCL program.</li></ul></li></ul><p>From <a href="https://groups.google.com/a/ucar.edu/g/wrf-chem-lightning/c/v6nIeyL7G2g" class="uri">https://groups.google.com/a/ucar.edu/g/wrf-chem-lightning/c/v6nIeyL7G2g</a>,</p><div class="note note-primary">            <p>The lightning option = 1 you chose is appropriate for dx&lt;5km because it relies on the maximum updraft speed in the storm updraft. You chose dx=10km which will not produce updraft speeds representative of thunderstorms, and in fact the storms are likely represented by the convective parameterization.</p><p>For dx=10 km, you should use lightning_option = 11.</p>          </div><h2 id="lightlightdenselectric-potential-difference-pot-from-wrf-elec">light/lightdens/Electric POTential difference (POT) (From WRF-ELEC)</h2><p>Starting with the electrification processes (inductive and non-inductive processes), calculation method of the electric field, along with the BoxMG mathematical software for computation of POT is described.</p><figure><img src="https://i.imgur.com/kgs4meR.png" alt="WRF-ELEC" /><figcaption>WRF-ELEC</figcaption></figure><h1 id="what-is-the-time-interval-in-lightflash-column-1">What is the time interval in light(flash column-1)?</h1><p><a href="https://github.com/MicroTed/wrf4-elec/blob/7c90e71bdc4db527d0ec034804e4fd200cdacf28/phys/module_microphysics_driver.F#L117" class="uri">https://github.com/MicroTed/wrf4-elec/blob/7c90e71bdc4db527d0ec034804e4fd200cdacf28/phys/module_microphysics_driver.F#L117</a></p><p>!--light 2D flash origin densities per output time !--lightdens 2D flash extent densities per output time !--lightdis 2D total number of discharge points per output time</p><ul><li>per output time?<ul><li>To find the number of flashes between output times, simply subtract the flashcount array from the previous output time from the current output time to get number of flashes per dt (where64dt = time between output files).</li></ul></li></ul><p>From <a href="https://github.com/MicroTed/wrf4-elec/blob/7c90e71bdc4db527d0ec034804e4fd200cdacf28/dyn_em/solve_em.F#L157">solve_em.F</a>, <strong>diag_flag and diag_flag_hist</strong> are</p><ul><li>Set diagnostic flag value <strong>history output time</strong></li></ul><figure class="highlight fortran"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs fortran"><span class="hljs-comment">!-----------------------------------------------------------------------------</span><br><span class="hljs-comment">!</span><br><span class="hljs-comment">! Set restart flag value history output time</span><br><span class="hljs-comment">!-----------------------------------------------------------------------------</span><br>   restart_flag = <span class="hljs-literal">.false.</span><br>   <span class="hljs-keyword">if</span> ( Is_alarm_tstep(grid%domain_clock, grid%alarms(restart_alarm)) ) <span class="hljs-keyword">then</span><br>      restart_flag = <span class="hljs-literal">.true.</span><br>   <span class="hljs-keyword">endif</span><br><span class="hljs-comment">!</span><br><span class="hljs-comment">! Set diagnostic flag value history output time</span><br><span class="hljs-comment">!-----------------------------------------------------------------------------</span><br><br>   ke_diag = kms <span class="hljs-comment">! default to ke_diag=1 in case of nwp_diagnostics == 1</span><br>   diag_flag = <span class="hljs-literal">.false.</span><br>   <span class="hljs-keyword">if</span> ( Is_alarm_tstep(grid%domain_clock, grid%alarms(HISTORY_ALARM)) ) <span class="hljs-keyword">then</span><br>      diag_flag = <span class="hljs-literal">.true.</span><br>      ke_diag = <span class="hljs-built_in">min</span>(k_end,kde-<span class="hljs-number">1</span>) <span class="hljs-comment">! set depth to full domain for reflectivity field</span><br>   <span class="hljs-keyword">endif</span><br>   diag_flag_hist = diag_flag<br></code></pre></td></tr></table></figure><ul><li>In <a href="https://github.com/MicroTed/wrf4-elec/blob/7c90e71bdc4db527d0ec034804e4fd200cdacf28/elec/include_microphysics_driver_elec.F#L24">include_microphysics_driver_elec.F</a>,<ul><li>diag_flag_hist</li><li>clear_history = .true.</li><li>all set = 0.0</li></ul></li></ul><figure class="highlight fortran"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs fortran"><span class="hljs-comment">! this sets the clear flag for the next time step if a history dump is occurring now</span><br><span class="hljs-keyword">IF</span> ( diag_flag_hist ) <span class="hljs-keyword">THEN</span><br>   clear_history = <span class="hljs-literal">.true.</span><br><span class="hljs-keyword">ENDIF</span><br><br><span class="hljs-comment">!    add up flashes up to history dump </span><br><br><span class="hljs-comment">!     if (MOD(NINT(curr_secs),history_interval*60).eq.0) then</span><br><span class="hljs-keyword">IF</span> ( clear_history ) <span class="hljs-keyword">THEN</span><br>   clear_history = <span class="hljs-literal">.false.</span><br><span class="hljs-comment">!      write(0,*) &#x27;clear arrays&#x27;</span><br>light(:,:) = <span class="hljs-number">0.</span><br>lightdis(:,:) = <span class="hljs-number">0.</span><br>lightdens(:,:) = <span class="hljs-number">0.</span><br>induc(:,:,:) = <span class="hljs-number">0.0</span><br>noninduc(:,:,:) = <span class="hljs-number">0.0</span><br>   <span class="hljs-keyword">IF</span> ( idischarge == <span class="hljs-number">1</span> ) <span class="hljs-keyword">THEN</span><br>   lightfod(:,:) = <span class="hljs-number">0.</span><br>   ELSEIF ( idischarge &gt;= <span class="hljs-number">2</span> ) <span class="hljs-keyword">THEN</span><br>   flshfedic(:,:) = <span class="hljs-number">0.</span><br>   flshfedicp(:,:) = <span class="hljs-number">0.</span><br>   flshfedicn(:,:) = <span class="hljs-number">0.</span><br>   flshfedcg(:,:) = <span class="hljs-number">0.</span><br>   flshfedcgp(:,:) = <span class="hljs-number">0.</span><br>   flshfedcgn(:,:) = <span class="hljs-number">0.</span><br>   flshi(:,:,:) = <span class="hljs-number">0.</span><br>   flshn(:,:,:) = <span class="hljs-number">0.</span><br>   flshp(:,:,:) = <span class="hljs-number">0.</span><br>   <span class="hljs-keyword">ENDIF</span><br></code></pre></td></tr></table></figure><h1 id="wrf-practice">WRF practice</h1><table><thead><tr class="header"><th style="text-align: left;">option</th><th style="text-align: left;"></th></tr></thead><tbody><tr class="odd"><td style="text-align: left;">elec_physics</td><td style="text-align: left;">= 0, electrification (and charge arrays) turned off (DEFAULT) <br> = 1, electrification turned on (only works with mp_physics = 17, 18, or 22 i.e., 2-moment NSSL schemes)</td></tr><tr class="even"><td style="text-align: left;">nssl_ipelec (max_dom)</td><td style="text-align: left;">! NOTE: only set this to a nonzero value on the innermost domain <br> = 0, charging turned off <br> = 2, non-inductive charging only <br> = 3, non-inductive + inductive charging <br> = 1, not used (reserved for future use)</td></tr><tr class="odd"><td style="text-align: left;">nssl_idischarge</td><td style="text-align: left;"><br> = 0, no discharge <br> = 1, Cylindrical "1D" lightning scheme based on Ziegler and MacGorman (1994, JAS) <br> = 2, 3D discrete discharge adapted from MacGorman et al. (2001)</td></tr></tbody></table><ul><li>The WRF-ELEC model outputs a variety of variables related to electrification processes and lightning activity in thunderstorms. Some of the key output variables include:</li></ul><table><thead><tr class="header"><th>WRF-ELEC variables</th><th>Unit</th><th>Description</th></tr></thead><tbody><tr class="odd"><td>LIGHT(Time, south_north, west_east)</td><td>flash origin density</td><td>lightning flash initiations</td></tr><tr class="even"><td>LIGHTDENS(Time, south_north, west_east)</td><td>flash column-1</td><td>lightning flash density</td></tr><tr class="odd"><td>LIGHTFOD(Time, south_north, west_east)</td><td>flash column-1</td><td>normalized lightning flash origin density</td></tr><tr class="even"><td>LIGHTDIS(Time, south_north, west_east)</td><td>Source column-1</td><td>lightning source density</td></tr><tr class="odd"><td>POT(Time, bottom_top, south_north, west_east)</td><td>V</td><td>POTENTIAL</td></tr><tr class="even"><td>ELECMAG(Time, bottom_top, south_north, west_east)</td><td>V m-1</td><td>EFIELD MAGNITUDE</td></tr><tr class="odd"><td>ELECX(Time, bottom_top, south_north, west_east)</td><td>V m-1</td><td>EFIELD X-Component</td></tr><tr class="even"><td>ELECY(Time, bottom_top, south_north, west_east)</td><td>V m-1</td><td>EFIELD Y-Component</td></tr><tr class="odd"><td>ELECZ(Time, bottom_top, south_north, west_east)</td><td>V m-1</td><td>EFIELD Z-Component</td></tr><tr class="even"><td>SCTOT(Time, bottom_top, south_north, west_east)</td><td>C m-3</td><td>Total Space Charge Density</td></tr><tr class="odd"><td>RSCGHIS_2D(Time, south_north, west_east)</td><td>C m-2</td><td>MAX NONINDUCTIVE CHARGING 2D</td></tr><tr class="even"><td>INDUC(Time, bottom_top, south_north, west_east)</td><td>C m-3</td><td>TOTAL INDUCTIVE CHARGING</td></tr><tr class="odd"><td>NONINDUC(Time, bottom_top, south_north, west_east)</td><td>C m-3</td><td>TOTAL NONINDUCTIVE CHARGING</td></tr><tr class="even"><td>SCTOT(Time, bottom_top, south_north, west_east)</td><td>C m-3</td><td>Total Space Charge Density</td></tr></tbody></table><ul><li>If the lightning discharge flag (nssl_idischarge = 2) that is lightning3d, More output variables include: (LIGHTFOD is not calculated)</li></ul><table><thead><tr class="header"><th>WRF-ELEC variables</th><th>Unit</th><th>Description</th></tr></thead><tbody><tr class="odd"><td>FLSHFEDIC(Time, south_north, west_east)</td><td>flash column-1</td><td>IC lightning flash extent density</td></tr><tr class="even"><td>FLSHFEDICP(Time, south_north, west_east)</td><td>flash column-1</td><td>IC pos lightning flash extent density</td></tr><tr class="odd"><td>FLSHFEDICN(Time, south_north, west_east)</td><td>flash column-1</td><td>IC neg lightning flash extent density</td></tr><tr class="even"><td>FLSHFEDCG(Time, south_north, west_east)</td><td>flash column-1</td><td>CG lightning flash extent density</td></tr><tr class="odd"><td>FLSHFEDCGN(Time, south_north, west_east)</td><td>flash column-1</td><td>CG neg lightning flash extent density</td></tr><tr class="even"><td>FLSHFEDCGP(Time, south_north, west_east)</td><td>flash column-1</td><td>CG pos lightning flash extent density</td></tr><tr class="odd"><td>FLSHI(Time, bottom_top, south_north, west_east)</td><td>count</td><td>Lightning init points</td></tr><tr class="even"><td>FLSHN(Time, bottom_top, south_north, west_east)</td><td>count</td><td>Negative channels</td></tr><tr class="odd"><td>FLSHP(Time, bottom_top, south_north, west_east)</td><td>count</td><td>Positive channels</td></tr></tbody></table><h1 id="cost-elapsed-time">Cost: Elapsed time</h1><table><thead><tr class="header"><th style="text-align: left;">WRF-ELEC</th><th style="text-align: left;">mp</th><th style="text-align: left;">idischarge</th><th style="text-align: left;">Elapsed time</th></tr></thead><tbody><tr class="odd"><td style="text-align: left;">elec=0</td><td style="text-align: left;">17</td><td style="text-align: left;">none</td><td style="text-align: left;">4h49m</td></tr><tr class="even"><td style="text-align: left;">elec=1</td><td style="text-align: left;">17</td><td style="text-align: left;">1</td><td style="text-align: left;">6h13m</td></tr><tr class="odd"><td style="text-align: left;">elec=1</td><td style="text-align: left;">17</td><td style="text-align: left;">2</td><td style="text-align: left;">9h1m</td></tr></tbody></table><p>WRFv4.5-ELEC.</p><h1 id="literature-review">Literature review</h1><p>Lightning activity is related to two important factors: dynamic–thermodynamic and microphysical characteristics (e.g., Williams et al., 2005; Rosenfeld et al., 2008; Guo et al., 2016; Wang et al., 2018; Zhao et al., 2020). Since the dynamic–thermodynamic processes affect the development of thunderstorm significantly, lightning activity is influenced by various dynamic–thermodynamic variables: temperature (Price, 1993), relative humidity in the lower and middle troposphere (Xiong et al., 2006; Fan et al., 2007), convective available potential energy (Qie et al., 2004; Stolz et al., 2015), and many others.</p><h2 id="pr92">(1992) PR92</h2><blockquote><p>Price, C., and D. Rind (1992), A Simple Lightning Parameterization for Calculating Global Lightning Distributions, J. Geophys. Res., 97(D9), 9919-9933, doi:10.1029/92JD00719.<br />Wong, J., M. Barth, and D. Noone, 2013: Evaluating a lightning parameterization based on cloud-top height for mesoscale numerical model simulations, Geosci. Model Dev., 6, 429–443, GMD - Evaluating a lightning parameterization based on cloud-top height for mesoscale numerical model simulations.</p></blockquote><p>ref: <a href="https://ruc.noaa.gov/wrf/wrf-chem/Users_guide.pdf">WRF-Chem Version 4.4 User's Guide: Appendix C: Using the Lightning-NOx Parameterization in WRF-Chem</a></p><p>You may also find useful information in the actual code for the schemes:</p><ul><li>module_lightning_driver.F</li><li>module_ltng_crmpr92.F</li></ul><h2 id="prediction-of-lightning-flash-density-with-the-wrf-model">(2010) Prediction of lightning flash density with the WRF model</h2><blockquote><p><a href="https://pdfs.semanticscholar.org/a206/1d033ccf90082c05a1514df4920005035c0b.pdf" class="uri">https://pdfs.semanticscholar.org/a206/1d033ccf90082c05a1514df4920005035c0b.pdf</a><br />Lynn, B., and Yoav Yair. "Prediction of lightning flash density with the WRF model." Advances in Geosciences 23 (2010): 11-16.</p></blockquote><p>The <strong>Lightning Potential Index (LPI)</strong> is a measure of the potential for charge generation and separation that leads to lightning flashes in convective thunderstorms. It is calculated from model simulated updraft and microphysical fields. It was designed to predict the potential of lightning occurrence in operational weather forecasting models, but could possibly be used to improve short-range forecasts of heavy rain. <strong>The index is modified here to be model grid-scale transparent between 1 and 4 km (the approximate upper limit of explicit microphysical weather forecasts)</strong>. Two case studies show that the modification appears to work quite well, and that LPI can be calculated on both an extremely high resolution research-grid (i.e., 1.33 km) and high resolution (i.e., 4 km) operationally compatible forecast grid. Analytical expressions are presented to use the LPI to predict the hourly lightning flash density.</p>    <div class="fold">      <div class="fold-title fold-info collapsed" data-toggle="collapse" href="#collapse-639614a5" role="button" aria-expanded="false" aria-controls="collapse-639614a5">        <div class="fold-arrow">▶</div>Perplexity      </div>      <div class="fold-collapse collapse" id="collapse-639614a5">        <div class="fold-content">          <figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><code class="hljs markdown">The <span class="hljs-code">`lightning_option=3`</span> in the Weather Research and Forecasting (WRF) model activates the <span class="hljs-strong">**Lightning Potential Index (LPI)**</span> parameterization, developed based on research by Yair, Lynn, and collaborators around 2010[<span class="hljs-string">1</span>][<span class="hljs-symbol">6</span>]. This method predicts lightning flash density by quantifying the potential for charge generation and separation in thunderstorms.<br><br><span class="hljs-section">### Key Features of LPI:</span><br><span class="hljs-bullet">1.</span> <span class="hljs-strong">**Physical Basis**</span>:  <br>   The LPI integrates microphysical and dynamical variables within the &quot;charging zone&quot; (0°C to −20°C) of thunderstorms. It accounts for:  <br><span class="hljs-bullet">   -</span> Vertical wind velocity ($\omega$)  <br><span class="hljs-bullet">   -</span> Mixing ratios of ice ($q<span class="hljs-emphasis">_i$), snow ($q_</span>s$), graupel ($q<span class="hljs-emphasis">_g$), and liquid water ($q_</span>l$)[<span class="hljs-string">1</span>][<span class="hljs-symbol">6</span>].  <br><br>   The formula is:  <br>   $<br>   \text&#123;LPI&#125; = \int<span class="hljs-emphasis">_V \omega \cdot \left( q_</span>s + q<span class="hljs-emphasis">_i + q_</span>g \right) \cdot \alpha \, dV<br>   $  <br>   where $ \alpha $ scales with the balance between ice and liquid water content[6].<br><br><span class="hljs-bullet">2.</span> <span class="hljs-strong">**Grid Resolution**</span>:  <br>   The LPI is designed to be grid-scale transparent between 1 km and 4 km resolutions[1], making it suitable for high-resolution simulations.<br><br><span class="hljs-bullet">3.</span> <span class="hljs-strong">**Operational Use**</span>:  <br><span class="hljs-bullet">   -</span> Validated in case studies (e.g., Italy and Israel) showing correlations between LPI and observed lightning density[1].  <br><span class="hljs-bullet">   -</span> Used in operational systems (e.g., India’s IMD-WRF) to generate hourly lightning threat maps[6].<br><br><span class="hljs-section">### Advantages Over Other Schemes:</span><br><span class="hljs-bullet">-</span> Directly links lightning activity to cloud electrification physics, unlike empirically derived methods (e.g., Price and Rind’s cloud-top height parameterization)[<span class="hljs-string">3</span>][<span class="hljs-symbol">4</span>].  <br><span class="hljs-bullet">-</span> Provides spatial and temporal details of lightning threat, aiding early warnings[<span class="hljs-string">1</span>][<span class="hljs-symbol">6</span>].<br><br><span class="hljs-section">### Limitations:</span><br><span class="hljs-bullet">-</span> Sensitivity to microphysics schemes (e.g., WSM6 vs. two-moment schemes)[4].  <br><span class="hljs-bullet">-</span> Overestimates spatial extent of lightning in some cases[1].<br><br>For users, enabling <span class="hljs-code">`lightning_option=3`</span> allows WRF to output LPI fields, which can be calibrated against ground-based lightning data (e.g., Earth Networks Global Lightning Network) to improve forecasts[<span class="hljs-string">2</span>][<span class="hljs-symbol">6</span>].<br><br>Citations:<br>[1] https://pdfs.semanticscholar.org/a206/1d033ccf90082c05a1514df4920005035c0b.pdf<br>[2] https://meteo.gov.lk/images/005BJD-1.pdf<br>[3] https://gmd.copernicus.org/preprints/5/3493/2012/gmdd-5-3493-2012.pdf<br>[4] https://journals.ametsoc.org/view/journals/wefo/35/4/wafD190101.pdf<br>[5] https://journals.ametsoc.org/view/journals/wefo/37/5/WAF-D-21-0080.1.xml<br>[6] https://srf.tropmet.res.in/srf/ts<span class="hljs-emphasis">_prediction_</span>system/lpi<span class="hljs-emphasis">_model.php</span><br><span class="hljs-emphasis">[7] https://www.researchgate.net/publication/374806154_</span>Performance<span class="hljs-emphasis">_Evaluation_</span>of<span class="hljs-emphasis">_Lightning_</span>Potential<span class="hljs-emphasis">_Index_</span>and<span class="hljs-emphasis">_Flash_</span>Count<span class="hljs-emphasis">_using_</span>WRF<span class="hljs-emphasis">_Microphysical_</span>Parameters<span class="hljs-emphasis">_over_</span>Rajasthan<span class="hljs-emphasis">_and_</span>West<span class="hljs-emphasis">_Bengal_</span>India<br>[8] https://agupubs.onlinelibrary.wiley.com/doi/full/10.1029/2023JD039492<br>[9] https://agupubs.onlinelibrary.wiley.com/doi/abs/10.1029/2008JD010868<br>[10] https://agupubs.onlinelibrary.wiley.com/doi/full/10.1029/2008JD010868<br>[11] https://www.researchgate.net/publication/234236223<span class="hljs-emphasis">_Predicting_</span>lightning<span class="hljs-emphasis">_density_</span>in<span class="hljs-emphasis">_Mediterranean_</span>storms<span class="hljs-emphasis">_based_</span>on<span class="hljs-emphasis">_the_</span>WRF<span class="hljs-emphasis">_model_</span>dynamic<span class="hljs-emphasis">_and_</span>microphysical<span class="hljs-emphasis">_fields</span><br><span class="hljs-emphasis">[12] https://www.researchgate.net/publication/242759928_</span>Prediction<span class="hljs-emphasis">_of_</span>lightning<span class="hljs-emphasis">_flash_</span>density<span class="hljs-emphasis">_with_</span>the<span class="hljs-emphasis">_WRF_</span>model<br>[13] https://forum.mmm.ucar.edu/threads/large-differences-of-simulated-fields-u-v-w-t-with-lightning<span class="hljs-emphasis">_option-3-lpi-on-and-off.9338/</span><br><span class="hljs-emphasis">[14] https://www.researchgate.net/publication/279524959_</span>Prediction<span class="hljs-emphasis">_of_</span>lightning<span class="hljs-emphasis">_potential_</span>index<span class="hljs-emphasis">_using_</span>WRF<span class="hljs-emphasis">_model_</span>a<span class="hljs-emphasis">_case_</span>study<span class="hljs-emphasis">_over_</span>Iran<br>[15] https://www.cnblogs.com/jiangleads/articles/14267628.html<br>[16] http://plutao.sid.inpe.br/col/dpi.inpe.br/plutao/2010/11.11.17.38.32/doc/zepka<span class="hljs-emphasis">_method.pdf</span><br><span class="hljs-emphasis">[17] https://github.com/wrf-model/WRF/blob/master/run/README.namelist</span><br><span class="hljs-emphasis">[18] https://adgeo.copernicus.org/articles/23/11/2010/</span><br><span class="hljs-emphasis">---</span><br><span class="hljs-emphasis">Answer from Perplexity: pplx.ai/share</span><br></code></pre></td></tr></table></figure>        </div>      </div>    </div><h2 id="fierro-et-al.">(2013) Fierro et al.</h2><blockquote><p>Fierro, A. O., Mansell, E. R., MacGorman, D. R., &amp; Ziegler, C. L. (2013). The implementation of an explicit charging and discharge lightning scheme within the WRF-ARW model: Benchmark simulations of a continental squall line, a tropical cyclone, and a winter storm. Monthly Weather Review, 141(7), 2390-2415.</p></blockquote><p>This work describes the recent implementation of explicit lightning physics within the Weather Research and Forecasting (WRF) Model.</p><ul><li>Charging of hydrometeors consists of five distinct noninductive parameterizations, polarization of cloud water, and the exchange of charge during collisional mass transfer.</li><li>The three components of the ambient electric field are explicitly solved for via the computationally efficient multigrid elliptic solver.</li><li>The discharge process employs concepts adapted from two well-documented bulk lightning models, whereby charge reduction is imposed within a prescribed volume centered at grid points characterized by electric field magnitudes exceeding a given breakdown threshold.</li></ul><p>This lightning model was evaluated through benchmark</p><ul><li>convection-allowing (3 km) model simulations of three contrasting convective systems: a continental squall line,</li><li>a major hurricane (Rita 2005), and</li><li>a winter storm.</li></ul><p>The areal coverage and magnitude of the simulated hourly flash origin density (FOD) for the continental squall line are qualitatively comparable to that of the total lightning data observations from Earth Networks Total Lightning Network (ENTLN). In agreement with the ENTLN observations, no FOD are simulated for the winter storm case. The simulated spatial FOD pattern of the hurricane and the eyewall gross charge structure were both in reasonable agreement with observations. The simulated FOD for all three cases were also evaluated against those obtained with the recently developed McCaul diagnostic lightning prediction schemes and exhibited overall good qualitative agreement with each other for Rita and the continental squall line.</p><h2 id="thunderstorm-indices-lpi-layrh-scp">Thunderstorm Indices (LPI, Layrh, SCP)</h2><p><strong>Thunderstorm Indices (LPI, Layrh, SCP)</strong> obtained from IMD-WRF (3km) Hourly outputs.</p><ul><li>Model GEFS - WRF Description</li><li><a href="https://srf.tropmet.res.in/srf/ts_prediction_system/lpi_model.php" class="uri">https://srf.tropmet.res.in/srf/ts_prediction_system/lpi_model.php</a></li><li><strong>Lightning Potential Index (LPI)</strong><ul><li>Here, LPI has been calculated using IMD-WRF (3km) hourly model output. 24 Hour accumulated LPI has been generated by adding hourly LPI values. The threat of LPI has been categorized in Low, Moderate and High. LOW: LPI &lt; 0.001 and &gt;0.0005; Moderate: LPI :&lt; 0.01 and &gt; 0.001; Threat Level: High: LPI &gt; 0.01.</li></ul></li><li><strong>SuperCell Composite Parameter (SCP)</strong><ul><li>SCP &gt; 1 indicated that the environment is conducive for thunderstorm formation. The Threat Level of SCP has been categorized in Low, Moderate and High. LOW: 3 &lt; SCP &lt; 5; Moderate: 5 &lt; SCP &lt; 7; High: SCP &gt; 7.</li></ul></li><li><strong>Layer Relative Humidity (LAYRH)</strong><ul><li>The threat level of Layrh has been categorized in Low, Moderate and High. LOW: 20 &lt; LAYRH &lt; 40; Moderate: 40 &lt; LAYRH &lt; 60; High : LAYRH &gt; 60</li></ul></li></ul><h2 id="numerical-study-of-performance-of-two-lightning-prediction-methods-based-on-lightning-potential-index-lpi-and-electric-potential-difference-pot-over-tehran-area">(2019) Numerical study of performance of two lightning prediction methods based on: Lightning Potential Index (LPI) and electric POTential difference (POT) over Tehran area</h2><blockquote><p><strong>Gharaylou, M., Farahani, M. M., Hosseini, M., &amp; Mahmoudian, A. (2019). Numerical study of performance of two lightning prediction methods based on: Lightning Potential Index (LPI) and electric POTential difference (POT) over Tehran area</strong>. Journal of Atmospheric and Solar-Terrestrial Physics, 193, 105067.</p></blockquote><p>The electric POTential difference (POT) and the Lightning Potential Index (LPI) performance in predicting the lightning activity is investigated and the probable relationship between them is examined. These two indices have a similar dependency on microphysical variables such as ice, graupel mixing ratios, and also updraft characteristics within the cloud. Regardless of this similarity, the LPI directly calculated from WRF model is a more favorable parameter for predicting the lightning events in comparison with the POT, which requires an extra package (ELEC) model. Ten years' available data over the Tehran area were reviewed and four thundercloud cases with distinct characteristics (CAPE, time-frequency, intensity) were selected. In order to acquire the associated physical properties, four simulations have been done using the WRF-ELEC model, which is initialized with ERA-Interim data.</p><h2 id="prediction-of-lightning-activity-using-wrf-elec-model">**(2020) Prediction of lightning activity using WRF-ELEC model</h2><blockquote><p><strong>Gharaylou, M., Farahani, M. M., Mahmoudian, A., &amp; Hosseini, M. (2020). Prediction of lightning activity using WRF-ELEC model: Impact of initial and boundary conditions</strong>. Journal of Atmospheric and Solar-Terrestrial Physics, 210, 105438.</p></blockquote><blockquote><ul><li><a href="https://sci-hub.se/https://doi.org/10.1016/j.jastp.2020.105438" class="uri">https://sci-hub.se/https://doi.org/10.1016/j.jastp.2020.105438</a></li></ul></blockquote><ul><li>The WRF model belongs to the first group in which lightning is predicted based on the <strong>Bulk Lightning Model (BLM)</strong>. Ziegler and MacGorman (1994) have studied lightning flashes in a twoand three-dimensional cloud models using the WRF model.</li><li>In the early 90s, Price and Rind (1992) developed a lightning parameterization scheme based on <strong>cloud-top height</strong>.</li><li>Furthermore, another lightning flash parameterization scheme has been introduced by Allen and Pickering (2002) and Allan et al. (2010) based on the <strong>square of deep convective mass flux</strong>.</li><li>Choi et al. (2005) and Zhao et al. (2009) incorporated the <strong>convective available potential energy (CAPE)</strong> in their comparative parameterizations.</li><li>Yair et al. (2010) introduced <strong>Lightning Potential Index (LPI)</strong>, an advanced index for evaluating the probability of lightning occurrence, incorporated the dynamic and microphysic concepts.</li><li>Following, Lynn et al. (2012) introduced the <strong>potential electrical energy (Ep) parameter</strong> into the WRF model, which was used to predict both <strong>Cloud-to-Ground (CG)</strong> and <strong>Intra-Cloud (IC)</strong> <em>lightning events</em>.</li><li>Afterwards, Wong et al. (2013) developed the lightning parameterization based on cloud-top height (Price and Rind, 1992).</li><li>Gharaylou et al. (2019) examined 2 indices which are used in predicting the lightning activities both in time and location. They compared the <strong>electric potential difference (POT)</strong> and the <strong>LPI</strong> performance in predicting the lightning associated with four events over a domain located in the north of Iran.</li><li><strong>The LPI is computationally less expensive and is directly calculated by the WRF model with less computational cost in comparison with the POT which requires an extra package (ELEC model).</strong><ul><li>LPI calculations have been discussed in our previous paper (Gharaylou et al., 2019)</li></ul></li></ul><h3 id="effect-of-initial-and-boundary-conditions-ibcs">Effect of Initial and boundary conditions (IBCs)</h3><ul><li>The mesoscale models ordinarily obtain their initial and boundary conditions (IBCs) from large scale global models. <strong>Applying different initial conditions highly influences the accuracy of the model prediction in local areas</strong> (Zhang et al., 2002, 2006).</li><li>A few works have been done to investigate the effect of initial conditions on lightning activity (Lynn et al., 2012).</li><li>Zepka et al. (2014) studied the impact of the resolution of the NCEP operational Global Forecast System.</li><li>As mentioned, <strong><em>there are very few works</em></strong> related to the assessment of IBC effects in the WRF-ELEC model for lightning prediction.<ul><li>WRF-ELEC model initialized with different datasets needs to be verified.</li></ul></li></ul><h1 id="case-hong-kong-lightning">Case: Hong Kong Lightning</h1><p>The "Hong Kong Observatory Lightning Statistics" refers to the detailed records of lightning activity in the Hong Kong region, primarily categorized into cloud-to-ground lightning and intra-cloud lightning. This data not only aids in understanding meteorological patterns but also enhances awareness of the safety risks associated with lightning strikes.</p><ul><li><a href="https://www.hko.gov.hk/tc/wservice/tsheet/llis.htm">香港天文台閃電位置資訊服務 HKO Lightning Location Information Service</a></li></ul><figure><img src="https://www.hko.gov.hk/tc/wservice/tsheet/images/fact2c.jpg" alt="閃電定位網絡各個探測站的位置分佈圖/Distribution of lightning sensor stations of the lightning location network" /><figcaption>閃電定位網絡各個探測站的位置分佈圖/Distribution of lightning sensor stations of the lightning location network</figcaption></figure><ul><li><a href="https://www.hko.gov.hk/en/wxinfo/llis/llis_map.htm">Lightning density map for Hong Kong</a></li></ul><figure><img src="https://www.hko.gov.hk/en/wxinfo/llis/images/ll_density_e.png" alt="Average yearly number of cloud-to-ground lightning strokes per square kilometer" /><figcaption>Average yearly number of cloud-to-ground lightning strokes per square kilometer</figcaption></figure><ul><li><a href="https://maps.weather.gov.hk/ocf/index_uc.html?data=ncln">閃電（試驗版） | 香港及珠江三角洲區域自動分區天氣預報/Automatic regional weather forecast in Hong Kong and the Pearl River Delta region</a></li></ul><h2 id="statistics-of-lightning-days-at-the-hko-weather-station">Statistics of lightning days at the HKO Weather Station</h2><figure><img src="../../../../figures/2024-09-20-wrf4-elec-lightning/Statistics_of_lightning_days_at_the_HKO_Weather_Station.png" alt="Statistics of lightning days at the HKO Weather Station (Last updated: August 31, 2024). From i-lens.hk" /><figcaption>Statistics of lightning days at the HKO Weather Station (Last updated: August 31, 2024). From <a href="https://i-lens.hk/hkweather/special_stat.php?event=LIGHTING_DAY&amp;station=HKO">i-lens.hk</a></figcaption></figure><h2 id="all-weather-stations---ranking-of-highest-daily-total-lightning-counts-in-history">All Weather Stations - Ranking of Highest Daily Total Lightning Counts in History</h2><p>From <a href="https://i-lens.hk/hkweather/rank.php?station=ALL&amp;element=L_BOTH&amp;type=MAX&amp;year=&amp;month=">i-lens.hk</a>, Last updated: August 31, 2024</p><table><thead><tr class="header"><th style="text-align: center;">Ranking</th><th style="text-align: center;">Weather Station</th><th style="text-align: center;">Start observation year</th><th style="text-align: center;">Observation date</th><th style="text-align: center;">Total number of lightning strikes per day (times)</th></tr></thead><tbody><tr class="odd"><td style="text-align: center;">1</td><td style="text-align: center;">Hong Kong Observatory</td><td style="text-align: center;">2005</td><td style="text-align: center;">2020-06-06</td><td style="text-align: center;">47537</td></tr><tr class="even"><td style="text-align: center;">2</td><td style="text-align: center;">Hong Kong Observatory</td><td style="text-align: center;">2005</td><td style="text-align: center;">2020-06-07</td><td style="text-align: center;">41446</td></tr><tr class="odd"><td style="text-align: center;">3</td><td style="text-align: center;">Hong Kong Observatory</td><td style="text-align: center;">2005</td><td style="text-align: center;">2019-04-20</td><td style="text-align: center;">36299</td></tr><tr class="even"><td style="text-align: center;">4</td><td style="text-align: center;">Hong Kong Observatory</td><td style="text-align: center;">2005</td><td style="text-align: center;">2023-06-01</td><td style="text-align: center;">36253</td></tr><tr class="odd"><td style="text-align: center;">5</td><td style="text-align: center;">Hong Kong Observatory</td><td style="text-align: center;">2005</td><td style="text-align: center;">2024-04-30</td><td style="text-align: center;">32603</td></tr><tr class="even"><td style="text-align: center;">6</td><td style="text-align: center;">Hong Kong Observatory</td><td style="text-align: center;">2005</td><td style="text-align: center;">2021-06-28</td><td style="text-align: center;">31859</td></tr><tr class="odd"><td style="text-align: center;">7</td><td style="text-align: center;">Hong Kong Observatory</td><td style="text-align: center;">2005</td><td style="text-align: center;">2019-08-25</td><td style="text-align: center;">24951</td></tr><tr class="even"><td style="text-align: center;">8</td><td style="text-align: center;">Hong Kong Observatory</td><td style="text-align: center;">2005</td><td style="text-align: center;">2019-04-19</td><td style="text-align: center;">22053</td></tr><tr class="odd"><td style="text-align: center;">9</td><td style="text-align: center;">Hong Kong Observatory</td><td style="text-align: center;">2005</td><td style="text-align: center;">2018-08-22</td><td style="text-align: center;">21152</td></tr><tr class="even"><td style="text-align: center;">10</td><td style="text-align: center;">Hong Kong Observatory</td><td style="text-align: center;">2005</td><td style="text-align: center;">2022-07-30</td><td style="text-align: center;">20187</td></tr><tr class="odd"><td style="text-align: center;">11</td><td style="text-align: center;">Hong Kong Observatory</td><td style="text-align: center;">2005</td><td style="text-align: center;">2019-06-13</td><td style="text-align: center;">19526</td></tr><tr class="even"><td style="text-align: center;">12</td><td style="text-align: center;">Hong Kong Observatory</td><td style="text-align: center;">2005</td><td style="text-align: center;">2010-09-09</td><td style="text-align: center;">18813</td></tr><tr class="odd"><td style="text-align: center;">13</td><td style="text-align: center;">Hong Kong Observatory</td><td style="text-align: center;">2005</td><td style="text-align: center;">2013-05-22</td><td style="text-align: center;">18568</td></tr><tr class="even"><td style="text-align: center;">14</td><td style="text-align: center;">Hong Kong Observatory</td><td style="text-align: center;">2005</td><td style="text-align: center;">2020-09-15</td><td style="text-align: center;">17879</td></tr><tr class="odd"><td style="text-align: center;">15</td><td style="text-align: center;">Hong Kong Observatory</td><td style="text-align: center;">2005</td><td style="text-align: center;">2020-05-30</td><td style="text-align: center;">17765</td></tr><tr class="even"><td style="text-align: center;">16</td><td style="text-align: center;">Hong Kong Observatory</td><td style="text-align: center;">2005</td><td style="text-align: center;">2006-06-09</td><td style="text-align: center;">17587</td></tr><tr class="odd"><td style="text-align: center;">17</td><td style="text-align: center;">Hong Kong Observatory</td><td style="text-align: center;">2005</td><td style="text-align: center;">2014-03-30</td><td style="text-align: center;">16823</td></tr><tr class="even"><td style="text-align: center;">18</td><td style="text-align: center;">Hong Kong Observatory</td><td style="text-align: center;">2005</td><td style="text-align: center;">2024-04-26</td><td style="text-align: center;">16328</td></tr><tr class="odd"><td style="text-align: center;">19</td><td style="text-align: center;">Hong Kong Observatory</td><td style="text-align: center;">2005</td><td style="text-align: center;">2010-09-08</td><td style="text-align: center;">14659</td></tr><tr class="even"><td style="text-align: center;">20</td><td style="text-align: center;">Hong Kong Observatory</td><td style="text-align: center;">2005</td><td style="text-align: center;">2023-04-21</td><td style="text-align: center;">14471</td></tr></tbody></table><h2 id="overview-of-climate-change-effects">Overview of Climate Change Effects</h2><p>Climate change, driven by the increase in greenhouse gases, has a profound impact on weather patterns. As global temperatures rise, more energy is available in the atmosphere, which intensifies convective storms. Since lightning is primarily a product of such storms, the increase in the frequency and intensity of these storms can lead to changes in lightning activity.</p><ul><li><strong>Increase Per Degree of Warming:</strong> Across the continental United States (CONUS), the CAPE × P proxy predicts a 12 ± 5% rise in lightning strike rates for each 1°C increase in global mean temperature (Romps et al., 2014). This research suggests that as the planet warms, lightning frequency will likely increase. A 12% rise in lightning activity is anticipated for every degree of warming, which could result in a 50% increase in lightning strikes in regions like the U.S. by the end of the century (Romps et al., 2014; Romps, 2021).</li><li><strong>Specific Regional Studies:</strong> Focused on the South China Sea (SCS) and surrounding regions in Southeast Asia to analyze long-term trends and future projections of lightning activity using the longest available satellite-based lightning dataset and climate models. The projections indicate that lightning activity in the SCS region is expected to increase by 10% under SSP245 and by 12% under SSP370 by the end of the 21st century. (Xu et al., 2023; Xu et al., 2024)</li><li><strong>Impact of Global Warming on Future Lightning Events</strong><ul><li>The IPCC AR6 defines several Shared Socioeconomic Pathways (SSPs) that describe possible future climate scenarios based on different levels of greenhouse gas emissions. (e.g., SSP5-8.5: Very high emissions, with warming over 4.4°C)</li></ul></li><li><strong>Regional Studies on Future Lightning Events (e.g., South China Sea)</strong></li></ul><p>From these papers,</p><ul><li>Romps, D. M., Seeley, J. T., Vollaro, D., &amp; Molinari, J. (2014). Projected increase in lightning strikes in the United States due to global warming. Science, 346(6211), 851-854.</li><li>Romps, D. M. (2019). Evaluating the future of lightning in cloud‐resolving models. Geophysical Research Letters, 46(24), 14863-14871.</li><li>Xu, L., Cao, X., Lan, X., Zhang, W., Sun, C., &amp; Zhang, Y. (2024). Future increase in lightning around the South China Sea under climate change. Earth and Space Science, 11(6), e2023EA003356.</li><li>Xu, Mingyi, et al. "Distribution of lightning spatial modes and climatic causes in China." Atmospheric and Oceanic Science Letters 16.2 (2023): 100338.</li></ul><h1 id="references">References</h1><ol type="1"><li><strong>香港天文台</strong><ol type="1"><li><a href="https://www.hko.gov.hk/tc/education/weather/thunderstorm-and-lightning/00031-what-are-thunderstorms.html">什麼是雷暴？</a></li><li><a href="https://www.hko.gov.hk/tc/wservice/warning/thunder.htm">雷暴警告</a></li><li><a href="https://www.hko.gov.hk/tc/education/weather/thunderstorm-and-lightning/00021-why-does-lightning-always-come-before-thunder.html">為什麼總是先閃電後打雷？</a></li><li><a href="https://www.hko.gov.hk/tc/education/weather/thunderstorm-and-lightning/00018-what-is-cloudtocloud-lightning.html">甚麼是雲間閃電？</a></li><li><a href="https://www.hko.gov.hk/tc/wxinfo/llis/stat.htm">香港天文台閃電位置資訊系統</a></li><li><a href="https://i.cs.hku.hk/~light/outgoing/Lightning_HKO_public_talk.pdf">2012 | 閃電及其測量方法 | HKO</a></li><li><a href="https://www.hko.gov.hk/tc/publica/reprint/files/r622.pdf">2006-Reprint 622-探討閃電位置數據應用在臨近預報的前景</a></li><li><a href="https://www.weather.gov.hk/tc/publica/reprint/files/r817a.pdf">2009-Reprint 817-香港一次夏季雹暴的天氣過程分析及臨近預報系統的應用</a></li><li><a href="https://www.weather.gov.hk/en/publica/reprint/files/r1035.pdf">2012-Reprint 1035-利用閃電數據監測暴雨發展的個案分析</a></li><li><a href="https://www.hko.gov.hk/tc/whatsnew/r1_wn20170531.htm">2017 天文台加強閃電定位資訊系統投入業務運作</a></li><li><a href="https://www.hko.gov.hk/en/publica/reprint/files/r1337.pdf">2018-Reprint 1337-粵港澳閃電定位網絡的最新發展及與超強颱風天鴿相關之數據分析</a></li><li><a href="https://www.hko.gov.hk/tc/publica/reprint/files/r1341.pdf">2018-Reprint 1341-公眾定點閃電臨近預報服務</a></li><li><a href="https://www.hko.gov.hk/en/publica/reprint/files/r1358.pdf">2019-Reprint 1358-區域與全球閃電定位資料於珠三角地區的精細化比對</a></li><li><a href="https://www.hko.gov.hk/tc/publica/ghm_21/files/HPaper_WongCP.pdf">2020-在珠三角一帶與大雨相關的閃電特徵分析</a></li><li><a href="https://www.hko.gov.hk/tc/education/weather/thunderstorm-and-lightning/00732-The-Aerial-Battle-Aircraft-vs-Thunder-God.html">3025-空中對決：飛機與雷神的交鋒</a></li></ol></li><li><a href="https://mp.weixin.qq.com/s/yuzCZB2Nb5CydG3WCysK_w">世界气候“雷极”：印度尼西亚爪哇岛，平均年雷雨日数超过220天</a></li><li>徐良韬, 张义军, 王飞, 郑栋. 2012: 雷暴起电和放电物理过程在WRF模式中的耦合及初步检验. 大气科学, 36(5): 1041-1052. DOI: 10.3878/j.issn.1006-9895.2012.11235<ol type="1"><li>WRFv3.2.1</li><li>本文将雷暴云的起电、放电物理过程引入中尺度的WRF (Weather Research and Forecasting) 模式,并对超级单体和飑线过程进行了模拟研究.起电过程在Milbrandt双参数微物理方案中写入,包含霰、雹与冰晶、雪之间的非感应起电机制,以及霰、雹与云滴之间的感应起电机制.</li></ol></li><li>徐良韬, 陈双, 姚雯, 等. 利用起放电模式开展闪电活动的直接预报试验. 应用气象学报, 2018, 29(5): 534-545. DOI: 10.11898/1001-7313.20180503.<ol type="1"><li>WRFv3.4.1</li><li>利用耦合有起电和放电物理过程的中尺度起电放电模式WRF-Electric</li></ol></li><li>Wasson, G., &amp; Panda, S. K. (2024). Sensitivity of PBL parameterization schemes in simulating lightning and thunderstorm using WRF-ELEC model. Climate Dynamics, 1-23.<ol type="1"><li>The WRF-ELEC model, an auxiliary package integrated into WRF, is specifically designed to compute electric potential and overall lightning flash rate (source: <a href="https://sourceforge.net/projects/wrfelec" class="uri">https://sourceforge.net/projects/wrfelec</a>).</li><li>It incorporates explicit cloudresolving scale physics for lightning prediction (<a href="https://scholar.google.com/scholar_url?url=https://journals.ametsoc.org/view/journals/mwre/141/7/mwr-d-12-00278.1.xml%3Ftab_body%3Dpdf&amp;hl=en&amp;sa=T&amp;oi=gsr-r-ggp&amp;ct=res&amp;cd=0&amp;d=6841908713848986342&amp;ei=DTHtZqfdAfSC6rQP2qO70AU&amp;scisig=AFWwaeaoJDdXALkuhsn44g0xEyU5">Fierro et al.2013</a>). Detailed formulations can be found in <a href="https://scholar.google.com/scholar_url?url=https://agupubs.onlinelibrary.wiley.com/doi/abs/10.1029/2004jd005287&amp;hl=en&amp;sa=T&amp;oi=gsr-r&amp;ct=res&amp;cd=0&amp;d=13100036974408530565&amp;ei=JTHtZs_QIeqs6rQPw4y2sAM&amp;scisig=AFWwaeZ27Z0oFR35ZZvLDk-yrgo_">Mansell et al.(2005)</a> and <a href="https://scholar.google.com/scholar_url?url=https://journals.ametsoc.org/view/journals/mwre/141/7/mwr-d-12-00278.1.xml%3Ftab_body%3Dpdf&amp;hl=en&amp;sa=T&amp;oi=gsr-r-ggp&amp;ct=res&amp;cd=0&amp;d=6841908713848986342&amp;ei=OTHtZtytGPay6rQPxrKeiAM&amp;scisig=AFWwaeaoJDdXALkuhsn44g0xEyU5">Fierro et al. (2013)</a>.</li><li>skill scores were calculated for each experiment.<ol type="1"><li>standard statistics and skill score analysis of CAPE (J/kg) and accumulated total precipitation (mm),</li></ol></li></ol></li><li>Saleh, N., Gharaylou, M., Farahani,M. M., &amp; Alizadeh, O. (2023).Performance of lightning potentialindex, lightning threat index, and theproduct of CAPE and precipitationin the WRF model. Earth and SpaceScience, 10, e2023EA003104. <a href="https://doi.org/10.1029/2023EA003104" class="uri">https://doi.org/10.1029/2023EA003104</a></li><li><a href="https://weather.ndc.nasa.gov/sport/training/lfa/LFAtraining_20111025.pdf">2011: Lightning Forecast Algorithm (LFA) Overview</a></li></ol>]]></content>
    
    
    <categories>
      
      <category>WRF</category>
      
    </categories>
    
    
    <tags>
      
      <tag>HKO</tag>
      
      <tag>WRF-ELEC</tag>
      
      <tag>Lightning</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Setting up Hexo Blog on github.io</title>
    <link href="/2024/09/13/Hexo/"/>
    <url>/2024/09/13/Hexo/</url>
    
    <content type="html"><![CDATA[<h1 id="hexo">Hexo</h1><p><a href="https://hexo.io/zh-cn/docs/#%E4%BB%80%E4%B9%88%E6%98%AF-Hexo%EF%BC%9F">Hexo</a> 是一个快速、简洁且高效的博客框架。 Hexo 使用 Markdown（或其他标记语言）解析文章，在几秒内，即可利用靓丽的主题生成静态网页。</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sh">micromamba <span class="hljs-built_in">env</span> create -n hexo<br>micromamba activate hexo<br>micromamba install conda-forge::nodejs<br></code></pre></td></tr></table></figure><ul><li>nodejs 22.8.0</li><li>git is installed</li></ul><p>底下是官方寫的 Quick Start，只需要短短五行指令就可以讓部落格跑起來。</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs sh">npm install hexo-cli -g<br>hexo init blog<br><span class="hljs-built_in">cd</span> blog<br>npm install<br>hexo server<br></code></pre></td></tr></table></figure><p>display <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">INFO  Hexo is running at http://localhost:4000/ . Press Ctrl+C to stop.<br></code></pre></td></tr></table></figure></p><ul><li>如果你已經有部落格資料夾，那麼你可以跳過“hexo init blog”</li></ul><h2 id="useful-commands">Useful commands</h2><ul><li>清理 hexo ,类似于清理编译结果，例如 执行命令 <strong>hexo clean</strong></li><li>生成静态页面, 执行命令 <strong>hexo g</strong></li><li>启动服务，执行命令 <strong>hexo s</strong> ,默认在 4000 端口启动，访问本地4000端口即可查看本地网站</li></ul><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs sh">hexo new <span class="hljs-string">&#x27;post name&#x27;</span><br>hexo clean<br>hexo generate    <span class="hljs-comment"># hexo g</span><br>hexo server      <span class="hljs-comment"># hexo s</span><br>hexo deploy      <span class="hljs-comment"># hexo d</span><br></code></pre></td></tr></table></figure><h2 id="theme-fluid">Theme: Fluid</h2><p>一款 Material Design 风格的主题</p><p><a href="https://github.com/fluid-dev/hexo-theme-fluid">An elegant Material-Design theme for Hexo</a></p><h3 id="step-1">Step 1</h3><p>下载 <a href="https://github.com/fluid-dev/hexo-theme-fluid/releases">最新 release 版本</a> 解压到 themes 目录，并将解压出的文件夹重命名为 fluid。</p><h3 id="step-2">Step 2</h3><figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs txt">如下修改 Hexo 博客目录中的 **_config.yml**：<br><br>theme: fluid  # 指定主题<br><br>language: zh-CN  # 指定语言，会影响主题显示的语言，按需修改<br></code></pre></td></tr></table></figure><h3 id="step-3">Step 3</h3><p>首次使用主题的「关于页」需要手动创建：</p><figure class="highlight actionscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs actionscript">hexo <span class="hljs-keyword">new</span> page about<br></code></pre></td></tr></table></figure><p>创建成功后，编辑博客目录下 /source/about/index.md，添加 layout 属性。</p><p>修改后的文件示例如下：</p><figure class="highlight md"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs md">---<br>title: about<br><span class="hljs-section">layout: about</span><br><span class="hljs-section">---</span><br><br>这里写关于页的正文，支持 Markdown, HTML<br></code></pre></td></tr></table></figure><h2 id="filename">Filename</h2><p><a href="https://hexo.io/docs/writing" class="uri">https://hexo.io/docs/writing</a></p><p>By default, Hexo uses the post title as its filename. You can edit the new_post_name setting in _config.yml to change the default filename. For example, <strong>:year-:month-:day-:title.md</strong> will prefix filenames with the post creation date. You can use the following placeholders:</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-comment"># Writing</span><br><span class="hljs-comment">## new_post_name: :title.md # File name of new posts</span><br><span class="hljs-attr">new_post_name:</span> <span class="hljs-string">:year-:month-:day-:title.md</span><br></code></pre></td></tr></table></figure><p>in **_config.yml** under themes/fluid.</p><h2 id="math">math</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sh">$ micromamba install conda-forge::pandoc<br>$ npm uninstall hexo-renderer-marked --save<br>$ npm install hexo-renderer-pandoc --save<br></code></pre></td></tr></table></figure><p>and, <figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-attr">math:</span><br>  <span class="hljs-attr">enable:</span> <span class="hljs-literal">true</span><br>  <span class="hljs-attr">specific:</span> <span class="hljs-literal">false</span><br>  <span class="hljs-attr">engine:</span> <span class="hljs-string">mathjax</span><br></code></pre></td></tr></table></figure></p><h2 id="mermaid">mermaid</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">$ npm install hexo-filter-mermaid-diagrams<br></code></pre></td></tr></table></figure><h1 id="deploy-to-github">Deploy to github</h1><p>设置部署类型和 github 仓库位置和主分支，到网站配置文件 _config.yml 中修改如下：</p><p>表示部署类型为 git；</p><p>仓库为 git@github.com:username/github.io.git ，替换成你的仓库即可；</p><p>分支为 master 主分支；</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs text">deploy:<br>  type: git<br>  repo: git@github.com:waipangsze/waipangsze.github.io.git<br>  branch: main<br></code></pre></td></tr></table></figure><p>安装 git 扩展模块 hexo-deployer-git，到 blog 目录中执行命令：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">$ npm install hexo-deployer-git --save<br></code></pre></td></tr></table></figure><p>执行命令</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">$ hexo d <br></code></pre></td></tr></table></figure><p>部署到上面创建的 github 仓库中。</p><p>这一步就是向 github 仓库的master 分支提交文件，所以本地要有权限向你的 github 仓库提交。需要 <strong>sshkey</strong>,至于怎么添加 sshkey，如果不清楚，查一下就知道了。</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs sh">To github.com:waipangsze/waipangsze.github.io.git<br> + 4aa63c5...24ec1e5 HEAD -&gt; main (forced update)<br>Branch <span class="hljs-string">&#x27;master&#x27;</span> <span class="hljs-built_in">set</span> up to track remote branch <span class="hljs-string">&#x27;main&#x27;</span> from <span class="hljs-string">&#x27;git@github.com:waipangsze/waipangsze.github.io.git&#x27;</span>.<br>INFO  Deploy <span class="hljs-keyword">done</span>: git<br></code></pre></td></tr></table></figure><h1 id="hexo-blog-多設備同步">hexo blog 多設備同步</h1><p>From <a href="https://xuexuan.site/2021/02/04/hexo%E5%8D%9A%E5%AE%A2%E5%A4%9A%E8%AE%BE%E5%A4%87%E5%90%8C%E6%AD%A5/">hexo博客多设备同步</a></p><div class="note note-primary">            <p>github上的repo创建了两个分支，master保存静态页面，hexo用于保存网站的全部文件。</p>          </div><ul><li>将旧环境中的文件上传到github的hexo分支：</li><li>github上切换到hexo分支，git clone仓库到本地。</li><li>此时本地会多出一个username.github.io文件夹，命令行cd进去，删除除.git文件夹（如果你看不到这个文件夹，说明是隐藏了。windows下需要右击文件夹内空白处，点选’显示/隐藏 异常文件’，Mac下我就不知道了）外的其他文件夹。</li><li>命令行git add -A把工作区的变化（包括已删除的文件）提交到暂存区（ps:git add .提交的变化不包括已删除的文件）。</li><li>命令行git commint -m "some description"提交。</li><li>命令行git push origin hexo推送到远程hexo分支。此时刷下github，如果正常操作，hexo分支应该已经被清空了。</li><li>复制本地username.github.io文件夹中的.git文件夹到hexo项目根目录下。此时，hexo项目已经变成了和远程hexo分支关联的本地仓库了。而username.github.io文件夹的使命到此为止，你可以把它删掉，因为我们只是把它作为一个“中转站”的角色。以后每次发布新文章或修改网站样式文件时，git add . &amp; git commit -m "some description" &amp; git push origin hexo即可把环境文件推送到hexo分支。然后再hexo g -d发布网站并推送静态文件到master分支。</li></ul><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs sh">git <span class="hljs-built_in">clone</span> git@github.com:waipangsze/waipangsze.github.io.git<br>waipangsze.github.io/<br>git switch hexo <br>git <span class="hljs-built_in">log</span> <br><span class="hljs-built_in">cp</span> -r .git ../../blog/ <span class="hljs-comment"># delete all files except .git</span><br><span class="hljs-built_in">cd</span> ../../blog/<br><span class="hljs-built_in">cat</span> .gitignore <br>git status<br>git add .<br>git commit -a <span class="hljs-comment"># git commit -m &quot;xxxx&quot;</span><br>git push origin hexo<br></code></pre></td></tr></table></figure><p>新环境</p><p>这部分应该要简单一点，如果你已经搭建过一个hexo博客的话。</p><ul><li>新电脑上安装node.js和git。</li><li>安装hexo：npm install -g hexo-cli。</li><li>clone远程仓库到本地 git clone git@github.com:username/username.github.io.git。</li><li>根据packge.json安装依赖npm install。</li><li>本地生成网站并开启博客服务器：hexo g &amp; hexo s。如果一切正常，此时打开浏览器输入<a href="http://localhost:4000/" class="uri">http://localhost:4000/</a> 已经可以看到博客正常运行了。</li></ul><p>在两台电脑上的同步操作</p><p>至此，迁移工作已完成，在两台电脑之间的同步操作如下：</p><ul><li>git pull从远程hexo分支拉取最新的环境文件到本地，可以理解为svn的更新操作。比如在公司写了博客，回家在电脑上也要写需要先执行这一步操作。</li><li>文章写完，要发布时，需要先提交环境文件，再发布文章。按以下顺序执行命令：git add .、git commit -m "some descrption"、git push origin hexo、hexo g -d。</li></ul><h1 id="upload-to-github">Upload to github</h1><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs sh">git pull --rebase <span class="hljs-comment"># do this at the beginning</span><br>git status<br>git add . <span class="hljs-comment"># add all files</span><br>git commit --amend<br><span class="hljs-comment"># git push (-f)</span><br>git push -u origin hexo<br></code></pre></td></tr></table></figure><h1 id="相關連結-icon">相關連結 icon</h1><p>官方的 icon 圖示，均引用自目前做網站最多人使用的免費 icon 圖庫 <a href="https://fontawesome.com/">Font Awesome</a>，Font Awesome 是一個基於CSS和LESS的字體和圖示工具套件。它由Dave Gandy製作，用於Twitter Bootstrap，後來被整合到BootstrapCDN 中。Font Awesome在使用第三方Font Scripts的網站中佔有20％的市場份額，排在Google字體之後的第二位。</p><h1 id="便签">便签</h1><p>可选便签：</p><ul><li>primary</li><li>secondary</li><li>success</li><li>danger</li><li>warning</li><li>info</li><li>light</li></ul><div class="note note-primary">            <p>primary: 文字 或者 <code>markdown</code> 均可</p>          </div><div class="note note-secondary">            <p>secondary: 文字 或者 <code>markdown</code> 均可</p>          </div><div class="note note-success">            <p>success: 文字 或者 <code>markdown</code> 均可</p>          </div><div class="note note-danger">            <p>danger: 文字 或者 <code>markdown</code> 均可</p>          </div><div class="note note-warning">            <p>warning: 文字 或者 <code>markdown</code> 均可</p>          </div><div class="note note-info">            <p>info: 文字 或者 <code>markdown</code> 均可</p>          </div><div class="note note-light">            <p>light: 文字 或者 <code>markdown</code> 均可</p>          </div><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs markdown">&#123;% note primary %&#125;<br>primary: 文字 或者 <span class="hljs-code">`markdown`</span> 均可<br>&#123;% endnote %&#125;<br></code></pre></td></tr></table></figure><h1 id="折叠块">折叠块</h1><p>使用折叠块，可以折叠代码、图片、文字等任何内容，你可以在 markdown 中按如下格式：</p>    <div class="fold">      <div class="fold-title fold-info collapsed" data-toggle="collapse" href="#collapse-b5714680" role="button" aria-expanded="false" aria-controls="collapse-b5714680">        <div class="fold-arrow">▶</div>title      </div>      <div class="fold-collapse collapse" id="collapse-b5714680">        <div class="fold-content">          <p>需要折叠的一段内容，支持 markdown</p>        </div>      </div>    </div><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs markdown">&#123;% fold info @title %&#125;<br>需要折叠的一段内容，支持 markdown<br>&#123;% endfold %&#125;<br></code></pre></td></tr></table></figure><h1 id="多张图片按一定布局组合显示">多张图片按一定布局组合显示</h1><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs less">&#123;% <span class="hljs-selector-tag">gi</span> <span class="hljs-number">5</span> <span class="hljs-number">3</span><span class="hljs-selector-tag">-2</span> %&#125;<br>!<span class="hljs-selector-attr">[1]</span>(<span class="hljs-attribute">https</span>:<span class="hljs-comment">//i.imgur.com/RwpxULg.png)</span><br>![<span class="hljs-number">2</span>](<span class="hljs-attribute">https</span>:<span class="hljs-comment">//i.imgur.com/RwpxULg.png)</span><br>![<span class="hljs-number">3</span>](<span class="hljs-attribute">https</span>:<span class="hljs-comment">//i.imgur.com/RwpxULg.png)</span><br>![<span class="hljs-number">4</span>](<span class="hljs-attribute">https</span>:<span class="hljs-comment">//i.imgur.com/RwpxULg.png)</span><br>![<span class="hljs-number">5</span>](<span class="hljs-attribute">https</span>:<span class="hljs-comment">//i.imgur.com/RwpxULg.png)</span><br>&#123;% endgi %&#125;<br></code></pre></td></tr></table></figure><div class="group-image-container"><div class="group-image-row"><div class="group-image-wrap"><img src="https://i.imgur.com/RwpxULg.png" alt="1" /></div><div class="group-image-wrap"><img src="https://i.imgur.com/RwpxULg.png" alt="2" /></div><div class="group-image-wrap"><img src="https://i.imgur.com/RwpxULg.png" alt="3" /></div></div><div class="group-image-row"><div class="group-image-wrap"><img src="https://i.imgur.com/RwpxULg.png" alt="4" /></div><div class="group-image-wrap"><img src="https://i.imgur.com/RwpxULg.png" alt="5" /></div></div></div><h1 id="展示pdf">展示PDF</h1><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">npm install --save hexo-pdf<br></code></pre></td></tr></table></figure><p>and</p><figure class="highlight django"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs django"><span class="hljs-template-tag">&#123;% <span class="hljs-name">pdf</span> ../pdf/xxx.pdf %&#125;</span><br></code></pre></td></tr></table></figure><h1 id="統計網站的造訪地區和ip">統計網站的造訪地區和IP</h1><ol type="1"><li><a href="http://www.waylon.one/website/statistics-visitor-traffic/">通过 clustermaps 统计 Hexo 网站的访问地区和 IP</a></li></ol><p><a href="https://clustrmaps.com/">clustrmaps.com</a> 是美國的資料網站。</p><p>網址提供了產生訪客地址分佈圖的程式碼，可以嵌入到網站或部落格中，來顯示來自世界各地訪客的即時地圖，有助於發展您隱藏的興趣社群。最重要的是，這個功能是免費的，能夠滿足個人網站的需求。</p><ul><li>配置 clustrmaps<ul><li>網站註冊後，請造訪 Enter your website address 新增自己的網站地址，選擇免費的服務。</li><li>選擇自己喜歡的外掛格式，現在 Hexo 的 Next 兩個主題都是支援的，比較喜歡 Map widget 的主題。</li><li>點選選擇後，拷貝網站出現的腳本 javascript 程式碼，貼到主題下某個位置。</li><li>我把它放在 about.ejs or index.md 的最後。<ul><li><script type="text/javascript" id="clustrmaps" src="//clustrmaps.com/map_v2.js?d=-FD52b9oydXY9a4RbTCAxGTeHgh-1YTFnwSX0jxQlA0&cl=ffffff&w=a"></script></li></ul></li><li>重新部署網站，您就可以在首頁看到即時訪客來源圖，如我的網站首頁所示。另外，點擊地圖，可以看到更詳細的信息，包括訪客的地圖、瀏覽設備以及 IP。</li></ul></li></ul><h1 id="導入影片">導入影片</h1><p>The easiest way to get the correct link is to right-click on the YouTube video and select copy embed code.</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">iframe</span> <span class="hljs-attr">width</span>=<span class="hljs-string">&quot;560&quot;</span> <span class="hljs-attr">height</span>=<span class="hljs-string">&quot;315&quot;</span> <span class="hljs-attr">src</span>=<span class="hljs-string">&quot;xxx&quot;</span> <span class="hljs-attr">......</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">iframe</span>&gt;</span><br></code></pre></td></tr></table></figure><iframe width="560" height="315" src="https://www.youtube.com/embed/XGPLHwARPSY?si=yd2MGyNa0GhkBkCs" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen></iframe><h1 id="支持二级菜单下拉菜单">支持二级菜单（下拉菜单）</h1><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-comment"># 导航栏菜单，可自行增减，key 用来关联 languages/*.yml，如不存在关联则显示 key 本身的值；icon 是 css class，可以省略；增加 name 可以强制显示指定名称</span><br><span class="hljs-comment"># Navigation bar menu. `key` is used to associate languages/*.yml. If there is no association, the value of `key` itself will be displayed; if `icon` is a css class, it can be omitted; adding `name` can force the display of the specified name</span><br><span class="hljs-attr">menu:</span><br>  <span class="hljs-bullet">-</span> &#123; <span class="hljs-attr">key:</span> <span class="hljs-string">&quot;home&quot;</span>, <span class="hljs-attr">link:</span> <span class="hljs-string">&quot;/&quot;</span>, <span class="hljs-attr">icon:</span> <span class="hljs-string">&quot;iconfont icon-home-fill&quot;</span> &#125;<br>  <span class="hljs-bullet">-</span> &#123; <span class="hljs-attr">key:</span> <span class="hljs-string">&quot;archive&quot;</span>, <span class="hljs-attr">link:</span> <span class="hljs-string">&quot;/archives/&quot;</span>, <span class="hljs-attr">icon:</span> <span class="hljs-string">&quot;iconfont icon-archive-fill&quot;</span> &#125;<br>  <span class="hljs-bullet">-</span> &#123; <span class="hljs-attr">key:</span> <span class="hljs-string">&quot;category&quot;</span>, <span class="hljs-attr">link:</span> <span class="hljs-string">&quot;/categories/&quot;</span>, <span class="hljs-attr">icon:</span> <span class="hljs-string">&quot;iconfont icon-category-fill&quot;</span> &#125;<br>  <span class="hljs-bullet">-</span> &#123; <span class="hljs-attr">key:</span> <span class="hljs-string">&quot;tag&quot;</span>, <span class="hljs-attr">link:</span> <span class="hljs-string">&quot;/tags/&quot;</span>, <span class="hljs-attr">icon:</span> <span class="hljs-string">&quot;iconfont icon-tags-fill&quot;</span> &#125;<br>  <span class="hljs-bullet">-</span> &#123; <span class="hljs-attr">key:</span> <span class="hljs-string">&quot;links&quot;</span>, <span class="hljs-attr">link:</span> <span class="hljs-string">&quot;/links/&quot;</span>, <span class="hljs-attr">icon:</span> <span class="hljs-string">&quot;iconfont icon-link-fill&quot;</span> &#125;<br>  <span class="hljs-bullet">-</span> &#123; <span class="hljs-attr">key:</span> <span class="hljs-string">&quot;Bookmarks&quot;</span>, <span class="hljs-attr">link:</span> <span class="hljs-string">&quot;/bookmark/&quot;</span>, <span class="hljs-attr">icon:</span> <span class="hljs-string">&quot;iconfont icon-bookmark&quot;</span>&#125;<br>  <span class="hljs-bullet">-</span> &#123; <span class="hljs-attr">key:</span> <span class="hljs-string">&quot;about&quot;</span>, <span class="hljs-attr">link:</span> <span class="hljs-string">&quot;/about/&quot;</span>, <span class="hljs-attr">icon:</span> <span class="hljs-string">&quot;iconfont icon-user-fill&quot;</span>, <span class="hljs-attr">name:</span> <span class="hljs-string">&#x27;About Me&#x27;</span>&#125;<br>  <span class="hljs-bullet">-</span> &#123;<br>  <span class="hljs-attr">key:</span> <span class="hljs-string">&#x27;Docs&#x27;</span>,<br>  <span class="hljs-attr">icon:</span> <span class="hljs-string">&#x27;iconfont icon-books&#x27;</span>,<br>  <span class="hljs-attr">submenu:</span> [<br>    <span class="hljs-comment">#&#123; key: &#x27;Physics&#x27;, link: &#x27;/archives/&#x27; &#125;,</span><br>    <span class="hljs-comment">#&#123; key: &#x27;Mathematics&#x27;, link: &#x27;/tags/&#x27; &#125;,</span><br>    &#123; <span class="hljs-attr">key:</span> <span class="hljs-string">&#x27;Meteorology&#x27;</span>, <span class="hljs-attr">link:</span> <span class="hljs-string">&#x27;/categories/Meteorology/&#x27;</span>, <span class="hljs-attr">icon:</span> <span class="hljs-string">&quot;iconfont icon-plan&quot;</span> &#125;<br>  ]<br>  &#125;<br></code></pre></td></tr></table></figure><p>這裡我們使用/categories/Meteorology/中的鏈接，但它只是標題，沒有<strong>封面圖片</strong>。如何顯示<strong>封面圖片</strong>？</p><h2 id="on-category.ejs">On category.ejs</h2><p>這裡我們使用/categories/Meteorology/中的鏈接，但它只是標題，沒有<strong>封面圖片</strong>。如何顯示<strong>封面圖片</strong>？</p><p>它調用了程式碼,</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs js">&lt;%- <span class="hljs-title function_">partial</span>(<span class="hljs-string">&#x27;_partials/archive-list.ejs&#x27;</span>, &#123; <span class="hljs-attr">params</span>: &#123; <span class="hljs-attr">key</span>: page.<span class="hljs-property">layout</span>, <span class="hljs-attr">postTotal</span>: cat ? cat.<span class="hljs-property">posts</span>.<span class="hljs-property">length</span> : <span class="hljs-number">0</span> &#125; &#125;) %&gt;<br></code></pre></td></tr></table></figure><p>建立一個 my-list.ejs 並使用它的程式碼，</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs js">&lt;%- <span class="hljs-title function_">partial</span>(<span class="hljs-string">&#x27;_partials/my-list.ejs&#x27;</span>, &#123; <span class="hljs-attr">params</span>: &#123; <span class="hljs-attr">key</span>: page.<span class="hljs-property">layout</span>, <span class="hljs-attr">postTotal</span>: cat ? cat.<span class="hljs-property">posts</span>.<span class="hljs-property">length</span> : <span class="hljs-number">0</span> &#125; &#125;) %&gt;<br></code></pre></td></tr></table></figure><p>my-list.ejs 是什麼？ （複製自index.ejs，其中一部分）</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><code class="hljs js">&lt;div <span class="hljs-keyword">class</span>=<span class="hljs-string">&quot;list-group&quot;</span>&gt;<br>  <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;h4&quot;</span>&gt;</span>&lt;%= __(params.key + &#x27;.post_total&#x27;, params.postTotal) %&gt;<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span></span><br>  &lt;hr&gt;<br>  &lt;% <span class="hljs-keyword">var</span> dateCursor %&gt;<br>  &lt;% page.<span class="hljs-property">posts</span>.<span class="hljs-title function_">each</span>(<span class="hljs-keyword">function</span> (<span class="hljs-params">post</span>) &#123; %&gt;<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;row mx-auto index-card&quot;</span>&gt;</span></span><br><span class="language-xml">      &lt;% var post_url = url_for(post.path), index_img = post.index_img || theme.post.default_index_img %&gt;</span><br><span class="language-xml">      &lt;% if (index_img) &#123; %&gt;</span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;col-12 col-md-4 m-auto index-img&quot;</span>&gt;</span></span><br><span class="language-xml">          <span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">&quot;&lt;%= post_url %&gt;&quot;</span> <span class="hljs-attr">target</span>=<span class="hljs-string">&quot;&lt;%- theme.index.post_url_target %&gt;&quot;</span>&gt;</span></span><br><span class="language-xml">            <span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">&quot;&lt;%= url_for(index_img) %&gt;&quot;</span> <span class="hljs-attr">alt</span>=<span class="hljs-string">&quot;&lt;%= post.title %&gt;&quot;</span>&gt;</span></span><br><span class="language-xml">          <span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span></span><br><span class="language-xml">        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br><span class="language-xml">      &lt;% &#125; %&gt;</span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">article</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;col-12 col-md-&lt;%= index_img ? &#x27;8&#x27; : &#x27;12&#x27; %&gt; mx-auto index-info&quot;</span>&gt;</span></span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">h2</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;index-header&quot;</span>&gt;</span></span><br><span class="language-xml">          &lt;% if (theme.index.post_sticky &amp;&amp; theme.index.post_sticky.enable &amp;&amp; post.sticky &gt; 0) &#123; %&gt;</span><br><span class="language-xml">            <span class="hljs-tag">&lt;<span class="hljs-name">i</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;index-pin &lt;%= theme.index.post_sticky &amp;&amp; theme.index.post_sticky.icon %&gt;&quot;</span> <span class="hljs-attr">title</span>=<span class="hljs-string">&quot;Pin on top&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">i</span>&gt;</span></span><br><span class="language-xml">          &lt;% &#125; %&gt;</span><br><span class="language-xml">          <span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">&quot;&lt;%= post_url %&gt;&quot;</span> <span class="hljs-attr">target</span>=<span class="hljs-string">&quot;&lt;%- theme.index.post_url_target %&gt;&quot;</span>&gt;</span></span><br><span class="language-xml">            &lt;%= post.title %&gt;</span><br><span class="language-xml">          <span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span></span><br><span class="language-xml">        <span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span></span><br><span class="language-xml">  </span><br><span class="language-xml">        &lt;% var excerpt = post.description || post.excerpt || (theme.index.auto_excerpt.enable &amp;&amp; !post.encrypt &amp;&amp; post.content) %&gt;</span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;index-excerpt &lt;%= index_img ? &#x27;&#x27; : &#x27;index-excerpt__noimg&#x27; %&gt;&quot;</span> <span class="hljs-attr">href</span>=<span class="hljs-string">&quot;&lt;%= post_url %&gt;&quot;</span> <span class="hljs-attr">target</span>=<span class="hljs-string">&quot;&lt;%- theme.index.post_url_target %&gt;&quot;</span>&gt;</span></span><br><span class="language-xml">          <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span></span><br><span class="language-xml">            &lt;%- strip_html(excerpt).substring(0, 200).trim().replace(/\n/g, &#x27; &#x27;) %&gt;</span><br><span class="language-xml">          <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br><span class="language-xml">        <span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span></span><br><span class="language-xml">  </span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;index-btm post-metas&quot;</span>&gt;</span></span><br><span class="language-xml">          &lt;% if (theme.index.post_meta.date) &#123; %&gt;</span><br><span class="language-xml">            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;post-meta mr-3&quot;</span>&gt;</span></span><br><span class="language-xml">              <span class="hljs-tag">&lt;<span class="hljs-name">i</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;iconfont icon-date&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">i</span>&gt;</span></span><br><span class="language-xml">              <span class="hljs-tag">&lt;<span class="hljs-name">time</span> <span class="hljs-attr">datetime</span>=<span class="hljs-string">&quot;&lt;%= full_date(post.date, &#x27;YYYY-MM-DD HH:mm&#x27;) %&gt;&quot;</span> <span class="hljs-attr">pubdate</span>&gt;</span></span><br><span class="language-xml">                &lt;%- date(post.date, config.date_format) %&gt;</span><br><span class="language-xml">              <span class="hljs-tag">&lt;/<span class="hljs-name">time</span>&gt;</span></span><br><span class="language-xml">            <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br><span class="language-xml">          &lt;% &#125; %&gt;</span><br><span class="language-xml">          &lt;% if (theme.index.post_meta.category &amp;&amp; post.categories.length &gt; 0) &#123; %&gt;</span><br><span class="language-xml">            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;post-meta mr-3 d-flex align-items-center&quot;</span>&gt;</span></span><br><span class="language-xml">              <span class="hljs-tag">&lt;<span class="hljs-name">i</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;iconfont icon-category&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">i</span>&gt;</span></span><br><span class="language-xml">              &lt;%- partial(&#x27;_partials/category-chains&#x27;, &#123; categories: post.categories, limit: 1 &#125;) %&gt;</span><br><span class="language-xml">            <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br><span class="language-xml">          &lt;% &#125; %&gt;</span><br><span class="language-xml">          &lt;% if (theme.index.post_meta.tag &amp;&amp; post.tags.length &gt; 0) &#123; %&gt;</span><br><span class="language-xml">            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;post-meta&quot;</span>&gt;</span></span><br><span class="language-xml">              <span class="hljs-tag">&lt;<span class="hljs-name">i</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;iconfont icon-tags&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">i</span>&gt;</span></span><br><span class="language-xml">              &lt;% post.tags.each(function(tag)&#123; %&gt;</span><br><span class="language-xml">                <span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">&quot;&lt;%= url_for(tag.path) %&gt;&quot;</span>&gt;</span>#&lt;%- tag.name %&gt;<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span></span><br><span class="language-xml">              &lt;% &#125;) %&gt;</span><br><span class="language-xml">            <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br><span class="language-xml">          &lt;% &#125; %&gt;</span><br><span class="language-xml">        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;/<span class="hljs-name">article</span>&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br><span class="language-xml">  &lt;% &#125;) %&gt;</span><br><span class="language-xml"><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br><br>&lt;%- <span class="hljs-title function_">partial</span>(<span class="hljs-string">&#x27;_partials/paginator&#x27;</span>) %&gt;<br></code></pre></td></tr></table></figure><h1 id="範例網站">範例網站</h1><ol type="1"><li><a href="https://zkqiang.cn/">zkqiang's blog</a></li><li><a href="https://fantasyhh.github.io/archives/page/5/#board">秉烛夜读</a><ol type="1"><li><a href="https://github.com/fantasyhh/fantasyhh.github.io" class="uri">https://github.com/fantasyhh/fantasyhh.github.io</a></li></ol></li><li><a href="https://s81679.github.io/2020/02/25/hexo-theme-fluid/">來點鳥 blog</a></li><li><a href="https://www.eatrice.cn/post/%E4%BB%8E0%E5%BC%80%E5%A7%8B%E6%90%AD%E5%BB%BA%E4%B8%80%E4%B8%AAhexo%E5%8D%9A%E5%AE%A2/">吃白饭的休伯利安号</a></li><li><a href="https://yuzhang.pages.dev/about/">Yu's Space</a></li><li><a href="https://blog.justlovesmile.top/about/">Justlovesmile</a></li><li><a href="https://zsyyblog.com/about/">zsyyblog.com</a></li><li><a href="https://yangyy.top/about/">Yangyy's Life</a></li><li><a href="https://blognas.hwb0307.com/me">Bensz’s blog</a></li><li><a href="https://neutrino7.top/about/#comment">七号中微子</a></li><li><a href="https://blog.zsd.name/posts/63716.html#%E8%87%AA%E5%AE%9A%E5%88%B6%E4%BF%AE%E6%94%B9">张赛东</a></li><li><a href="https://www.yousazoe.top/archives/e5b4d2d6.html">Fl0w3r | Hexo-Fluid 博客建站記錄</a></li><li><a href="https://www.tabirstrees.top/about/">南科大地空系空间物理研究生</a></li></ol><h1 id="references">References:</h1><ol type="1"><li><a href="https://fluid-dev.github.io/hexo-fluid-docs/en/guide/">Hexo Fluid Docs</a></li><li><a href="https://async-docs.imalun.com/">一个简单而轻量级的 Hexo 主题</a></li><li><a href="https://linyencheng.github.io/2022/09/14/relationships-between-frontend-and-backend/tool-hexo-blog/">用 Hexo 和 Github Pages 建立部落格吧</a></li><li><a href="https://mp.weixin.qq.com/s/Iy-ZXHHHRwHBCwozF5wtyg">用 GitHub + Hexo 免费搭建博客，保姆级教程</a></li><li><a href="https://wangxiaoyu-go.github.io/2018/11/23/hexo-filter-mermaid-diagrams/">Hexo中插入mermaid diagrams</a></li><li><a href="https://xuexuan.site/2021/02/04/hexo%E5%8D%9A%E5%AE%A2%E5%A4%9A%E8%AE%BE%E5%A4%87%E5%90%8C%E6%AD%A5/">hexo博客多设备同步</a></li><li><a href="https://blog.csdn.net/qq_30105599/article/details/118302086">多台电脑同步更新Hexo博客</a></li></ol>]]></content>
    
    
    <categories>
      
      <category>Hexo</category>
      
    </categories>
    
    
    <tags>
      
      <tag>github.io</tag>
      
      <tag>blog</tag>
      
      <tag>Hexo</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>DA-Meteorological Data Encoding(氣象數據編碼)</title>
    <link href="/2024/08/20/DA-obs-introduction/"/>
    <url>/2024/08/20/DA-obs-introduction/</url>
    
    <content type="html"><![CDATA[<h1 id="meteorological-data-encoding">Meteorological Data Encoding</h1><p>氣象數據編碼</p><ul><li><a href="https://www.hko.gov.hk/tc/education/weather/data-and-technology/00479-abc-of-meteorological-data-encoding.html">HKO 淺談氣象數據編碼 (2015)</a></li><li><a href="https://web.archive.org/web/20180215023559/https://www.eumetsat.int/website/wcm/idc/idcplg?IdcService=GET_FILE&amp;dDocName=PDF_CONF_P57_S5_01_KARHILA_V&amp;RevisionSelectionMethod=LatestReleased&amp;Rendition=Web">BUFR: A METEOROLOGICAL CODE FOR THE 21ST CENTURY (2010)</a></li><li><a href="https://photino.cwb.gov.tw/rdcweb/lib/cd/cd01conf/dissertation/2014WAF/A1/A1-23.pdf">中央氣象局新格式氣象觀測資料作業系統介紹 (2014)</a></li><li><a href="https://community.wmo.int/en/activity-areas/operational-information-service/migration-tac-tdcf">Migration TAC to TDCF</a></li><li><a href="https://mp.weixin.qq.com/s/qiowYgEHHdQhC4TPbcjMVw">气象编程 | 读取气象BUFR、PREPBUFR数据</a></li></ul><p>Currently, most meteorological observations are being produced and transmitted in special formats known as</p><ul><li>Traditional Alphanumeric Codes (TAC) 傳統字符代碼</li><li>Table-Driven Code Forms (TDCF) 表格驅動代碼</li></ul><p>as promulgated by WMO. Both TAC and TDCF are ways of representing meteorological data intended for international exchange in real-time.</p><figure><img src="https://www.hko.gov.hk/en/education/images/fig_00479_1e.png" alt="Decoded TAC Information" /><figcaption>Decoded TAC Information</figcaption></figure><figure><img src="https://www.hko.gov.hk/en/education/images/fig_00479_2e.png" alt="Decoded BUFR Information" /><figcaption>Decoded BUFR Information</figcaption></figure><h2 id="bufr">BUFR</h2><ul><li>Binary Universal Form for the Representation of meteorological data</li><li>二進制通用數據表示格式</li></ul><p>BURF is TDCF.</p><p>The latest version is BUFR Edition 4. BUFR Edition 3 is also considered current for operational use. BUFR was created in 1988 with the goal of replacing the WMO's dozens of character-based, position-driven meteorological codes, such as <strong>SYNOP (surface observations)</strong>, <strong>TEMP (upper air soundings)</strong> and <strong>CLIMAT (monthly climatological data)</strong>. BUFR was designed to be portable, compact, and universal. Any kind of data can be represented, along with its specific spatial/temporal context and any other associated metadata. In the WMO terminology, BUFR belongs to the category of table-driven code forms, where the meaning of data elements is determined by referring to a set of tables that are kept and maintained separately from the message itself.</p><h1 id="little_r">LITTLE_R</h1><p><a href="https://www2.mmm.ucar.edu/wrf/users/wrfda/OnlineTutorial/Help/littler.html">What is LITTLE_R?</a></p><p>LITTLE_R is an ASCII-based observation file format, <strong>in use since the MM5 era</strong>. Because raw observation data files have many possible formats (such as ASCII, BUFR, PREPBUFR, MADIS, and HDF) LITTLE_R is designed to be an intermediate format so that <strong>WRFDA might be able to assimilate as many observation types as possible in a universal manner</strong>. It is a report-based file format, so all manner of observation types can easily be "cat-ted" together into an easy-to-read and -edit text file.</p><p><strong>It is the user's responsibility to develop an interface to convert their own observations to LITTLE_R format so they may be read by OBSPROC</strong>. We (UCAR) do not support any existing tools which do this. However, on this help page, we hope to describe the format as thoroughly as possible to aid the user in the conversion process.</p>]]></content>
    
    
    <categories>
      
      <category>DA</category>
      
    </categories>
    
    
    <tags>
      
      <tag>NWP</tag>
      
      <tag>WRF</tag>
      
      <tag>MPAS</tag>
      
      <tag>DA</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>GFS/FNL/RDA upgrade (2024)</title>
    <link href="/2024/08/16/GFS_FNL_RDA_upgrade/"/>
    <url>/2024/08/16/GFS_FNL_RDA_upgrade/</url>
    
    <content type="html"><![CDATA[<h1 id="rda-team">RDA team</h1><p>RDA - Research Data Archive</p><h2 id="rda-data-services-unavailable-july-30-2024">RDA Data Services Unavailable July 30, 2024</h2><ul><li>July 26, 2024 Posted by: RDA Team</li></ul><p>Update on July 31, 2024: standard data file download, THREDDS access, and Globus transfer services have been restored. We continue to resolve issues with data search and subsetting services. Thank you for your patience during this maintenance period.</p><p>Due to scheduled updates on the NSF NCAR Research Data Archive, all RDA data access services, including downloads, data subsetting, and THREDDS data server access, will be unavailable July 30, 2024 beginning at 9:00 AM MDT. We anticipate services to be restored near the end of the day July 30. Please follow our Twitter profile (<span class="citation" data-cites="NCAR_RDA">@NCAR_RDA</span>) for updates.</p><p>The primary purpose of the downtime is to update the dataset numbering system for data collections archived in the RDA. After the update, <strong>all RDA datasets will be identified by a dataset number in the format 'dnnnnnn', where 'nnnnnn' is the serial number used to identify a dataset. Until now, dataset numbers have been in the format 'dnnn.n'. This format will be converted to the new format 'dnnn00n', in which the first three digits of the old format are placed in the first three positions of the new format, and the last digit of the old format will be placed in the last position of the new format. For example, the dataset ID 'ds094.1' will be converted to 'd094001', and the dataset ID 'ds351.0' will be converted to 'd351000'.</strong> Please contact us at rdahelp@ucar.edu if you have questions regarding this update.</p><h2 id="changes">Changes</h2><p>Goto <a href="https://waipangsze.github.io/2023/04/27/GFS_FNL/" class="uri">https://waipangsze.github.io/2023/04/27/GFS_FNL/</a></p><ul><li>old one: https://rda.ucar.edu/data/ds084.1/</li><li>new one: https://data.rda.ucar.edu/d084001/</li></ul>]]></content>
    
    
    <categories>
      
      <category>NWP</category>
      
    </categories>
    
    
    <tags>
      
      <tag>WRF</tag>
      
      <tag>WPS</tag>
      
      <tag>MPAS</tag>
      
      <tag>IC/BC</tag>
      
      <tag>NCEP</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>WRF | WRF-DA Installation</title>
    <link href="/2024/08/16/wrf-DA_Installation/"/>
    <url>/2024/08/16/wrf-DA_Installation/</url>
    
    <content type="html"><![CDATA[<h1 id="preparation">Preparation</h1><p>Install all requried libraries of WRF.</p><p>Beginning with version 4.0, the basic WRF tar file now includes WRFDA, WRFPLUS, and WRF-Chem. Next to the WRFDA tar file link, there is a link to 'updates.' Take a look at that for additional information regarding this change. You can also find updated compiling instructions in the Users Guide: <a href="http://www2.mmm.ucar.edu/wrf/users/docs/user_guide_v4/v4.0/users_guide_chap6.html" class="uri">http://www2.mmm.ucar.edu/wrf/users/docs/user_guide_v4/v4.0/users_guide_chap6.html</a></p><h1 id="wrf-da">WRF-DA</h1><p><a href="https://www2.mmm.ucar.edu/wrf/users/wrfda/">WRF Data Assimilation System Users Page</a></p><p>The WRFDA system is in the public domain and is freely available for community use. It is designed to be a flexible, state-of-the-art atmospheric data assimilation system that is portable and efficient on available parallel computing platforms. WRFDA is suitable for use in a broad range of applications, across scales ranging from kilometers for regional and mesoscale modeling to thousands of kilometers for global scale modeling.</p><p>The Mesoscale and Microscale Meteorology (MMM) Laboratory of NCAR currently maintains and supports a subset of the overall WRF code (Version 4) that includes:</p><ul><li>WRF Software Framework (WSF)</li><li>Advanced Research WRF (ARW) dynamic solver, including one-way, two-way nesting and moving nests, grid and observation nudging</li><li>WRF Pre-Processing System (WPS)</li><li><strong>WRF Data Assimilation System (WRFDA)</strong></li><li>Numerous physics packages contributed by WRF partners and the research community</li></ul><h2 id="installation">Installation</h2><ul><li>wrf_env.sh</li></ul><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-meta">#!/bin/bash</span><br><br><span class="hljs-built_in">export</span> PATH=/home/wpsze/GNU_GCC/Library/gcc-v9.3.0/bin:<span class="hljs-variable">$PATH</span><br><span class="hljs-built_in">export</span> LD_LIBRARY_PATH=/home/wpsze/GNU_GCC/Library/gcc-v9.3.0/lib/<span class="hljs-variable">$&#123;LD_LIBRARY_PATH:+:$LD_LIBRARY_PATH&#125;</span><br><span class="hljs-built_in">export</span> LD_LIBRARY_PATH=/home/wpsze/GNU_GCC/Library/gcc-v9.3.0/lib64:<span class="hljs-variable">$LD_LIBRARY_PATH</span><br><br><span class="hljs-built_in">export</span> LD_LIBRARY_PATH=/home/wpsze/WRF/WRFv440/Library/lib:<span class="hljs-variable">$LD_LIBRARY_PATH</span><br><span class="hljs-built_in">export</span> LDFLAGS=-L/home/wpsze/WRF/WRFv440/Library/lib<br><span class="hljs-built_in">export</span> CPPFLAGS=-I/home/wpsze/WRF/WRFv440/Library/include<br><span class="hljs-built_in">export</span> NETCDF=/home/wpsze/WRF/WRFv440/Library/<br><span class="hljs-built_in">export</span> HDF5=/home/wpsze/WRF/WRFv440/Library/<br><span class="hljs-built_in">export</span> PATH=/home/wpsze/WRF/WRFv440/Library/bin:<span class="hljs-variable">$PATH</span><br><br>gcc --version<br>gfortran --version<br>mpirun --version<br><span class="hljs-built_in">which</span> mpif90 &amp; mpif90 --version<br><br>time mpif90 --version<br></code></pre></td></tr></table></figure><ul><li>wrf_da_install.sh</li></ul><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-meta">#!/bin/bash</span><br><span class="hljs-comment">############################## Directory Listing ############################</span><br><span class="hljs-built_in">export</span> HOME=`<span class="hljs-built_in">pwd</span>`<br><span class="hljs-built_in">export</span> download_DIR=<span class="hljs-variable">$HOME</span>/wrf_install/<br><span class="hljs-built_in">export</span> libs_DIR=<span class="hljs-variable">$HOME</span>/Library/<br><br><span class="hljs-built_in">echo</span> <span class="hljs-variable">$HOME</span><br><span class="hljs-built_in">echo</span> <span class="hljs-variable">$download_DIR</span><br><span class="hljs-built_in">echo</span> <span class="hljs-variable">$libs_DIR</span><br><br><span class="hljs-built_in">mkdir</span> -p wrf_install<br><span class="hljs-built_in">mkdir</span> -p Library<br><br><span class="hljs-comment">############################## WRF ############################</span><br><span class="hljs-built_in">source</span> /home/wpsze/WRF/WRFv440/wrf_env.sh<br><span class="hljs-comment">##################################################################</span><br><span class="hljs-comment"># Prior to version 4.0, WRFPlus code had been developed and maintained </span><br><span class="hljs-comment"># in a separated branch from WRF. From V4.0, it is now fully integrated </span><br><span class="hljs-comment"># into the same WRF branch. TLM/ADJ code is located in the &#x27;wrftladj&#x27; directory.</span><br><br><span class="hljs-comment"># Now WRF, WRFDA, and WRFPLUS are stored in the same package which you can get from GitHub. </span><br><span class="hljs-comment"># After downloading WRF package, decompress it three times, </span><br><span class="hljs-comment"># rename it to WRF, WRFDA, and WRFPLUS.</span><br><br><span class="hljs-built_in">cd</span> <span class="hljs-variable">$download_DIR</span><br><br><span class="hljs-built_in">rm</span> -rf WRFVDA4.5<br><br><span class="hljs-built_in">cp</span> -r WRFV4.4-raw WRFDAV4.4<br><br><span class="hljs-built_in">cd</span> WRFDAV4.4/<br><br>./clean -a<br><br>./configure wrfda<br><br><span class="hljs-comment">## rewrite: The character class \s will match the whitespace characters &lt;tab&gt; and &lt;space&gt;.</span><br><span class="hljs-comment">## and don&#x27;t include $(DM_FC) </span><br><span class="hljs-comment"># ** Not for all version **</span><br>sed -i <span class="hljs-string">&quot;s/\s\stime\s//g&quot;</span> configure.wrf<br><br>./compile all_wrfvar 2&gt;&amp;1 | <span class="hljs-built_in">tee</span> compile_wrfda.out<br><br><span class="hljs-comment"># After successful compilation, you can find the EXE file of WRFDA in the var/build/ directory</span><br><span class="hljs-comment"># ./var/build/da_wrfvar.exe</span><br></code></pre></td></tr></table></figure><p>End of compilation,</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs sh">......<br><span class="hljs-keyword">if</span> [ <span class="hljs-string">&quot;-DBUFR&quot;</span> = <span class="hljs-string">&quot;-DBUFR&quot;</span> ] ; <span class="hljs-keyword">then</span> \<br>gfortran -o obsproc.exe \<br>module_date.o module_namelist.o module_mm5.o module_map.o module_map_utils.o module_intp.o module_type.o module_func.o module_inside.o module_obs_merge.o module_per_type.o module_duplicate.o module_sort.o module_write.o module_complete.o module_recoverp.o module_diagnostics.o module_recoverh.o module_icao.o module_qc.o module_err_afwa.o module_err_ncep.o module_thin_ob.o \<br>module_decoded.o module_stntbl.o \<br>error_handler.o fm_decoder.o sort_platform.o qc_reduction.o check_obs.o setup.o \<br>obsproc.o  -O2 -ftree-vectorize -funroll-loops -w -ffree-form -ffree-line-length-none -fconvert=big-endian -frecord-marker=4      ../../external/bufr/libbufr.a; \<br><span class="hljs-keyword">else</span> \<br>gfortran -o obsproc.exe \<br>module_date.o module_namelist.o module_mm5.o module_map.o module_map_utils.o module_intp.o module_type.o module_func.o module_inside.o module_obs_merge.o module_per_type.o module_duplicate.o module_sort.o module_write.o module_complete.o module_recoverp.o module_diagnostics.o module_recoverh.o module_icao.o module_qc.o module_err_afwa.o module_err_ncep.o module_thin_ob.o \<br>module_decoded.o module_stntbl.o \<br>error_handler.o fm_decoder.o sort_platform.o qc_reduction.o check_obs.o setup.o \<br>obsproc.o  -O2 -ftree-vectorize -funroll-loops -w -ffree-form -ffree-line-length-none -fconvert=big-endian -frecord-marker=4      ; \<br><span class="hljs-keyword">fi</span><br>make[2]: Leaving directory <span class="hljs-string">&#x27;/home/wpsze/WRF/WRFv440/wrf_install/WRFDAV4.4/var/obsproc/src&#x27;</span><br>( /bin/rm -f obsproc.exe ;   <span class="hljs-built_in">ln</span> -s src/obsproc.exe . )<br>make[1]: Leaving directory <span class="hljs-string">&#x27;/home/wpsze/WRF/WRFv440/wrf_install/WRFDAV4.4/var/obsproc&#x27;</span><br>build started:   Fri Aug 16 15:09:14 HKT 2024<br>build completed: Fri Aug 16 15:13:51 HKT 2024<br></code></pre></td></tr></table></figure><h2 id="successful">Successful</h2><p>Checking, completely successful there should be 44 exe files.</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-built_in">ls</span> -l var/build/*exe var/obsproc/src/obsproc.exe<br></code></pre></td></tr></table></figure><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs sh">da_advance_time.exe               gen_be_diags_read.exe<br>da_bias_airmass.exe               gen_be_ensmean.exe<br>da_bias_scan.exe                  gen_be_ensrf.exe<br>da_bias_sele.exe                  gen_be_ep1.exe<br>da_bias_verif.exe                 gen_be_ep2.exe<br>da_rad_diags.exe                  gen_be_etkf.exe<br>da_tune_obs_desroziers.exe        gen_be_hist.exe<br>da_tune_obs_hollingsworth1.exe    gen_be_stage0_gsi.exe<br>da_tune_obs_hollingsworth2.exe    gen_be_stage0_wrf.exe<br>da_update_bc_ad.exe               gen_be_stage1_1dvar.exe<br>da_update_bc.exe                  gen_be_stage1.exe<br>da_verif_grid.exe                 gen_be_stage1_gsi.exe<br>da_verif_obs.exe                  gen_be_stage2_1dvar.exe<br>da_wrfvar.exe                     gen_be_stage2a.exe<br>gen_be_addmean.exe                gen_be_stage2.exe<br>gen_be_cov2d3d_contrib.exe        gen_be_stage2_gsi.exe<br>gen_be_cov2d.exe                  gen_be_stage3.exe<br>gen_be_cov3d2d_contrib.exe        gen_be_stage4_global.exe<br>gen_be_cov3d3d_bin3d_contrib.exe  gen_be_stage4_regional.exe<br>gen_be_cov3d3d_contrib.exe        gen_be_vertloc.exe<br>gen_be_cov3d.exe                  gen_mbe_stage2.exe<br>gen_be_diags.exe<br></code></pre></td></tr></table></figure><p>and</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">/var/obsproc/src/obsproc.exe<br></code></pre></td></tr></table></figure><h2 id="error">Error</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">make[3]: time: No such file or directory make[3]: [makefile:42: module_io_int_idx.o] Error 127 (ignored)<br></code></pre></td></tr></table></figure><p>Solution: <a href="https://waipangsze.github.io/2024/05/29/WRF_install_time_error/">make -- time No such file or directory</a></p><h1 id="testcase">testcase</h1><ul><li><a href="https://forum.mmm.ucar.edu/threads/wrfda-4-5-with-wrf-3-9-testcase.13678/">wrfda 4.5 with wrf 3.9 testcase</a></li><li><a href="https://forum.mmm.ucar.edu/threads/error-the-input-file-appears-to-be-from-a-pre-v4-version-of-wrf-initialization-routines.5529/">ERROR: The input file appears to be from a pre-v4 version of WRF initialization routines</a></li><li><a href="https://www2.mmm.ucar.edu/wrf/users/wrfda/download/" class="uri">https://www2.mmm.ucar.edu/wrf/users/wrfda/download/</a></li></ul><blockquote><p>but in this link i don't have a 4.0 testdata and the last testdata that I have is for 3.9 So I've downloaded 3.9 testdata... As expected, it complained about old 3.9 data, so I had to include &gt; force_use_old_data=True</p></blockquote><h1 id="online-tutorial">Online Tutorial</h1><ul><li><a href="https://www2.mmm.ucar.edu/wrf/users/wrfda/OnlineTutorial/index.html">the WRFDA Online Tutorial!</a></li><li><a href="https://www2.mmm.ucar.edu/wrf/users/wrfda/OnlineTutorial/3dvar/index.html">3DVAR: The basics</a></li></ul><h1 id="references">References</h1><ul><li><a href="https://2018syocean.readthedocs.io/zh-cn/feature-delivery/hybrid/hybrid.html">2018沈阳海洋工程项目-WRFDA-混合数据同化技术/快速更新同化预报系统</a></li><li></li></ul>]]></content>
    
    
    <categories>
      
      <category>WRF</category>
      
    </categories>
    
    
    <tags>
      
      <tag>NWP</tag>
      
      <tag>gnu</tag>
      
      <tag>WRF</tag>
      
      <tag>Installation</tag>
      
      <tag>MPAS</tag>
      
      <tag>DA</tag>
      
      <tag>WRFDA</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ERA5 CDS upgrade (2024 Sep)</title>
    <link href="/2024/08/16/ERA5-2024-upgrade/"/>
    <url>/2024/08/16/ERA5-2024-upgrade/</url>
    
    <content type="html"><![CDATA[<h1 id="climate-data-store-cds">Climate Data Store (CDS)</h1><p>Some time ago, an upgrade notice was officially released on the Copernicus Climate Change Service (C3S) website. <strong>The old interface was closed in September 2024</strong>. Currently, the download of ERA5 data is gradually upgraded from the old CDS interface system to the new CDS-Beta.</p><p><a href="https://cds.climate.copernicus.eu/">Climate Data Store</a></p><p>The Copernicus Climate Change Service (C3S) supports society by providing authoritative information about the past, present and future climate in Europe and the rest of the World.</p><ul><li><strong>15 May 2024</strong> BETA version of the new <a href="https://ewds.climate.copernicus.eu/">CEMS Early Warning Data Store (EWDS)</a>. Your feedback is very useful for us. Please notice that access to the system might suffer some disruptions due to evolving updates.</li><li><strong>16 Jun 2024</strong> Check our <a href="https://confluence.ecmwf.int/x/uINmFw">informative page</a> to best prepare yourself to use CDS-Beta.</li><li><strong>16 Jun 2024</strong> CDS API syntax is changed and some keys or parameter names may have also changed. To avoid requests failing, please use the "Show API request code" tool on the dataset Download Form to check you are using the correct syntax for your API request.</li><li><strong>16 Jun 2024</strong> BETA version of the new CDS. Your feedback is very useful for us. Please notice that access to the system might suffer some disruptions due to evolving updates.</li><li><strong>18 Jul 2024</strong> Remember that you need to have an ECMWF account to use CDS-Beta. Your existing CDS credentials will not work in CDS-Beta!</li></ul><h2 id="registration-ecmwf-account">Registration ECMWF account</h2><p>registration address: <a href="https://www.ecmwf.int/" class="uri">https://www.ecmwf.int/</a> There is a <strong>Log in</strong> button in the upper right corner of the page, click on it directly!</p><h2 id="cds-beta-account-information-supplement-and-terms-upgrade">CDS-beta account information supplement and terms upgrade</h2><p>After successfully registering an ECMWF account, enter the page <a href="https://cds.climate.copernicus.eu/" class="uri">https://cds.climate.copernicus.eu/</a></p><p>We need to go to the upgraded CDS page to complete the information, including: - country, - affiliation, - thematic activities, - activities sectors, and</p><p>Then, <strong>three Accet Terms &amp; Conditions</strong>. It’s all relatively simple! Finally, click Activate your profile to complete. Automatically return to the CDS-beta data customization home page.</p><h2 id="upgrade-cdsapi-library-and-.cdsapirc-key">Upgrade cdsapi library and .cdsapirc key</h2><p><strong>Note:</strong> We need to ensure that we have logged in to the CDS-beta account in advance!</p><p>Goto</p><p><a href="https://cds.climate.copernicus.eu/how-to-api" class="uri">https://cds.climate.copernicus.eu/how-to-api</a></p><h2 id="setup-the-cds-api-personal-access-token">Setup the CDS API personal access token</h2><p>Here is how to setup the CDS API personal access token:</p><p>If you do not have an account yet, please register. If you are not logged in, please login. Once logged in, copy the code displayed below to the file - <strong>$HOME/.cdsapirc</strong> (in your Unix/Linux environment):</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh">url: https://cds.climate.copernicus.eu/api<br>key: xxxxxx-xxxxx-xxxxx-xxxx-xxxx<br></code></pre></td></tr></table></figure><h2 id="install-the-cds-api-client">Install the CDS API client</h2><p>The CDS API client is a Python based library. It provides support for Python 3.</p><p>You can Install the CDS API client via the package management system pip, by running on Unix/Linux the command below.</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">$ conda install <span class="hljs-string">&#x27;cdsapi&gt;=0.7.0&#x27;</span> <span class="hljs-comment"># updated in future</span><br></code></pre></td></tr></table></figure><p>and, (typing-extensions 4.9.0)</p><p>Version 0.7.0 or higher is required in order to be able to use the new data stores.</p><h2 id="use-the-cds-api-client-for-data-access">Use the CDS API client for data access</h2><p>Once the CDS API client is installed, it can be used to request data from the datasets listed in the CDS, ADS, ECDS and CEMS Early Warning DS catalogues.</p><p>One must agree to the Terms of Use of a dataset before downloading any data out of it. This step must be done manually from the dataset page (at the bottom of the download form).</p><p>At the bottom of each dataset download form, press the "Show API request code" button to display a Python code snippet that can be used to run the manually built request. The API call must have this syntax:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> cdsapi<br><br>client = cdsapi.Client()<br><br>dataset = <span class="hljs-string">&quot;&lt;DATASET-SHORT-NAME&gt;&quot;</span><br>request = &#123;<br>    &lt;SELECTION-REQUEST&gt;<br>&#125;<br>target = <span class="hljs-string">&quot;&lt;TARGET-FILE&gt;&quot;</span><br><br>client.retrieve(dataset, request, target)<br></code></pre></td></tr></table></figure><p>Example:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> cdsapi<br><br>client = cdsapi.Client()<br><br>dataset = <span class="hljs-string">&#x27;reanalysis-era5-pressure-levels&#x27;</span><br>request = &#123;<br>    <span class="hljs-string">&#x27;product_type&#x27;</span>: [<span class="hljs-string">&#x27;reanalysis&#x27;</span>],<br>    <span class="hljs-string">&#x27;variable&#x27;</span>: [<span class="hljs-string">&#x27;geopotential&#x27;</span>],<br>    <span class="hljs-string">&#x27;year&#x27;</span>: [<span class="hljs-string">&#x27;2024&#x27;</span>],<br>    <span class="hljs-string">&#x27;month&#x27;</span>: [<span class="hljs-string">&#x27;03&#x27;</span>],<br>    <span class="hljs-string">&#x27;day&#x27;</span>: [<span class="hljs-string">&#x27;01&#x27;</span>],<br>    <span class="hljs-string">&#x27;time&#x27;</span>: [<span class="hljs-string">&#x27;13:00&#x27;</span>],<br>    <span class="hljs-string">&#x27;pressure_level&#x27;</span>: [<span class="hljs-string">&#x27;1000&#x27;</span>],<br>    <span class="hljs-string">&#x27;data_format&#x27;</span>: <span class="hljs-string">&#x27;grib&#x27;</span>,<br>&#125;<br>target = <span class="hljs-string">&#x27;download.grib&#x27;</span><br><br>client.retrieve(dataset, request, target)<br></code></pre></td></tr></table></figure><h1 id="issues">Issues</h1><h2 id="section"></h2><p>Recovering from connection error [HTTPSConnectionPool(host='cds.climate.copernicus.eu', port=443): Max retries exceeded with url: /api/retrieve/v1/processes/reanalysis-era5-pressure-levels/execute</p><ul><li>ValueError: Result not ready, job is accepted</li></ul><p>and,</p><ul><li><a href="https://forum.ecmwf.int/t/goodbye-legacy-climate-data-store-hello-new-climate-data-store-cds/6380/14" class="uri">https://forum.ecmwf.int/t/goodbye-legacy-climate-data-store-hello-new-climate-data-store-cds/6380/14</a></li></ul><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs text">Anabelle<br>ECMWF Staff<br>Please be aware that as initially published in this topic, the cds-beta URL was planned to be discontinued and users were advised to update the URL in their .cdsapirc file by 20th October 2024.<br><br>We can confirm that the cds-beta URL is now discontinued. And this explains why some users are getting some SSL: CERTIFICATE_VERIFY_FAILED errors.<br><br>If you have not already done so, please update the URL in your .cdsapirc file as shown below:<br><br>url: https://cds.climate.copernicus.eu/api<br>key: xx-xx-xx-xx-xx<br><br>Alternatively, login [here](https://cds.climate.copernicus.eu/how-to-api) to check URL to use in .cdsapirc file.<br><br>Thank you<br><br>ECMWF Support<br>on behalf of the Data Stores team<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>NWP</category>
      
    </categories>
    
    
    <tags>
      
      <tag>WRF</tag>
      
      <tag>WPS</tag>
      
      <tag>MPAS</tag>
      
      <tag>IC/BC</tag>
      
      <tag>ERA5</tag>
      
      <tag>ECMWF</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Spack and Intel OneAPI</title>
    <link href="/2024/08/13/spack_intel/"/>
    <url>/2024/08/13/spack_intel/</url>
    
    <content type="html"><![CDATA[<h1 id="spack">Spack</h1><p>Spack is a package management tool designed to support multiple versions and configurations of software on a wide variety of platforms and environments. It was designed for large supercomputing centers, where many users and application teams share common installations of software on clusters with exotic architectures, using libraries that do not have a standard ABI. Spack is non-destructive: installing a new version does not break existing installations, so many configurations can coexist on the same system. Most importantly, Spack is simple. It offers a simple spec syntax so that users can specify versions and configuration options concisely. Spack is also simple for package authors: package files are written in pure Python, and specs allow package authors to maintain a single file for many different builds of the same package.</p><p><a href="https://spack.readthedocs.io/en/latest/" class="uri">https://spack.readthedocs.io/en/latest/</a></p><h2 id="search-packages-online">Search packages online</h2><blockquote><p><a href="https://packages.spack.io/" class="uri">https://packages.spack.io/</a></p></blockquote><h1 id="installation">Installation</h1><p>Getting Spack is easy. You can clone it from the github repository using this command:</p><p>git clone -c feature.manyFiles=true https://github.com/spack/spack.git {:.info}</p><p>This will create a directory called spack.</p><p>Once you have cloned Spack, we recommend sourcing the appropriate script for your shell:</p><p>. spack/share/spack/setup-env.sh {:.info}</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs sh">For bash/zsh/sh<br>. spack/share/spack/setup-env.sh<br>(add into .bashrc)<br>For tcsh/csh<br><span class="hljs-built_in">source</span> spack/share/spack/setup-env.csh<br></code></pre></td></tr></table></figure><h1 id="intel">Intel</h1><p>IntelOneapi, https://spack.readthedocs.io/en/latest/build_systems/inteloneapipackage.html</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs sh">$ spack <span class="hljs-built_in">env</span> create intel_oneapi <br>$ spack <span class="hljs-built_in">env</span> activate intel_oneapi<br>$ spack info --all intel-oneapi-mpi<br>$ spack info --all intel-oneapi-compilers<br></code></pre></td></tr></table></figure><p>try: module load intel-oneapi-mpi/2021.4.0 module load intel-oneapi-compilers/2021.4.0 <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs sh">$ spack install --add intel-oneapi-compilers@2021.4.0<br><span class="hljs-comment"># Add the compilers to your compilers.yaml so spack can use them:</span><br>$ spack compiler add `spack location -i intel-oneapi-compilers@2021.4.0`/compiler/latest/linux/bin/intel64<br>$ spack compiler add `spack location -i intel-oneapi-compilers@2021.4.0`/compiler/latest/linux/bin<br><span class="hljs-comment"># Verify that the compilers are available:</span><br>$ spack compiler list or spack location -i intel-oneapi-compilers@2021.4.0<br></code></pre></td></tr></table></figure></p><p>Check,</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-built_in">which</span> mpiicc &amp;&amp; mpiicc --version<br><span class="hljs-built_in">which</span> mpiifort &amp;&amp; mpiifort --version<br><span class="hljs-built_in">which</span> mpiicpc &amp;&amp; mpiicpc --version<br><span class="hljs-built_in">which</span> icc &amp;&amp; icc --version<br><span class="hljs-built_in">which</span> ifort &amp;&amp; ifort --version<br></code></pre></td></tr></table></figure><p>one more step, install curl</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh">$ spack info --all curl<br>$ spack install --add curl%intel<br></code></pre></td></tr></table></figure><h1 id="remark">Remark</h1><h2 id="spack-info---all-intel-oneapi-mpi">spack info --all intel-oneapi-mpi</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><code class="hljs sh">$ spack info --all intel-oneapi-mpi<br><br>Package:   intel-oneapi-mpi<br><br>Description:<br>    Intel MPI Library is a multifabric message-passing library that<br>    implements the open-source MPICH specification. Use the library to<br>    create, maintain, and <span class="hljs-built_in">test</span> advanced, complex applications that perform<br>    better on high-performance computing (HPC) clusters based on Intel<br>    processors. LICENSE INFORMATION: By downloading and using this software,<br>    you agree to the terms and conditions of the software license agreements<br>    at https://intel.ly/393CijO.<br><br>Homepage: https://software.intel.com/content/www/us/en/develop/tools/oneapi/components/mpi-library.html<br><br>Maintainers: @rscohn2<br><br>Externally Detectable: <br>    False<br><br>Tags: <br>    None<br><br>Preferred version:  <br>    2021.13.1    https://registrationcenter-download.intel.com/akdlm/IRC_NAS/364c798c-4cad-4c01-82b5-e1edd1b476af/l_mpi_oneapi_p_2021.13.1.769_offline.sh<br><br>Safe versions:  <br>    2021.13.1    https://registrationcenter-download.intel.com/akdlm/IRC_NAS/364c798c-4cad-4c01-82b5-e1edd1b476af/l_mpi_oneapi_p_2021.13.1.769_offline.sh<br>    2021.13.0    https://registrationcenter-download.intel.com/akdlm/IRC_NAS/9f84e1e8-11b2-4bd1-8512-3e3343585956/l_mpi_oneapi_p_2021.13.0.719_offline.sh<br>    2021.12.1    https://registrationcenter-download.intel.com/akdlm/IRC_NAS/56b2dd0e-954d-4330-b0a7-b22992f7e6b7/l_mpi_oneapi_p_2021.12.1.8_offline.sh<br>    2021.12.0    https://registrationcenter-download.intel.com/akdlm/IRC_NAS/749f02a5-acb8-4bbb-91db-501ff80d3f56/l_mpi_oneapi_p_2021.12.0.538_offline.sh<br>    2021.11.0    https://registrationcenter-download.intel.com/akdlm//IRC_NAS/2c45ede0-623c-4c8e-9e09-bed27d70fa33/l_mpi_oneapi_p_2021.11.0.49513_offline.sh<br>    2021.10.0    https://registrationcenter-download.intel.com/akdlm/IRC_NAS/4f5871da-0533-4f62-b563-905edfb2e9b7/l_mpi_oneapi_p_2021.10.0.49374_offline.sh<br>    2021.9.0     https://registrationcenter-download.intel.com/akdlm/IRC_NAS/718d6f8f-2546-4b36-b97b-bc58d5482ebf/l_mpi_oneapi_p_2021.9.0.43482_offline.sh<br>    2021.8.0     https://registrationcenter-download.intel.com/akdlm/IRC_NAS/19131/l_mpi_oneapi_p_2021.8.0.25329_offline.sh<br>    2021.7.1     https://registrationcenter-download.intel.com/akdlm/IRC_NAS/19010/l_mpi_oneapi_p_2021.7.1.16815_offline.sh<br>    2021.7.0     https://registrationcenter-download.intel.com/akdlm/IRC_NAS/18926/l_mpi_oneapi_p_2021.7.0.8711_offline.sh<br>    2021.6.0     https://registrationcenter-download.intel.com/akdlm/IRC_NAS/18714/l_mpi_oneapi_p_2021.6.0.602_offline.sh<br>    2021.5.1     https://registrationcenter-download.intel.com/akdlm/IRC_NAS/18471/l_mpi_oneapi_p_2021.5.1.515_offline.sh<br>    2021.5.0     https://registrationcenter-download.intel.com/akdlm/IRC_NAS/18370/l_mpi_oneapi_p_2021.5.0.495_offline.sh<br>    2021.4.0     https://registrationcenter-download.intel.com/akdlm/IRC_NAS/18186/l_mpi_oneapi_p_2021.4.0.441_offline.sh<br>    2021.3.0     https://registrationcenter-download.intel.com/akdlm/IRC_NAS/17947/l_mpi_oneapi_p_2021.3.0.294_offline.sh<br>    2021.2.0     https://registrationcenter-download.intel.com/akdlm/IRC_NAS/17729/l_mpi_oneapi_p_2021.2.0.215_offline.sh<br>    2021.1.1     https://registrationcenter-download.intel.com/akdlm/IRC_NAS/17397/l_mpi_oneapi_p_2021.1.1.76_offline.sh<br><br>Deprecated versions:  <br>    None<br><br>Variants:<br>    build_system [generic]            generic<br>        Build systems supported by the package<br>    classic-names [<span class="hljs-literal">false</span>]             <span class="hljs-literal">false</span>, <span class="hljs-literal">true</span><br>        Use classic compiler names, e.g mpiicc instead of mpiicx<br>    envmods [<span class="hljs-literal">true</span>]                    <span class="hljs-literal">false</span>, <span class="hljs-literal">true</span><br>        Toggles environment modifications<br>    external-libfabric [<span class="hljs-literal">false</span>]        <span class="hljs-literal">false</span>, <span class="hljs-literal">true</span><br>        Enable external libfabric dependency<br>    generic-names [<span class="hljs-literal">false</span>]             <span class="hljs-literal">false</span>, <span class="hljs-literal">true</span><br>        Use generic names, e.g mpicc instead of mpiicx<br>    ilp64 [<span class="hljs-literal">false</span>]                     <span class="hljs-literal">false</span>, <span class="hljs-literal">true</span><br>        Build with ILP64 support<br><br>Installation Phases:<br>    install<br><br>Build Dependencies:<br>    None<br><br>Link Dependencies:<br>    libfabric<br><br>Run Dependencies:<br>    libfabric<br><br>Virtual Packages: <br>    intel-oneapi-mpi provides mpi@:3.1<br><br>Available Build Phase Test Methods:<br>    None<br><br>Available Install Phase Test Methods:<br>    None<br><br>Stand-Alone/Smoke Test Methods:<br>    Mpi.test_mpi_hello<br><br>Licenses: <br>    https://intel.ly/393CijO<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>Spack</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Spack</tag>
      
      <tag>Intel</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Intel Instruction Set Extensions Technology 指令集擴充技術</title>
    <link href="/2024/08/07/Intel_Instruction_Set_Extensions_Technology/"/>
    <url>/2024/08/07/Intel_Instruction_Set_Extensions_Technology/</url>
    
    <content type="html"><![CDATA[<h1 id="intel-instruction-set-extensions-technology">Intel Instruction Set Extensions Technology</h1><p><a href="https://www.intel.com.tw/content/www/tw/zh/support/articles/000005779/processors.html">Intel® Instruction Set Extensions (指令集擴充技術)</a> are additional instructions that <strong>can increase performance</strong> when the same operations are performed on multiple data objects.</p><p>Instruction Set Extensions are additional instructions which can increase performance when the same operations are performed on multiple data objects. These can include <strong>SSE (Streaming SIMD Extensions) and AVX (Advanced Vector Extensions).</strong></p><p>Detailed instructions are listed in Intel® Architecture Instruction Set Extensions Programming Reference.</p><p>Instruction Set Extensions can include: - Single Instruction Multiple Data (SIMD) - Intel® Streaming SIMD Extensions (Intel® SSE,Intel® SSE2,Intel® SSE3, and Intel® SSE4) - Intel® Advanced Vector Extensions (Intel® AVX, Intel® AVX2, and Intel® AVX-512)</p><h2 id="identify-my-intel-processor">Identify My Intel Processor</h2><p>Linux Type the following command: <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh">$ lscpu | grep <span class="hljs-string">&quot;Model name&quot;</span><br>Model name:                           Intel(R) Core(TM) i5-3470S CPU @ 2.90GHz<br></code></pre></td></tr></table></figure></p><h2 id="product-specifications">Product Specifications</h2><ul><li>Go to https://ark.intel.com/content/www/us/en/ark.html#<span class="citation" data-cites="Processors">@Processors</span></li><li>enter your CPU name<ul><li>like https://ark.intel.com/content/www/us/en/ark/products/68315/intel-core-i5-3470s-processor-6m-cache-up-to-3-60-ghz.html</li><li>It has shown <strong>Instruction Set Extensions = Intel® SSE4.1, Intel® SSE4.2, Intel® AVX</strong></li></ul></li></ul><h2 id="streaming-simd-extensions-sse">Streaming SIMD Extensions (SSE)</h2><p>SSE is a process or technology that enables single instruction multiple data. Older processors only process a single data element per instruction. SSE enables the instruction to handle multiple data elements. It's used in intensive applications, such as 3D graphics, for faster processing. SSE is designed to replace MMX™ Technology. It expanded over the generations of Intel® Processors to include SSE2, SSE3/SSE3S, and SSE4. Each iteration has brought new instructions and increased performance.</p><h2 id="intel-advanced-vector-extensions-intel-avx-and-avx2">Intel Advanced Vector Extensions (Intel® AVX and AVX2)</h2><p><strong>Intel® AVX is a 256-bit instruction set extension to Intel® SSE</strong> designed for applications that are Floating Point (FP) intensive. Intel AVX improves performance due to wider vectors, new extensible syntax, and rich functionality. <strong><em>Intel AVX2 was released in 2013</em></strong>, extending vector processing capability across floating-point and integer data domains. This results in higher performance and more efficient data management across a wide range of applications. Examples are image and audio/video processing, scientific simulations, financial analytics, and 3D modeling and analysis.</p><h2 id="intel-advanced-vector-extensions-512-intel-avx-512">Intel® Advanced Vector Extensions 512 (Intel® AVX-512)</h2><p>The Intel® AVX-512 enables processing of twice the number of data elements that Intel AVX/AVX2 can process with a single instruction and four times the capabilities of Intel SSE. Intel AVX-512 instructions are important because they open up higher performance capabilities for the most demanding computational tasks. Intel AVX-512 instructions offer the highest degree of compiler support in the design of the instruction capabilities.</p><h2 id="spec-flag-description-for-the-gnu-ccfortran-compiler">SPEC Flag Description for the GNU C/C++/Fortran Compiler</h2><p>Go to https://www.spec.org/omp2012/flags/gcc-linux64.html</p><p>Optimization Flags - -Ofast - -fopenmp - -fopenmp-simd - -m64 - -mavx512f - -mavx512cd - -mavx512er - -mavx512pf - -march=ivybridge - -march=native</p>]]></content>
    
    
    <categories>
      
      <category>Intel</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Intel</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>JupyterLab</title>
    <link href="/2024/07/31/JupyterLab/"/>
    <url>/2024/07/31/JupyterLab/</url>
    
    <content type="html"><![CDATA[<h1 id="jupyterlab">JupyterLab</h1><p>JupyterLab is the latest web-based interactive development environment for notebooks, code, and data. Its flexible interface allows users to configure and arrange workflows in data science, scientific computing, computational journalism, and machine learning. A modular design invites extensions to expand and enrich functionality.</p><h2 id="install">Install</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs sh">micromamba activate venv <br>micromamba install python=3.11<br>micromamba install -c conda-forge jupyterlab<br>micromamba install anaconda::ipykernel<br>micromamba install nodejs<br>micromamba install -c conda-forge jupyter-resource-usage<br>micromamba install -c conda-forge jupyterlab_execute_time<br></code></pre></td></tr></table></figure><h2 id="execute">Execute</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">$ jupyter-lab<br></code></pre></td></tr></table></figure><h2 id="added-other-kernels-to-jupyter">Added other kernels to Jupyter</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs sh"><br>micromamba activate new-env-1<br><br><span class="hljs-comment"># install python kernel for Jupyter</span><br><span class="hljs-comment"># avoid installation of any jupyter related modules</span><br>micromamba install anaconda::ipykernel<br><br><span class="hljs-comment"># added the kernel to Jupyter and name it as &quot;Environment(myproject)&quot;</span><br>python -m ipykernel install --user --name=mnew-env-1 --display-name=<span class="hljs-string">&#x27;Environment(new-env-1)&#x27;</span><br><br>micromamba deactivate<br><br>micromamba acitvate new-env-2<br><br><span class="hljs-comment"># install python kernel for Jupyter</span><br><span class="hljs-comment"># avoid installation of any jupyter related modules</span><br>micromamba install anaconda::ipykernel<br><br><span class="hljs-comment"># added the kernel to Jupyter and name it as &quot;Environment(myproject)&quot;</span><br>python -m ipykernel install --user --name=mnew-env-2 --display-name=<span class="hljs-string">&#x27;Environment(new-env-2)&#x27;</span><br></code></pre></td></tr></table></figure><h1 id="to-access-the-remote-machine-with-a-browser">To access the remote machine with a browser</h1><p>To access the remote machine with a browser the notebook must listen on an external facing port <strong>(not localhost)</strong>. You will need the same invocation if want to run the Jupyter notebook on a container. In that case it is something like this:</p><figure class="highlight console"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs console">jupyter-notebook --no-browser --port 11013 --ip=0.0.0.0<br></code></pre></td></tr></table></figure><p>To listen <strong>only in localhost</strong> then you can omit the IP</p><figure class="highlight console"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs console">jupyter notebook --no-browser --port=8080<br></code></pre></td></tr></table></figure><h1 id="monitor-resource-usage-with-gpu-dashboard-in-jupyter">Monitor resource usage with GPU Dashboard in Jupyter</h1><p>A GPU dashboard is available for JupyterLab for showing the resource usage of GPU in real time, side by side with cells in your notebook. It is particularly useful in identifying any bottleneck or issues during code development.</p><p>You may activate your conda or python virtual environment for your kernel and run the following once to install the GPU dashboard.</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">pip install jupyterlab-nvdashboard<br></code></pre></td></tr></table></figure><h1 id="references">References</h1><ul><li><a href="https://hpc.hku.hk/hpc/software/jupyterlab/">HKU HPC</a></li><li><a href="https://github.com/jupyter-server/jupyter-resource-usage">jupyter-resource-usage</a></li><li><a href="https://jupyterlab-contrib.github.io/extensions.html">List of extensions and tools</a></li><li><a href="https://github.com/altair-viz/jupyterlab_voyager">Voyager is a JupyterLab MIME renderer extension to view CSV and JSON data in Voyager 2</a></li><li><a href="https://github.com/jupyterlab/debugger">jupyterlab/debugger</a></li><li><a href="https://jupyterlab.readthedocs.io/en/stable/user/extensions.html#id9">JupyterLab extension</a></li></ul>]]></content>
    
    
    <categories>
      
      <category>Jupyter</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Jupyter</tag>
      
      <tag>python</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ssh tunnel</title>
    <link href="/2024/07/04/ssh_tunnel/"/>
    <url>/2024/07/04/ssh_tunnel/</url>
    
    <content type="html"><![CDATA[<h1 id="introduction-to-ssh-tunnels">Introduction to SSH Tunnels</h1><p>Secure Shell, or SSH, is used to create a secure channel between a local and remote computer. While SSH is commonly used for secure terminal access and file transfers, it can also be used to create a secure tunnel between computers for forwarding other network connections that are not normally encrypted. SSH tunnels are also useful for allowing outside access to internal network resources.</p><p>An <strong>SSH tunneling (SSH Port Forwarding)</strong> establishes a connection between your local machine and the remote machine via a TCP port. When you configure your local application to use an SSH tunnel you tell it to connect to your local machine at a specified port, rather than the remote machine. The tunnel then carries your traffic securely to the remote machine.</p><p>SSH Port Forwarding： - Local Port Forwarding - Remote Port Forwarding - Dynamic Port Forwarding</p><p>For both local and remote port forwarding, there are three roles:</p><ul><li>Client<ul><li>Any machine from which you can type ssh to start Port Forwarding</li></ul></li><li>SSH server<ul><li>Clients can use SSH connections for machine learning</li></ul></li><li>target server<ul><li>Some machines you want to establish a connection to, usually to open services on this machine to the outside world</li></ul></li></ul><p><strong>Note that</strong> both the client and the SSH server can themselves be the target server. It does not mean that only three machines can be used for port forwarding!</p><p><img src="https://img1.xenby.com/269/89b59f7b.png" width="500" /></p><h2 id="常用的-ssh-指令參數">常用的 SSH 指令參數</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">sh -N -L 0.0.0.0:local-port:target-server:target-port username@proxy-server<br></code></pre></td></tr></table></figure><ul><li><code>-L</code><ul><li><strong>建立 Local forwarding</strong></li></ul></li><li><code>-N</code><ul><li><strong>不要執行任何遠端指令</strong>。沒有加這個參數時，建立 Port Forwarding 的同時也會開啟 Remote Shell，讓你可以對 SSH Server 下指令，而這個參數可以讓 Remote Shell 不要打開。</li></ul></li><li><code>-f</code><ul><li><strong>讓 ssh 指令在背景執行</strong>，讓你可以繼續用 Shell 做事情。通常會搭上面的 -N 使用。</li></ul></li><li><code>lsof -i -n | egrep '\&lt;ssh\&gt;'</code><ul><li>列出目前有的 SSH tunnel</li></ul></li></ul><h2 id="local-port-forwarding">Local Port Forwarding</h2><p>Local forwarding is used to forward a port from the client machine to the server machine.</p><p>Quite a few organizations for all incoming SSH access through a single <strong>jump server</strong>. The server may be a standard Linux/Unix box, usually with some extra hardening, intrusion detection, and/or logging, or it may be a commercial jump server solution.</p><p>To create a local port forward add the <strong>-L</strong> parameter to the ssh command line.</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">$ ssh -L 9090:localhost:8080 user@server-ip<br></code></pre></td></tr></table></figure><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">$ ssh -L 9090:192.168.1.101:8080 user@server-ip<br></code></pre></td></tr></table></figure><p>The 192.168.1.101 (like Target server) here is relative to user@server-ip, so it is the IP address of the server behind the firewall or VPN. Then, you can visit 192.168.1.101:9090</p><h3 id="client----ssh-server----target-server">Client -- SSH server -- Target server</h3><ul><li>Client<ul><li>你的電腦</li></ul></li><li>SSH Server<ul><li>防火牆後你的機器</li><li>SSH Destination： user@server-ip</li></ul></li><li>Target Server<ul><li>防火牆後的伺服器</li><li>192.168.1.101:8080</li></ul></li></ul><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">ssh -L 9090:192.168.1.101:8080 user@server-ip<br></code></pre></td></tr></table></figure><h3 id="bind_address">bind_address</h3><p>如果你沒有給 bind_address ，預設會 Bind 在 localhost 上。如果你想把 Port 9090 開放給所有人用：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">$ ssh -L 0.0.0.0:9090:localhost:8080 user@server-ip<br></code></pre></td></tr></table></figure><h2 id="remote-port-forwarding">Remote Port Forwarding</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">ssh -R 9090:localhost:8080 user@server-ip<br></code></pre></td></tr></table></figure><h1 id="references">References</h1><p><a href="https://www.ssh.com/academy/iam/jump-server">What is a Jump Server?</a><br /><a href="https://johnliu55.tw/ssh-tunnel.html">SSH Tunneling (Port Forwarding) 詳解</a></p>]]></content>
    
    
    <categories>
      
      <category>Linux</category>
      
    </categories>
    
    
    <tags>
      
      <tag>ssh</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ML | Physics-informed neural networks (PINN)</title>
    <link href="/2024/06/26/PINN/"/>
    <url>/2024/06/26/PINN/</url>
    
    <content type="html"><![CDATA[<h1 id="pinn">PINN</h1><p>Physics-informed neural networks (PINNs) represent a significant advancement in the integration of machine learning with physical laws, particularly in the context of solving differential equations. They combine traditional neural network approaches with the constraints provided by known physics, enabling more accurate modeling and predictions in various scientific fields.</p><figure><img src="https://www.researchgate.net/profile/Zhen-Li-105/publication/335990167/figure/fig1/AS:806502679982080@1569296631121/Schematic-of-a-physics-informed-neural-network-PINN-where-the-loss-function-of-PINN_W640.jpg" alt="PINN (source: http://dx.doi.org/10.48550/arXiv.1909.10145)" width="400" /><figcaption>PINN (source: http://dx.doi.org/10.48550/arXiv.1909.10145)</figcaption></figure><h1 id="universal-approximation-theorem">Universal Approximation Theorem</h1><p><strong>Definition</strong></p><p>The theorem states that for <strong>any continuous function</strong> $ f: ^n  $ defined on a compact subset of $ ^n $, there exists a neural network $ g $ such that the difference between $ f $ and $ g $ can be made arbitrarily small. Formally, for any $ &gt; 0 $, there exists a neural network with a finite number of neurons such that:</p><p><span class="math display">\[| f(x) - g(x) | &lt; \epsilon\]</span></p><p>for all $ x $ in the domain of interest.</p><p><strong>Historical Background</strong></p><p>The theorem was independently proven by George Cybenko in 1989, who focused on networks using sigmoid activation functions, and later by Kurt Hornik in 1991, who generalized it to include other activation functions like ReLU (Rectified Linear Unit).</p><p><strong>Implications</strong></p><p>It has profound implications for the design and understanding of neural networks:</p><ul><li><strong>Expressive Power</strong>: It guarantees that neural networks can model complex relationships in data, making them suitable for tasks like image classification, function approximation, and more.</li><li><strong>Architecture Design</strong>: The theorem informs users about the necessary architecture (e.g., number of layers and neurons) required to achieve desired approximations.</li></ul><p><strong>Limitations</strong></p><p>While the UAT provides a theoretical foundation, it does not address practical aspects such as:</p><ul><li><strong>Generalization</strong>: The ability of a network to perform well on unseen data is not guaranteed by the theorem alone. Techniques like regularization and cross-validation are necessary to improve generalization.</li><li><strong>Computational Feasibility</strong>: The theorem does not specify how to construct the network or find the optimal parameters effectively. In practice, training methods like backpropagation are used, but they may not always reach the global optimum.</li></ul><p><strong>Reading</strong></p><ul><li><a href="https://www.deep-mind.org/2023/03/26/the-universal-approximation-theorem/">The Universal Approximation Theorem</a></li><li><a href="https://mitliagkas.github.io/ift6085-2020/ift-6085-lecture-10-notes.pdf">Expressivity and Universal Approximation Theorems Part 1</a></li></ul><h2 id="for-function-alone">For function alone,</h2><ul><li><a href="https://citeseerx.ist.psu.edu/document?repid=rep1&amp;type=pdf&amp;doi=42b931a30e5b8e7de7fca061d4f445ca252ac23a">Chen, T., &amp; Chen, H. (1993). Approximations of continuous functionals by neural networks with application to dynamic systems. IEEE Transactions on Neural networks, 4(6), 910-918.</a></li></ul><p>Theorem 2: Suppose that <span class="math inline">\(U\)</span> is a compact set in <span class="math inline">\(C[a,b]\)</span>, <span class="math inline">\(f\)</span> is a continuous functional defined on <span class="math inline">\(U\)</span>, and <span class="math inline">\(\sigma (x)\)</span> is a bounded generalized sigmoidal function, then for any <span class="math inline">\(\epsilon &gt; 0\)</span>, there exist <span class="math inline">\(m+1\)</span> points $ a = x_0 &lt;...&lt; x_m = b$, a positive integer <span class="math inline">\(N\)</span> and constants <span class="math inline">\(c_{ij}, \theta_{ij}, \xi_{ij}\)</span>, <span class="math inline">\(i=1,...,N\)</span>, <span class="math inline">\(j=0,1,...,m\)</span>, such that</p><p><span class="math display">\[\begin{align*} | f(u) - \sum_{i=1}^N c_i g ( \sum_{j=0}^m \xi_{ij} u(x_{j}) + \theta_i) | &amp;&lt; \epsilon, \qquad \forall u \in U \\| f(u) - \sum_{i=1}^N c_i g (\mathbf{\omega_j} \cdot \mathbf{x} + \theta_i) | &amp;&lt; \epsilon, \qquad \forall u \in U\end{align*} \]</span></p><h1 id="definition-and-functionality">Definition and Functionality</h1><p>PINNs are a type of <strong>universal function approximator</strong> that incorporates physical laws directly into the training process of neural networks. This is achieved by embedding governing equations, typically expressed as partial differential equations (PDEs), into the loss function of the network. By doing so, PINNs ensure that the solutions generated are consistent with these physical laws, which enhances the robustness and accuracy of the model even when data availability is limited</p><p><strong>Training Mechanism</strong></p><p>The training of a PINN involves two main components:</p><ol type="1"><li><strong>Data Loss</strong>: The standard supervised learning approach minimizes the mean squared error (MSE) between <strong>predicted outputs and actual data</strong>.</li><li><strong>Physics Loss</strong>: An additional term is introduced to the loss function that quantifies <strong>how well the predicted outputs satisfy the governing physical equations</strong>. This is done by computing gradients (<strong>using automatic differentiation</strong>) at sampled points in space and time, allowing for the evaluation of residuals from the PDEs.</li></ol><p>This dual approach allows PINNs to <strong>leverage both empirical data and theoretical knowledge</strong>, making them particularly effective for problems where data is scarce or noisy.</p><h2 id="challenges-and-future-directions">Challenges and Future Directions</h2><p>Despite their advantages, PINNs also face challenges:</p><ul><li><strong>Computational Cost</strong>: Training PINNs can be computationally intensive, especially when dealing with <strong>complex geometries</strong> or <strong>high-dimensional problems</strong>.</li><li><strong>Generalization Limitations</strong>: Regular PINNs typically require <strong>retraining for different geometries or boundary conditions</strong>, which can limit their efficiency in practical applications.</li></ul><h1 id="pinn-1">PINN</h1><h2 id="key-points-on-using-collocation-points-in-pinns">Key Points on Using Collocation Points in PINNs</h2><figure><img src="https://www.researchgate.net/publication/354493654/figure/fig2/AS:1066347421261825@1631248445040/Distributions-of-collocation-points-t-f-x-f-for-the-evaluation-of-governing.png" alt="Distributions of collocation points (t f , x f ) for the evaluation of governing equations (a) logarithmically sampled time points, and (b) uniformly sampled time points. The data sets (t o , x o ) and (t b , x b ) are also plotted." width="550" /><figcaption>Distributions of collocation points (t f , x f ) for the evaluation of governing equations (a) logarithmically sampled time points, and (b) uniformly sampled time points. The data sets (t o , x o ) and (t b , x b ) are also plotted.</figcaption></figure><p>It is possible to use collocation points only in Physics-Informed Neural Networks (PINNs). Collocation points are specific locations in the domain where the residuals of the governing equations are evaluated, and they play a crucial role in training PINNs.</p><div class="note note-primary">            <p>Neural networks can indeed be utilized to approximate functions with undetermined parameters, and <strong>one of their key advantages is the ability to compute various operators, including derivatives and partial derivatives, directly on these networks</strong>. This capability is particularly beneficial in applications like Physics-Informed Neural Networks (PINNs), where the derivatives of the network output with respect to inputs are essential for enforcing physical laws.</p><p>神經網路確實可以用來近似具有未確定參數的函數，其主要優點之一是能夠<strong>直接在這些神經網路上計算各種運算符，包括導數和偏導數</strong>。此功能在物理資訊神經網路 (PINN) 等應用中特別有用。</p>          </div><p><strong>1. Definition and Role</strong></p><p>Collocation points serve as the training dataset for PINNs, where the network learns to <strong>minimize the residuals of the partial differential equations (PDEs) at these discrete points</strong>. The objective is to ensure that the neural network's output satisfies the physical laws represented by these equations at the selected collocation points.</p><p><strong>2. Training with Collocation Points</strong></p><p>The training process involves minimizing a loss function that combines:</p><ul><li><strong>Data Loss</strong>: Measures how well the model fits any <strong>available observational data</strong>.</li><li><strong>Physics Loss</strong>: Enforces that the residuals of the PDEs at the <strong>collocation points</strong> are minimized.</li></ul><p>Using only collocation points can be effective, especially when there is limited observational data. However, it is essential to select these points wisely, as their distribution can significantly affect the accuracy and convergence of the solution. <strong>Strategies such as adaptive selection of collocation points</strong> based on residual analysis or problem-specific features can enhance performance.</p><p><strong>3. Limitations and Considerations</strong></p><p>While using collocation points alone is feasible, there are considerations:</p><ul><li><strong>Distribution of Points</strong>: A uniform distribution may not capture complex behaviors in certain regions of the domain effectively. <strong>Adaptive methods that focus on areas with higher residuals or complexity</strong> can improve training efficiency and solution accuracy.</li><li><strong>Generalization</strong>: Relying solely on collocation points may limit the model's ability to generalize across different scenarios or boundary conditions unless carefully managed.</li></ul><p>In summary, using only collocation points in PINNs is a valid approach, but careful consideration of their selection and distribution is crucial for achieving accurate and reliable results.</p><h2 id="strategies-for-selecting-collocation-points">Strategies for Selecting Collocation Points</h2><p><strong>1. Uniform Sampling</strong></p><ul><li><strong>Description</strong>: Initially, many PINNs utilize a uniform sampling strategy, distributing collocation points evenly across the domain.</li><li><strong>Limitations</strong>: This method may lead to inefficiencies, especially in complex problems where certain regions require more focus due to higher gradients or residuals.</li></ul><p><strong>2. Adaptive Sampling Techniques</strong></p><ul><li><strong>Dynamic Adjustment</strong>: Adaptive strategies adjust the locations of collocation points during training based on the residuals of the PDEs. This allows the network to concentrate on areas where the solution is more complex or where errors are larger.</li><li><strong>Examples</strong>:<ul><li><strong>PINNACLE Method</strong>: This method dynamically selects collocation and experimental points by analyzing training dynamics and adjusting point locations based on performance metrics. It improves accuracy and convergence speed by focusing on regions with significant residuals.</li><li><strong>Residual-Based Sampling</strong>: Points are selected based on the distribution of residuals, with higher densities in areas exhibiting larger errors. This method can involve <strong>resampling after a set number of iterations to avoid local minima</strong>.</li></ul></li></ul><p><strong>3. Weighting Collocation Points</strong></p><ul><li><strong>Variable Influence</strong>: Assign different weights to collocation points based on their importance, allowing the model to focus more on points with higher loss values. This approach helps prioritize learning in critical areas of the solution space.</li></ul><p><strong>4. Probability Density Functions (PDFs)</strong></p><ul><li><strong>Guided Distribution</strong>: Use information from residuals to create a probability density function that guides the distribution of collocation points. This can lead to a non-uniform distribution that better captures the essential features of the solution.</li></ul><p><strong>5. Hybrid Approaches</strong></p><ul><li>Combining fixed and adaptive methods can also be beneficial. For instance, starting with uniformly distributed points and then adapting their locations based on observed performance can provide a balanced approach.</li></ul><p>In conclusion, <strong>selecting collocation points in PINNs is an iterative process</strong> that can significantly impact the model's efficiency and accuracy. Adaptive methods that focus on error distribution and dynamic adjustments during training are particularly effective, as demonstrated by recent advancements like the PINNACLE method. These strategies allow for better representation of complex physical phenomena while optimizing computational resources.</p><h1 id="video">Video</h1><ul><li>Steve Brunton</li></ul><iframe width="560" height="315" src="https://www.youtube.com/embed/-zrY7P2dVC4?si=u64XUih1hSEUEv6o" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen></iframe><h1 id="physics">Physics</h1><ol type="1"><li>Baty, H. (2024). A hands-on introduction to Physics-Informed Neural Networks for solving partial differential equations with benchmark tests taken from astrophysics and plasma physics. arXiv preprint arXiv:2403.00599.<ol type="1"><li>(Left panel) Distribution of data sets showing the space localization of training data <strong>points at the four boundaries</strong> (i.e. <span class="math inline">\(N_{data} = 120\)</span>) and <strong>collocation points</strong> (i.e. <span class="math inline">\(N_c = 400\)</span>) inside the domain, for solving Laplace problem using vanilla-PINNs. (Right panel) Evolution of the two partial losses <span class="math inline">\(L_{data}\)</span> and $L_{PDE} $ as functions of the number of iterations (i.e. epochs).</li></ol></li></ol><div class="group-image-container"><div class="group-image-row"><div class="group-image-wrap"><img src="https://arxiv.org/html/2403.00599v1/extracted/5443010/figur6.png" /></div><div class="group-image-wrap"><img src="https://arxiv.org/html/2403.00599v1/extracted/5443010/figur6b.png" /></div></div><div class="group-image-row"><div class="group-image-wrap"><img src="https://arxiv.org/html/2403.00599v1/extracted/5443010/figur7.png" /></div></div><div class="group-image-row"><div class="group-image-wrap"><img src="https://arxiv.org/html/2403.00599v1/extracted/5443010/figur9a.png" /></div><div class="group-image-wrap"><img src="https://arxiv.org/html/2403.00599v1/extracted/5443010/figur9b.png" /></div></div><div class="group-image-row"><div class="group-image-wrap"><img src="https://arxiv.org/html/2403.00599v1/extracted/5443010/figur10.png" /></div></div></div><ol start="2" type="1"><li>Schiassi, Enrico, et al. "Physics-Informed Neural Networks for Optimal Planar Orbit Transfers." Journal of Spacecraft and Rockets (2022): 1-16.</li><li>Barreau, Matthieu, et al. "Physics-informed learning for identification and state reconstruction of traffic density." arXiv preprint arXiv:2103.13852 (2021).</li></ol><h1 id="blog">Blog</h1><ul><li><a href="https://zhuanlan.zhihu.com/p/662739405?utm_psn=1832573966142803968">浅谈一下PINN(物理启发神经网络）西南望长安</a><ul><li>PINN的基本原理起源于2017年Prof.George Karniadarkis 组Marziar Raissi的工作 (2017年已经放在了Arxiv上)<ul><li>Physics Informed Deep Learning:Data-driven Solutions of Nonlinear Partial Differential Equations</li></ul></li><li>分别用于解决反问题（inverse problem）和正问题（forward problem）<ul><li>正问题和反问题的正经定义可以解释为：正问题，已知原因，根据已有的模型和规律，得到结果状态或者观测，而反问题则是已知结果状态或者观测，来反推原因。</li><li>反问题我们定义为，已知一些场域内的观测情况，来反推最优的PDE方程的系数/参数的值（这个定义是非常狭隘的和最基本的，后面我们再延申），从某种角度来开，正问题和反问题是一套系统的共生问题</li></ul></li><li>神经网络的可微性带来了梯度求解的可行性，而现有的pytorch等框架的autograd带来了工程上实现的便利性</li><li>正是由于<strong>PDE方程已经包含了所有信息(一个世界模型)</strong>，因此，求解正问题时，<strong>PINN完全不需要数据，只需要随意在空间和时间步上采样，然后让PDE方程来评估神经网络的建模是否准确</strong></li></ul></li><li><a href="https://zhuanlan.zhihu.com/p/468748367?utm_psn=1832689886811004928">​内嵌物理知识神经网络（PINN）是个坑吗？ zwqwo</a><ul><li>PINN的原理就是通过训练神经网络来最小化损失函数来近似PDE的求解，所谓的损失函数项包括初始和边界条件的残差项，以及<strong>区域中选定点（按传统应该称为"配点"）处的偏微分方程残差</strong>。训练完成后进行推断（Inference）就可以得到时空点上的值了。</li><li>特别是用于解决与偏微分方程 （PDE） 相关的各种问题，包括方程求解、参数反演、模型发现、控制与优化等。</li><li>相比传统微分方程数值求解的描述，这里多出了行式子，也就是对于数据的使用，这也是PINN的特点之一。当然，这三个条件也不一定全都出现，比如<strong>边界条件消失，从传统数值方法的角度来看甚至不能满足定解条件</strong>。</li><li>自动微分</li><li>但PINN这种神经网络不行，即使对于线性方程，也不得不使用<strong>非线性求解器</strong>（迭代优化器），比如L-BFGS，或者神经网络训练中用得更多的SGD、Adam等。非线性问题的求解通常比线性问题难，这是PINN计算效率上一个避不开的障碍。</li><li>从这么看来，PINN确实不是太过于新奇的东西。至少在<em>1994年的文献中已经有使用MLP求解二维Poisson方程</em>的例子：<ul><li>Dissanayake, M. W. M. G., and Nhan Phan‐Thien. "Neural‐network‐based approximations for solving partial differential equations." communications in Numerical Methods in Engineering 10.3 (1994): 195-201.</li></ul></li><li>小结一下以上内容<ul><li>大家都知道PINN是一种（深度）网络，在定义时空区域中给定一个输入点，在训练后在微分方程的该点中产生估计的解。</li><li>结合对控制方程的嵌入得到残差，利用<strong>残差构造损失项</strong>就是PINN的一项不太新奇的新奇之处了。本质原理就是将方程（也就是所谓的物理知识）集成到网络中，并使用来自控制方程的残差项来构造损失函数，由该项作为惩罚项来限制可行解的空间。</li><li><strong>用PINN来求解方程并不需要有标签的数据，比如先前模拟或实验的结果</strong>。从这个角度，对PINN 在深度学习中的地位进行定位的话，大概是处于无监督、自监督、半监督或者弱监督的地位，这几个不尽相同的说法在不同语境下都有文献提过。</li><li><strong>PINN算法本质上是一种无网格技术，通过将直接求解控制方程的问题转换为损失函数的优化问题来找到偏微分方程解</strong>。</li></ul></li><li>如果把PINN当作是单纯的数值求解器，通常来讲，不管从速度或者精度，PINN在性能上并不能跟传统方法（有限差分、有限元、有限体积等大类方法）抗衡。(not sure)</li><li>“内嵌物理”（Physics informed）对于科学机器学习的必要性。值得一提的是，内嵌物理知识神经网络并不是一种作为数据驱动方法对立面的、单纯的“知识驱动”方法，而是作为数据方法与传统知识驱动方程的桥梁存在，也就是“知识”和“数据”共同驱动的方法</li><li>这节对一个不是太简单的方程进行了数值求解，<strong>但解方程其实也并不是PINN的主业</strong>。当然，<strong>对于PINN而言，解方程这种“正问题”跟参数发现等这些“逆问题”在求解形式上没有太大区别</strong>，能比较好求解“正问题”的PINN方法对于“逆问题”也会有不错的表现。</li><li>CFD与其说是计算科学，更像是一门实验科学，需要物理实验数据来对解算的模型进行验证，还面临诸多困难。<ul><li>在工程模型中，可能还涉及逆问题的求解，<strong>也就是边界条件和流体的各种参数未知的情形下，如何通过部分测量数据得到精确的模型参数和流场的重构</strong>。</li><li>CFD网格质量对结果的影响比较大，计算中网格划分本身也是非常耗时的。最后，目前的CFD软件都非常庞大，比如OpenFoam，对每一类问题都有专门的求解模块，拥有超过10万行的科学计算代码，其更新与维护也是一件难事。</li><li>刚好，PINN有部分解决以上问题的能力。<strong>PINN对各种数据的融合是非常自然的</strong>，不管是压强标量场的时空散点数据、速度矢量场的时空散点数据，还是示踪粒子的运动轨迹，都可以非常容易地融合到PINN的求解中。</li><li><strong>对于PINN来讲，求解正问题与求解包含数据的逆问题在形式上并没有太大区别</strong>，这是它的巨大优势之一。</li><li>即在时空散点测量数据比较充足的情况下，进行CFD相关的<strong>参数估计、流场重建、代理模型构建</strong>等问题的求解。与传统的CFD求解器相比，PINN在集成数据（流量的观测值）和物理知识（其实就是描述该物理现象的控制方程）方面更胜一筹。</li></ul></li><li>比较直接的是<strong>通过速度观测来重建全流场</strong>。在气动力学等学科的实验研究中，可以利用光学设备，通过粒子图像测速（Particle Image Velocimetry，PIV）和Particle Tracking Velocimetry（PTV）方法测量的得到多个散点速度。然而散点速度并不能满足需求，高分辨率的速度场对于可视化和后续分析是必不可少的。一个非常自然的想法就是通过类似图像插值来实现从散点到高分辨率流场的“超分辨”，但是这种方式处理得到的结果可能“并不符合物理规律”。作为融合了物理知识的PINN方法，可以非常自然地从这些稀疏速度信息来重建分辨率的整体速度场。</li><li><strong>连初值和边界条件都不需要。这种适合PINN建模求解的逆问题对于传统的CFD求解器来说并不是一件容易的事情</strong>。</li><li><strong>PINN的优势不再正问题求解上的速度和精度，而是在于融合数据和知识</strong>。</li></ul></li><li><a href="https://www.zhihu.com/question/526459912/answer/2776226543">PINN还有研究的必要吗？AI4Science探索</a><ul><li>PINN即内嵌物理知识神经网络，该领域更广泛、通用叫法应该是物理驱动的神经网络(深度学习)，刚接触到物理驱动的神经学习方法时，总会有一些疑惑：物理驱动的深度学习方法在求解一些物理系统（由物理方程所描述控制的系统）时，需要已知一些物理信息如偏微分方程。<strong>但传统数值方法发展这么多年了，如有限差分、有限体积方法已经非常成熟，也成功用于物理系统的求解，求解准确性非常高</strong>。但是物理驱动的深度学习如神经网络方法</li><li>相比于传统数值方法有以下潜在优势：<ul><li><strong>反问题计算上有比较大的优势</strong>。传统数值方法主要针对复杂问题的正计算，如已知边界条件、已知控制方程下的正计算，优势非常强。相比之下，在正计算问题上，深度学习方法逊色一些。但针对一些反问题，如已知一些测量数据和部分物理 <strong>(方程中某些参数未知、边界条件未知)</strong>，深度学习方法可以形成数据和物理双驱动的模型，比基于传统数值方法去做数据同化（data assimilation）效率更高。</li><li><strong>需要做快速推断时</strong>，优势更明显。一方面，当面对一些数值问题，可以不需要熟悉数值方法背景（不必利用数值格式去推导求解），可以直接利用加物理损失的方法得到一个参考解；另一方面，当问题边界需要不停地换，或者很多源需要不停的变化的问题设定下，如果利用大量时间去训练一个网络，如利用lulu老师提出<strong>deeponet方法</strong>（物理驱动的神经网络方法），在推断阶段就能实现快速预测。高维问题上的潜在优势。</li><li>神经网络确实能处理许多高维问题，但很难说神经网络方法在一些benchmark问题上已经完全超越了传统问题，还需要进一步讨论。</li></ul></li></ul></li><li><a href="https://mp.weixin.qq.com/s/YGd_PSWfqoZhsrYOUcTbJw">一GAN崩了不听话的PINN | 2025年01月27日 西南望长安</a><ul><li>这篇论文是关于如何使用GAN来自适应调整PINN的损失函数，从而让PINN 收敛到更好的性能。论文题目是“DEQGAN: Learning the Loss Function for PINNs with Generative Adversarial Networks”</li><li>当我们把PINN用在实际工作中，你会发现有时候很难搞到收敛的结果，把PINN 当作一个所谓的physics solver似乎只是一个镜花水月的梦想。why？ 首先，神经网络的自由度远远超出了pde方程的复杂度，这就像是高维生物在看低微生物，亦或者人类在看小蚂蚁，有无数种方法可以玩弄小蚂蚁，所以虽然pde只有一个解，但是神经网络有一万条路去拟合，其中大部分都跑到了局部最优</li><li>典型做法是这样的，大家不停试错，为这些损失函数配置权重，最终找到一组可以让模型收敛，论文里“trail and error”三个词可能代表了科研民工们三个月的工作量。但是这样的人肉优化是不是最好的，我不置可否，虽然它很artificial，但好像不咋intelligence。</li><li>更有甚者，就是直接拿一堆样本把模型都监督学习跑了几万个epoch训好了，然后拿pde loss“辛辛苦苦的”跑了三个epoch；亦或者给监督损失一个极大的权重，pde一个忽略不计的权重。这仿佛去吃牛肉面，只看到了牛肉沫，剩下的全是科技狠活出来的牛肉味儿。</li><li>说起来简单，其实GAN 也不是什么灵丹妙药，毕竟GAN自身就是天下一等一的不稳定，难训练。</li><li>如果大家去看论文里下表的参差不齐的学习率设计，你就知道作者为了把它调收敛也是花了不少心思，但是好在GAN的理论研究比较多，怎么把GAN 搞收敛已经有比较多的手段了。</li></ul></li></ul><h1 id="governing-equations-from-scarce-data">governing equations from scarce data</h1><ul><li>Chen, Z., Liu, Y., &amp; Sun, H. (2021). Physics-informed learning of governing equations from scarce data. Nature communications, 12(1), 6136.<ul><li>通过数据发现描述复杂物理系统的控制方程或规律，可以极大地促进各个科学和工程领域对这些系统的建模、仿真和理解。本文提出了一种新颖的方法，<strong>称为稀疏回归的物理启发神经网络</strong>，用于从稀疏和噪声数据中<strong>发现非线性时空系统的控制偏微分方程</strong>。特别地，该发现方法无缝集成了深度神经网络在丰富表示学习、物理嵌入、自动微分和稀疏回归方面的优势，以逼近系统变量的解，计算必要的导数，以及识别形成方程结构和显式表达式的关键导数项和参数。该方法的有效性和鲁棒性在多种偏微分方程系统的数值和实验上得到了验证，这些系统考虑了不同的数据稀缺性和噪声水平，以及不同的初始/边界条件。所得的计算框架<strong>显示了在大规模准确数据难以获取的实际应用中发现封闭形式模型的潜力</strong>。</li></ul></li></ul><figure><img src="https://media.springernature.com/full/springer-static/image/art%3A10.1038%2Fs41467-021-26434-1/MediaObjects/41467_2021_26434_Fig4_HTML.png?as=webp" alt="Fig. 4: Discovered Fitzhugh–Nagumo equations based on data sampled under three initial conditions (ICs) with 10% noise." /><figcaption>Fig. 4: Discovered Fitzhugh–Nagumo equations based on data sampled under three initial conditions (ICs) with 10% noise.</figcaption></figure><h1 id="generalization-of-pinns">Generalization of PINNs</h1><ul><li><a href="https://elib.dlr.de/185457/1/master_thesis.pdf#page=36.10">Schäfer, Violetta. Generalization of physics-informed neural networks for various boundary and initial conditions. Diss. Technische Universität Kaiserslautern, 2022. (Master Thesis)</a></li><li></li></ul><h1 id="references">References</h1><ol type="1"><li>Dissanayake, M. W. M. G., and Nhan Phan‐Thien. "Neural‐network‐based approximations for solving partial differential equations." communications in Numerical Methods in Engineering 10.3 (1994): 195-201.</li><li>Raissi, Maziar, Paris Perdikaris, and George Em Karniadakis. "Physics informed deep learning (part i): Data-driven solutions of nonlinear partial differential equations." arXiv preprint arXiv:1711.10561 (2017).</li><li>Raissi, M., Perdikaris, P., &amp; Karniadakis, G.E. (2017). Physics Informed Deep Learning (Part II): Data-driven Discovery of Nonlinear Partial Differential Equations. ArXiv, abs/1711.10566.</li><li>Raissi, M., Perdikaris, P., &amp; Karniadakis, G. E. (2019). Physics-informed neural networks: A deep learning framework for solving forward and inverse problems involving nonlinear partial differential equations. Journal of Computational physics, 378, 686-707.</li><li>Karniadakis, G. E., Kevrekidis, I. G., Lu, L., Perdikaris, P., Wang, S., &amp; Yang, L. (2021). Physics-informed machine learning. Nature Reviews Physics, 3(6), 422-440.</li><li>Lu, L., Jin, P., Pang, G., Zhang, Z., &amp; Karniadakis, G. E. (2021). Learning nonlinear operators via DeepONet based on the universal approximation theorem of operators. Nature machine intelligence, 3(3), 218-229.</li><li>Lu, Lu, et al. "DeepXDE: A deep learning library for solving differential equations." SIAM Review 63.1 (2021): 208-228.</li></ol>]]></content>
    
    
    <categories>
      
      <category>ML</category>
      
    </categories>
    
    
    <tags>
      
      <tag>AI</tag>
      
      <tag>PINN</tag>
      
      <tag>DeepONet</tag>
      
      <tag>ML</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ML | JAX</title>
    <link href="/2024/06/25/PINN-JAX/"/>
    <url>/2024/06/25/PINN-JAX/</url>
    
    <content type="html"><![CDATA[<h1 id="jax">JAX</h1><p><a href="https://github.com/google/jax">JAX</a> is a Python library for accelerator-oriented array computation and program transformation, designed for high-performance numerical computing and large-scale machine learning.</p><p>With its updated version of <strong>Autograd</strong>, JAX can automatically differentiate native Python and NumPy functions. It can differentiate through loops, branches, recursion, and closures, and it can take derivatives of derivatives of derivatives. It supports reverse-mode differentiation (a.k.a. backpropagation) via grad as well as forward-mode differentiation, and the two can be composed arbitrarily to any order.</p><h1 id="installing-jax">Installing JAX</h1><p>https://jax.readthedocs.io/en/latest/installation.html</p><p>TL;DR For most users, a typical JAX installation may look something like this:</p><ul><li>CPU-only (Linux/macOS/Windows)</li><li>GPU (NVIDIA, CUDA 12)</li><li>TPU (Google Cloud TPU VM)</li></ul><h1 id="install-nvidia">Install (NVIDIA)</h1><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs sh">$ micromamba activate wpsze_venv<br>$ micromamba install jaxlib=*=*cuda* jax cuda-nvcc -c conda-forge -c nvidia<br><br>$ nvidia-smi<br></code></pre></td></tr></table></figure><h2 id="version-issue">Version Issue</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs sh">CUDA backend failed to initialize: Unable to use CUDA because of the following issues with CUDA components:<br>Outdated CUDA installation found.<br>Version JAX was built against: 11080<br>Minimum supported: 12010<br>Installed version: 11080<br>The <span class="hljs-built_in">local</span> installation version must be no lower than 12010.<br>--------------------------------------------------<br>Outdated cuBLAS installation found.<br>Version JAX was built against: 111103<br>Minimum supported: 120100<br>Installed version: 111103<br>The <span class="hljs-built_in">local</span> installation version must be no lower than 120100.<br>--------------------------------------------------<br>Outdated cuSPARSE installation found.<br>Version JAX was built against: 11705<br>Minimum supported: 12100<br>Installed version: 11705<br>The <span class="hljs-built_in">local</span> installation version must be no lower than 12100..(Set TF_CPP_MIN_LOG_LEVEL=0 and rerun <span class="hljs-keyword">for</span> more info.)<br>[0.        1.05      2.1       3.1499999 4.2      ]<br></code></pre></td></tr></table></figure><p><a href="https://docs.nvidia.com/cuda/archive/12.1.0/cuda-toolkit-release-notes/">Driver/CUDA version</a>,</p><table><thead><tr class="header"><th>CUDA Toolkit</th><th>Minimum Required Driver Version for CUDA Minor Version Compatibility*</th><th></th></tr></thead><tbody><tr class="odd"><td></td><td>Linux x86_64 Driver Version</td><td>Windows x86_64 Driver Version</td></tr><tr class="even"><td>CUDA 12.1.x</td><td>525.60.13</td><td>527.41</td></tr><tr class="odd"><td>CUDA 12.0.x</td><td>525.60.13</td><td>527.41</td></tr><tr class="even"><td>CUDA 11.8.x</td><td>450.80.02</td><td>452.39</td></tr><tr class="odd"><td>CUDA 11.7.x</td><td>450.80.02</td><td>452.39</td></tr></tbody></table><h1 id="install-cpu-only">Install (CPU only)</h1><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">conda install jax -c conda-forge<br></code></pre></td></tr></table></figure><p>Test 1:</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-meta">#!/bin/python</span><br><br><span class="hljs-comment"># 导入库</span><br>from jax import grad<br>import jax.numpy as jnp<br><br><span class="hljs-comment"># 定义logistic函数</span><br>def logistic(x):  <br>    <span class="hljs-built_in">return</span> jnp.exp(x) / (jnp.exp(x) + 1)<br><br><span class="hljs-comment"># 获得logistic函数的梯度函数</span><br>grad_logistic = grad(logistic)<br><br><span class="hljs-comment"># 求值logistic函数在x = 1处的梯度 </span><br>grad_log_out = grad_logistic(1.0)   <br><span class="hljs-built_in">print</span>(grad_log_out)<br><br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Final result is 0.19661194 &quot;</span>)<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>ML</category>
      
    </categories>
    
    
    <tags>
      
      <tag>AI</tag>
      
      <tag>PINN</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>WRF | WRF: Why domains should be at least 100x100 grid spaces?</title>
    <link href="/2024/06/11/WRF-Why_domains_should_be_at_least_100_100_grid_spaces/"/>
    <url>/2024/06/11/WRF-Why_domains_should_be_at_least_100_100_grid_spaces/</url>
    
    <content type="html"><![CDATA[<h1 id="why-domains-should-be-at-least-100x100-grid-spaces"><a href="https://forum.mmm.ucar.edu/threads/why-domains-should-be-at-least-100x100-grid-spaces.16793/">Why domains should be at least 100x100 grid spaces?</a></h1><p>Each WRF domain should be at least 100x100 grid points (e_we and e_sn).</p><p>When running a simulation, the input data for the lateral boundaries, every so many intervals (e.g., every 3 hours), are much more coarse than the simulation you’re trying to run.</p><p>Synoptic-scale systems typically move through a large area in a short amount of time. If a domains is too small, there isn’t enough space for the model to develop anything of interest before the large-scale parcels have propagated through the domain and exited the other side. This is sometimes referred to as “sweeping,” meaning the <strong>input essentially wipes out what WRF is trying to simulate at high resolution, with different physics and higher-res terrain, landuse, the dynamics, and all the other features you want</strong>. Even if you’re only interested in microscale events, the large-scale factors are important for forcing.</p><p>Essentially, if your domain is too small, you’re basically going to get the output as if the domain was still a coarse-resolution. You want your domain to have enough space so that you can actually see the effect.</p><p>This is not a computational limitation. It’s more an issue of reasonable and beneficial output. {:.info}</p><p><strong>Also note that the model will use the rows and columns around the edges of the domain for communication. This is set, by default, to 5 rows and 5 columns (it can be changed with the &amp;bdy_control namelist parameter ‘spec_bdy_width,' but shouldn't be smaller than 5). This means that if e_we = 100 and e_sn = 100, at a minimum, the domain is already cut down to 90x90.</strong></p>]]></content>
    
    
    <categories>
      
      <category>WRF</category>
      
    </categories>
    
    
    <tags>
      
      <tag>WRF</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Spack-Stack (MPAS-JEDI)</title>
    <link href="/2024/06/10/spack_stack_jedi_mpas/"/>
    <url>/2024/06/10/spack_stack_jedi_mpas/</url>
    
    <content type="html"><![CDATA[<h1 id="spack-stack">spack-stack</h1><p>Spack-stack is a framework for installing software libraries to support NOAA's Unified Forecast System (UFS) applications and the Joint Effort for Data assimilation Integration (JEDI) coupled to several Earth system prediction models (MPAS, NEPTUNE, UM, FV3, GEOS, UFS).</p><p>Spack-stack provides a practical framework for setting up and managing software libraries that support the Unified Forecast System (UFS) and Joint Effort for Data assimilation Integration (JEDI) projects, along with several other Earth system prediction models, such as the Model for Prediction Across Scales (MPAS), the Navy Environmental Prediction System Utilizing a Nonhydrostatic Engine (NEPTUNE), the Unified Model (UM), and the Goddard Earth Observing System (GEOS). This project results from collaboration among the Joint Center for Satellite Data Assimilation (JCSDA), the National Oceanic and Atmospheric Administration’s (NOAA’s) Environmental Modeling Center (EMC) and Earth Prediction Innovation Center (EPIC), and the U.S. Naval Research Laboratory (NRL). Spack-stack utilizes the Spack package manager, originally developed at Lawrence Livermore National Laboratory to cater to scientific high-performance computing (HPC) workflows.</p><p><a href="https://www.jcsda.org/news-blog/2023/10/2/jedi-spack-stack-150-the-new-standard">SPACK-STACK 1.5.0</a> &gt; That started changing in 2021, when JCSDA and NOAA EMC began exploring Spack as an option for creating a single software stack that could be used for both the JEDI DA software environment and the Unified Forecast System (UFS) ecosystem.</p><p><a href="https://github.com/JCSDA/spack-stack">github spack-stack</a></p><p><a href="https://spack-stack.readthedocs.io/en/latest/#">spack-stack.readthedocs.io</a></p><p><a href="https://epic.noaa.gov/spack-stack/">Spack-stack</a></p><p><a href="https://www.google.com/search?q=ONE+STACK+TO+BUILD+THEM+ALL%3A+THE+NOAA-EMC%2FJCSDA+SPACK-STACK&amp;rlz=1C5CHFA_enHK1003HK1003&amp;sourceid=chrome&amp;ie=UTF-8">ONE STACK TO BUILD THEM ALL: THE NOAA-EMC/JCSDA SPACK-STACK (PPT)</a></p><p><a href="https://epic.noaa.gov/wp-content/uploads/2023/08/UIFCW-2023-Thu-17.-RICHERT_spack-stack-UIFCW-July-2023.pdf">spack-stack: A reproducible, many-platform software stack for operational weather applications (PPT)</a></p><div class="note note-primary">            <p><strong>spack-stack</strong> is a set of Spack configurations and extensions</p>          </div><div class="note note-primary">            <p><strong>spack-stack</strong> is mainly a collection of Spack configuration files, but provides a Spack extension to simplify the installation process</p>          </div><ul><li><a href="https://www2.mmm.ucar.edu/projects/mpas-jedi/tutorial/202410HOWARD/lectures/12-spackstack.pdf"><strong>Introduction to spack-stack Building JEDI bundles on your own machine | October 4, 2024</strong></a></li></ul><h1 id="prerequisites-micromamba-env">Prerequisites (Micromamba Env)</h1><h2 id="prerequisites-ubuntu-one-off">Prerequisites: Ubuntu (one-off)</h2><ul><li><a href="https://spack-stack.readthedocs.io/en/latest/NewSiteConfigs.html#prerequisites-ubuntu-one-off" class="uri">https://spack-stack.readthedocs.io/en/latest/NewSiteConfigs.html#prerequisites-ubuntu-one-off</a></li></ul>    <div class="fold">      <div class="fold-title fold-info collapsed" data-toggle="collapse" href="#collapse-8f7bdefe" role="button" aria-expanded="false" aria-controls="collapse-8f7bdefe">        <div class="fold-arrow">▶</div>Prerequisites: Ubuntu (one-off)      </div>      <div class="fold-collapse collapse" id="collapse-8f7bdefe">        <div class="fold-content">          <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-built_in">sudo</span> su<br>apt-get update<br>apt-get upgrade<br><br>Compilers<br>apt install -y gcc g++ gfortran gdb<br><br>Environment module support<br>Note: lmod is available <span class="hljs-keyword">in</span> 22.04, but is out of <span class="hljs-built_in">date</span>: https://github.com/JCSDA/spack-stack/issues/593<br>apt install -y environment-modules<br><br>Misc<br>apt install -y build-essential<br>apt install -y libkrb5-dev<br>apt install -y m4<br>apt install -y git<br>apt install -y git-lfs<br>apt install -y bzip2<br>apt install -y unzip<br>apt install -y automake<br>apt install -y autopoint<br>apt install -y gettext<br>apt install -y texlive<br>apt install -y libcurl4-openssl-dev<br>apt install -y libssl-dev<br>apt install -y wget<br><br>Note - only needed <span class="hljs-keyword">for</span> running JCSDA<span class="hljs-string">&#x27;s</span><br><span class="hljs-string">JEDI-Skylab system (using R2D2 localhost)</span><br><span class="hljs-string">apt install -y mysql-server</span><br><span class="hljs-string">apt install -y libmysqlclient-dev</span><br><span class="hljs-string"></span><br><span class="hljs-string">Exit root session</span><br><span class="hljs-string">exit</span><br><span class="hljs-string"></span><br></code></pre></td></tr></table></figure>        </div>      </div>    </div><h1 id="new-spack-stack-directory-structure">New spack-stack directory structure</h1><p>To generate a new spack-stack directory structure,</p><p>run <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">git <span class="hljs-built_in">clone</span> --recurse-submodules https://github.com/JCSDA/spack-stack<br></code></pre></td></tr></table></figure></p><p>optionally with, e.g., '-b release/1.4.1' to specify the version</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-built_in">source</span> \&lt;path to spack-stack directory\&gt;/setup.sh<br></code></pre></td></tr></table></figure><h1 id="new-environment">New environment</h1><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs sh">$ spack stack create <span class="hljs-built_in">env</span> --site &lt;site name&gt; --template &lt;template name&gt; --name &lt;environment name&gt;<br>$ <span class="hljs-built_in">cd</span> <span class="hljs-variable">$&#123;SPACK_STACK_DIR&#125;</span>/envs/&lt;environment name&gt;/<br>$ spack <span class="hljs-built_in">env</span> activate .<br><br><span class="hljs-comment"># If not using an existing site configuration, you may wish to modify config files and/or populate them using commands</span><br><span class="hljs-comment"># such as &#x27;spack external find&#x27; and &#x27;spack compiler find&#x27;.</span><br><span class="hljs-comment"># See https://spack-tutorial.readthedocs.io/en/latest/tutorial_configuration.html</span><br><br>$ spack concretize 2&gt;&amp;1 | <span class="hljs-built_in">tee</span> log.concretize<br>$ spack install [--verbose] [--fail-fast] 2&gt;&amp;1 | <span class="hljs-built_in">tee</span> log.install<br>$ spack module lmod refresh<br>$ spack stack setup-meta-modules<br></code></pre></td></tr></table></figure><h2 id="mpas-jdei">MPAS-JDEI</h2><p>Ref:<a href="https://www2.mmm.ucar.edu/projects/mpas-jedi/tutorial/202310NCU/">Welcome to the MPAS-JEDI tutorial practice guide</a></p><p>For example, if default is gcc@8.5.0.</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><code class="hljs sh">$ git <span class="hljs-built_in">clone</span> -b release/1.5.1 --recurse-submodules https://github.com/JCSDA/spack-stack<br><br>$ <span class="hljs-built_in">cd</span> spack-stack<br><br>$ git status<br>On branch release/1.5.1<br>Your branch is up to <span class="hljs-built_in">date</span> with <span class="hljs-string">&#x27;origin/release/1.5.1&#x27;</span>.<br><br>nothing to commit, working tree clean<br><br>$ <span class="hljs-built_in">source</span> setup.sh<br><br>$ spack stack create <span class="hljs-built_in">env</span> --site linux.default --name jedi_gccv850_linux<br>Configuring basic directory information ...<br>  ... script directory: /home/wpsze/spack-stack/spack-stack/spack/lib/jcsda-emc/spack-stack/stack<br>  ... base directory: /home/wpsze/spack-stack/spack-stack/spack/lib/jcsda-emc/spack-stack<br>  ... spack directory: /home/wpsze/spack-stack/spack-stack/spack<br>Creating environment from command-line args<br>Successfully wrote environment at /home/wpsze/spack-stack/spack-stack/envs/jedi_gccv850_linux/spack.yaml<br><br>WARNING! User <span class="hljs-built_in">umask</span> is neither 0022 nor 0027, check before proceeding<br><br>==&gt; Created environment /home/wpsze/spack-stack/spack-stack/envs/jedi_gccv850_linux<br><br>$ spack <span class="hljs-built_in">env</span> activate envs/jedi_gccv850_linux<br><br>$ spack find<br>==&gt; In environment /home/wpsze/spack-stack/spack-stack/envs/jedi_gccv850_linux<br>==&gt; No root specs<br>==&gt; 0 installed packages<br><br><br><span class="hljs-comment">## MPAS-JEDI</span><br>$ spack add ecbuild eigen udunits gsl-lite environment-modules<br>$ spack add mpich<br>$ spack add hdf5^mpich parallelio^mpich<br>$ spack add ecmwf-atlas@0.31.1^mpich<br><br>$ spack install<br><br><span class="hljs-comment"># all are successful.</span><br><br> $ spack find<br>==&gt; In environment /home/wpsze/spack-stack/spack-stack/envs/jedi_gccv850_linux<br>==&gt; Root specs<br>ecbuild   ecmwf-atlas@0.31.1   eigen   environment-modules   gsl-lite   hdf5   mpich   parallelio   udunits <br><br>==&gt; Installed packages<br>-- linux-rocky8-haswell / gcc@8.5.0 -----------------------------<br>autoconf@2.69                       diffutils@3.9              fiat@1.2.0       libfabric@1.18.1   m4@1.4.19               pigz@2.7                util-macros@1.19.3<br>automake@1.16.5                     ecbuild@3.7.2              findutils@4.9.0  libffi@3.4.4       mpich@4.1.1             pkg-config@0.29.2       xz@5.4.1<br>berkeley-db@18.1.40                 eckit@1.23.1               flex@2.6.3       libiconv@1.17      ncurses@6.4             python@3.10.8           yaksa@0.2<br>bison@3.8.2                         ecmwf-atlas@0.31.1         gdbm@1.23        libmd@1.0.4        netcdf-c@4.9.2          readline@8.2            zlib@1.2.13<br>boost@1.78.0                        ectrans@1.2.0              gettext@0.21.1   libpciaccess@0.17  netcdf-fortran@4.6.0    snappy@1.1.10           zstd@1.5.2<br>bzip2@1.0.8                         eigen@3.4.0                gmake@4.4.1      libsigsegv@2.14    openblas@0.3.19         sqlite@3.42.0<br>c-blosc@1.21.4                      environment-modules@5.3.1  gsl-lite@0.37.0  libtool@2.4.7      openssl@1.1.1u          tar@1.34<br>ca-certificates-mozilla@2023-01-10  expat@2.5.0                hdf5@1.14.0      libxcrypt@4.4.35   parallel-netcdf@1.12.2  tcl@8.6.12<br>cmake@3.23.1                        fckit@0.10.1               libaec@1.0.6     libxml2@2.10.3     parallelio@2.5.10       udunits@2.2.28<br>curl@8.1.2                          fftw@3.3.10                libbsd@0.11.7    lz4@1.9.4          perl@5.38.0             util-linux-uuid@2.38.1<br>==&gt; 65 installed packages<br><br>$ spack module tcl refresh<br>==&gt; You are about to regenerate tcl module files <span class="hljs-keyword">for</span>:<br><br>-- linux-rocky8-haswell / gcc@8.5.0 -----------------------------<br>kmosf2b autoconf@2.69                       owkksle expat@2.5.0       o5fm2ib libpciaccess@0.17       zzdldzz pkg-config@0.29.2<br>3zzqcqa automake@1.16.5                     z5frtgj fckit@0.10.1      bcnervk libsigsegv@2.14         vu7mzai python@3.10.8<br>rksajpa berkeley-db@18.1.40                 dyhv6t6 fftw@3.3.10       oi52wco libtool@2.4.7           nbav53o readline@8.2<br>k4yohcw bison@3.8.2                         abwhtim fiat@1.2.0        dh3pgna libxcrypt@4.4.35        awehs3f snappy@1.1.10<br>3zcm66d boost@1.78.0                        th5cmuq findutils@4.9.0   56a6xgk libxml2@2.10.3          xmupg6k sqlite@3.42.0<br>yd6i5au bzip2@1.0.8                         hjgtmaq flex@2.6.3        rwcgkls lz4@1.9.4               vetdjwa tar@1.34<br>at3s3ei c-blosc@1.21.4                      lisu52h gdbm@1.23         uwicvjw m4@1.4.19               m3xviog tcl@8.6.12<br>edma3gu ca-certificates-mozilla@2023-01-10  wzfhnm7 gettext@0.21.1    jefb5lu mpich@4.1.1             uadvmuz udunits@2.2.28<br>h5p5rs7 cmake@3.23.1                        ba4vudd gmake@4.4.1       dzxkixc ncurses@6.4             wdfeec7 util-linux-uuid@2.38.1<br>jf7usug curl@8.1.2                          t4udhou gsl-lite@0.37.0   6d2z7tb netcdf-c@4.9.2          evqjofh util-macros@1.19.3<br>32jm5xp diffutils@3.9                       fja7tdm hdf5@1.14.0       3ltfgi2 netcdf-fortran@4.6.0    72t2yvx xz@5.4.1<br>pzidwlf ecbuild@3.7.2                       vbf3elz libaec@1.0.6      u5n5zri openblas@0.3.19         iyrk2i7 yaksa@0.2<br>wov4yva eckit@1.23.1                        65boafj libbsd@0.11.7     mgcs3tx openssl@1.1.1u          x54v3wn zlib@1.2.13<br>v45ibbv ecmwf-atlas@0.31.1                  63u4otp libfabric@1.18.1  56vql6d parallel-netcdf@1.12.2  bteldyo zstd@1.5.2<br>kb6u64z ectrans@1.2.0                       frf3blg libffi@3.4.4      efx7bmd parallelio@2.5.10<br>t4jxg3j eigen@3.4.0                         pnmrtbc libiconv@1.17     se4zvg5 perl@5.38.0<br>om7l5xf environment-modules@5.3.1           vgtevgl libmd@1.0.4       l3xczgm pigz@2.7<br><br>==&gt; Do you want to proceed? [y/n] y<br>==&gt; Regenerating tcl module files<br><br>$ spack stack setup-meta-modules<br>...<br>Metamodule generation completed successfully <span class="hljs-keyword">in</span> /home/wpsze/spack-stack/spack-stack/envs/jedi_gccv850_linux/install/modulefiles/Core<br></code></pre></td></tr></table></figure><p>Error: &gt; Error: eigen-3.4.0-t4jxg3j727pxxsr75zstl2eblmkzapfz: timeout: The read operation timed out &gt;&gt; rerun: $ spack install</p><blockquote><p>==&gt; Installing krb5-1.20.1-muktx57itqz6x2z74afwncpub2higpei msgfmt: error while opening "en_US.mo" for writing: Permission denied msgfmt: error while opening "de.mo" for writing: Permission denied &gt; No install git-lfs</p></blockquote><blockquote><p>Error: git-lfs-3.3.0-6ilwlfqmm7ud5crbugmcskju5gtkgk4j: Package was not installed &gt; <code>$ micromamba activate git-lfs</code> &gt; <code>$ micromamba install git-lfs</code></p></blockquote><p>Remark: Git Large File Storage (LFS) replaces large files such as audio samples, videos, datasets, and graphics with text pointers inside Git, while storing the file contents on a remote server like GitHub.com or GitHub Enterprise.</p><p>source env,</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment">#source $&#123;SPACK_DIR&#125;/setup.sh</span><br><span class="hljs-comment">#spack env activate $&#123;SPACK_ENV&#125;</span><br></code></pre></td></tr></table></figure><blockquote><p>** do above on local PC because git-lfs fails on workstation/cluster.</p></blockquote><h2 id="mpas_bundle">mpas_bundle</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs sh">$ <span class="hljs-built_in">source</span> spack/share/spack/setup-env.sh<br>$ <span class="hljs-built_in">source</span> spack-stack/setup.sh<br>$ spack <span class="hljs-built_in">env</span> activate spack-stack/envs/jedi_gcc_linux<br>$ spack find<br><br>$ <span class="hljs-built_in">mkdir</span> mpas_bundle_v2<br>$ <span class="hljs-built_in">cd</span> mpas_bundle_v2<br>$ git <span class="hljs-built_in">clone</span> -b release/2.0.0 https://github.com/JCSDA/mpas-bundle.git code<br><br>$ <span class="hljs-built_in">mkdir</span> build<br>$ <span class="hljs-built_in">cd</span> build<br><br><span class="hljs-comment"># (no need) $ module list</span><br></code></pre></td></tr></table></figure><p>MPAS-JEDI uses cmake to automatically download the code from various github repositories, listed in CMakeLists.txt under ~code. Now type the command below under the build directory:</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">$ git lfs install<br></code></pre></td></tr></table></figure><p>and then, <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs sh">spack load ecbuild@3.7.2<br>spack load eigen@3.4.0 gsl-lite@0.37.0 hdf5@1.14.0 udunits@2.2.28 netcdf-c@4.9.2 netcdf-fortran@4.6.0 parallel-netcdf@1.12.2 parallelio@2.5.10<br>spack load openblas@0.3.19<br>spack load eckit@1.23.1<br>spack load fckit@0.10.1<br>spack load ecmwf-atlas@0.31.1<br>spack load cmake@3.23.1 mpich@4.1.1<br><br>$ cmake ../code<br><br>......<br>-- Configuring <span class="hljs-keyword">done</span><br>-- Generating <span class="hljs-keyword">done</span><br>-- Build files have been written to: /home/wpsze/mpas_bundle_v2/build<br></code></pre></td></tr></table></figure></p><p>After it completes, <strong>you will see the actual source code of various reporitories (e.g., oops, saber, ufo, ioda, crtm, mpas-jedi, and MPAS) is now under the code directory</strong>. Meanwhile, <strong>Makefile files to build executables are generated under the build directory</strong>. Now it is ready to compile MPAS-JEDI under 'build' using the standard make. However, it is NOT recommended to compile the code on the login node at the same time.</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs sh">$ make -j14<br><br>.......<br>[100%]<br></code></pre></td></tr></table></figure><p>This requests xx min walltime of a login node with 14 cores. {:.info}</p><p>Once we reach 100% of the compilation, we can check mpas-jedi related executables:</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs sh">$ <span class="hljs-built_in">ls</span> bin/mpas*<br><br>bin/mpas_atmosphere                       bin/mpasjedi_forecast.x<br>bin/mpas_atmosphere_build_tables          bin/mpasjedi_gen_ens_pert_B.x<br>bin/mpas_data_checker.py                  bin/mpasjedi_hofx3d.x<br>bin/mpas_data_downloader.py               bin/mpasjedi_hofx.x<br>bin/mpas_init_atmosphere                  bin/mpasjedi_rtpp.x<br>bin/mpasjedi_convertstate.x               bin/mpasjedi_staticbinit.x<br>bin/mpasjedi_dirac.x                      bin/mpasjedi_variational.x<br>bin/mpasjedi_eda.x                        bin/mpas_namelist_gen<br>bin/mpasjedi_enkf.x                       bin/mpas_parse_atmosphere<br>bin/mpasjedi_enshofx.x                    bin/mpas_parse_init_atmosphere<br>bin/mpasjedi_error_covariance_training.x  bin/mpas_streams_gen<br><br>$ <span class="hljs-built_in">ls</span> bin/ioda-up*<br>bin/ioda-upgrade-v1-to-v2.x  bin/ioda-upgrade-v2-to-v3.x<br></code></pre></td></tr></table></figure><p>The last step is to ensure that the code was compiled properly by running the MPAS-JEDI ctests, with two lines of simple command:</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs sh">$ <span class="hljs-built_in">cd</span> mpas-jedi<br>$ ctest<br><br>100% tests passed, 0 tests failed out of 47<br><br>Label Time Summary:<br>executable    =  54.21 sec*proc (13 tests)<br>mpasjedi      = 380.26 sec*proc (47 tests)<br>mpi           = 287.59 sec*proc (43 tests)<br>script        = 326.05 sec*proc (34 tests)<br><br>Total Test time (real) = 380.91 sec<br></code></pre></td></tr></table></figure><p>To determine if a test passes or fails, <em>a comparison of the test log and reference file is done internally taking as reference a tolerance value</em>. This tolerance is specified via YAML file. These files can be found under <strong>mpas-jedi/test/testoutput</strong> in the build folder.</p><h2 id="converting-ncep-bufr-observation-into-ioda-hdf5-format">Converting NCEP BUFR observation into IODA-HDF5 format</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sh">$ <span class="hljs-built_in">cd</span> mpas_jedi_tutorial <br>$ git <span class="hljs-built_in">clone</span> https://github.com/NCAR/obs2ioda<br>$ <span class="hljs-built_in">cd</span> obs2ioda/obs2ioda-v2/src/<br></code></pre></td></tr></table></figure><p>NCEP BUFR library (https://github.com/NOAA-EMC/NCEPLIBS-bufr) is required to compile <strong>obs2ioda-v2.x</strong>. Edit <strong>obs2ioda-v2/src/Makefile</strong> to set proper <strong>BUFR_LIB</strong> before make. Here we have pre-build BUFR_LIB on Taiwania-3 and we put the pre-build BUFR_LIB path in Makefile.</p><h3 id="required-ncep-bufr-library">(Required) NCEP BUFR library</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs sh">$ git <span class="hljs-built_in">clone</span> https://github.com/NOAA-EMC/NCEPLIBS-bufr<br><br>$ <span class="hljs-built_in">mkdir</span> build &amp;&amp; <span class="hljs-built_in">cd</span> build<br><br><span class="hljs-comment"># $ cmake -DCMAKE_INSTALL_PREFIX=path1 -DMASTER_TABLE_DIR=path2 .. # path1=./</span><br>$ cmake -DCMAKE_INSTALL_PREFIX=./ .. <br>-- Build files have been written to: /home/wpsze/mpas_jedi_tutorial/NCEPLIBS-bufr/build<br><br>$ make -j4<br>......<br>[100%] Built target outtest6_8<br><br>$ ctest<br>......<br>100% tests passed, 0 tests failed out of 94<br>Total Test time (real) =  30.62 sec<br><br>$ make install<br>......<br>-- Installing: /home/wpsze/mpas_jedi_tutorial/NCEPLIBS-bufr/build/bin/debufr<br></code></pre></td></tr></table></figure><p>Both <strong>path1</strong> and <strong>path2</strong> may be full or relative pathnames on the system, up to a maximum of 90 characters each.</p><p>Installation of the library and utilities will be under <strong>path1</strong>. Installation of the master BUFR tables will be under <strong>path2</strong>, or <em>under path1 if -DMASTER_TABLE_DIR=path2 is omitted from the above cmake command</em>.</p><p>If Python interoperability is desired, -DENABLE_PYTHON=ON can also be added to the above cmake command. However, version 3 of Python must be installed and available on the system.</p><h3 id="go-back-to-ioda">Go back to IODA</h3><h3 id="obs2ioda-v2.x">obs2ioda-v2.x</h3><p>https://github.com/jamiebresch/obs2ioda/blob/main/obs2ioda-v2/README.md</p><p>NCEP BUFR library (https://github.com/NOAA-EMC/NCEPLIBS-bufr) is required to compile <strong>obs2ioda-v2.x</strong>. Edit <strong>obs2ioda-v2/src/Makefile</strong> to set proper <strong>BUFR_LIB</strong> before make. <del>Here we have pre-build BUFR_LIB on Taiwania-3 and we put the pre-build BUFR_LIB path in Makefile.</del> We have to build one as above and put the build BUFR_LIB path in Makefile.</p><p>Default Makefile includes,</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment">#--------------</span><br><span class="hljs-comment">#INTEL compiler</span><br><span class="hljs-comment">#--------------</span><br>FC = ifort<br><span class="hljs-comment">#BUFR_LIB = -L/glade/u/home/hclin/extlib/intel -lbufr</span><br><span class="hljs-comment">#FFLAGS = -mcmodel medium # needed for intel error message &quot;failed to convert GOTPCREL relocation&quot;</span><br>BUFR_LIB = -L/glade/campaign/mmm/parc/ivette/pandac/converters/WRFDA_3DVAR_dmpar/var/external/bufr -lbufr<br>FFLAGS = -mcmodel medium <span class="hljs-comment"># needed for intel error message &quot;failed to convert GOTPCREL relocation&quot; # -g -traceback -debug all -check all</span><br><br>LIBS = -L$(NETCDF)/lib -lnetcdff -lnetcdf <span class="hljs-variable">$&#123;BUFR_LIB&#125;</span><br>INCS = -I$(NETCDF)/include<br>```   <br><br><span class="hljs-keyword">then</span>,<br><br>```sh<br>BUFR_LIB = -L/home/wpsze/mpas_jedi_tutorial/NCEPLIBS-bufr/build/lib -lbufr<br><span class="hljs-built_in">export</span> NETCDF=/home/wpsze/spack-stack/envs/jedi_gcc_linux/install/gcc/9.4.0/netcdf-fortran-4.6.0-gwqak4i/<br><span class="hljs-built_in">export</span> NETCDF=/home/wpsze/micromamba/envs/obs2ioda/x86_64-conda-linux-gnu/<br></code></pre></td></tr></table></figure><p>Then compile the converter by using make command:</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sh">$ <span class="hljs-built_in">cd</span> obs2ioda/obs2ioda-v2/src/<br>$ make<br><span class="hljs-comment"># $ make clean</span><br></code></pre></td></tr></table></figure><p>If the compilation is successful, the executable file <strong>obs2ioda-v2.x</strong> will be generated.</p><h4 id="error-1">Error 1</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs sh">hsd.f90:306:11:<br><br>  306 |       <span class="hljs-keyword">if</span> ( fexist(ij) == .<span class="hljs-literal">false</span>. ) <span class="hljs-keyword">then</span><br>      |           1<br>Error: Logicals at (1) must be compared with .eqv. instead of ==<br>make: *** [Makefile:67: hsd.o] Error 1<br></code></pre></td></tr></table></figure><p>check, and then replace with "eqv"</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sh">$ grep -rin <span class="hljs-string">&quot;==&quot;</span> hsd.f90 <br>306:      <span class="hljs-keyword">if</span> ( fexist(ij) == .<span class="hljs-literal">false</span>. ) <span class="hljs-keyword">then</span><br>...<br></code></pre></td></tr></table></figure><p>to</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh"> $ grep -rin <span class="hljs-string">&quot;eqv&quot;</span> hsd.f90 <br>306:      <span class="hljs-keyword">if</span> ( fexist(ij) .eqv. .<span class="hljs-literal">false</span>. ) <span class="hljs-keyword">then</span><br></code></pre></td></tr></table></figure><h4 id="error-2">Error 2</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sh">/usr/bin/ld: cannot find -lbufr<br>collect2: error: ld returned 1 <span class="hljs-built_in">exit</span> status<br>make: *** [Makefile:46: obs2ioda] Error 1<br></code></pre></td></tr></table></figure><p>check,</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh">NCEPLIBS-bufr/build/include/ is bufr_4<br>NCEPLIBS-bufr/build/lib/ is libbufr_4.a<br></code></pre></td></tr></table></figure><h4 id="error-3">Error 3</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">/usr/bin/ld: warning: libnetcdf.so.19, needed by /home/wpsze/spack-stack/envs/jedi_gcc_linux/install/gcc/9.4.0/netcdf-fortran-4.6.0-gwqak4i/lib/libnetcdff.so, may conflict with libnetcdf.so.15<br></code></pre></td></tr></table></figure><p>Export,</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-built_in">export</span> NETCDF=/home/wpsze/spack-stack/envs/jedi_gcc_linux/install/gcc/9.4.0/netcdf-c-4.9.2-yhizvd3/<br><span class="hljs-built_in">export</span> NETCDFF=/home/wpsze/spack-stack/envs/jedi_gcc_linux/install/gcc/9.4.0/netcdf-fortran-4.6.0-gwqak4i/<br></code></pre></td></tr></table></figure><p>and, modify in Makefile</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh">LIBS = -L$(NETCDF)/lib -L$(NETCDFF)/lib -lnetcdff -lnetcdf <span class="hljs-variable">$&#123;BUFR_LIB&#125;</span><br>INCS = -I$(NETCDF)/include -I$(NETCDFF)/include<br></code></pre></td></tr></table></figure><h4 id="error-4">Error 4</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs sh">hsd.o: <span class="hljs-keyword">in</span> <span class="hljs-keyword">function</span> `__ahi_hsd_mod_MOD_hisd_radiance_to_tbb<span class="hljs-string">&#x27;:</span><br><span class="hljs-string">hsd.f90:(.text+0x19ed): relocation truncated to fit: R_X86_64_PC32 against symbol `__ahi_hsd_mod_MOD_header&#x27;</span> defined <span class="hljs-keyword">in</span> .bss section <span class="hljs-keyword">in</span> hsd.o<br>hsd.f90:(.text+0x1a06): relocation truncated to fit: R_X86_64_PC32 against symbol `__ahi_hsd_mod_MOD_header<span class="hljs-string">&#x27; defined in .bss section in hsd.o</span><br><span class="hljs-string">hsd.f90:(.text+0x1a1a): relocation truncated to fit: R_X86_64_PC32 against symbol `__ahi_hsd_mod_MOD_header&#x27;</span> defined <span class="hljs-keyword">in</span> .bss section <span class="hljs-keyword">in</span> hsd.o<br>hsd.f90:(.text+0x1a50): relocation truncated to fit: R_X86_64_PC32 against symbol `__ahi_hsd_mod_MOD_header<span class="hljs-string">&#x27; defined in .bss section in hsd.o</span><br><span class="hljs-string">hsd.f90:(.text+0x1a58): relocation truncated to fit: R_X86_64_PC32 against symbol `__ahi_hsd_mod_MOD_header&#x27;</span> defined <span class="hljs-keyword">in</span> .bss section <span class="hljs-keyword">in</span> hsd.o<br>hsd.f90:(.text+0x1a64): relocation truncated to fit: R_X86_64_PC32 against symbol `__ahi_hsd_mod_MOD_header<span class="hljs-string">&#x27; defined in .bss section in hsd.o</span><br><span class="hljs-string">hsd.f90:(.text+0x1ad1): relocation truncated to fit: R_X86_64_PC32 against symbol `__ahi_hsd_mod_MOD_header&#x27;</span> defined <span class="hljs-keyword">in</span> .bss section <span class="hljs-keyword">in</span> hsd.o<br>hsd.f90:(.text+0x1ad9): relocation truncated to fit: R_X86_64_PC32 against symbol `__ahi_hsd_mod_MOD_header<span class="hljs-string">&#x27; defined in .bss section in hsd.o</span><br><span class="hljs-string">hsd.f90:(.text+0x1aea): relocation truncated to fit: R_X86_64_PC32 against symbol `__ahi_hsd_mod_MOD_header&#x27;</span> defined <span class="hljs-keyword">in</span> .bss section <span class="hljs-keyword">in</span> hsd.o<br>hsd.o: <span class="hljs-keyword">in</span> <span class="hljs-keyword">function</span> `__ahi_hsd_mod_MOD_pixlin_to_lonlat<span class="hljs-string">&#x27;:</span><br><span class="hljs-string">hsd.f90:(.text+0x1eca): relocation truncated to fit: R_X86_64_PC32 against symbol `__ahi_hsd_mod_MOD_header&#x27;</span> defined <span class="hljs-keyword">in</span> .bss section <span class="hljs-keyword">in</span> hsd.o<br>hsd.f90:(.text+0x1eed): additional relocation overflows omitted from the output<br>/usr/bin/ld: failed to convert GOTPCREL relocation; relink with --no-relax<br>collect2: error: ld returned 1 <span class="hljs-built_in">exit</span> status<br>make: *** [Makefile:46: obs2ioda] Error 1<br></code></pre></td></tr></table></figure><p>We use gfortran, <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment">#------------</span><br><span class="hljs-comment">#GNU compiler</span><br><span class="hljs-comment">#------------</span><br>FC = gfortran<br>BUFR_LIB = -L/home/wpsze/mpas_jedi_tutorial/NCEPLIBS-bufr/build/lib -lbufr_4<br><br>FFLAGS = -ffree-line-length-none -mcmodel=medium <br></code></pre></td></tr></table></figure></p><h3 id="finally-modified-makefile">Finally, modified Makefile</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-meta">#! /bin/sh -v</span><br><br><span class="hljs-comment">#------------</span><br><span class="hljs-comment">#GNU compiler</span><br><span class="hljs-comment">#------------</span><br>FC = gfortran<br>BUFR_LIB = -L/home/wpsze/mpas_jedi_tutorial/NCEPLIBS-bufr/build/lib -lbufr_4<br><br>FFLAGS = -ffree-line-length-none -mcmodel=medium <span class="hljs-comment">#-fbacktrace -ggdb -fcheck=bounds,do,mem,pointer -ffpe-trap=invalid,zero,overflow</span><br><br><span class="hljs-comment">#GNU10 = -fallow-argument-mismatch -fallow-invalid-boz</span><br><span class="hljs-comment">#FFLAGS = -mcmodel=medium -fpic -ffree-line-length-none $&#123;GNU10&#125; -fbacktrace -ggdb -fcheck=bounds,do,mem,pointer -ffpe-trap=invalid,zero,overflow</span><br><br><span class="hljs-comment">#GNU10 = #-fallow-argument-mismatch -fallow-invalid-boz</span><br><span class="hljs-comment">#FFLAGS = -ffree-line-length-none $&#123;GNU10&#125; #-fbacktrace -ggdb -fcheck=bounds,do,mem,pointer -ffpe-trap=invalid,zero,overflow</span><br><br><span class="hljs-comment">#--------------</span><br><span class="hljs-comment">#INTEL compiler</span><br><span class="hljs-comment">#--------------</span><br><span class="hljs-comment">#FC = ifort</span><br><span class="hljs-comment">#BUFR_LIB = -L/glade/u/home/hclin/extlib/intel -lbufr</span><br><span class="hljs-comment">#FFLAGS = -mcmodel medium # needed for intel error message &quot;failed to convert GOTPCREL relocation&quot;</span><br><span class="hljs-comment">#BUFR_LIB = -L/home/wpsze/mpas_jedi_tutorial/NCEPLIBS-bufr/build/lib -lbufr</span><br><span class="hljs-comment">#FFLAGS = -mcmodel medium # needed for intel error message &quot;failed to convert GOTPCREL relocation&quot; # -g -traceback -debug all -check all</span><br><br>LIBS = -L$(NETCDF)/lib -L$(NETCDFF)/lib -lnetcdff -lnetcdf <span class="hljs-variable">$&#123;BUFR_LIB&#125;</span><br>INCS = -I$(NETCDF)/include -I$(NETCDFF)/include<br></code></pre></td></tr></table></figure><h1 id="jedi-mpas-test-and-application-files">JEDI-MPAS Test and Application Files</h1><p>https://gdex.ucar.edu/dataset/147b_jcsda.html</p><p>JEDI-MPAS is the interface between the generic components of the Joint Effort for Data assimilation Integration (JEDI) system and the atmospheric core of the Model for Prediction Across Scales (MPAS). The JEDI software package is a unified, innovative data assimilation system for Earth System Prediction. Developed and distributed by UCP’s Joint Center for Satellite Data Assimilation (JCSDA), JEDI is versatile and sophisticated enough for a variety of applications, from operational weather forecasting and atmospheric research on High Performance Computing (HPC), to learning the fundamentals of data assimilation by running idealized toy models on your laptop. The atmospheric component of MPAS is a non-hydrostatic model using an unstructured centroidal Voronoi mesh with smoothly varying resolution for global or regional domains. The primary development partners for MPAS are Los Alamos National Laboratory and the National Center for Atmospheric Research.</p><p>This data set provides example observation files, model backgrounds, and other input files needed to run a variety of JEDI-MPAS applications, including the comprehensive suite of unit tests and example activities that are described in online tutorials. This data set accompanies JEDI-MPAS, version 1.0.0, released 24 September 20.</p><blockquote><p>Wget shell script - Download all files using Wget, preferred for Linux.</p></blockquote><h1 id="specific-issue-cluster">Specific Issue (cluster)</h1><blockquote><p>git-lfs issue Ran patch() for krb5 &amp; error while opening "en_US.mo" for writing: Permission denied</p></blockquote><p>If copy whole <strong>mpas_bundle_v2</strong> (e.g. local PC) that includes <strong>build</strong> and <strong>code</strong> to workstation or cluster,</p><ol type="1"><li>if your workstation/cluster has spack-stack (for jedi-mpas)</li><li>remove build/CMakeCache.txt</li><li>remove build/_deps/mpas_data-subbuild/CMakeCache.txt</li><li>run $ cmake ../code</li><li>it will re-generate your curren config</li></ol><p>Reference error: <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sh">CMake Error: The current CMakeCache.txt directory /xxx/mpas_bundle_v2_temp/build/CMakeCache.txt is different than the directory /home/wpsze/mpas_bundle_v2/build <span class="hljs-built_in">where</span> CMakeCache.txt was created. This may result <span class="hljs-keyword">in</span> binaries being created <span class="hljs-keyword">in</span> the wrong place. If you are not sure, reedit the CMakeCache.txt<br>CMake Error: The <span class="hljs-built_in">source</span> <span class="hljs-string">&quot;/home/wpsze/MPAS/MPAS-MPAS-JEDI/DA-obs2ioda-EM/mpas_bundle_v2_temp/code/CMakeLists.txt&quot;</span> does not match the <span class="hljs-built_in">source</span> <span class="hljs-string">&quot;/home/wpsze/mpas_bundle_v2/code/CMakeLists.txt&quot;</span> used to generate cache.  Re-run cmake with a different <span class="hljs-built_in">source</span> directory.<br>CMake Error: The current CMakeCache.txt directory /xxx/mpas_bundle_v2_temp/build/_deps/mpas_data-subbuild/CMakeCache.txt is different than the directory /home/wpsze/mpas_bundle_v2/build/_deps/mpas_data-subbuild <span class="hljs-built_in">where</span> CMakeCache.txt was created. This may result <span class="hljs-keyword">in</span> binaries being created <span class="hljs-keyword">in</span> the wrong place. If you are not sure, reedit the CMakeCache.txt<br></code></pre></td></tr></table></figure></p><ol type="1"><li><p>config done <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sh">-- Configuring <span class="hljs-keyword">done</span><br>-- Generating <span class="hljs-keyword">done</span><br>-- Build files have been written to: /xxx/mpas_bundle_v2_temp/build<br></code></pre></td></tr></table></figure></p></li><li><p>make -j12 <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">[100%] Built target mpasjedi_variational.x<br></code></pre></td></tr></table></figure></p></li><li><p>cd mpas-jedi &amp; ctest <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs sh">74% tests passed, 12 tests failed out of 47<br><br>Label Time Summary:<br>executable    =  42.47 sec*proc (13 tests)<br>mpasjedi      = 680.81 sec*proc (47 tests)<br>mpi           = 672.80 sec*proc (43 tests)<br>script        = 638.33 sec*proc (34 tests)<br><br>Total Test time (real) = 683.12 sec<br><br>The following tests FAILED:<br> 23 - test_mpasjedi_parameters_bumpcov (Failed)<br> 24 - test_mpasjedi_parameters_bumploc (Failed)<br> 25 - test_mpasjedi_dirac_bumpcov (Failed)<br> 29 - test_mpasjedi_3dvar_bumpcov (Failed)<br> 35 - test_mpasjedi_3dhybrid_bumpcov_bumploc (Failed)<br> 39 - test_mpasjedi_eda_3dhybrid (Failed)<br> 41 - test_mpasjedi_letkf_3dloc_4pe (Failed)<br> 42 - test_mpasjedi_lgetkf_4pe (Failed)<br> 44 - test_mpasjedi_parameters_bumpcov_2pe (Failed)<br> 45 - test_mpasjedi_parameters_bumploc_2pe (Failed)<br> 46 - test_mpasjedi_3dvar_2pe (Failed)<br> 47 - test_mpasjedi_3dhybrid_bumpcov_bumploc_2pe (Failed)<br>Errors <span class="hljs-keyword">while</span> running CTest<br>Output from these tests are <span class="hljs-keyword">in</span>: /xxx/build/mpas-jedi/Testing/Temporary/LastTest.<span class="hljs-built_in">log</span><br>Use <span class="hljs-string">&quot;--rerun-failed --output-on-failure&quot;</span> to re-run the failed cases verbosely.<br></code></pre></td></tr></table></figure></p></li></ol><h1 id="if-git-lfs-exists">if git-lfs exists,</h1><p>Assume your workstation or cluster already has git-lfs, then may skip the error on it. Try below,</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-built_in">set</span> -v<br><span class="hljs-built_in">source</span> /home/wpsze/spack/share/spack/setup-env.sh<br><span class="hljs-built_in">source</span> /home/wpsze/spack-stack/spack-stack/setup.sh<br><br>spack stack create <span class="hljs-built_in">env</span> --site linux.default --name gcc_mpich<br><br>spack <span class="hljs-built_in">env</span> activate /home/wpsze/spack-stack/spack-stack/envs/gcc_mpich<br>spack add gcc@10.5.0<br>spack install<br>spack compiler add `spack location -i gcc@10.5.0`<br><br>spack add environment-modules%gcc@10.5.0 ecbuild%gcc@10.5.0 eigen%gcc@10.5.0 udunits%gcc@10.5.0 gsl-lite%gcc@10.5.0<br>spack add mpich%gcc@10.5.0<br>spack add hdf5%gcc@10.5.0^mpich parallelio%gcc@10.5.0^mpich <br><br><span class="hljs-comment"># Tried atlas v0.31.1 can make successful compilation. Newer version like 0.35.0 fails.</span><br>spack add ecmwf-atlas@0.31.1%gcc@10.5.0^mpich<br>spack install<br>spack module tcl refresh<br><span class="hljs-comment">#spack stack setup-meta-modules</span><br></code></pre></td></tr></table></figure><h1 id="module-load">module load</h1><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-function"><span class="hljs-title">module</span></span> () &#123;<br>  <span class="hljs-built_in">eval</span> $(<span class="hljs-variable">$&#123;SPACK_ENV&#125;</span>/install/gcc/x.x.x/environment-modules-xxx/bin/modulecmd bash <span class="hljs-variable">$@</span>)<br>&#125;<br><br>module load xxx<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>Spack</category>
      
    </categories>
    
    
    <tags>
      
      <tag>MPAS</tag>
      
      <tag>DA</tag>
      
      <tag>Spack</tag>
      
      <tag>Spack-Stack</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ecFlow -- Installation &amp; Usage</title>
    <link href="/2024/06/07/ecflow/"/>
    <url>/2024/06/07/ecflow/</url>
    
    <content type="html"><![CDATA[<h1 id="by-micromamba-recommend">By micromamba (Recommend)</h1><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs sh">$ micromamba create -n ecFlow<br>Empty environment created at prefix: /home/wpsze/micromamba/envs/ecFlow<br>$ micromamba activate ecFlow<br>|ecFlow|wpsze:/home/wpsze $ micromamba install ecflow -c conda-forge<br>|ecFlow|wpsze:/home/wpsze $ ecflow_client --version<br>Ecflow version(5.13.0) boost(1.84.0) compiler(gcc 12.3.0) protocol(JSON cereal 1.3.0) openssl(enabled) Compiled on Jun 20 2024 08:28:01<br><br> $ ecf*<br>ecflow_client        ecflow_http          ecflow_logsvr.pl     ecflow_standalone    ecflow_stop.sh       <br>ecflow_udp_client    ecflow_ui.x<br>ecflow_fuse.py       ecflow_logserver.sh  ecflow_server        <br>ecflow_start.sh      ecflow_udp           ecflow_ui<br></code></pre></td></tr></table></figure><p>and it installs,</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sh">+ libboost-python                  1.84.0  py312h389efb2_3      conda-forge      124kB<br>+ libboost-python-devel            1.84.0  py312h9cebb41_3      conda-forge       20kB<br>+ ecflow                           5.13.0  py312hc3ad225_0      conda-forge       17MB<br></code></pre></td></tr></table></figure><p>where boost is 1.84.0</p><h1 id="ecflow-quickstart">ecFlow Quickstart</h1><p><a href="https://confluence.ecmwf.int/display/ECFLOW/ecFlow+Quickstart">ecFlow Quickstart</a></p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs sh"> $ ll ./ecflow_quickstart  <br>total 160K<br>drwxrwxr-x 3 wpsze wpsze  33K Jun  7 22:06 ./<br>drwxrwxr-x 3 wpsze wpsze  33K Jun  7 22:06 ../<br>-rw-rw-r-- 1 wpsze wpsze 2.4K Jun  7 17:51 ecflow_quickstart.tar.gz<br>-rw-r--r-- 1 wpsze wpsze 1.8K Nov  2  2022 head.h<br>-rw-r--r-- 1 wpsze wpsze  760 Nov  2  2022 instructions.txt<br>-rw-r--r-- 1 wpsze wpsze  209 Nov  1  2022 tail.h<br>drwxr-xr-x 2 wpsze wpsze  33K Nov  2  2022 <span class="hljs-built_in">test</span>/<br>-rw-r--r-- 1 wpsze wpsze  222 Nov  2  2022 test.def<br><br> $ ll <span class="hljs-built_in">test</span><br>total 165K<br>drwxr-xr-x 2 wpsze wpsze  33K Nov  2  2022 ./<br>drwxrwxr-x 3 wpsze wpsze  33K Jun  7 22:06 ../<br>-rw-r--r-- 1 wpsze wpsze  627 Nov  2  2022 t1.1<br>-rw-r--r-- 1 wpsze wpsze  877 Nov  2  2022 t1.2<br>-rw-r--r-- 1 wpsze wpsze  119 Nov  2  2022 t1.ecf<br>-rwxr-xr-x 1 wpsze wpsze 2.1K Nov  2  2022 t1.job1*<br>-rwxr-xr-x 1 wpsze wpsze 2.1K Nov  2  2022 t1.job2*<br>-rw-r--r-- 1 wpsze wpsze  627 Nov  2  2022 t2.1<br>-rw-r--r-- 1 wpsze wpsze  118 Nov  2  2022 t2.ecf<br>-rwxr-xr-x 1 wpsze wpsze 2.1K Nov  2  2022 t2.job1*<br><br> $ <span class="hljs-built_in">cat</span> <span class="hljs-built_in">test</span>/t1.ecf <br>%include <span class="hljs-string">&quot;../head.h&quot;</span><br><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;I, %ECF_NAME%, am part of a suite that lives in %ECF_HOME%&quot;</span><br><span class="hljs-built_in">sleep</span> 2<br><br>%include <span class="hljs-string">&quot;../tail.h&quot;</span><br><br> $ <span class="hljs-built_in">cat</span> <span class="hljs-built_in">test</span>/t2.ecf <br>%include <span class="hljs-string">&quot;../head.h&quot;</span><br><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;I, %ECF_NAME%, am part of a suite that lives in %ECF_HOME%&quot;</span><br><span class="hljs-built_in">sleep</span> 2<br><br>%include <span class="hljs-string">&quot;../tail.h&quot;</span><br></code></pre></td></tr></table></figure><h2 id="inspect-and-update-the-suite-definition">Inspect and update the suite definition</h2><p>The file <strong>test.def</strong> defines a suite called "test". Open this file in a text editor and note the structure.</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs sh">suite <span class="hljs-built_in">test</span><br>   edit ECF_HOME <span class="hljs-string">&quot;/replace/with/own/home/ecflow/quickstart&quot;</span><br>   task t1<br>   task t2<br>        trigger t1 eq complete<br>endsuite<br></code></pre></td></tr></table></figure><p>We define a suite called "test"; it defines a variable called <strong>ECF_HOME</strong>, then it defines two tasks <strong>("tasks" are things that actually run)</strong> and specifies that <strong>task t2 will be run as soon as task t1 has completed</strong>. The scripts corresponding to the tasks are specified in <strong>".ecf"</strong> files in the test directory. Have a look - they simply print some information about themselves, then sleep for 2 seconds.</p><p>The first thing you must do is to complete the path to your working directory in the <strong>ECF_HOME</strong> definition in test.def and save the file.</p><h2 id="start-an-ecflow-server">Start an ecFlow server</h2><p>We will start a <strong>new running instance of an ecFlow server using the default port (# start ecFlow with default port 3141)</strong>. It is possible to use a different port by <strong>adding --port=3500 (for example)</strong> to every ecFlow command-line action. Note also that we start it as a background task - it will run until the server is stopped. It can be run in the foreground, but in that case you will need to use a new terminal for any subsequent commands!</p><p>To start the ecflow server:</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs sh">$ ecflow_server &amp;<br>or<br>$ <span class="hljs-built_in">export</span> ECF_PORT=3141<br>$ ecflow_start.sh -d /home/wpsze/xxx -p <span class="hljs-variable">$ECF_PORT</span><br></code></pre></td></tr></table></figure><p><strong>make sure this port can be used</strong> {:.info}</p><h3 id="check-what-port-numbers-are-being-used">check what port numbers are being used</h3><h3 id="netstat--lnptu">netstat -lnptu</h3><p>You can check what port numbers are being used, with netstat: To list all open network ports on your machine, run <strong>netstat -lnptu</strong>. Here is a breakdown of the parameters:</p><p>l - List all listening ports n - Display the numeric IP addresses (i.e., don't do reverse DNS lookups p - List the process name that is attached to that port t - List all TCP connections u - List all UDP connections</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh">$ netstat -lnptu<br>tcp        0      0 0.0.0.0:3141            0.0.0.0:*               LISTEN      169655/ecflow_serve<br></code></pre></td></tr></table></figure><p>Check that it is running:</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh">$ ecflow_client --ping --port=3141<br>ping server(localhost:3141) succeeded <span class="hljs-keyword">in</span> 00:00:00.034207  ~34 milliseconds<br></code></pre></td></tr></table></figure><p>or check</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh"> $ ps -u wpsze -f | grep ecflow | grep -v grep<br>wpsze    3248171 3700943  0 14:26 pts/6    00:00:00 ecflow_server<br></code></pre></td></tr></table></figure><p>Please note <strong>“Host”</strong> and <strong>“Port Number”</strong> here. Also note that each user must use a unique port number (we recommend using a random number between 2500 and 9999)</p><p>To stop the ecflow server:</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">ecflow_stop.sh -p <span class="hljs-variable">$ECF_PORT</span><br></code></pre></td></tr></table></figure><p>e.g.</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs sh"> $ ecflow_stop.sh -p 3141<br>Fri Jun 28 08:57:33 UTC 2024<br><br>User <span class="hljs-string">&quot;10004&quot;</span> attempting to stop ecf server on ip:3141<br><br>Checking <span class="hljs-keyword">if</span> the server is running on ip:3141<br>ping server(ip:3141) succeeded <span class="hljs-keyword">in</span> 00:00:00.011797  ~11 milliseconds<br><br>Halting, check pointing and terminating the server<br>[1]+  Done                    ecflow_server<br></code></pre></td></tr></table></figure><p>and then,</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">$ ps -u wpsze -f | grep ecflow | grep -v grep<br></code></pre></td></tr></table></figure><p>has shown nothing now.</p><h2 id="load-your-suite-definition-into-the-server">Load your suite definition into the server **</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">$ ecflow_client --load=test.def --port=3141<br></code></pre></td></tr></table></figure><p>More, <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs sh">ecflow_client --<span class="hljs-built_in">help</span><br>ecflow_client --load=/my/home/fred.def<br>ecflow_client --load=/my/home/exotic.def            <span class="hljs-comment"># will error if suites of same name exists</span><br>ecflow_client --load=/my/home/exotic.def force      <span class="hljs-comment"># overwrite suite&#x27;s of same name in the server</span><br>ecflow_client --load=/my/home/exotic.def check_only <span class="hljs-comment"># Just check, don&#x27;t send to server</span><br>ecflow_client --load=/my/home/exotic.def stats      <span class="hljs-comment"># Show defs statistics, don&#x27;t send to server</span><br>ecflow_client --load=host1.3141.check               <span class="hljs-comment"># Load checkpoint file to the server</span><br>ecflow_client --load=host1.3141.check <span class="hljs-built_in">print</span>         <span class="hljs-comment"># print definition to standard out in defs format</span><br></code></pre></td></tr></table></figure></p><p>Check that it is loaded by asking the server to give you back the suite definition:</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs sh">$ ecflow_client --get --port=3141<br><span class="hljs-comment">#5.11.4</span><br>suite <span class="hljs-built_in">test</span><br>  edit ECF_HOME <span class="hljs-string">&#x27;/home/wpsze/ecflow/ecflow_quickstart/&#x27;</span><br>  task t1<br>  task t2<br>    trigger t1 eq complete<br>endsuite<br><span class="hljs-comment"># enddef</span><br></code></pre></td></tr></table></figure><h2 id="monitor-and-interact-via-the-gui">Monitor and interact via the GUI</h2><h3 id="start-ecflowui-local-pc">Start ecFlowUI: (Local PC)</h3><p>When opening the ecflow GUI flow for the first time you will need to add your server to the GUI. In the GUI click on <strong>“Servers” and then “Manage servers”</strong>. A new window will appear. Click on <strong>“Add server”. Here you need to add the Name, Host, and Port of your server</strong>. For “Host” and “Port” please refer to the last section of output from the previous step.</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">$ ecflow_ui &amp;<br></code></pre></td></tr></table></figure><h3 id="ssh-tunnel">ssh tunnel</h3><p>SSH tunneling, or SSH port forwarding, is a method of transporting arbitrary data over an encrypted SSH connection. SSH tunnels allow connections made to a local port (that is, to a port on your own desktop) to be forwarded to a remote machine via a secure channel.</p><p>on local PC terminal, <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh">$ ssh -L 9090:localhost:3141 server.ip<br>$ ssh -NL 9090:localhost:3141 server.ip<br></code></pre></td></tr></table></figure> where local PC's port 9090 to server.ip's port 3141</p><p>and you can set ecflow_ui config, - host=localhost - port=local PC's port 9090</p><h3 id="ecflowui-has-started">ecFlowUI has started</h3><p>Once ecFlowUI has started, you must tell it how to reach your server. Go to the</p><p>Servers → Manage Servers menu, click "Add server", then enter the details of your server. Name can be anything you want - it's for you to identify the server to your self; something like "localtest" would be fine here. Host should in this case be "localhost", and Port should be XXX. The other fields can be left blank, but keep the "Add server to current view" box ticked.</p><p>You should now see your suite loaded into the GUI! To make the server active, right-click on the top-level node representing the server ("localtest in our case) and choose <strong>"Restart"</strong>. Now right-click on the "test" node and <strong>choose "Begin"</strong> to make the suite active. The default behaviour is to only refresh its view of the suite every 60 seconds, so you will need to click the green refresh button at the top every so often to see the progress of the tasks.</p><figure><img src="https://confluence.ecmwf.int/download/attachments/52464709/worddavd23273b6552a14558257676bb73f41be.png?version=1&amp;modificationDate=1448363109499&amp;api=v2" alt="ecflow-ui_Task" /><figcaption>ecflow-ui_Task</figcaption></figure><p>The diagram shows the typical status changes for a Task.</p><h2 id="start">Start</h2><p>At this time, the service is stopped and needs to be started manually.</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-variable">$ecflow_client</span> --begin --host=login05 --port=3141<br></code></pre></td></tr></table></figure><p>Since no triggering mechanism is added, t1 will be executed immediately after the service starts.</p><h2 id="replace-suite">Replace suite</h2><p>Replace the entire suite, <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">ecflow_client --replace=/test test.def --port=3141<br></code></pre></td></tr></table></figure></p><h2 id="check-the-status-of-the-server">check the status of the server</h2><p>To check the status of the server, enter the following unix command <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs sh">ecflow_client --host=login05 --port=3141 --stats<br>Server statistics<br>   Version                         Ecflow version(5.13.0) boost(1.84.0) compiler(gcc 12.3.0) protocol(JSON cereal 1.3.0) openssl(enabled) Compiled on Jun 20 2024 08:28:01<br>   Status                          RUNNING<br>   Host                            xxx.com<br>   Port                            3141<br>   Up since                        2024-Jul-02 23:44:29<br>......<br></code></pre></td></tr></table></figure> If ecflow_server is in <strong>halted state</strong>, the server needs to be restarted.</p><h2 id="ecflow-variables">ecFlow variables</h2><p><a href="https://confluence.ecmwf.int/display/ECFLOW/ecFlow++variables">ecFlow variables</a></p><blockquote><p>ECF_HOME ECF_INCLUDE ECF_FILES</p></blockquote><h2 id="execute-rerun-requeue">Execute, rerun, requeue</h2><p>In ecflow_ui, it is important to understand the distinction between execute, rerun and re-queue.</p><p>These options are available with the right mouse button over a task.</p><blockquote><p><strong>Execute</strong>: This means run the task immediately. (Hence ignores any dependency that holds the task).</p></blockquote><p>This option preserves the previous output, from the job. You should see output files t1.1, t1.2, t1.3, each time the task is run.</p><blockquote><p><strong>Rerun</strong>: This places the task, back into the queued state.</p></blockquote><p>The task will now honour any dependencies that would hold the job. i.e. time dependencies, limits, triggers, suspend, etc. (You will be introduced to these terms later on in the tutorial) If the task does run, the previous output is preserved.</p><blockquote><p><strong>Re-queue</strong>: This resets the task back to the queued state.</p></blockquote><p>If the task has a default status, this is applied. The task output number is reset, such that the next output will be written to t1.1. This will overwrite any existing output with that extension when the task runs. Any subsequent calls to execute or rerun will now overwrite the output files, t1.2,t1.3 etc.</p><h2 id="add-description">Add description</h2><p>The manual page makes the documentation in the <strong>ecf script</strong> visible in ecflow_ui.</p><p>The description page is the combination of all the text before the directives <strong>%manual</strong> and <strong>%end</strong>. (or create <strong>f1.man</strong>)</p><p>e.g. edit t2.ecf <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs sh">%manual<br>   Manual <span class="hljs-keyword">for</span> task t2<br>   Operations: <span class="hljs-keyword">if</span> this task fails, <span class="hljs-built_in">set</span> it to complete and report next working day<br>   Analyst:    Check something ?<br>%end<br> <br>%include &lt;head.h&gt;<br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;I am part of a suite that lives in %ECF_HOME%&quot;</span><br>%include &lt;tail.h&gt;<br> <br>%manual<br>   There can be multiple manual pages <span class="hljs-keyword">in</span> the same file.<br>   When viewed they are simply concatenated.<br>%end<br></code></pre></td></tr></table></figure></p><h2 id="familys">familys</h2><p>Tasks can be organized into a tree structure similar to a Unix file system, where <strong>task is like a file</strong> and <strong>family is like a folder</strong>.</p><p>A suite is a family with additional properties (see Dates). <strong>family</strong> can contain other families. Similar to directories, tasks in different families can have the same name.</p><p>Unless a file location is specified, ecFlow assumes that the structure of the suite corresponds to the location of the task file in the file system.</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># Definition of the suite test.</span><br> suite <span class="hljs-built_in">test</span><br>   edit ECF_INCLUDE <span class="hljs-string">&quot;<span class="hljs-variable">$ECF_HOME</span>/course&quot;</span>  <span class="hljs-comment"># replace &#x27;$ECF_HOME&#x27; with the path to your ECF_HOME directory</span><br>   edit ECF_HOME    <span class="hljs-string">&quot;<span class="hljs-variable">$ECF_HOME</span>/course&quot;</span><br>   family f1<br>      task t1<br>      task t2<br>   endfamily<br>endsuite<br></code></pre></td></tr></table></figure><h2 id="time-dependencies">Time Dependencies</h2><p><a href="https://confluence.ecmwf.int/display/ECFLOW/Time+Dependencies">Time Dependencies</a></p><h2 id="time-triggers">Time Triggers</h2><p><a href="https://confluence.ecmwf.int/display/ECFLOW/Time+Triggers">Time Triggers</a></p><h2 id="add-a-cron">Add a Cron</h2><p><a href="https://confluence.ecmwf.int/display/ECFLOW/Add+a+Cron">Add a Cron</a></p><h2 id="repeat-repeat">Repeat *** <a href="https://confluence.ecmwf.int/display/ECFLOW/Repeat">Repeat</a></h2><p>It is sometimes useful to repeat the same task or family several times, looping on a specific value. You can do that by defining a repeat attribute. You can iterate over sequences of:</p><ul><li>strings</li><li>integers</li><li>dates</li></ul><p>A sequence of integers or dates is created by specifying the first and the last element, with an optional increment (the default is one).</p><p>From <strong>ecflow5 we can also loop over an arbitrary list of dates</strong>. <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh">repeat datelist YMD 20130101 20130102 20130103 20200101 20190101<br>repeat <span class="hljs-built_in">date</span> YMD 20090331 20121212 1  <span class="hljs-comment"># &lt;start&gt; &lt;end&gt; &lt;increment&gt;</span><br></code></pre></td></tr></table></figure></p><blockquote><p>The following generated variables, are accessible for trigger expressions YMD, YMD_YYYY, YMD_MM, YMD_DD, YMD_DOW,YMD_JULIAN</p></blockquote><p>e.g. <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs sh"><br><span class="hljs-comment"># Definition of the suite test.</span><br>suite <span class="hljs-built_in">test</span><br> edit ECF_INCLUDE <span class="hljs-string">&quot;<span class="hljs-variable">$HOME</span>/course&quot;</span><br> edit ECF_HOME    <span class="hljs-string">&quot;<span class="hljs-variable">$HOME</span>/course&quot;</span><br> family f4<br>     edit SLEEP 2<br>     repeat string NAME a b c d e f<br>     family f5<br>         repeat <span class="hljs-built_in">integer</span> VALUE 1 10<br>         task t1<br>             repeat <span class="hljs-built_in">date</span> DATE 20101230 20110105<br>             label info <span class="hljs-string">&quot;&quot;</span><br>             label <span class="hljs-built_in">date</span> <span class="hljs-string">&quot;&quot;</span><br>     endfamily<br> endfamily<br>endsuite<br></code></pre></td></tr></table></figure></p><p><a href="https://confluence.ecmwf.int/display/ECFLOW/Glossary#term-trigger">repeat &amp; trigger</a></p><p>When we use relative time attributes under a Repeat. They are automatically reset when the repeat loops. Take for example: <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs sh">suite <span class="hljs-built_in">test</span><br> edit ECF_HOME    <span class="hljs-string">&quot;<span class="hljs-variable">$HOME</span>/course&quot;</span><br> edit ECF_INCLUDE <span class="hljs-string">&quot;<span class="hljs-variable">$HOME</span>/course&quot;</span><br> edit ECF_FILES <span class="hljs-string">&quot;<span class="hljs-variable">$HOME</span>/course&quot;</span><br>  family hc00<br>    repeat <span class="hljs-built_in">integer</span> HYEAR 1993 2017<br>    task t1<br>    task t2<br>      trigger t1  == complete<br>  endfamily<br>endsuite<br></code></pre></td></tr></table></figure></p><p><strong>Repeat increment</strong></p><p>A repeat under a family node will only increment when all the child nodes are complete.</p><p>In the example above, <strong>once task t1, and t2 are complete</strong>, the repeat integer rep will increment to the next value.</p><h2 id="with-sbatch">with SBATCH</h2><p>sbatch.h <figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c++">#SBATCH --qos=%QUEUE%<br>#SBATCH --job-name=%TASK%_%FAMILY1:NOT_DEF%<br>#SBATCH --account=%ACCOUNT%<br>#SBATCH --output=%ECF_JOBOUT%<br>#SBATCH --error=%ECF_JOBOUT%<br>#SBATCH --time=%RQ_TIME%<br></code></pre></td></tr></table></figure></p><h1 id="references">References</h1><ol type="1"><li><a href="https://perillaroc.github.io/ecflow-tutorial-cn/chap01/">ECFLOW教程 2018</a></li><li><strong><a href="https://cemc-ecflow-tutorial-2023.readthedocs.io/zh-cn/latest/">CEMC ecFlow 实战教程 本教程用于 CEMC 2023 培训的 ecFlow 上机实习环节</a></strong></li><li><a href="https://confluence.ecmwf.int/display/ECFLOW/Conda-forge">The latest ecflow is available for Linux and macOS from conda forge</a></li><li><a href="https://git.ecmwf.int/projects/USS">https://git.ecmwf.int/projects/USS</a></li><li><a href="https://confluence.ecmwf.int/display/UDOC/HPC2020%3A+Using+ecFlow">HPC2020: Using ecFlow</a></li><li><a href="http://qxkj.ijournals.cn/qxkj/article/abstract/20190122">基于ECFLOW实现华中区域快速更新-同化预报业务流程</a></li><li><a href="https://mp.weixin.qq.com/s/d17lDCd7f2_hS0S4E1mgTg">ecFlow学习笔记：编译V5.X版本</a></li></ol>]]></content>
    
    
    <categories>
      
      <category>MPAS</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Installation</tag>
      
      <tag>Micromamba</tag>
      
      <tag>Spack</tag>
      
      <tag>ecFlow</tag>
      
      <tag>Conda</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Spack</title>
    <link href="/2024/06/07/spack/"/>
    <url>/2024/06/07/spack/</url>
    
    <content type="html"><![CDATA[<h1 id="spack">Spack</h1><p><strong>Spack</strong> is a package management tool designed to support multiple versions and configurations of software on a wide variety of platforms and environments. It was designed for large supercomputing centers, where many users and application teams share common installations of software on clusters with exotic architectures, using libraries that do not have a standard ABI. Spack is non-destructive: installing a new version does not break existing installations, so many configurations can coexist on the same system. Most importantly, Spack is simple. It offers a simple spec syntax so that users can specify versions and configuration options concisely. Spack is also simple for package authors: package files are written in pure Python, and specs allow package authors to maintain a single file for many different builds of the same package.</p><p><a href="https://spack.readthedocs.io/en/latest/" class="uri">https://spack.readthedocs.io/en/latest/</a></p><h2 id="search-packages-online">Search packages online</h2><blockquote><p><a href="https://packages.spack.io/" class="uri">https://packages.spack.io/</a></p></blockquote><h1 id="installation">Installation</h1><p>Getting Spack is easy. You can clone it from the github repository using this command:</p><p>git clone -c feature.manyFiles=true https://github.com/spack/spack.git {:.info}</p><p>This will create a directory called spack.</p><p>Once you have cloned Spack, we recommend sourcing the appropriate script for your shell:</p><p>. spack/share/spack/setup-env.sh {:.info}</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs sh">For bash/zsh/sh<br>. spack/share/spack/setup-env.sh<br>(add into .bashrc)<br>For tcsh/csh<br><span class="hljs-built_in">source</span> spack/share/spack/setup-env.csh<br></code></pre></td></tr></table></figure><p>Sourcing these files will put the spack command in your PATH, set up your MODULEPATH to use Spack’s packages, and add other useful shell integration for certain commands, environments, and modules. For bash and zsh, it also sets up tab completion.</p><ul><li>spack env create yourEnvironmentName</li><li>spack env activate yourEnvironmentName</li><li>spack env list # You can see a list of your available environments</li><li>spack env status # you can see which environment you are currently<br /></li><li>spack env deactivate</li><li>spack find # to see what packages are installed in the current environment</li><li>spack add python@3.10</li><li>spack add compilerName@compilerVersion</li><li>spack install --add xxx</li><li>compilerPath=$(spack location -i compilerName@compilerVersion)</li><li>spack add python@3.10%gcc@9.5.0 # As a general rule, you should use the same compiler for installing all of your packages within an environment</li><li>spack env remove yourEnvironmentName</li></ul><h1 id="compiler-configuration">Compiler configuration</h1><p>Spack has the ability to build packages with multiple compilers and compiler versions. Compilers can be made available to Spack by specifying them manually in <strong>compilers.yaml</strong> or <strong>packages.yaml</strong>, or automatically by running spack compiler find, but for convenience Spack will automatically detect compilers the first time it needs them.</p><p>You can see which compilers are available to Spack by running</p><p>spack compilers or spack compiler list {:.info}</p><blockquote><p>Any of these compilers can be used to build Spack packages.</p></blockquote><p>spack compiler add {:.info}</p><p>An alias for <strong>spack compiler find</strong>.</p><p>spack compiler find {:.info}</p><p>Lists the compilers currently available to Spack. If you do not see a compiler in this list, but you want to use it with Spack, you can simply run spack compiler find with the path to where the compiler is installed. For example:</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sh">$ spack compiler find /usr/local/tools/ic-13.0.079<br>==&gt; Added 1 new compiler to ~/.spack/linux/compilers.yaml<br>    intel@13.0.079<br></code></pre></td></tr></table></figure><p>Or you can run spack compiler find with no arguments to force auto-detection. This is useful if you do not know where compilers are installed, but you know that new compilers have been added to your PATH. For example, you might load a module, like this:</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs sh">$ module load gcc/4.9.0<br>$ spack compiler find<br>==&gt; Added 1 new compiler to ~/.spack/linux/compilers.yaml<br>    gcc@4.9.0<br></code></pre></td></tr></table></figure><p>This loads the environment module for gcc-4.9.0 to add it to PATH, and then it adds the compiler to Spack.</p><p>spack compiler info {:.info}</p><p>If you want to see specifics on a particular compiler, you can run spack compiler info on it:</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs sh">$ spack compiler info intel@15<br>intel@15.0.0:<br>  paths:<br>    cc  = /usr/local/bin/icc-15.0.090<br>    cxx = /usr/local/bin/icpc-15.0.090<br>    f77 = /usr/local/bin/ifort-15.0.090<br>    <span class="hljs-built_in">fc</span>  = /usr/local/bin/ifort-15.0.090<br>  modules = []<br>  operating_system = centos6<br></code></pre></td></tr></table></figure><p>This shows which C, C++, and Fortran compilers were detected by Spack. Notice also that we didn’t have to be too specific about the version. We just said intel@15, and information about the only matching Intel compiler was displayed.</p><h2 id="manual-compiler-configuration">Manual compiler configuration</h2><p>If auto-detection fails, you can manually configure a compiler by editing your <strong>~/.spack/<platform>/compilers.yaml file</strong>. You can do this by running <strong>spack config edit compilers</strong>, which will open the file in your favorite editor.</p><h2 id="build-your-own-compiler">Build Your Own Compiler</h2><p>If you are particular about which compiler/version you use, you might wish to have Spack build it for you. For example:</p><blockquote><p>$ spack install gcc@4.9.3</p></blockquote><p>Once that has finished, you will need to add it to your <strong>compilers.yaml</strong> file.</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sh">spack add gcc@4.9.3<br>spack install<br>spack compiler add `spack location -i gcc@4.9.3`<br></code></pre></td></tr></table></figure><p>You can then set Spack to use it by default by adding the following to your packages.yaml file:</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sh">packages:<br>  all:<br>    compiler: [gcc@4.9.3]<br></code></pre></td></tr></table></figure><h1 id="specs-dependencies">Specs &amp; dependencies</h1><p>We know that <strong>spack install</strong>, <strong>spack uninstall</strong>, and other commands take a package name with an optional version specifier. In Spack, that descriptor is called a spec. Spack uses specs to refer to a particular build configuration (or configurations) of a package. Specs are more than a package name and a version; you can use them to specify the compiler, compiler version, architecture, compile options, and dependency options for a build. In this section, we’ll go over the full syntax of specs.</p><p>Here is an example of a much longer spec than we’ve seen thus far:</p><blockquote><p>mpileaks <span class="citation" data-cites="1.2:1.4">@1.2:1.4</span> %gcc@4.7.5 +debug -qt target=x86_64 ^callpath <span class="citation" data-cites="1.1">@1.1</span> %gcc@4.7.2</p></blockquote><p>If provided to spack install, this will install the mpileaks library at <strong>some version between 1.2 and 1.4 (inclusive)</strong>, built using <strong>gcc at version 4.7.5</strong> for a generic x86_64 architecture, with <strong>debug options enabled</strong>, and <strong>without Qt support</strong>. Additionally, it says to link it with the <strong>callpath library (which it depends on)</strong>, and to <strong>build callpath with gcc 4.7.2</strong>. Most specs will not be as complicated as this one, but this is a good example of what is possible with specs.</p><p>More formally, a spec consists of the following pieces:</p><ul><li>Package name identifier (mpileaks above)</li><li>@ Optional version specifier (<span class="citation" data-cites="1.2:1.4">@1.2:1.4</span>)</li><li>% Optional compiler specifier, with an optional compiler version (gcc or gcc@4.7.3)</li><li>+ or - or ~ Optional variant specifiers (+debug, -qt, or ~qt) for boolean variants. Use ++ or -- or ~~ to propagate variants through the dependencies (++debug, --qt, or ~~qt).</li><li>name=<value> Optional variant specifiers that are not restricted to boolean variants. Use name==<value> to propagate variant through the dependencies.</li><li>name=<value> Optional compiler flag specifiers. Valid flag names are cflags, cxxflags, fflags, cppflags, ldflags, and ldlibs. Use name==<value> to propagate compiler flags through the dependencies.</li><li>target=&lt;value&gt; os=&lt;value&gt; Optional architecture specifier (target=haswell os=CNL10)</li><li>^ Dependency specs (^callpath@1.1)</li></ul><p>套件表示法 @ 開頭表示版本號 % 開頭表示編譯器 ^ 開頭表示依賴項</p><h1 id="spack-load">Spack load</h1><p>There are several different ways to use Spack packages once you have installed them. As you’ve seen, spack packages are installed into long paths with hashes, and you need a way to get them into your path. The easiest way is to use <strong>spack load</strong>, which is described in this section.</p><blockquote><p>spack load mpich %gcc@4.4.7</p></blockquote><h1 id="slurm">Slurm</h1><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-meta">#!/bin/sh</span><br><span class="hljs-comment"># This file is called submit-script.sh</span><br><span class="hljs-comment">#SBATCH --partition=shared       # default &quot;shared&quot;, if not specified</span><br><span class="hljs-comment">#SBATCH --time=0-04:30:00        # run time in days-hh:mm:ss</span><br><span class="hljs-comment">#SBATCH --nodes=1                # require 1 nodes</span><br><span class="hljs-comment">#SBATCH --ntasks-per-node=64     # cpus per node (by default, &quot;ntasks&quot;=&quot;cpus&quot;)</span><br><span class="hljs-comment">#SBATCH --mem-per-cpu=4000       # RAM per node in megabytes</span><br><span class="hljs-comment">#SBATCH --error=job.%J.err</span><br><span class="hljs-comment">#SBATCH --output=job.%J.out</span><br><span class="hljs-comment"># v---Remember to activate your Spack environment!! </span><br>spack <span class="hljs-built_in">env</span> activate yourEnvironmentName<br>srun --mpi=pmix -n 64 /home/username/mpiprogram<br></code></pre></td></tr></table></figure><h1 id="references">References</h1><ol type="1"><li><a href="https://hackmd.io/@William-Mou/spack_command">Spack 指令教學</a></li></ol>]]></content>
    
    
    <categories>
      
      <category>Spack</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Spack</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>WRF | WRF uses Pnetcdf</title>
    <link href="/2024/06/05/WRF-install-pnetcdf/"/>
    <url>/2024/06/05/WRF-install-pnetcdf/</url>
    
    <content type="html"><![CDATA[<h1 id="issue">Issue</h1><p>To Be Tested.</p><h1 id="remark">Remark</h1><ol type="1"><li><p><a href="https://forum.mmm.ucar.edu/threads/parallel-netcdf4-i-o-support-as-opposed-to-pnetcdf.9509/">Parallel Netcdf4 I/O support (as opposed to pnetcdf)</a> &gt; Unfortunately the WRF model is not capable of using parallel I/O. If you are using netCDF-4, you must install it without activating parallel I/O based on HDF5. It is possible to use compression with netcdf-4 and HDF5 (without parallel I/O). See this page for details: https://www2.mmm.ucar.edu/wrf/users/building_netcdf4.html</p></li><li><a href="http://climate-cms.wikis.unsw.edu.au/WRF_Build_with_Parallel_NetCDF_Support">WRF Build with Parallel NetCDF Support</a></li></ol><ul><li>export PNETCDF=/projects/WRF/parallel-netcdf/xxx/ (BASH)</li><li>Configure namelist to use pNetCDF</li></ul><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs sh">In the namelist.input, the following settings support pNetCDF by setting value to 11:<br><br>io_form_boundary<br><br>io_form_history<br><br>io_form_auxinput2<br><br>io_form_auxhist2<br><br>Note that you need <span class="hljs-built_in">set</span> nocolons = .<span class="hljs-literal">true</span>. <span class="hljs-keyword">in</span> the section &amp;time_control of namelist.input<br></code></pre></td></tr></table></figure><ul><li><p>With pNetCDF support:</p><ul><li>Timing for Writing wrfout_d03_2010-02-06_01_00_00 for domain 3: 77.62950 elapsed seconds. Timing for Writing wrfout_d03_2010-02-06_02_00_00 for domain 3: 75.74540 elapsed seconds. Timing for Writing wrfout_d03_2010-02-06_03_00_00 for domain 3: 80.26440 elapsed seconds.</li></ul></li><li>Without pNetCDF support:<ul><li>Timing for Writing wrfout_d03_2010-02-06_01:00:00 for domain 3: 315.81271 elapsed seconds. Timing for Writing wrfout_d03_2010-02-06_02:00:00 for domain 3: 299.80011 elapsed seconds. Timing for Writing wrfout_d03_2010-02-06_03:00:00 for domain 3: 307.18109 elapsed seconds.</li></ul></li></ul>]]></content>
    
    
    <categories>
      
      <category>WRF</category>
      
    </categories>
    
    
    <tags>
      
      <tag>WRF</tag>
      
      <tag>Installation</tag>
      
      <tag>Pnetcdf</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ssh setup</title>
    <link href="/2024/06/05/ssh/"/>
    <url>/2024/06/05/ssh/</url>
    
    <content type="html"><![CDATA[<p><a href="https://en.wikipedia.org/wiki/Secure_Shell">The Secure Shell Protocol (SSH)</a> is a cryptographic network protocol for operating network services securely over an unsecured network. Its most notable applications are remote login and command-line execution.</p><p>SSH was designed for Unix-like operating systems as a replacement for Telnet and unsecured remote Unix shell protocols, such as the Berkeley Remote Shell (rsh) and the related rlogin and rexec protocols, which all use insecure, plaintext methods of authentication, like passwords.</p><p>安全外殼協定（Secure Shell Protocol，簡稱SSH）是一種加密的網路傳輸協定，可在不安全的網路中為網路服務提供安全的傳輸環境[1]。SSH通過在網路中建立安全隧道來實現SSH客戶端與伺服器之間的連線[2]。SSH最常見的用途是遠端登入系統，人們通常利用SSH來傳輸命令列介面和遠端執行命令。SSH使用頻率最高的場合是類Unix系統，但是Windows作業系統也能有限度地使用SSH。2015年，微軟宣布將在未來的作業系統中提供原生SSH協定支援[3]，Windows 10 1803版本已提供OpenSSH工具</p><h1 id="generate-a-key-pair">Generate a key pair</h1><p>In you local PC,</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sh">$ ssh-keygen<br>or<br>$ ssh-keygen -t rsa<br></code></pre></td></tr></table></figure><p>where -t rsa option specifies that the type of the key should be RSA. Other choices include DSA, ECDSA, and ED25519. Select the protocol your SSH connection will use.</p><p>and id_rsa/id_rsa.pub are generated on .ssh.</p><ul><li>id_rsa contains the private key.</li><li>id_rsa.pub contains the public key.</li></ul><h1 id="id_rsa.pub">id_rsa.pub</h1><p>Copy id_rsa.pub to remote machine .ssh/authorized_keys</p><h1 id="ssh-login-without-password">ssh login without password</h1><p>In your SSH session with the remote machine, update the permissions of the .ssh directory and authorized_keys file in case they need it:</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh">$ <span class="hljs-built_in">chmod</span> 700 ~/.ssh<br>$ <span class="hljs-built_in">chmod</span> 600 ~/.ssh/authorized_keys<br></code></pre></td></tr></table></figure><p>Now, close your connection and your Terminal or Command Prompt. When you reopen it and try to connect to the remote server again from the client where you have your private key saved, you should receive a request to enter the passphrase instead of your username and password.</p><p>Reference: 1. <a href="https://www.strongdm.com/blog/ssh-passwordless-login">How to Set Up SSH Passwordless Login (Step-by-Step Tutorial)</a></p>]]></content>
    
    
    <categories>
      
      <category>Linux</category>
      
    </categories>
    
    
    <tags>
      
      <tag>ssh</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>MPAS | use_mp_re/config_microp_re -- use effective radii computed in mp schemes in RRTMG</title>
    <link href="/2024/06/04/MPAS_config_microp_re/"/>
    <url>/2024/06/04/MPAS_config_microp_re/</url>
    
    <content type="html"><![CDATA[<h1 id="in-wrf">In WRF,</h1><p>WRF Model Version 3.8: UPDATES</p><p>Add a new namelist, use_mp_re, to control the interaction between effective radii computed in some microphysics with RRTMG radiation. {:.info}</p><p>use_mp_re = 1 ! whether to use effective radii computed in mp schemes in RRTMG - 0: do not use; - 1: use effective radii - (The mp schemes that compute effective radii are 3,4,6,7,8,10,14,16,18,24,26,28,50-53,55)</p><h1 id="in-mpas-version-7.0">In MPAS Version 7.0,</h1><p>A fix for the communication of effective radii between the WSM6 and RRTMG schemes when config_microp_re=true. {:.info}</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">var</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;re_cloud&quot;</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;real&quot;</span> <span class="hljs-attr">dimensions</span>=<span class="hljs-string">&quot;nVertLevels nCells Time&quot;</span> <span class="hljs-attr">units</span>=<span class="hljs-string">&quot;m&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">description</span>=<span class="hljs-string">&quot;effective radius of cloud water droplets&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">packages</span>=<span class="hljs-string">&quot;mp_thompson_in;mp_wsm6_in&quot;</span>/&gt;</span><br><br><span class="hljs-tag">&lt;<span class="hljs-name">var</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;re_ice&quot;</span>  <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;real&quot;</span> <span class="hljs-attr">dimensions</span>=<span class="hljs-string">&quot;nVertLevels nCells Time&quot;</span>  <span class="hljs-attr">units</span>=<span class="hljs-string">&quot;m&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">description</span>=<span class="hljs-string">&quot;effective radius of cloud ice crystals&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">packages</span>=<span class="hljs-string">&quot;mp_thompson_in;mp_wsm6_in&quot;</span>/&gt;</span><br><br><span class="hljs-tag">&lt;<span class="hljs-name">var</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;re_snow&quot;</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;real&quot;</span> <span class="hljs-attr">dimensions</span>=<span class="hljs-string">&quot;nVertLevels nCells Time&quot;</span>  <span class="hljs-attr">units</span>=<span class="hljs-string">&quot;m&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">description</span>=<span class="hljs-string">&quot;effective radius of snow crystals&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">packages</span>=<span class="hljs-string">&quot;mp_thompson_in;mp_wsm6_in&quot;</span>/&gt;</span><br><br><span class="hljs-tag">&lt;<span class="hljs-name">var</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;rre_cloud&quot;</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;real&quot;</span> <span class="hljs-attr">dimensions</span>=<span class="hljs-string">&quot;nVertLevels nCells Time&quot;</span> <span class="hljs-attr">units</span>=<span class="hljs-string">&quot;microns&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">description</span>=<span class="hljs-string">&quot;effective radius of cloud water droplets calculated in RRTMG radiation&quot;</span>/&gt;</span><br><br><span class="hljs-tag">&lt;<span class="hljs-name">var</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;rre_ice&quot;</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;real&quot;</span> <span class="hljs-attr">dimensions</span>=<span class="hljs-string">&quot;nVertLevels nCells Time&quot;</span> <span class="hljs-attr">units</span>=<span class="hljs-string">&quot;microns&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">description</span>=<span class="hljs-string">&quot;effective radius of cloud ice crystals calculated in RRTMG radiation&quot;</span>/&gt;</span><br><br><span class="hljs-tag">&lt;<span class="hljs-name">var</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;rre_snow&quot;</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;real&quot;</span> <span class="hljs-attr">dimensions</span>=<span class="hljs-string">&quot;nVertLevels nCells Time&quot;</span> <span class="hljs-attr">units</span>=<span class="hljs-string">&quot;microns&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">description</span>=<span class="hljs-string">&quot;effective radius of snow crystals calculated in RRTMG radiation&quot;</span>/&gt;</span><br></code></pre></td></tr></table></figure><h1 id="references">References</h1><p>1.<a href="https://www2.mmm.ucar.edu/wrf/users/workshops/WS2022/full_presentations/session4.wong.pdf">Comparison of WRF and Regional MPAS: Ensuring Consistent Physics Configurations, 2022</a></p><h1 id="papers">Papers</h1><ol type="1"><li><ol start="1994" type="1"><li>Kiehl, J. T. <a href="https://agupubs.onlinelibrary.wiley.com/doi/abs/10.1029/94JD01117">Sensitivity of a GCM climate simulation to differences in continental versus maritime cloud drop size. Journal of Geophysical Research: Atmospheres, 99(D11), 23107-23115.</a></li></ol></li></ol><p>Extensive observations indicate a distinct difference between maritime and continental effective drop size, <span class="math inline">\(r_e\)</span>, for warm clouds. The latest version of the NCAR Community Climate Model (CCM2) is used to explore the sensitivity of differentiating between continental and maritime <span class="math inline">\(r_e\)</span> on the simulated climate. <strong>The results of this study indicate that the smaller drop size over continents leads to a reduction of surface-absorbed solar radiation from 20 to 60 <span class="math inline">\(W m^{−2}\)</span>. This reduction in surface solar flux leads to a cooling of the continents by up to −3.5 K. The reduction in surface solar flux and temperature also leads to a reduction in latent heat flux and precipitation over land.</strong> In the January simulation, there is a significant shift in tropical precipitation associated with the Australian monsoon. This shift leads to a response in the extra tropical geopotential height field over the western United States. All of these changes reduce biases in the current version of CCM2. {:.info}</p><ol start="2" type="1"><li><ol start="1994" type="1"><li>J.T. Kiehl. <a href="https://ntrs.nasa.gov/api/citations/19960000201/downloads/19960000201.pdf">Cloud Formation and Radiative Modeling in the NCAR CCM2: The Present and Future</a>, National Center for Atmospheric Research, U.S.A.</li></ol></li></ol><p>Although the CCM2 is generally an improvement over CCM1, there are stilt biases in CCM2. These are: (1) northern summer continents that are too warm, (2) excessive precipitation over land, and (3) a weak Northern Hemisphere winter stationary wave pattern in the Pacific Northwest. It is believed that to a large degree these biases are related to cloud properties.</p><p><strong>Observations indicate that over continents the warm cloud'-drop effective radius is approximately 5 <span class="math inline">\(\mu m\)</span>, while over oceans the drop size is more like 10 <span class="math inline">\(\mu m\)</span></strong>. A sensitivity study has been carried out (Kiehl, 1994) where the distinction is made between continental and maritime drop size. This simulation was compared to a control where the effective drop size was set to 10 <span class="math inline">\(\mu m\)</span> everywhere. <strong>The smaller drop size over continents led to higher cloud albedos over land regions. This, in turn, led to less solar radiation absorbed at the surface, which led to a reduction of surface temperature (maximum reduction of around 5 K)</strong>. Furthermore, the latent heat flux over land decreased, which led to a decrease in local precipitation. Thus, adopting a more realistic cloud-drop size for land and ocean led to an improved climate simulation. In January, there was an improvement in the Australian monsoon simulation, with a. displacement of the maximum precipitation in the northeast. This shift in tropical heating led to a shift in the Northern Hemisphere planetary wave structure, which again decreased the known bias in the control model.</p><p>CCM2 employs a prescribFa zonally symmetric in-cloud liquid-water path (Kiehl et al., 1994). Hack and Kiehl (1994) have recently replaced this with a local diagnostic for in-cloud liquid water. This new approach to in-cloud liquid water leads to further improvements in the summer land-surface temperature bias. This approach also vastly improves the shortwave cloud forcing over the North Atlantic storm track region.</p><p>The conclusion of these studies is that improvements in the diagnosis of cloud microphysical properties (drop size and liquid water content) leads to a significant improvement in the simulated climate of CCM2. Future research in the area will focus on implementation of a prognostic formulation for cloud water and ice concentration.</p><ol start="3" type="1"><li>Kiehl, J. T., Hack, J. J., Bonan, G. B., Boville, B. A., Williamson, D. L., &amp; Rasch, P. J. (1998). <a href="https://doi.org/10.1175/1520-0442(1998)011%3C1131:TNCFAR%3E2.0.CO;2">The National Center for Atmospheric Research Community Climate Model: CCM3. Journal of Climate, 11(6), 1131-1149.</a></li></ol>]]></content>
    
    
    <categories>
      
      <category>MPAS</category>
      
    </categories>
    
    
    <tags>
      
      <tag>WRF</tag>
      
      <tag>Parametrization</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>WRF | Error Error Error NoahMP submodule files not populating WRF directories</title>
    <link href="/2024/06/04/WRF_install_Error_NoahMP_submodule_files/"/>
    <url>/2024/06/04/WRF_install_Error_NoahMP_submodule_files/</url>
    
    <content type="html"><![CDATA[<h1 id="issue">Issue</h1><p>While installing latest WRF, encounter</p><blockquote><p>Error Error Error NoahMP submodule files not populating WRF directories</p></blockquote><h2 id="new-in-version-4.4">New in Version 4.4</h2><p>Physics</p><p>The NoahMP code has been moved to an external repository and is linked to WRF repository via a submodule. This submodule is automatically pulled in to build the code during compiling, as long as the compilation is done with internet access. If compiling without internet access, or you are not sure if the computer you are using to compile supports git (git is used during the compiling process to access code in submodule), or in the rare case that one checks out another branch, other than ‘master,’ it may be necessary to issue the following commands while connected to the internet to ensure the submodule is available for compiling.</p><ul><li>git clone https://github.com/wrf-model/WRF.git</li><li>git submodule update --init --recursive</li></ul><p>Or in one command: - git clone --recurse-submodule https://github.com/wrf-model/WRF.git</p><p>After this, it is okay to go offline to compile. In the case you would like to remove code in the submodule, use ‘clean -aa’ instead of ‘clean -a’. <a href="https://github.com/wrf-model/WRF/commit/a49fe581285d">Details</a></p><p>If downloading the files from the section below, please choose either the v4.4.tar.gz file, or the v4.4.zip file. DO NOT choose those named "Source Code." They do not include the mandatory NoahMP submodule - needed for compiling WRF.</p><h1 id="solution">Solution</h1><ol type="1"><li>Go to specific WRF version and /phys/</li><li>Download <strong>noahmp @ xxxx</strong> folder to your local /WRF/phys/<ul><li>WRFv4.5.2 is noahmp @ 8a8073e</li><li>WRFv4.6.0 is noahmp @ 848f54a</li></ul></li></ol><p>It is</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs stylus">WRFV4.<span class="hljs-number">5</span>/phys/noahmp  <br> $ ls<br>drivers  parameters  README<span class="hljs-selector-class">.md</span>  <span class="hljs-attribute">src</span><br><br>.<br>├── drivers<br>│   └── wrf<br>│       └── module_sf_noahmpdrv<span class="hljs-selector-class">.F</span><br>├── parameters<br>│   ├── GENPARM<span class="hljs-selector-class">.TBL</span><br>│   ├── MPTABLE<span class="hljs-selector-class">.TBL</span><br>│   └── SOILPARM<span class="hljs-selector-class">.TBL</span><br>├── README<span class="hljs-selector-class">.md</span><br>└── <span class="hljs-attribute">src</span><br>    ├── module_sf_noahmp_glacier<span class="hljs-selector-class">.F</span><br>    ├── module_sf_noahmp_groundwater<span class="hljs-selector-class">.F</span><br>    └── module_sf_noahmplsm<span class="hljs-selector-class">.F</span><br><br><span class="hljs-number">4</span> directories, <span class="hljs-number">8</span> files<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>WRF</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Installation</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>MPAS | Official MPAS Installation lib -- Preliminary requirements</title>
    <link href="/2024/06/03/MPAS_install_official_mpas_lib_install/"/>
    <url>/2024/06/03/MPAS_install_official_mpas_lib_install/</url>
    
    <content type="html"><![CDATA[<h1 id="preliminary-requirements-the-easiest-route">Preliminary requirements: the easiest route</h1><p>Installing the full set of I/O libraries required by MPAS can be tedious. To make this easier, we've prepared a shell script that may be helpful:</p><p>Preliminary requirements: the easiest route</p><p><a href="https://www2.mmm.ucar.edu/projects/mpas/scripts/mpas_lib_install.sh" class="uri">https://www2.mmm.ucar.edu/projects/mpas/scripts/mpas_lib_install.sh</a></p><p>Notes:</p><ul><li>Before running or following the above script, you will need to have downloaded the library sources from <a href="https://www2.mmm.ucar.edu/projects/mpas/scripts" class="uri">https://www2.mmm.ucar.edu/projects/mpas/scripts</a></li><li>If you already have an MPI library, skip the MPICH installation</li><li>After editing paths and compiler names at the top, you may be able to run the script, but in general the script may be best used as a guide</li></ul><p>attached below,</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-meta">#!/usr/bin/env bash</span><br><br><span class="hljs-comment">#</span><br><span class="hljs-comment"># Sources for all libraries used in this script can be found at</span><br><span class="hljs-comment"># http://www2.mmm.ucar.edu/people/duda/files/mpas/sources/ </span><br><span class="hljs-comment">#</span><br><br><span class="hljs-comment"># Where to find sources for libraries - generally, the directory into which</span><br><span class="hljs-comment"># you have downloaded the sources from the URL, above</span><br><span class="hljs-built_in">export</span> LIBSRC=/sysdisk2/duda/sources<br><br><span class="hljs-comment"># Where to install libraries - this directory must be writable by you</span><br><span class="hljs-built_in">export</span> LIBBASE=/sysdisk2/duda/mpas-libs<br><br><span class="hljs-comment"># Compilers</span><br><span class="hljs-built_in">export</span> SERIAL_FC=gfortran<br><span class="hljs-built_in">export</span> SERIAL_F77=gfortran<br><span class="hljs-built_in">export</span> SERIAL_CC=gcc<br><span class="hljs-built_in">export</span> SERIAL_CXX=g++<br><span class="hljs-built_in">export</span> MPI_FC=mpifort<br><span class="hljs-built_in">export</span> MPI_F77=mpifort<br><span class="hljs-built_in">export</span> MPI_CC=mpicc<br><span class="hljs-built_in">export</span> MPI_CXX=mpic++<br><br><br><span class="hljs-built_in">export</span> CC=<span class="hljs-variable">$SERIAL_CC</span><br><span class="hljs-built_in">export</span> CXX=<span class="hljs-variable">$SERIAL_CXX</span><br><span class="hljs-built_in">export</span> F77=<span class="hljs-variable">$SERIAL_F77</span><br><span class="hljs-built_in">export</span> FC=<span class="hljs-variable">$SERIAL_FC</span><br><span class="hljs-built_in">unset</span> F90  <span class="hljs-comment"># This seems to be set by default on NCAR&#x27;s Cheyenne and is problematic</span><br><span class="hljs-built_in">unset</span> F90FLAGS<br><span class="hljs-built_in">export</span> CFLAGS=<span class="hljs-string">&quot;-g&quot;</span><br><span class="hljs-built_in">export</span> FFLAGS=<span class="hljs-string">&quot;-g -fbacktrace&quot;</span><br><span class="hljs-built_in">export</span> FCFLAGS=<span class="hljs-string">&quot;-g -fbacktrace -fallow-argument-mismatch&quot;</span><br><span class="hljs-built_in">export</span> F77FLAGS=<span class="hljs-string">&quot;-g -fbacktrace -fallow-argument-mismatch&quot;</span><br><br><br><span class="hljs-comment">########################################</span><br><span class="hljs-comment"># MPICH</span><br><span class="hljs-comment">########################################</span><br>tar xzvf <span class="hljs-variable">$&#123;LIBSRC&#125;</span>/mpich-3.3.1.tar.gz <br><span class="hljs-built_in">cd</span> mpich-3.3.1<br>./configure --prefix=<span class="hljs-variable">$&#123;LIBBASE&#125;</span><br>make -j 4<br><span class="hljs-comment">#make check</span><br>make install<br><span class="hljs-comment">#make testing</span><br><span class="hljs-built_in">export</span> PATH=<span class="hljs-variable">$&#123;LIBBASE&#125;</span>/bin:<span class="hljs-variable">$PATH</span><br><span class="hljs-built_in">export</span> LD_LIBRARY_PATH=<span class="hljs-variable">$&#123;LIBBASE&#125;</span>/lib:<span class="hljs-variable">$LD_LIBRARY_PATH</span><br><span class="hljs-built_in">cd</span> ..<br><span class="hljs-built_in">rm</span> -rf mpich-3.3.1<br><br><span class="hljs-comment">########################################</span><br><span class="hljs-comment"># zlib</span><br><span class="hljs-comment">########################################</span><br>tar xzvf <span class="hljs-variable">$&#123;LIBSRC&#125;</span>/zlib-1.2.11.tar.gz<br><span class="hljs-built_in">cd</span> zlib-1.2.11<br>./configure --prefix=<span class="hljs-variable">$&#123;LIBBASE&#125;</span> --static<br>make -j 4<br>make install<br><span class="hljs-built_in">cd</span> ..<br><span class="hljs-built_in">rm</span> -rf zlib-1.2.11<br><br><span class="hljs-comment">########################################</span><br><span class="hljs-comment"># HDF5</span><br><span class="hljs-comment">########################################</span><br>tar xjvf <span class="hljs-variable">$&#123;LIBSRC&#125;</span>/hdf5-1.10.5.tar.bz2<br><span class="hljs-built_in">cd</span> hdf5-1.10.5<br><span class="hljs-built_in">export</span> FC=<span class="hljs-variable">$MPI_FC</span><br><span class="hljs-built_in">export</span> CC=<span class="hljs-variable">$MPI_CC</span><br><span class="hljs-built_in">export</span> CXX=<span class="hljs-variable">$MPI_CXX</span><br>./configure --prefix=<span class="hljs-variable">$&#123;LIBBASE&#125;</span> --enable-parallel --with-zlib=<span class="hljs-variable">$&#123;LIBBASE&#125;</span> --disable-shared<br>make -j 4<br><span class="hljs-comment">#make check</span><br>make install<br><span class="hljs-built_in">cd</span> ..<br><span class="hljs-built_in">rm</span> -rf hdf5-1.10.5<br><br><span class="hljs-comment">########################################</span><br><span class="hljs-comment"># Parallel-netCDF</span><br><span class="hljs-comment">########################################</span><br>tar xzvf <span class="hljs-variable">$&#123;LIBSRC&#125;</span>/pnetcdf-1.12.2.tar.gz<br><span class="hljs-built_in">cd</span> pnetcdf-1.12.2<br><span class="hljs-built_in">export</span> CC=<span class="hljs-variable">$SERIAL_CC</span><br><span class="hljs-built_in">export</span> CXX=<span class="hljs-variable">$SERIAL_CXX</span><br><span class="hljs-built_in">export</span> F77=<span class="hljs-variable">$SERIAL_F77</span><br><span class="hljs-built_in">export</span> FC=<span class="hljs-variable">$SERIAL_FC</span><br><span class="hljs-built_in">export</span> MPICC=<span class="hljs-variable">$MPI_CC</span><br><span class="hljs-built_in">export</span> MPICXX=<span class="hljs-variable">$MPI_CXX</span><br><span class="hljs-built_in">export</span> MPIF77=<span class="hljs-variable">$MPI_F77</span><br><span class="hljs-built_in">export</span> MPIF90=<span class="hljs-variable">$MPI_FC</span><br><span class="hljs-comment">### Will also need gcc in path</span><br>./configure --prefix=<span class="hljs-variable">$&#123;LIBBASE&#125;</span><br>make -j 4<br><span class="hljs-comment">#make check</span><br><span class="hljs-comment">#make ptest</span><br><span class="hljs-comment">#make testing</span><br>make install<br><span class="hljs-built_in">export</span> PNETCDF=<span class="hljs-variable">$&#123;LIBBASE&#125;</span><br><span class="hljs-built_in">cd</span> ..<br><span class="hljs-built_in">rm</span> -rf pnetcdf-1.12.2<br><br><span class="hljs-comment">########################################</span><br><span class="hljs-comment"># netCDF (C library)</span><br><span class="hljs-comment">########################################</span><br>tar xzvf <span class="hljs-variable">$&#123;LIBSRC&#125;</span>/netcdf-c-4.6.3.tar.gz<br><span class="hljs-built_in">cd</span> netcdf-c-4.6.3<br><span class="hljs-built_in">export</span> CPPFLAGS=<span class="hljs-string">&quot;-I<span class="hljs-variable">$&#123;LIBBASE&#125;</span>/include&quot;</span><br><span class="hljs-built_in">export</span> LDFLAGS=<span class="hljs-string">&quot;-L<span class="hljs-variable">$&#123;LIBBASE&#125;</span>/lib&quot;</span><br><span class="hljs-built_in">export</span> LIBS=<span class="hljs-string">&quot;-lhdf5_hl -lhdf5 -lz -ldl&quot;</span><br><span class="hljs-built_in">export</span> CC=<span class="hljs-variable">$MPI_CC</span><br>./configure --prefix=<span class="hljs-variable">$&#123;LIBBASE&#125;</span> --disable-dap --enable-netcdf4 --enable-pnetcdf --enable-cdf5 --enable-parallel-tests --disable-shared<br>make -j 4 <br><span class="hljs-comment">#make check</span><br>make install<br><span class="hljs-built_in">export</span> NETCDF=<span class="hljs-variable">$&#123;LIBBASE&#125;</span><br><span class="hljs-built_in">cd</span> ..<br><span class="hljs-built_in">rm</span> -rf netcdf-c-4.6.3<br><br><span class="hljs-comment">########################################</span><br><span class="hljs-comment"># netCDF (Fortran interface library)</span><br><span class="hljs-comment">########################################</span><br>tar xzvf <span class="hljs-variable">$&#123;LIBSRC&#125;</span>/netcdf-fortran-4.5.2.tar.gz<br><span class="hljs-built_in">cd</span> netcdf-fortran-4.5.2<br><span class="hljs-built_in">export</span> FC=<span class="hljs-variable">$MPI_FC</span><br><span class="hljs-built_in">export</span> F77=<span class="hljs-variable">$MPI_F77</span><br><span class="hljs-built_in">export</span> LIBS=<span class="hljs-string">&quot;-lnetcdf -lpnetcdf <span class="hljs-variable">$&#123;LIBS&#125;</span>&quot;</span><br>./configure --prefix=<span class="hljs-variable">$&#123;LIBBASE&#125;</span> --enable-parallel-tests --disable-shared<br>make -j 4<br><span class="hljs-comment">#make check</span><br>make install<br><span class="hljs-built_in">cd</span> ..<br><span class="hljs-built_in">rm</span> -rf netcdf-fortran-4.5.2<br><br><span class="hljs-comment">########################################</span><br><span class="hljs-comment"># PIO</span><br><span class="hljs-comment">########################################</span><br>git <span class="hljs-built_in">clone</span> https://github.com/NCAR/ParallelIO<br><span class="hljs-built_in">cd</span> ParallelIO<br>git checkout -b pio-2.5.8 pio2_5_8<br><span class="hljs-built_in">export</span> PIOSRC=`<span class="hljs-built_in">pwd</span>`<br><span class="hljs-built_in">cd</span> ..<br><span class="hljs-built_in">mkdir</span> pio<br><span class="hljs-built_in">cd</span> pio<br><span class="hljs-built_in">export</span> CC=<span class="hljs-variable">$MPI_CC</span><br><span class="hljs-built_in">export</span> FC=<span class="hljs-variable">$MPI_FC</span><br>cmake -DNetCDF_C_PATH=<span class="hljs-variable">$NETCDF</span> -DNetCDF_Fortran_PATH=<span class="hljs-variable">$NETCDF</span> -DPnetCDF_PATH=<span class="hljs-variable">$PNETCDF</span> -DHDF5_PATH=<span class="hljs-variable">$NETCDF</span> -DCMAKE_INSTALL_PREFIX=<span class="hljs-variable">$LIBBASE</span> -DPIO_USE_MALLOC=ON -DCMAKE_VERBOSE_MAKEFILE=1 -DPIO_ENABLE_TIMING=OFF <span class="hljs-variable">$PIOSRC</span><br>make<br><span class="hljs-comment">#make check</span><br>make install<br><span class="hljs-built_in">cd</span> ..<br><span class="hljs-built_in">rm</span> -rf pio ParallelIO<br><span class="hljs-built_in">export</span> PIO=<span class="hljs-variable">$LIBBASE</span><br><br><span class="hljs-comment">########################################</span><br><span class="hljs-comment"># Other environment vars needed by MPAS</span><br><span class="hljs-comment">########################################</span><br><span class="hljs-built_in">export</span> MPAS_EXTERNAL_LIBS=<span class="hljs-string">&quot;-L<span class="hljs-variable">$&#123;LIBBASE&#125;</span>/lib -lhdf5_hl -lhdf5 -ldl -lz&quot;</span><br><span class="hljs-built_in">export</span> MPAS_EXTERNAL_INCLUDES=<span class="hljs-string">&quot;-I<span class="hljs-variable">$&#123;LIBBASE&#125;</span>/include&quot;</span><br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>MPAS</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Installation</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>MPAS | Installation by Spack and Intel</title>
    <link href="/2024/06/01/MPAS_intel_spack_installation/"/>
    <url>/2024/06/01/MPAS_intel_spack_installation/</url>
    
    <content type="html"><![CDATA[<h1 id="using-spack">Using Spack</h1><p>Spack is a package management tool designed to support multiple versions and configurations of software on a wide variety of platforms and environments. It was designed for large supercomputing centers, where many users and application teams share common installations of software on clusters with exotic architectures, using libraries that do not have a standard ABI. Spack is non-destructive: installing a new version does not break existing installations, so many configurations can coexist on the same system. Most importantly, Spack is simple. It offers a simple spec syntax so that users can specify versions and configuration options concisely. Spack is also simple for package authors: package files are written in pure Python, and specs allow package authors to maintain a single file for many different builds of the same package.</p><p><a href="https://spack.readthedocs.io/en/latest/" class="uri">https://spack.readthedocs.io/en/latest/</a></p><h2 id="search-packages-online">Search packages online</h2><blockquote><p><a href="https://packages.spack.io/" class="uri">https://packages.spack.io/</a></p></blockquote><h1 id="install-intel-compiler-and-intel-onempi">Install Intel compiler and intel-onempi</h1><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs sh">$ spack <span class="hljs-built_in">env</span> create intel_oneapi <br>$ spack <span class="hljs-built_in">env</span> activate intel_oneapi<br>$ spack info --all intel-oneapi-mpi<br>$ spack info --all intel-oneapi-compilers<br></code></pre></td></tr></table></figure><p>Try to install <a href="https://spack.readthedocs.io/en/latest/build_systems/inteloneapipackage.html">intel-oneapi-mpi/2021.4.0</a>,</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs sh">$ spack install --add intel-oneapi-compilers@2021.4.0<br><span class="hljs-comment"># Add the compilers to your compilers.yaml so spack can use them:</span><br><span class="hljs-comment"># For 2023.x and earlier versions, use:</span><br>$ spack compiler add `spack location -i intel-oneapi-compilers@2021.4.0`/compiler/latest/linux/bin/intel64<br>$ spack compiler add `spack location -i intel-oneapi-compilers@2021.4.0`/compiler/latest/linux/bin<br><span class="hljs-comment"># Verify that the compilers are available:</span><br>$ spack compiler list<br>$ spack location -i intel-oneapi-compilers@2021.4.0<br></code></pre></td></tr></table></figure><p>Then, install intel-onempi,</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">$ spack install --add intel-oneapi-mpi@2021.4.0%intel<br></code></pre></td></tr></table></figure><p>Done.</p><p>And, check</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs sh">spack <span class="hljs-built_in">env</span> activate intel_oneapi<br><br><span class="hljs-built_in">which</span> mpiicc &amp;&amp; mpiicc --version<br><span class="hljs-built_in">which</span> mpiifort &amp;&amp; mpiifort --version<br><span class="hljs-built_in">which</span> mpiicpc &amp;&amp; mpiicpc --version<br><span class="hljs-built_in">which</span> icc &amp;&amp; icc --version<br><span class="hljs-built_in">which</span> ifort &amp;&amp; ifort --version<br></code></pre></td></tr></table></figure><p>Additionally, install curl and cmake,</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs sh">$ spack info --all curl<br>$ spack install --add curl%intel<br>$ spack info --all cmake<br>$ spack install --add cmake%intel<br></code></pre></td></tr></table></figure><h1 id="install-enviroment-for-mpas">Install enviroment for MPAS</h1><p>Prepare</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-meta">#!/bin/bash</span><br><br><span class="hljs-comment">#------------------------------------------------#</span><br><span class="hljs-comment">#Author:         wpsze</span><br><span class="hljs-comment">#Email：         </span><br><span class="hljs-comment">#date:           </span><br><span class="hljs-comment">#Version:        </span><br><span class="hljs-comment">#Description:    The purpose of the script</span><br><span class="hljs-comment">#Copyright (C)： 2022 All rights reserved</span><br><span class="hljs-comment">#------------------------------------------------#</span><br><br><span class="hljs-built_in">export</span> libs_DIR=/home/wpsze/MPAS-A/intel/modules_library/Library/<br><br><span class="hljs-comment"># intel compiler &amp; intel onempi</span><br>spack <span class="hljs-built_in">env</span> activate intel_oneapi<br><br><span class="hljs-built_in">which</span> mpiicc &amp;&amp; mpiicc --version<br><span class="hljs-built_in">which</span> mpiifort &amp;&amp; mpiifort --version<br><span class="hljs-built_in">which</span> mpiicpc &amp;&amp; mpiicpc --version<br><span class="hljs-built_in">which</span> icc &amp;&amp; icc --version<br><span class="hljs-built_in">which</span> ifort &amp;&amp; ifort --version<br><br><span class="hljs-comment"># MPAS env</span><br><span class="hljs-built_in">export</span> PATH=<span class="hljs-variable">$libs_DIR</span>/bin:<span class="hljs-variable">$PATH</span><br><span class="hljs-built_in">export</span> LD_LIBRARY_PATH=<span class="hljs-variable">$libs_DIR</span>/lib:<span class="hljs-variable">$LD_LIBRARY_PATH</span><br><span class="hljs-built_in">export</span> LDFLAGS=-L<span class="hljs-variable">$libs_DIR</span>/lib<br><span class="hljs-built_in">export</span> CPPFLAGS=-I<span class="hljs-variable">$libs_DIR</span>/include<br><br><span class="hljs-built_in">export</span> PNETCDF_PATH=<span class="hljs-variable">$libs_DIR</span><br><span class="hljs-built_in">export</span> PNETCDF=<span class="hljs-variable">$libs_DIR</span><br><span class="hljs-built_in">export</span> NETCDF_PATH=<span class="hljs-variable">$libs_DIR</span><br><span class="hljs-built_in">export</span> NETCDF=<span class="hljs-variable">$libs_DIR</span><br><span class="hljs-built_in">export</span> PIO=<span class="hljs-variable">$libs_DIR</span><br><br><br><span class="hljs-built_in">export</span> CC=mpiicc<br><span class="hljs-built_in">export</span> CXX=mpiicpc<br><span class="hljs-built_in">export</span> FC=mpiifort<br><span class="hljs-built_in">export</span> F77=mpiifort<br><span class="hljs-built_in">export</span> F90=mpiifort<br><span class="hljs-built_in">export</span> MPIF90=mpiifort<br><span class="hljs-built_in">export</span> MPIF77=mpiifort<br><span class="hljs-built_in">export</span> MPIFC=mpiifort<br><span class="hljs-built_in">export</span> MPICC=mpiicc<br><span class="hljs-built_in">export</span> MPICXX=mpiicpc<br><br><span class="hljs-built_in">export</span> CFLAGS=<span class="hljs-string">&#x27;-O3 -fPIC -static-intel&#x27;</span><br><span class="hljs-built_in">export</span> CXXFLAGS=<span class="hljs-string">&#x27;-O3 -fPIC -static-intel&#x27;</span><br><span class="hljs-built_in">export</span> FFLAGS=<span class="hljs-string">&#x27;-O3 -fPIC -static-intel&#x27;</span><br></code></pre></td></tr></table></figure><p>Then, env sh</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment">############################## Directory Listing ############################</span><br><span class="hljs-built_in">export</span> HOME=`<span class="hljs-built_in">pwd</span>`<br><br><span class="hljs-built_in">source</span> /home/wpsze/MPAS-A/intel/modules_library/mpas_env_intel.sh<br><br><span class="hljs-built_in">export</span> download_DIR=<span class="hljs-variable">$HOME</span>/mpas_install/<br><br>TARGET=ifort<br><br><span class="hljs-built_in">which</span> mpiicc &amp;&amp; mpiicc --version<br><span class="hljs-built_in">which</span> mpiifort &amp;&amp; mpiifort --version<br><span class="hljs-built_in">which</span> mpiicpc &amp;&amp; mpiicpc --version<br><span class="hljs-built_in">which</span> icc &amp;&amp; icc --version<br><span class="hljs-built_in">which</span> ifort &amp;&amp; ifort --version<br><br><span class="hljs-built_in">echo</span> <span class="hljs-variable">$HOME</span><br><span class="hljs-built_in">echo</span> <span class="hljs-variable">$download_DIR</span><br><span class="hljs-built_in">echo</span> <span class="hljs-variable">$libs_DIR</span><br><br>mpiicc --version<br>mpiifort --version<br><br><span class="hljs-built_in">echo</span> <span class="hljs-variable">$HOME</span><br><span class="hljs-built_in">echo</span> <span class="hljs-variable">$download_DIR</span><br><span class="hljs-built_in">echo</span> <span class="hljs-variable">$libs_DIR</span><br><br><span class="hljs-built_in">mkdir</span> -p mpas_install<br><span class="hljs-built_in">mkdir</span> -p Library<br><br>do_download=False <span class="hljs-comment"># True or False</span><br>compile_all=True<br><br><span class="hljs-comment"># Currently Loaded Modules:</span><br><span class="hljs-comment">#  1) ncarenv/1.0 (xx)      4) ncarcompilers/1.0 (xx)  7) pnetcdf/1.11.2  10) ncview/2.1.7 (already)</span><br><span class="hljs-comment">#  2) ncarbinlibs/1.1 (xx)  5) netcdf/4.7.0        8) pio/1.9.23 (2.5.2)      11) metis/5.1.0</span><br><span class="hljs-comment">#  3) gnu/8.3.0 (done)         6) mpich/3.3.1         9) ncl/6.6.2 (already)       12) hdf5/1.10.5</span><br><br><span class="hljs-comment">#do_mpich=False ## intel-onempi</span><br>do_zlib=False<br>do_hdf5=True<br>do_pnetcdf=False<br>do_netcdfC=False<br>do_netcdfF=False<br>do_pio=False<br>do_metis=fTrue<br><br><span class="hljs-comment">############################## Downloading Libraries ############################</span><br><span class="hljs-keyword">if</span> [[ <span class="hljs-variable">$do_download</span>  == True ]]; <span class="hljs-keyword">then</span><br>    <span class="hljs-built_in">cd</span> <span class="hljs-variable">$download_DIR</span><br>    wget -c https://zlib.net/zlib-1.2.13.tar.gz<br>    wget -c https://www.gfd-dennou.org/arch/netcdf/unidata-mirror/netcdf-c-4.7.4.tar.gz<br>    wget -c https://www.gfd-dennou.org/arch/netcdf/unidata-mirror/netcdf-fortran-4.5.3.tar.gz<br>    <span class="hljs-comment"># wget -c https://github.com/pmodels/mpich/releases/download/v4.0.2/mpich-4.0.2.tar.gz</span><br>    wget -c https://www.mpich.org/static/downloads/3.3.1/mpich-3.3.1.tar.gz<br>    wget -c https://parallel-netcdf.github.io/Release/pnetcdf-1.11.2.tar.gz <br>    <span class="hljs-comment"># Pio is from https://github.com/NCAR/ParallelIO/releases</span><br>    <span class="hljs-comment"># metis is from http://glaros.dtc.umn.edu/gkhome/metis/metis/download</span><br>    wget -c https://hdf-wordpress-1.s3.amazonaws.com/wp-content/uploads/manual/HDF5/HDF5_1_12_0/source/hdf5-1.12.0.tar.gz<br><br><span class="hljs-keyword">fi</span><br><br><span class="hljs-keyword">if</span> [[ <span class="hljs-variable">$compile_all</span> == True ]]; <span class="hljs-keyword">then</span><br><span class="hljs-comment">###################################################################</span><br><span class="hljs-built_in">export</span> LD_LIBRARY_PATH=<span class="hljs-variable">$libs_DIR</span>/lib:<span class="hljs-variable">$LD_LIBRARY_PATH</span><br><span class="hljs-built_in">export</span> LDFLAGS=-L<span class="hljs-variable">$libs_DIR</span>/lib<br><span class="hljs-built_in">export</span> CPPFLAGS=-I<span class="hljs-variable">$libs_DIR</span>/include<br><span class="hljs-built_in">export</span> PATH=<span class="hljs-variable">$libs_DIR</span>/bin:<span class="hljs-variable">$PATH</span><br><br><span class="hljs-comment">#export PNETCDF_PATH=$libs_DIR/bin:$PATH</span><br><span class="hljs-comment">#export PNETCDF=$libs_DIR/bin:$PATH</span><br><br><span class="hljs-comment">#export NETCDF_PATH=$libs_DIR/bin:$PATH</span><br><span class="hljs-comment">#export NETCDF=$libs_DIR/bin:$PATH</span><br><br><span class="hljs-comment">############################## zlib ############################ *** zlib test OK ***</span><br><span class="hljs-keyword">if</span> [[ <span class="hljs-variable">$&#123;do_zlib&#125;</span>  == True ]]; <span class="hljs-keyword">then</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;=== zlib ====&quot;</span><br><span class="hljs-built_in">cd</span> <span class="hljs-variable">$download_DIR</span><br>tar xvf zlib-1.2.13.tar.gz 1&gt;/dev/null 2&gt;&amp;1 <br><span class="hljs-built_in">cd</span> zlib-1.2.13/<br><br>./configure --prefix=<span class="hljs-variable">$libs_DIR</span> <span class="hljs-comment">#--static</span><br>make -j 4<br>make install<br>make check<br><span class="hljs-built_in">cd</span> ..<br><span class="hljs-built_in">rm</span> -rf zlib-1.2.13<br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;=== zlib (end) ====&quot;</span><br><span class="hljs-keyword">fi</span><br><br><span class="hljs-comment">############################## HDF5 ############################ </span><br><span class="hljs-keyword">if</span> [[ <span class="hljs-variable">$&#123;do_hdf5&#125;</span> == True ]]; <span class="hljs-keyword">then</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;=== hdf5 ====&quot;</span><br><span class="hljs-built_in">cd</span> <span class="hljs-variable">$download_DIR</span><br>tar xvf hdf5-1.12.0.tar.gz 1&gt;/dev/null 2&gt;&amp;1 <br><span class="hljs-built_in">cd</span> hdf5-1.12.0/<br><br>./configure --prefix=<span class="hljs-variable">$libs_DIR</span> --enable-parallel --with-zlib=<span class="hljs-variable">$libs_DIR</span> --enable-fortran <span class="hljs-comment">#--disable-shared</span><br>make -j 4<br>make check<br>make install<br><span class="hljs-built_in">cd</span> ..<br><span class="hljs-built_in">rm</span> -rf hdf5-1.12.0<br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;=== hdf5 (end) ====&quot;</span><br><span class="hljs-keyword">fi</span><br><br><span class="hljs-comment">############################## pnetcdf ############################ PnetCDF has been successfully installed </span><br><span class="hljs-keyword">if</span> [[ <span class="hljs-variable">$&#123;do_pnetcdf&#125;</span> == True ]]; <span class="hljs-keyword">then</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;=== pnetcdf ====&quot;</span><br><span class="hljs-built_in">cd</span> <span class="hljs-variable">$download_DIR</span><br>tar xvf pnetcdf-1.11.2.tar.gz 1&gt;/dev/null 2&gt;&amp;1 <br><span class="hljs-built_in">cd</span> pnetcdf-1.11.2/<br><br>./configure --prefix=<span class="hljs-variable">$libs_DIR</span><br>make -j 4<br>make check<br>make ptest<br>make testing<br>make install<br><span class="hljs-built_in">cd</span> ..<br><span class="hljs-built_in">rm</span> -rf pnetcdf-1.11.2<br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;=== pnetcdf (end) ====&quot;</span><br><span class="hljs-keyword">fi</span><br><br><span class="hljs-comment">############################## netcdf-C ############################  Congratulations! You have successfully installed netCDF!</span><br><span class="hljs-keyword">if</span> [[ <span class="hljs-variable">$&#123;do_netcdfC&#125;</span> == True ]]; <span class="hljs-keyword">then</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;=== netcdf-C ====&quot;</span><br><span class="hljs-comment">## -disable-dap：--disable-dap的原因是缺少一个‘curl’的lib</span><br><span class="hljs-comment">## 4.1.3以后的版本Fortran和C分开了。把disable--netcdf-4 写进去也无所谓</span><br><span class="hljs-built_in">cd</span> <span class="hljs-variable">$download_DIR</span><br>tar xvf netcdf-c-4.7.4.tar.gz 1&gt;/dev/null 2&gt;&amp;1 <br><span class="hljs-built_in">cd</span> netcdf-c-4.7.4/<br><br><span class="hljs-comment">#export LIBS=&quot;-lhdf5_hl -lhdf5 -lz -ldl&quot;</span><br><br><span class="hljs-built_in">export</span> LD_LIBRARY_PATH=<span class="hljs-variable">$libs_DIR</span>/lib:<span class="hljs-variable">$LD_LIBRARY_PATH</span><br><span class="hljs-built_in">export</span> LDFLAGS=-L<span class="hljs-variable">$libs_DIR</span>/lib<br><span class="hljs-built_in">export</span> CPPFLAGS=-I<span class="hljs-variable">$libs_DIR</span>/include<br><br><span class="hljs-comment">#./configure --prefix=$libs_DIR --disable-dap --enable-pnetcdf --enable-netcdf4 --enable-cdf5 --enable-parallel-tests --disable-shared</span><br>./configure --prefix=<span class="hljs-variable">$libs_DIR</span> --enable-shared --enable-netcdf4 --disable-filter-testing --disable-dap<br>make -j 4 <br>make check<br>make install<br><span class="hljs-built_in">cd</span> ..<br><span class="hljs-built_in">rm</span> -rf netcdf-c-4.7.4<br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;=== netcdf-C (end) ====&quot;</span><br><span class="hljs-keyword">fi</span><br><br><span class="hljs-comment">############################## netcdf-F ############################ </span><br><span class="hljs-keyword">if</span> [[ <span class="hljs-variable">$&#123;do_netcdfF&#125;</span> == True ]]; <span class="hljs-keyword">then</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;=== netcdf-F ====&quot;</span><br><span class="hljs-built_in">cd</span> <span class="hljs-variable">$download_DIR</span><br>tar xvf netcdf-fortran-4.5.3.tar.gz 1&gt;/dev/null 2&gt;&amp;1 <br><span class="hljs-built_in">cd</span> netcdf-fortran-4.5.3/<br><br><br><span class="hljs-built_in">export</span> LD_LIBRARY_PATH=<span class="hljs-variable">$libs_DIR</span>/lib:<span class="hljs-variable">$LD_LIBRARY_PATH</span><br><span class="hljs-built_in">export</span> LDFLAGS=-L<span class="hljs-variable">$libs_DIR</span>/lib<br><span class="hljs-built_in">export</span> CPPFLAGS=-I<span class="hljs-variable">$libs_DIR</span>/include<br><br><span class="hljs-comment">#</span><br><span class="hljs-comment"># configure: error: netcdf-c version 4.7.4 or greater is required</span><br><br>nc-config --cflags<br>nc-config --libs<br>./configure --prefix=<span class="hljs-variable">$libs_DIR</span> --enable-shared <span class="hljs-comment">#--enable-parallel-tests #--disable-shared</span><br><br><span class="hljs-comment">#CFLAGS=$(nc-config --cflags) LDFLAGS=$(nc-config --libs) ./configure --prefix=$libs_DIR --enable-parallel-tests #--disable-shared</span><br><br>make -j 4 <br>make check<br>make install<br><span class="hljs-built_in">cd</span> ..<br><span class="hljs-built_in">rm</span> -rf netcdf-fortran-4.5.3<br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;=== netcdf-F (end) ====&quot;</span><br><span class="hljs-keyword">fi</span><br><br><span class="hljs-comment">############################## Pio ############################</span><br><span class="hljs-keyword">if</span> [[ <span class="hljs-variable">$&#123;do_pio&#125;</span> == True ]]; <span class="hljs-keyword">then</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;=== PIO ====&quot;</span><br><span class="hljs-built_in">cd</span> <span class="hljs-variable">$download_DIR</span><br>tar xvf ParallelIO-pio2_5_8.tar.gz 1&gt;/dev/null 2&gt;&amp;1<br><span class="hljs-built_in">cd</span> ParallelIO-pio2_5_8/<br><br><span class="hljs-comment">#./configure --prefix=$libs_DIR --enable-fortran</span><br><span class="hljs-comment">#cmake -DNetCDF_C_PATH=$libs_DIR -DNetCDF_Fortran_PATH=$libs_DIR -DPnetCDF_PATH=$libs_DIR -DPIO_ENABLE_TIMING=OFF -DCMAKE_INSTALL_PREFIX=$libs_DIR</span><br>cmake -DNetCDF_C_PATH=<span class="hljs-variable">$NETCDF</span> -DNetCDF_Fortran_PATH=<span class="hljs-variable">$NETCDF</span> -DPnetCDF_PATH=<span class="hljs-variable">$PNETCDF</span> -DHDF5_PATH=<span class="hljs-variable">$libs_DIR</span> -DCMAKE_INSTALL_PREFIX=<span class="hljs-variable">$libs_DIR</span> -DPIO_USE_MALLOC=ON -DCMAKE_VERBOSE_MAKEFILE=1 -DPIO_ENABLE_TIMING=OFF ./<br>make<br><span class="hljs-comment">#make check</span><br>make install<br><span class="hljs-built_in">cd</span> ..<br><span class="hljs-built_in">rm</span> -rf ParallelIO-pio2_5_8<br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;=== PIO (end) ====&quot;</span><br><span class="hljs-keyword">fi</span><br><br><span class="hljs-comment">############################## metis ############################</span><br><span class="hljs-keyword">if</span> [[ <span class="hljs-variable">$&#123;do_metis&#125;</span> == True ]]; <span class="hljs-keyword">then</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;=== metis ====&quot;</span><br><br>        <span class="hljs-comment">## metis is serial </span><br>        <span class="hljs-built_in">export</span> CC=icc<br>        <span class="hljs-built_in">export</span> CXX=icpc<br>        <span class="hljs-built_in">export</span> FC=ifort<br>        <span class="hljs-built_in">export</span> F77=ifort<br>        <span class="hljs-built_in">export</span> F90=ifort<br><br><span class="hljs-built_in">cd</span> <span class="hljs-variable">$download_DIR</span><br>tar xvf metis-5.1.0.tar.gz 1&gt;/dev/null 2&gt;&amp;1<br><span class="hljs-built_in">cd</span> metis-5.1.0/<br><span class="hljs-comment">#./configure --prefix=$libs_DIR</span><br><br>make config prefix=<span class="hljs-variable">$libs_DIR</span><br>make<br><span class="hljs-comment">#make check</span><br>make install<br><span class="hljs-built_in">cd</span> ..<br><span class="hljs-built_in">rm</span> -rf metis-5.1.0<br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;=== metis (end) ====&quot;</span><br><span class="hljs-keyword">fi</span><br><br><span class="hljs-keyword">fi</span><br></code></pre></td></tr></table></figure><h1 id="mpasv7.3">MPASv7.3</h1><h1 id="reference">Reference</h1><ol type="1"><li><p><a href="https://forum.mmm.ucar.edu/threads/full-wrf-and-wps-installation-example-intel.15229/">Full WRF and WPS Installation Example (Intel)</a></p></li><li><p><a href="https://forum.mmm.ucar.edu/threads/make-ifort-error.340/">Make ifort error</a></p></li></ol><p>In Makefile,</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs sh">ifort:<br>( $(MAKE) all \<br><span class="hljs-string">&quot;FC_PARALLEL = mpif90&quot;</span> \<br><span class="hljs-string">&quot;CC_PARALLEL = mpicc&quot;</span> \<br><span class="hljs-string">&quot;CXX_PARALLEL = mpicxx&quot;</span> \<br><span class="hljs-string">&quot;FC_SERIAL = ifort&quot;</span> \<br><span class="hljs-string">&quot;CC_SERIAL = icc&quot;</span> \<br><span class="hljs-string">&quot;CXX_SERIAL = icpc&quot;</span> \<br><span class="hljs-string">&quot;FFLAGS_PROMOTION = -real-size 64&quot;</span> \<br><span class="hljs-string">&quot;FFLAGS_OPT = -O3 -convert big_endian -free -align array64byte&quot;</span> \<br><span class="hljs-string">&quot;CFLAGS_OPT = -O3&quot;</span> \<br><span class="hljs-string">&quot;CXXFLAGS_OPT = -O3&quot;</span> \<br><span class="hljs-string">&quot;LDFLAGS_OPT = -O3&quot;</span> \<br><span class="hljs-string">&quot;FFLAGS_DEBUG = -g -convert big_endian -free -CU -CB -check all -fpe0 -traceback&quot;</span> \<br><span class="hljs-string">&quot;CFLAGS_DEBUG = -g -traceback&quot;</span> \<br><span class="hljs-string">&quot;CXXFLAGS_DEBUG = -g -traceback&quot;</span> \<br><span class="hljs-string">&quot;LDFLAGS_DEBUG = -g -fpe0 -traceback&quot;</span> \<br><span class="hljs-string">&quot;FFLAGS_OMP = -qopenmp&quot;</span> \<br><span class="hljs-string">&quot;CFLAGS_OMP = -qopenmp&quot;</span> \<br><span class="hljs-string">&quot;CORE = <span class="hljs-subst">$(CORE)</span>&quot;</span> \<br><span class="hljs-string">&quot;DEBUG = <span class="hljs-subst">$(DEBUG)</span>&quot;</span> \<br><span class="hljs-string">&quot;USE_PAPI = <span class="hljs-subst">$(USE_PAPI)</span>&quot;</span> \<br><span class="hljs-string">&quot;OPENMP = <span class="hljs-subst">$(OPENMP)</span>&quot;</span> \<br><span class="hljs-string">&quot;CPPFLAGS = <span class="hljs-subst">$(MODEL_FORMULATION)</span> -D_MPI&quot;</span> )<br></code></pre></td></tr></table></figure><p>where use <strong>mpif90/mpicc/mpicxx</strong> but now we want to use <strong>mpiifort/mpiicc/mpiicpc</strong>.</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># After reading your comment I decided to edit the Makefile, and in the lines of ifort I made the following change:</span><br><span class="hljs-comment"># Code:</span><br>ifort:<br>        ( $(MAKE) all \<br>        <span class="hljs-string">&quot;FC_PARALLEL = mpiifort&quot;</span> \<br>        <span class="hljs-string">&quot;CC_PARALLEL = mpiicc&quot;</span> \<br>        <span class="hljs-string">&quot;CXX_PARALLEL = mpiicpc&quot;</span> \<br>        <span class="hljs-string">&quot;FC_SERIAL = ifort&quot;</span> \<br>        <span class="hljs-string">&quot;CC_SERIAL = icc&quot;</span> \<br>        <span class="hljs-string">&quot;CXX_SERIAL = icpc&quot;</span> \<br></code></pre></td></tr></table></figure><h1 id="for-mpasv8.1.0">For MPASv8.1.0,</h1><p><a href="https://github.com/MPAS-Dev/MPAS-Model/releases/tag/v8.1.0" class="uri">https://github.com/MPAS-Dev/MPAS-Model/releases/tag/v8.1.0</a></p><p>The top-level Makefile provides a new intel build target for the Intel oneAPI Fortran, C, and C++ compiler suite. {:.info}</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs sh">intel-mpi:   <span class="hljs-comment"># BUILDTARGET Intel compiler suite with Intel MPI library</span><br>( $(MAKE) all \<br><span class="hljs-string">&quot;FC_PARALLEL = mpiifort&quot;</span> \<br><span class="hljs-string">&quot;CC_PARALLEL = mpiicc&quot;</span> \<br><span class="hljs-string">&quot;CXX_PARALLEL = mpiicpc&quot;</span> \<br><span class="hljs-string">&quot;FC_SERIAL = ifort&quot;</span> \<br><span class="hljs-string">&quot;CC_SERIAL = icc&quot;</span> \<br><span class="hljs-string">&quot;CXX_SERIAL = icpc&quot;</span> \<br><span class="hljs-string">&quot;FFLAGS_PROMOTION = -real-size 64&quot;</span> \<br><span class="hljs-string">&quot;FFLAGS_OPT = -O3 -convert big_endian -free -align array64byte&quot;</span> \<br><span class="hljs-string">&quot;CFLAGS_OPT = -O3&quot;</span> \<br><span class="hljs-string">&quot;CXXFLAGS_OPT = -O3&quot;</span> \<br><span class="hljs-string">&quot;LDFLAGS_OPT = -O3&quot;</span> \<br><span class="hljs-string">&quot;FFLAGS_DEBUG = -g -convert big_endian -free -CU -CB -check all -fpe0 -traceback&quot;</span> \<br><span class="hljs-string">&quot;CFLAGS_DEBUG = -g -traceback&quot;</span> \<br><span class="hljs-string">&quot;CXXFLAGS_DEBUG = -g -traceback&quot;</span> \<br><span class="hljs-string">&quot;LDFLAGS_DEBUG = -g -fpe0 -traceback&quot;</span> \<br><span class="hljs-string">&quot;FFLAGS_OMP = -qopenmp&quot;</span> \<br><span class="hljs-string">&quot;CFLAGS_OMP = -qopenmp&quot;</span> \<br><span class="hljs-string">&quot;PICFLAG = -fpic&quot;</span> \<br><span class="hljs-string">&quot;BUILD_TARGET = <span class="hljs-subst">$(@)</span>&quot;</span> \<br><span class="hljs-string">&quot;CORE = <span class="hljs-subst">$(CORE)</span>&quot;</span> \<br><span class="hljs-string">&quot;DEBUG = <span class="hljs-subst">$(DEBUG)</span>&quot;</span> \<br><span class="hljs-string">&quot;USE_PAPI = <span class="hljs-subst">$(USE_PAPI)</span>&quot;</span> \<br><span class="hljs-string">&quot;OPENMP = <span class="hljs-subst">$(OPENMP)</span>&quot;</span> \<br><span class="hljs-string">&quot;CPPFLAGS = <span class="hljs-subst">$(MODEL_FORMULATION)</span> -D_MPI&quot;</span> )<br></code></pre></td></tr></table></figure><p>$ make intel-mpi CORE=core options {:.info}</p>]]></content>
    
    
    <categories>
      
      <category>MPAS</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Installation</tag>
      
      <tag>MPAS</tag>
      
      <tag>Spack</tag>
      
      <tag>Intel</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>MPAS | install ParallelIO-pio2_5_8</title>
    <link href="/2024/05/31/MPAS_install_ParallelIO-pio2_error/"/>
    <url>/2024/05/31/MPAS_install_ParallelIO-pio2_error/</url>
    
    <content type="html"><![CDATA[<h1 id="issue-solution">Issue &amp; solution</h1><ol type="1"><li><p>needs cmake &gt; $ micromamba env create -n mpas_env python=3.9 &gt; micromamba install anaconda::cmake</p></li><li><p>cmake</p></li></ol><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-built_in">export</span> libs_DIR=<span class="hljs-variable">$HOME</span>/Library/<br><span class="hljs-comment">### Compilers</span><br><span class="hljs-built_in">export</span> MPI_FC=mpifort<br><span class="hljs-built_in">export</span> MPI_F77=mpifort<br><span class="hljs-built_in">export</span> MPI_F90=mpifort<br><span class="hljs-built_in">export</span> MPI_CC=mpicc<br><span class="hljs-built_in">export</span> MPI_CXX=mpic++<br><span class="hljs-comment">### all serial are same as MPI</span><br><span class="hljs-built_in">export</span> FC=<span class="hljs-variable">$&#123;MPI_FC&#125;</span><br><span class="hljs-built_in">export</span> F77=<span class="hljs-variable">$&#123;MPI_F77&#125;</span><br><span class="hljs-built_in">export</span> F90=<span class="hljs-variable">$&#123;MPI_F77&#125;</span><br><span class="hljs-built_in">export</span> CC=<span class="hljs-variable">$&#123;MPI_F77&#125;</span><br><span class="hljs-built_in">export</span> CXX=<span class="hljs-variable">$&#123;MPI_F77&#125;</span><br></code></pre></td></tr></table></figure><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment">############################## Pio ############################</span><br><span class="hljs-keyword">if</span> [[ <span class="hljs-variable">$&#123;do_pio&#125;</span> == True ]]; <span class="hljs-keyword">then</span><br>    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;=== PIO ====&quot;</span><br>    <span class="hljs-built_in">cd</span> <span class="hljs-variable">$download_DIR</span><br>    tar xvf ParallelIO-pio2_5_8.tar.gz 1&gt;/dev/null 2&gt;&amp;1<br>    <span class="hljs-built_in">cd</span> ParallelIO-pio2_5_8/<br><br>    <span class="hljs-built_in">export</span> CC=mpicc <br>    <span class="hljs-built_in">export</span> FC=mpif90 <br>    <span class="hljs-comment">#./configure --prefix=$libs_DIR --enable-fortran</span><br>    <span class="hljs-comment">#cmake -DNetCDF_C_PATH=$libs_DIR -DNetCDF_Fortran_PATH=$libs_DIR -DPnetCDF_PATH=$libs_DIR -DPIO_ENABLE_TIMING=OFF -DCMAKE_INSTALL_PREFIX=$libs_DIR</span><br>    cmake -DNetCDF_C_PATH=<span class="hljs-variable">$NETCDF</span> -DNetCDF_Fortran_PATH=<span class="hljs-variable">$NETCDF</span> -DPnetCDF_PATH=<span class="hljs-variable">$PNETCDF</span> -DHDF5_PATH=<span class="hljs-variable">$libs_DIR</span> -DCMAKE_INSTALL_PREFIX=<span class="hljs-variable">$libs_DIR</span> -DPIO_USE_MALLOC=ON -DCMAKE_VERBOSE_MAKEFILE=1 -DPIO_ENABLE_TIMING=OFF ./<br>    make<br>    <span class="hljs-comment">#make check</span><br>    make install<br>    <span class="hljs-built_in">cd</span> ..<br>    <span class="hljs-built_in">rm</span> -rf ParallelIO-pio2_5_8<br>    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;=== PIO (end) ====&quot;</span><br><span class="hljs-keyword">fi</span><br></code></pre></td></tr></table></figure><p>where ./ is PIO directory.</p><figure class="highlight basic"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs basic"><span class="hljs-symbol">568 </span>Install the project...<br><span class="hljs-symbol">569 </span>/home/wpsze/micromamba/envs/mpas_env/bin/cmake -P cmake_install.cmake<br><span class="hljs-symbol">570 </span>-- Install configuration: <span class="hljs-string">&quot;&quot;</span><br><span class="hljs-symbol">571 </span>-- Installing: /home/wpsze/MPAS-A/modules_library/Library/lib/libpio.settings<br><span class="hljs-symbol">572 </span>-- Installing: /home/wpsze/MPAS-A/modules_library/Library/lib/libpioc.a<br><span class="hljs-symbol">573 </span>-- Installing: /home/wpsze/MPAS-A/modules_library/Library/include/pio.h<br><span class="hljs-symbol">574 </span>-- Installing: /home/wpsze/MPAS-A/modules_library/Library/include/uthash.h<br><span class="hljs-symbol">575 </span>-- Installing: /home/wpsze/MPAS-A/modules_library/Library/lib/libpiof.a<br><span class="hljs-symbol">576 </span>-- Installing: /home/wpsze/MPAS-A/modules_library/Library/include/pio.<span class="hljs-keyword">mod</span><br><span class="hljs-symbol">577 </span>-- Installing: /home/wpsze/MPAS-A/modules_library/Library/include/pio_nf.<span class="hljs-keyword">mod</span><br><span class="hljs-symbol">578 </span>-- Installing: /home/wpsze/MPAS-A/modules_library/Library/include/pio_types.<span class="hljs-keyword">mod</span><br><span class="hljs-symbol">579 </span>-- Installing: /home/wpsze/MPAS-A/modules_library/Library/include/piolib_mod.<span class="hljs-keyword">mod</span><br><span class="hljs-symbol">580 </span>-- Installing: /home/wpsze/MPAS-A/modules_library/Library/include/pionfget_mod.<span class="hljs-keyword">mod</span><br><span class="hljs-symbol">581 </span>-- Installing: /home/wpsze/MPAS-A/modules_library/Library/include/pio_kinds.<span class="hljs-keyword">mod</span><br><span class="hljs-symbol">582 </span>-- Installing: /home/wpsze/MPAS-A/modules_library/Library/include/pio_support.<span class="hljs-keyword">mod</span><br><span class="hljs-symbol">583 </span>-- Installing: /home/wpsze/MPAS-A/modules_library/Library/include/piodarray.<span class="hljs-keyword">mod</span><br><span class="hljs-symbol">584 </span>-- Installing: /home/wpsze/MPAS-A/modules_library/Library/include/pionfatt_mod.<span class="hljs-keyword">mod</span><br><span class="hljs-symbol">585 </span>-- Installing: /home/wpsze/MPAS-A/modules_library/Library/include/pionfput_mod.<span class="hljs-keyword">mod</span><br></code></pre></td></tr></table></figure><p>Output files are,</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash"> $ <span class="hljs-built_in">ls</span> Library/lib/*pio*<br>Library/lib/libpioc.a  Library/lib/libpiof.a<br> $ <span class="hljs-built_in">ls</span> Library/include/*pio*<br>Library/include/H5FDmpio.h  Library/include/piodarray.mod  Library/include/piolib_mod.mod    Library/include/pionfget_mod.mod  Library/include/pio_support.mod<br>Library/include/mpiof.h     Library/include/pio.h          Library/include/pio.mod           Library/include/pio_nf.mod        Library/include/pio_types.mod<br>Library/include/mpio.h      Library/include/pio_kinds.mod  Library/include/pionfatt_mod.mod  Library/include/pionfput_mod.mod<br></code></pre></td></tr></table></figure><p>Ref: 1. <a href="https://forum.mmm.ucar.edu/threads/mpas-a-installation-failed-due-to-pio1-f90-and-pio2-f90.9902/">MPAS-A installation failed due to pio1.f90 and pio2.f90</a> 2.</p>]]></content>
    
    
    <categories>
      
      <category>MPAS</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Installation</tag>
      
      <tag>PIO</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>MPAS | install Metis</title>
    <link href="/2024/05/31/MPAS_install_metis_error/"/>
    <url>/2024/05/31/MPAS_install_metis_error/</url>
    
    <content type="html"><![CDATA[<h1 id="metis---serial-graph-partitioning-and-fill-reducing-matrix-ordering">METIS - Serial Graph Partitioning and Fill-reducing Matrix Ordering</h1><p><a href="http://glaros.dtc.umn.edu/gkhome/metis/metis/overview">METIS</a> is a set of serial programs for partitioning graphs, partitioning finite element meshes, and producing fill reducing orderings for sparse matrices. The algorithms implemented in METIS are based on the multilevel recursive-bisection, multilevel k-way, and multi-constraint partitioning schemes developed in our lab.</p><h1 id="issue-solution">Issue &amp; Solution</h1><figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs clean">############################## metis ############################<br><span class="hljs-keyword">if</span> [[ $&#123;do_metis&#125; == <span class="hljs-literal">True</span> ]]; then<br>echo <span class="hljs-string">&quot;=== metis ====&quot;</span><br>cd $download_DIR<br>tar xvf metis<span class="hljs-number">-5.1</span><span class="hljs-number">.0</span>.tar.gz <span class="hljs-number">1</span>&gt;/dev/null <span class="hljs-number">2</span>&gt;&amp;<span class="hljs-number">1</span><br>cd metis<span class="hljs-number">-5.1</span><span class="hljs-number">.0</span>/<br>#./configure --prefix=$libs_DIR<br><br>make config prefix=$libs_DIR<br>make<br>#make check<br>make install<br>cd ..<br>rm -rf metis<span class="hljs-number">-5.1</span><span class="hljs-number">.0</span><br>echo <span class="hljs-string">&quot;=== metis (end) ====&quot;</span><br>fi<br></code></pre></td></tr></table></figure><p>Output files are,</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash"> $ <span class="hljs-built_in">ls</span> Library/bin/*meti*<br>Library/bin/gpmetis  Library/bin/m2gmetis  Library/bin/mpmetis  Library/bin/ndmetis<br> $ <span class="hljs-built_in">ls</span> Library/lib/*meti*<br>Library/lib/libmetis.a<br> $ <span class="hljs-built_in">ls</span> Library/include/*meti*<br>Library/include/metis.h<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>MPAS</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Installation</tag>
      
      <tag>Metis</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>MPAS | MPAS Installation</title>
    <link href="/2024/05/31/MPAS_installation/"/>
    <url>/2024/05/31/MPAS_installation/</url>
    
    <content type="html"><![CDATA[<h1 id="for-mpasv7.0-and-above">For MPASv7.0 and above,</h1><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-meta">#!/bin/bash</span><br><br><span class="hljs-comment">#------------------------------------------------#</span><br><span class="hljs-comment">#Author:         wpsze</span><br><span class="hljs-comment">#Email：         </span><br><span class="hljs-comment">#date:           </span><br><span class="hljs-comment">#Version:        0.0 </span><br><span class="hljs-comment">#Description:    Install libraries that MPAS needs </span><br><span class="hljs-comment">#Copyright (C)： 2022 All rights reserved</span><br><span class="hljs-comment">#------------------------------------------------#</span><br><br><span class="hljs-comment">## ./mpas_env_install_gcc10_3_0.sh 2&gt;&amp;1 |tee log.log</span><br><br><span class="hljs-comment">############################## Directory Listing ############################</span><br><span class="hljs-built_in">export</span> HOME=`<span class="hljs-built_in">pwd</span>`<br><br><span class="hljs-built_in">source</span> /home/wpsze/MPAS-A/mpas_env.sh<br><br>gcc --version<br>g++ --version<br>gfortran --version<br>mpif90 --version<br>mpicc --version<br>make --version<br>cmake --version<br><br><span class="hljs-built_in">echo</span> <span class="hljs-variable">$NETCDF</span><br><span class="hljs-built_in">echo</span> <span class="hljs-variable">$PNETCDF</span><br><span class="hljs-built_in">echo</span> <span class="hljs-variable">$PIO</span><br><br><span class="hljs-comment">##--Intel MPI与Open MPI、MPICH等MPI实现不同：</span><br><span class="hljs-comment">##--mpiicc、mpiicpc和mpiifort命令：使用Intel编译器</span><br><span class="hljs-comment">##--mpicc、mpif90和mpifc命令：默认使用GNU编译器</span><br><br>do_init_atmosphere=True <span class="hljs-comment"># True, False</span><br>do_atmosphere=True<br>do_build_tables=True<br><br>mpas_version=<span class="hljs-string">&quot;MPASv8&quot;</span><br><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;Copy MPAS-Model to build-mpas ... &quot;</span><br><span class="hljs-built_in">rm</span> -rf build-mpas<br><span class="hljs-built_in">cp</span> -r MPAS-Model-8.0.0 build-mpas<br><span class="hljs-built_in">cd</span> build-mpas<br><br><span class="hljs-comment">############################## init_atmosphere ############################ -g -O0 -fbacktrace</span><br><span class="hljs-keyword">if</span> [[ <span class="hljs-variable">$&#123;do_init_atmosphere&#125;</span> == True ]]; <span class="hljs-keyword">then</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;=== init_atmosphere ====&quot;</span><br><br>make clean CORE=init_atmosphere<br>make clean CORE=atmosphere<br><br><span class="hljs-comment"># mpas_dmpar.F:</span><br> <span class="hljs-comment"># call MPI_Allreduce(inArray, outArray, nElements, MPI_INTEGERKIND, MPI_MAX, dminfo % comm, mpi_ierr) </span><br><span class="hljs-comment"># Warning: Rank mismatch between actual argument at (1) and actual argument at (2) (scalar and rank-1)</span><br><br><span class="hljs-comment">#export FFLAGS=&quot;-w -fallow-argument-mismatch -O2&quot;</span><br><span class="hljs-comment">#export FCFLAGS=&quot;-w -fallow-argument-mismatch -O2&quot;</span><br><br><span class="hljs-comment"># make gfortran CORE=init_atmosphere PRECISION=single DEBUG=true USE_PIO2=true &gt;&amp; log_build2.txt</span><br><br>make -j8 gfortran CORE=init_atmosphere PRECISION=single USE_PIO2=<span class="hljs-literal">true</span> 2&gt;&amp;1 |<span class="hljs-built_in">tee</span> log_build_init.txt<br><br><span class="hljs-comment">### Check MPAS model.</span><br><span class="hljs-comment">#ls -la init_atmosphere_model</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;=== init_atmosphere (end) ====&quot;</span><br>: <span class="hljs-string">&#x27;</span><br><span class="hljs-string">*******************************************************************************</span><br><span class="hljs-string">MPAS was built with default single-precision reals.</span><br><span class="hljs-string">Debugging is off.</span><br><span class="hljs-string">Parallel version is on.</span><br><span class="hljs-string">Papi libraries are off.</span><br><span class="hljs-string">TAU Hooks are off.</span><br><span class="hljs-string">MPAS was built without OpenMP support.</span><br><span class="hljs-string">MPAS was built with .F files.</span><br><span class="hljs-string">The native timer interface is being used</span><br><span class="hljs-string">Using the PIO 2 library.</span><br><span class="hljs-string">*******************************************************************************</span><br><span class="hljs-string">make[1]: Leaving directory /home/wpsze/MPAS-A/mpasv73/MPAS-Model-7.3</span><br><span class="hljs-string">If compilation of the init_atmosphere core was successful, we should also have an executable file named init_atmosphere_model</span><br><span class="hljs-string">&#x27;</span><br><span class="hljs-keyword">fi</span><br><br><span class="hljs-comment">############################## atmosphere_model ############################</span><br><span class="hljs-keyword">if</span> [[ <span class="hljs-variable">$&#123;do_atmosphere&#125;</span> == True ]]; <span class="hljs-keyword">then</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;=== atmosphere_model ====&quot;</span><br><span class="hljs-comment"># To preserve all executables except atmosphere_model and clean the MPAS infrastructure, run: </span><br>make clean CORE=atmosphere<br><br><span class="hljs-comment">#export FFLAGS=&quot;-w -fallow-argument-mismatch -O2&quot;</span><br><span class="hljs-comment">#export FCFLAGS=&quot;-w -fallow-argument-mismatch -O2&quot;</span><br><br><span class="hljs-comment"># DEBUG=true</span><br><br>make gfortran CORE=atmosphere PRECISION=single USE_PIO2=<span class="hljs-literal">true</span> 2&gt;&amp;1 |<span class="hljs-built_in">tee</span> log_build_atm.txt<br><br><span class="hljs-comment">### Check MPAS model.</span><br><span class="hljs-comment">#ls -la atmosphere_model</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;=== atmosphere_model (end) ====&quot;</span><br>: <span class="hljs-string">&#x27;</span><br><span class="hljs-string">*******************************************************************************</span><br><span class="hljs-string">MPAS was built with default single-precision reals.</span><br><span class="hljs-string">Debugging is off.</span><br><span class="hljs-string">Parallel version is on.</span><br><span class="hljs-string">Papi libraries are off.</span><br><span class="hljs-string">TAU Hooks are off.</span><br><span class="hljs-string">MPAS was built without OpenMP support.</span><br><span class="hljs-string">MPAS was built with .F files.</span><br><span class="hljs-string">The native timer interface is being used</span><br><span class="hljs-string">Using the PIO 2 library.</span><br><span class="hljs-string">*******************************************************************************</span><br><span class="hljs-string">&#x27;</span><br><br><span class="hljs-built_in">wait</span><br><br><span class="hljs-keyword">fi</span><br><br><span class="hljs-keyword">if</span> [[ -f atmosphere_model ]]; <span class="hljs-keyword">then</span><br><span class="hljs-built_in">mkdir</span> -p <span class="hljs-variable">$HOME</span>/<span class="hljs-variable">$&#123;mpas_version&#125;</span><br><span class="hljs-built_in">mv</span> streams.init_atmosphere <span class="hljs-variable">$HOME</span>/<span class="hljs-variable">$&#123;mpas_version&#125;</span><br><span class="hljs-built_in">mv</span> namelist.init_atmosphere <span class="hljs-variable">$HOME</span>/<span class="hljs-variable">$&#123;mpas_version&#125;</span><br><span class="hljs-built_in">mv</span> init_atmosphere_model <span class="hljs-variable">$HOME</span>/<span class="hljs-variable">$&#123;mpas_version&#125;</span><br><br><span class="hljs-built_in">mv</span> atmosphere_model <span class="hljs-variable">$HOME</span>/<span class="hljs-variable">$&#123;mpas_version&#125;</span><br><span class="hljs-built_in">mv</span> build_tables <span class="hljs-variable">$HOME</span>/<span class="hljs-variable">$&#123;mpas_version&#125;</span><br><span class="hljs-built_in">mv</span> namelist.atmosphere <span class="hljs-variable">$HOME</span>/<span class="hljs-variable">$&#123;mpas_version&#125;</span><br><span class="hljs-built_in">mv</span> streams.atmosphere <span class="hljs-variable">$HOME</span>/<span class="hljs-variable">$&#123;mpas_version&#125;</span><br><span class="hljs-built_in">mv</span> stream_list.atmosphere.diagnostics <span class="hljs-variable">$HOME</span>/<span class="hljs-variable">$&#123;mpas_version&#125;</span><br><span class="hljs-built_in">mv</span> stream_list.atmosphere.output <span class="hljs-variable">$HOME</span>/<span class="hljs-variable">$&#123;mpas_version&#125;</span><br><span class="hljs-built_in">mv</span> stream_list.atmosphere.surface <span class="hljs-variable">$HOME</span>/<span class="hljs-variable">$&#123;mpas_version&#125;</span><br><br><span class="hljs-built_in">mv</span> ./src/core_atmosphere/physics/physics_wrf/files/* <span class="hljs-variable">$HOME</span>/<span class="hljs-variable">$&#123;mpas_version&#125;</span>/<br><br><span class="hljs-keyword">if</span> [[ <span class="hljs-variable">$&#123;do_build_tables&#125;</span> == True ]]; <span class="hljs-keyword">then</span><br><span class="hljs-built_in">cd</span> <span class="hljs-variable">$HOME</span>/<span class="hljs-variable">$&#123;mpas_version&#125;</span><br>./build_tables<br><span class="hljs-keyword">fi</span><br><br><span class="hljs-keyword">fi</span><br></code></pre></td></tr></table></figure><p>and,</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-meta">#!/bin/bash</span><br><br><span class="hljs-comment">#------------------------------------------------#</span><br><span class="hljs-comment">#Author:         wpsze</span><br><span class="hljs-comment">#homeail：        </span><br><span class="hljs-comment">#date:           </span><br><span class="hljs-comment">#Version:        0.0 </span><br><span class="hljs-comment">#Description:    Install libraries that MPAS needs </span><br><span class="hljs-comment">#Copyright (C)： 2022 All rights reserved</span><br><span class="hljs-comment">#------------------------------------------------#</span><br><br><span class="hljs-comment">############################## Directory Listing ############################</span><br><span class="hljs-built_in">export</span> HOME=`<span class="hljs-built_in">pwd</span>`<br><span class="hljs-built_in">export</span> download_DIR=<span class="hljs-variable">$HOME</span>/mpas_install/<br><span class="hljs-built_in">export</span> libs_DIR=<span class="hljs-variable">$HOME</span>/Library/<br><br><span class="hljs-built_in">export</span> PATH=/home/wpsze/GNU_GCC/Library/gcc-v9.3.0/bin:<span class="hljs-variable">$PATH</span><br><span class="hljs-built_in">export</span> LD_LIBRARY_PATH=/home/wpsze/GNU_GCC/Library/gcc-v9.3.0/lib/<span class="hljs-variable">$&#123;LD_LIBRARY_PATH:+:$LD_LIBRARY_PATH&#125;</span><br><span class="hljs-comment">#export LD_LIBRARY_PATH=/home/wpsze/GNU_GCC/Library/gcc-v9.3.0/lib:$LD_LIBRARY_PATH</span><br><span class="hljs-built_in">export</span> LD_LIBRARY_PATH=/home/wpsze/GNU_GCC/Library/gcc-v9.3.0/lib64:<span class="hljs-variable">$LD_LIBRARY_PATH</span><br><br><span class="hljs-built_in">export</span> LD_LIBRARY_PATH=<span class="hljs-variable">$libs_DIR</span>/lib:<span class="hljs-variable">$LD_LIBRARY_PATH</span><br><span class="hljs-built_in">export</span> LDFLAGS=-L<span class="hljs-variable">$libs_DIR</span>/lib<br><span class="hljs-built_in">export</span> CPPFLAGS=-I<span class="hljs-variable">$libs_DIR</span>/include<br><br><span class="hljs-built_in">source</span> /home/wpsze/micromamba/etc/profile.d/micromamba.sh <span class="hljs-comment"># install cmake</span><br>micromamba activate mpas_env<br><br>gcc --version<br>gfortran --version<br><br><span class="hljs-built_in">echo</span> <span class="hljs-variable">$HOME</span><br><span class="hljs-built_in">echo</span> <span class="hljs-variable">$download_DIR</span><br><span class="hljs-built_in">echo</span> <span class="hljs-variable">$libs_DIR</span><br><br><span class="hljs-built_in">mkdir</span> -p mpas_install<br><span class="hljs-built_in">mkdir</span> -p Library<br><br>do_download=False <span class="hljs-comment"># True or False</span><br>compile_all=True<br><br><span class="hljs-comment"># Currently Loaded Modules:</span><br><span class="hljs-comment">#  1) ncarenv/1.0 (xx)      4) ncarcompilers/1.0 (xx)  7) pnetcdf/1.11.2  10) ncview/2.1.7 (already)</span><br><span class="hljs-comment">#  2) ncarbinlibs/1.1 (xx)  5) netcdf/4.7.0        8) pio/1.9.23 (2.5.2)      11) metis/5.1.0</span><br><span class="hljs-comment">#  3) gnu/8.3.0 (done)         6) mpich/3.3.1         9) ncl/6.6.2 (already)       12) hdf5/1.10.5</span><br><br>do_mpich=False<br>do_zlib=False<br>do_hdf5=False<br>do_pnetcdf=False<br>do_netcdfC=False<br>do_netcdfF=False<br>do_pio=False<br>do_metis=True<br><br><span class="hljs-comment">############################## Downloading Libraries ############################</span><br><span class="hljs-keyword">if</span> [[ <span class="hljs-variable">$do_download</span>  == True ]]; <span class="hljs-keyword">then</span><br>    <span class="hljs-built_in">cd</span> <span class="hljs-variable">$download_DIR</span><br>    wget -c https://zlib.net/zlib-1.2.13.tar.gz<br>    wget -c https://www.gfd-dennou.org/arch/netcdf/unidata-mirror/netcdf-c-4.7.4.tar.gz<br>    wget -c https://www.gfd-dennou.org/arch/netcdf/unidata-mirror/netcdf-fortran-4.5.3.tar.gz<br>    <span class="hljs-comment"># wget -c https://github.com/pmodels/mpich/releases/download/v4.0.2/mpich-4.0.2.tar.gz</span><br>    wget -c https://www.mpich.org/static/downloads/3.3.1/mpich-3.3.1.tar.gz<br>    wget -c https://parallel-netcdf.github.io/Release/pnetcdf-1.11.2.tar.gz <br>    <span class="hljs-comment"># Pio is from https://github.com/NCAR/ParallelIO/releases</span><br>    <span class="hljs-comment"># metis is from http://glaros.dtc.umn.edu/gkhome/metis/metis/download</span><br>    wget -c https://hdf-wordpress-1.s3.amazonaws.com/wp-content/uploads/manual/HDF5/HDF5_1_12_0/source/hdf5-1.12.0.tar.gz<br><br><span class="hljs-keyword">fi</span><br><br><span class="hljs-keyword">if</span> [[ <span class="hljs-variable">$compile_all</span> == True ]]; <span class="hljs-keyword">then</span><br><span class="hljs-comment">###################################################################</span><br><span class="hljs-built_in">export</span> LD_LIBRARY_PATH=<span class="hljs-variable">$libs_DIR</span>/lib:<span class="hljs-variable">$LD_LIBRARY_PATH</span><br><span class="hljs-built_in">export</span> LDFLAGS=-L<span class="hljs-variable">$libs_DIR</span>/lib<br><span class="hljs-built_in">export</span> CPPFLAGS=-I<span class="hljs-variable">$libs_DIR</span>/include<br><span class="hljs-built_in">export</span> PATH=<span class="hljs-variable">$libs_DIR</span>/bin:<span class="hljs-variable">$PATH</span><br><br><span class="hljs-comment">#export PNETCDF_PATH=$libs_DIR/bin:$PATH</span><br><span class="hljs-comment">#export PNETCDF=$libs_DIR/bin:$PATH</span><br><br><span class="hljs-comment">#export NETCDF_PATH=$libs_DIR/bin:$PATH</span><br><span class="hljs-comment">#export NETCDF=$libs_DIR/bin:$PATH</span><br><br><span class="hljs-comment">#export PIO=$libs_DIR/bin:$PATH</span><br><br><span class="hljs-comment">############################## MPICH ############################</span><br><span class="hljs-keyword">if</span> [[ <span class="hljs-variable">$&#123;do_mpich&#125;</span>  == True ]]; <span class="hljs-keyword">then</span><br><span class="hljs-comment">#export PATH=$libs_DIR/gcc-v8.3.0/bin:$PATH</span><br><span class="hljs-comment">#export LD_LIBRARY_PATH=$libs_DIR/gcc-v8.3.0/lib:$LD_LIBRARY_PATH</span><br><span class="hljs-comment">#export LD_LIBRARY_PATH=$libs_DIR/gcc-v8.3.0/lib64:$LD_LIBRARY_PATH</span><br><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;=== MPICH ====&quot;</span><br><span class="hljs-built_in">cd</span> <span class="hljs-variable">$download_DIR</span><br>tar xvf mpich-4.0.2.tar.gz 1&gt;/dev/null 2&gt;&amp;1  <span class="hljs-comment"># 3.3.1 4.0.2</span><br><span class="hljs-built_in">cd</span> mpich-4.0.2/<br><br>./configure --prefix=<span class="hljs-variable">$libs_DIR</span> --with-device=ch3 <span class="hljs-comment">#--enable-pic</span><br>make -j 4<br>make check<br>make install<br><span class="hljs-comment">#make testing</span><br><span class="hljs-built_in">cd</span> ..<br><span class="hljs-built_in">rm</span> -rf mpich-4.0.2<br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;=== MPICH (end) ====&quot;</span><br><span class="hljs-keyword">fi</span><br><br><span class="hljs-comment">### Compilers</span><br><span class="hljs-comment">## commment out for mpich</span><br><span class="hljs-built_in">export</span> SERIAL_FC=gfortran<br><span class="hljs-built_in">export</span> SERIAL_F77=gfortran<br><span class="hljs-built_in">export</span> SERIAL_CC=gcc<br><span class="hljs-built_in">export</span> SERIAL_CXX=g++<br><span class="hljs-built_in">export</span> MPI_FC=mpifort<br><span class="hljs-built_in">export</span> MPI_F77=mpifort<br><span class="hljs-built_in">export</span> MPI_F90=mpifort<br><span class="hljs-built_in">export</span> MPI_CC=mpicc<br><span class="hljs-built_in">export</span> MPI_CXX=mpic++<br><span class="hljs-comment">### all serial are same as MPI</span><br><span class="hljs-built_in">export</span> FC=<span class="hljs-variable">$&#123;MPI_FC&#125;</span><br><span class="hljs-built_in">export</span> F77=<span class="hljs-variable">$&#123;MPI_F77&#125;</span><br><span class="hljs-built_in">export</span> F90=<span class="hljs-variable">$&#123;MPI_F77&#125;</span><br><span class="hljs-built_in">export</span> CC=<span class="hljs-variable">$&#123;MPI_F77&#125;</span><br><span class="hljs-built_in">export</span> CXX=<span class="hljs-variable">$&#123;MPI_F77&#125;</span><br><br><span class="hljs-comment">############################## zlib ############################ *** zlib test OK ***</span><br><span class="hljs-keyword">if</span> [[ <span class="hljs-variable">$&#123;do_zlib&#125;</span>  == True ]]; <span class="hljs-keyword">then</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;=== zlib ====&quot;</span><br><span class="hljs-built_in">cd</span> <span class="hljs-variable">$download_DIR</span><br>tar xvf zlib-1.2.13.tar.gz 1&gt;/dev/null 2&gt;&amp;1 <br><span class="hljs-built_in">cd</span> zlib-1.2.13/<br><br>./configure --prefix=<span class="hljs-variable">$libs_DIR</span> <span class="hljs-comment">#--static</span><br>make -j 4<br>make install<br>make check<br><span class="hljs-built_in">cd</span> ..<br><span class="hljs-built_in">rm</span> -rf zlib-1.2.13<br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;=== zlib (end) ====&quot;</span><br><span class="hljs-keyword">fi</span><br><br><span class="hljs-comment">############################## HDF5 ############################ </span><br><span class="hljs-keyword">if</span> [[ <span class="hljs-variable">$&#123;do_hdf5&#125;</span> == True ]]; <span class="hljs-keyword">then</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;=== hdf5 ====&quot;</span><br><span class="hljs-built_in">cd</span> <span class="hljs-variable">$download_DIR</span><br>tar xvf hdf5-1.12.0.tar.gz 1&gt;/dev/null 2&gt;&amp;1 <br><span class="hljs-built_in">cd</span> hdf5-1.12.0/<br><br>./configure --prefix=<span class="hljs-variable">$libs_DIR</span> --enable-parallel --with-zlib=<span class="hljs-variable">$libs_DIR</span> --enable-fortran <span class="hljs-comment">#--disable-shared</span><br>make -j 4<br>make check<br>make install<br><span class="hljs-built_in">cd</span> ..<br><span class="hljs-built_in">rm</span> -rf hdf5-1.12.0<br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;=== hdf5 (end) ====&quot;</span><br><span class="hljs-keyword">fi</span><br><br><span class="hljs-comment">############################## pnetcdf ############################ PnetCDF has been successfully installed </span><br><span class="hljs-keyword">if</span> [[ <span class="hljs-variable">$&#123;do_pnetcdf&#125;</span> == True ]]; <span class="hljs-keyword">then</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;=== pnetcdf ====&quot;</span><br><span class="hljs-built_in">cd</span> <span class="hljs-variable">$download_DIR</span><br>tar xvf pnetcdf-1.11.2.tar.gz 1&gt;/dev/null 2&gt;&amp;1 <br><span class="hljs-built_in">cd</span> pnetcdf-1.11.2/<br><br>./configure --prefix=<span class="hljs-variable">$libs_DIR</span><br>make -j 4<br>make check<br>make ptest<br>make testing<br>make install<br><span class="hljs-built_in">cd</span> ..<br><span class="hljs-built_in">rm</span> -rf pnetcdf-1.11.2<br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;=== pnetcdf (end) ====&quot;</span><br><span class="hljs-keyword">fi</span><br><br><span class="hljs-comment">############################## netcdf-C ############################  Congratulations! You have successfully installed netCDF!</span><br><span class="hljs-keyword">if</span> [[ <span class="hljs-variable">$&#123;do_netcdfC&#125;</span> == True ]]; <span class="hljs-keyword">then</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;=== netcdf-C ====&quot;</span><br><span class="hljs-comment">## -disable-dap：--disable-dap的原因是缺少一个‘curl’的lib</span><br><span class="hljs-comment">## 4.1.3以后的版本Fortran和C分开了。把disable--netcdf-4 写进去也无所谓</span><br><span class="hljs-built_in">cd</span> <span class="hljs-variable">$download_DIR</span><br>tar xvf netcdf-c-4.7.4.tar.gz 1&gt;/dev/null 2&gt;&amp;1 <br><span class="hljs-built_in">cd</span> netcdf-c-4.7.4/<br><br><span class="hljs-comment"># have to define below parameters</span><br><span class="hljs-built_in">export</span> FC=mpifort<br><span class="hljs-built_in">export</span> F77=mpifort<br><span class="hljs-built_in">export</span> F90=mpifort<br><span class="hljs-built_in">export</span> CC=mpicc<br><span class="hljs-built_in">export</span> CXX=mpic++<br><br><span class="hljs-comment">#export LIBS=&quot;-lhdf5_hl -lhdf5 -lz -ldl&quot;</span><br><br><span class="hljs-built_in">export</span> LD_LIBRARY_PATH=<span class="hljs-variable">$libs_DIR</span>/lib:<span class="hljs-variable">$LD_LIBRARY_PATH</span><br><span class="hljs-built_in">export</span> LDFLAGS=-L<span class="hljs-variable">$libs_DIR</span>/lib<br><span class="hljs-built_in">export</span> CPPFLAGS=-I<span class="hljs-variable">$libs_DIR</span>/include<br><br><span class="hljs-comment">#./configure --prefix=$libs_DIR --disable-dap --enable-pnetcdf --enable-netcdf4 --enable-cdf5 --enable-parallel-tests --disable-shared</span><br>./configure --prefix=<span class="hljs-variable">$libs_DIR</span> --enable-shared --enable-netcdf4 --disable-filter-testing --disable-dap<br>make -j 4 <br>make check<br>make install<br><span class="hljs-built_in">cd</span> ..<br><span class="hljs-built_in">rm</span> -rf netcdf-c-4.7.4<br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;=== netcdf-C (end) ====&quot;</span><br><span class="hljs-keyword">fi</span><br><br><span class="hljs-comment">############################## netcdf-F ############################ </span><br><span class="hljs-keyword">if</span> [[ <span class="hljs-variable">$&#123;do_netcdfF&#125;</span> == True ]]; <span class="hljs-keyword">then</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;=== netcdf-F ====&quot;</span><br><span class="hljs-built_in">cd</span> <span class="hljs-variable">$download_DIR</span><br>tar xvf netcdf-fortran-4.5.3.tar.gz 1&gt;/dev/null 2&gt;&amp;1 <br><span class="hljs-built_in">cd</span> netcdf-fortran-4.5.3/<br><br><br><span class="hljs-built_in">export</span> LD_LIBRARY_PATH=<span class="hljs-variable">$libs_DIR</span>/lib:<span class="hljs-variable">$LD_LIBRARY_PATH</span><br><span class="hljs-built_in">export</span> LDFLAGS=-L<span class="hljs-variable">$libs_DIR</span>/lib<br><span class="hljs-built_in">export</span> CPPFLAGS=-I<span class="hljs-variable">$libs_DIR</span>/include<br><br><span class="hljs-comment">#</span><br><span class="hljs-comment"># configure: error: netcdf-c version 4.7.4 or greater is required</span><br><br>nc-config --cflags<br>nc-config --libs<br>./configure --prefix=<span class="hljs-variable">$libs_DIR</span> --enable-shared <span class="hljs-comment">#--enable-parallel-tests #--disable-shared</span><br><br><span class="hljs-comment">#CFLAGS=$(nc-config --cflags) LDFLAGS=$(nc-config --libs) ./configure --prefix=$libs_DIR --enable-parallel-tests #--disable-shared</span><br><br>make -j 4 <br>make check<br>make install<br><span class="hljs-built_in">cd</span> ..<br><span class="hljs-built_in">rm</span> -rf netcdf-fortran-4.5.3<br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;=== netcdf-F (end) ====&quot;</span><br><span class="hljs-keyword">fi</span><br><br><span class="hljs-comment">############################## Pio ############################</span><br><span class="hljs-keyword">if</span> [[ <span class="hljs-variable">$&#123;do_pio&#125;</span> == True ]]; <span class="hljs-keyword">then</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;=== PIO ====&quot;</span><br><span class="hljs-built_in">cd</span> <span class="hljs-variable">$download_DIR</span><br>tar xvf ParallelIO-pio2_5_8.tar.gz 1&gt;/dev/null 2&gt;&amp;1<br><span class="hljs-built_in">cd</span> ParallelIO-pio2_5_8/<br><br><span class="hljs-built_in">export</span> CC=mpicc <br><span class="hljs-built_in">export</span> FC=mpif90 <br><span class="hljs-comment">#./configure --prefix=$libs_DIR --enable-fortran</span><br><span class="hljs-comment">#cmake -DNetCDF_C_PATH=$libs_DIR -DNetCDF_Fortran_PATH=$libs_DIR -DPnetCDF_PATH=$libs_DIR -DPIO_ENABLE_TIMING=OFF -DCMAKE_INSTALL_PREFIX=$libs_DIR</span><br>cmake -DNetCDF_C_PATH=<span class="hljs-variable">$NETCDF</span> -DNetCDF_Fortran_PATH=<span class="hljs-variable">$NETCDF</span> -DPnetCDF_PATH=<span class="hljs-variable">$PNETCDF</span> -DHDF5_PATH=<span class="hljs-variable">$libs_DIR</span> -DCMAKE_INSTALL_PREFIX=<span class="hljs-variable">$libs_DIR</span> -DPIO_USE_MALLOC=ON -DCMAKE_VERBOSE_MAKEFILE=1 -DPIO_ENABLE_TIMING=OFF ./<br>make<br><span class="hljs-comment">#make check</span><br>make install<br><span class="hljs-built_in">cd</span> ..<br><span class="hljs-built_in">rm</span> -rf ParallelIO-pio2_5_8<br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;=== PIO (end) ====&quot;</span><br><span class="hljs-keyword">fi</span><br><br><span class="hljs-comment">############################## metis ############################</span><br><span class="hljs-keyword">if</span> [[ <span class="hljs-variable">$&#123;do_metis&#125;</span> == True ]]; <span class="hljs-keyword">then</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;=== metis ====&quot;</span><br><span class="hljs-built_in">cd</span> <span class="hljs-variable">$download_DIR</span><br>tar xvf metis-5.1.0.tar.gz 1&gt;/dev/null 2&gt;&amp;1<br><span class="hljs-built_in">cd</span> metis-5.1.0/<br><span class="hljs-comment">#./configure --prefix=$libs_DIR</span><br><br>make config prefix=<span class="hljs-variable">$libs_DIR</span><br>make<br><span class="hljs-comment">#make check</span><br>make install<br><span class="hljs-built_in">cd</span> ..<br><span class="hljs-built_in">rm</span> -rf metis-5.1.0<br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;=== metis (end) ====&quot;</span><br><span class="hljs-keyword">fi</span><br><br><span class="hljs-keyword">fi</span><br></code></pre></td></tr></table></figure><h1 id="for-mpasv6.3-and-before">For MPASv6.3 and before</h1><p>Install cmake, curl and unzip !!! {:.warning}</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-built_in">source</span> /home/wpsze/micromamba/etc/profile.d/micromamba.sh <span class="hljs-comment"># install cmake</span><br>micromamba activate mpas_env<br></code></pre></td></tr></table></figure><h1 id="mpas_env.sh">mpas_env.sh</h1><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-meta">#!/bin/bash</span><br><br><span class="hljs-comment">#------------------------------------------------#</span><br><span class="hljs-comment">#Author:         wpsze</span><br><span class="hljs-comment">#Email：         </span><br><span class="hljs-comment">#date:           2022-10-21 23:13:49</span><br><span class="hljs-comment">#Version:        0.0 </span><br><span class="hljs-comment">#Description:    The purpose of the script</span><br><span class="hljs-comment">#Copyright (C)： 2022 All rights reserved</span><br><span class="hljs-comment">#------------------------------------------------#</span><br><br><span class="hljs-comment"># Install: make/cmake</span><br><span class="hljs-comment"># Actually: can install gnu </span><br><span class="hljs-built_in">source</span> /home/wpsze/micromamba/etc/profile.d/micromamba.sh<br>micromamba activate mpas_env<br><br><span class="hljs-built_in">export</span> libs_DIR=/home/wpsze/MPAS-A/modules_library/Library/<br><br><span class="hljs-comment"># GCC env</span><br><span class="hljs-built_in">export</span> PATH=/home/wpsze/GNU_GCC/Library/gcc-v9.3.0/bin:<span class="hljs-variable">$PATH</span><br><span class="hljs-built_in">export</span> LD_LIBRARY_PATH=/home/wpsze/GNU_GCC/Library/gcc-v9.3.0/lib/<span class="hljs-variable">$&#123;LD_LIBRARY_PATH:+:$LD_LIBRARY_PATH&#125;</span><br><span class="hljs-built_in">export</span> LD_LIBRARY_PATH=/home/wpsze/GNU_GCC/Library/gcc-v9.3.0/lib64:<span class="hljs-variable">$LD_LIBRARY_PATH</span><br><br><span class="hljs-comment"># MPAS env </span><br><span class="hljs-built_in">export</span> PATH=<span class="hljs-variable">$libs_DIR</span>/bin:<span class="hljs-variable">$PATH</span><br><span class="hljs-built_in">export</span> LD_LIBRARY_PATH=<span class="hljs-variable">$libs_DIR</span>/lib:<span class="hljs-variable">$LD_LIBRARY_PATH</span><br><span class="hljs-built_in">export</span> LDFLAGS=-L<span class="hljs-variable">$libs_DIR</span>/lib<br><span class="hljs-built_in">export</span> CPPFLAGS=-I<span class="hljs-variable">$libs_DIR</span>/include<br><br><span class="hljs-built_in">export</span> PNETCDF_PATH=<span class="hljs-variable">$libs_DIR</span><br><span class="hljs-built_in">export</span> PNETCDF=<span class="hljs-variable">$libs_DIR</span><br><span class="hljs-built_in">export</span> NETCDF_PATH=<span class="hljs-variable">$libs_DIR</span><br><span class="hljs-built_in">export</span> NETCDF=<span class="hljs-variable">$libs_DIR</span><br><span class="hljs-built_in">export</span> PIO=<span class="hljs-variable">$libs_DIR</span><br><br><span class="hljs-comment">##--Intel MPI与Open MPI、MPICH等MPI实现不同：</span><br><span class="hljs-comment">##--mpiicc、mpiicpc和mpiifort命令：使用Intel编译器</span><br><span class="hljs-comment">##--mpicc、mpif90和mpifc命令：默认使用GNU编译器</span><br><span class="hljs-comment">## </span><br><span class="hljs-built_in">export</span> FC=mpifort<br><span class="hljs-built_in">export</span> F77=mpifort<br><span class="hljs-built_in">export</span> F90=mpifort<br><span class="hljs-built_in">export</span> CC=mpicc<br><span class="hljs-built_in">export</span> MPIF90=mpifort<br><span class="hljs-built_in">export</span> MPIF77=mpifort<br><span class="hljs-built_in">export</span> MPIFC=mpifort<br><span class="hljs-built_in">export</span> MPICC=mpicc<br><br>gcc --version<br>gfortran --version<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>MPAS</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Installation</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>MPAS | MPAS Installation (More)</title>
    <link href="/2024/05/31/MPAS_installation_more/"/>
    <url>/2024/05/31/MPAS_installation_more/</url>
    
    <content type="html"><![CDATA[<p>The repository URL can be found from the MPAS GitHub page at <a href="https://github.com/MPAS-Dev/MPAS-Model" class="uri">https://github.com/MPAS-Dev/MPAS-Model</a></p><h1 id="compiling-mpas">Compiling MPAS</h1><p>There is no “configuration” step for MPAS, unlike, e.g., for the WRF model - All build flags are either set in the top-level Makefile or on the command-line General MPAS build command:</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">$ make target CORE=core options<br></code></pre></td></tr></table></figure><p>target can be either - <strong>clean</strong> or - <strong>gfortran</strong> - <strong>ifort</strong> - nvhpc - llvm - <strong>intel-mpi (MPASv8.1.0)</strong> ... plus a few others...</p><p>For MPAS-Atmosphere, core may be - atmosphere - init_atmosphere</p><p>options can be zero or more of - <strong>DEBUG=true</strong> - AUTOCLEAN=true - <strong>PRECISION=single</strong> - OPENMP=true</p><p>Typical build of both the init_atmosphere and atmosphere cores involves:</p><ul><li>make gfortran CORE=init_atmosphere (build init_atmosphere_model)</li><li>make clean CORE=atmosphere (clean any infrastructure files used by both init_atmosphere and atmosphere)</li><li>make gfortran CORE=atmosphere (build atmosphere_model)</li></ul><p>By default, MPAS cores are built with double-precision reals</p><p>MPAS-Atmosphere can be built in single precision - Add PRECISION=single to build commands for single-precision executables - <strong>execution time ~35% less compared with double-precision</strong> - output files approximately half as large</p><p>For mpich, - see https://www.mpich.org/static/downloads/4.2.0/mpich-4.2.0-installguide.pdf</p><h1 id="for-mpasv7.0">For MPASv7.0,</h1><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-meta">#!/bin/bash</span><br><br><span class="hljs-comment">#------------------------------------------------#</span><br><span class="hljs-comment">#Author:         wpsze</span><br><span class="hljs-comment">#Email：         </span><br><span class="hljs-comment">#date:           </span><br><span class="hljs-comment">#Version:        0.0 </span><br><span class="hljs-comment">#Description:    Install libraries that MPAS needs </span><br><span class="hljs-comment">#Copyright (C)： 2022 All rights reserved</span><br><span class="hljs-comment">#------------------------------------------------#</span><br><br><span class="hljs-comment">## ./mpas_env_install_gcc10_3_0.sh 2&gt;&amp;1 |tee log.log</span><br><br><span class="hljs-comment">############################## Directory Listing ############################</span><br><span class="hljs-built_in">export</span> HOME=`<span class="hljs-built_in">pwd</span>`<br><br><span class="hljs-built_in">source</span> /home/wpsze/MPAS-A/mpas_env.sh<br><br>gcc --version<br>g++ --version<br>gfortran --version<br>mpif90 --version<br>mpicc --version<br>make --version<br>cmake --version<br><br><span class="hljs-built_in">echo</span> <span class="hljs-variable">$NETCDF</span><br><span class="hljs-built_in">echo</span> <span class="hljs-variable">$PNETCDF</span><br><span class="hljs-built_in">echo</span> <span class="hljs-variable">$PIO</span><br><br><span class="hljs-comment">##--Intel MPI与Open MPI、MPICH等MPI实现不同：</span><br><span class="hljs-comment">##--mpiicc、mpiicpc和mpiifort命令：使用Intel编译器</span><br><span class="hljs-comment">##--mpicc、mpif90和mpifc命令：默认使用GNU编译器</span><br><br>do_init_atmosphere=True <span class="hljs-comment"># True, False</span><br>do_atmosphere=True<br>do_build_tables=True<br><br>mpas_version=<span class="hljs-string">&quot;MPASv8&quot;</span><br><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;Copy MPAS-Model to build-mpas ... &quot;</span><br><span class="hljs-built_in">rm</span> -rf build-mpas<br><span class="hljs-built_in">cp</span> -r MPAS-Model-8.0.0 build-mpas<br><span class="hljs-built_in">cd</span> build-mpas<br><br><span class="hljs-comment">############################## init_atmosphere ############################ -g -O0 -fbacktrace</span><br><span class="hljs-keyword">if</span> [[ <span class="hljs-variable">$&#123;do_init_atmosphere&#125;</span> == True ]]; <span class="hljs-keyword">then</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;=== init_atmosphere ====&quot;</span><br><br>make clean CORE=init_atmosphere<br>make clean CORE=atmosphere<br><br><span class="hljs-comment"># mpas_dmpar.F:</span><br> <span class="hljs-comment"># call MPI_Allreduce(inArray, outArray, nElements, MPI_INTEGERKIND, MPI_MAX, dminfo % comm, mpi_ierr) </span><br><span class="hljs-comment"># Warning: Rank mismatch between actual argument at (1) and actual argument at (2) (scalar and rank-1)</span><br><br><span class="hljs-comment">#export FFLAGS=&quot;-w -fallow-argument-mismatch -O2&quot;</span><br><span class="hljs-comment">#export FCFLAGS=&quot;-w -fallow-argument-mismatch -O2&quot;</span><br><br><span class="hljs-comment"># make gfortran CORE=init_atmosphere PRECISION=single DEBUG=true USE_PIO2=true &gt;&amp; log_build2.txt</span><br><br>make -j8 gfortran CORE=init_atmosphere PRECISION=single USE_PIO2=<span class="hljs-literal">true</span> 2&gt;&amp;1 |<span class="hljs-built_in">tee</span> log_build_init.txt<br><br><span class="hljs-comment">### Check MPAS model.</span><br><span class="hljs-comment">#ls -la init_atmosphere_model</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;=== init_atmosphere (end) ====&quot;</span><br>: <span class="hljs-string">&#x27;</span><br><span class="hljs-string">*******************************************************************************</span><br><span class="hljs-string">MPAS was built with default single-precision reals.</span><br><span class="hljs-string">Debugging is off.</span><br><span class="hljs-string">Parallel version is on.</span><br><span class="hljs-string">Papi libraries are off.</span><br><span class="hljs-string">TAU Hooks are off.</span><br><span class="hljs-string">MPAS was built without OpenMP support.</span><br><span class="hljs-string">MPAS was built with .F files.</span><br><span class="hljs-string">The native timer interface is being used</span><br><span class="hljs-string">Using the PIO 2 library.</span><br><span class="hljs-string">*******************************************************************************</span><br><span class="hljs-string">make[1]: Leaving directory /home/wpsze/MPAS-A/mpasv73/MPAS-Model-7.3</span><br><span class="hljs-string">If compilation of the init_atmosphere core was successful, we should also have an executable file named init_atmosphere_model</span><br><span class="hljs-string">&#x27;</span><br><span class="hljs-keyword">fi</span><br><br><span class="hljs-comment">############################## atmosphere_model ############################</span><br><span class="hljs-keyword">if</span> [[ <span class="hljs-variable">$&#123;do_atmosphere&#125;</span> == True ]]; <span class="hljs-keyword">then</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;=== atmosphere_model ====&quot;</span><br><span class="hljs-comment"># To preserve all executables except atmosphere_model and clean the MPAS infrastructure, run: </span><br>make clean CORE=atmosphere<br><br><span class="hljs-comment">#export FFLAGS=&quot;-w -fallow-argument-mismatch -O2&quot;</span><br><span class="hljs-comment">#export FCFLAGS=&quot;-w -fallow-argument-mismatch -O2&quot;</span><br><br><span class="hljs-comment"># DEBUG=true</span><br><br>make gfortran CORE=atmosphere PRECISION=single USE_PIO2=<span class="hljs-literal">true</span> 2&gt;&amp;1 |<span class="hljs-built_in">tee</span> log_build_atm.txt<br><br><span class="hljs-comment">### Check MPAS model.</span><br><span class="hljs-comment">#ls -la atmosphere_model</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;=== atmosphere_model (end) ====&quot;</span><br>: <span class="hljs-string">&#x27;</span><br><span class="hljs-string">*******************************************************************************</span><br><span class="hljs-string">MPAS was built with default single-precision reals.</span><br><span class="hljs-string">Debugging is off.</span><br><span class="hljs-string">Parallel version is on.</span><br><span class="hljs-string">Papi libraries are off.</span><br><span class="hljs-string">TAU Hooks are off.</span><br><span class="hljs-string">MPAS was built without OpenMP support.</span><br><span class="hljs-string">MPAS was built with .F files.</span><br><span class="hljs-string">The native timer interface is being used</span><br><span class="hljs-string">Using the PIO 2 library.</span><br><span class="hljs-string">*******************************************************************************</span><br><span class="hljs-string">&#x27;</span><br><br><span class="hljs-built_in">wait</span><br><br><span class="hljs-keyword">fi</span><br><br><span class="hljs-keyword">if</span> [[ -f atmosphere_model ]]; <span class="hljs-keyword">then</span><br><span class="hljs-built_in">mkdir</span> -p <span class="hljs-variable">$HOME</span>/<span class="hljs-variable">$&#123;mpas_version&#125;</span><br><span class="hljs-built_in">mv</span> streams.init_atmosphere <span class="hljs-variable">$HOME</span>/<span class="hljs-variable">$&#123;mpas_version&#125;</span><br><span class="hljs-built_in">mv</span> namelist.init_atmosphere <span class="hljs-variable">$HOME</span>/<span class="hljs-variable">$&#123;mpas_version&#125;</span><br><span class="hljs-built_in">mv</span> init_atmosphere_model <span class="hljs-variable">$HOME</span>/<span class="hljs-variable">$&#123;mpas_version&#125;</span><br><br><span class="hljs-built_in">mv</span> atmosphere_model <span class="hljs-variable">$HOME</span>/<span class="hljs-variable">$&#123;mpas_version&#125;</span><br><span class="hljs-built_in">mv</span> build_tables <span class="hljs-variable">$HOME</span>/<span class="hljs-variable">$&#123;mpas_version&#125;</span><br><span class="hljs-built_in">mv</span> namelist.atmosphere <span class="hljs-variable">$HOME</span>/<span class="hljs-variable">$&#123;mpas_version&#125;</span><br><span class="hljs-built_in">mv</span> streams.atmosphere <span class="hljs-variable">$HOME</span>/<span class="hljs-variable">$&#123;mpas_version&#125;</span><br><span class="hljs-built_in">mv</span> stream_list.atmosphere.diagnostics <span class="hljs-variable">$HOME</span>/<span class="hljs-variable">$&#123;mpas_version&#125;</span><br><span class="hljs-built_in">mv</span> stream_list.atmosphere.output <span class="hljs-variable">$HOME</span>/<span class="hljs-variable">$&#123;mpas_version&#125;</span><br><span class="hljs-built_in">mv</span> stream_list.atmosphere.surface <span class="hljs-variable">$HOME</span>/<span class="hljs-variable">$&#123;mpas_version&#125;</span><br><br><span class="hljs-built_in">mv</span> ./src/core_atmosphere/physics/physics_wrf/files/* <span class="hljs-variable">$HOME</span>/<span class="hljs-variable">$&#123;mpas_version&#125;</span>/<br><br><span class="hljs-keyword">if</span> [[ <span class="hljs-variable">$&#123;do_build_tables&#125;</span> == True ]]; <span class="hljs-keyword">then</span><br><span class="hljs-built_in">cd</span> <span class="hljs-variable">$HOME</span>/<span class="hljs-variable">$&#123;mpas_version&#125;</span><br>./build_tables<br><span class="hljs-keyword">fi</span><br><br><span class="hljs-keyword">fi</span><br></code></pre></td></tr></table></figure><p>and,</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-meta">#!/bin/bash</span><br><br><span class="hljs-comment">#------------------------------------------------#</span><br><span class="hljs-comment">#Author:         wpsze</span><br><span class="hljs-comment">#homeail：        </span><br><span class="hljs-comment">#date:           </span><br><span class="hljs-comment">#Version:        0.0 </span><br><span class="hljs-comment">#Description:    Install libraries that MPAS needs </span><br><span class="hljs-comment">#Copyright (C)： 2022 All rights reserved</span><br><span class="hljs-comment">#------------------------------------------------#</span><br><br><span class="hljs-comment">############################## Directory Listing ############################</span><br><span class="hljs-built_in">export</span> HOME=`<span class="hljs-built_in">pwd</span>`<br><span class="hljs-built_in">export</span> download_DIR=<span class="hljs-variable">$HOME</span>/mpas_install/<br><span class="hljs-built_in">export</span> libs_DIR=<span class="hljs-variable">$HOME</span>/Library/<br><br><span class="hljs-built_in">export</span> PATH=/home/wpsze/GNU_GCC/Library/gcc-v9.3.0/bin:<span class="hljs-variable">$PATH</span><br><span class="hljs-built_in">export</span> LD_LIBRARY_PATH=/home/wpsze/GNU_GCC/Library/gcc-v9.3.0/lib/<span class="hljs-variable">$&#123;LD_LIBRARY_PATH:+:$LD_LIBRARY_PATH&#125;</span><br><span class="hljs-comment">#export LD_LIBRARY_PATH=/home/wpsze/GNU_GCC/Library/gcc-v9.3.0/lib:$LD_LIBRARY_PATH</span><br><span class="hljs-built_in">export</span> LD_LIBRARY_PATH=/home/wpsze/GNU_GCC/Library/gcc-v9.3.0/lib64:<span class="hljs-variable">$LD_LIBRARY_PATH</span><br><br><span class="hljs-built_in">export</span> LD_LIBRARY_PATH=<span class="hljs-variable">$libs_DIR</span>/lib:<span class="hljs-variable">$LD_LIBRARY_PATH</span><br><span class="hljs-built_in">export</span> LDFLAGS=-L<span class="hljs-variable">$libs_DIR</span>/lib<br><span class="hljs-built_in">export</span> CPPFLAGS=-I<span class="hljs-variable">$libs_DIR</span>/include<br><br><span class="hljs-built_in">source</span> /home/wpsze/micromamba/etc/profile.d/micromamba.sh <span class="hljs-comment"># install cmake</span><br>micromamba activate mpas_env<br><br>gcc --version<br>gfortran --version<br><br><span class="hljs-built_in">echo</span> <span class="hljs-variable">$HOME</span><br><span class="hljs-built_in">echo</span> <span class="hljs-variable">$download_DIR</span><br><span class="hljs-built_in">echo</span> <span class="hljs-variable">$libs_DIR</span><br><br><span class="hljs-built_in">mkdir</span> -p mpas_install<br><span class="hljs-built_in">mkdir</span> -p Library<br><br>do_download=False <span class="hljs-comment"># True or False</span><br>compile_all=True<br><br><span class="hljs-comment"># Currently Loaded Modules:</span><br><span class="hljs-comment">#  1) ncarenv/1.0 (xx)      4) ncarcompilers/1.0 (xx)  7) pnetcdf/1.11.2  10) ncview/2.1.7 (already)</span><br><span class="hljs-comment">#  2) ncarbinlibs/1.1 (xx)  5) netcdf/4.7.0        8) pio/1.9.23 (2.5.2)      11) metis/5.1.0</span><br><span class="hljs-comment">#  3) gnu/8.3.0 (done)         6) mpich/3.3.1         9) ncl/6.6.2 (already)       12) hdf5/1.10.5</span><br><br>do_mpich=False<br>do_zlib=False<br>do_hdf5=False<br>do_pnetcdf=False<br>do_netcdfC=False<br>do_netcdfF=False<br>do_pio=False<br>do_metis=True<br><br><span class="hljs-comment">############################## Downloading Libraries ############################</span><br><span class="hljs-keyword">if</span> [[ <span class="hljs-variable">$do_download</span>  == True ]]; <span class="hljs-keyword">then</span><br>    <span class="hljs-built_in">cd</span> <span class="hljs-variable">$download_DIR</span><br>    wget -c https://zlib.net/zlib-1.2.13.tar.gz<br>    wget -c https://www.gfd-dennou.org/arch/netcdf/unidata-mirror/netcdf-c-4.7.4.tar.gz<br>    wget -c https://www.gfd-dennou.org/arch/netcdf/unidata-mirror/netcdf-fortran-4.5.3.tar.gz<br>    <span class="hljs-comment"># wget -c https://github.com/pmodels/mpich/releases/download/v4.0.2/mpich-4.0.2.tar.gz</span><br>    wget -c https://www.mpich.org/static/downloads/3.3.1/mpich-3.3.1.tar.gz<br>    wget -c https://parallel-netcdf.github.io/Release/pnetcdf-1.11.2.tar.gz <br>    <span class="hljs-comment"># Pio is from https://github.com/NCAR/ParallelIO/releases</span><br>    <span class="hljs-comment"># metis is from http://glaros.dtc.umn.edu/gkhome/metis/metis/download</span><br>    wget -c https://hdf-wordpress-1.s3.amazonaws.com/wp-content/uploads/manual/HDF5/HDF5_1_12_0/source/hdf5-1.12.0.tar.gz<br><br><span class="hljs-keyword">fi</span><br><br><span class="hljs-keyword">if</span> [[ <span class="hljs-variable">$compile_all</span> == True ]]; <span class="hljs-keyword">then</span><br><span class="hljs-comment">###################################################################</span><br><span class="hljs-built_in">export</span> LD_LIBRARY_PATH=<span class="hljs-variable">$libs_DIR</span>/lib:<span class="hljs-variable">$LD_LIBRARY_PATH</span><br><span class="hljs-built_in">export</span> LDFLAGS=-L<span class="hljs-variable">$libs_DIR</span>/lib<br><span class="hljs-built_in">export</span> CPPFLAGS=-I<span class="hljs-variable">$libs_DIR</span>/include<br><span class="hljs-built_in">export</span> PATH=<span class="hljs-variable">$libs_DIR</span>/bin:<span class="hljs-variable">$PATH</span><br><br><span class="hljs-comment">#export PNETCDF_PATH=$libs_DIR/bin:$PATH</span><br><span class="hljs-comment">#export PNETCDF=$libs_DIR/bin:$PATH</span><br><br><span class="hljs-comment">#export NETCDF_PATH=$libs_DIR/bin:$PATH</span><br><span class="hljs-comment">#export NETCDF=$libs_DIR/bin:$PATH</span><br><br><span class="hljs-comment">#export PIO=$libs_DIR/bin:$PATH</span><br><br><span class="hljs-comment">############################## MPICH ############################</span><br><span class="hljs-keyword">if</span> [[ <span class="hljs-variable">$&#123;do_mpich&#125;</span>  == True ]]; <span class="hljs-keyword">then</span><br><span class="hljs-comment">#export PATH=$libs_DIR/gcc-v8.3.0/bin:$PATH</span><br><span class="hljs-comment">#export LD_LIBRARY_PATH=$libs_DIR/gcc-v8.3.0/lib:$LD_LIBRARY_PATH</span><br><span class="hljs-comment">#export LD_LIBRARY_PATH=$libs_DIR/gcc-v8.3.0/lib64:$LD_LIBRARY_PATH</span><br><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;=== MPICH ====&quot;</span><br><span class="hljs-built_in">cd</span> <span class="hljs-variable">$download_DIR</span><br>tar xvf mpich-4.0.2.tar.gz 1&gt;/dev/null 2&gt;&amp;1  <span class="hljs-comment"># 3.3.1 4.0.2</span><br><span class="hljs-built_in">cd</span> mpich-4.0.2/<br><br>./configure --prefix=<span class="hljs-variable">$libs_DIR</span> --with-device=ch3 <span class="hljs-comment">#--enable-pic</span><br>make -j 4<br>make check<br>make install<br><span class="hljs-comment">#make testing</span><br><span class="hljs-built_in">cd</span> ..<br><span class="hljs-built_in">rm</span> -rf mpich-4.0.2<br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;=== MPICH (end) ====&quot;</span><br><span class="hljs-keyword">fi</span><br><br><span class="hljs-comment">### Compilers</span><br><span class="hljs-comment">## commment out for mpich !!</span><br><span class="hljs-built_in">export</span> SERIAL_FC=gfortran<br><span class="hljs-built_in">export</span> SERIAL_F77=gfortran<br><span class="hljs-built_in">export</span> SERIAL_CC=gcc<br><span class="hljs-built_in">export</span> SERIAL_CXX=g++<br><span class="hljs-built_in">export</span> MPI_FC=mpifort<br><span class="hljs-built_in">export</span> MPI_F77=mpifort<br><span class="hljs-built_in">export</span> MPI_F90=mpifort<br><span class="hljs-built_in">export</span> MPI_CC=mpicc<br><span class="hljs-built_in">export</span> MPI_CXX=mpic++<br><span class="hljs-comment">### all serial are same as MPI</span><br><span class="hljs-built_in">export</span> FC=<span class="hljs-variable">$&#123;MPI_FC&#125;</span><br><span class="hljs-built_in">export</span> F77=<span class="hljs-variable">$&#123;MPI_F77&#125;</span><br><span class="hljs-built_in">export</span> F90=<span class="hljs-variable">$&#123;MPI_F77&#125;</span><br><span class="hljs-built_in">export</span> CC=<span class="hljs-variable">$&#123;MPI_F77&#125;</span><br><span class="hljs-built_in">export</span> CXX=<span class="hljs-variable">$&#123;MPI_F77&#125;</span><br><br><span class="hljs-comment">############################## zlib ############################ *** zlib test OK ***</span><br><span class="hljs-keyword">if</span> [[ <span class="hljs-variable">$&#123;do_zlib&#125;</span>  == True ]]; <span class="hljs-keyword">then</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;=== zlib ====&quot;</span><br><span class="hljs-built_in">cd</span> <span class="hljs-variable">$download_DIR</span><br>tar xvf zlib-1.2.13.tar.gz 1&gt;/dev/null 2&gt;&amp;1 <br><span class="hljs-built_in">cd</span> zlib-1.2.13/<br><br>./configure --prefix=<span class="hljs-variable">$libs_DIR</span> <span class="hljs-comment">#--static</span><br>make -j 4<br>make install<br>make check<br><span class="hljs-built_in">cd</span> ..<br><span class="hljs-built_in">rm</span> -rf zlib-1.2.13<br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;=== zlib (end) ====&quot;</span><br><span class="hljs-keyword">fi</span><br><br><span class="hljs-comment">############################## HDF5 ############################ </span><br><span class="hljs-keyword">if</span> [[ <span class="hljs-variable">$&#123;do_hdf5&#125;</span> == True ]]; <span class="hljs-keyword">then</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;=== hdf5 ====&quot;</span><br><span class="hljs-built_in">cd</span> <span class="hljs-variable">$download_DIR</span><br>tar xvf hdf5-1.12.0.tar.gz 1&gt;/dev/null 2&gt;&amp;1 <br><span class="hljs-built_in">cd</span> hdf5-1.12.0/<br><br>./configure --prefix=<span class="hljs-variable">$libs_DIR</span> --enable-parallel --with-zlib=<span class="hljs-variable">$libs_DIR</span> --enable-fortran <span class="hljs-comment">#--disable-shared</span><br>make -j 4<br>make check<br>make install<br><span class="hljs-built_in">cd</span> ..<br><span class="hljs-built_in">rm</span> -rf hdf5-1.12.0<br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;=== hdf5 (end) ====&quot;</span><br><span class="hljs-keyword">fi</span><br><br><span class="hljs-comment">############################## pnetcdf ############################ PnetCDF has been successfully installed </span><br><span class="hljs-keyword">if</span> [[ <span class="hljs-variable">$&#123;do_pnetcdf&#125;</span> == True ]]; <span class="hljs-keyword">then</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;=== pnetcdf ====&quot;</span><br><span class="hljs-built_in">cd</span> <span class="hljs-variable">$download_DIR</span><br>tar xvf pnetcdf-1.11.2.tar.gz 1&gt;/dev/null 2&gt;&amp;1 <br><span class="hljs-built_in">cd</span> pnetcdf-1.11.2/<br><br>./configure --prefix=<span class="hljs-variable">$libs_DIR</span><br>make -j 4<br>make check<br>make ptest<br>make testing<br>make install<br><span class="hljs-built_in">cd</span> ..<br><span class="hljs-built_in">rm</span> -rf pnetcdf-1.11.2<br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;=== pnetcdf (end) ====&quot;</span><br><span class="hljs-keyword">fi</span><br><br><span class="hljs-comment">############################## netcdf-C ############################  Congratulations! You have successfully installed netCDF!</span><br><span class="hljs-keyword">if</span> [[ <span class="hljs-variable">$&#123;do_netcdfC&#125;</span> == True ]]; <span class="hljs-keyword">then</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;=== netcdf-C ====&quot;</span><br><span class="hljs-comment">## -disable-dap：--disable-dap的原因是缺少一个‘curl’的lib</span><br><span class="hljs-comment">## 4.1.3以后的版本Fortran和C分开了。把disable--netcdf-4 写进去也无所谓</span><br><span class="hljs-built_in">cd</span> <span class="hljs-variable">$download_DIR</span><br>tar xvf netcdf-c-4.7.4.tar.gz 1&gt;/dev/null 2&gt;&amp;1 <br><span class="hljs-built_in">cd</span> netcdf-c-4.7.4/<br><br><span class="hljs-comment"># have to define below parameters</span><br><span class="hljs-built_in">export</span> FC=mpifort<br><span class="hljs-built_in">export</span> F77=mpifort<br><span class="hljs-built_in">export</span> F90=mpifort<br><span class="hljs-built_in">export</span> CC=mpicc<br><span class="hljs-built_in">export</span> CXX=mpic++<br><br><span class="hljs-comment">#export LIBS=&quot;-lhdf5_hl -lhdf5 -lz -ldl&quot;</span><br><br><span class="hljs-built_in">export</span> LD_LIBRARY_PATH=<span class="hljs-variable">$libs_DIR</span>/lib:<span class="hljs-variable">$LD_LIBRARY_PATH</span><br><span class="hljs-built_in">export</span> LDFLAGS=-L<span class="hljs-variable">$libs_DIR</span>/lib<br><span class="hljs-built_in">export</span> CPPFLAGS=-I<span class="hljs-variable">$libs_DIR</span>/include<br><br><span class="hljs-comment">#./configure --prefix=$libs_DIR --disable-dap --enable-pnetcdf --enable-netcdf4 --enable-cdf5 --enable-parallel-tests --disable-shared</span><br>./configure --prefix=<span class="hljs-variable">$libs_DIR</span> --enable-shared --enable-netcdf4 --disable-filter-testing --disable-dap<br>make -j 4 <br>make check<br>make install<br><span class="hljs-built_in">cd</span> ..<br><span class="hljs-built_in">rm</span> -rf netcdf-c-4.7.4<br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;=== netcdf-C (end) ====&quot;</span><br><span class="hljs-keyword">fi</span><br><br><span class="hljs-comment">############################## netcdf-F ############################ </span><br><span class="hljs-keyword">if</span> [[ <span class="hljs-variable">$&#123;do_netcdfF&#125;</span> == True ]]; <span class="hljs-keyword">then</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;=== netcdf-F ====&quot;</span><br><span class="hljs-built_in">cd</span> <span class="hljs-variable">$download_DIR</span><br>tar xvf netcdf-fortran-4.5.3.tar.gz 1&gt;/dev/null 2&gt;&amp;1 <br><span class="hljs-built_in">cd</span> netcdf-fortran-4.5.3/<br><br><br><span class="hljs-built_in">export</span> LD_LIBRARY_PATH=<span class="hljs-variable">$libs_DIR</span>/lib:<span class="hljs-variable">$LD_LIBRARY_PATH</span><br><span class="hljs-built_in">export</span> LDFLAGS=-L<span class="hljs-variable">$libs_DIR</span>/lib<br><span class="hljs-built_in">export</span> CPPFLAGS=-I<span class="hljs-variable">$libs_DIR</span>/include<br><br><span class="hljs-comment">#</span><br><span class="hljs-comment"># configure: error: netcdf-c version 4.7.4 or greater is required</span><br><br>nc-config --cflags<br>nc-config --libs<br>./configure --prefix=<span class="hljs-variable">$libs_DIR</span> --enable-shared <span class="hljs-comment">#--enable-parallel-tests #--disable-shared</span><br><br><span class="hljs-comment">#CFLAGS=$(nc-config --cflags) LDFLAGS=$(nc-config --libs) ./configure --prefix=$libs_DIR --enable-parallel-tests #--disable-shared</span><br><br>make -j 4 <br>make check<br>make install<br><span class="hljs-built_in">cd</span> ..<br><span class="hljs-built_in">rm</span> -rf netcdf-fortran-4.5.3<br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;=== netcdf-F (end) ====&quot;</span><br><span class="hljs-keyword">fi</span><br><br><span class="hljs-comment">############################## Pio ############################</span><br><span class="hljs-keyword">if</span> [[ <span class="hljs-variable">$&#123;do_pio&#125;</span> == True ]]; <span class="hljs-keyword">then</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;=== PIO ====&quot;</span><br><span class="hljs-built_in">cd</span> <span class="hljs-variable">$download_DIR</span><br>tar xvf ParallelIO-pio2_5_8.tar.gz 1&gt;/dev/null 2&gt;&amp;1<br><span class="hljs-built_in">cd</span> ParallelIO-pio2_5_8/<br><br><span class="hljs-built_in">export</span> CC=mpicc <br><span class="hljs-built_in">export</span> FC=mpif90 <br><span class="hljs-comment">#./configure --prefix=$libs_DIR --enable-fortran</span><br><span class="hljs-comment">#cmake -DNetCDF_C_PATH=$libs_DIR -DNetCDF_Fortran_PATH=$libs_DIR -DPnetCDF_PATH=$libs_DIR -DPIO_ENABLE_TIMING=OFF -DCMAKE_INSTALL_PREFIX=$libs_DIR</span><br>cmake -DNetCDF_C_PATH=<span class="hljs-variable">$NETCDF</span> -DNetCDF_Fortran_PATH=<span class="hljs-variable">$NETCDF</span> -DPnetCDF_PATH=<span class="hljs-variable">$PNETCDF</span> -DHDF5_PATH=<span class="hljs-variable">$libs_DIR</span> -DCMAKE_INSTALL_PREFIX=<span class="hljs-variable">$libs_DIR</span> -DPIO_USE_MALLOC=ON -DCMAKE_VERBOSE_MAKEFILE=1 -DPIO_ENABLE_TIMING=OFF ./<br>make<br><span class="hljs-comment">#make check</span><br>make install<br><span class="hljs-built_in">cd</span> ..<br><span class="hljs-built_in">rm</span> -rf ParallelIO-pio2_5_8<br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;=== PIO (end) ====&quot;</span><br><span class="hljs-keyword">fi</span><br><br><span class="hljs-comment">############################## metis ############################</span><br><span class="hljs-keyword">if</span> [[ <span class="hljs-variable">$&#123;do_metis&#125;</span> == True ]]; <span class="hljs-keyword">then</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;=== metis ====&quot;</span><br><span class="hljs-built_in">cd</span> <span class="hljs-variable">$download_DIR</span><br>tar xvf metis-5.1.0.tar.gz 1&gt;/dev/null 2&gt;&amp;1<br><span class="hljs-built_in">cd</span> metis-5.1.0/<br><span class="hljs-comment">#./configure --prefix=$libs_DIR</span><br><br>make config prefix=<span class="hljs-variable">$libs_DIR</span><br>make<br><span class="hljs-comment">#make check</span><br>make install<br><span class="hljs-built_in">cd</span> ..<br><span class="hljs-built_in">rm</span> -rf metis-5.1.0<br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;=== metis (end) ====&quot;</span><br><span class="hljs-keyword">fi</span><br><br><span class="hljs-keyword">fi</span><br></code></pre></td></tr></table></figure><h1 id="for-mpasv8.2.0">For MPASv8.2.0,</h1><ul><li><a href="https://github.com/MPAS-Dev/MPAS-Model/releases" class="uri">https://github.com/MPAS-Dev/MPAS-Model/releases</a></li></ul><p>MPAS Version 8.2.0 This release of MPAS introduces several significant changes to MPAS-Atmosphere.</p><ul><li>New physics<ul><li>The <strong>Noah-MP v5.0.1</strong> land-surface model is now available by setting</li><li><code>config_lsm_scheme = 'sf_noahmp'</code> in the <code>&amp;physics namelist group</code>.</li></ul></li><li>New static files that include the <strong>soilcomp, soilcl1, soilcl2, soilcl3, and soilcl4</strong> fields are required when activating <strong>Noah-MP</strong> in the model.</li><li>The <strong>aerosol-aware Thompson microphysics (as in WRF v4.1.4)</strong> is available by setting <code>config_microp_scheme = 'mp_thompson_aerosols'</code> in the <code>&amp;physics namelist group</code>.</li></ul><p>An aerosol climatology file (QNWFA_QNIFA_SIGMA_MONTHLY.dat) is used when running the init_atmosphere_model program to produce initial and lateral boundary conditions for <code>nifa</code> and <code>nwfa</code>.</p><div class="note note-danger">            <p>It includes Noah-MP, so have to download Noah-MP Geographical Input Data (soilgrids).</p>          </div><ul><li><a href="https://www2.mmm.ucar.edu/projects/mpas/mpas_static.tar.bz2">Static geographical datasets</a></li><li><a href="https://www2.mmm.ucar.edu/projects/mpas/QNWFA_QNIFA_SIGMA_MONTHLY.dat">Monthly climatological aerosol dataset (QNWFA_QNIFA_SIGMA_MONTHLY.dat)</a></li><li><a href="https://www2.mmm.ucar.edu/wrf/users/download/get_sources_wps_geog.html" class="uri">https://www2.mmm.ucar.edu/wrf/users/download/get_sources_wps_geog.html</a></li><li>NoahMP Tar File<ul><li>soilgrids</li></ul></li></ul><h1 id="for-mpasv6.3-and-before">For MPASv6.3 and before</h1><div class="note note-danger">            <p>Install cmake, curl and unzip !!!</p>          </div><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-built_in">source</span> /home/wpsze/micromamba/etc/profile.d/micromamba.sh <span class="hljs-comment"># install cmake</span><br>micromamba activate mpas_env<br></code></pre></td></tr></table></figure><h1 id="references">References</h1><ol type="1"><li><a href="https://www2.mmm.ucar.edu/people/duda/files/mpas/sources/">Notably the iolib_installation.sh script</a><ol type="1"><li>[ ] hdf5-1.10.5.tar.bz2 2019-07-11 19:36 8.3M<br /></li><li>[ ] iolib_installation.sh 2019-11-08 21:05 3.9K<br /></li><li>[ ] mpich-3.3.1.tar.gz 2019-07-11 19:36 26M<br /></li><li>[ ] netcdf-c-4.6.3.tar.gz 2019-11-09 01:48 17M<br /></li><li>[ ] netcdf-c-4.7.0.tar.gz 2019-07-11 19:36 18M<br /></li><li>[ ] netcdf-fortran-4.4.5..&gt; 2019-07-11 19:36 1.3M<br /></li><li>[ ] netcdf-fortran-4.5.2..&gt; 2019-11-09 01:48 1.0M<br /></li><li>[ ] openmpi-4.0.1.tar.bz2 2019-11-09 01:50 9.4M<br /></li><li>[ ] pnetcdf-1.11.2.tar.gz 2019-07-11 19:36 2.1M<br /></li><li>[ ] zlib-1.2.11.tar.gz 2019-07-11 19:36 593K<br /></li></ol></li><li><a href="https://forum.mmm.ucar.edu/threads/setting-the-environment-for-for-mpas-installation.10192/">Setting the environment for for MPAS installation</a></li><li><a href="https://forum.mmm.ucar.edu/threads/compiling-mpas-atmosphere-with-compass-conda-environment.14553/#post-37460">Compiling MPAS-Atmosphere with Compass Conda Environment</a></li><li><a href="https://forum.mmm.ucar.edu/threads/issue-running-mpas-a-from-restart-file.17596/#post-42923">Issue Running MPAS-A from Restart File</a></li><li><a href="https://forum.mmm.ucar.edu/threads/an-error-occurred-during-the-installation-of-libraries-for-mpas7-0.20102/#post-48844">An error occurred during the installation of libraries for MPAS7.0</a></li></ol>]]></content>
    
    
    <categories>
      
      <category>MPAS</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Installation</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>NWP | The orographic gravity wave drag (GWDO)</title>
    <link href="/2024/05/31/NWP_gwdo/"/>
    <url>/2024/05/31/NWP_gwdo/</url>
    
    <content type="html"><![CDATA[<p>The wave stress of orography gravity wave drag scheme</p><p><span class="math display">\[\frac{\partial U}{\partial t} = - \frac{1}{\rho} \frac{\partial \tau_x}{\partial z}\]</span></p><h1 id="gwdo">GWDO</h1><h2 id="the-gravity-wave-drag-parameterization">The gravity-wave drag parameterization</h2><p><span class="math display">\[\tau_{GWD} = \rho_0 E \frac{m}{\lambda_{eff}} G \frac{|U_0|^3}{N_0} \]</span></p><h2 id="the-blocked-layer-drag-parameterization">The blocked-layer drag parameterization</h2><p><span class="math display">\[\tau_{BLD} = \frac{1}{2} \rho_0 \frac{m}{\Delta_x^2} C_d \Delta_x^{\perp} L_x^{\perp} h_B |U_0|^2\]</span></p><h1 id="references">References</h1><ol type="1"><li>Choi, H.-J., and S.-Y. Hong (2015), An updated subgrid orographic parameterization for global atmospheric forecast models, J. Geophys. Res. Atmos., 120,12,445–12,457, doi:10.1002/ 2015JD024230.</li><li></li></ol><h1 id="applications">Applications</h1><ol type="1"><li>张涵斌, 史永强, 卢冰, 等. 2024. 尺度适应重力波拖曳方案在高分辨率数值预报中的应用研究[J]. 大气科学, 48(2): 789−802. DOI: 10.3878/j.issn.1006-9895.2304.22235</li></ol>]]></content>
    
    
    <categories>
      
      <category>NWP</category>
      
    </categories>
    
    
    <tags>
      
      <tag>GWDO</tag>
      
      <tag>Parametrization</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>MPAS | netcdf-c-4.7.4 final link failed - nonrepresentable section on output</title>
    <link href="/2024/05/30/MPAS_install_netcdf_c_nonrepresentable_error/"/>
    <url>/2024/05/30/MPAS_install_netcdf_c_nonrepresentable_error/</url>
    
    <content type="html"><![CDATA[<h1 id="issue">Issue</h1><p>In order to write netCDF-4 files, you must have the <strong><a href="https://www.unidata.ucar.edu/software/netcdf/">NetCDF-4 C library</a> (libnetcdf)</strong> - version 4.3.1 or above - available on your system, along with all supporting libraries (<em>libhdf5, libz, etc</em>). The details of this differ for each operating system.</p><p><strong>nc-config and libnetcdf.so</strong> are expected to be generated. And, check with</p><blockquote><p>nc-config --cflags nc-config --libs</p></blockquote><p>netcdf-c-4.7.4</p><blockquote><p>final link failed: nonrepresentable section on output</p></blockquote><h1 id="solution">Solution</h1><ul><li>[ ] have to add <strong>--disable-shared</strong> to avoid Error-ld: final link failed: nonrepresentable section on output.</li><li>[x] add -enable-static</li></ul><p>Ref:</p><ol type="1"><li><a href="https://stackoverflow.com/questions/49733534/enable-static-vs-disable-shared">--enable-static vs --disable-shared</a></li></ol><blockquote><p>In the common case that these are switches to a "configure" script generated by Autoconf and Libtool, then they officially mean closely-related, but different, things. --enable-static means <strong>do build static libraries</strong>; --disable-shared means <strong>don't build shared libraries</strong>. If you want to be sure to get only static libraries, no matter what, you need to give both options. However, often just --disable-shared will have that effect, because think about the possibilities: if the package builds only static libraries by default, then --disable-shared is a no-op; if it builds both static and shared libraries by default, then you just have to turn off the shared libraries to get what you want; and if it builds only shared libraries by default, then you might think you need both options, but if you just say --disable-shared, Libtool will usually notice that it's now being asked to build nothing, assume that that couldn't possibly be what you wanted, and flip the --enable-static switch for you.</p></blockquote><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs routeros">echo <span class="hljs-string">&quot;=== netcdf-C ====&quot;</span><br><span class="hljs-comment">## -disable-dap：--disable-dap的原因是缺少一个‘curl’的lib</span><br><span class="hljs-comment">## 4.1.3以后的版本Fortran和C分开了。把disable--netcdf-4 写进去也无所谓</span><br><br>cd <span class="hljs-variable">$download_DIR</span><br>tar xvf netcdf-c-4.7.4.tar.gz 1&gt;/dev/<span class="hljs-literal">null</span> 2&gt;&amp;1 <br>cd netcdf-c-4.7.4/<br><br><span class="hljs-comment"># have to define below parameters</span><br><span class="hljs-built_in">export</span> <span class="hljs-attribute">FC</span>=mpifort<br><span class="hljs-built_in">export</span> <span class="hljs-attribute">F77</span>=mpifort<br><span class="hljs-built_in">export</span> <span class="hljs-attribute">F90</span>=mpifort<br><span class="hljs-built_in">export</span> <span class="hljs-attribute">CC</span>=mpicc<br><span class="hljs-built_in">export</span> <span class="hljs-attribute">CXX</span>=mpic++<br><br><span class="hljs-comment">###export LIBS=&quot;-lhdf5_hl -lhdf5 -lz -ldl&quot;</span><br><br><span class="hljs-built_in">export</span> <span class="hljs-attribute">LD_LIBRARY_PATH</span>=<span class="hljs-variable">$libs_DIR</span>/lib:$LD_LIBRARY_PATH<br><span class="hljs-built_in">export</span> <span class="hljs-attribute">LDFLAGS</span>=-L$libs_DIR/lib<br><span class="hljs-built_in">export</span> <span class="hljs-attribute">CPPFLAGS</span>=-I$libs_DIR/include<br><br>./configure <span class="hljs-attribute">--prefix</span>=<span class="hljs-variable">$libs_DIR</span> --enable-shared --enable-netcdf4 --disable-filter-testing --disable-dap<br>make -j 4 <br>make check<br>make install<br>cd <span class="hljs-built_in">..</span><br>rm -rf netcdf-c-4.7.4<br>echo <span class="hljs-string">&quot;=== netcdf-C (end) ====&quot;</span><br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>MPAS</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Installation</tag>
      
      <tag>netcdf-c</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>WRF | error - jas_image_t aka struct anonymous has no member named inmem_ and image.inmem_=1</title>
    <link href="/2024/05/30/WPS_install_enc_jpeg2000_error/"/>
    <url>/2024/05/30/WPS_install_enc_jpeg2000_error/</url>
    
    <content type="html"><![CDATA[<h1 id="issue">Issue</h1><p>While compiling WPSv3.8.1,</p><figure class="highlight basic"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs basic"><span class="hljs-symbol">17 </span>gcc -c  -D_UNDERSCORE -DBYTESWAP -DLINUX -DIO_NETCDF -DBIT32 -DNO_SIGNAL -D_MPI -I/home/wpsze/WRF/WRFv440/Library/include/ -DUSE_JPEG2000 -DUSE_PNG -D__64BIT__ enc_jp    eg2000.c<br><span class="hljs-symbol">18 </span>enc_jpeg2000.c: In function ‘enc_jpeg2000_’:<br><span class="hljs-symbol">19 </span>enc_jpeg2000.c:<span class="hljs-number">141</span>:<span class="hljs-number">10</span>: <span class="hljs-keyword">error</span>: ‘jas_image_t’ &#123;aka ‘struct &lt;anonymous&gt;’&#125; has no member named ‘inmem_’<br><span class="hljs-symbol">20 </span>  <span class="hljs-number">141</span> |     image.inmem_=<span class="hljs-number">1</span>;<br><span class="hljs-symbol">21 </span>      |          ^<br><span class="hljs-symbol">22 </span>make[<span class="hljs-number">2</span>]: [Makefile:<span class="hljs-number">75</span>: enc_jpeg2000.o] <span class="hljs-keyword">Error</span> <span class="hljs-number">1</span> (ignored)<br></code></pre></td></tr></table></figure><h1 id="search">Search</h1><p>From Grib2 output is broken -- <a href="https://github.com/wrf-model/WRF/issues/993" class="uri">https://github.com/wrf-model/WRF/issues/993</a></p><p>I'm unsure if the issue has been resolved, or if anyone still cares, but I think I see what might be going on here. The offending part of enc_jpeg2000.c relates to a C struct of type jas_image_t (in line 87 in the version of this file I'm looking at):</p><blockquote><p>jas_image_t image;</p></blockquote><p>It throws an error when the code tries to access the inmem_ element:</p><blockquote><pre><code class="hljs">image.inmem_=1;</code></pre></blockquote><p>This C struct is defined by jasper/jas_image.h (version 2.0.14, which is what I have on the system I'm working on). <figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">/* Image class. */</span><br><br><span class="hljs-keyword">typedef</span> <span class="hljs-keyword">struct</span> &#123;<br><br>        <span class="hljs-type">jas_image_coord_t</span> tlx_;<br>        <span class="hljs-comment">/* The x-coordinate of the top-left corner of the image bounding box. */</span><br><br>        <span class="hljs-type">jas_image_coord_t</span> tly_;<br>        <span class="hljs-comment">/* The y-coordinate of the top-left corner of the image bounding box. */</span><br><br>        <span class="hljs-type">jas_image_coord_t</span> brx_;<br>        <span class="hljs-comment">/* The x-coordinate of the bottom-right corner of the image bounding</span><br><span class="hljs-comment">          box (plus one). */</span><br><br>        <span class="hljs-type">jas_image_coord_t</span> bry_;<br>        <span class="hljs-comment">/* The y-coordinate of the bottom-right corner of the image bounding</span><br><span class="hljs-comment">          box (plus one). */</span><br><br>        <span class="hljs-type">int</span> numcmpts_;<br>        <span class="hljs-comment">/* The number of components. */</span><br><br>        <span class="hljs-type">int</span> maxcmpts_;<br>        <span class="hljs-comment">/* The maximum number of components that this image can have (i.e., the</span><br><span class="hljs-comment">          allocated size of the components array). */</span><br><br>        <span class="hljs-type">jas_image_cmpt_t</span> **cmpts_;<br>        <span class="hljs-comment">/* Per-component information. */</span><br><br>        <span class="hljs-type">jas_clrspc_t</span> clrspc_;<br><br>        <span class="hljs-type">jas_cmprof_t</span> *cmprof_;<br><br><span class="hljs-comment">//      bool inmem_;</span><br><br>&#125; <span class="hljs-type">jas_image_t</span>;<br></code></pre></td></tr></table></figure></p><p>You can see that the bool component inmem_ has been commented out. If you go back to older versions of jasper you can get back to one that doesn't have inmem_ commented out. For example, in the <a href="https://github.com/jasper-software/jasper">github repo for this library</a>, that would be something like SHAH 2b2efba4eda0a654ab02 or version 1.900.24, which dates to Nov 2016.</p><h1 id="workaround">Workaround</h1><h2 id="in-wpsv3.8.1-code">In WPSv3.8.1 code</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">./ungrib/src/ngl/g2/dec_jpeg2000.c:104:    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot; inmem %d \n&quot;</span>,image-&gt;inmem_);<br>./ungrib/src/ngl/g2/enc_jpeg2000.c:141:    image.inmem_=1;<br></code></pre></td></tr></table></figure><p>and, modify enc_jpeg2000.c</p><figure class="highlight actionscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs actionscript"><span class="hljs-comment">/* </span><br><span class="hljs-comment"> * Does not seem to be needed, and throws a compiler error</span><br><span class="hljs-comment"> * image.inmem_=1;</span><br><span class="hljs-comment"> */</span><br></code></pre></td></tr></table></figure><p>Finally, ungrib.exe is generated.</p><p>but, is it right? will that break something...?</p><p>Ref: <a href="https://www.cnblogs.com/jiangleads/articles/11422607.html">WRF 3.9.1.1 安装 记录</a> &gt;此外，如果安装的是较新的jasper版本，还需要更改文件enc_jpeg2000.c （在目录WPS/ungrib/src/ngl/g2/enc_jpeg2000.c） &gt; 参见 <a href="http://forum.wrfforum.com/viewtopic.php?f=20&amp;t=10035" class="uri">http://forum.wrfforum.com/viewtopic.php?f=20&amp;t=10035</a> &gt;将第141行 &gt;&gt; image.inmem_=1; &gt;注释掉 &gt;这样，就能生成ungrib.exe了</p>]]></content>
    
    
    <categories>
      
      <category>WRF</category>
      
    </categories>
    
    
    <tags>
      
      <tag>WPS</tag>
      
      <tag>Installation</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>WRF | Error - Size of put argument of random_seed intrinsic at (1) too small</title>
    <link href="/2024/05/30/WRF_install_random_seed_error/"/>
    <url>/2024/05/30/WRF_install_random_seed_error/</url>
    
    <content type="html"><![CDATA[<h1 id="issue">Issue</h1><p>While compiling WRFv3.8.1,</p><figure class="highlight basic"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs basic"><span class="hljs-symbol">2065 </span><br><span class="hljs-symbol">2066 </span> <span class="hljs-number">3128</span> |                    <span class="hljs-keyword">call</span> random_seed (<span class="hljs-keyword">PUT</span>=seed)<br><span class="hljs-symbol">2067 </span>      |                                         <span class="hljs-number">1</span><br><span class="hljs-symbol">2068 </span><span class="hljs-keyword">Error</span>: Size of ‘<span class="hljs-keyword">put</span>’ argument of ‘random_seed’ intrinsic at (<span class="hljs-number">1</span>) too small (<span class="hljs-number">12</span>/<span class="hljs-number">33</span>)<br><span class="hljs-symbol">2069 </span>module_cu_g3.f90:<span class="hljs-number">3217</span>:<span class="hljs-number">41</span>:<br><span class="hljs-symbol">2070 </span><br><span class="hljs-symbol">2071 </span> <span class="hljs-number">3217</span> |                    <span class="hljs-keyword">call</span> random_seed (<span class="hljs-keyword">PUT</span>=seed)<br><span class="hljs-symbol">2072 </span>      |                                         <span class="hljs-number">1</span><br><span class="hljs-symbol">2073 </span><span class="hljs-keyword">Error</span>: Size of ‘<span class="hljs-keyword">put</span>’ argument of ‘random_seed’ intrinsic at (<span class="hljs-number">1</span>) too small (<span class="hljs-number">12</span>/<span class="hljs-number">33</span>)<br><span class="hljs-symbol">2074 </span>module_cu_g3.f90:<span class="hljs-number">3232</span>:<span class="hljs-number">41</span>:<br><span class="hljs-symbol">2075 </span><br><span class="hljs-symbol">2076 </span> <span class="hljs-number">3232</span> |                    <span class="hljs-keyword">call</span> random_seed (<span class="hljs-keyword">PUT</span>=seed)<br><span class="hljs-symbol">2077 </span>      |                                         <span class="hljs-number">1</span><br><span class="hljs-symbol">2078 </span><span class="hljs-keyword">Error</span>: Size of ‘<span class="hljs-keyword">put</span>’ argument of ‘random_seed’ intrinsic at (<span class="hljs-number">1</span>) too small (<span class="hljs-number">12</span>/<span class="hljs-number">33</span>)<br><span class="hljs-symbol">2079 </span>make[<span class="hljs-number">3</span>]: [../configure.wrf:<span class="hljs-number">339</span>: module_cu_g3.o] <span class="hljs-keyword">Error</span> <span class="hljs-number">1</span> (ignored)<br><span class="hljs-symbol">2080 </span>rm -f module_cu_kfeta.o<br></code></pre></td></tr></table></figure><h1 id="solution">Solution</h1><p>Ref: - <a href="https://forum.mmm.ucar.edu/threads/wrfv3-9-compilation-error-on-ubuntu-18-04-lts-with-gfortran-7-4.8786/">WRFV3.9 compilation error on Ubuntu 18.04 LTS with gfortran-7.4</a> - <a href="https://forum.mmm.ucar.edu/threads/wrfv3-8-problem-building-executables.8418/">WRFV3.8 problem building executables</a> - <a href="https://forum.mmm.ucar.edu/threads/wrfv381-with-gnu8-x.217/">WRFv381 with GNU8.x</a></p><blockquote><p>This code has been corrected beginning with V4.0. I'm attaching the modified file so that you can see how we changed it. Unfortunately we didn't have a git repo when we released V3.8.1, but we can add the problems to our known problems page.</p></blockquote><p>The file is &gt; WRF/phys/module_cu_g3.F</p><p>on <a href="https://github.com/wrf-model/WRF/blob/v4.0/phys/module_cu_g3.F" class="uri">https://github.com/wrf-model/WRF/blob/v4.0/phys/module_cu_g3.F</a></p><figure class="highlight gcode"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs gcode">$ md<span class="hljs-number">5</span>sum module_cu_<span class="hljs-name">g3.</span>F<br>e<span class="hljs-number">385527</span>b<span class="hljs-number">41</span>d<span class="hljs-number">374</span>d<span class="hljs-number">6530596</span>e<span class="hljs-number">069</span>fb<span class="hljs-number">547</span>b  module_cu_<span class="hljs-name">g3.</span>F<br></code></pre></td></tr></table></figure><h1 id="but">But</h1><blockquote><p>Fatal Error: Can't open module file 'module_initialize_real.mod' for reading at (1): No such file or directory</p></blockquote><h2 id="solution-1">Solution</h2><p>Then it should end successfully when running the command a second time (do not understand why but it works...)</p><ol type="1"><li>$ ./compile -j 8 em_real 2&gt;&amp;1 | tee compile.log</li><li>Fatal Error: Can't open module file 'module_initialize_real.mod' ...</li><li>$ ./compile -j 8 em_real 2&gt;&amp;1 | tee compile.log</li><li>Then, it works !!</li></ol><p>ref: <a href="https://valcap74.blogspot.com/2017/10/how-to-compile-wrf-model-on-ecmwf-cray.html" class="uri">https://valcap74.blogspot.com/2017/10/how-to-compile-wrf-model-on-ecmwf-cray.html</a></p>]]></content>
    
    
    <categories>
      
      <category>WRF</category>
      
    </categories>
    
    
    <tags>
      
      <tag>WRF</tag>
      
      <tag>Installation</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>MPAS | MPAS-JEDI</title>
    <link href="/2024/05/29/MPAS-JEDI_note/"/>
    <url>/2024/05/29/MPAS-JEDI_note/</url>
    
    <content type="html"><![CDATA[<h1 id="workshop">Workshop</h1><ol type="1"><li><a href="http://www.gpsarc.ncu.edu.tw/MPAS2023/download.html">2023-10 MPAS-A and MPAS-JEDI Tutorials and Workshop, National Central University (NCU)</a></li><li><a href="https://www2.mmm.ucar.edu/projects/mpas-jedi/tutorial/202310NCU/">Welcome to the MPAS-JEDI tutorial practice guide, 202310NCU</a><ol type="1"><li>This web page is intended to serve as a guide through the practice exercises of this tutorial. Exercises are split into seven main sections, each of which focuses on a particular aspect of using the MPAS-JEDI data assimilation system.</li><li><a href="https://www2.mmm.ucar.edu/projects/mpas-jedi/tutorial/202309NCAR/testdata/">2023-09NCAR/testdata</a></li></ol></li><li><a href="https://www2.mmm.ucar.edu/projects/mpas-jedi/tutorial/202309NCAR/agenda.html">2023-09 MPAS-JEDI Tutorial Agenda</a></li><li><a href="https://www2.mmm.ucar.edu/projects/mpas-jedi/tutorial/202309NCAR/">Welcome to the MPAS-JEDI tutorial practice guide, 202309NCAR</a><ol type="1"><li>This web page is intended to serve as a guide through the practice exercises of this tutorial. Exercises are split into seven main sections, each of which focuses on a particular aspect of using the MPAS-JEDI data assimilation system.</li></ol></li><li><a href="https://www2.mmm.ucar.edu/projects/mpas-jedi/tutorial/202410HOWARD/lectures/">MPAS-JEDI Tutorial, Howard University | October 3-4, 2024</a><ol type="1"><li><a href="https://www2.mmm.ucar.edu/projects/mpas-jedi/tutorial/202410HOWARD/lectures/3-Overview.pdf">3-Overview.pdf</a></li></ol></li></ol><div class="group-image-container"><div class="group-image-row"><div class="group-image-wrap"><img src="https://i.imgur.com/6oGdLJk.png" width="600" /></div><div class="group-image-wrap"><img src="https://i.imgur.com/UA7n4qz.png" width="600" /></div></div></div><h1 id="papers">Papers</h1><ul><li>3DEnVar<ul><li><a href="https://gmd.copernicus.org/preprints/gmd-2022-133/gmd-2022-133.pdf">Liu, Zhiquan, et al. "Data assimilation for the Model for Prediction Across Scales–Atmosphere with the Joint Effort for Data assimilation Integration (JEDI-MPAS 1.0. 0): EnVar implementation and evaluation." Geoscientific Model Development Discussions 2022 (2022): 1-33.</a></li></ul></li><li>IAU<ul><li><a href="https://egusphere.copernicus.org/preprints/2023/egusphere-2023-2299/egusphere-2023-2299.pdf">Ha, S., Guerrette, J. J., Hernandez Banos, I., Skamarock, W. C., &amp; Duda, M. G. (2023). Incremental Analysis Update (IAU) in the Model for Prediction Across Scales coupled with the Joint Effort for Data assimilation Integration (MPAS-JEDI 2.0. 0). EGUsphere, 2023, 1-21.</a></li></ul></li><li>3DVar<ul><li><a href="https://gmd.copernicus.org/articles/17/3879/2024/gmd-17-3879-2024.html">Jung, Byoung-Joo, et al. "Three-dimensional variational assimilation with a multivariate background error covariance for the Model for Prediction Across Scales–Atmosphere with the Joint Effort for data Assimilation Integration (JEDI-MPAS 2.0. 0-beta)." Geoscientific Model Development 17.9 (2024): 3879-3895.</a></li></ul></li><li>Ensemble/EDA<ul><li><a href="https://gmd.copernicus.org/preprints/gmd-2023-54/gmd-2023-54.pdf">Guerrette, Jonathan J., et al. "Data assimilation for the Model for Prediction Across Scales–Atmosphere with the Joint Effort for Data assimilation Integration (JEDI-MPAS 2.0. 0-beta): ensemble of 3D ensemble-variational (En-3DEnVar) assimilations." Geoscientific Model Development Discussions 2023 (2023): 1-34.</a></li></ul></li></ul><h1 id="github">Github</h1><p><a href="https://github.com/JCSDA/mpas-jedi">MPAS-JEDI</a></p><h1 id="presentation">Presentation</h1><ol type="1"><li>2nd EarthCare Moldeling Workshop, Shuzenji, Japan, 27-29 March, 2023 Jake Liu<ul><li><a href="https://www.eorc.jaxa.jp/EARTHCARE/event/Modeling_ws2023/material1/March28/11_EarthCare2023_JakeLiu%20zhiquan%20liu.pdf">Towards global convection-permitting NWP using MPAS and MPAS-JEDI</a></li></ul></li></ol><h1 id="ucar-mpas-jedi-weekly-cycling">UCAR: MPAS-JEDI Weekly Cycling</h1><ul><li><a href="https://www2.mmm.ucar.edu/projects/mpas-jedi/weekly-cycling/" class="uri">https://www2.mmm.ucar.edu/projects/mpas-jedi/weekly-cycling/</a></li></ul>]]></content>
    
    
    <categories>
      
      <category>MPAS</category>
      
    </categories>
    
    
    <tags>
      
      <tag>MPAS</tag>
      
      <tag>DA</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>MPAS | MPAS installation - configure - RUNNING CONFIGURE FOR ch4:ucx</title>
    <link href="/2024/05/29/MPAS_install_error_CH4_UCX/"/>
    <url>/2024/05/29/MPAS_install_error_CH4_UCX/</url>
    
    <content type="html"><![CDATA[<h1 id="issue">Issue</h1><figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs stata">configure: RUNNING CONFIGURE <span class="hljs-keyword">FOR</span> ch4:ucx<br>configure: CH4 UCX Netmod:  Using <span class="hljs-keyword">an</span> external ucx<br>checking <span class="hljs-keyword">if</span> UCX meets minimum <span class="hljs-keyword">version</span> requirement... <span class="hljs-keyword">no</span><br>configure: <span class="hljs-keyword">error</span>: UCX installation does not meet minimum <span class="hljs-keyword">version</span> requirement (v1.9.0). Please upgrade your installation, or <span class="hljs-keyword">use</span> --with-ucx=embedded.<br></code></pre></td></tr></table></figure><h1 id="solution">Solution</h1><p>Configure will use an embedded copy of libfabric or ucx if one is not found in the user environment. An installation can be specified by adding</p><blockquote><p>--with-libfabric=<path/to/install> or --with-ucx=<path/to/install></p></blockquote><p>to the configuration.</p><p>The previous MPICH default device (ch3) is also available and supported with option:</p><blockquote><p>--with-device=ch3</p></blockquote>]]></content>
    
    
    <categories>
      
      <category>MPAS</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Installation</tag>
      
      <tag>MPAS</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>VSCode with Markdown editor</title>
    <link href="/2024/05/29/VSCode_markdown_editor/"/>
    <url>/2024/05/29/VSCode_markdown_editor/</url>
    
    <content type="html"><![CDATA[<p>Working with <a href="https://code.visualstudio.com/docs/languages/markdown">Markdown files in Visual Studio Code</a> is simple, straightforward, and fun. Besides VS Code's basic editing, there are a several Markdown-specific features that help you be more productive.</p><h1 id="markdown-preview">Markdown preview</h1><p>You can also right-click on the editor Tab and select Open Preview (Ctrl+Shift+V) or use the Command Palette (Ctrl+Shift+P) to run the Markdown: <strong>Open Preview to the Side</strong> command (Ctrl+K V).</p><h1 id="outline-view">Outline view</h1><p>The Outline view is a separate section in the bottom of the File Explorer. When expanded, it shows the symbol tree of the currently active editor. For Markdown files, the symbol tree is the Markdown file's header hierarchy.</p><h1 id="extension">Extension</h1><ul><li>markdownlint</li><li>Markdown All in One</li><li>Markdown Preview Github Styling</li><li>Markdown Preview Enhanced</li><li>Markdown Table Prettifier</li></ul><h1 id="markdown-syntax">Markdown syntax</h1><h2 id="bolditalics">Bold/Italics</h2><ul><li>I just love <strong>bold text</strong>./I just love <em>bold text</em>.</li><li>I just love <strong>bold text</strong>./I just love <em>bold text</em>.</li><li>Love<strong>is</strong>bold./Love<em>is</em>bold</li></ul><h2 id="blockquotes">Blockquotes</h2><blockquote><p>It is Markdown.</p></blockquote><blockquote><p>It is also Markdown.</p><p>same here. &gt; indent &gt; &gt; indent</p></blockquote><blockquote><h4 id="the-quarterly-results-look-great">The quarterly results look great!</h4><ul><li>Revenue was off the chart.</li><li>Profits were higher than ever.</li></ul><p><em>Everything</em> is going according to <strong>plan</strong>.</p></blockquote><h2 id="lists">Lists</h2><ol type="1"><li>First item</li><li>Second item</li><li>Third item<ol type="1"><li>Indented item</li><li>Indented item</li></ol></li><li>Fourth item</li></ol><p>Or,</p><ul><li>First item</li><li>Second item</li><li>Third item<ul><li>Indented item</li><li>Indented item</li></ul></li><li>Fourth item</li></ul><p>Or,</p><ol type="1"><li>First item</li><li>Second item</li><li>Third item<ul><li>Indented item</li><li>Indented item</li></ul></li><li>Fourth item</li></ol><h2 id="code-and-highlighting">Code and Highlighting</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-meta">#!/bin/sh</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;Hello world&quot;</span><br></code></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np<br></code></pre></td></tr></table></figure><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;iostream&gt;</span></span><br><span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> std;<br><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>&#123;<br>  cout &lt;&lt; <span class="hljs-string">&quot;Hello World!&quot;</span>;<br>  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span> &#123;<br>   <span class="hljs-comment">// printf() displays the string inside quotation</span><br>   <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Hello, World!&quot;</span>);<br>   <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="table">Table</h2><ul><li><a href="https://medium.com/%E8%B2%93%E7%A7%91%E5%B7%A5%E7%A8%8B%E5%B8%AB%E7%9A%84%E6%97%A5%E5%B8%B8/%E7%94%A8css-table%E5%81%9A%E5%87%BA%E5%A5%BD%E7%9C%8B%E7%9A%84%E8%A1%A8%E6%A0%BC-7ec639942fea">CSS筆記-如何用Table做出好看的表格</a></li></ul><p>You first have to understand table structure: a <code>table</code> element consists of a head and a body (<code>thead</code> and <code>tbody</code>). Both of them in turn are made up of row (<code>tr</code>) elements. And every row consists of <code>th</code> (for a table head) or <code>td</code> elements which are finally defining the table cells themselves.</p><p>One detail many people want are lines dividing the columns and rows. That, however, is not something you can set for the whole table. Instead, you have to specify a <code>border</code> for the <code>td</code> and <code>th</code> cells:</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs css"><span class="hljs-selector-tag">table</span> <span class="hljs-selector-pseudo">:is</span>(<span class="hljs-selector-tag">td</span>, <span class="hljs-selector-tag">th</span>) &#123;<br>  <span class="hljs-attribute">border</span>: <span class="hljs-number">1px</span> solid black;<br>  <span class="hljs-attribute">padding</span>: <span class="hljs-number">0.3em</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>Here, <code>table :is(td.th)</code> is an abbreviation for <code>table td, table th</code>.</p><div class="note note-primary">            <p><strong>Edit markdown.styl</strong></p>          </div><style>.wrap{  overflow:hidden;  border-radius:10px 10px 0px 0px;  box-shadow: 0 0 20px rgba(0, 0, 0, 0.35);}table{  font-family: 'Oswald', sans-serif;  border-collapse:separate;}th{  background-color:#009879;  color:#ffffff;  width:25vw;  height:25px;}td{  background-color:#ffffff;  width:25vw;  height:25px;  text-align:left;}tr{  border-bottom: 1px solid #dddddd;}tr:nth-of-type(even) td{  background-color:#f3f3f3;}tr:hover td{  background-color:#ffe599;    transition: all 0.3s ease-in-out;}</style><table><thead><tr class="header"><th>Syntax</th><th>Description</th></tr></thead><tbody><tr class="odd"><td>Header</td><td>Title</td></tr><tr class="even"><td>Paragraph 1</td><td>Text 1</td></tr><tr class="odd"><td>Paragraph 2</td><td>Text 2</td></tr></tbody></table><table><thead><tr class="header"><th style="text-align: left;">Left-Aligned</th><th style="text-align: center;">Center Aligned</th><th style="text-align: right;">Right Aligned</th></tr></thead><tbody><tr class="odd"><td style="text-align: left;">Row 1</td><td style="text-align: center;">Cell 2</td><td style="text-align: right;">Cell 3</td></tr><tr class="even"><td style="text-align: left;">Row 2</td><td style="text-align: center;">Cell 5</td><td style="text-align: right;">Cell 6</td></tr><tr class="odd"><td style="text-align: left;">Row 3</td><td style="text-align: center;">Cell 8</td><td style="text-align: right;">Cell 9</td></tr></tbody></table><table><thead><tr class="header"><th style="text-align: left;">Left-Aligned</th><th style="text-align: center;">Center Aligned</th><th style="text-align: right;">Right Aligned</th></tr></thead><tbody><tr class="odd"><td style="text-align: left;">Row 1</td><td style="text-align: center;"><strong>Bold</strong></td><td style="text-align: right;">Cell 3</td></tr><tr class="even"><td style="text-align: left;">Row 2</td><td style="text-align: center;"><em>Italic</em></td><td style="text-align: right;">Cell 6</td></tr><tr class="odd"><td style="text-align: left;">Row 3</td><td style="text-align: center;"><del>Strike</del></td><td style="text-align: right;">Cell 9</td></tr><tr class="even"><td style="text-align: left;">Row 3</td><td style="text-align: center;"><a href="dot.com">Link</a></td><td style="text-align: right;">Cell 9</td></tr></tbody></table><p><a href="https://nabeelvalley.co.za/blog/2021/23-03/custom-styles-in-markdown/" class="uri">https://nabeelvalley.co.za/blog/2021/23-03/custom-styles-in-markdown/</a></p><table><thead><tr class="header"><th style="text-align: center;"><!-- --></th><th style="text-align: center;"><!-- --></th><th style="text-align: center;"><!-- --></th></tr></thead><tbody><tr class="odd"><td style="text-align: center;">Row 1</td><td style="text-align: center;"><strong>Bold</strong></td><td style="text-align: center;">Cell 3</td></tr><tr class="even"><td style="text-align: center;">Row 2</td><td style="text-align: center;"><em>Italic</em></td><td style="text-align: center;">Cell 6</td></tr><tr class="odd"><td style="text-align: center;">Row 3</td><td style="text-align: center;"><del>Strike</del></td><td style="text-align: center;">Cell 9</td></tr></tbody></table><table><thead><tr class="header"><th style="text-align: left;">elec_physics</th><th style="text-align: center;">nssl_ipelec</th><th style="text-align: center;">nssl_idischarge</th><th style="text-align: left;">outputs</th></tr></thead><tbody><tr class="odd"><td style="text-align: left;">1</td><td style="text-align: center;">2</td><td style="text-align: center;">1</td><td style="text-align: left;">?</td></tr><tr class="even"><td style="text-align: left;">1</td><td style="text-align: center;">3</td><td style="text-align: center;">1</td><td style="text-align: left;">scalar:scr,scw,sci,scs,sch,schl,sciona; <br> state:rscghis_2d,sctot,noninduc,induc,pot, <br> elecmag,elecx,elecy,elecz,light,lightdens,lightdis</td></tr><tr class="odd"><td style="text-align: left;">1</td><td style="text-align: center;">3</td><td style="text-align: center;">2</td><td style="text-align: left;">state:flshi,flshn,flshp,flshfedic, <br> flshfedicp,flshfedicn,flshfedcg,flshfedcgp,flshfedcgn</td></tr></tbody></table><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs markdown">| Syntax | Description |<br>| ----------- | ----------- |<br>| Header | Title |<br>| Paragraph 1| Text 1|<br>| Paragraph 2 | Text 2|<br><br>| Left-Aligned  | Center Aligned  | Right Aligned |<br>|:------------- |:---------------:| -------------:|<br>| Row 1         | Cell 2          | Cell 3        |<br>| Row 2         | Cell 5          | Cell 6        |<br>| Row 3         | Cell 8          | Cell 9        |<br><br>| Left-Aligned  | Center Aligned  | Right Aligned |<br>|:------------- |:---------------:| -------------:|<br>| Row 1         | <span class="hljs-strong">**Bold**</span>        | Cell 3        |<br>| Row 2         | <span class="hljs-emphasis">*Italic*</span>        | Cell 6        |<br>| Row 3         | ~~Strike~~      | Cell 9        |<br>| Row 3         | [<span class="hljs-string">Link</span>](<span class="hljs-link">dot.com</span>) | Cell 9        |<br><br>| &lt;!-- --&gt;      | &lt;!-- --&gt;        | &lt;!-- --&gt;      |<br>|:-------------:|:---------------:|:-------------:|<br>| Row 1         | <span class="hljs-strong">**Bold**</span>        | Cell 3        |<br>| Row 2         | <span class="hljs-emphasis">*Italic*</span>        | Cell 6        |<br>| Row 3         | ~~Strike~~      | Cell 9        |<br><br>| elec<span class="hljs-emphasis">_physics  | nssl_</span>ipelec  | nssl<span class="hljs-emphasis">_idischarge | outputs |</span><br><span class="hljs-emphasis">|:------------- |:---------------:|:---------------:| :-------------|</span><br><span class="hljs-emphasis">| 1         | 2          | 1        | ? |</span><br><span class="hljs-emphasis">| 1         | 3          | 1        | scalar:scr,scw,sci,scs,sch,schl,sciona; <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span></span> state:rscghis_</span>2d,sctot,noninduc,induc,pot, <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span></span> elecmag,elecx,elecy,elecz,light,lightdens,lightdis |<br>| 1         | 3          | 2       | state:flshi,flshn,flshp,flshfedic, <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span></span> flshfedicp,flshfedicn,flshfedcg,flshfedcgp,flshfedcgn |<br><br></code></pre></td></tr></table></figure><h3 id="useful-link">Useful link</h3><ul><li><a href="https://www.tablesgenerator.com/markdown_tables">Markdown Table Generator</a></li></ul><h2 id="links">Links</h2><p>To create a link, enclose the link text in brackets (e.g., [Duck Duck Go]) and then follow it immediately with the URL in parentheses (e.g., (https://duckduckgo.com)).</p><p>It is <a href="https://en.wikipedia.org/wiki/GNU_Compiler_Collection">GNU Compiler Collection (GCC)</a>.</p><h2 id="urls-and-email-addresses">URLs and Email Addresses</h2><p><a href="https://www.markdownguide.org" class="uri">https://www.markdownguide.org</a><br /><a href="mailto:waipangsze@gmail.com" class="email">waipangsze@gmail.com</a></p><h2 id="task-list">Task List</h2><ul><li>[x] Write the press release</li><li>[ ] Update the website</li><li>[ ] Contact the media</li></ul><h2 id="image">Image</h2><ol type="1"><li><p>Open the file containing the Linux.</p><figure><img src="https://upload.wikimedia.org/wikipedia/commons/thumb/3/35/Tux.svg/150px-Tux.svg.png" alt="Tux, the Linux mascot" /><figcaption>Tux, the Linux mascot</figcaption></figure></li><li><p>Close the file.</p></li></ol><figure><img src="https://upload.wikimedia.org/wikipedia/commons/thumb/3/35/Tux.svg/150px-Tux.svg.png" alt="Tux, the Linux mascot" width="50" /><figcaption>Tux, the Linux mascot</figcaption></figure><h2 id="in-fluid-theme">In Fluid theme,</h2><h3 id="便签">便签</h3><p>可选便签：</p><ul><li>primary</li><li>secondary</li><li>success</li><li>danger</li><li>warning</li><li>info</li><li>light</li></ul><div class="note note-primary">            <p>primary: 文字 或者 <code>markdown</code> 均可</p>          </div><div class="note note-secondary">            <p>secondary: 文字 或者 <code>markdown</code> 均可</p>          </div><div class="note note-success">            <p>success: 文字 或者 <code>markdown</code> 均可</p>          </div><div class="note note-danger">            <p>danger: 文字 或者 <code>markdown</code> 均可</p>          </div><div class="note note-warning">            <p>warning: 文字 或者 <code>markdown</code> 均可</p>          </div><div class="note note-info">            <p>info: 文字 或者 <code>markdown</code> 均可</p>          </div><div class="note note-light">            <p>light: 文字 或者 <code>markdown</code> 均可</p>          </div><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs markdown">&#123;% note primary %&#125;<br>primary: 文字 或者 <span class="hljs-code">`markdown`</span> 均可<br>&#123;% endnote %&#125;<br></code></pre></td></tr></table></figure><h2 id="text---mermaid">TeXt - Mermaid,</h2><p>set <code>mermaid: true</code></p><figure class="highlight oxygene"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs oxygene"># 流程图，基于 mermaid-js，具体请见：https:<span class="hljs-comment">//hexo.fluid-dev.com/docs/guide/#mermaid-流程图</span><br># Flow chart, based <span class="hljs-keyword">on</span> mermaid-js, see: https:<span class="hljs-comment">//hexo.fluid-dev.com/docs/en/guide/#mermaid</span><br>mermaid:<br># 开启后文章默认可用，自定义页面如需使用，需在 Front-matter 中指定 `mermaid: <span class="hljs-keyword">true</span>`<br># <span class="hljs-keyword">If</span> you want <span class="hljs-keyword">to</span> use mermaid <span class="hljs-keyword">on</span> the custom page, you need <span class="hljs-keyword">to</span> <span class="hljs-keyword">set</span> `mermaid: <span class="hljs-keyword">true</span>` <span class="hljs-keyword">in</span> Front-matter<br>enable: <span class="hljs-keyword">false</span><br></code></pre></td></tr></table></figure><p>and,</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">npm install hexo-filter-mermaid-diagrams<br></code></pre></td></tr></table></figure><pre class="mermaid">pie title NETFLIX         "Time spent looking for movie" : 90         "Time spent watching it" : 10</pre><pre class="mermaid">flowchart TD    Start --> Stop</pre><h3 id="flowchart">Flowchart</h3><pre class="mermaid">graph TD;    A-->B;    A-->C;    B-->D;    C-->D;</pre><pre><code class="hljs">&lt;pre class=&quot;mermaid&quot;&gt;    graph TD;    A--&gt;B;    A--&gt;C;    B--&gt;D;    C--&gt;D;&lt;/pre&gt;</code></pre><h3 id="sequence-diagram">Sequence Diagram</h3><pre class="mermaid">sequenceDiagram    participant Alice    participant Bob    Alice->John: Hello John, how are you?    loop Healthcheck        John->John: Fight against hypochondria    end    Note right of John: Rational thoughts <br/>prevail...    John-->Alice: Great!    John->Bob: How about you?    Bob-->John: Jolly good!</pre><pre><code class="hljs">&lt;pre class=&quot;mermaid&quot;&gt;    sequenceDiagram    participant Alice    participant Bob    Alice-&gt;John: Hello John, how are you?    loop Healthcheck        John-&gt;John: Fight against hypochondria    end    Note right of John: Rational thoughts &lt;br/&gt;prevail...    John--&gt;Alice: Great!    John-&gt;Bob: How about you?    Bob--&gt;John: Jolly good!&lt;/pre&gt;</code></pre><h3 id="gant-diagrams">Gant Diagrams</h3><pre class="mermaid">gantt    dateFormat  YYYY-MM-DD    title Adding GANTT diagram functionality to mermaid    section A section        Completed task            :done,    des1, 2014-01-06,2014-01-08        Active task               :active,  des2, 2014-01-09, 3d        Future task               :         des3, after des2, 5d        Future task2              :         des4, after des3, 5d    section Critical tasks        Completed task in the critical line :crit, done, 2014-01-06,24h        Implement parser and jison          :crit, done, after des1, 2d        Create tests for parser             :crit, active, 3d        Future task in critical line        :crit, 5d        Create tests for renderer           :2d</pre><pre><code class="hljs">&lt;pre class=&quot;mermaid&quot;&gt;    gantt    dateFormat  YYYY-MM-DD    title Adding GANTT diagram functionality to mermaid    section A section        Completed task            :done,    des1, 2014-01-06,2014-01-08        Active task               :active,  des2, 2014-01-09, 3d        Future task               :         des3, after des2, 5d        Future task2              :         des4, after des3, 5d    section Critical tasks        Completed task in the critical line :crit, done, 2014-01-06,24h        Implement parser and jison          :crit, done, after des1, 2d        Create tests for parser             :crit, active, 3d        Future task in critical line        :crit, 5d        Create tests for renderer           :2d&lt;/pre&gt;</code></pre><pre class="mermaid">gantt    title A Gantt Diagram    dateFormat YYYY-MM-DD    section Section        A task          :a1, 2014-01-01, 30d        Another task    :after a1, 20d    section Another        Task in Another :2014-01-12, 12d        another task    :24d    section Another 2        Task in Another :2014-01-12, 12d        another task    :24d</pre><pre><code class="hljs">&lt;pre class=&quot;mermaid&quot;&gt;    gantt    title A Gantt Diagram    dateFormat YYYY-MM-DD    section Section        A task          :a1, 2014-01-01, 30d        Another task    :after a1, 20d    section Another        Task in Another :2014-01-12, 12d        another task    :24d    section Another 2        Task in Another :2014-01-12, 12d        another task    :24d&lt;/pre&gt;</code></pre><h2 id="math-block">Math block</h2><p>set<br /><code>mathjax: true</code><br /><code>mathjax_autoNumber: true</code> {:.info}</p><h3 id="in-text-theme-mathjax-is-used.">In TeXt theme, MathJax is used.</h3><ol type="1"><li><a href="https://nightcatv.github.io/2020/06/05/MathJax%20%E8%AA%9E%E6%B3%95%E8%A3%9C%E5%B8%96/#MathJax-%E8%AA%9E%E6%B3%95%E8%A3%9C%E5%B8%96">MathJax 語法補帖</a></li><li><a href="https://bachzart.github.io/2020/09/17/MathJax-%E8%AF%AD%E6%B3%95%E5%BF%AB%E9%80%9F%E6%8C%87%E5%8D%97/">MathJax 语法快速指南</a></li></ol><p>edit waipangsze.github.io/_includes/markdown-enhancements/mathjax.html and add</p><figure class="highlight prolog"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs prolog">displayMath: [ [<span class="hljs-string">&#x27;$$&#x27;</span>,<span class="hljs-string">&#x27;$$&#x27;</span>], [<span class="hljs-string">&#x27;\\[&#x27;</span>,<span class="hljs-string">&#x27;\\]&#x27;</span>] ]<br></code></pre></td></tr></table></figure><p>and,</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;text/x-mathjax-config&quot;</span>&gt;</span><span class="language-javascript"></span><br><span class="language-javascript"><span class="hljs-keyword">var</span> _config = &#123; <span class="hljs-attr">tex2jax</span>: &#123;</span><br><span class="language-javascript">        <span class="hljs-attr">inlineMath</span>: [ [<span class="hljs-string">&#x27;$&#x27;</span>,<span class="hljs-string">&#x27;$&#x27;</span>], [<span class="hljs-string">&#x27;\\(&#x27;</span>,<span class="hljs-string">&#x27;\\)&#x27;</span>] ],</span><br><span class="language-javascript">        <span class="hljs-attr">displayMath</span>: [ [<span class="hljs-string">&#x27;$$&#x27;</span>,<span class="hljs-string">&#x27;$$&#x27;</span>], [<span class="hljs-string">&#x27;\\[&#x27;</span>,<span class="hljs-string">&#x27;\\]&#x27;</span>] ]</span><br><span class="language-javascript">&#125;&#125;;</span><br><span class="language-javascript">_config.<span class="hljs-property">TeX</span> = &#123; <span class="hljs-attr">equationNumbers</span>: &#123; <span class="hljs-attr">autoNumber</span>: <span class="hljs-string">&quot;all&quot;</span> &#125; &#125;;</span><br><span class="language-javascript"><span class="hljs-title class_">MathJax</span>.<span class="hljs-property">Hub</span>.<span class="hljs-title class_">Config</span>(_config);</span><br><span class="language-javascript"></span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;text/javascript&quot;</span> <span class="hljs-attr">src</span>=<span class="hljs-string">&quot;https://cdn.bootcss.com/mathjax/2.7.4/MathJax.js?config=TeX-MML-AM_CHTML&quot;</span> <span class="hljs-attr">async</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br></code></pre></td></tr></table></figure><p>Inline math: <span class="math inline">\(x^2\)</span></p><p><span class="math display">\[\left( \sum_{k=1}^n a_k b_k \right)^2\leq\left( \sum_{k=1}^n a_k^2 \right)\left( \sum_{k=1}^n b_k^2 \right)\]</span></p><p><span class="math display">\[a+1 = b\\c+2 = d \]</span></p><p><span class="math display">\[\begin{align}a &amp;= 1 \\b &amp;= 2 \end{align}\tag{1}\]</span></p><p><span class="math display">\[\begin{equation}\begin{split}A &amp; = \frac{\pi r^2}{2} \\    &amp; = \frac{1}{2} \pi r^2\end{split}\end{equation}\tag{2}\]</span></p><p><span class="math display">\[\begin{align*}  &amp; \phi(x,y) = \phi \left(\sum_{i=1}^n x_ie_i, \sum_{j=1}^n y_je_j \right)  = \sum_{i=1}^n \sum_{j=1}^n x_i y_j \phi(e_i, e_j) = \\  &amp; (x_1, \ldots, x_n) \left( \begin{array}{ccc}      \phi(e_1, e_1) &amp; \cdots &amp; \phi(e_1, e_n) \\      \vdots &amp; \ddots &amp; \vdots \\      \phi(e_n, e_1) &amp; \cdots &amp; \phi(e_n, e_n)    \end{array} \right)  \left( \begin{array}{c}      y_1 \\      \vdots \\      y_n    \end{array} \right)\end{align*}\]</span></p><p><span class="math display">\[a = 1 \\b + 1 = 2 \\c + 1 + 2 = 3\]</span></p><p><span class="math display">\[\begin{cases}a_1x + b_1y + c_1z = d_1\\a_2x + b_2y + c_2z = d_2\\a_3x + b_3y + c_3z = d_3\\\end{cases}\]</span></p>]]></content>
    
    
    <categories>
      
      <category>Linux</category>
      
    </categories>
    
    
    <tags>
      
      <tag>editor</tag>
      
      <tag>Markdown</tag>
      
      <tag>VSCode</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>WRF | unrecognized command line option ‘-f90=gfortran’ &amp; ungrib.exe compile error</title>
    <link href="/2024/05/29/WPS_install_gfortran_error/"/>
    <url>/2024/05/29/WPS_install_gfortran_error/</url>
    
    <content type="html"><![CDATA[<h1 id="issue">Issue</h1><p>When compiling WPSv4.0/v4.2/v3.8.1</p><blockquote><p>gfortran: error: unrecognized command line option ‘-f90=gfortran’</p></blockquote><h1 id="solution">Solution</h1><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs makefile"><span class="hljs-comment"># Settings for    Linux x86_64 ppc64le, gfortran compiler with gcc   (dmpar)</span><br><span class="hljs-comment">#</span><br>DESCRIPTION     =       GNU ($SFC/$SCC)<br>DMPARALLEL      =        1<br>OMPCPP          =       <span class="hljs-comment"># -D_OPENMP</span><br>OMP             =       <span class="hljs-comment"># -fopenmp</span><br>OMPCC           =       <span class="hljs-comment"># -fopenmp</span><br>SFC             =       gfortran<br>SCC             =       gcc<br>CCOMP           =       gcc<br>DM_FC           =       mpif90 -f90=gfortran<br>DM_CC           =       mpicc -cc=<span class="hljs-variable">$(SCC)</span><br>FC              =       <span class="hljs-variable">$(DM_FC)</span><br>CC              =       <span class="hljs-variable">$(DM_CC)</span> -DFSEEKO64_OK <br>LD              =       <span class="hljs-variable">$(FC)</span><br></code></pre></td></tr></table></figure><p>modify DM_FC to</p><blockquote><p>DM_FC = mpif90</p></blockquote><p>without -f90-gfortran</p><p>Finally,</p><ol type="1"><li>geogrid.exe and metgrid.exe</li><li>link_grib.csh</li></ol><p>are generated.</p><p>But, <strong>no ungrib.exe !!!</strong></p><h2 id="error">Error</h2><blockquote><p>Error: Arguments of ‘iand’ have different kind type parameters at (1)</p></blockquote><p>References</p><ol type="1"><li><a href="https://forum.mmm.ucar.edu/threads/resolved-ungrib-exe-compile-error-arguments-of-%E2%80%98iand%E2%80%99-have-different-kind-type-parameters-at-1-ted.9409/">(RESOLVED) ungrib.exe compile error: Arguments of ‘iand’ have different kind type parameters at (1)ted</a><ul><li>To dd those two extra lines to ungrib/src/ngl/g2/intmath.f (based on <a href="https://github.com/wrf-model/WPS/pull/119" class="uri">https://github.com/wrf-model/WPS/pull/119</a>)</li></ul></li><li><a href="https://forum.mmm.ucar.edu/threads/resolved-not-generating-ungrib-exe.9367/">(RESOLVED) Not generating ungrib.exe</a></li></ol><h3 id="solution-1">Solution</h3><p><a href="https://github.com/wrf-model/WPS/pull/119/files/74eb62b1bef320b453151e1eb749dae96616da97#diff-93d876794073a0c3c81a225075d33578e88a2d946b833ba92f0bbcd3d6be9c03">Fix mismatch integer kind in IAND intrinsic calls in g2 librar</a></p><p>ungrib/src/ngl/g2/intmath.f</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs stylus">ilog2_2=<span class="hljs-number">0</span><br>i=i_in<br><span class="hljs-function"><span class="hljs-title">if</span><span class="hljs-params">(i&lt;=<span class="hljs-number">0</span>)</span></span> return<br><span class="hljs-function"><span class="hljs-title">if</span><span class="hljs-params">(iand(i,i-<span class="hljs-number">1</span>)</span></span>/=<span class="hljs-number">0</span>) then<br>   !<span class="hljs-built_in">write</span>(<span class="hljs-number">0</span>,*) <span class="hljs-string">&#x27;iand i-1&#x27;</span><br>   ilog2_2=<span class="hljs-number">1</span><br></code></pre></td></tr></table></figure><p>to <figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs stylus">      ilog2_2=<span class="hljs-number">0</span><br>      i=i_in<br>      <span class="hljs-built_in">if</span>(i&lt;=<span class="hljs-number">0</span>) return<br>! WPS modification <span class="hljs-keyword">for</span> the XL compiler<br>!      <span class="hljs-built_in">if</span>(<span class="hljs-built_in">iand</span>(<span class="hljs-selector-tag">i</span>,i-<span class="hljs-number">1</span>)/=<span class="hljs-number">0</span>) then<br>      <span class="hljs-built_in">if</span>(<span class="hljs-built_in">iand</span>(<span class="hljs-selector-tag">i</span>,i-<span class="hljs-number">1</span>_2)/=<span class="hljs-number">0</span>) then<br>         !<span class="hljs-built_in">write</span>(<span class="hljs-number">0</span>,*) <span class="hljs-string">&#x27;iand i-1&#x27;</span><br>         ilog2_2=<span class="hljs-number">1</span><br></code></pre></td></tr></table></figure> And, <figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs stylus">ilog2_1=<span class="hljs-number">0</span><br>i=i_in<br><span class="hljs-function"><span class="hljs-title">if</span><span class="hljs-params">(i&lt;=<span class="hljs-number">0</span>)</span></span> return<br><span class="hljs-function"><span class="hljs-title">if</span><span class="hljs-params">(iand(i,i-<span class="hljs-number">1</span>)</span></span>/=<span class="hljs-number">0</span>) then<br>   !<span class="hljs-built_in">write</span>(<span class="hljs-number">0</span>,*) <span class="hljs-string">&#x27;iand i-1&#x27;</span><br>   ilog2_1=<span class="hljs-number">1</span><br></code></pre></td></tr></table></figure> to <figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs stylus">      ilog2_1=<span class="hljs-number">0</span><br>      i=i_in<br>      <span class="hljs-built_in">if</span>(i&lt;=<span class="hljs-number">0</span>) return<br>! WPS modification <span class="hljs-keyword">for</span> the XL compiler<br>!      <span class="hljs-built_in">if</span>(<span class="hljs-built_in">iand</span>(<span class="hljs-selector-tag">i</span>,i-<span class="hljs-number">1</span>)/=<span class="hljs-number">0</span>) then<br>      <span class="hljs-built_in">if</span>(<span class="hljs-built_in">iand</span>(<span class="hljs-selector-tag">i</span>,i-<span class="hljs-number">1</span>_1)/=<span class="hljs-number">0</span>) then<br>         !<span class="hljs-built_in">write</span>(<span class="hljs-number">0</span>,*) <span class="hljs-string">&#x27;iand i-1&#x27;</span><br>         ilog2_1=<span class="hljs-number">1</span><br></code></pre></td></tr></table></figure></p><p><strong>Works!!!</strong></p>]]></content>
    
    
    <categories>
      
      <category>WRF</category>
      
    </categories>
    
    
    <tags>
      
      <tag>WPS</tag>
      
      <tag>Installation</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>WRF | fatal error - rpc/types.h - No such file or directory</title>
    <link href="/2024/05/29/WRF_install_landread_error/"/>
    <url>/2024/05/29/WRF_install_landread_error/</url>
    
    <content type="html"><![CDATA[<h1 id="issue">Issue</h1><p>When compiling WRFv4.0.0,</p><blockquote><p>mpicc -cc=gcc -DFSEEKO64_OK -o landread.o -c -w -O3 -c -DDM_PARALLEL -DMAX_HISTORY=25 -DNMM_CORE=0 landread.c landread.c:68:10: fatal error: rpc/types.h: No such file or directory #include &lt;rpc/types.h&gt; ^~~~~~~~~~~~~ compilation terminated. make[2]: [../configure.wrf:372: landread.o] Error 1 (ignored)</p></blockquote><h1 id="reference">Reference</h1><p><a href="https://forum.mmm.ucar.edu/threads/resolved-problem-compiling-wrfv4-0-on-fedora-28-landread-error.61/">(RESOLVED) Problem Compiling WRFV4.0 on Fedora 28: landread error</a></p><h1 id="workaround-1">Workaround 1</h1><p>We've seen a few reports of this, and it seems to be specific to particular Linux systems. We have not been able to repeat this at NCAR on our Macs, our department Linux server, or on our Linux HPC, and therefore we haven't come up with a long-term solution yet. However, a work-around would be to do the following:</p><p>Issue a ‘clean -a’ and then reconfigure. Then go into your configure.wrf file and look for the line: <figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-attr">CFLAGS</span> = $(CFLAGS_LOCAL) -DDM_PARALLEL -DSTUBMPI \<br><span class="hljs-attr">-DMAX_HISTORY</span>=$(MAX_HISTORY) -DNMM_CORE=$(WRF_NMM_CORE)<br></code></pre></td></tr></table></figure></p><p>Onto the end of that, add -DLANDREAD_STUFF, so that it now looks like: <figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-attr">CFLAGS</span> = $(CFLAGS_LOCAL) -DDM_PARALLEL -DSTUBMPI \<br><span class="hljs-attr">-DMAX_HISTORY</span>=$(MAX_HISTORY) -DNMM_CORE=$(WRF_NMM_CORE) -DLANDREAD_STUB<br></code></pre></td></tr></table></figure> Then save that configure file and recompile. This should get your past the problem. Please let us know if that works for you. Thanks!</p><h3 id="wrfv4.0.0-works">WRFv4.0.0 Works !</h3><h2 id="what-is-landread_stub">What is LANDREAD_STUB?</h2><ol type="1"><li><p>The LANDREAD_STUB option removes the ability for a moving nest to horizontally interpolate high-resolution topography and landuse fields. Very few use this option, so this is typically a safe recourse.</p></li><li><p>For those who do need the capability of a moving nest with the high-resolution static fields, if the location of types.h is not found in /usr/include, the alternative would be to look in /usr/include/tirpc.</p></li></ol><p>We can put together a github pull request, but we will need a couple of users to verify that the proposed fix still provide code that works for us and additionally works for the those that have reported the build troubles with WRF.</p><ol start="3" type="1"><li>Would you please test this pull request: <a href="https://github.com/wrf-model/WRF/pull/1072" class="uri">https://github.com/wrf-model/WRF/pull/1072</a></li></ol><h1 id="workaround-2">Workaround 2</h1><ol type="1"><li><p>I am encountering a similar issue when compiling V3.9.1.1 and the above solution does not seem to work for me.</p></li><li><p>I had to Copy landread.c.dist to landread.c in share directory for WRFV3 and that solved the issue.</p></li><li><p>Just cd share/ and do cp landread.c.dist landread.c</p></li></ol>]]></content>
    
    
    <categories>
      
      <category>WRF</category>
      
    </categories>
    
    
    <tags>
      
      <tag>WRF</tag>
      
      <tag>Installation</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>WRF | make -- time No such file or directory</title>
    <link href="/2024/05/29/WRF_install_time_error/"/>
    <url>/2024/05/29/WRF_install_time_error/</url>
    
    <content type="html"><![CDATA[<h1 id="issue">Issue</h1><p>After moving to new cluster, a error appear when I reinstalled WRF. It is</p><blockquote><p>make[3]: time: No such file or directory</p></blockquote><p>Or,</p><blockquote><p>make[3]: time: No such file or directory make[3]: [makefile:42: module_io_int_idx.o] Error 127 (ignored)</p></blockquote><p>On WRFv450, v440, v433, v430</p><h1 id="workaround">Workaround</h1><p>Reference: <a href="https://forum.mmm.ucar.edu/threads/compiling-wrf-4-2-on-centos7-failed-problems-building-executables-look-for-errors-in-the-build-log.12864/">compiling wrf 4.2 on centos7 failed---&gt;Problems building executables, look for errors in the build log</a></p><p>'time' is a simple linux command that is typically included with your operating system. I believe, ultimately, the issue is that you're using a very old version of GNU to compile a newer version of WRF. GNU is free software, so can you try to install the latest version of GNU to see if that makes any difference in your compile? If you aren't sure how to do this, seek the help of a systems administrator (IT) at your institution. Once you install the new GNU version, you'll need to rebuild NetCDF and your MPI installation with the updated GNU, as well.</p><p>If you do that, and still run into the above error regarding the 'time' command, you can try a couple things: 1) Ask a systems admin for assistance in getting this command installed on your system. 'time' is a very simple linux command and typically comes readily available with the OS. 2) You can try modifying the configure.wrf file. After issuing <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">./clean -a<br>./configure<br></code></pre></td></tr></table></figure> 3) , and reconfiguring, open your configure.wrf file and look for this line: <figure class="highlight arcade"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs arcade">FC        = <span class="hljs-built_in">time</span> $(DM_FC)<br></code></pre></td></tr></table></figure> 4) Remove 'time' from the line so that it now reads as <figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-attr">FC</span>        =  $(DM_FC)<br></code></pre></td></tr></table></figure> Save the configure.wrf with the change and try recompiling. <figure class="highlight maxima"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs maxima">./<span class="hljs-built_in">compile</span> -j <span class="hljs-number">8</span> em_real <span class="hljs-number">2</span>&gt;&amp;<span class="hljs-number">1</span> | tee <span class="hljs-built_in">compile</span>.<span class="hljs-built_in">log</span><br></code></pre></td></tr></table></figure></p><p>or</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment">#cp -r WRF-4.5.1-raw WRFV4.5.1</span><br><br><span class="hljs-built_in">cd</span> WRFV4.5.1/<br><br>./clean -a<br>./configure <br><span class="hljs-comment">##  34 (dmpar) GNU [gfortran/gcc]</span><br><br><span class="hljs-comment">## rewrite: The character class \s will match the whitespace characters &lt;tab&gt; and &lt;space&gt;.</span><br><span class="hljs-comment">## and don&#x27;t include $(DM_FC) </span><br>sed -i <span class="hljs-string">&quot;s/\s\stime\s//g&quot;</span> configure.wrf<br><span class="hljs-comment">#sed -i &quot;s/-DNMM_CORE=$(WRF_NMM_CORE)/-DNMM_CORE=$(WRF_NMM_CORE)\s-DLANDREAD_STUB/g&quot; configure.wrf</span><br><br>./compile -j 4 em_real 2&gt;&amp;1 | <span class="hljs-built_in">tee</span> compile.log<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>WRF</category>
      
    </categories>
    
    
    <tags>
      
      <tag>WRF</tag>
      
      <tag>Installation</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Conda/Micromamba</title>
    <link href="/2024/03/02/Conda_Micromamba/"/>
    <url>/2024/03/02/Conda_Micromamba/</url>
    
    <content type="html"><![CDATA[<p>The easiest way to export a .yml file from a conda environment is to first activate your environment by running: <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">conda activate myvenv<br></code></pre></td></tr></table></figure> And then run the following command that generated your .yml file: <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs sh">conda <span class="hljs-built_in">env</span> <span class="hljs-built_in">export</span> &gt; list.yml<br><br><span class="hljs-comment">## win-64 and linux-64 have different label on version/number</span><br><span class="hljs-comment">## Export Conda Environment with minimized requirements</span><br>micromamba <span class="hljs-built_in">env</span> <span class="hljs-built_in">export</span> --from-history &gt; list.yml<br><br><span class="hljs-comment">## like</span><br>name: uxarray<br>channels:<br>- anaconda<br>- conda-forge<br>dependencies:<br>- conda-forge::basemap<br>- conda-forge::cartopy<br>- anaconda::ipykernel<br>- conda-forge::netcdf4<br>- scipy<br>- conda-forge::uxarray==2024.11.1<br>- conda-forge::wrf-python<br></code></pre></td></tr></table></figure> Finally, you can create a new environment using the .yml file, like: <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">conda <span class="hljs-built_in">env</span> create --name myvenv --file=list.yml<br></code></pre></td></tr></table></figure></p><p>or <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh">conda <span class="hljs-built_in">env</span> <span class="hljs-built_in">export</span> | grep -v <span class="hljs-string">&quot;^prefix: &quot;</span> &gt; environment.yml<br>conda <span class="hljs-built_in">env</span> create -f environment.yml<br></code></pre></td></tr></table></figure></p><p>Remove environment, <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">conda remove -n ENV_NAME --all<br></code></pre></td></tr></table></figure></p><h1 id="micromamba">Micromamba</h1><p>Micromamba is a standalone version of Mamba which is an alternative to Conda. This stack delivers a custom anaconda/miniconda type deployment based on the communities conda-forge channel with micromamba as the package manager. For more information visit <a href="https://mamba.readthedocs.io/en/latest/user_guide/micromamba.html">micromamba documentation</a>.</p><h2 id="installation">Installation</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sh">wget micro.mamba.pm/install.sh<br><span class="hljs-built_in">chmod</span> +x install.sh<br>./install.sh<br></code></pre></td></tr></table></figure><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment">## Parsing arguments</span><br><span class="hljs-keyword">if</span> [ -t 0 ] ; <span class="hljs-keyword">then</span><br>  <span class="hljs-built_in">printf</span> <span class="hljs-string">&quot;Micromamba binary folder? [~/.local/bin] &quot;</span><br>  <span class="hljs-built_in">read</span> BIN_FOLDER<br>  <span class="hljs-built_in">printf</span> <span class="hljs-string">&quot;Init shell (<span class="hljs-variable">$shell</span>)? [Y/n] &quot;</span><br>  <span class="hljs-built_in">read</span> INIT_YES<br>  <span class="hljs-built_in">printf</span> <span class="hljs-string">&quot;Configure conda-forge? [Y/n] &quot;</span><br>  <span class="hljs-built_in">read</span> CONDA_FORGE_YES<br><span class="hljs-keyword">fi</span><br></code></pre></td></tr></table></figure><ul><li>/home/wpsze/.local/bin</li><li>init shell? Y</li><li>configure-forge? Y</li></ul><p>Finally, it will initalize micromambs config on .bashrc</p><h3 id="export-the-contents-of-the-existing-environment-to-a-yaml-file.">Export the contents of the existing environment to a YAML file.</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">micromamba <span class="hljs-built_in">env</span> <span class="hljs-built_in">export</span> -n oldenv &gt; oldenv.yaml<br></code></pre></td></tr></table></figure><h3 id="create-env-by-given-yaml">Create env by given yaml</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">micromamba <span class="hljs-built_in">env</span> create --name newenv --file oldenv.yaml<br></code></pre></td></tr></table></figure><h3 id="pip-requirements-file-contain-file">pip requirements file contain "<span class="citation" data-cites="file">@file</span>"</h3><ul><li><span class="citation" data-cites="file">[Why does the pip requirements file contain @file instead of version number?]</span>(https://stackoverflow.com/questions/62586878/why-does-the-pip-requirements-file-contain-file-instead-of-version-number)</li><li><a href="https://peps.python.org/pep-0440/#direct-references" class="uri">https://peps.python.org/pep-0440/#direct-references</a></li><li></li></ul><h3 id="source-and-activate-env">Source and activate env</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs sh">$ <span class="hljs-built_in">source</span> /home/wpsze/micromamba/etc/profile.d/micromamba.sh<br>$ micromamba activate venv<br><br><span class="hljs-comment">## For everyone to activate my env</span><br>$ micromamba activate /home/wpsze/micromamba/envs/mpich<br></code></pre></td></tr></table></figure><h3 id="activate-or-execute">activate or execute</h3><p>Transaction finished</p><p>To activate this environment, use:</p><pre><code class="hljs">micromamba activate venv</code></pre><p>Or to execute a single command in this environment, use:</p><pre><code class="hljs">micromamba run -n venv mycommand</code></pre><h2 id="clone-an-environment">clone an environment,</h2><p>As stated in the answer to <a href="https://stackoverflow.com/questions/76884520/cloning-environment-with-micromamba">Cloning environment with micromamba</a>, <strong>--clone</strong> is not an option in micromamba.</p><p>Instead, export the environment yaml and create a new environment using the --file flag. Then remove the old environment.</p><ol type="1"><li>export the env dependencies: micromamba env export -n oldenv &gt; oldenv.yaml</li><li>create a new env with a new name: micromamba create -n newenv --file oldenv.yaml</li><li>remove the old env: micromamba env remove -n oldenv</li><li>delete the yaml file: rm oldenv.yaml</li></ol><h2 id="checkadd-channel">check/add channel</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs sh">$ micromamba info<br><br><span class="hljs-comment"># or</span><br><br>$ micromamba config list --sources<br><br>channels:<br>  - conda-forge  <span class="hljs-comment"># &#x27;~/.condarc&#x27;</span><br><br>$ micromamba config append channels conda-forge<br></code></pre></td></tr></table></figure><h2 id="cloning-an-environment">Cloning an environment</h2><figure class="highlight console"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs console">micromamba env create --name my_clone --clone new_venv<br></code></pre></td></tr></table></figure><h1 id="to-access-the-remote-machine-with-a-browser">To access the remote machine with a browser</h1><p>To access the remote machine with a browser the notebook must listen on an external facing port <strong>(not localhost)</strong>. You will need the same invocation if want to run the Jupyter notebook on a container. In that case it is something like this:</p><figure class="highlight console"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs console">jupyter-notebook --no-browser --port 11013 --ip=0.0.0.0<br></code></pre></td></tr></table></figure><p>To listen <strong>only in localhost</strong> then you can omit the IP</p><figure class="highlight console"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs console">jupyter notebook --no-browser --port=8080<br></code></pre></td></tr></table></figure><h1 id="references">References</h1><ol type="1"><li><a href="https://hpc.pku.edu.cn/ug/guide/soft/conda/#_3">北京大学高性能计算校级公共平台用户文档</a></li></ol>]]></content>
    
    
    <categories>
      
      <category>Linux</category>
      
    </categories>
    
    
    <tags>
      
      <tag>conda</tag>
      
      <tag>Micromamba</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>bashrc</title>
    <link href="/2024/03/02/bashrc/"/>
    <url>/2024/03/02/bashrc/</url>
    
    <content type="html"><![CDATA[<p>If you spend a lot of time on the command line, chances are that you’ll want to customize your shell environment. This can mean creating aliases, adding a new directory to the <strong>$PATH</strong> , or changing the look of the shell prompt.</p><p>You may have come across some tutorials where they say to put your configuration either in the <strong>.bashrc</strong>, <strong>.bash_profile</strong> or another configuration file that is read and executed by the bash shell.</p><h1 id="bash-startup-files">Bash Startup Files</h1><p>When invoked as an interactive login shell, Bash looks for the <strong>/etc/profile</strong> file, and if the file exists , it runs the commands listed in the file. Then Bash searches for <strong><sub>/.bash_profile<strong>, </strong></sub>/.bash_login</strong>, and <strong>~/.profile</strong> files, in the listed order, and executes commands from the first readable file found.</p><p>When Bash is invoked as an <em>interactive non-login shell</em>, it reads and executes commands from <strong>~/.bashrc</strong>, if that file exists, and it is readable.</p><h2 id="difference-between-.bashrc-and-.bash_profile">Difference Between .bashrc and .bash_profile</h2><p><strong>.bash_profile</strong> is read and executed when Bash is invoked as an interactive login shell, while <strong>.bashrc</strong> is executed for an interactive non-login shell.</p><p>Use <strong>.bash_profile</strong> to run commands that should run only once, such as customizing the <strong>$PATH</strong> environment variable .</p><p>Put the commands that should run every time you launch a new shell in the <strong>.bashrc</strong> file. This include your aliases and functions , custom prompts, history customizations , and so on.</p><blockquote><p>Typically, ~/.bash_profile contains lines like below that source the .bashrc file. This means each time you log in to the terminal, both files are read and executed.</p></blockquote><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-keyword">if</span> [ -f ~/.bashrc ]; <span class="hljs-keyword">then</span><br>. ~/.bashrc<br><span class="hljs-keyword">fi</span><br></code></pre></td></tr></table></figure><h2 id="profile-and-.bash_profile">~/.profile and ~/.bash_profile</h2><p>Most Linux distributions are using <strong>~/.profile</strong> instead of <strong><sub>/.bash_profile<strong>. The </strong></sub>/.profile</strong> file is read by <em>all shells</em>, while <strong>~/.bash_profile</strong> <em>only by Bash</em>.</p><p>If any startup file is not present on your system, you can create it.</p><h1 id="more">More</h1><h2 id="profile">profile</h2><p>profile，路徑：/etc/profile，用於設定係統級的環境變數和啟動程序，在此文件下配置對所有使用者生效。 當登入使用者（login）時，檔案會被執行，並從/etc/profile.d目錄的設定檔中找到shell設定。</p><h2 id="bash_profile">bash_profile</h2><p>bash_profile只對單一使用者有效，檔案儲存位於~/.bash_profile，該檔案是一個使用者層級的設置，可以理解為某個使用者的設定檔目錄下。</p><p>該文件也可以用於配置環境變數和啟動程序，但僅針對單一使用者有效。</p><p>和 profile 檔案類似，bash_profile 也可以在使用者登入（login）時生效，也可以用來設定環境變數。</p><p>但與 profile 不同，bash_profile 只能對目前使用者生效。</p><p>#BASH Alias BASH Alias is a shortcut to run commands using some mapping. It is a way to create some shortcut commands for repetitive and multiple tasks. We create an alias in a BASH environment in specified files. We can also incorporate BASH functions, variables, etc to make the Alias more programmatic and flexible.</p>]]></content>
    
    
    <categories>
      
      <category>Linux</category>
      
    </categories>
    
    
    <tags>
      
      <tag>bashrc</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>vim</title>
    <link href="/2023/10/20/vim/"/>
    <url>/2023/10/20/vim/</url>
    
    <content type="html"><![CDATA[<h1 id="vimrc-setup">.vimrc setup</h1><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-built_in">set</span> showmode<br><span class="hljs-built_in">set</span> encoding=utf-8 <br><span class="hljs-built_in">set</span> t_Co=256<br><span class="hljs-built_in">set</span> tabstop=4<br><span class="hljs-built_in">set</span> shiftwidth=4<br><span class="hljs-built_in">set</span> expandtab<br><br><span class="hljs-built_in">set</span> nolist<br><br><span class="hljs-built_in">set</span> number<br><br><span class="hljs-built_in">set</span> <span class="hljs-built_in">paste</span><br><br><span class="hljs-built_in">set</span> showmatch<br><br>autocmd BufNewFile *.py,*.sh <span class="hljs-built_in">exec</span> <span class="hljs-string">&quot;:call SetTitle()&quot;</span><br><br>func SetTitle()<br><span class="hljs-keyword">if</span> <span class="hljs-built_in">expand</span>(<span class="hljs-string">&quot;%:e&quot;</span>) == <span class="hljs-string">&#x27;sh&#x27;</span><br>    call setline(1,<span class="hljs-string">&quot;#!/bin/bash&quot;</span>)<br>elseif <span class="hljs-built_in">expand</span>(<span class="hljs-string">&quot;%:e&quot;</span>) == <span class="hljs-string">&#x27;py&#x27;</span><br>    call setline(1,<span class="hljs-string">&quot;#!/bin/python&quot;</span>)<br>endif<br><br>call setline(2,<span class="hljs-string">&quot;&quot;</span>)<br>call setline(3,<span class="hljs-string">&quot;#------------------------------------------------#&quot;</span>)<br>call setline(4,<span class="hljs-string">&quot;#Author:         wpsze&quot;</span>)<br>call setline(5,<span class="hljs-string">&quot;#Email：         wpsze@gmail.com&quot;</span>)<br>call setline(6,<span class="hljs-string">&quot;#date:           &quot;</span>.strftime(<span class="hljs-string">&quot;%Y-%m-%d %H:%M:%S&quot;</span>))<br>call setline(7,<span class="hljs-string">&quot;#Version:        0.0 &quot;</span>)<br>call setline(8,<span class="hljs-string">&quot;#Description:    The purpose of the script&quot;</span>)<br>call setline(9,<span class="hljs-string">&quot;#Copyright (C)： &quot;</span>.strftime(<span class="hljs-string">&quot;%Y&quot;</span>).<span class="hljs-string">&quot; All rights reserved&quot;</span>)<br>call setline(10,<span class="hljs-string">&quot;#------------------------------------------------#&quot;</span>)<br>call setline(11,<span class="hljs-string">&quot;&quot;</span>)<br>call setline(12,<span class="hljs-string">&quot;&quot;</span>)<br><br><span class="hljs-keyword">if</span> <span class="hljs-built_in">expand</span>(<span class="hljs-string">&quot;%:e&quot;</span>) == <span class="hljs-string">&#x27;sh&#x27;</span><br>    call setline(14, <span class="hljs-string">&quot;#source /home/wpsze/anaconda3/bin/activate venv&quot;</span>)<br>    call setline(16, <span class="hljs-string">&quot;export SCRIPT_DIR=\x22<span class="hljs-subst">$( cd \x22$( dirname \x22$&#123;BASH_SOURCE[0]&#125;\x22 )</span>\x22 &gt;/dev/null 2&gt;&amp;1 &amp;&amp; pwd )\x22&quot;</span>)<br>endif<br><br>endfunc<br><br>autocmd BufNewFile * normal G<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>Linux</category>
      
    </categories>
    
    
    <tags>
      
      <tag>HPC</tag>
      
      <tag>vim</tag>
      
      <tag>editor</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>HKO station and analysis</title>
    <link href="/2023/06/24/HKO-station-and-analysis/"/>
    <url>/2023/06/24/HKO-station-and-analysis/</url>
    
    <content type="html"><![CDATA[<h1 id="download-hko-weather-dataset">Download HKO weather dataset</h1><p>From <a href="https://i-lens.hk/hkweather/">i-lens.hk 香港自動氣象站氣候觀測資料庫</a> <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-built_in">export</span> yyyy=2023<br><span class="hljs-built_in">export</span> mm=04<br><br><span class="hljs-keyword">for</span> <span class="hljs-built_in">dd</span> <span class="hljs-keyword">in</span> &#123;14..16&#125;; <span class="hljs-keyword">do</span><br>    wget http://i-lens.hk/hkweather/history_minute_record/<span class="hljs-variable">$&#123;yyyy&#125;</span>/<span class="hljs-variable">$&#123;yyyy&#125;</span><span class="hljs-variable">$&#123;mm&#125;</span><span class="hljs-variable">$&#123;dd&#125;</span>.zip ;<br>    <span class="hljs-built_in">echo</span> $mm<span class="hljs-variable">$dd</span> sleeping now ;<br>    <span class="hljs-comment">#mkdir -p $yyyy</span><br>    <span class="hljs-comment">#mv $&#123;yyyy&#125;$&#123;mm&#125;$&#123;dd&#125;* ./$&#123;yyyy&#125; ;</span><br>    <span class="hljs-comment">#sleep $((80 + RANDOM % 21)) ;</span><br><span class="hljs-keyword">done</span><br></code></pre></td></tr></table></figure> Subsequently, extract those elements.</p><h1 id="list-of-hko-station">List of HKO station</h1><p>As part of the HKO stations, the majority of the names I use align with the definitions provided by HKO. However, there are a few instances where I have personally assigned names to certain elements.</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs sh">ID,lat,lon,station,station_en,station_ch<br>1,22.301944,114.174167,hko,HKO (Tsim Sha Tsui),香港天文台<br>2,22.201111,114.026667,cch,Cheung Chau,長洲<br>3,22.263389,114.299769,cwb,Clear water bay,清水灣<br>4,22.309444,113.921944,hka,HK Airport,香港國際機場<br>5,22.278333,114.162222,hkp,Hong Kong Park,香港公園<br>6,22.247778,114.173611,hks,Wong Chuk Hang,黃竹坑<br>7,22.270556,114.183611,hpv,Happy Valley,跑馬地<br>8,22.315833,114.255556,jkb,Tseung Kwan O,將軍澳<br>9,22.335000,114.184722,klt,Kowloon City,九龍城<br>10,22.311944,114.172778,kp,King’s Park,京士柏<br>11,22.370278,114.312500,ksc,Kau Sai Chau,滘西洲<br>12,22.318611,114.224722,ktg,Kwun Tong,觀塘<br>13,22.468889,113.983611,lfs,Lau Fau Shan,流浮山<br>14,22.258611,113.912778,ngp,Ngong Ping,昂坪<br>15,22.291111,114.043333,pen,Peng Chau,坪洲<br>16,22.475278,114.237500,plc,Tai Mei Tuk,大美督<br>17,22.304722,114.217222,se1,Kai Tak Runway Park,啟德跑道公園<br>18,22.436111,114.084722,sek,Shek Kong,石崗<br>19,22.402500,114.210000,sha,Sha Tin,沙田<br>20,22.375556,114.274444,skg,Sai Kung,西貢<br>21,22.281667,114.236111,skw,Shau Kei Wan,筲箕灣<br>22,22.501944,114.111111,ssh,Sheung Shui,上水<br>23,22.335833,114.136944,ssp,Sham Shui Po,深水埗<br>24,22.214167,114.218611,sty,Stanley,赤柱<br>25,22.357778,114.217778,tc,Tate<span class="hljs-string">&#x27;s Cairn,大老山</span><br><span class="hljs-string">26,22.528611,114.156667,tkl,Ta Kwu Ling,打鼓嶺</span><br><span class="hljs-string">27,22.483480,114.117400,tl,Tai Lung,大隴</span><br><span class="hljs-string">28,22.410556,114.124444,tms,Tai Mo Shan,大帽山</span><br><span class="hljs-string">29,22.446111,114.178889,tpo,Tai Po,大埔</span><br><span class="hljs-string">30,22.385833,113.964167,tu1,Tuen Mun Children and Juvenile Home,屯門兒童及青少年院</span><br><span class="hljs-string">31,22.375556,114.126667,tw,Shing Mun Valley,荃灣城門谷</span><br><span class="hljs-string">32,22.383611,114.107778,twn,Tsuen Wan,荃灣</span><br><span class="hljs-string">33,22.344167,114.110000,ty1,Tsing Yi Station,新青衣站</span><br><span class="hljs-string">34,22.402778,114.323056,tyw,Pak Tam Chung,北潭涌(鯽魚湖)</span><br><span class="hljs-string">35,22.264167,114.155000,vp1,The Peak,山頂</span><br><span class="hljs-string">36,22.182222,114.303333,wgl,Waglan Island,橫瀾島</span><br><span class="hljs-string">37,22.466667,114.008889,wlp,Wetland Park,濕地公園</span><br><span class="hljs-string">38,22.339444,114.205278,wts,Wong Tai Sin,黃大仙</span><br><span class="hljs-string">39,22.440833,114.018333,ylp,ylp,ylp</span><br></code></pre></td></tr></table></figure><h1 id="jupter-notebook-or-python">Jupter Notebook or python</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/env python</span><br><span class="hljs-comment"># coding: utf-8</span><br><br><span class="hljs-comment"># In[1]:</span><br><br><br><span class="hljs-keyword">import</span> glob, os<br><span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np<br><span class="hljs-keyword">import</span> xarray <span class="hljs-keyword">as</span> xr<br><span class="hljs-keyword">import</span> pandas <span class="hljs-keyword">as</span> pd<br><span class="hljs-keyword">from</span> datetime <span class="hljs-keyword">import</span> timedelta<br><br><span class="hljs-keyword">import</span> matplotlib.pyplot <span class="hljs-keyword">as</span> plt<br><span class="hljs-keyword">from</span> matplotlib <span class="hljs-keyword">import</span> cm<br>SMALL_SIZE = <span class="hljs-number">8</span><br>MEDIUM_SIZE = <span class="hljs-number">10</span><br>BIGGER_SIZE = <span class="hljs-number">24</span><br><br>plt.rcParams[<span class="hljs-string">&quot;figure.figsize&quot;</span>] = (<span class="hljs-number">10</span>,<span class="hljs-number">8</span>)<br>plt.rc(<span class="hljs-string">&#x27;font&#x27;</span>, size=BIGGER_SIZE)          <span class="hljs-comment"># controls default text sizes</span><br>plt.rc(<span class="hljs-string">&#x27;axes&#x27;</span>, titlesize=BIGGER_SIZE)     <span class="hljs-comment"># fontsize of the axes title</span><br>plt.rc(<span class="hljs-string">&#x27;axes&#x27;</span>, labelsize=BIGGER_SIZE)    <span class="hljs-comment"># fontsize of the x and y labels</span><br>plt.rc(<span class="hljs-string">&#x27;xtick&#x27;</span>, labelsize=BIGGER_SIZE)    <span class="hljs-comment"># fontsize of the tick labels</span><br>plt.rc(<span class="hljs-string">&#x27;ytick&#x27;</span>, labelsize=BIGGER_SIZE)    <span class="hljs-comment"># fontsize of the tick labels</span><br>plt.rc(<span class="hljs-string">&#x27;legend&#x27;</span>, fontsize=BIGGER_SIZE)    <span class="hljs-comment"># legend fontsize</span><br>plt.rc(<span class="hljs-string">&#x27;figure&#x27;</span>, titlesize=BIGGER_SIZE)  <span class="hljs-comment"># fontsize of the figure title</span><br><br><span class="hljs-comment"># plt.rcParams[&#x27;font.sans-serif&#x27;] = [&#x27;SimHei&#x27;] </span><br><span class="hljs-comment"># plt.rcParams[&#x27;axes.unicode_minus&#x27;] = False</span><br><br>plt.rcParams.update(&#123;<span class="hljs-string">&#x27;font.family&#x27;</span>:<span class="hljs-string">&#x27;sans-serif&#x27;</span>&#125;)<br>plt.rcParams[<span class="hljs-string">&#x27;font.sans-serif&#x27;</span>] = [<span class="hljs-string">&#x27;DejaVu Sans&#x27;</span>]<br><br><span class="hljs-comment"># from IPython.core.interactiveshell import InteractiveShell</span><br><span class="hljs-comment"># InteractiveShell.ast_node_interactivity = &quot;all&quot;</span><br><br><br><span class="hljs-comment"># # Reading all dataset</span><br><br><span class="hljs-comment"># In[2]:</span><br><br><br>select_year = <span class="hljs-string">&quot;202304&quot;</span><br><br>station = pd.read_csv(<span class="hljs-string">r&#x27;./HKO-station.csv&#x27;</span>, header=<span class="hljs-number">0</span>) <span class="hljs-comment"># nearwater or inland</span><br>select_num = <span class="hljs-number">7</span><br><span class="hljs-comment">#======================================== station =============================================</span><br>select_station = station[<span class="hljs-string">&quot;station&quot;</span>][select_num]<br>select_station_en = station[<span class="hljs-string">&quot;station_en&quot;</span>][select_num]<br>select_station_ch = station[<span class="hljs-string">&quot;station_ch&quot;</span>][select_num]<br>file_name_t2m = select_station+<span class="hljs-string">&quot;_&quot;</span>+select_year<br>file_name_wind = select_station+<span class="hljs-string">&quot;_wd_&quot;</span>+select_year<br>file_name_pressure = select_station+<span class="hljs-string">&quot;_pre_&quot;</span>+select_year<br><span class="hljs-built_in">print</span>(select_num, select_station, select_station_en, select_station_ch)<br>station<br><br><br><span class="hljs-comment"># In[3]:</span><br><br><br><span class="hljs-comment">#========================================= mpas ================================================</span><br>mpas_station_extraction_dir=<span class="hljs-string">&quot;/xxx/xxx/station_xxxx.csv&quot;</span><br>df_mpas = pd.read_csv(mpas_station_extraction_dir)<br><span class="hljs-comment"># .dt.tz_localize(None): to remove timezone from a Timestamp column in a pandas dataframe</span><br>df_mpas[<span class="hljs-string">&quot;Date(UTC)&quot;</span>] = pd.to_datetime(df_mpas[<span class="hljs-string">&quot;xtime[UTC]&quot;</span>], utc=<span class="hljs-string">&quot;false&quot;</span>).dt.tz_localize(<span class="hljs-literal">None</span>)<br>df_mpas[<span class="hljs-string">&quot;Date(HKT)&quot;</span>] = df_mpas[<span class="hljs-string">&quot;Date(UTC)&quot;</span>] + timedelta(hours=<span class="hljs-number">8</span>)<br><br>df_select_mpas = df_mpas[df_mpas[<span class="hljs-string">&quot;station&quot;</span>] == select_station]<br>df_select_mpas = df_select_mpas.reset_index(drop = <span class="hljs-literal">True</span>)<br><br><span class="hljs-comment">#=========================================== HKO t2m ==============================================</span><br>obs_file = []<br><span class="hljs-keyword">for</span> file <span class="hljs-keyword">in</span> glob.glob(<span class="hljs-string">f&quot;/home/wpsze/hk_data/<span class="hljs-subst">&#123;select_year&#125;</span>*/<span class="hljs-subst">&#123;file_name_t2m&#125;</span>*&quot;</span>):<br>    obs_file.append(file)<br><span class="hljs-built_in">print</span>(obs_file)<br>df = pd.concat((pd.read_csv(f, header = <span class="hljs-number">0</span>, na_values=[<span class="hljs-string">&#x27;nan&#x27;</span>], keep_default_na=<span class="hljs-literal">True</span>) <span class="hljs-keyword">for</span> f <span class="hljs-keyword">in</span> obs_file))<br>df_hko_obs = df.drop_duplicates()<br>df_hko_obs = df_hko_obs.reset_index(drop = <span class="hljs-literal">True</span>)<br><br>df_hko_obs[<span class="hljs-string">&quot;Date(HKT)&quot;</span>] = pd.to_datetime(df_hko_obs[<span class="hljs-string">&quot;Date&quot;</span>]) <br>df_hko_obs[<span class="hljs-string">&quot;Date(UTC)&quot;</span>] = df_hko_obs[<span class="hljs-string">&quot;Date(HKT)&quot;</span>] + timedelta(hours=-<span class="hljs-number">8</span>)<br>df_hko_obs = df_hko_obs.reset_index(drop = <span class="hljs-literal">True</span>)<br>df_hko_obs<br><span class="hljs-comment">#=========================================================================================</span><br>df_combine = pd.merge(df_select_mpas, df_hko_obs)<br><span class="hljs-comment">#=========================================== HKO wind ==============================================</span><br>obs_file = []<br><span class="hljs-keyword">for</span> file <span class="hljs-keyword">in</span> glob.glob(<span class="hljs-string">f&quot;/home/home/wpsze/hk_data/<span class="hljs-subst">&#123;select_year&#125;</span>*/<span class="hljs-subst">&#123;file_name_wind&#125;</span>*&quot;</span>):<br>    obs_file.append(file)<br><span class="hljs-built_in">print</span>(obs_file)<br>df = pd.concat((pd.read_csv(f, header = <span class="hljs-number">0</span>, na_values=[<span class="hljs-string">&#x27;nan&#x27;</span>], keep_default_na=<span class="hljs-literal">True</span>) <span class="hljs-keyword">for</span> f <span class="hljs-keyword">in</span> obs_file))<br>df_hko_obs = df.drop_duplicates()<br>df_hko_obs = df_hko_obs.reset_index(drop = <span class="hljs-literal">True</span>)<br>df_hko_obs<br><br>df_hko_obs[<span class="hljs-string">&quot;Date(HKT)&quot;</span>] = pd.to_datetime(df_hko_obs[<span class="hljs-string">&quot;Date&quot;</span>]) <br>df_hko_obs[<span class="hljs-string">&quot;Date(UTC)&quot;</span>] = df_hko_obs[<span class="hljs-string">&quot;Date(HKT)&quot;</span>] + timedelta(hours=-<span class="hljs-number">8</span>)<br>df_hko_obs[<span class="hljs-string">&quot;obs-wspd[m/s]&quot;</span>] = df_hko_obs[<span class="hljs-string">&quot;Wind Spd&quot;</span>]*<span class="hljs-number">0.514444444</span> <span class="hljs-comment"># knt to m/s</span><br>df_hko_obs[<span class="hljs-string">&quot;obs-wdir[deg]&quot;</span>] = df_hko_obs[<span class="hljs-string">&quot; Wind Dir&quot;</span>]<br>df_hko_obs = df_hko_obs.reset_index(drop = <span class="hljs-literal">True</span>)<br>df_hko_obs<br><span class="hljs-comment">#=========================================================================================</span><br>df_combine = pd.merge(df_combine, df_hko_obs)<br><span class="hljs-comment">#=========================================================================================</span><br>spin_up_period = <span class="hljs-number">72</span><br>df_combine_skip_spinup = df_combine[spin_up_period:]<br>df_combine_skip_spinup = df_combine_skip_spinup.reset_index(drop = <span class="hljs-literal">True</span>)<br>df_combine_skip_spinup<br><br><br><span class="hljs-comment"># In[4]:</span><br><br><br>df_combine_final = df_combine_skip_spinup[df_combine_skip_spinup[<span class="hljs-string">&quot;obs-wspd[m/s]&quot;</span>]&lt;<span class="hljs-number">100</span>] <br>df_combine_final = df_combine_final.reset_index(drop = <span class="hljs-literal">True</span>)<br>df_combine_final<br><br><br><span class="hljs-comment"># # For t2m</span><br><br><span class="hljs-comment"># In[33]:</span><br><br><br>plt.plot(df_combine_final[<span class="hljs-string">&quot;Date(HKT)&quot;</span>], df_combine_final[<span class="hljs-string">&quot;Temp&quot;</span>], <span class="hljs-string">&#x27;ko-&#x27;</span>, label=<span class="hljs-string">&quot;Obs&quot;</span>)<br>plt.plot(df_combine_final[<span class="hljs-string">&quot;Date(HKT)&quot;</span>], df_combine_final[<span class="hljs-string">&quot;t2m[degC]&quot;</span>],<span class="hljs-string">&#x27;bo-&#x27;</span>, label=<span class="hljs-string">&quot;mpas&quot;</span>)<br>plt.grid(zorder=<span class="hljs-number">0</span>)<br>plt.xlabel(<span class="hljs-string">&quot;Date Time (HKT)&quot;</span>)<br>plt.ylabel(<span class="hljs-string">&quot;T2m [deg C]&quot;</span>)<br>plt.title(select_station_en)<br>plt.xticks(rotation=<span class="hljs-number">45</span>)<br>plt.legend()<br>plt.tight_layout()<br>plt.show()<br>plt.close()<br><br><span class="hljs-comment"># df_combine_final[&quot;Temp&quot;]</span><br><br><br><span class="hljs-comment"># # For wind speed</span><br><br><span class="hljs-comment"># In[6]:</span><br><br><br>plt.plot(df_combine_final[<span class="hljs-string">&quot;Date(HKT)&quot;</span>], df_combine_final[<span class="hljs-string">&quot;Temp&quot;</span>], <span class="hljs-string">&#x27;ko-&#x27;</span>, label=<span class="hljs-string">&quot;Obs&quot;</span>)<br>plt.plot(df_combine_final[<span class="hljs-string">&quot;Date(HKT)&quot;</span>], df_combine_final[<span class="hljs-string">&quot;t2m[degC]&quot;</span>],<span class="hljs-string">&#x27;bo-&#x27;</span>, label=<span class="hljs-string">&quot;mpas&quot;</span>)<br>plt.grid(zorder=<span class="hljs-number">0</span>)<br>plt.xlabel(<span class="hljs-string">&quot;Date Time (HKT)&quot;</span>)<br>plt.ylabel(<span class="hljs-string">&quot;T2m [deg C]&quot;</span>)<br>plt.title(select_station_en)<br>plt.xticks(rotation=<span class="hljs-number">45</span>)<br>plt.legend()<br>plt.show()<br>plt.close()<br><br><br><span class="hljs-comment"># In[7]:</span><br><br><br><span class="hljs-comment">#=========================================================</span><br><br>hko_wind = df_combine_final[<span class="hljs-string">&quot;obs-wspd[m/s]&quot;</span>]<br>hko_wdir = df_combine_final[<span class="hljs-string">&quot;obs-wdir[deg]&quot;</span>]<br><br>size = hko_wdir.shape[<span class="hljs-number">0</span>]<br><br>wspd = hko_wind*<span class="hljs-number">1.9438452</span>    <span class="hljs-comment"># m/s to kt</span><br>wdir = hko_wdir*<span class="hljs-number">0.0174532925</span> <span class="hljs-comment"># deg to rad</span><br>U_obs = -wspd*np.sin(wdir)<br>V_obs = -wspd*np.cos(wdir)<br><br>df = pd.DataFrame(np.vstack([U_obs,V_obs]).T, columns=[<span class="hljs-string">&#x27;U&#x27;</span>, <span class="hljs-string">&#x27;V&#x27;</span>])<br><br><span class="hljs-comment">#=========================================================</span><br>mpas_wind = df_combine_final[<span class="hljs-string">&quot;wspd[m/s]&quot;</span>]<br>mpas_wdir = df_combine_final[<span class="hljs-string">&quot;wdir[deg]&quot;</span>]<br><br>wspd = mpas_wind*<span class="hljs-number">1.9438452</span>    <span class="hljs-comment"># m/s to kt</span><br>wdir = mpas_wdir*<span class="hljs-number">0.0174532925</span> <span class="hljs-comment"># deg to rad</span><br>U_mpas = -wspd*np.sin(wdir)<br>V_mpas = -wspd*np.cos(wdir)<br><br>df_mpas = pd.DataFrame(np.vstack([U_mpas,V_mpas]).T, columns=[<span class="hljs-string">&#x27;U&#x27;</span>, <span class="hljs-string">&#x27;V&#x27;</span>])<br><br><span class="hljs-comment">#=========================================================</span><br><br>fig, ax = plt.subplots(<span class="hljs-number">1</span>,<span class="hljs-number">1</span>, figsize=(<span class="hljs-number">15</span>,<span class="hljs-number">4</span>))<br><br><span class="hljs-comment"># ax.plot(df.index.values.astype(&#x27;d&#x27;), df.V * 0.1 + 4, color=&#x27;k&#x27;)</span><br><span class="hljs-comment"># ax.quiver(df.index.values.astype(&#x27;d&#x27;), np.ones(size) * 2, df.U.values, df.V.values) #, pivot=&#x27;mid&#x27;)</span><br><br>plt.barbs(df_combine_final[<span class="hljs-string">&quot;Date(HKT)&quot;</span>], np.ones(size) * <span class="hljs-number">4</span>, df.U.values, df.V.values, length=<span class="hljs-number">8</span>, barbcolor=<span class="hljs-string">&#x27;k&#x27;</span>)<br><br>plt.barbs(df_combine_final[<span class="hljs-string">&quot;Date(HKT)&quot;</span>], np.ones(size) * <span class="hljs-number">2</span>, df_mpas.U.values, df_mpas.V.values, length=<span class="hljs-number">8</span>, barbcolor=<span class="hljs-string">&#x27;b&#x27;</span>)<br><br>ax.set_ylim([-<span class="hljs-number">1</span>,<span class="hljs-number">6</span>])<br>plt.xticks(rotation=<span class="hljs-number">45</span>)<br>plt.xlabel(<span class="hljs-string">&quot;Date Time (HKT)&quot;</span>)<br>plt.title(select_station_en)<br>plt.xticks(rotation=<span class="hljs-number">45</span>)<br><span class="hljs-comment"># plt.legend()</span><br>plt.show()<br>plt.close()<br><br><br><span class="hljs-comment"># In[8]:</span><br><br><br>fig, ax = plt.subplots(<span class="hljs-number">1</span>,<span class="hljs-number">1</span>, figsize=(<span class="hljs-number">15</span>,<span class="hljs-number">8</span>))<br><br>plt.plot(df_combine_final[<span class="hljs-string">&quot;Date(HKT)&quot;</span>], df_combine_final[<span class="hljs-string">&quot;obs-wspd[m/s]&quot;</span>], <span class="hljs-string">&#x27;ko-&#x27;</span>, label=<span class="hljs-string">&quot;Obs&quot;</span>)<br>plt.plot(df_combine_final[<span class="hljs-string">&quot;Date(HKT)&quot;</span>], df_combine_final[<span class="hljs-string">&quot;wspd[m/s]&quot;</span>],<span class="hljs-string">&#x27;ro-&#x27;</span>, label=<span class="hljs-string">&quot;mpas&quot;</span>)<br><br>plt.barbs(df_combine_final[<span class="hljs-string">&quot;Date(HKT)&quot;</span>], np.ones(size) * -<span class="hljs-number">2</span>, df.U.values, df.V.values, length=<span class="hljs-number">8</span>, barbcolor=<span class="hljs-string">&#x27;k&#x27;</span>)<br><br>plt.barbs(df_combine_final[<span class="hljs-string">&quot;Date(HKT)&quot;</span>], np.ones(size) * -<span class="hljs-number">5</span>, df_mpas.U.values, df_mpas.V.values, length=<span class="hljs-number">8</span>, barbcolor=<span class="hljs-string">&#x27;r&#x27;</span>)<br><br>plt.grid(zorder=<span class="hljs-number">0</span>)<br>plt.xlabel(<span class="hljs-string">&quot;Date Time (HKT)&quot;</span>)<br>plt.ylabel(<span class="hljs-string">&quot;Wind Speed [m/s]&quot;</span>)<br>plt.title(select_station_en)<br>plt.xticks(rotation=<span class="hljs-number">45</span>)<br>plt.ylim([-<span class="hljs-number">7</span>,<span class="hljs-number">12</span>])<br>plt.axhline(y=<span class="hljs-number">0.0</span>, color=<span class="hljs-string">&#x27;k&#x27;</span>, linestyle=<span class="hljs-string">&#x27;-&#x27;</span>)<br>plt.legend()<br>plt.show()<br>plt.close() <br><br><br><span class="hljs-comment"># ## Seperate u and v directions</span><br><span class="hljs-comment"># </span><br><span class="hljs-comment"># U_obs = -wspd x np.sin(wdir)\</span><br><span class="hljs-comment"># V_obs = -wspd x np.cos(wdir)</span><br><br><span class="hljs-comment"># In[9]:</span><br><br><br>fig, ax = plt.subplots(<span class="hljs-number">1</span>,<span class="hljs-number">1</span>, figsize=(<span class="hljs-number">15</span>,<span class="hljs-number">8</span>))<br><br>kt2ms = <span class="hljs-number">0.514444444</span><br><br>plt.plot(df_combine_final[<span class="hljs-string">&quot;Date(HKT)&quot;</span>], U_obs*kt2ms, <span class="hljs-string">&#x27;ko-&#x27;</span>, label=<span class="hljs-string">&quot;Obs&quot;</span>)<br>plt.plot(df_combine_final[<span class="hljs-string">&quot;Date(HKT)&quot;</span>], U_mpas*kt2ms,<span class="hljs-string">&#x27;ro-&#x27;</span>, label=<span class="hljs-string">&quot;mpas&quot;</span>)<br><br>plt.grid(zorder=<span class="hljs-number">0</span>)<br>plt.xlabel(<span class="hljs-string">&quot;Date Time (HKT)&quot;</span>)<br>plt.ylabel(<span class="hljs-string">&quot;U Wind Speed [m/s]&quot;</span>)<br>plt.title(select_station_en)<br>plt.xticks(rotation=<span class="hljs-number">45</span>)<br><span class="hljs-comment"># plt.ylim([-7,10])</span><br>plt.axhline(y=<span class="hljs-number">0.0</span>, color=<span class="hljs-string">&#x27;k&#x27;</span>, linestyle=<span class="hljs-string">&#x27;-&#x27;</span>)<br>plt.legend()<br>plt.show()<br>plt.close() <br><br>fig, ax = plt.subplots(<span class="hljs-number">1</span>,<span class="hljs-number">1</span>, figsize=(<span class="hljs-number">15</span>,<span class="hljs-number">8</span>))<br><br>plt.plot(df_combine_final[<span class="hljs-string">&quot;Date(HKT)&quot;</span>], V_obs*kt2ms, <span class="hljs-string">&#x27;ko-&#x27;</span>, label=<span class="hljs-string">&quot;Obs&quot;</span>)<br>plt.plot(df_combine_final[<span class="hljs-string">&quot;Date(HKT)&quot;</span>], V_mpas*kt2ms,<span class="hljs-string">&#x27;ro-&#x27;</span>, label=<span class="hljs-string">&quot;mpas&quot;</span>)<br><br>plt.grid(zorder=<span class="hljs-number">0</span>)<br>plt.xlabel(<span class="hljs-string">&quot;Date Time (HKT)&quot;</span>)<br>plt.ylabel(<span class="hljs-string">&quot;V Wind Speed [m/s]&quot;</span>)<br>plt.title(select_station_en)<br>plt.xticks(rotation=<span class="hljs-number">45</span>)<br><span class="hljs-comment"># plt.ylim([-7,10])</span><br>plt.axhline(y=<span class="hljs-number">0.0</span>, color=<span class="hljs-string">&#x27;k&#x27;</span>, linestyle=<span class="hljs-string">&#x27;-&#x27;</span>)<br>plt.legend()<br>plt.show()<br>plt.close() <br><br><br><span class="hljs-comment"># # Final Plot</span><br><br><span class="hljs-comment"># In[26]:</span><br><br><br>fig = plt.subplots(<span class="hljs-number">2</span>, <span class="hljs-number">2</span>, figsize=(<span class="hljs-number">20</span>,<span class="hljs-number">12</span>))<br><br>ax = plt.subplot(<span class="hljs-number">221</span>)<br>plt.plot(df_combine_final[<span class="hljs-string">&quot;Date(HKT)&quot;</span>], df_combine_final[<span class="hljs-string">&quot;Temp&quot;</span>], <span class="hljs-string">&#x27;ko-&#x27;</span>, label=<span class="hljs-string">&quot;Obs&quot;</span>)<br>plt.plot(df_combine_final[<span class="hljs-string">&quot;Date(HKT)&quot;</span>], df_combine_final[<span class="hljs-string">&quot;t2m[degC]&quot;</span>],<span class="hljs-string">&#x27;ro-&#x27;</span>, label=<span class="hljs-string">&quot;mpas&quot;</span>)<br>plt.grid(zorder=<span class="hljs-number">0</span>)<br>plt.xlabel(<span class="hljs-string">&quot;Date Time (HKT)&quot;</span>)<br>plt.ylabel(<span class="hljs-string">&quot;T2m [deg C]&quot;</span>)<br>plt.title(select_station_en)<br>plt.xticks(rotation=<span class="hljs-number">45</span>)<br>plt.legend()<br>plt.tight_layout()<br><br>ax = plt.subplot(<span class="hljs-number">222</span>)<br>plt.plot(df_combine_final[<span class="hljs-string">&quot;Date(HKT)&quot;</span>], df_combine_final[<span class="hljs-string">&quot;obs-wspd[m/s]&quot;</span>], <span class="hljs-string">&#x27;ko-&#x27;</span>, label=<span class="hljs-string">&quot;Obs&quot;</span>)<br>plt.plot(df_combine_final[<span class="hljs-string">&quot;Date(HKT)&quot;</span>], df_combine_final[<span class="hljs-string">&quot;wspd[m/s]&quot;</span>],<span class="hljs-string">&#x27;ro-&#x27;</span>, label=<span class="hljs-string">&quot;mpas&quot;</span>)<br>plt.barbs(df_combine_final[<span class="hljs-string">&quot;Date(HKT)&quot;</span>], np.ones(size) * -<span class="hljs-number">2</span>, df.U.values, df.V.values, length=<span class="hljs-number">8</span>, barbcolor=<span class="hljs-string">&#x27;k&#x27;</span>)<br>plt.barbs(df_combine_final[<span class="hljs-string">&quot;Date(HKT)&quot;</span>], np.ones(size) * -<span class="hljs-number">5</span>, df_mpas.U.values, df_mpas.V.values, length=<span class="hljs-number">8</span>, barbcolor=<span class="hljs-string">&#x27;r&#x27;</span>)<br>plt.grid(zorder=<span class="hljs-number">0</span>)<br>plt.xlabel(<span class="hljs-string">&quot;Date Time (HKT)&quot;</span>)<br>plt.ylabel(<span class="hljs-string">&quot;Wind Speed [m/s]&quot;</span>)<br>plt.title(select_station_en)<br>plt.xticks(rotation=<span class="hljs-number">45</span>)<br>plt.ylim([-<span class="hljs-number">7</span>,<span class="hljs-number">12</span>])<br>plt.axhline(y=<span class="hljs-number">0.0</span>, color=<span class="hljs-string">&#x27;k&#x27;</span>, linestyle=<span class="hljs-string">&#x27;-&#x27;</span>)<br>plt.legend()<br><br><br>kt2ms = <span class="hljs-number">0.514444444</span><br>ax = plt.subplot(<span class="hljs-number">223</span>)<br>plt.plot(df_combine_final[<span class="hljs-string">&quot;Date(HKT)&quot;</span>], U_obs*kt2ms, <span class="hljs-string">&#x27;ko-&#x27;</span>, label=<span class="hljs-string">&quot;Obs&quot;</span>)<br>plt.plot(df_combine_final[<span class="hljs-string">&quot;Date(HKT)&quot;</span>], U_mpas*kt2ms,<span class="hljs-string">&#x27;ro-&#x27;</span>, label=<span class="hljs-string">&quot;mpas&quot;</span>)<br>plt.grid(zorder=<span class="hljs-number">0</span>)<br>plt.xlabel(<span class="hljs-string">&quot;Date Time (HKT)&quot;</span>)<br>plt.ylabel(<span class="hljs-string">&quot;U Wind Speed [m/s]&quot;</span>)<br>plt.title(select_station_en)<br>plt.xticks(rotation=<span class="hljs-number">45</span>)<br><span class="hljs-comment"># plt.ylim([-7,10])</span><br>plt.axhline(y=<span class="hljs-number">0.0</span>, color=<span class="hljs-string">&#x27;k&#x27;</span>, linestyle=<span class="hljs-string">&#x27;-&#x27;</span>)<br>plt.legend()<br><br><br>ax = plt.subplot(<span class="hljs-number">224</span>)<br>plt.plot(df_combine_final[<span class="hljs-string">&quot;Date(HKT)&quot;</span>], V_obs*kt2ms, <span class="hljs-string">&#x27;ko-&#x27;</span>, label=<span class="hljs-string">&quot;Obs&quot;</span>)<br>plt.plot(df_combine_final[<span class="hljs-string">&quot;Date(HKT)&quot;</span>], V_mpas*kt2ms,<span class="hljs-string">&#x27;ro-&#x27;</span>, label=<span class="hljs-string">&quot;mpas&quot;</span>)<br>plt.grid(zorder=<span class="hljs-number">0</span>)<br>plt.xlabel(<span class="hljs-string">&quot;Date Time (HKT)&quot;</span>)<br>plt.ylabel(<span class="hljs-string">&quot;V Wind Speed [m/s]&quot;</span>)<br>plt.title(select_station_en)<br>plt.xticks(rotation=<span class="hljs-number">45</span>)<br><span class="hljs-comment"># plt.ylim([-7,10])</span><br>plt.axhline(y=<span class="hljs-number">0.0</span>, color=<span class="hljs-string">&#x27;k&#x27;</span>, linestyle=<span class="hljs-string">&#x27;-&#x27;</span>)<br>plt.legend()<br><br>plt.show()<br>plt.close() <br><br><br><span class="hljs-comment"># In[ ]:</span><br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>NWP</category>
      
    </categories>
    
    
    <tags>
      
      <tag>WRF</tag>
      
      <tag>MPAS</tag>
      
      <tag>HKO</tag>
      
      <tag>obs</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Jupyter-Notebook</title>
    <link href="/2023/06/24/Jupyter-Notebook/"/>
    <url>/2023/06/24/Jupyter-Notebook/</url>
    
    <content type="html"><![CDATA[<h1 id="how-to-display-full-output-in-jupyter-not-only-last-result">How to display full output in Jupyter, not only last result?</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> IPython.core.interactiveshell <span class="hljs-keyword">import</span> InteractiveShell<br>InteractiveShell.ast_node_interactivity = <span class="hljs-string">&quot;all&quot;</span><br></code></pre></td></tr></table></figure><h1 id="sample-plot">Sample plot</h1><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><code class="hljs sh">import os.path<br>import xarray as xr<br>import numpy as np<br>import matplotlib.pyplot as plt<br>import pandas as pd<br><br>SMALL_SIZE = 8<br>MEDIUM_SIZE = 10<br>BIGGER_SIZE = 24<br><br>plt.rcParams[<span class="hljs-string">&quot;figure.figsize&quot;</span>] = (10,8)<br>plt.rc(<span class="hljs-string">&#x27;font&#x27;</span>, size=BIGGER_SIZE)          <span class="hljs-comment"># controls default text sizes</span><br>plt.rc(<span class="hljs-string">&#x27;axes&#x27;</span>, titlesize=BIGGER_SIZE)     <span class="hljs-comment"># fontsize of the axes title</span><br>plt.rc(<span class="hljs-string">&#x27;axes&#x27;</span>, labelsize=BIGGER_SIZE)    <span class="hljs-comment"># fontsize of the x and y labels</span><br>plt.rc(<span class="hljs-string">&#x27;xtick&#x27;</span>, labelsize=BIGGER_SIZE)    <span class="hljs-comment"># fontsize of the tick labels</span><br>plt.rc(<span class="hljs-string">&#x27;ytick&#x27;</span>, labelsize=BIGGER_SIZE)    <span class="hljs-comment"># fontsize of the tick labels</span><br>plt.rc(<span class="hljs-string">&#x27;legend&#x27;</span>, fontsize=BIGGER_SIZE)    <span class="hljs-comment"># legend fontsize</span><br>plt.rc(<span class="hljs-string">&#x27;figure&#x27;</span>, titlesize=BIGGER_SIZE)  <span class="hljs-comment"># fontsize of the figure title</span><br><br><span class="hljs-comment"># plt.rcParams[&#x27;font.sans-serif&#x27;] = [&#x27;SimHei&#x27;] </span><br><span class="hljs-comment"># plt.rcParams[&#x27;axes.unicode_minus&#x27;] = False</span><br><br>plt.rcParams.update(&#123;<span class="hljs-string">&#x27;font.family&#x27;</span>:<span class="hljs-string">&#x27;sans-serif&#x27;</span>&#125;)<br>plt.rcParams[<span class="hljs-string">&#x27;font.sans-serif&#x27;</span>] = [<span class="hljs-string">&#x27;DejaVu Sans&#x27;</span>]<br><br><span class="hljs-comment">#</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment">#</span><br><br>plt.title(<span class="hljs-string">&quot;diff T2m (UCM-on - UCM-off) of selected urban area&quot;</span>)<br>plt.ylabel(<span class="hljs-string">&quot;T2m (deg C)&quot;</span>)<br>plt.xlabel(<span class="hljs-string">&quot;Time (HKT)&quot;</span>)<br><br><span class="hljs-comment"># Add a horizontal line across the Axes.</span><br>plt.axhline(y = 0.0, color = <span class="hljs-string">&#x27;k&#x27;</span>, linestyle=<span class="hljs-string">&#x27;--&#x27;</span>, linewidth=2, label = <span class="hljs-string">&#x27;axhline&#x27;</span>)<br>plt.axvline(x = 1.0, color = <span class="hljs-string">&#x27;b&#x27;</span>, linestyle=<span class="hljs-string">&#x27;--&#x27;</span>, linewidth=2, label = <span class="hljs-string">&#x27;axvline&#x27;</span>)<br><br>plt.xticks(rotation=45)<br>plt.grid(linestyle=<span class="hljs-string">&#x27;--&#x27;</span>)<br><br><span class="hljs-comment"># Put a legend to the right of the current axis</span><br>plt.legend(loc=<span class="hljs-string">&#x27;center left&#x27;</span>, bbox_to_anchor=(1, 0.5))<br>plt.tight_layout()<br>plt.show()<br>plt.close()<br></code></pre></td></tr></table></figure><h1 id="to-access-the-remote-machine-with-a-browser">To access the remote machine with a browser</h1><p>To access the remote machine with a browser the notebook must listen on an external facing port <strong>(not localhost)</strong>. You will need the same invocation if want to run the Jupyter notebook on a container. In that case it is something like this:</p><figure class="highlight console"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs console">jupyter-notebook --no-browser --port 11013 --ip=0.0.0.0<br></code></pre></td></tr></table></figure><p>To listen <strong>only in localhost</strong> then you can omit the IP</p><figure class="highlight console"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs console">jupyter notebook --no-browser --port=8080<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>Jupyter</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Jupyter</tag>
      
      <tag>python</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Removing PDF protected mode</title>
    <link href="/2023/06/24/Removing-PDF-protected-mode/"/>
    <url>/2023/06/24/Removing-PDF-protected-mode/</url>
    
    <content type="html"><![CDATA[<h1 id="section"></h1><p>Removing PDF usage restrictions,</p><blockquote><p>view <a href="https://qpdf.sourceforge.io/">qpdf</a>,</p></blockquote><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh">$ <span class="hljs-built_in">sudo</span> apt install qpdf<br>$ qpdf --decrypt restricted-input.pdf unrestricted-output.pdf<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>Linux</category>
      
    </categories>
    
    
    <tags>
      
      <tag>PDF</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>WRF | WPS geo data and binary tile files</title>
    <link href="/2023/06/24/WPS-geo-data-and-binary-tile-files/"/>
    <url>/2023/06/24/WPS-geo-data-and-binary-tile-files/</url>
    
    <content type="html"><![CDATA[<h1 id="binary-files-in-the-geog-folder">Binary files in the geog folder</h1><p>The file naming convention is described on slides 14 and 15 of the <a href="https://www2.mmm.ucar.edu/wrf/users/tutorial/presentation_pdfs/202101/duda_wps_advanced.pdf">Advanced Usage of the WPS</a> tutorial presentation. If you have any additional questions about the file names, please don't hesitate to follow up in this forum and I can offer further details.</p><h1 id="reading-tile-fines-and-ploting">Reading tile fines and ploting</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np<br><span class="hljs-keyword">import</span> matplotlib <span class="hljs-keyword">as</span> mpl<br><span class="hljs-keyword">import</span> matplotlib.pyplot <span class="hljs-keyword">as</span> plt<br><span class="hljs-keyword">import</span> glob<br><span class="hljs-keyword">import</span> re<br><span class="hljs-keyword">import</span> math<br><span class="hljs-keyword">from</span> matplotlib.colors <span class="hljs-keyword">import</span> ListedColormap<br><br>SMALL_SIZE = <span class="hljs-number">8</span><br>MEDIUM_SIZE = <span class="hljs-number">10</span><br>BIGGER_SIZE = <span class="hljs-number">24</span><br><br>plt.rcParams[<span class="hljs-string">&quot;figure.figsize&quot;</span>] = (<span class="hljs-number">10</span>,<span class="hljs-number">8</span>)<br>plt.rc(<span class="hljs-string">&#x27;font&#x27;</span>, size=BIGGER_SIZE)          <span class="hljs-comment"># controls default text sizes</span><br>plt.rc(<span class="hljs-string">&#x27;axes&#x27;</span>, titlesize=BIGGER_SIZE)     <span class="hljs-comment"># fontsize of the axes title</span><br>plt.rc(<span class="hljs-string">&#x27;axes&#x27;</span>, labelsize=BIGGER_SIZE)    <span class="hljs-comment"># fontsize of the x and y labels</span><br>plt.rc(<span class="hljs-string">&#x27;xtick&#x27;</span>, labelsize=BIGGER_SIZE)    <span class="hljs-comment"># fontsize of the tick labels</span><br>plt.rc(<span class="hljs-string">&#x27;ytick&#x27;</span>, labelsize=BIGGER_SIZE)    <span class="hljs-comment"># fontsize of the tick labels</span><br>plt.rc(<span class="hljs-string">&#x27;legend&#x27;</span>, fontsize=BIGGER_SIZE)    <span class="hljs-comment"># legend fontsize</span><br>plt.rc(<span class="hljs-string">&#x27;figure&#x27;</span>, titlesize=BIGGER_SIZE)  <span class="hljs-comment"># fontsize of the figure title</span><br><br><span class="hljs-comment"># plt.rcParams[&#x27;font.sans-serif&#x27;] = [&#x27;SimHei&#x27;] </span><br><span class="hljs-comment"># plt.rcParams[&#x27;axes.unicode_minus&#x27;] = False</span><br><br>plt.rcParams.update(&#123;<span class="hljs-string">&#x27;font.family&#x27;</span>:<span class="hljs-string">&#x27;sans-serif&#x27;</span>&#125;)<br>plt.rcParams[<span class="hljs-string">&#x27;font.sans-serif&#x27;</span>] = [<span class="hljs-string">&#x27;DejaVu Sans&#x27;</span>]<br><br><span class="hljs-comment"># Reading binary tile files</span><br><span class="hljs-comment"># file_dir = &quot;/dir/*&quot;</span><br>root_dir = <span class="hljs-string">&quot;/dir/geog/&quot;</span><br>dataset_dir = <span class="hljs-string">&quot;modis_landuse_20class_30s&quot;</span><br><span class="hljs-comment">#dataset_dir = &quot;modis_landuse_20class_15s&quot;</span><br><span class="hljs-comment"># dataset_dir = &quot;greenfrac_fpar_modis&quot;</span><br><span class="hljs-comment"># dataset_dir = &quot;topo_gmted2010_2.5m&quot;</span><br><span class="hljs-comment"># dataset_dir = &quot;topo_gmted2010_30s&quot;</span><br><span class="hljs-comment"># dataset_dir = &quot;soiltype_top_30s&quot;</span><br><span class="hljs-comment"># dataset_dir = &quot;albedo_modis&quot;</span><br><span class="hljs-comment"># dataset_dir = &quot;albedo_ncep&quot;</span><br><span class="hljs-comment"># dataset_dir = &quot;greenfrac&quot;</span><br><br>file_dir = root_dir + dataset_dir + <span class="hljs-string">&quot;/*&quot;</span><br><span class="hljs-built_in">print</span>(file_dir)<br>all_files = <span class="hljs-built_in">sorted</span>(glob.glob(file_dir))<br><br>all_files<br><br>index_file = all_files[-<span class="hljs-number">1</span>]<br><span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(index_file, <span class="hljs-string">&quot;r&quot;</span>) <span class="hljs-keyword">as</span> f:<br>    index_info = f.read()<br><span class="hljs-built_in">print</span>(index_info)<br><br><span class="hljs-comment">### WITHOUT SPACE ###</span><br>tile_x = <span class="hljs-built_in">int</span>(re.search(<span class="hljs-string">&#x27;tile_x=(.+?)\ntile_y&#x27;</span>, index_info).group(<span class="hljs-number">1</span>))<br>tile_y = <span class="hljs-built_in">int</span>(re.search(<span class="hljs-string">&#x27;tile_y=(.+?)\ntile_z&#x27;</span>, index_info).group(<span class="hljs-number">1</span>))<br>tile_z = <span class="hljs-built_in">int</span>(re.search(<span class="hljs-string">&#x27;tile_z=(.+?)\nunits&#x27;</span>, index_info).group(<span class="hljs-number">1</span>))  <span class="hljs-comment"># for land use, soiltype</span><br><span class="hljs-comment"># tile_z = int(re.search(&#x27;tile_z=(.+?)\nscale&#x27;, index_info).group(1))  # for greenfrac</span><br><br><span class="hljs-comment">### WITH SPACE ###</span><br><span class="hljs-comment"># tile_x = int(re.search(&#x27;tile_x = (.+?)\ntile_y&#x27;, index_info).group(1))</span><br><span class="hljs-comment"># tile_y = int(re.search(&#x27;tile_y = (.+?)\ntile_z&#x27;, index_info).group(1))</span><br><span class="hljs-comment"># tile_z = int(re.search(&#x27;tile_z = (.+?)\ntile_bdr&#x27;, index_info).group(1))  # for topo_gmted2010</span><br><br>tile_bdr = <span class="hljs-number">0</span>  <span class="hljs-comment"># default = 0?</span><br><span class="hljs-comment"># tile_bdr = int(re.search(&#x27;tile_bdr=(.+?)\nunits&#x27;, index_info).group(1))  # for topo_gmted2010</span><br><br><span class="hljs-comment"># (tile_z, tile_y + 2 * tile_bdr and tile_x + 2 * tile_bdr, tile_y + 2 * tile_bdr and tile_x + 2 * tile_bdr)</span><br>dim1 = tile_z<br>dim2 = tile_y + <span class="hljs-number">2</span> * tile_bdr<br>dim3 = tile_x + <span class="hljs-number">2</span> * tile_bdr<br><br><span class="hljs-comment"># degrees per pixel</span><br><span class="hljs-comment">### WITHOUT SPACE ###</span><br>dx = <span class="hljs-built_in">float</span>(re.search(<span class="hljs-string">&#x27;dx=(.+?)\ndy&#x27;</span>, index_info).group(<span class="hljs-number">1</span>))  <span class="hljs-comment"># for land use, greenfrac, soiltype</span><br><span class="hljs-comment">### WITH SPACE ###</span><br><span class="hljs-comment"># dx = float(re.search(&#x27;dx = (.+?)\ndy&#x27;, index_info).group(1))  # for topo_gmted2010</span><br><br><span class="hljs-built_in">print</span>(dim1, dim2, dim3)<br><span class="hljs-built_in">print</span>(tile_x, tile_y, tile_z, dx)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">get_tile_name</span>(<span class="hljs-params">pixels_per_tile, dx, target_lat, lat_hemi, target_lon, lon_hemi, pad=<span class="hljs-number">5</span></span>):<br>    <br>    <span class="hljs-comment"># lat starts from south pole</span><br>    <span class="hljs-keyword">if</span> lat_hemi == <span class="hljs-string">&#x27;S&#x27;</span>:<br>        lat = <span class="hljs-number">90</span> - target_lat<br>    <span class="hljs-keyword">elif</span> lat_hemi == <span class="hljs-string">&#x27;N&#x27;</span>:<br>        lat = <span class="hljs-number">90</span> + target_lat<br>    <span class="hljs-keyword">else</span>:<br>        <span class="hljs-keyword">raise</span> ValueError(<span class="hljs-string">&#x27;Invalid lat_hemi&#x27;</span>)<br>        <br>    <span class="hljs-comment"># lon starts from international date line</span><br>    <span class="hljs-keyword">if</span> lon_hemi == <span class="hljs-string">&#x27;W&#x27;</span>:<br>        lon = <span class="hljs-number">180</span> - target_lon<br>    <span class="hljs-keyword">elif</span> lon_hemi == <span class="hljs-string">&#x27;E&#x27;</span>:<br>        lon = <span class="hljs-number">180</span> + target_lon<br>    <span class="hljs-keyword">else</span>:<br>        <span class="hljs-keyword">raise</span> ValueError(<span class="hljs-string">&#x27;Invalid lon_hemi&#x27;</span>)<br>    <br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;lat&#x27;</span>, lat, <span class="hljs-string">&#x27;lon&#x27;</span>, lon)<br>    <br>    <span class="hljs-comment"># 10 deg per tile for 15s/30s</span><br>    degs_per_tile = <span class="hljs-built_in">round</span>(tile_x * dx)<br>    <span class="hljs-built_in">print</span>(degs_per_tile)<br>    <br><span class="hljs-comment">#     tile_left = int(math.floor(lon / 10) * 10)</span><br><span class="hljs-comment">#     tile_right = int(math.ceil(lon / 10) * 10)</span><br><span class="hljs-comment">#     tile_bot = int(math.floor(lat / 10) * 10)</span><br><span class="hljs-comment">#     tile_top = int(math.ceil(lat / 10) * 10)</span><br>    <br>    tile_left = <span class="hljs-built_in">int</span>(math.floor(lon / degs_per_tile) * degs_per_tile)<br>    tile_right = <span class="hljs-built_in">int</span>(math.ceil(lon / degs_per_tile) * degs_per_tile)<br>    tile_bot = <span class="hljs-built_in">int</span>(math.floor(lat / degs_per_tile) * degs_per_tile)<br>    tile_top = <span class="hljs-built_in">int</span>(math.ceil(lat / degs_per_tile) * degs_per_tile)  <br><br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;tile dims&#x27;</span>, tile_left, tile_right, tile_bot, tile_top)<br>    <br><span class="hljs-comment">#     tile_left_str = str(int(math.floor(lon / 10) * pixels_per_tile + 1))</span><br><span class="hljs-comment">#     tile_right_str = str(int(math.ceil(lon / 10) * pixels_per_tile))</span><br><span class="hljs-comment">#     tile_bot_str = str(int(math.floor(lat / 10) * pixels_per_tile + 1))</span><br><span class="hljs-comment">#     tile_top_str = str(int(math.ceil(lat / 10) * pixels_per_tile))</span><br><br>    tile_left_str = <span class="hljs-built_in">str</span>(<span class="hljs-built_in">int</span>(math.floor(lon / degs_per_tile) * pixels_per_tile + <span class="hljs-number">1</span>)).zfill(pad)<br>    tile_right_str = <span class="hljs-built_in">str</span>(<span class="hljs-built_in">int</span>(math.ceil(lon / degs_per_tile) * pixels_per_tile)).zfill(pad)<br>    tile_bot_str = <span class="hljs-built_in">str</span>(<span class="hljs-built_in">int</span>(math.floor(lat / degs_per_tile) * pixels_per_tile + <span class="hljs-number">1</span>)).zfill(pad)<br>    tile_top_str = <span class="hljs-built_in">str</span>(<span class="hljs-built_in">int</span>(math.ceil(lat / degs_per_tile) * pixels_per_tile)).zfill(pad)<br><br>    target_file = tile_left_str + <span class="hljs-string">&#x27;-&#x27;</span> + tile_right_str + <span class="hljs-string">&#x27;.&#x27;</span> + tile_bot_str + <span class="hljs-string">&#x27;-&#x27;</span> + tile_top_str<br>    <br>    <span class="hljs-keyword">return</span> target_file<br><br><span class="hljs-comment"># Set lat/lon</span><br><span class="hljs-comment">### WITHOUT SPACE ###</span><br>pixels_per_tile = <span class="hljs-built_in">int</span>(re.search(<span class="hljs-string">&#x27;tile_x=(.+?)\ntile_y&#x27;</span>, index_info).group(<span class="hljs-number">1</span>))<br><span class="hljs-comment">### WITH SPACE ###</span><br><span class="hljs-comment"># pixels_per_tile = int(re.search(&#x27;tile_x = (.+?)\ntile_y&#x27;, index_info).group(1))</span><br><br>search_lat = <span class="hljs-number">22.3</span><br>search_lon = <span class="hljs-number">114.2</span><br><span class="hljs-built_in">print</span>(pixels_per_tile)<br><br><span class="hljs-comment"># west region: 27.8 N, 92.0 E</span><br><br>search_tile = get_tile_name(pixels_per_tile, dx, search_lat, <span class="hljs-string">&#x27;N&#x27;</span>, search_lon, <span class="hljs-string">&#x27;E&#x27;</span>)<br>search_file = root_dir + dataset_dir + <span class="hljs-string">&#x27;/&#x27;</span> + search_tile<br><span class="hljs-built_in">print</span>(search_file)<br><br><span class="hljs-comment"># Plot</span><br>tiley = pixels_per_tile<br>tilex = pixels_per_tile<br><br>arr = np.fromfile(search_file, dtype=<span class="hljs-string">&#x27;i1&#x27;</span>)<br>tile_output = np.reshape(arr, (tiley, tilex))<br><br>num_color = <span class="hljs-number">17</span><br><br><span class="hljs-comment"># For landuse</span><br>lst_color =     [<br><span class="hljs-string">&quot;darkgreen&quot;</span>,<br><span class="hljs-string">&quot;lime&quot;</span>,<br><span class="hljs-string">&quot;limegreen&quot;</span>,<br><span class="hljs-string">&quot;lightgreen&quot;</span>,<br><span class="hljs-string">&quot;darkseagreen&quot;</span>,<br><span class="hljs-string">&quot;mediumpurple&quot;</span>,<br><span class="hljs-string">&quot;linen&quot;</span>,<br><span class="hljs-string">&quot;tan&quot;</span>,<br><span class="hljs-string">&quot;wheat&quot;</span>,<br><span class="hljs-string">&quot;darkorange&quot;</span>,<br><span class="hljs-string">&quot;blue&quot;</span>,<br><span class="hljs-string">&quot;yellow&quot;</span>,<br><span class="hljs-string">&quot;red&quot;</span>,<br><span class="hljs-string">&quot;olive&quot;</span>,<br><span class="hljs-string">&quot;white&quot;</span>,<br><span class="hljs-string">&quot;lightsteelblue&quot;</span>,<br><span class="hljs-string">&quot;cyan&quot;</span>,<br><span class="hljs-string">&quot;whitesmoke&quot;</span>,<br><span class="hljs-string">&quot;grey&quot;</span>,<br><span class="hljs-string">&quot;dimgrey&quot;</span><br>    ]<br><br>custom_cmap = ListedColormap(lst_color[:num_color])<br><br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Min, Max = &quot;</span>, np.<span class="hljs-built_in">min</span>(tile_output), np.<span class="hljs-built_in">max</span>(tile_output))<br><br>plt.imshow(tile_output, cmap=custom_cmap, interpolation=<span class="hljs-string">&#x27;nearest&#x27;</span>, origin=<span class="hljs-string">&#x27;lower&#x27;</span>)<br>plt.colorbar()<br>plt.title( dataset_dir )<br>plt.show()<br>plt.close()<br><br><span class="hljs-comment"># Plot multiple tile fies</span><br>search_file<br><br><span class="hljs-comment"># From small y to large y ==&gt; + </span><br><span class="hljs-comment"># From large x to small x ==&gt; -</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">tile_combine</span>(<span class="hljs-params">header, xs, xe, ys, ye, nxy, pixels_per_tile</span>):<br>    <span class="hljs-comment">#</span><br>    <span class="hljs-comment"># Make first one</span><br>    <span class="hljs-comment">#</span><br>    px = <span class="hljs-number">0</span><br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;For x, &quot;</span>, px, pixels_per_tile, pixels_per_tile*px)<br>    tmp = header+<span class="hljs-built_in">str</span>(xs-pixels_per_tile*px)+<span class="hljs-string">&#x27;-&#x27;</span>+<span class="hljs-built_in">str</span>(xe-pixels_per_tile*px)+<span class="hljs-string">&#x27;.&#x27;</span>+<span class="hljs-built_in">str</span>(ys)+<span class="hljs-string">&#x27;-&#x27;</span>+<span class="hljs-built_in">str</span>(ye)<br>    <span class="hljs-built_in">print</span>(tmp)<br>    arr_tmp = np.fromfile(tmp, dtype=<span class="hljs-string">&#x27;i1&#x27;</span>)<br>    combine = np.reshape(arr_tmp, (tiley, tilex))<br><br>    <span class="hljs-keyword">for</span> py <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">1</span>, nxy):<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;   --- For y, &quot;</span>, py, pixels_per_tile, pixels_per_tile*py)<br>        tmp = header+<span class="hljs-built_in">str</span>(xs)+<span class="hljs-string">&#x27;-&#x27;</span>+<span class="hljs-built_in">str</span>(xe)+<span class="hljs-string">&#x27;.&#x27;</span>+<span class="hljs-built_in">str</span>(ys+pixels_per_tile*py)+<span class="hljs-string">&#x27;-&#x27;</span>+<span class="hljs-built_in">str</span>(ye+pixels_per_tile*py)<br>        <span class="hljs-built_in">print</span>(tmp)<br>        arr_tmp = np.fromfile(tmp, dtype=<span class="hljs-string">&#x27;i1&#x27;</span>)<br>        arr_tmp = np.reshape(arr_tmp, (tiley, tilex))<br>        combine = np.concatenate((combine, arr_tmp))   <br>    <br>    <span class="hljs-comment">#</span><br>    <span class="hljs-comment"># Build the rest</span><br>    <span class="hljs-comment">#</span><br>    <span class="hljs-keyword">for</span> px <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">1</span>, nxy):<br>        <br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;For x, &quot;</span>, px, pixels_per_tile, pixels_per_tile*px)<br>        tmp = header+<span class="hljs-built_in">str</span>(xs-pixels_per_tile*px)+<span class="hljs-string">&#x27;-&#x27;</span>+ \<br>                    <span class="hljs-built_in">str</span>(xe-pixels_per_tile*px)+<span class="hljs-string">&#x27;.&#x27;</span>+ \<br>                    <span class="hljs-built_in">str</span>(ys)+<span class="hljs-string">&#x27;-&#x27;</span>+ \<br>                    <span class="hljs-built_in">str</span>(ye)<br>        <span class="hljs-built_in">print</span>(tmp)<br>        arr_tmp = np.fromfile(tmp, dtype=<span class="hljs-string">&#x27;i1&#x27;</span>)<br>        tmp_combine = np.reshape(arr_tmp, (tiley, tilex))<br><br>        <span class="hljs-keyword">for</span> py <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">1</span>, nxy):<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;   ---For y, &quot;</span>, py, pixels_per_tile, pixels_per_tile*py)<br>            tmp = header+<span class="hljs-built_in">str</span>(xs-pixels_per_tile*px)+<span class="hljs-string">&#x27;-&#x27;</span>+ \<br>                        <span class="hljs-built_in">str</span>(xe-pixels_per_tile*px)+<span class="hljs-string">&#x27;.&#x27;</span>+ \<br>                        <span class="hljs-built_in">str</span>(ys+pixels_per_tile*py)+<span class="hljs-string">&#x27;-&#x27;</span>+ \<br>                        <span class="hljs-built_in">str</span>(ye+pixels_per_tile*py)<br>            <span class="hljs-built_in">print</span>(tmp)<br>            arr_tmp = np.fromfile(tmp, dtype=<span class="hljs-string">&#x27;i1&#x27;</span>)<br>            arr_tmp = np.reshape(arr_tmp, (tiley, tilex))<br>            tmp_combine = np.concatenate((tmp_combine, arr_tmp))<br>        <br>        <span class="hljs-comment">#</span><br>        combine = np.concatenate((tmp_combine, combine), axis=<span class="hljs-number">1</span>)<br>    <br>    <br>    <span class="hljs-keyword">return</span> combine<br><br>con = tile_combine(<span class="hljs-string">&quot;/dir/data/geog/modis_landuse_20class_30s/&quot;</span>, <span class="hljs-number">352801</span>, <span class="hljs-number">354000</span>, <span class="hljs-number">133201</span>, <span class="hljs-number">134400</span>, <span class="hljs-number">8</span>, pixels_per_tile)<br><br>plt.imshow(con, cmap=custom_cmap, interpolation=<span class="hljs-string">&#x27;nearest&#x27;</span>, origin=<span class="hljs-string">&#x27;lower&#x27;</span>)<br>plt.colorbar()<br>plt.title( dataset_dir )<br>plt.show()<br>plt.close()<br><br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>WRF</category>
      
    </categories>
    
    
    <tags>
      
      <tag>WRF</tag>
      
      <tag>WPS</tag>
      
      <tag>MPAS</tag>
      
      <tag>tile files</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>WRF | WRF-extraction-station</title>
    <link href="/2023/06/24/WRF-extraction-station/"/>
    <url>/2023/06/24/WRF-extraction-station/</url>
    
    <content type="html"><![CDATA[<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np<br><span class="hljs-keyword">import</span> xarray <span class="hljs-keyword">as</span> xr<br><span class="hljs-keyword">import</span> pandas <span class="hljs-keyword">as</span> pd<br><span class="hljs-keyword">from</span> netCDF4 <span class="hljs-keyword">import</span> Dataset<br><span class="hljs-keyword">import</span> matplotlib.pyplot <span class="hljs-keyword">as</span> plt<br><span class="hljs-keyword">from</span> matplotlib.cm <span class="hljs-keyword">import</span> get_cmap<br><br><span class="hljs-keyword">from</span> wrf <span class="hljs-keyword">import</span> (to_np, getvar, smooth2d, get_cartopy, cartopy_xlim,<br>                 cartopy_ylim, latlon_coords, extract_vars, xy_to_ll, ll_to_xy)<br><br><span class="hljs-comment"># How to display full output in Jupyter, not only last result?</span><br><span class="hljs-keyword">from</span> IPython.core.interactiveshell <span class="hljs-keyword">import</span> InteractiveShell<br>InteractiveShell.ast_node_interactivity = <span class="hljs-string">&quot;all&quot;</span><br><br>SMALL_SIZE = <span class="hljs-number">8</span><br>MEDIUM_SIZE = <span class="hljs-number">10</span><br>BIGGER_SIZE = <span class="hljs-number">24</span><br><br>plt.rcParams[<span class="hljs-string">&quot;figure.figsize&quot;</span>] = (<span class="hljs-number">10</span>,<span class="hljs-number">8</span>)<br>plt.rc(<span class="hljs-string">&#x27;font&#x27;</span>, size=BIGGER_SIZE)          <span class="hljs-comment"># controls default text sizes</span><br>plt.rc(<span class="hljs-string">&#x27;axes&#x27;</span>, titlesize=BIGGER_SIZE)     <span class="hljs-comment"># fontsize of the axes title</span><br>plt.rc(<span class="hljs-string">&#x27;axes&#x27;</span>, labelsize=BIGGER_SIZE)    <span class="hljs-comment"># fontsize of the x and y labels</span><br>plt.rc(<span class="hljs-string">&#x27;xtick&#x27;</span>, labelsize=BIGGER_SIZE)    <span class="hljs-comment"># fontsize of the tick labels</span><br>plt.rc(<span class="hljs-string">&#x27;ytick&#x27;</span>, labelsize=BIGGER_SIZE)    <span class="hljs-comment"># fontsize of the tick labels</span><br>plt.rc(<span class="hljs-string">&#x27;legend&#x27;</span>, fontsize=BIGGER_SIZE)    <span class="hljs-comment"># legend fontsize</span><br>plt.rc(<span class="hljs-string">&#x27;figure&#x27;</span>, titlesize=BIGGER_SIZE)  <span class="hljs-comment"># fontsize of the figure title</span><br><br><span class="hljs-comment"># plt.rcParams[&#x27;font.sans-serif&#x27;] = [&#x27;SimHei&#x27;] </span><br><span class="hljs-comment"># plt.rcParams[&#x27;axes.unicode_minus&#x27;] = False</span><br><br>plt.rcParams.update(&#123;<span class="hljs-string">&#x27;font.family&#x27;</span>:<span class="hljs-string">&#x27;sans-serif&#x27;</span>&#125;)<br>plt.rcParams[<span class="hljs-string">&#x27;font.sans-serif&#x27;</span>] = [<span class="hljs-string">&#x27;DejaVu Sans&#x27;</span>]<br><br>rad2deg = <span class="hljs-number">57.2957795</span><br><br><span class="hljs-comment"># # single xy to latlon</span><br><span class="hljs-comment"># lat_lon = xy_to_ll(ncfile_domain_1, 100, 100)</span><br><span class="hljs-comment"># print(lat_lon.values)</span><br><br><span class="hljs-comment"># # single latlon to xy</span><br><span class="hljs-comment"># x_y = ll_to_xy(ncfile_domain_1, 34.62, 105.46)</span><br><span class="hljs-comment"># print(x_y.values)</span><br><br><span class="hljs-comment"># # more points</span><br><span class="hljs-comment"># lat_lon = xy_to_ll(ncfile_domain_1, [100,105], [100,205])</span><br><span class="hljs-comment"># print(lat_lon.values)</span><br><br><span class="hljs-comment"># # more points</span><br><span class="hljs-comment"># x_y = ll_to_xy(ncfile_domain_1, [34.62, 35], [105.46, 100])</span><br><span class="hljs-comment"># print(x_y.values)</span><br><br><span class="hljs-comment"># get met stations</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">get_station_info</span>(<span class="hljs-params">statfile</span>):<br>    stats = pd.read_csv(statfile, sep=<span class="hljs-string">&#x27;,&#x27;</span>)<br>    stats = stats[[<span class="hljs-string">&#x27;WMO_id&#x27;</span>,<span class="hljs-string">&#x27;lat&#x27;</span>,<span class="hljs-string">&#x27;lon&#x27;</span>]]<br>    stats = stats.dropna(axis=<span class="hljs-number">0</span>)<br>    stats = stats.astype(&#123;<span class="hljs-string">&#x27;WMO_id&#x27;</span>:<span class="hljs-built_in">int</span>&#125;)<br>    <span class="hljs-keyword">return</span> (stats)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">read_model_data</span>(<span class="hljs-params">domloc, wrfdir, dom, statf, sdate, edate, utc</span>):<br>    <span class="hljs-keyword">import</span> glob<br>    <span class="hljs-keyword">from</span> netCDF4 <span class="hljs-keyword">import</span> Dataset<br>    wrfoutfiles = <span class="hljs-built_in">sorted</span>(glob.glob(<span class="hljs-string">&#x27;&#123;0&#125;/wrfout_&#123;1&#125;_*&#x27;</span>.<span class="hljs-built_in">format</span>(wrfdir,dom)))<br>    wrflist = [ Dataset(f) <span class="hljs-keyword">for</span> f <span class="hljs-keyword">in</span> wrfoutfiles ]<br>    <span class="hljs-keyword">from</span> wrf <span class="hljs-keyword">import</span> getvar, ALL_TIMES, interplevel, extract_times, to_np, ll_to_xy, extract_times<br>    wrftimes = extract_times(wrflist, timeidx=ALL_TIMES, method=<span class="hljs-string">&#x27;cat&#x27;</span>)<br><br>    <span class="hljs-comment"># get start and end index</span><br>    times = [ <span class="hljs-built_in">str</span>(s).split(<span class="hljs-string">&#x27;:&#x27;</span>)[<span class="hljs-number">0</span>] <span class="hljs-keyword">for</span> s <span class="hljs-keyword">in</span> wrftimes ]<br>    <span class="hljs-built_in">print</span>(times)<br>    sdate = (datetime.strptime(sdate,<span class="hljs-string">&#x27;%Y-%m-%d %H:%M:%S&#x27;</span>)+timedelta(hours=-utc)).strftime(<span class="hljs-string">&#x27;%Y-%m-%dT%H&#x27;</span>) <br>    edate = (datetime.strptime(edate,<span class="hljs-string">&#x27;%Y-%m-%d %H:%M:%S&#x27;</span>)+timedelta(hours=-utc)).strftime(<span class="hljs-string">&#x27;%Y-%m-%dT%H&#x27;</span>)<br>    st = times.index(sdate)<br>    et = times.index(edate) + <span class="hljs-number">1</span><br>    <span class="hljs-built_in">print</span> (<span class="hljs-string">&#x27;&#123;0&#125;: &#123;1&#125; - &#123;2&#125;&#x27;</span>.<span class="hljs-built_in">format</span>(domloc, st, et))<br><br>    stats = get_station_info(statf)<br>    stats[<span class="hljs-string">&#x27;ij&#x27;</span>] = stats.apply(<span class="hljs-keyword">lambda</span> row: np.array(ll_to_xy(wrflist[<span class="hljs-number">0</span>], row.lat, row.lon).values), axis=<span class="hljs-number">1</span>)<br>    stats[<span class="hljs-string">&#x27;i&#x27;</span>] = stats.apply(<span class="hljs-keyword">lambda</span> row: row.ij[<span class="hljs-number">0</span>], axis=<span class="hljs-number">1</span>)<br>    stats[<span class="hljs-string">&#x27;j&#x27;</span>] = stats.apply(<span class="hljs-keyword">lambda</span> row: row.ij[<span class="hljs-number">1</span>], axis=<span class="hljs-number">1</span>)<br><br>    varlist = [<span class="hljs-string">&quot;T2&quot;</span>,<span class="hljs-string">&quot;Q2&quot;</span>, <span class="hljs-string">&quot;U10&quot;</span>,<span class="hljs-string">&quot;V10&quot;</span>]<br>    df = pd.DataFrame()<br>    <span class="hljs-keyword">for</span> varname <span class="hljs-keyword">in</span> varlist:<br>        <span class="hljs-keyword">for</span> tt <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(st,et):<br>            stats[<span class="hljs-string">&#x27;varname&#x27;</span>] = varname<br>            var = getvar(wrflist, varname, timeidx=tt, method=<span class="hljs-string">&quot;cat&quot;</span>)<br>            <span class="hljs-keyword">if</span> varname == <span class="hljs-string">&#x27;T2&#x27;</span>:<br>                var = var - <span class="hljs-number">273.15</span><br>            stats[<span class="hljs-string">&#x27;datetime&#x27;</span>] = var.coords[<span class="hljs-string">&#x27;Time&#x27;</span>].values<br>            stats[<span class="hljs-string">&#x27;value&#x27;</span>] = stats.apply(<span class="hljs-keyword">lambda</span> row: to_np(var[row.i, row.j]), axis=<span class="hljs-number">1</span>)<br>            df =df.append(stats[[<span class="hljs-string">&#x27;datetime&#x27;</span>,<span class="hljs-string">&#x27;WMO_id&#x27;</span>,<span class="hljs-string">&#x27;varname&#x27;</span>,<span class="hljs-string">&#x27;value&#x27;</span>]])<br>    df[<span class="hljs-string">&#x27;datetime&#x27;</span>] = df.apply(<span class="hljs-keyword">lambda</span> row: (datetime.strptime(<span class="hljs-built_in">str</span>(row.datetime),<span class="hljs-string">&#x27;%Y-%m-%d %H:%M:%S&#x27;</span>)+timedelta(hours=utc)).strftime(<span class="hljs-string">&quot;%Y-%m-%d %H:%M:%S&quot;</span>), axis=<span class="hljs-number">1</span>)<br>    df[<span class="hljs-string">&#x27;model&#x27;</span>] = domloc<br>    <span class="hljs-comment">#df[&#x27;WSPD10&#x27;] = df.apply(lambda row: math.sqrt(row.U10 ** 2 + row.V10 ** 2))</span><br>    <span class="hljs-comment">#df[&#x27;WDIR10&#x27;] = df.apply(lambda row: 180+(360/(2/3.1415926)*math.atan2(row.U10,row.V10)))</span><br>    <span class="hljs-comment">#df = df[]</span><br>    <span class="hljs-keyword">return</span> (df)<br><br>station = get_station_info(<span class="hljs-string">&quot;./station.txt&quot;</span>)<br>station<br><br><span class="hljs-comment"># WMO_idlatlon</span><br><span class="hljs-comment"># 0122.312114.173</span><br><span class="hljs-comment"># 1233.000105.000</span><br><br>domloc = <span class="hljs-string">&quot;ucm&quot;</span><br>wrfdir = <span class="hljs-string">&quot;/xxx/wrf/&quot;</span><br>dom = <span class="hljs-string">&quot;d02&quot;</span><br>statf = <span class="hljs-string">&quot;./station.txt&quot;</span><br>sdate = <span class="hljs-string">&quot;2023-03-31 21:00:00&quot;</span><br>edate = <span class="hljs-string">&quot;2023-04-01 03:00:00&quot;</span><br>utc = <span class="hljs-number">0</span> <span class="hljs-comment"># 8</span><br><br>df = read_model_data(domloc, wrfdir, dom, statf, sdate, edate, utc)<br>df<br><br>select_var = df[(df[<span class="hljs-string">&quot;varname&quot;</span>] == <span class="hljs-string">&quot;T2&quot;</span>) &amp; (df[<span class="hljs-string">&quot;WMO_id&quot;</span>] == <span class="hljs-number">1</span>)]<br>select_var<br><br>plt.plot(pd.to_datetime(select_var.datetime), select_var.value, <span class="hljs-string">&#x27;ro--&#x27;</span>)<br>plt.title(<span class="hljs-string">&quot;T2m&quot;</span>)<br>plt.ylabel(<span class="hljs-string">&quot;T2m (deg C)&quot;</span>)<br>plt.xlabel(<span class="hljs-string">&quot;Time (UTC)&quot;</span>)<br>plt.legend()<br><span class="hljs-comment"># plt.axhline(y=0.0, color=&#x27;k&#x27;, linestyle=&#x27;-&#x27;)</span><br>plt.xticks(rotation=<span class="hljs-number">45</span>)<br>plt.grid()<br>plt.show()<br>plt.close()<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>WRF</category>
      
    </categories>
    
    
    <tags>
      
      <tag>NWP</tag>
      
      <tag>Jupyter</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>netCDF operator (nco, cdo)</title>
    <link href="/2023/06/24/cdo/"/>
    <url>/2023/06/24/cdo/</url>
    
    <content type="html"><![CDATA[<h2 id="ncrename---netcdf-renamer">ncrename - netCDF Renamer</h2><p>Options &gt; -a old_name, new_name Attribute renaming. The old and new names of the attribute are specified by the associated old_name and new_name values. Global attributes are treated no differently than variable attributes. This option may be specified more than once. You cannot change the attribute name for one particular variable (unless it is uniquely named); all occurrences of the attribute of a given name will be renamed. This is considered an oversight and will be addressed in a future version of NCO. -d old_name, new_name Dimension renaming. The old and new names of the dimension are specified by the associated old_name and new_name values. This option may be specified more than once. -v old_name, new_name Variable renaming. The old and new names of the variable are specified by the associated old_name and new_name values. This option may be specified more than once. -i &gt;Interactive. ncrename will prompt for confirmation before overwriting an existing file.</p><p>Examples Rename the variable p to pressure and t to temperature in netCDF in.nc. In this case p must exist in the input file (or ncrename will abort), but the presence of t is optional: <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">$ ncrename -v p,pressure -v .t,temperature in.nc<br></code></pre></td></tr></table></figure> ncrename does not automatically attach dimensions to variables of the same name. If you want to rename a coordinate variable so that it remains a coordinate variable, you must separately rename both the dimension and the variable: <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">$ ncrename -d lon,longitude -v lon,longitude in.nc<br></code></pre></td></tr></table></figure></p><h2 id="ncrcat---netcdf-record-concatenator">ncrcat - netCDF Record Concatenator</h2><p>ncrcat concatenates record variables across an arbitrary number of input files. The final record dimension is by default the sum of the lengths of the record dimensions in the input files. <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sh">$ ncrcat -O <span class="hljs-string">&quot;diag*.nc&quot;</span> <span class="hljs-variable">$&#123;path_out&#125;</span><br>$ ncrcat 85.nc 86.nc 87.nc 88.nc 89.nc 8589.nc<br>$ ncrcat 8[56789].nc 8589.nc<br></code></pre></td></tr></table></figure> <a href="https://disc.gsfc.nasa.gov/information/howto?title=How%20to%20Concatenate%20the%20Time%20Dimension%20of%20netCDF%20Files%20with%20NCO">How to Concatenate the Time Dimension of netCDF Files with NCO</a></p><h2 id="appending-variables">Appending variables</h2><p>This puts the contents yyy of bbb.nc into aaa.nc. <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">$ ncks -A -v yyy bbb.nc aaa.nc<br></code></pre></td></tr></table></figure></p><h2 id="ncdiff---netcdf-differencer">ncdiff - netCDF Differencer</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">$ ncdiff 86_0112.nc 85_0112.nc diff.nc<br></code></pre></td></tr></table></figure><h2 id="cdo-sub">cdo sub</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">$ cdo sub v1.nc v2.nc diff.nc<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>NWP</category>
      
    </categories>
    
    
    <tags>
      
      <tag>WRF</tag>
      
      <tag>MPAS</tag>
      
      <tag>netcdf</tag>
      
      <tag>nco</tag>
      
      <tag>cdo</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Approximate Metric Equivalents for Degrees, Minutes, and Seconds</title>
    <link href="/2023/06/24/degree-to-meter/"/>
    <url>/2023/06/24/degree-to-meter/</url>
    
    <content type="html"><![CDATA[<h1 id="approximate-metric-equivalents-for-degrees-minutes-and-seconds">Approximate Metric Equivalents for Degrees, Minutes, and Seconds</h1><p>At the equator for longitude and for latitude anywhere, the following approximations are valid:</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs sh">1° = 111 km  (or 60 nautical miles)<br>0.1° = 11.1 km<br>0.01° = 1.11 km (2 decimals, km accuracy)<br>0.001° =111 m<br>0.0001° = 11.1 m<br>0.00001° = 1.11 m<br>0.000001° = 0.11 m (7 decimals, cm accuracy)<br><br>1<span class="hljs-string">&#x27; = 1.85 km  (or 1 nautical mile)</span><br><span class="hljs-string">0.1&#x27;</span> = 185 m<br>0.01<span class="hljs-string">&#x27; = 18.5 m</span><br><span class="hljs-string">0.001&#x27;</span> = 1.85 m<br><br>30<span class="hljs-string">&quot; = 900 m</span><br><span class="hljs-string">15&quot;</span> = 450 m<br>3<span class="hljs-string">&quot; = 90 m</span><br><span class="hljs-string">1&quot;</span> = 30 m<br>1/3<span class="hljs-string">&quot; = 10 m</span><br><span class="hljs-string">0.1&quot;</span> = 3 m<br>1/9<span class="hljs-string">&quot; = 3 m</span><br><span class="hljs-string">1/27&quot;</span> = 1 m<br></code></pre></td></tr></table></figure><p>If you report a position to the nearest 0.01° (two decimal places for latitude and longitude), you will only be accurate to around 1 km. While this is adequate for rough locations on a global scale, for detailed work it will be inadequate.</p><h1 id="latitude-and-longitude">Latitude and longitude</h1><p>Lines of latitude and longitude form the grid system used on globes, maps and charts. Latitude is a measure of how far north or south somewhere is from the Equator; longitude is a measure of how far east or west it is from the Prime Meridian. Whilst lines (or parallels) of latitude all run parallel to the Equator, lines (or meridians) of longitude all converge at the Earth’s North and South Poles. The north–south line passing through any particular point on the Earth’s surface is known as the “local meridian”.</p><p>Although the Equator is the obvious zero point from which to measure latitude, there is no equivalent point from which to measure longitude. In 1884, an international conference decided that the Greenwich Meridian, as defined by the Airy Transit Circle at the Royal Observatory, Greenwich, should be adopted as the Prime or Zero Meridian for the World.</p><p>Latitude and longitude are both measured in degrees. <strong>Each degree (°) is subdivided into 60 minutes (') and each minute into 60 seconds (")</strong>. Each degree of latitude corresponds to a distance on the Earth‘s surface of about 111 km. Each degree of longitude however, corresponds to a distance that varies with latitude. The distance is about 111 km at the Equator, reducing to 0 km at the Poles.</p><h1 id="the-prime-meridian">The prime meridian</h1><p>The prime meridian forms the reference point by which longitudes are defined and expressed. This line makes it possible to measure the position of a location on Earth based on the longitude.</p><p>On Earth, the prime meridian -- which, like all other latitude and longitude lines, is also imaginary -- passes through Greenwich, England. For this reason, it also called the Greenwich meridian. Thus, the prime meridian is the imaginary north-south line that passes through the north and south poles, as well as Greenwich. It has a longitude of 0 degrees. The antemeridian, which is the opposite of the prime meridian, is located on the other side of the Earth and has a longitude of 180 degrees.</p><p>Longitudes and the prime meridian are both used to define time zones. <strong>Greenwich Mean Time (GMT)</strong>, also known as Coordinated Universal Time, is the standard time by which all other time zones are expressed -- for example:</p><p>GMT + 0 = Time in Greenwich, U.K. GMT + 8 = China Standard Time GMT - 8 = Pacific Standard Time</p><h1 id="coordinated-universal-time-or-utc">Coordinated Universal Time or UTC</h1><p>Coordinated Universal Time or UTC is the primary time standard by which the world regulates clocks and time. It is within about one second of mean solar time (such as UT1) at 0° longitude (at the IERS Reference Meridian as the currently used prime meridian) and is not adjusted for daylight saving time. It is effectively a successor to Greenwich Mean Time (GMT).</p><p>世界協調時間是世界上調節時鐘和時間的主要時間標準，它與0度經線的平太陽時相差不超過1秒，並不遵守夏令時。世界協調時間是最接近格林威治標準時間（GMT）的幾個替代時間系統之一。對於大多數用途來說，UTC時間被認為能與GMT時間互換，但GMT時間已不再被科學界所確定。</p>]]></content>
    
    
    <categories>
      
      <category>NWP</category>
      
    </categories>
    
    
    <tags>
      
      <tag>WRF</tag>
      
      <tag>MPAS</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>NetCDF and its Conversion</title>
    <link href="/2023/06/24/netcdf/"/>
    <url>/2023/06/24/netcdf/</url>
    
    <content type="html"><![CDATA[<p><a href="https://www.unidata.ucar.edu/software/netcdf/">NetCDF</a> (Network Common Data Form) is a set of software libraries and machine-independent data formats that support the creation, access, and sharing of array-oriented scientific data. It is also a community standard for sharing scientific data. The Unidata Program Center supports and maintains netCDF programming interfaces for C, C++, Java, and Fortran. Programming interfaces are also available for Python, IDL, MATLAB, R, Ruby, and Perl.</p><p>網絡通用數據格式（英語：Network Common Data Form，NetCDF）是一種自描述、與機器無關、基於陣列的科學數據格式，同時也是支援建立、存取和共用這一數據格式的函數庫。該專案首頁位於美國大氣科學研究大學聯盟（UCAR）的Unidata規劃網站。它也是netCDF軟件、標準開發、更新等的主要來源。NetCDF格式是一種開放標準。NetCDF的經典格式和64位元偏移量格式是開放地理空間協會採用的國際標準。該專案開始於1989年，UCAR目前對其積極支援，在新發行版中改進效能、增加功能並修正缺陷，目前版本系列是netCDF-4，在編譯時也可以選擇只建造netCDF-3庫。</p><h2 id="file-formats-and-conversion">File Formats and Conversion</h2><p><a href="https://nco.sourceforge.net/nco.html#fl_fmt">link</a> &gt; Availability: ncap2, nces, ncecat, ncflint, ncks, ncpdq, ncra, ncrcat, ncwa &gt; Short options: ‘-3’, ‘-4’, ‘-5’, ‘-6’, ‘-7’ &gt; Long options: ‘--3’, ‘--4’, ‘--5’, ‘--6’, ‘--64bit_offset’, ‘--7’, ‘--fl_fmt’, ‘--netcdf4’</p><p>All NCO operators support (read and write) all three (or four, depending on how one counts) file formats supported by netCDF4. The default output file format for all operators is the input file format. The operators listed under “Availability” above allow the user to specify the output file format independent of the input file format. These operators allow the user to convert between the various file formats. (The operators ncatted and ncrename do not support these switches so they always write the output netCDF file in the same format as the input netCDF file.)</p><h3 id="file-formats">File Formats</h3><p>netCDF supports five types of files: <strong>CLASSIC, 64BIT_OFFSET, 64BIT_DATA, NETCDF4, and NETCDF4_CLASSIC</strong>. The CLASSIC (aka CDF1) format is the traditional 32-bit offset written by netCDF2 and netCDF3. As of 2005, nearly all netCDF datasets were in CLASSIC format. The 64BIT_OFFSET (originally called plain old 64BIT) (aka CDF2) format was added in Fall, 2004. As of 2010, many netCDF datasets were in 64BIT_OFFSET format. As of 2013, an increasing number of netCDF datasets were in NETCDF4_CLASSIC format. The 64BIT_DATA (aka CDF5 or PNETCDF) format was added to netCDF in January, 2016 and immediately supported by NCO. Support for Zarr and NCZarr backend storage formats was added to netCDF in 2021 and supported by NCO in 2022.</p><p>The NETCDF4 format uses HDF5 as the file storage layer. The files are (usually) created, accessed, and manipulated using the traditional netCDF3 API (with numerous extensions). The NETCDF4_CLASSIC format refers to netCDF4 files created with the NC_CLASSIC_MODEL mask. Such files use HDF5 as the back-end storage format (unlike netCDF3), though they incorporate only netCDF3 features. Hence NETCDF4_CLASSIC files are entirely readable by applications that use only the netCDF3 API (though the applications must be linked with the netCDF4 library). NCO must be built with netCDF4 to write files in the new NETCDF4 and NETCDF4_CLASSIC formats, and to read files in these formats. Datasets in the default CLASSIC or the newer 64BIT_OFFSET formats have maximum backwards-compatibility with older applications. NCO has deep support for NETCDF4 formats. If backwards compatibility is important, and your datasets are too large for netCDF3, use NETCDF4_CLASSIC instead of CLASSIC format files. NCO support for the NETCDF4 format is complete and many high-performance disk/RAM efficient workflows utilize this format.</p><p>As mentioned above, all operators write use the input file format for output files unless told otherwise. Toggling the short option ‘-6’ or the long option ‘--6’ or ‘--64bit_offset’ (or their key-value equivalent ‘--fl_fmt=64bit_offset’) produces the netCDF3 64-bit offset format named 64BIT_OFFSET. NCO must be built with netCDF 3.6 or higher to produce a 64BIT_OFFSET file. As of NCO version 4.6.9 (September, 2017), toggling the short option ‘-5’ or the long options ‘--5’, ‘--64bit_data’, ‘--cdf5’, or ‘--pnetcdf’ (or their key-value equivalent ‘--fl_fmt=64bit_data’) produces the netCDF3 64-bit data format named 64BIT_DATA. This format is widely used by MPI-enabled modeling codes because of its long association with PnetCDF. NCO must be built with netCDF 4.4 or higher to produce a 64BIT_DATA file.</p><p>Using the ‘-4’ switch (or its long option equivalents ‘--4’ or ‘--netcdf4’), or setting its key-value equivalent ‘--fl_fmt=netcdf4’ produces a NETCDF4 file (i.e., with all supported HDF5 features). Using the ‘-7’ switch (or its long option equivalent ‘--7’ 30, or setting its key-value equivalent ‘--fl_fmt=netcdf4_classic’ produces a NETCDF4_CLASSIC file (i.e., with all supported HDF5 features like compression and chunking but without groups or new atomic types). Operators given the ‘-3’ (or ‘--3’) switch without arguments will (attempt to) produce netCDF3 CLASSIC output, even from netCDF4 input files.</p><p>Note that NETCDF4 and NETCDF4_CLASSIC are the same binary format. The latter simply causes a writing application to fail if it attempts to write a NETCDF4 file that cannot be completely read by the netCDF3 library. Conversely, NETCDF4_CLASSIC indicates to a reading application that all of the file contents are readable with the netCDF3 library. NCO has supported reading/writing basic NETCDF4 and NETCDF4_CLASSIC files since October, 2005.</p><h3 id="determining-file-format">Determining File Format</h3><p>First, examine the first line of global metadata output by <strong>ncks -M</strong>: <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh">$ ncks -M foo_3.nc<br>Summary of foo_3.nc: filetype = NC_FORMAT_CLASSIC, 0 <span class="hljs-built_in">groups</span> ...<br></code></pre></td></tr></table></figure> ncks will also print the extended or underlying format of the input file <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">$ ncks -D 2 -M foo_4.nc<br></code></pre></td></tr></table></figure> Second, query the file with ‘ncdump -k’: <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh">$ ncdump -k foo_3.nc<br>classic/netCDF-4/cdf5/...<br></code></pre></td></tr></table></figure></p><h3 id="file-conversion">File Conversion</h3><p>Let us demonstrate converting a file from any netCDF-supported input format into any netCDF output format (subject to limits of the output format). Here the <strong>input file in.nc</strong> may be in any of these formats: netCDF3 (classic, 64bit_offset, 64bit_data), netCDF4 (classic and extended), HDF4, HDF5, HDF-EOS (version 2 or 5), and DAP. The switch determines the output format written in the comment:</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs sh">ncks --fl_fmt=classic in.nc foo_3.nc <span class="hljs-comment"># netCDF3 classic</span><br>ncks --fl_fmt=64bit_offset in.nc foo_6.nc <span class="hljs-comment"># netCDF3 64bit-offset</span><br>ncks --fl_fmt=64bit_data in.nc foo_5.nc <span class="hljs-comment"># netCDF3 64bit-data</span><br>ncks --fl_fmt=cdf5 in.nc foo_5.nc <span class="hljs-comment"># netCDF3 64bit-data</span><br>ncks --fl_fmt=netcdf4_classic in.nc foo_7.nc <span class="hljs-comment"># netCDF4 classic</span><br>ncks --fl_fmt=netcdf4 in.nc foo_4.nc <span class="hljs-comment"># netCDF4 </span><br>ncks -3 in.nc foo_3.nc <span class="hljs-comment"># netCDF3 classic</span><br>ncks --3 in.nc foo_3.nc <span class="hljs-comment"># netCDF3 classic</span><br>ncks -6 in.nc foo_6.nc <span class="hljs-comment"># netCDF3 64bit-offset</span><br>ncks --64 in.nc foo_6.nc <span class="hljs-comment"># netCDF3 64bit-offset</span><br>ncks -5 in.nc foo_5.nc <span class="hljs-comment"># netCDF3 64bit-data</span><br>ncks --5 in.nc foo_5.nc <span class="hljs-comment"># netCDF3 64bit-data</span><br>ncks -4 in.nc foo_4.nc <span class="hljs-comment"># netCDF4 </span><br>ncks --4 in.nc foo_4.nc <span class="hljs-comment"># netCDF4 </span><br>ncks -7 in.nc foo_7.nc <span class="hljs-comment"># netCDF4 classic</span><br>ncks --7 in.nc foo_7.nc <span class="hljs-comment"># netCDF4 classic</span><br></code></pre></td></tr></table></figure><p>Of course since most operators support these switches, the “conversions” can be done at the output stage of arithmetic or metadata processing rather than requiring a separate step. Producing (netCDF3) CLASSIC or 64BIT_OFFSET or 64BIT_DATA files from NETCDF4_CLASSIC files always works.</p>]]></content>
    
    
    <categories>
      
      <category>NWP</category>
      
    </categories>
    
    
    <tags>
      
      <tag>WRF</tag>
      
      <tag>MPAS</tag>
      
      <tag>netcdf</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>rsync - Transferring and synchronizing files</title>
    <link href="/2023/06/24/rsync-Transferring-and-synchronizing-files/"/>
    <url>/2023/06/24/rsync-Transferring-and-synchronizing-files/</url>
    
    <content type="html"><![CDATA[<h1 id="rsync">rsync</h1><p>rsync (remote sync) 是Unix下的一款套用軟件，它能同步更新兩處電腦的檔案與目錄，並適當利用差分編碼以減少數據傳輸量。rsync中的一項同類軟件不常見的重要特性是每個目標的鏡像只需傳送一次。rsync可以拷貝／顯示目錄內容，以及拷貝檔案，並可選壓縮以及遞歸拷貝。</p><p>在常駐模式（daemon mode）下，rsync預設監聽 <code>TCP埠 873</code>，以原生rsync傳輸協定或者透過遠端shell如RSH或者SSH提供檔案。SSH模式下，rsync用戶端執行程式必須同時在本機和遠端機器上安裝。</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs sh">rsync 的基本語法結構如下：<br><br>rsync 參數 來源檔案 目的檔案<br>以下是最常見的幾個參數：<br><br>-v：verbose 模式，輸出比較詳細的訊息。<br>-r：遞迴（recursive）備份所有子目錄下的目錄與檔案。<br>-a：封裝備份模式，相當於 -rlptgoD，遞迴備份所有子目錄下的目錄與檔案，保留連結檔、檔案的擁有者、群組、權限以及時間戳記。<br>-z：啟用壓縮。<br>-h：將數字以比較容易閱讀的格式輸出。<br></code></pre></td></tr></table></figure><ol type="1"><li>如果要讓 rsync 在傳輸檔案時可以即時顯示進度，可以加上 --progress 參數。</li><li>-P參數是--progress和--partial這兩個參數的結合，使用此選項時，rsync 在傳輸過程中<strong>顯示進度條</strong>並<strong>保留部分傳輸的檔案</strong>。透過緩慢或不穩定的網路連線傳輸大檔案時非常有用。</li></ol><figure class="highlight console"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs console">rsync -aP folder username@target-ip:/home/user/xxx/<br><br>rsync -aP --exclude=&#x27;*.txt&#x27; --exclude &#x27;dir1/*&#x27; source/ destination<br>rsync -aP --exclude=&#123;&#x27;*.txt&#x27;, &#x27;file1.txt&#x27;,&#x27;dir1/*&#x27;&#125; source/ destination<br>rsync -aP --exclude-from=&#x27;exclude-file.txt&#x27; source/ destination/<br>rsync -av --include=&quot;*.txt&quot; --exclude=&#x27;*&#x27; source/ destination<br></code></pre></td></tr></table></figure><p>and,</p>    <div class="fold">      <div class="fold-title fold-info collapsed" data-toggle="collapse" href="#collapse-6ae3e036" role="button" aria-expanded="false" aria-controls="collapse-6ae3e036">        <div class="fold-arrow">▶</div>script      </div>      <div class="fold-collapse collapse" id="collapse-6ae3e036">        <div class="fold-content">          <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-meta">#!/bin/bash</span><br><span class="hljs-comment">#Here&#x27;s how this script works:</span><br><br><span class="hljs-comment"># Replace the REMOTE_HOST, REMOTE_PATH, and LOCAL_PATH variables with your actual remote host details, remote file path, and local directory path, respectively.</span><br><span class="hljs-comment"># The LOCK_FILE variable specifies the path to the lock file, which will be used to prevent multiple instances of the script from running simultaneously.</span><br><span class="hljs-comment"># The is_locked function checks if the lock file exists.</span><br><span class="hljs-comment"># The create_lock function creates the lock file.</span><br><span class="hljs-comment"># The remove_lock function removes the lock file.</span><br><span class="hljs-comment"># The perform_rsync function performs the actual rsync -z command to copy the files from the remote machine to the local machine.</span><br><span class="hljs-comment"># The script checks if the lock file exists. If it does, it means the previous rsync is still running, so it exits without starting a new rsync.</span><br><span class="hljs-comment"># If the lock file doesn&#x27;t exist, the script creates the lock file, performs the rsync, and then removes the lock file.</span><br><br>INIT_DIR=<span class="hljs-variable">$1</span><br><br>REMOTE_HOST=<span class="hljs-string">&quot;user@ip&quot;</span><br>PORT=<span class="hljs-string">&quot;1234567&quot;</span><br>REMOTE_PATH=<span class="hljs-string">&quot;/home/user/<span class="hljs-variable">$&#123;INIT_DIR&#125;</span>/file.*&quot;</span> <br>LOCAL_PATH=<span class="hljs-string">&quot;/home/user/<span class="hljs-variable">$&#123;INIT_DIR&#125;</span>/&quot;</span> <br>LOCK_FILE=<span class="hljs-string">&quot;<span class="hljs-variable">$&#123;LOCAL_PATH&#125;</span>/rsync.lock&quot;</span> <br>LOG_FILE=<span class="hljs-string">&quot;<span class="hljs-variable">$&#123;LOCAL_PATH&#125;</span>/rsync.log&quot;</span><br><span class="hljs-comment"># Function to check if the lock file exists</span><br><span class="hljs-function"><span class="hljs-title">is_locked</span></span>() &#123;<br>    [ -f <span class="hljs-string">&quot;<span class="hljs-variable">$LOCK_FILE</span>&quot;</span> ]<br>&#125;<br><br><span class="hljs-comment"># Create the lock file</span><br><span class="hljs-function"><span class="hljs-title">create_lock</span></span>() &#123;<br>    <span class="hljs-built_in">touch</span> <span class="hljs-string">&quot;<span class="hljs-variable">$LOCK_FILE</span>&quot;</span><br>&#125;<br><br><span class="hljs-comment"># Remove the lock file</span><br><span class="hljs-function"><span class="hljs-title">remove_lock</span></span>() &#123;<br>    <span class="hljs-built_in">rm</span> <span class="hljs-string">&quot;<span class="hljs-variable">$LOCK_FILE</span>&quot;</span><br>&#125;<br><br><span class="hljs-comment"># Function to perform rsync</span><br><span class="hljs-function"><span class="hljs-title">perform_rsync</span></span>() &#123;<br>    rsync -azvhP -e <span class="hljs-string">&#x27;ssh -p &#x27;</span> <span class="hljs-string">&quot;<span class="hljs-variable">$PORT</span>&quot;</span> <span class="hljs-string">&quot;<span class="hljs-variable">$REMOTE_HOST</span>:<span class="hljs-variable">$REMOTE_PATH</span>&quot;</span> <span class="hljs-string">&quot;<span class="hljs-variable">$LOCAL_PATH</span>&quot;</span> --log-file=<span class="hljs-variable">$&#123;LOG_FILE&#125;</span><br>&#125;<br><br><span class="hljs-comment"># Check if the lock file exists</span><br><span class="hljs-keyword">if</span> is_locked; <span class="hljs-keyword">then</span><br>    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;Previous rsync is still running. Exiting.&quot;</span><br>    <span class="hljs-built_in">exit</span> 1<br><span class="hljs-keyword">fi</span><br><br><span class="hljs-comment"># Create the lock file</span><br>create_lock<br><br><span class="hljs-comment"># Perform rsync</span><br>perform_rsync<br><br><span class="hljs-comment"># Remove the lock file</span><br>remove_lock<br></code></pre></td></tr></table></figure>        </div>      </div>    </div><p>This can be submitted as cron job and automatically downloads new files generated (e.g. every hour). It checks whether the previous rsync job is done before rsync-ing again, otherwise waits for another time interval defined in the crontab (it generates a 'lock' file when starting a rsync and deleting it afterwards. If the 'lock' file is present it will not run rsync)</p><h1 id="includeexclude">include/exclude</h1><p><code>rsync</code> supports the <code>--include-from</code> option, which allows you to specify include patterns in a file instead of listing multiple <code>--include</code> options on the command line. This is useful for managing complex include patterns or when you have many file types to include.</p><h2 id="syntax">Syntax</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">rsync [options] --include-from=<span class="hljs-string">&#x27;file&#x27;</span> <span class="hljs-built_in">source</span> destination<br></code></pre></td></tr></table></figure><h2 id="key-points">Key Points</h2><ul><li>The <code>--include-from='file'</code> option reads include patterns from a specified file.</li><li>Each line in the file is treated as an include pattern (e.g., <code>*.txt</code>, <code>*.pdf</code>).</li><li>Combine with <code>--exclude='*'</code> to include only the patterns listed in the file and exclude everything else.</li><li>The file can also contain <code>--exclude</code> patterns if needed (prefix with <code>-</code> for exclude).</li><li>Patterns in the file follow the same syntax as <code>--include</code> and <code>--exclude</code>.</li></ul><h2 id="how-to-use---include-from">How to Use <code>--include-from</code></h2><ol type="1"><li><strong>Create a file</strong> (e.g., <code>include.txt</code>) with include patterns, one per line.</li><li><strong>Use <code>--include-from</code></strong> to reference the file in your <code>rsync</code> command.</li><li><strong>Test with <code>--dry-run</code></strong> to verify the patterns.</li><li><strong>Run the command</strong> to synchronize files.</li></ol><h2 id="example">Example</h2><h3 id="step-1-create-the-include-file">Step 1: Create the include file</h3><p>Create a file named <code>include.txt</code> with the following content:</p><figure class="highlight gams"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs gams"><span class="hljs-comment">*.txt</span><br><span class="hljs-comment">*.pdf</span><br><span class="hljs-comment">*.jpg</span><br></code></pre></td></tr></table></figure><h3 id="step-2-run-rsync">Step 2: Run rsync</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">rsync -av --include-from=<span class="hljs-string">&#x27;include.txt&#x27;</span> --exclude=<span class="hljs-string">&#x27;*&#x27;</span> /source/ /destination/<br></code></pre></td></tr></table></figure><ul><li>This syncs only <code>.txt</code>, <code>.pdf</code>, and <code>.jpg</code> files from <code>/source/</code> to <code>/destination/</code>, excluding all other files.</li></ul><h2 id="advanced-example">Advanced Example</h2><h3 id="include-file-with-directories-and-exclusions">Include file with directories and exclusions</h3><p><code>include.txt</code>:</p><figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs jboss-cli">+ */                 <span class="hljs-comment"># Include all directories for traversal</span><br>+ *<span class="hljs-string">.txt</span>             <span class="hljs-comment"># Include .txt files</span><br>+ *<span class="hljs-string">.pdf</span>             <span class="hljs-comment"># Include .pdf files</span><br>- *<span class="hljs-string">.bak</span>             <span class="hljs-comment"># Exclude .bak files</span><br></code></pre></td></tr></table></figure><h3 id="command">Command</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">rsync -av --include-from=<span class="hljs-string">&#x27;include.txt&#x27;</span> --exclude=<span class="hljs-string">&#x27;*&#x27;</span> /source/ /destination/<br></code></pre></td></tr></table></figure><ul><li>Includes <code>.txt</code> and <code>.pdf</code> files recursively, excludes <code>.bak</code> files, and ignores all other files.</li></ul><h2 id="notes">Notes</h2><ul><li><strong>Pattern syntax in file</strong>:<ul><li>Use <code>+</code> (plus and space) for include patterns (optional, but clearer).</li><li>Use <code>-</code> (minus and space) for exclude patterns.</li><li>Blank lines and lines starting with <code>#</code> are ignored (useful for comments).</li></ul></li><li><strong>Order matters</strong>: Patterns are processed in the order they appear in the file.</li><li><strong>Relative paths</strong>: The <code>--include-from</code> file path is relative to the current working directory.</li><li><strong>Combine with other options</strong>: You can still use <code>--include</code> or <code>--exclude</code> on the command line, but <code>--include-from</code> patterns are processed afterward.</li><li><strong>Debugging</strong>: Use <code>--dry-run</code> and <code>-v</code> to verify which files are included/excluded.</li></ul><h2 id="tips">Tips</h2><ul><li>Use <code>--include-from</code> for large or reusable pattern lists to keep commands clean.</li><li>Store the include file in a version-controlled location if used frequently.</li><li>Test complex patterns with <code>rsync -av --dry-run --include-from='file'</code>.</li></ul>]]></content>
    
    
    <categories>
      
      <category>Linux</category>
      
    </categories>
    
    
    <tags>
      
      <tag>download</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Bash | datetime (manipulate)</title>
    <link href="/2023/05/23/bash-datetime/"/>
    <url>/2023/05/23/bash-datetime/</url>
    
    <content type="html"><![CDATA[<h1 id="bash-datetime-manipulate">Bash datetime (manipulate)</h1><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs sh">NAME<br>       <span class="hljs-built_in">date</span> - <span class="hljs-built_in">print</span> or <span class="hljs-built_in">set</span> the system <span class="hljs-built_in">date</span> and time<br><br>SYNOPSIS<br>       <span class="hljs-built_in">date</span> [OPTION]... [+FORMAT]<br>       <span class="hljs-built_in">date</span> [-u|--utc|--universal] [MMDDhhmm[[CC]YY][.ss]]<br><br></code></pre></td></tr></table></figure><p>We want to manipulate the datetime change.</p><h2 id="formatyyymmdd">Format=YYYMMDD</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs sh">YYYYMMDD=<span class="hljs-string">&quot;20210315&quot;</span><br>Next_day=$(<span class="hljs-built_in">date</span> +%Y%m%d -d <span class="hljs-string">&quot;<span class="hljs-variable">$YYYYMMDD</span> + 1 day&quot;</span>)<br><span class="hljs-comment"># 20210316</span><br>Next_day=$(<span class="hljs-built_in">date</span> +%Y-%m-%d -d <span class="hljs-string">&quot;<span class="hljs-variable">$YYYYMMDD</span> + 1 day&quot;</span>)<br><span class="hljs-comment"># 2021-03-16</span><br>Next_day=$(<span class="hljs-built_in">date</span> +%Y-%m-%d_%H:%M:%S -d <span class="hljs-string">&quot;<span class="hljs-variable">$YYYYMMDD</span> + 1 day&quot;</span>)<br><span class="hljs-comment"># 2021-03-16_00:00:00</span><br>Next_day=$(<span class="hljs-built_in">date</span> +%Y-%m-%d_%H:%M:%S -d <span class="hljs-string">&quot;<span class="hljs-variable">$YYYYMMDD</span> + 1 hour&quot;</span>)<br><span class="hljs-comment"># 2021-03-15_01:00:00</span><br>Next_day=$(<span class="hljs-built_in">date</span> +%Y-%m-%d_%H:%M:%S -d <span class="hljs-string">&quot;<span class="hljs-variable">$YYYYMMDD</span> + 1 min&quot;</span>)<br><span class="hljs-comment"># 2021-03-15_00:01:00</span><br>Next_day=$(<span class="hljs-built_in">date</span> +%Y-%m-%d_%H:%M:%S -d <span class="hljs-string">&quot;<span class="hljs-variable">$YYYYMMDD</span> + 1 second&quot;</span>)<br><span class="hljs-comment"># 2021-03-15_00:00:01</span><br>Next_day=$(<span class="hljs-built_in">date</span> +%Y-%m-%d_%H:%M:%S -d <span class="hljs-string">&quot;<span class="hljs-variable">$YYYYMMDD</span> + 1 day + 1 hour + 1 min + 1 second&quot;</span>)<br><span class="hljs-comment"># 2021-03-16_01:01:01</span><br></code></pre></td></tr></table></figure><h2 id="formatyyyy-mm-dd">Format=YYYY-MM-DD</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sh">YYYYMMDD=<span class="hljs-string">&quot;2021-04-15&quot;</span><br>Next_day=$(<span class="hljs-built_in">date</span> +%Y-%m-%d_%H:%M:%S -d <span class="hljs-string">&quot;<span class="hljs-variable">$YYYYMMDD</span> + 1 day + 1 hour + 1 min + 1 second&quot;</span>)<br><span class="hljs-comment"># 2021-04-16_01:01:01</span><br></code></pre></td></tr></table></figure><h2 id="formatyyyy-mm-dd-hhmmss">Format=YYYY-MM-DD HH:MM:SS"</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sh">YYYYMMDD=<span class="hljs-string">&quot;2017-01-19 00:05:01&quot;</span><br>Next_day=$(<span class="hljs-built_in">date</span> +%Y-%m-%d_%H:%M:%S -d <span class="hljs-string">&quot;<span class="hljs-variable">$YYYYMMDD</span> + 1 day + 1 hour + 1 min + 1 second&quot;</span>)<br><span class="hljs-comment"># 2017-01-20_08:06:02</span><br></code></pre></td></tr></table></figure><h2 id="for-loop">for loop</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs sh">YYYYMMDD=<span class="hljs-string">&quot;2024-06-02&quot;</span><br><span class="hljs-keyword">for</span> gfsfile <span class="hljs-keyword">in</span> $(<span class="hljs-built_in">seq</span> 0 1 28); <span class="hljs-keyword">do</span><br>    next_day=$(<span class="hljs-built_in">date</span> +%Y%m%d%H -d <span class="hljs-string">&quot;<span class="hljs-variable">$YYYYMMDD</span> + <span class="hljs-variable">$&#123;gfsfile&#125;</span> day&quot;</span>)<br>    <span class="hljs-built_in">echo</span> <span class="hljs-variable">$next_day</span><br><span class="hljs-keyword">done</span><br></code></pre></td></tr></table></figure><h2 id="to-seperate">To seperate</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs sh">FCST_DURATION=<span class="hljs-string">&quot;000_17:00:00&quot;</span><br><br>fcst_DD=<span class="hljs-variable">$&#123;FCST_DURATION:0:3&#125;</span><br>fcst_hh=<span class="hljs-variable">$&#123;FCST_DURATION:4:2&#125;</span><br>fcst_mm=<span class="hljs-variable">$&#123;FCST_DURATION:7:2&#125;</span><br>fcst_ss=<span class="hljs-variable">$&#123;FCST_DURATION:10:2&#125;</span><br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>Bash</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Linux</tag>
      
      <tag>Bash</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>What&#39;s the rigorous definition of phase and phase transition?</title>
    <link href="/2023/05/15/Whats-the-rigorous-definition-of-phase-and-phase-transition/"/>
    <url>/2023/05/15/Whats-the-rigorous-definition-of-phase-and-phase-transition/</url>
    
    <content type="html"><![CDATA[<h1 id="whats-the-rigorous-definition-of-phase-and-phase-transition">What's the rigorous definition of phase and phase transition?</h1><p>Ref: <a href="https://physics.stackexchange.com/questions/313758/whats-the-rigorous-definition-of-phase-and-phase-transition">What's the rigorous definition of phase and phase transition?</a></p><p>From Yi-Zhuang You (尤亦庄, Everett You),</p><blockquote><p>Does this mean that gas and liquid are the same phases? Because in the phase diagram they are connected and they have the same symmetry(translation and rotation). If they are not the same phase, how to call the state in large pressure and large temperature? Liquid or gas?</p></blockquote><p>Yes. <strong>From the modern point of view, liquid and gas are in the same phase</strong>. Because, as the asker has mentioned, they are continuously connected in the phase diagram through the "supercritical" regime. By definition, two states of matter are in the same phase if they can be smoothly deformed to each other without going through phase transitions. Historically, liquid and gas are named as different phases (by mistake) because people thought that "there must be one different phase at each side of the phase transition" (as argued in Diracology's answer). But this idea is wrong.</p><p>We can not declare different phases just by observing phase transitions. Otherwise, for example, in the following phase diagram on the left, we could have declared states A and B to be in different phases, simply because they are separated by phase transitions, as we can first go out of the blue phase and then reenter it. This way of separating phases is clearly stupid. Any reasonable person would agree that A and B should belong to the same phase in this case. Now we just deform the left phase diagram to the right by squeezing the intermediate red phase to a first-order transition line, then why we suddenly get confused about whether A and B are in the same phase or not? Definitely, they should still remain in the same phase! The liquid-gas transition is indeed a situation like this. So a logically consistent definition will have to define liquid and gas as a single phase.</p><blockquote><p>Does this mean that above the critical point the transition from gas to liquid is not a phase transition, but below the critical point, the transition from gas to liquid is a phase transition?</p></blockquote><p>Yes.</p><blockquote><p>If answers to my first and second question are "yes", does this mean even in the same phase there still can have phase transition? This conclusion is so weird!</p></blockquote><p>Given the example of the above phase diagrams, <strong>one will not feel weird about the fact that there can be (first-order) phase transitions inside a single phase</strong>. In fact, <strong>first-order transitions often appear by merging two second-order transitions together (this can be explained by Landau's theory)</strong>. <strong>So going across a first-order transition is like going out of the phase and back again immediately, which definitely can happen inside a single phase</strong>. However, I am not aware of any example that continuous phase transitions can also happen within a single phase. So I conjecture that if a phase transition happens inside a phase, it must be first-order. (The conjecture is falsified by the recent discovery of "unnecessary" quantum criticalities in Bi, Senthil 2018, Jian, Xu 2019, Verresen, Bibo, Pollmann 2021. -- Edited 2021) The liquid-gas transition is one example of my conjecture.</p><blockquote><p>From the Landau's paradigm, what's the symmetry breaking and order parameter in the gas-liquid phase transition? It seems that the symmetry is same in gas and liquid. Gas-liquid phase transition must be able to be explained by Landau's paradigm but Landau's paradigm says that there must be symmetry breaking in phase transition. There is an answer. I admit that from a modern point of view phase transition is not necessary due to symmetry breaking, but I don't think that gas-liquid transition has been beyond Landau's paradigm.</p></blockquote><p><strong>No symmetry breaking is associated with the liquid-gas transition. Landau's paradigm only says that there must be spontaneous symmetry breaking in second-order transitions, but not in first-order transitions.</strong> In fact, nothing can be said about first-order transitions, because first-order transitions can happen anywhere in the phase diagram without any reason. The liquid-gas transition is indeed a case like this.</p><p>Even though the liquid-gas transition is not a symmetry breaking transition, it can still be described within Landau's paradigm phenomenologically (who says that Landau's theory only applies to symmetry breaking transitions?). We can introduce the density <span class="math inline">\(\rho\)</span> of the fluid as the order parameter. Because no symmetry is acting on this order parameter, so there is no symmetry reason to forbid odd-order terms like <span class="math inline">\(\rho, \rho^3, ...\)</span> to appear in Landau's free energy. However the first order term can always be absorbed by redefining the order parameter with a shift <span class="math inline">\(\rho --&gt; \rho 0\)</span> , then the Landau free energy takes the general form of,</p><p><span class="math inline">\(F = F0 + a\rho^2 + b\rho^3 + c\rho^4 + ...\)</span></p><p>First-order transition happens by driving the parameter <span class="math inline">\(a\)</span> to <span class="math inline">\(a &lt; 9b^2/32c\)</span></p><p>From this example, we can see that (within Landau's paradigm) if a phase transition happens without breaking any symmetry, it must be first-order. Again the liquid-gas transition is one such example.</p><blockquote><p>So if given one phase, we firstly find the symmetry is same in this phase and then check several order parameters also same in this phase. However, how do you prove you must not be able to construct some weird order parameters such that in one part of this phase is zero and in another part of this phase is nonzero? For example, in a solid phase of water which has the same crystal structure, how to prove any order parameter that you can construct will not be zero in one part of the phase and nonzero in another part?</p></blockquote><p>Indeed, <strong>you can never rule out the possibility that some weird order parameter is hiding there to further divide the phase into more phases.</strong> That is actually why the solid phase of water is divided into so many different crystal phases. Each crystal structure is associated with a different symmetry-breaking pattern. Sometimes the symmetries are just so complicated that you may miss one or two of them if you are not careful enough. In that case, you will also miss the order parameters associated with the missing symmetry, until you see a specific heat anomaly in the experiment where you did not expect, then you start to realize that oh there is a missing order parameter that actually changes across this transition, and one needs to add some additional symmetry to explain it. This is actually the typical way that physicists work every day, they never figure out the full classification of phases until they see the evidence for new phases and phase transitions. I think this is also the fun part of condensed matter physics: there are always new phases of matter waiting for us to discover.</p><h2 id="more">More</h2><ol type="1"><li>In <a href="https://en.wikipedia.org/wiki/Ginzburg%E2%80%93Landau_theory">wiki</a>, Based on Landau's previously established theory of <strong>second-order phase transitions,</strong> ...</li></ol>]]></content>
    
    
    <categories>
      
      <category>Physics</category>
      
    </categories>
    
    
    <tags>
      
      <tag>phase transition</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ERA5 dataset (2) contains invariant variables</title>
    <link href="/2023/05/11/ERA5-2-invariant-variables/"/>
    <url>/2023/05/11/ERA5-2-invariant-variables/</url>
    
    <content type="html"><![CDATA[<h1 id="era5-dataset-2-contains-invariant-variables">ERA5 dataset (2) contains invariant variables</h1><p><a href="https://forum.mmm.ucar.edu/threads/error-while-running-real-exe-with-era5-data-in-wrf-4-3-3.11500/">Post</a> <a href="https://rda.ucar.edu/datasets/ds633.0/dataaccess/">Downlaod</a> Ref: <a href="https://dreambooker.site/2017/12/20/initializing-the-wrf-model-with-ecmwf-era-interim-reanalysis/#/plpy">Initializing the WRF model with ECMWF ERA-Interim reanalysis</a></p><blockquote><p>I am suspicious that you don't have the file that contains invariant variables, especially landmask and terrain height, which are two important variables for WRF/WPS.</p></blockquote><blockquote><p>Please let me know if I am wrong. Otherwise, please download the following two files (from NCAR CISL)</p></blockquote><blockquote><p>e5.oper.invariant.128_172_lsm.regn320sc.2016010100_2016010100.grb e5.oper.invariant.128_129_z.regn320sc.2016010100_2016010100.grb</p></blockquote><blockquote><p>These files are not 'built-in' files. You have to download them, then go through the ungrib and metgrid processes.</p></blockquote><blockquote><p>Note that the two files need to be ungribbed separately (with start_date and end_date = '2016-01-01_00:00:00', and prefix = 'FILE2' in &amp;unribThese files</p></blockquote><blockquote><p>Then rename FILE2:2016-01-01_00 to be FILE2, and set <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs sh">&amp;metgrid<br>fg_name = <span class="hljs-string">&#x27;FILE1&#x27;</span>,<br>io_form_metgrid = 2,<br>constants_name = <span class="hljs-string">&#x27;./FILE2&#x27;</span><br></code></pre></td></tr></table></figure> From here you can continue to run metgrid.exe.</p></blockquote><h2 id="download">Download</h2><p><a href="https://rda.ucar.edu/datasets/ds633.0/dataaccess/">Downlaod</a></p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-meta">#!/usr/bin/env csh</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment"># c-shell script to download selected files from rda.ucar.edu using Wget</span><br><span class="hljs-comment"># NOTE: if you want to run under a different shell, make sure you change</span><br><span class="hljs-comment">#       the &#x27;set&#x27; commands according to your shell&#x27;s syntax</span><br><span class="hljs-comment"># after you save the file, don&#x27;t forget to make it executable</span><br><span class="hljs-comment">#   i.e. - &quot;chmod 755 &lt;name_of_script&gt;&quot;</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment"># Experienced Wget Users: add additional command-line flags to &#x27;opts&#x27; here</span><br><span class="hljs-comment">#   Use the -r (--recursive) option with care</span><br><span class="hljs-comment">#   Do NOT use the -b (--background) option - simultaneous file downloads</span><br><span class="hljs-comment">#       can cause your data access to be blocked</span><br><span class="hljs-built_in">set</span> opts = <span class="hljs-string">&quot;-N&quot;</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment"># Check wget version.  Set the --no-check-certificate option</span><br><span class="hljs-comment"># if wget version is 1.10 or higher</span><br><span class="hljs-built_in">set</span> v = `wget -V |grep <span class="hljs-string">&#x27;GNU Wget &#x27;</span> | <span class="hljs-built_in">cut</span> -d <span class="hljs-string">&#x27; &#x27;</span> -f 3`<br><span class="hljs-built_in">set</span> a = `<span class="hljs-built_in">echo</span> <span class="hljs-variable">$v</span> | <span class="hljs-built_in">cut</span> -d <span class="hljs-string">&#x27;.&#x27;</span> -f 1`<br><span class="hljs-built_in">set</span> b = `<span class="hljs-built_in">echo</span> <span class="hljs-variable">$v</span> | <span class="hljs-built_in">cut</span> -d <span class="hljs-string">&#x27;.&#x27;</span> -f 2`<br><span class="hljs-keyword">if</span>(100 * <span class="hljs-variable">$a</span> + <span class="hljs-variable">$b</span> &gt; 109) <span class="hljs-keyword">then</span><br>  <span class="hljs-built_in">set</span> cert_opt = <span class="hljs-string">&quot;--no-check-certificate&quot;</span><br><span class="hljs-keyword">else</span><br>  <span class="hljs-built_in">set</span> cert_opt = <span class="hljs-string">&quot;&quot;</span><br>endif<br><br><span class="hljs-built_in">set</span> filelist= ( \<br>  https://data.rda.ucar.edu/ds633.0/e5.oper.invariant/197901/e5.oper.invariant.128_026_cl.ll025sc.1979010100_1979010100.grb  \<br>  https://data.rda.ucar.edu/ds633.0/e5.oper.invariant/197901/e5.oper.invariant.128_027_cvl.ll025sc.1979010100_1979010100.grb  \<br>  https://data.rda.ucar.edu/ds633.0/e5.oper.invariant/197901/e5.oper.invariant.128_028_cvh.ll025sc.1979010100_1979010100.grb  \<br>  https://data.rda.ucar.edu/ds633.0/e5.oper.invariant/197901/e5.oper.invariant.128_029_tvl.ll025sc.1979010100_1979010100.grb  \<br>  https://data.rda.ucar.edu/ds633.0/e5.oper.invariant/197901/e5.oper.invariant.128_030_tvh.ll025sc.1979010100_1979010100.grb  \<br>  https://data.rda.ucar.edu/ds633.0/e5.oper.invariant/197901/e5.oper.invariant.128_043_slt.ll025sc.1979010100_1979010100.grb  \<br>  https://data.rda.ucar.edu/ds633.0/e5.oper.invariant/197901/e5.oper.invariant.128_074_sdfor.ll025sc.1979010100_1979010100.grb  \<br>  https://data.rda.ucar.edu/ds633.0/e5.oper.invariant/197901/e5.oper.invariant.128_129_z.ll025sc.1979010100_1979010100.grb  \<br>  https://data.rda.ucar.edu/ds633.0/e5.oper.invariant/197901/e5.oper.invariant.128_160_sdor.ll025sc.1979010100_1979010100.grb  \<br>  https://data.rda.ucar.edu/ds633.0/e5.oper.invariant/197901/e5.oper.invariant.128_161_isor.ll025sc.1979010100_1979010100.grb  \<br>  https://data.rda.ucar.edu/ds633.0/e5.oper.invariant/197901/e5.oper.invariant.128_162_anor.ll025sc.1979010100_1979010100.grb  \<br>  https://data.rda.ucar.edu/ds633.0/e5.oper.invariant/197901/e5.oper.invariant.128_163_slor.ll025sc.1979010100_1979010100.grb  \<br>  https://data.rda.ucar.edu/ds633.0/e5.oper.invariant/197901/e5.oper.invariant.128_172_lsm.ll025sc.1979010100_1979010100.grb  \<br>  https://data.rda.ucar.edu/ds633.0/e5.oper.invariant/197901/e5.oper.invariant.228_007_dl.ll025sc.1979010100_1979010100.grb  \<br>)<br><span class="hljs-keyword">while</span>(<span class="hljs-variable">$#filelist</span> &gt; 0)<br>  <span class="hljs-built_in">set</span> syscmd = <span class="hljs-string">&quot;wget <span class="hljs-variable">$cert_opt</span> <span class="hljs-variable">$opts</span> <span class="hljs-variable">$filelist</span>[1]&quot;</span><br>  <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;<span class="hljs-variable">$syscmd</span> ...&quot;</span><br>  <span class="hljs-variable">$syscmd</span><br>  <span class="hljs-built_in">shift</span> filelist<br>end<br></code></pre></td></tr></table></figure><p>Two are important,</p><p>terrain height, &gt; e5.oper.invariant.128_129_z.ll025sc.1979010100_1979010100.grb</p><p>landmask, &gt; e5.oper.invariant.128_172_lsm.ll025sc.1979010100_1979010100.grb</p><h2 id="ungrib">Ungrib</h2><h3 id="source-wrf-env">source WRF env</h3><h3 id="soft-link">soft-link</h3><ol type="1"><li>link_grib.csh</li><li>namelist.wps</li><li>ungrib.exe</li><li>Vtable.ERA-interim.pl as Vtable</li><li>int2nc.exe</li></ol><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs sh">&amp;share<br> wrf_core = <span class="hljs-string">&#x27;ARW&#x27;</span>,<br> max_dom = 1,<br> start_date = <span class="hljs-string">&#x27;1979-01-01_00:00:00&#x27;</span>,<br> end_date   = <span class="hljs-string">&#x27;1979-01-01_00:00:00&#x27;</span>,<br> interval_seconds = 10800,<br> io_form_geogrid = 2<br>/<br><br>&amp;ungrib<br> out_format = <span class="hljs-string">&#x27;WPS&#x27;</span>,<br> prefix = <span class="hljs-string">&#x27;FIX&#x27;</span>,<br>/<br></code></pre></td></tr></table></figure><p>and link_grib.csh</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sh">$ ./link_grib.csh e5.oper.invariant.*<br>GRIBFILE.AAA -&gt; e5.oper.invariant.128_129_z.ll025sc.1979010100_1979010100.grb<br>GRIBFILE.AAB -&gt; e5.oper.invariant.128_172_lsm.ll025sc.1979010100_1979010100.grb<br></code></pre></td></tr></table></figure><p>then ungrib.exe</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh">$ ./ungrib.exe<br>FIX:1979-01-01_00<br></code></pre></td></tr></table></figure><h3 id="check-results">check results</h3><p>Plot Intermediate Files in netCDF Format Using <strong>int2nc.exe (Found in WPS/util/)</strong> <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sh">$ ./int2nc.exe FIX:1979-01-01_00<br>FIX:1979-01-01_00.nc<br>$ ncview FIX:1979-01-01_00.nc<br></code></pre></td></tr></table></figure></p><h2 id="for-metgrid.exe">For metgrid.exe</h2><p>namelist.wps is written as</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs sh">&amp;share<br> start_date = <span class="hljs-string">&#x27;2015-08-07_00:00:00&#x27;</span>,<span class="hljs-string">&#x27;2015-08-07_00:00:00&#x27;</span>,<br> end_date   = <span class="hljs-string">&#x27;2015-08-08_12:00:00&#x27;</span>,<span class="hljs-string">&#x27;2015-08-08_12:00:00&#x27;</span>,<br>&amp;metgrid<br> fg_name = <span class="hljs-string">&#x27;ERA5&#x27;</span>,<br> constants_name = <span class="hljs-string">&#x27;/xxx/xxx/FIX:1979-01-01_00&#x27;</span>,<br> io_form_metgrid = 2,<br></code></pre></td></tr></table></figure><p>Finally, <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">$ ./metgrid.exe<br></code></pre></td></tr></table></figure></p>]]></content>
    
    
    <categories>
      
      <category>NWP</category>
      
    </categories>
    
    
    <tags>
      
      <tag>WRF</tag>
      
      <tag>WPS</tag>
      
      <tag>MPAS</tag>
      
      <tag>IC/BC</tag>
      
      <tag>ERA5</tag>
      
      <tag>ECMWF</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>gdb debugger</title>
    <link href="/2023/05/11/gdb/"/>
    <url>/2023/05/11/gdb/</url>
    
    <content type="html"><![CDATA[<h1 id="gdb-debugger">gdb debugger</h1><p>GDB stands for GNU Project Debugger. GDB（GNU Debugger）是UNIX及UNIX-like下的強大調試工具，可以調試ada, c, c++, asm, minimal, d, fortran, objective-c, go, java,pascal等語言。本文以C程序為例如，介紹GDB啟動調試的多種方式。</p><ol type="1"><li>Compile your code with debugging option</li></ol><h2 id="launch-gdb">Launch gdb</h2><p>In general, it is <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">gdb ./wrf.exe<br></code></pre></td></tr></table></figure> but most of time, it is by mpirun, <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">mpirun -n 1 gdb ./wrf.exe<br></code></pre></td></tr></table></figure></p><p>Sample output, <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs sh">GNU gdb (GDB) Red Hat Enterprise Linux 7.6.1-110.el7<br>Copyright (C) 2013 Free Software Foundation, Inc.<br>License GPLv3+: GNU GPL version 3 or later &lt;http://gnu.org/licenses/gpl.html&gt;<br>This is free software: you are free to change and redistribute it.<br>There is NO WARRANTY, to the extent permitted by law.  Type <span class="hljs-string">&quot;show copying&quot;</span><br>and <span class="hljs-string">&quot;show warranty&quot;</span> <span class="hljs-keyword">for</span> details.<br>This GDB was configured as <span class="hljs-string">&quot;x86_64-redhat-linux-gnu&quot;</span>.<br>For bug reporting instructions, please see:<br>&lt;http://www.gnu.org/software/gdb/bugs/&gt;...<br>Reading symbols from /xxx/WRFV4.4_debug/main/wrf.exe...done.<br>(gdb)<br></code></pre></td></tr></table></figure></p><h2 id="commands">commands</h2><p>Here are few useful commands to get started with gdb for the above example: <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs sh">run or r –&gt; executes the program from start to end.<br><span class="hljs-built_in">break</span> or b –&gt; sets breakpoint on a particular line.<br><span class="hljs-built_in">disable</span> -&gt; <span class="hljs-built_in">disable</span> a breakpoint.<br><span class="hljs-built_in">enable</span> –&gt; <span class="hljs-built_in">enable</span> a disabled breakpoint.<br>delete -&gt; delete a breakpoint by index 1,2,3,...<br>next or n -&gt; executes next line of code, but don’t dive into <span class="hljs-built_in">functions</span>.<br>step –&gt; go to next instruction, diving into the <span class="hljs-keyword">function</span>.<br>list or l –&gt; displays the code.<br><span class="hljs-built_in">print</span> or p –&gt; used to display the stored value.<br>quit or q –&gt; exits out of gdb.<br>clear –&gt; to clear all breakpoints.<br><span class="hljs-built_in">continue</span> –&gt; <span class="hljs-built_in">continue</span> normal execution.<br>reverse-next -&gt; Run the program backward<br>reverse-step -&gt; Run the program backward<br>reverse-continue -&gt; Run the program backward<br></code></pre></td></tr></table></figure></p><h2 id="movement">movement</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sh">up (n)<br>down (n)<br><span class="hljs-built_in">print</span> or p<br></code></pre></td></tr></table></figure><h2 id="single-step-execution--next">Single step execution -next</h2><p>The next command (can be abbreviated as n) is used to continue to execute the next statement after the program is stopped, assuming that debugging has been started, and stop at line 10, if you want to continue execution, use n to execute the next statement, if later Keeping up with the number num, it means that the instruction is executed num times, and the effect of continuing to execute n lines is achieved.</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs sh">(gdb) b 10<br>Breakpoint 1 at 0x405b26: file wrf.f90, line 10.<br>(gdb) run<br>Starting program: /xxx/./wrf.exe <br>[Thread debugging using libthread_db enabled]<br>Using host libthread_db library <span class="hljs-string">&quot;/lib64/libthread_db.so.1&quot;</span>.<br><br>Breakpoint 1, wrf () at wrf.f90:22<br>22        CALL wrf_init<br>Missing separate debuginfos, use: debuginfo-install ...<br>(gdb) n<br> starting wrf task            0  of            1<br>25        CALL wrf_dfi<br></code></pre></td></tr></table></figure><h2 id="step-into--step">Step into -step</h2><p>For the above situation, if we want to track the internal situation of the function, we can use the step command (which can be abbreviated as s), which can single-step trace to the inside of the function, but only if the function has debugging information and source code information.</p><h2 id="core-document">core document</h2><p>When a program core dumps, a core file may be generated, which can help us identify location problems for a large enough program. But it was proposed before that the system does not limit the generation of core files. You can use the command limit - c to view: <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sh">$ <span class="hljs-built_in">ulimit</span> -c<br>0<br>$ <span class="hljs-built_in">ulimit</span> -c unlimited  <span class="hljs-comment"># Indicates that there is no limit to the core file size</span><br></code></pre></td></tr></table></figure> Or add at the end of ~/.bashrc: ulimit -c unlimited</p><h2 id="check-breakpoints">check breakpoints</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">$ info breakpoints<br></code></pre></td></tr></table></figure><h2 id="set-breakpoints">set breakpoints</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sh">$ b 10<br>$ b main.c:10 <span class="hljs-comment"># Important</span><br>$ b Function<br></code></pre></td></tr></table></figure><h3 id="generate-breakpoints-based-on-expression-value-changes">Generate breakpoints based on expression value changes</h3><p>Sometimes we need to observe a certain value or expression to know when it has changed. At this time, we can use the watch command. For example: <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">$ watch a<br></code></pre></td></tr></table></figure> At this time, let the program continue to run. If the value of a changes, the relevant content will be printed, such as： <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sh">Hardware watchpoint 2: a<br>Old value = 12<br>New value = 11<br></code></pre></td></tr></table></figure> But here to pay attention is that the program must be running, otherwise it will appear: &gt; No symbol "a" in current context. Because the program is not running, the current context has no relevant variable information.</p><h2 id="tuitext-user-interface">TUI(Text User Interface)</h2><p>The GDB Text User Interface, TUI in short, is a terminal interface which uses the curses library to show the source file, the assembly output, the program registers and GDB commands in separate text windows. <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">$ gdb main -tui<br></code></pre></td></tr></table></figure> Sounds like what you're looking for is the callstack/backtrace. For that, just use the &gt; $ (gdb) backtrace/bt or where</p><p>command.</p><h2 id="frame">frame</h2><ol type="1"><li>According to the stack frame number or stack frame address, select the stack frame to be viewed. The syntax format is as follows: &gt; (gdb) frame spec</li><li>With the help of the following command, we can view the information stored in the current stack frame: &gt; (gdb) info frame</li></ol><h2 id="backtracebt">backtrace/bt</h2><blockquote><p>backtrace</p></blockquote><p>The command is used to print the information of all stack frames in the current debugging environment</p><h2 id="step-out-of-current-function-with-gdb">Step out of current function with GDB</h2><p>You can use the <strong>finish</strong> command. &gt; finish: Continue running until just after function in the selected stack frame returns. Print the returned value (if any). This command can be abbreviated as fin.</p><h2 id="reserse">Reserse</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sh">reverse-next -&gt; Run the program backward<br>reverse-step -&gt; Run the program backward<br>reverse-continue -&gt; Run the program backward<br></code></pre></td></tr></table></figure><h2 id="example-wrf">Example: WRF</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs sh">$ <span class="hljs-built_in">source</span> wrf_env.sh<br><br>(gdb) b solve_em.F:xxx                       <span class="hljs-comment"># try to stop before CALL first_rk_step_part1(...)</span><br>(gdb) b module_first_rk_step_part1.f90:387   <span class="hljs-comment"># try to stop before CALL surface_driver(...)</span><br>(gdb) b module_surface_driver.f90:2683       <span class="hljs-comment"># try to stop before CALL lsm(...) </span><br>(gdb) b module_sf_noahdrv.f90:1234           <span class="hljs-comment"># try to stop before Call urban(...) for WRF</span><br>(gdb) b module_sf_noahdrv.F:xxxx             <span class="hljs-comment"># try to stop before Call urban(...) for MPAS</span><br>(gdb) run<br>...<br>(gdb) n/s/p/f/bt<br></code></pre></td></tr></table></figure><h2 id="inferior-1-process-exited-normally">Inferior 1 (process ) exited normally</h2><p>That is not an error, from gdb's point of view. Your program just finished gracefully, with a return value of 0, and gdb informs you of that.</p><h2 id="what-does-no-stack-mean-in-gdb">What does <strong>no stack</strong> mean in gdb?</h2><h2 id="missing-separate-debuginfos-use-debuginfo-install-cyrus-sasl-lib-">Missing separate debuginfos, use: debuginfo-install cyrus-sasl-lib-?</h2><ol type="1"><li>Install debuginfos</li><li>$ debuginfo-install glibc</li></ol>]]></content>
    
    
    <categories>
      
      <category>gdb</category>
      
    </categories>
    
    
    <tags>
      
      <tag>debug</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ERA5 ERA5T expver dimension issue</title>
    <link href="/2023/05/07/ERA5-expver-issue/"/>
    <url>/2023/05/07/ERA5-expver-issue/</url>
    
    <content type="html"><![CDATA[<h1 id="era5-era5t-expver-dimension-issue">ERA5 ERA5T expver dimension issue</h1><p>Ref: <a href="https://confluence.ecmwf.int/display/CUSF/ERA5+CDS+requests+which+return+a+mixture+of+ERA5+and+ERA5T+data">ERA5 CDS requests which return a mixture of ERA5 and ERA5T data</a></p><p><strong>The ERA5 hourly and monthly data are made available with a 3 month delay.</strong> This means that after a month has passed, another month's worth of ERA5 data is written to the dataset.</p><p><strong>ERA5T (near real time)</strong> preliminary data are used to fill the gap between the end of the ERA5 data and 5 days before the present date. The oldest month of these is overwritten each month as new ERA5 data become available.</p><blockquote><p>It depends on time, it is <strong>expver either 1 or 5</strong>, will not exist at the same time<br />If already past 3 months' time, it will use ERA5, otherwise use ERA5T if too recent</p></blockquote><h2 id="for-example">For example,</h2><p>So as an example, say we have a current date of 15th February 2020:</p><blockquote><p>ERA5 data are currently from 1/1/1979 - 30/11/2019 (instantaneous variables) and 1/1/1979 - 1/12/2019 (00-06 UTC, accumulated variables)<br />ERA5T data (with a 5 day delay) are from 1/12/2019- 10/2/2020 (instantaneous variables) and 1/12/2019 (07-23 UTC, accumulated variables)- 10/2/2020</p></blockquote><p>For requests which return a mixture of ERA5 and ERA5T data (such as for data from the 1st of the month), instantaneous variables (e.g temperature) come from ERA5T (which has 'experiment version' of 5) while accumulated variables (fluxes, precipitation) come from both datasets with the following structure:</p><blockquote><p>00-06 UTC on 1 day of the month from <strong>ERA5 (expver 1)</strong><br />07-23 UTC on 1 day of the month (and the following dates up to 5 day from present) from <strong>ERA5T (expver 5)</strong> When these data are converted to netCDF a new dimension is created called expver containing 1 and 5. Moreover, a single time coordinate is used which covers the entire requested period.</p></blockquote><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs sh">dimensions:<br>        longitude = 1440 ;<br>        latitude = 721 ;<br>        expver = 2 ;<br>        time = 24 ;<br>variables:<br>        <span class="hljs-built_in">float</span> longitude(longitude) ;<br>                longitude:units = <span class="hljs-string">&quot;degrees_east&quot;</span> ;<br>                longitude:long_name = <span class="hljs-string">&quot;longitude&quot;</span> ;<br>        <span class="hljs-built_in">float</span> latitude(latitude) ;<br>                latitude:units = <span class="hljs-string">&quot;degrees_north&quot;</span> ;<br>                latitude:long_name = <span class="hljs-string">&quot;latitude&quot;</span> ;<br>        int expver(expver) ;<br>                expver:long_name = <span class="hljs-string">&quot;expver&quot;</span> ;<br>        int time(time) ;<br>                time:units = <span class="hljs-string">&quot;hours since 1900-01-01 00:00:00.0&quot;</span> ;<br>                time:long_name = <span class="hljs-string">&quot;time&quot;</span> ;<br>                time:calendar = <span class="hljs-string">&quot;gregorian&quot;</span> ;<br>        short tp(time, expver, latitude, longitude) ;<br>                tp:scale_factor = 9.06276558810304e-07 ;<br>                tp:add_offset = 0.0296950577259784 ;<br>                tp:_FillValue = -32767s ;<br>                tp:missing_value = -32767s ;<br>                tp:units = <span class="hljs-string">&quot;m&quot;</span> ;<br>                tp:long_name = <span class="hljs-string">&quot;Total precipitation&quot;</span> ;<br>data:<br><br> expver = 5, 1 ;<br> ...<br>&#125;<br></code></pre></td></tr></table></figure><p>Both expver dimensions use the full time extent of time coordinate but the expver 1 data only covers the first 7 timesteps, the remaining timesteps are 'padded' with empty fields. For the expver 5 data, the first 7 timesteps are padded with empty fields, with the remaining timesteps coming from the ERA5T data.</p><p>When the last ERA5 data are released, <strong>they will overwrite the ERA5T data for the entire month and for accumulated variables for 00-06 in next month.</strong> This process will be repeated each month.</p>]]></content>
    
    
    <categories>
      
      <category>NWP</category>
      
    </categories>
    
    
    <tags>
      
      <tag>WRF</tag>
      
      <tag>WPS</tag>
      
      <tag>MPAS</tag>
      
      <tag>IC/BC</tag>
      
      <tag>ERA5</tag>
      
      <tag>ECMWF</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Git cherry-pick</title>
    <link href="/2023/05/07/Git-cherry-pick/"/>
    <url>/2023/05/07/Git-cherry-pick/</url>
    
    <content type="html"><![CDATA[<h1 id="git-cherry-pick">Git cherry-pick</h1><p>After switching to the master, use the cherry-pick command to take out the submission of "adding commit instructions", and then add it to the master.</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs sh">$ git checkout master<br>Switched to branch <span class="hljs-string">&#x27;master&#x27;</span><br>$ git cherry-pick 99daed2<br>error: could not apply 99daed2... commit<br>hint: after resolving the conflicts, mark the corrected paths<br>hint: with <span class="hljs-string">&#x27;git add &lt;paths&gt;&#x27;</span> or <span class="hljs-string">&#x27;git rm &lt;paths&gt;&#x27;</span><br>hint: and commit the result with <span class="hljs-string">&#x27;git commit&#x27;</span><br></code></pre></td></tr></table></figure><p>If a conflict occurs, please open sample.txt, modify the conflicting part and then submit.</p><h2 id="whats-the-simplest-way-to-list-conflicted-files-in-git">What's the simplest way to list conflicted files in Git?</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># # Search for all conflicting files.</span><br>git diff --name-only --diff-filter=U --relative<br><br><span class="hljs-comment"># Search for all conflicting files.</span><br>grep -lr <span class="hljs-string">&quot;&lt;&lt;&lt;&lt;&lt;&lt;&lt; HEAD&quot;</span> ./*<br><br></code></pre></td></tr></table></figure><h2 id="resolve-easyobvious-conflicts">Resolve easy/obvious conflicts</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment">#At this point you may review each files. If solution is to accept local/our version, run:</span><br>git checkout --ours PATH/FILE<br><br><span class="hljs-comment">#If solution is to accept remote/other-branch version, run:</span><br>git checkout --theirs PATH/FILE<br><br><span class="hljs-comment">#If you have multiple files and you want to accept local/our version, run:</span><br>grep -lr <span class="hljs-string">&#x27;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&#x27;</span> . | xargs git checkout --ours<br><br><span class="hljs-comment">#If you have multiple files and you want to accept remote/other-branch version, run:</span><br>grep -lr <span class="hljs-string">&#x27;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&#x27;</span> . | xargs git checkout --theirs<br></code></pre></td></tr></table></figure><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh">$ git add sample.txt<br>$ git commit<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>Git</category>
      
    </categories>
    
    
    <tags>
      
      <tag>git cherry-pick</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Git: solve conflicted files</title>
    <link href="/2023/05/07/Git-conflicts/"/>
    <url>/2023/05/07/Git-conflicts/</url>
    
    <content type="html"><![CDATA[<h1 id="git-solve-conflicted-files">Git: solve conflicted files</h1><h2 id="whats-the-simplest-way-to-list-conflicted-files-in-git">What's the simplest way to list conflicted files in Git?</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># # Search for all conflicting files.</span><br>git diff --name-only --diff-filter=U --relative<br><br><span class="hljs-comment"># Search for all conflicting files.</span><br>grep -lr <span class="hljs-string">&quot;&lt;&lt;&lt;&lt;&lt;&lt;&lt; HEAD&quot;</span> ./*<br><br></code></pre></td></tr></table></figure><h2 id="resolve-easyobvious-conflicts">Resolve easy/obvious conflicts</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment">#At this point you may review each files. If solution is to accept local/our version, run:</span><br>git checkout --ours PATH/FILE<br><br><span class="hljs-comment">#If solution is to accept remote/other-branch version, run:</span><br>git checkout --theirs PATH/FILE<br><br><span class="hljs-comment">#If you have multiple files and you want to accept local/our version, run:</span><br>grep -lr <span class="hljs-string">&#x27;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&#x27;</span> . | xargs git checkout --ours<br><br><span class="hljs-comment">#If you have multiple files and you want to accept remote/other-branch version, run:</span><br>grep -lr <span class="hljs-string">&#x27;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&#x27;</span> . | xargs git checkout --theirs<br></code></pre></td></tr></table></figure><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh">$ git add sample.txt<br>$ git commit<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>Git</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Github</tag>
      
      <tag>git commit</tag>
      
      <tag>git conflicts</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Intel OneAPI</title>
    <link href="/2023/05/06/Intel_OneAPI/"/>
    <url>/2023/05/06/Intel_OneAPI/</url>
    
    <content type="html"><![CDATA[<h1 id="intel-oneapi">Intel OneAPI</h1><p>The Intel oneAPI HPC Toolkit is a comprehensive suite of development tools that make it fast and easy to build modern code that gets maximum performance out of the newest Intel® processors. This toolkit enables high performance computing on clusters or individual nodes with flexible options including optimal performance on a CPU or GPU.</p><p>Intel oneAPI 是一種統一的跨架構的程式設計模型，提供了CPU、GPU、FPGA、專用加速器的產品。</p><p>2020年12月，英特爾發布了oneAPI軟體開發套裝，免費、並且取代了之前需要許可(購買)的Intel Parallel Studio。</p><p>Intel oneAPI toolkits包含了六大工具包：</p><ul><li>Intel® oneAPI Base Toolkit(包含了Intel Parallel Studio中常用的軟體以及 icc、MPI、DPCPP、MKL等)</li><li>Intel® oneAPI HPC Toolkit(提供可擴充的快速C ++、Fortran、OpenMP和MPI應用程式)</li><li>Intel® oneAPI IoT Toolkit</li><li>Intel® oneAPI Rendering Toolkit</li><li>Intel® AI Analytics Toolkit</li><li>Intel® Distribution of OpenVINO™ Toolkit</li></ul><div class="note note-primary">            <p><strong>對我們來說 Intel® oneAPI Base Toolkit + Intel® oneAPI HPC Toolkit 基本上就包含Intel Parallel Studio XE的功能了，關鍵還免費。</strong></p>          </div><p>Intel OneAPI Toolkit 使用一流的編譯器, 效能庫, 框架以及分析和偵錯工具在CPU 和XPU 上分析和優化高效能, 跨架構應用程式. 我們的伺服器上安裝了Base Toolkit 和HPC Toolkit, 包含ic​​c compiler, debugger, mkl 數學庫, intel MPI, vtune 等軟體, 請參閱官網查看完整軟體清單及使用方法。</p><p>Intel® oneAPI Base Toolkit: 「Intel® oneAPI基本工具包」（Base Kit）是一套核心工具和函式庫，用於跨各種體系結構(CPU、GPU和FPGA)開發高效能、以資料為中心的應用程式. 它採用了業界領先的C++編譯器，實作了SYCL*，這是C++在異質運算上的發展。可以使用其他工具包來補充基本工具包,比如Intel® HPC Toolkit(包括Intel® Fortran編譯器， OpenMP* GPU offload和Intel® MPI庫)，Intel® Rendering Toolkit(渲染和光線跟踪，用於高保真可視化應用程式)</p><p>Intel® HPC Toolkit：Build, analyze, and scale applications across shared- and distributed-memory computing systems. 高效能運算（HPC）是人工智慧、機器學習和深度學習應用程式的核心。 「Intel® HPC Toolkit」（HPC工具包）利用向量化、多執行緒、多節點並行化和記憶體最佳化的最新技術， 為開發人員提供建置、分析、最佳化和擴展HPC應用程式所需的功能。 此工具包是「Intel® oneAPI Base Toolkit」的附加元件，是實現完整功能所必需的。它包括功能強大的以數據為中心的庫、高級分析工具和Intel® Python*發行版，以實現核心Python數值、科學和機器學習套件的近乎本地程式碼效能。</p><p>原來用來編譯intel程式的「Intel全家桶」指的是Intel Parallel Studio XE，裡面整合了C/C++/Fortran語言的編譯器（分別是icc、icpc、ifort）、MKL數學函式庫及各種高效調試工具，甚至還有Intel MPI， 可以說是編譯量化軟體最常用的一套「裝備」。然而從2021年開始Intel不再提供舊版Parallel Studio XE下載頁面，而是改成了（或稱升級成了）oneAPI， oneapi包括上述6個套件。</p><p>但Base Toolkit套件裡含icc、icpc編譯器和MKL函式庫，卻不含ifort。而HPC Toolkit包裡含icc、icpc、ifort，卻不含MKL庫。顯然下載任一個包都無法完全取代以前的「全家桶」。 因此平台採用安裝Intel Base Toolkit和HPC Toolkit方法，來取代先前的Parallel Studio XE。</p><p>Intel® VTune™ Profiler:發現並最佳化CPU、GPU和FPGA系統的效能瓶頸。</p><h2 id="command-line-download">Command Line Download</h2><p>Command Line Installation Parameters</p><p>Get latest version <a href="https://www.intel.com/content/www/us/en/developer/tools/oneapi/hpc-toolkit-download.html?operatingsystem=linux&amp;distributions=offline" class="uri">https://www.intel.com/content/www/us/en/developer/tools/oneapi/hpc-toolkit-download.html?operatingsystem=linux&amp;distributions=offline</a></p><ul><li>下載兩個 Linux 的 sh 檔：<ul><li><a href="https://www.intel.com/content/www/us/en/developer/tools/oneapi/base-toolkit-download.html?packages=oneapi-toolkit&amp;oneapi-toolkit-os=linux&amp;oneapi-lin=offline">Get the Intel® oneAPI Base Toolkit</a></li><li><a href="https://www.intel.com/content/www/us/en/developer/tools/oneapi/hpc-toolkit-download.html?packages=hpc-toolkit&amp;hpc-toolkit-os=linux&amp;hpc-toolkit-lin=offline">Get Intel® oneAPI HPC Toolkit</a></li></ul></li></ul><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs sh">wget https://registrationcenter-download.intel.com/akdlm/IRC_NAS/7deeaac4-f605-4bcf-a81b-ea7531577c61/l_BaseKit_p_2023.1.0.46401_offline.sh<br>wget https://registrationcenter-download.intel.com/akdlm/IRC_NAS/1ff1b38a-8218-4c53-9956-f0b264de35a4/l_HPCKit_p_2023.1.0.46346_offline.sh<br><br>sh ./l_BaseKit_p_2023.1.0.46401_offline.sh (**Install dependence**)<br>sh ./l_HPCKit_p_2023.1.0.46346_offline.sh<br></code></pre></td></tr></table></figure><p>For BaseKit, there is no dependence needs <strong>if doesn't install Intel Advisor and Intel VTune</strong>,</p><ul><li><a href="https://archlinux.org/packages/extra/x86_64/intel-oneapi-basekit/">Dependencies (10)</a></li><li>Intel Advisor，它可以幫助開發者對程式進行並行處理的優化，提高程式的性能 <a href="https://www.toolify.ai/tw/hardwaretw/intel-advisor%E7%A8%8B%E5%BC%8F%E5%84%AA%E5%8C%96%E7%9A%84%E5%BC%B7%E5%A4%A7%E5%B7%A5%E5%85%B7-3170948">link</a></li><li>Intel VTune 是intel公司開發的一款強大的效能瓶頸分析軟體，能幫助開發者找出效能影響因素</li></ul><p><img src="https://i.imgur.com/5bQ4Nch.png" width="400" /></p><p>or,</p><p>download list: <a href="https://get.hpc.dev/vault/intel/" class="uri">https://get.hpc.dev/vault/intel/</a></p><p>or,</p><p>Direct download,</p><ul><li>intel-oneapi-base-toolkit-2025.0.0.885_offline.sh (2.4GB)</li><li>intel-oneapi-hpc-toolkit-2025.0.0.825_offline.sh (2.4GB)</li></ul><h3 id="installation-instructions">Installation Instructions</h3><p>The initial download is for the installer application files only. The installer will acquire all the tools during the installation process.</p><ol type="1"><li>Step 1: From the console, locate the downloaded install file.</li><li>Step 2:<ol type="1"><li>Use $ sudo sh ./<installer>.sh to launch the GUI Installer as root.</li><li>Optionally, use $ sh ./<installer>.sh to launch the GUI Installer as current user.</li></ol></li><li>Step 3: Follow the instructions in the installer.</li><li>Step 4: Explore the Get <a href="https://www.intel.com/content/www/us/en/develop/documentation/get-started-with-intel-oneapi-hpc-linux/top.html">Started Guide</a>.</li></ol><h3 id="option-get-started-with-the-intel-oneapi-hpc-toolkit-for-linux">(Option) Get Started with the Intel oneAPI HPC Toolkit for Linux</h3><p>Although the <code>CMake</code> and <code>pkg-config</code> build tools are not required by the oneAPI tools and toolkits, many oneAPI samples are provided as <code>CMake</code> projects and require <code>CMake</code> to build them. In some cases <code>pkg-config</code> is necessary to locate libraries needed to complete a build of the application.</p><p>The Intel compilers utilize the existing GNU build toolchains to provide a complete C/C++ development environment. If your distribution of Linux does not include the complete suite of GNU development tools, you need to install these tools.</p><p>To install <code>CMake</code>, <code>pkg-config</code>, and the GNU development tools on your Linux system, open a terminal session and enter the following commands:</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-built_in">sudo</span> apt update<br><span class="hljs-built_in">sudo</span> apt -y install cmake pkg-config build-essential<br></code></pre></td></tr></table></figure><p>Verify the installation by displaying the installation location with this command: <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-built_in">which</span> cmake pkg-config make gcc g++<br></code></pre></td></tr></table></figure></p><h3 id="install-on-cluster-no-sudo">Install on cluster (no sudo)</h3><p>Online/Offline Installer:</p><ul><li><a href="https://www.intel.com/content/www/us/en/docs/oneapi/installation-guide-linux/2025-0/online-offline-installer-003.html#HPC-ONLINE-OFFLINE">Online/Offline Installer</a></li><li>If you do not have root (administrative or sudo) permissions, you can install the toolkit only in <strong>your home directory</strong> or <strong>a user-specific location</strong>. Refer to user installation commands in this document.<ul><li><code>--silent</code> (Run the installer in non-interactive (silent) mode.)</li><li><code>--install-dir</code> (Silent, default installation directory, Supported in silent mode. Customize the installation directory.)</li></ul></li><li><a href="https://www.intel.com/content/www/us/en/docs/oneapi/installation-guide-linux/2025-0/command-line-options.html#BASE-COMMAND-LINE-OPTIONS">Command Line Options</a></li></ul><div class="note note-primary">            <p>/home/wpsze/intel/oneapi/</p>          </div><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs sh"> $ sh ./l_BaseKit_p_2023.1.0.46401_offline.sh <br>Extract l_BaseKit_p_2023.1.0.46401_offline to /home/wpsze/intel/l_BaseKit_p_2023.1.0.46401_offline...<br>[######################################################################################################################################################################]<br>Extract l_BaseKit_p_2023.1.0.46401_offline completed!<br>Remove extracted files: /home/wpsze/intel/l_BaseKit_p_2023.1.0.46401_offline...<br></code></pre></td></tr></table></figure><div class="group-image-container"><div class="group-image-row"><div class="group-image-wrap"><img src="https://i.imgur.com/ppnqwDo.png" alt="1" /></div><div class="group-image-wrap"><img src="https://i.imgur.com/3C7FkYU.png" alt="2" /></div></div></div><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs sh"> $ bash l_HPCKit_p_2023.1.0.46346_offline.sh <br>Extract l_HPCKit_p_2023.1.0.46346_offline to /home/wpsze/intel/l_HPCKit_p_2023.1.0.46346_offline...<br>[#####################################################################################################################################################################]<br>Extract l_HPCKit_p_2023.1.0.46346_offline completed!<br>Remove extracted files: /home/wpsze/intel/l_HPCKit_p_2023.1.0.46346_offline...<br></code></pre></td></tr></table></figure><div class="group-image-container"><div class="group-image-row"><div class="group-image-wrap"><img src="https://i.imgur.com/DDb4wOZ.png" alt="1" /></div><div class="group-image-wrap"><img src="https://i.imgur.com/6JzxBe4.png" alt="2" /></div><div class="group-image-wrap"><img src="https://i.imgur.com/i1WGV00.png" alt="3" /></div></div><div class="group-image-row"><div class="group-image-wrap"><img src="https://i.imgur.com/UvVfnH8.png" alt="4" /></div><div class="group-image-wrap"><img src="https://i.imgur.com/EFY2UFk.png" alt="5" /></div><div class="group-image-wrap"><img src="https://i.imgur.com/DfGTm66.png" alt="6" /></div></div><div class="group-image-row"><div class="group-image-wrap"><img src="https://i.imgur.com/j0YSOSe.png" alt="7" /></div></div></div><h3 id="compiler-對照表">Compiler 對照表</h3><ul><li><a href="https://man.twcc.ai/@TWCC-III-manual/SkgZUHhi_">Compiler 對照表</a></li></ul><table><thead><tr class="header"><th></th><th><strong>GNU</strong></th><th><strong>Intel</strong></th><th><strong>MVAPICH2</strong></th><th><strong>OpenMPI</strong></th><th><strong>IntelMPI</strong></th></tr></thead><tbody><tr class="odd"><td><strong>C</strong></td><td>gcc</td><td>icc/icx</td><td>mpicc</td><td>mpicc</td><td>mpiicc</td></tr><tr class="even"><td><strong>C++</strong></td><td>g++</td><td>icpc/icpx</td><td>mpic++/ mpicxx</td><td>mpiCC/mpic++/mpicxx</td><td>mpiicpc</td></tr><tr class="odd"><td><strong>Fortran</strong></td><td>g77/gfortran</td><td>ifort/ifx</td><td>mpif77/mpif90/mpifort</td><td>mpifort/mpif77/mpif90</td><td>mpiifort</td></tr></tbody></table><h3 id="check">Check</h3><p>In my caes, it is installed in /home/wpsze/intel/oneapi/</p><blockquote><p>remark #10441: The Intel(R) C++ Compiler Classic (ICC) is deprecated and will be removed from product release in the second half of 2023. The Intel(R) oneAPI DPC++/C++ Compiler (ICX) is the recommended compiler moving forward. Please transition to use this compiler. Use '-diag-disable=10441' to disable this message.</p></blockquote><div class="note note-primary">            <p>Intel oneAPI's <code>icc</code> and <code>icpc</code> have been replaced by <code>icx</code>. We do not have <code>icc</code> and <code>icpc</code> installed on our servers, so please use <code>icx</code> for C and C++ compilation. The usage is similar to the original compiler, for example: <code>icx</code> your_code.cpp -o output.</p>          </div><p>ICC (Linux), ICL (Windows) are classic Intel C/C++ Compilers. Whereas, ICX is Intel nextgen compiler based on Clang /LLVM technology plus Intel proprietary optimizations and code generation.</p><ol type="1"><li>You may use ICC for performance on CPU targets.</li><li>ICX enables OpenMP TARGET offload to Intel GPU targets.</li></ol><p>The following are the guiding principles for ICX:</p><blockquote><ol type="1"><li>ICX and ICC Classic use different compiler drivers. The Intel® C++ Compiler Classic compiler drivers are icc, icpc, and icl.  The Intel® oneAPI DPC++/C++ Compiler drivers are icx and icpx. Use icx to compile and link C programs, and icpx for C++ programs.</li></ol></blockquote><blockquote><ol start="2" type="1"><li>Unlike the icc driver, icx does not use the file extension to determine whether to compile as C or C+. Users must invoke icpx to compile C+ files. . In addition to providing a core C++ Compiler, ICX/ICPX is also used to compile SYCL/DPC++ codes for the Intel® oneAPI Data Parallel C++ Compiler when we pass an additional flag “-fsycl”. </li></ol></blockquote><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-built_in">source</span> /home/wpsze/intel/oneapi/setvars.sh intel64<br><br><span class="hljs-built_in">which</span> icc<br><span class="hljs-built_in">which</span> ifort <br><span class="hljs-built_in">which</span> icpc<br>icc --version<br>ifort --version<br>icpc --version<br><span class="hljs-built_in">which</span> icx<br>icx --version<br><span class="hljs-built_in">which</span> icpx<br>icpx --version<br><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;======================&quot;</span><br><br><span class="hljs-built_in">which</span> mpiicc<br><span class="hljs-built_in">which</span> mpiicpc<br><span class="hljs-built_in">which</span> mpiifort<br>mpicc -v<br>mpiicpc -v<br>mpiifort -v<br><br><span class="hljs-comment"># print as</span><br><br>:: initializing oneAPI environment ...<br>   test.sh: BASH_VERSION = 4.4.20(1)-release<br>   args: Using <span class="hljs-string">&quot;<span class="hljs-variable">$@</span>&quot;</span> <span class="hljs-keyword">for</span> setvars.sh arguments: <br>:: ccl -- latest<br>:: clck -- latest<br>:: compiler -- latest<br>:: dal -- latest<br>:: debugger -- latest<br>:: dev-utilities -- latest<br>:: dnnl -- latest<br>:: dpcpp-ct -- latest<br>:: dpl -- latest<br>:: inspector -- latest<br>:: ipp -- latest<br>:: ippcp -- latest<br>:: ipp -- latest<br>:: itac -- latest<br>:: mkl -- latest<br>:: mpi -- latest<br>:: tbb -- latest<br>:: oneAPI environment initialized ::<br><br><span class="hljs-comment">#/home/wpsze/intel/oneapi/compiler/2023.1.0/linux/bin/intel64/icc</span><br><span class="hljs-comment">#/home/wpsze/intel/oneapi/compiler/2023.1.0/linux/bin/intel64/ifort</span><br><span class="hljs-comment">#/home/wpsze/intel/oneapi/compiler/2023.1.0/linux/bin/intel64/icpc</span><br><br>$ icc --version<br>icc: remark <span class="hljs-comment">#10441: The Intel(R) C++ Compiler Classic (ICC) is deprecated and will be removed from product release in the second half of 2023. The Intel(R) oneAPI DPC++/C++ Compiler (ICX) is the recommended compiler moving forward. Please transition to use this compiler. Use &#x27;-diag-disable=10441&#x27; to disable this message.</span><br>icc (ICC) 2021.9.0 20230302<br>Copyright (C) 1985-2023 Intel Corporation.  All rights reserved.<br><br>$ ifort --version<br>ifort (IFORT) 2021.9.0 20230302<br>Copyright (C) 1985-2023 Intel Corporation.  All rights reserved.<br><br>$ icpc --version<br>icpc: remark <span class="hljs-comment">#10441: The Intel(R) C++ Compiler Classic (ICC) is deprecated and will be removed from product release in the second half of 2023. The Intel(R) oneAPI DPC++/C++ Compiler (ICX) is the recommended compiler moving forward. Please transition to use this compiler. Use &#x27;-diag-disable=10441&#x27; to disable this message.</span><br>icpc (ICC) 2021.9.0 20230302<br>Copyright (C) 1985-2023 Intel Corporation.  All rights reserved.<br><br>$ <span class="hljs-built_in">which</span> icx<br><span class="hljs-comment"># /home/wpsze/intel/oneapi/compiler/2023.1.0/linux/bin/icx</span><br><br>$ icx --version<br>Intel(R) oneAPI DPC++/C++ Compiler 2023.1.0 (2023.1.0.20230320)<br>Target: x86_64-unknown-linux-gnu<br>Thread model: posix<br>InstalledDir: /home/wpsze/intel/oneapi/compiler/2023.1.0/linux/bin-llvm<br>Configuration file: /home/wpsze/intel/oneapi/compiler/2023.1.0/linux/bin-llvm/../bin/icx.cfg<br><br>$ <span class="hljs-built_in">which</span> icpx<br><span class="hljs-comment"># /home/wpsze/intel/oneapi/compiler/2023.1.0/linux/bin/icpx</span><br><br>$ icpx --version<br>Intel(R) oneAPI DPC++/C++ Compiler 2023.1.0 (2023.1.0.20230320)<br>Target: x86_64-unknown-linux-gnu<br>Thread model: posix<br>InstalledDir: /home/wpsze/intel/oneapi/compiler/2023.1.0/linux/bin-llvm<br>Configuration file: /home/wpsze/intel/oneapi/compiler/2023.1.0/linux/bin-llvm/../bin/icpx.cfg<br><br>======================<br>/home/wpsze/intel/oneapi/mpi/2021.9.0/bin/mpiicc<br>/home/wpsze/intel/oneapi/mpi/2021.9.0/bin/mpiicpc<br>/home/wpsze/intel/oneapi/mpi/2021.9.0/bin/mpiifort<br></code></pre></td></tr></table></figure><p>Remark</p><ol type="1"><li>The icc and icpc commands resemble the GNU equivalents gcc and g++. This is a highly optimizing C (icc) and C++ (icpc) compiler.</li></ol><h2 id="set-environment-variables-for-cli-development">Set Environment Variables for CLI Development</h2><p>Option 1: Source setvars.sh once per session</p><p>Source setvars.sh every time you open a new terminal window:</p><p>You can find the setvars.sh script in the root folder of your oneAPI installation, which is typically /opt/intel/oneapi/ for system wide installation and ~/intel/oneapi/ when installed as a private installation. Note that system wide installation requires root or sudo privileges.</p><p>For system wide installations: <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-built_in">source</span> /opt/intel/oneapi/setvars.sh intel64<br></code></pre></td></tr></table></figure></p><p>For private installations: <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-built_in">source</span> ~/intel/oneapi/setvars.sh intel64<br></code></pre></td></tr></table></figure></p><h2 id="build-and-run-a-sample-project-using-the-command-line">Build and Run a Sample Project Using the Command Line</h2><p>To compile and run a sample:</p><ol type="1"><li>Download the sample using the oneAPI CLI Samples Browser. (Command line interface (CLI))</li></ol><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">$ oneapi-cli <br></code></pre></td></tr></table></figure><ol start="2" type="1"><li>Compile and run the sample with Make*</li></ol><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sh">$ <span class="hljs-built_in">cd</span> /home/wpsze/intel/oneapi/matrix_mul <br>$ make<br>$ sh run.sh<br></code></pre></td></tr></table></figure><p>Output: &gt; start: 23/05/04 10:59:07.161 &gt; &gt; ./matrix_mul_dpc &gt; Device: Intel(R) xxxx(xx) ix-xxxxS CPU @ x.xxGHz &gt; Problem size: c(150,600) = a(150,300) * b(300,600) &gt; Result of matrix multiplication using SYCL: Success - The results are correct! &gt; &gt; end: 23/05/04 10:59:14.409</p><h2 id="compile-wrfv440-with-intel-oneapi">Compile WRFv440 with Intel OneAPI</h2><p>Ref: [WRF installation on a Linux-based machine]</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-built_in">source</span> /home/wpsze/intel/oneapi/setvars.sh<br><span class="hljs-built_in">export</span> PATH=/home/wpsze/intel/oneapi/compiler/2023.1.0/linux/bin/intel64/:<span class="hljs-variable">$PATH</span><br><span class="hljs-built_in">export</span> LD_LIBRARY_PATH=/home/wpsze/intel/oneapi/compiler/2023.1.0/linux/lib/intel64/:<span class="hljs-variable">$LD_LIBRARY_PATH</span><br><br>gcc --version<br>gfortran --version<br><br>icx --version<br>ifort --version<br><br><span class="hljs-comment"># Intel (serial or dmpar)</span><br></code></pre></td></tr></table></figure><p>If it is sucessful, the following exe will be gnerated, <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs sh">==========================================================================<br>---&gt;                  Executables successfully built                  &lt;---<br> main/ndown.exe<br> main/real.exe<br> main/tc.exe<br> main/wrf.exe<br>==========================================================================<br>wrf_install/WPS-4.4/geogrid.exe -&gt; geogrid/src/geogrid.exe*<br>wrf_install/WPS-4.4/ungrib.exe -&gt; ungrib/src/ungrib.exe*<br>==========================================================================<br></code></pre></td></tr></table></figure></p><h3 id="bug-.configure-919-unexpected-operator">Bug: ./configure: 919: [: unexpected operator</h3><ul><li><a href="https://forum.mmm.ucar.edu/threads/resolved-wrf-configure-issue.11474/">(RESOLVED) WRF configure issue</a><ul><li>Error <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs log">NetCDF version: 4.8.1<br>Enabled NetCDF-4/HDF-5: yes<br>NetCDF built with PnetCDF: no<br>./configure: 919: [: unexpected operator<br></code></pre></td></tr></table></figure></li><li><strong>./configure: 919: [: unexpected operator</strong></li></ul></li></ul><p>Solution: <a href="https://github.com/wrf-model/WRF/pull/1735/files">Bugfix: Correct string test in configure. #1735</a></p><h3 id="bug-.clean-cannot-execute-required-file-not-found">Bug: ./clean: cannot execute: required file not found</h3><p>or <code>./compile: cannot execute: required file not found</code></p><ul><li>miss <strong>/bin/csh</strong></li></ul><h1 id="references">References</h1><ol type="1"><li><a href="https://kb.brightcomputing.com/knowledge-base/how-to-install-intel-oneapi-base-and-hpc-toolkits/#installing-the-intel-oneapi-hpc-toolkit">How to install Intel OneAPI Base and HPC Toolkits</a></li><li><a href="https://blog.qiql.net/archives/intelgcc">Ubuntu20.04 安装 INTEL 编译器和 Gcc 编译器</a><ol type="1"><li>先安装Base Toolkit，再安装 HPC Toolkit</li><li>安装gcc5.4编译器</li><li>安装module</li><li>编写 modulefile</li></ol></li><li><a href="https://cloud.tencent.com/developer/article/2148549">Intel oneAPI toolkits 介绍和安装</a><ol type="1"><li>对于气象中的应用，主流数值模式基本都是以Fortran编写的，为了追求更高的计算速度，我们尽量使用的intel编译器</li><li>ifort编译的程序运行速度比gfortran要高一些。尽管高的不是非常多，但对于模式长时间的积分，节省的时间还是非常可观的</li><li>对于我们的使用需求，只需安装Intel® oneAPI Base Toolkit 和 Intel® oneAPI HPC Toolkit 就满足了</li></ol></li><li><a href="https://hpc.lenovo.com/lico/downloads/7.1/Install_Intel_oneAPI.html">Install Intel oneAPI | lenovo</a></li><li><a href="https://www.xiaoledeng.com/2021/07/19/oneapi-resource-install/">oneAPI资源和安装</a></li><li><a href="https://zhuanlan.zhihu.com/p/358928837">Intel学生许可过期后，安装 Intel® oneAPI Base Toolkit 和 Intel® oneAPI HPC来替代</a><ol type="1"><li>之前的Intel Parallel Studio XE用邮箱申请了学生许可，已经过期，发现不能再续期，官网竟然出了免费版本！</li></ol></li><li><a href="https://community.intel.com/t5/Blogs/Tech-Innovation/Tools/A-Historic-Moment-for-The-Intel-Fortran-Compiler-Classic-ifort/post/1614625">A Historic Moment for The Intel® Fortran Compiler Classic (ifort)</a></li></ol><table><thead><tr class="header"><th>oneAPI Package Version</th><th>ifx version</th><th>ifort version</th></tr></thead><tbody><tr class="odd"><td>2024.0.x</td><td>2024.0.x</td><td>2021.11.x</td></tr><tr class="even"><td>2024.1.0</td><td>2024.1.0</td><td>2021.12.0</td></tr><tr class="odd"><td>2024.2.0</td><td>2024.2.0</td><td>2021.13.0</td></tr><tr class="even"><td>2025.0.0 (future)</td><td>2025.0.0</td><td>not included</td></tr></tbody></table>]]></content>
    
    
    <categories>
      
      <category>Linux</category>
      
    </categories>
    
    
    <tags>
      
      <tag>HPC</tag>
      
      <tag>WRF</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>WRF | GRIB1, GRIB2, NetCDF</title>
    <link href="/2023/05/06/GRIB1_GRIB2_NetCDF/"/>
    <url>/2023/05/06/GRIB1_GRIB2_NetCDF/</url>
    
    <content type="html"><![CDATA[<h1 id="grib1-grib2-netcdf">GRIB1, GRIB2, NetCDF</h1><p>Ref: <a href="https://rda.ucar.edu/OS/web/datasets/ds083.2/docs/README_Formats.pdf">GRIB1, GRIB2, NetCDF: Which do I choose?</a></p><p>Your choice of data format depends on the date range that you need and what you want to do with the data. GRIB is a World Meteorological Organization (WMO) international standard for exchanging GRidded BInary data.</p><p><strong>GRIB1</strong> is the original format and requires a separate parameter table to unpack the data. <strong>GRIB2</strong> improves upon the standard with file compression and the inclusion of the metadata/parameter table that you need to unpack the data in each file. <strong>GRIB2 exploits the same compression software commonly used for images to gain a roughly 50% reduction in Hile size over GRIB1. </strong></p><p>If you are interested in <strong>2007.12.06</strong> or later, then choose GRIB2 because of its smaller size. For earlier dates, use GRIB1. If you are using software that reads NetCDF but not GRIB, then convert the files to NetCDF *.nc format. Unless you need to use NetCDF tools, use GRIB2 for its efficiency. The WRF mesoscale model can use either GRIB1 or GRIB2. Newer versions of WRF Preprocessing System (WPS) can recognize FNL GRIB1 and GRIB2; WPS will even provide the appropriate parameter table for FNL in GRIB1 format so you do not need to do so manually.</p><p>If you are using the older MM5 mesoscale model, use GRIB1. You can perform many data processing tasks on GRIB files with wgrib (for GRIB1) and wgrib2 (for GRIB2).</p><p>You can process and visualize GRIB Hiles with GRADS, IDL, Panoply, and R (using the rNOMADS package).</p><p>You can use the extensive NetCDF software libraries if you convert the Hiles to NetCDF. However, be mindful that NetCDF Hiles are not as compact as GRIB2, even when compressed.</p>]]></content>
    
    
    <categories>
      
      <category>WRF</category>
      
    </categories>
    
    
    <tags>
      
      <tag>HPC</tag>
      
      <tag>WRF</tag>
      
      <tag>WPS</tag>
      
      <tag>MPAS</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Tmux terminal multiplexer</title>
    <link href="/2023/05/01/Tmux_terminal_multiplexer/"/>
    <url>/2023/05/01/Tmux_terminal_multiplexer/</url>
    
    <content type="html"><![CDATA[<h1 id="tmux-terminal-multiplexer">Tmux terminal multiplexer</h1><p><strong>tmux</strong> is a terminal multiplexer: it enables a number of terminals to be created, accessed, and controlled from a single screen. tmux may be detached from a screen and continue running in the background, then later reattached.</p><p>This release runs on OpenBSD, FreeBSD, NetBSD, Linux, macOS and Solaris.</p><p><a href="https://github.com/tmux/tmux">Git tmux</a></p><h2 id="dependencies">Dependencies</h2><ul><li>tmux depends on <strong>libevent 2.x</strong>, available from <a href="https://github.com/libevent/libevent/releases/latest">this page</a>.</li><li>It also depends on <strong>ncurses</strong>, available from <a href="https://invisible-mirror.net/archives/ncurses/">this page</a>. To build tmux, a C compiler (for example gcc or clang), make, pkg-config and a suitable yacc (yacc or bison) are needed.</li></ul><h2 id="installation">Installation</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs sh">git <span class="hljs-built_in">clone</span> https://github.com/tmux/tmux.git<br><span class="hljs-built_in">cd</span> tmux<br>sh autogen.sh<br>./configure &amp;&amp; make<br></code></pre></td></tr></table></figure><p>or</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">micromamba install conda-forge::tmux<br></code></pre></td></tr></table></figure><h2 id="edit-.tmux.conf">Edit .tmux.conf</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># prefix setting (screen-like)</span><br><span class="hljs-built_in">set</span> -g prefix C-a<br>unbind C-b<br><span class="hljs-built_in">bind</span> C-a send-prefix<br><br><span class="hljs-comment"># Use the mouse</span><br><span class="hljs-built_in">set</span> -g mouse on<br><br><span class="hljs-built_in">bind</span> | split-window -h<br><span class="hljs-built_in">bind</span> - split-window -v<br><br><span class="hljs-comment"># History-limit</span><br><span class="hljs-built_in">set</span> -g history-limit 30000<br><br><span class="hljs-built_in">bind</span> -r ^Up select-pane -U<br><span class="hljs-built_in">bind</span> -r ^Down select-pane -D<br><span class="hljs-built_in">bind</span> -r ^Left select-pane -L<br><span class="hljs-built_in">bind</span> -r ^Right select-pane -R<br><br><span class="hljs-built_in">set</span> -g default-terminal <span class="hljs-string">&quot;xterm-256color&quot;</span><br></code></pre></td></tr></table></figure><h2 id="usage">Usage</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># Add new seession</span><br>tmux new -s &lt;session-name&gt;<br><br><span class="hljs-comment"># Detach</span><br>tmux detach<br><br><span class="hljs-comment"># List all sessions</span><br>tmux <span class="hljs-built_in">ls</span><br><br><span class="hljs-comment"># Attach a session</span><br>tmux a -t &lt;session-name&gt;<br><br><span class="hljs-comment"># rename session, </span><br>tmux rename-session -t &lt;old-session-name&gt; &lt;new-session-name&gt;<br><br><span class="hljs-comment"># Reload the current Tmux configuration</span><br>tmux source-file ~/.tmux.conf<br></code></pre></td></tr></table></figure><h2 id="actions">Actions</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># Move bewteen panes</span><br>C trl + A (up,down,lef,right)<br><br><span class="hljs-comment"># the window into two panes horizontally.</span><br>Ctrl + A —<br><br><span class="hljs-comment"># Split the window into two panes vertically.</span><br>Ctrl + A |<br><br><span class="hljs-comment"># Ctrl+B X — Close pane.</span><br>Ctrl + A X<br></code></pre></td></tr></table></figure><h2 id="選擇文字">選擇文字</h2><p>在bash中選擇文字本不是一件難事，但是到了tmux中，情況會稍有複雜。如果一個window裡面有多個pane，普通的選擇是會橫跨並排的pane的，這讓複製文字變得困難了起來。那麼如何解決呢？答案是：使用Alt。利用Alt+滑鼠框選，我們可以控制選擇的文字範圍，就可以實現選擇單一pane裡的文字啦。 如果在tmux中啟用滑鼠模式(tmux set mouse on)的話，會發現無法直接透過滑鼠來選擇複製文字，這個時候可以用過Shift+滑鼠選擇來選擇文字。 不過對於有多個pane的窗口，選擇一個pane裡的文字就不能簡單透過Shift+滑鼠選擇來完成了，因為這樣可能會選取多個pane裡的文字。 那麼如何來實現只選擇單一pane裡的文字呢？方法很簡單，只需要多按一個鍵即可：</p><ul><li><code>Shift + Alt + 滑鼠框選</code><ul><li>copy: <code>Ctrl + Shift + C</code></li><li>paste: <code>Ctrl + Shift + V</code></li></ul></li></ul>]]></content>
    
    
    <categories>
      
      <category>Linux</category>
      
    </categories>
    
    
    <tags>
      
      <tag>HPC</tag>
      
      <tag>terminal</tag>
      
      <tag>tmux</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>WRF | WPS build up domain</title>
    <link href="/2023/05/01/WPS_build_up_domain/"/>
    <url>/2023/05/01/WPS_build_up_domain/</url>
    
    <content type="html"><![CDATA[<h1 id="wps-build-up-domain">WPS build up domain</h1><p><a href="https://www2.mmm.ucar.edu/wrf/users/special_code.html">WRF-Related Special Code</a></p><table><thead><tr class="header"><th style="text-align: left;">Function</th><th style="text-align: left;">source</th></tr></thead><tbody><tr class="odd"><td style="text-align: left;">Convert netCDF to Intermediate</td><td style="text-align: left;"><a href="https://www2.mmm.ucar.edu/wrf/src/netcdf-to-intermediate.f">netcdf-to-intermediate.f</a></td></tr><tr class="even"><td style="text-align: left;">NCL Design Grids</td><td style="text-align: left;"><a href="https://www2.mmm.ucar.edu/wrf/src/design_grids.ncl">design_grids.ncl</a></td></tr><tr class="odd"><td style="text-align: left;">Convert netCDF to Intermediate (CCSM Data)</td><td style="text-align: left;"><a href="https://www2.mmm.ucar.edu/wrf/src/ccsm2IM.tar.gz">tar file</a></td></tr><tr class="even"><td style="text-align: left;">wrf2grads</td><td style="text-align: left;"><a href="https://www2.mmm.ucar.edu/wrf/src/wrf2grads.tar.gz">csh script</a></td></tr><tr class="odd"><td style="text-align: left;">Hurricane Dorian Test Case</td><td style="text-align: left;"><a href="https://www2.mmm.ucar.edu/wrf/src/dorian_test_case.tar.gz">dorian_test_case.tar.gz</a></td></tr></tbody></table><p>The most useful here is <strong>design_grids.ncl</strong></p><blockquote><p>You provide lat/lon/dx/dy and then it will generate WPS domain config.</p></blockquote><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-meta">#!/bin/bash</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment"># https://www2.mmm.ucar.edu/wrf/users/tutorial/presentation_pdfs/202101/werner_data_util_pp.pdf P.19</span><br><span class="hljs-comment"># https://www2.mmm.ucar.edu/wrf/users/special_code.html</span><br><span class="hljs-comment">#</span><br><br><span class="hljs-built_in">source</span> /home/wpsze/anaconda3/bin/activate ncl<br>ncl design_grids.ncl<br><br></code></pre></td></tr></table></figure><p>and design_grids.ncl is like as below,</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br></pre></td><td class="code"><pre><code class="hljs sh">;   Script display location of model domains<br>;   Only works <span class="hljs-keyword">for</span> ARW domains<br>;   Reads namelist file directly<br><br>load <span class="hljs-string">&quot;<span class="hljs-variable">$NCARG_ROOT</span>/lib/ncarg/nclscripts/csm/gsn_code.ncl&quot;</span><br>load <span class="hljs-string">&quot;<span class="hljs-variable">$NCARG_ROOT</span>/lib/ncarg/nclscripts/wrf/WRFUserARW.ncl&quot;</span><br>;load <span class="hljs-string">&quot;./WRFUserARW.ncl&quot;</span><br><br>begin<br>;<br><br>; We generate plots, but what kind <span class="hljs-keyword">do</span> we prefer?<br>; <span class="hljs-built_in">type</span> = <span class="hljs-string">&quot;x11&quot;</span><br>; <span class="hljs-built_in">type</span> = <span class="hljs-string">&quot;pdf&quot;</span><br>; <span class="hljs-built_in">type</span> = <span class="hljs-string">&quot;ps&quot;</span><br>; <span class="hljs-built_in">type</span> = <span class="hljs-string">&quot;ncgm&quot;</span><br>  <span class="hljs-built_in">type</span> = <span class="hljs-string">&quot;png&quot;</span><br>  wks = gsn_open_wks(<span class="hljs-built_in">type</span>,<span class="hljs-string">&quot;wps_show_dom&quot;</span>)<br><br>; Set the colors to be used<br>  colors = (/<span class="hljs-string">&quot;white&quot;</span>,<span class="hljs-string">&quot;black&quot;</span>,<span class="hljs-string">&quot;White&quot;</span>,<span class="hljs-string">&quot;ForestGreen&quot;</span>,<span class="hljs-string">&quot;DeepSkyBlue&quot;</span>,<span class="hljs-string">&quot;Red&quot;</span>,<span class="hljs-string">&quot;Blue&quot;</span>/)<br>  gsn_define_colormap(wks, colors)  <br><br><br>; Set some map information ; line and text information<br>  mpres = True<br>  mpres@mpFillOn = True<br>  mpres@mpFillColors  = (/<span class="hljs-string">&quot;background&quot;</span>,<span class="hljs-string">&quot;DeepSkyBlue&quot;</span>,<span class="hljs-string">&quot;ForestGreen&quot;</span>,<span class="hljs-string">&quot;DeepSkyBlue&quot;</span>, <span class="hljs-string">&quot;transparent&quot;</span>/)<br>  mpres@mpGeophysicalLineColor      = <span class="hljs-string">&quot;Black&quot;</span><br>  mpres@mpGridLineColor             = <span class="hljs-string">&quot;Black&quot;</span><br>  mpres@mpLimbLineColor             = <span class="hljs-string">&quot;Black&quot;</span><br>  mpres@mpNationalLineColor         = <span class="hljs-string">&quot;Black&quot;</span><br>  mpres@mpPerimLineColor            = <span class="hljs-string">&quot;Black&quot;</span><br>  mpres@mpUSStateLineColor          = <span class="hljs-string">&quot;Black&quot;</span><br>  mpres@mpGridSpacingF              = 1<br>  mpres@tiMainString                = <span class="hljs-string">&quot; WPS Domain Configuration  &quot;</span><br><br>  lnres = True <br>  lnres@gsLineThicknessF = 2.5<br>  lnres@domLineColors    = (/ <span class="hljs-string">&quot;white&quot;</span>, <span class="hljs-string">&quot;Red&quot;</span> , <span class="hljs-string">&quot;Red&quot;</span> , <span class="hljs-string">&quot;Blue&quot;</span> /)<br><br>  txres = True<br>  txres@txFont = <span class="hljs-string">&quot;helvetica-bold&quot;</span><br>  ;txres@txJust = <span class="hljs-string">&quot;BottomLeft&quot;</span><br>  txres@txJust = <span class="hljs-string">&quot;TopLeft&quot;</span><br>  txres@txPerimOn = False<br>  txres@txFontHeightF = 0.015<br><br>;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;<br>DOMS = 3<br>DX = 50.<br><br>MAP = <span class="hljs-string">&quot;lambert&quot;</span><br><br>;MAP = <span class="hljs-string">&quot;mercator&quot;</span><br><br>;LAT1 = (/ -47., -39., -27. /); original lambert grids<br>;LAT2 = (/ -10., -18., -23. /)<br>;LON1 = (/ 113., 119., 126. /)<br>;LON2 = (/ 164., 157., 132. /)<br><br>LAT1 = (/ 2.23, 19.94, 21.5 /); modified mercator grids<br>LAT2 = (/ 43.82, 27.09, 23.83 /)<br>LON1 = (/ 85.81, 110.68, 112.51/)<br>LON2 = (/ 140.05, 117.60, 115.04/)<br><br>;LAT1 = (/ -35.0, -45., -27. /); Yasi Domains<br>;LAT2 = (/   0., -20., -23. /)<br>;LON1 = (/ 131., 121., 125./)<br>;LON2 = (/ 171., 159., 131./)<br>;LAT1 = (/ -43.0, -45., -27. /); Yasi Domains<br>;LAT2 = (/   5., -20., -23. /)<br>;LON1 = (/  95., 121., 125./)<br>;LON2 = (/ 179., 159., 131./)<br>parent_id = (/ 1, 1, 2 /)<br>parent_grid_ratio = (/ 1, 3, 3 /)<br><br>std_truelats = False<br><br>;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;<br>; Do not change anything between the <span class="hljs-string">&quot;;;;;;&quot;</span> lines<br><br>  mpres@max_dom   = DOMS<br>  mpres@map_proj  = MAP<br>  mpres@dx        = DX*1000.<br>  mpres@dy        = DX*1000.<br>  mpres@ref_lat   = LAT1(0) + (LAT2(0)-LAT1(0))/2.<br>  mpres@ref_lon   = LON1(0) + (LON2(0)-LON1(0))/2.<br>  mpres@stand_lon = mpres@ref_lon<br>  <br>  <span class="hljs-keyword">if</span> (MAP .eq. <span class="hljs-string">&quot;lambert&quot;</span>) <span class="hljs-keyword">then</span><br>    <span class="hljs-keyword">if</span> ( std_truelats ) <span class="hljs-keyword">then</span><br>      <span class="hljs-keyword">if</span> (LAT1(0) .gt. 0.) <span class="hljs-keyword">then</span><br>        mpres@truelat1 = 30.<br>        mpres@truelat2 = 60.<br>      <span class="hljs-keyword">else</span><br>        mpres@truelat1 = -30.<br>        mpres@truelat2 = -60.<br>      end <span class="hljs-keyword">if</span><br>    <span class="hljs-keyword">else</span><br>      truelat1 = floattoint(LAT1(0) + (LAT2(0)-LAT1(0))/3)<br>      truelat2 = floattoint(truelat1 + (LAT2(0)-LAT1(0))/3)<br>      mpres@truelat1 = int2flt(truelat1)<br>      mpres@truelat2 = int2flt(truelat2)<br>    end <span class="hljs-keyword">if</span><br>  end <span class="hljs-keyword">if</span><br>  <span class="hljs-keyword">if</span> (MAP .eq. <span class="hljs-string">&quot;mercator&quot;</span>) <span class="hljs-keyword">then</span><br>    mpres@truelat2 = 0.<br>    <span class="hljs-keyword">if</span> ( std_truelats ) <span class="hljs-keyword">then</span><br>      mpres@truelat1 = 0.<br>    <span class="hljs-keyword">else</span><br>      truelat1 = floattoint(mpres@ref_lat)<br>      mpres@truelat1 = int2flt(truelat1)<br>    end <span class="hljs-keyword">if</span><br>  end <span class="hljs-keyword">if</span><br><br>  e_we = new ( DOMS, <span class="hljs-built_in">integer</span> ) <br>  e_sn = new ( DOMS, <span class="hljs-built_in">integer</span> ) <br>  e_we(0) = floattoint((LON2(<span class="hljs-number">0</span>)-LON1(<span class="hljs-number">0</span>))*111./DX)<br>  e_sn(0) = floattoint((LAT2(<span class="hljs-number">0</span>)-LAT1(<span class="hljs-number">0</span>))*111./DX)<br>  centeri = e_we(0)/2 + 1<br>  centerj = e_sn(0)/2 + 1<br><br>  i_parent_start = new ( DOMS, <span class="hljs-built_in">integer</span> ) <br>  j_parent_start = new ( DOMS, <span class="hljs-built_in">integer</span> ) <br>  i_parent_start(0) = 1<br>  j_parent_start(0) = 1<br><br>  ;<span class="hljs-built_in">print</span>(mpres)<br>  ;<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Number of grid points &quot;</span> + e_we(0) + <span class="hljs-string">&quot; &quot;</span> + e_sn(0) )<br><br><br>  <span class="hljs-keyword">if</span> ( DOMS .gt. 1 ) <span class="hljs-keyword">then</span><br><br>    mpres@parent_id         = parent_id<br>    mpres@parent_grid_ratio = parent_grid_ratio<br><br>    res = True<br>    <span class="hljs-keyword">if</span> (MAP .eq. <span class="hljs-string">&quot;lambert&quot;</span>) <span class="hljs-keyword">then</span><br>      res@MAP_PROJ  = 1<br>    end <span class="hljs-keyword">if</span><br>    <span class="hljs-keyword">if</span> (MAP .eq. <span class="hljs-string">&quot;mercator&quot;</span>) <span class="hljs-keyword">then</span><br>      res@MAP_PROJ  = 3<br>    end <span class="hljs-keyword">if</span><br>    res@TRUELAT1  = mpres@truelat1<br>    res@TRUELAT2  = mpres@truelat2<br>    res@STAND_LON = mpres@stand_lon<br>    res@DX        = mpres@dx<br>    res@DY        = mpres@dy<br>    res@REF_LAT   = mpres@ref_lat<br>    res@REF_LON   = mpres@ref_lon<br>    res@KNOWNI    = centeri<br>    res@KNOWNJ    = centerj<br><br>    ratio = 1<br>    ratio_start = 1<br>    istart = 1<br>    jstart = 1<br>    <span class="hljs-keyword">do</span> ii=1,DOMS-1<br>      ratio = ratio * parent_grid_ratio(ii)<br>      loc = wrf_ll_to_ij (LON1(ii),LAT1(ii),res)<br>      loci1 = new(dimsizes(loc),<span class="hljs-built_in">integer</span>)<br>      loci1 = tointeger(loc + .5)<br>      loci1!0 = loc!0<br>      ;<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;DOM=&quot;</span>+ii + <span class="hljs-string">&quot;  start &quot;</span> + loci1)<br>      loc = wrf_ll_to_ij (LON2(ii),LAT2(ii),res)<br>      loci2 = new(dimsizes(loc),<span class="hljs-built_in">integer</span>)<br>      loci2 = tointeger(loc + .5)<br>      loci2!0 = loc!0<br>      ;<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;DOM=&quot;</span>+ii + <span class="hljs-string">&quot;    end &quot;</span> + loci2)<br>      e_we(ii) = (loci2(0)-loci1(0))*ratio + 1<br>      e_sn(ii) = (loci2(1)-loci1(1))*ratio + 1<br>      istart = (loci1(0) - istart + 1)*ratio_start<br>      jstart = (loci1(1) - jstart + 1)*ratio_start<br>      i_parent_start(ii) = istart<br>      j_parent_start(ii) = jstart<br>      ;<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Number of grid points &quot;</span> + e_we(ii) + <span class="hljs-string">&quot; &quot;</span> + e_sn(ii) )<br>      ;<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Start locations &quot;</span> + istart + <span class="hljs-string">&quot; &quot;</span> + jstart)<br>      ratio_start = ratio<br>    end <span class="hljs-keyword">do</span><br>   <br>  end <span class="hljs-keyword">if</span><br><br>  <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Suggested namelist options&quot;</span>)<br>  xxx = <span class="hljs-string">&quot;parent_id =&quot;</span><br>  <span class="hljs-keyword">do</span> ii=0,DOMS-1<br>    xxx = xxx + <span class="hljs-string">&quot; &quot;</span> + parent_id(ii) + <span class="hljs-string">&quot;,&quot;</span><br>  end <span class="hljs-keyword">do</span><br>  <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot; &quot;</span> + xxx)<br>  xxx = <span class="hljs-string">&quot;parent_grid_ratio =&quot;</span><br>  <span class="hljs-keyword">do</span> ii=0,DOMS-1<br>    xxx = xxx + <span class="hljs-string">&quot; &quot;</span> + parent_grid_ratio(ii) + <span class="hljs-string">&quot;,&quot;</span><br>  end <span class="hljs-keyword">do</span><br>  <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot; &quot;</span> + xxx)<br>  xxx = <span class="hljs-string">&quot;i_parent_start =&quot;</span><br>  <span class="hljs-keyword">do</span> ii=0,DOMS-1<br>    xxx = xxx + <span class="hljs-string">&quot; &quot;</span> + i_parent_start(ii) + <span class="hljs-string">&quot;,&quot;</span><br>  end <span class="hljs-keyword">do</span><br>  <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot; &quot;</span> + xxx)<br>  xxx = <span class="hljs-string">&quot;j_parent_start =&quot;</span><br>  <span class="hljs-keyword">do</span> ii=0,DOMS-1<br>    xxx = xxx + <span class="hljs-string">&quot; &quot;</span> + j_parent_start(ii) + <span class="hljs-string">&quot;,&quot;</span><br>  end <span class="hljs-keyword">do</span><br>  <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot; &quot;</span> + xxx)<br>  xxx = <span class="hljs-string">&quot;e_we =&quot;</span><br>  <span class="hljs-keyword">do</span> ii=0,DOMS-1<br>    xxx = xxx + <span class="hljs-string">&quot; &quot;</span> + e_we(ii) + <span class="hljs-string">&quot;,&quot;</span><br>  end <span class="hljs-keyword">do</span><br>  <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot; &quot;</span> + xxx)<br>  xxx = <span class="hljs-string">&quot;e_sn =&quot;</span><br>  <span class="hljs-keyword">do</span> ii=0,DOMS-1<br>    xxx = xxx + <span class="hljs-string">&quot; &quot;</span> + e_sn(ii) + <span class="hljs-string">&quot;,&quot;</span><br>  end <span class="hljs-keyword">do</span><br>  <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot; &quot;</span> + xxx)<br>  <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot; dx = &quot;</span> + mpres@dx + <span class="hljs-string">&quot;,&quot;</span>)<br>  <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot; dy = &quot;</span> + mpres@dy + <span class="hljs-string">&quot;,&quot;</span>)<br>  <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot; map_proj = &#x27;&quot;</span> + mpres@map_proj + <span class="hljs-string">&quot;&#x27;,&quot;</span>)<br>  <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot; ref_lat = &quot;</span> + sprintf(<span class="hljs-string">&quot;%7.2f&quot;</span>,mpres@ref_lat) + <span class="hljs-string">&quot;,&quot;</span>)<br>  <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot; ref_lon = &quot;</span> + sprintf(<span class="hljs-string">&quot;%7.2f&quot;</span>,mpres@ref_lon) + <span class="hljs-string">&quot;,&quot;</span>)<br>  <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot; truelat1 = &quot;</span> + sprintf(<span class="hljs-string">&quot;%7.2f&quot;</span>,mpres@truelat1) + <span class="hljs-string">&quot;,&quot;</span>)<br>  <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot; truelat2 = &quot;</span> + sprintf(<span class="hljs-string">&quot;%7.2f&quot;</span>,mpres@truelat2) + <span class="hljs-string">&quot;,&quot;</span>)<br>  <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot; stand_lon = &quot;</span> + sprintf(<span class="hljs-string">&quot;%7.2f&quot;</span>,mpres@stand_lon) + <span class="hljs-string">&quot;,&quot;</span>)<br>  <br>  mpres@e_we = e_we<br>  mpres@e_sn = e_sn<br>  mpres@i_parent_start = i_parent_start<br>  mpres@j_parent_start = j_parent_start<br><br>  mp = wrf_wps_dom (wks,mpres,lnres,txres)<br>  pmres = True<br>  pmres@gsMarkerColor = <span class="hljs-string">&quot;White&quot;</span><br>  pmres@gsMarkerIndex = 16<br>  pmres@gsMarkerSizeF = 0.01<br>  gsn_polymarker(wks,mp,128.00,-25.00,pmres)<br>  frame(wks)   <br><br>;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;<br><br><br><br>end<br><br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>WRF</category>
      
    </categories>
    
    
    <tags>
      
      <tag>NWP</tag>
      
      <tag>WRF</tag>
      
      <tag>WPS</tag>
      
      <tag>domain</tag>
      
      <tag>ncl</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Bash &amp; Oh-My-Bash</title>
    <link href="/2023/05/01/bash_oh_my_bash/"/>
    <url>/2023/05/01/bash_oh_my_bash/</url>
    
    <content type="html"><![CDATA[<h1 id="bash-oh-my-bash">Bash &amp; Oh-My-Bash</h1><p>Ref:</p><ol type="1"><li><a href="https://www.cnblogs.com/nbtech/p/oh-my-bash.html">配置安装oh-my-bash</a></li><li><a href="https://github.com/ohmybash/oh-my-bash" class="uri">https://github.com/ohmybash/oh-my-bash</a></li><li><a href="https://github.com/ohmybash/oh-my-bash/tree/master/plugins">plugins</a></li><li><a href="https://github.com/ohmybash/oh-my-bash/wiki/Themes">Themes</a></li></ol><p><em>Oh My Bash</em> works best on macOS and Linux.</p><blockquote><p>Unix-like operating system (macOS or Linux)<br />curl or wget should be installed<br />git should be installed</p></blockquote><h2 id="check-shell-used">Check $SHELL used</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-built_in">cat</span> /etc/shells<br><span class="hljs-comment">## /etc/shells: valid login shells</span><br><span class="hljs-comment"># /bin/sh</span><br><span class="hljs-comment"># /bin/bash</span><br><span class="hljs-comment"># /bin/rbash</span><br><span class="hljs-comment"># /bin/dash</span><br><span class="hljs-comment"># /bin/csh</span><br><span class="hljs-comment"># /bin/zsh</span><br><span class="hljs-comment"># /usr/bin/zsh</span><br><br><span class="hljs-built_in">echo</span> <span class="hljs-variable">$SHELL</span><br><span class="hljs-comment"># /bin/bash</span><br></code></pre></td></tr></table></figure><p>To change your shell.</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sh">chsh -s /bin/bash <span class="hljs-comment">## change to bash ##</span><br><span class="hljs-comment"># or</span><br><span class="hljs-built_in">exec</span> bash <span class="hljs-comment"># zsh</span><br></code></pre></td></tr></table></figure><h2 id="installation">Installation</h2><p>On the HOME dir, like /home/wpsze/</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs sh">git <span class="hljs-built_in">clone</span> https://github.com/ohmybash/oh-my-bash.git<br><span class="hljs-built_in">mv</span> oh-my-bash-master .oh-my-bash<br><span class="hljs-built_in">cd</span> .oh-my-bash/<br><span class="hljs-built_in">chmod</span> +x oh-my-bash.sh<br></code></pre></td></tr></table></figure><p>Backup our .bashrc first, <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-built_in">cp</span> ~/.bashrc ~/.bashrc.bak<br></code></pre></td></tr></table></figure></p><p>copy the oh-my-bash to .bashrc <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-built_in">cp</span> ~/.oh-my-bash/templates/bashrc.osh-template ~/.bashrc<br></code></pre></td></tr></table></figure></p><p>source it, <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-built_in">source</span> ~/.bashrc<br></code></pre></td></tr></table></figure></p><p>The installation and use of oh-my-bash is very simple, and the use of oh-my-bash is similar to that of oh-my-zsh. There are functions such as auto-completion (ignoring case), history, and quick cd.</p><h2 id="theme">Theme</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-built_in">ls</span> .oh-my-bash/themes/<br>vim ~/.bashrc<br><span class="hljs-comment">#</span><br><span class="hljs-comment"># OSH_THEME=&quot;font&quot;</span><br><span class="hljs-comment"># or</span><br>OSH_THEME=<span class="hljs-string">&quot;simple&quot;</span><br></code></pre></td></tr></table></figure><p>and change theme like /home/wpsze/.oh-my-bash/themes/font/font.theme.sh <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs sh">CLOCK_THEME_PROMPT_PREFIX=<span class="hljs-string">&#x27;[&#x27;</span><br>CLOCK_THEME_PROMPT_SUFFIX=<span class="hljs-string">&#x27;]&#x27;</span><br><br><span class="hljs-built_in">local</span> hostname=<span class="hljs-string">&quot;<span class="hljs-variable">$&#123;_omb_prompt_bold_green&#125;</span>\u@\h&quot;</span><br></code></pre></td></tr></table></figure></p><h2 id="absolute-path">absolute path</h2><p>How can I display the absolute path in bash prompt? <a href="https://superuser.com/questions/202212/how-can-i-display-the-absolute-path-in-bash-prompt" class="uri">https://superuser.com/questions/202212/how-can-i-display-the-absolute-path-in-bash-prompt</a></p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># PS1=&#x27;\u@\h:\w\$ &#x27;</span><br><span class="hljs-comment"># Replace the &quot;\w&quot; with &quot;\$PWD&quot;</span><br><span class="hljs-comment"># PS1=[\u@\h ]\$PWD$</span><br>PS1=<span class="hljs-string">&quot;<span class="hljs-subst">$(clock_prompt)</span>$python_venv<span class="hljs-variable">$&#123;hostname&#125;</span>:<span class="hljs-variable">$&#123;_omb_prompt_bold_teal&#125;</span>\$&#123;PWD&#125; <span class="hljs-subst">$(scm_prompt_char_info)</span><span class="hljs-variable">$&#123;ret_status&#125;</span>$ <span class="hljs-variable">$&#123;_omb_prompt_normal&#125;</span>&quot;</span><br></code></pre></td></tr></table></figure><p>The key here is <strong>* gives the full path while </strong>* gives only the directory.</p><h2 id="conda-initialize">conda initialize</h2><p>Add the following into .bashrc</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># &gt;&gt;&gt; conda initialize &gt;&gt;&gt;</span><br><span class="hljs-comment"># !! Contents within this block are managed by &#x27;conda init&#x27; !!</span><br>__conda_setup=<span class="hljs-string">&quot;<span class="hljs-subst">$(&#x27;/home/wpsze/anaconda3/bin/conda&#x27; &#x27;shell.bash&#x27; &#x27;hook&#x27; 2&gt; /dev/null)</span>&quot;</span><br><span class="hljs-keyword">if</span> [ $? -eq 0 ]; <span class="hljs-keyword">then</span><br>    <span class="hljs-built_in">eval</span> <span class="hljs-string">&quot;<span class="hljs-variable">$__conda_setup</span>&quot;</span><br><span class="hljs-keyword">else</span><br>    <span class="hljs-keyword">if</span> [ -f <span class="hljs-string">&quot;/home/wpsze/anaconda3/etc/profile.d/conda.sh&quot;</span> ]; <span class="hljs-keyword">then</span><br>        . <span class="hljs-string">&quot;/home/wpsze/anaconda3/etc/profile.d/conda.sh&quot;</span><br>    <span class="hljs-keyword">else</span><br>        <span class="hljs-built_in">export</span> PATH=<span class="hljs-string">&quot;/home/wpsze/anaconda3/bin:<span class="hljs-variable">$PATH</span>&quot;</span><br>    <span class="hljs-keyword">fi</span><br><span class="hljs-keyword">fi</span><br><span class="hljs-built_in">unset</span> __conda_setup<br><span class="hljs-comment"># &lt;&lt;&lt; conda initialize &lt;&lt;&lt;</span><br></code></pre></td></tr></table></figure><h2 id="history-of-most-recent-directories">History of most recent directories</h2><p>Looks like a history of most recent directories you've been in. <strong>which d</strong> identifies it as an alias to <strong>dirs</strong> shell builtin, which prints the contents of the directory stack. Just tried it and number keys allow to move to respective directory.</p><p><strong>dirs</strong> command shell builtin is used to display the list of currently remembered directories. By default, it includes the directory you are currently in. A directory can get into the list via pushd command followed by the dir name and can be removed via popd command.</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs sh">$ <span class="hljs-built_in">dirs</span> -v | <span class="hljs-built_in">head</span> -n 10<br><span class="hljs-comment"># 0 ~</span><br><span class="hljs-comment"># 1 ~/.oh-my-bash/themes/font</span><br><span class="hljs-comment"># 2 ~/.oh-my-bash/themes</span><br><span class="hljs-comment"># ...</span><br><br><span class="hljs-comment">## Select number above will jump to that direcotry</span><br>$ 1<br>.oh-my-bash/themes/font $ <br></code></pre></td></tr></table></figure><h3 id="add-it-to-.bashrc">add it to .bashrc</h3><p>refer to <a href="https://github.com/ohmyzsh/ohmyzsh/blob/master/lib/directories.zsh">zsh directories.zsh</a> here dl() function name can be defined by yourself. <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-keyword">function</span> <span class="hljs-function"><span class="hljs-title">dl</span></span>() &#123;<br>    <span class="hljs-built_in">dirs</span> -v | <span class="hljs-built_in">head</span> -n 10<br>&#125;<br></code></pre></td></tr></table></figure> Remark: In .oh-my-bash/lib/directories.sh New package may be false on this function as <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">OMB_DIRECTORIES_CD_USE_PUSHD=<span class="hljs-literal">true</span> <span class="hljs-comment">#false</span><br></code></pre></td></tr></table></figure> Set as <strong>ture</strong></p><h4 id="if-it-is-clients-node-and-dont-want-to-modify-the-terminal-config-then-just-add-a-function-on-.bashrc">If it is client's node and don't want to modify the terminal config, then just add a function on .bashrc,</h4><ul><li><a href="https://waipangsze.github.io/2024/10/15/Linux-terminal/" class="uri">https://waipangsze.github.io/2024/10/15/Linux-terminal/</a></li></ul><h2 id="autojump---a-faster-way-to-navigate-your-filesystem">autojump - a faster way to navigate your filesystem</h2><p><a href="https://github.com/wting/autojump">Git autojump</a></p><h2 id="ble.sh-bash-line-editor">ble.sh ― Bash Line Editor</h2><h3 id="autosuggestions">autosuggestions</h3><p><a href="https://github.com/akinomyoga/ble.sh">Git ble.sh</a></p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># TRIAL without installation</span><br><br>wget -O - https://github.com/akinomyoga/ble.sh/releases/download/nightly/ble-nightly.tar.xz | tar xJf -<br><span class="hljs-built_in">source</span> ble-nightly/ble.sh<br><br><span class="hljs-comment"># Quick INSTALL to BASHRC (If this doesn&#x27;t work, please follow Sec 1.3)</span><br><br>wget -O - https://github.com/akinomyoga/ble.sh/releases/download/nightly/ble-nightly.tar.xz | tar xJf -<br><span class="hljs-built_in">mkdir</span> -p ~/.local/share/blesh<br><span class="hljs-built_in">cp</span> -Rf ble-nightly/* ~/.local/share/blesh/<br><span class="hljs-built_in">rm</span> -rf ble-nightly<br><span class="hljs-built_in">echo</span> <span class="hljs-string">&#x27;source ~/.local/share/blesh/ble.sh&#x27;</span> &gt;&gt; ~/.bashrc<br></code></pre></td></tr></table></figure><h2 id="whole-.bashrc">Whole .bashrc</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># Enable the subsequent settings only in interactive sessions</span><br><span class="hljs-keyword">case</span> $- <span class="hljs-keyword">in</span><br>  *i*) ;;<br>    *) <span class="hljs-built_in">return</span>;;<br><span class="hljs-keyword">esac</span><br><br><span class="hljs-comment"># Path to your oh-my-bash installation.</span><br><span class="hljs-built_in">export</span> OSH=~/.oh-my-bash<br><br><span class="hljs-comment"># Set name of the theme to load. Optionally, if you set this to &quot;random&quot;</span><br><span class="hljs-comment"># it&#x27;ll load a random theme each time that oh-my-bash is loaded.</span><br>OSH_THEME=<span class="hljs-string">&quot;font&quot;</span><br><br><span class="hljs-comment"># Uncomment the following line to use case-sensitive completion.</span><br><span class="hljs-comment"># OMB_CASE_SENSITIVE=&quot;true&quot;</span><br><br><span class="hljs-comment"># Uncomment the following line to use hyphen-insensitive completion. Case</span><br><span class="hljs-comment"># sensitive completion must be off. _ and - will be interchangeable.</span><br><span class="hljs-comment"># OMB_HYPHEN_SENSITIVE=&quot;false&quot;</span><br><br><span class="hljs-comment"># Uncomment the following line to disable bi-weekly auto-update checks.</span><br><span class="hljs-comment"># DISABLE_AUTO_UPDATE=&quot;true&quot;</span><br><br><span class="hljs-comment"># Uncomment the following line to change how often to auto-update (in days).</span><br><span class="hljs-comment"># export UPDATE_OSH_DAYS=13</span><br><br><span class="hljs-comment"># Uncomment the following line to disable colors in ls.</span><br><span class="hljs-comment"># DISABLE_LS_COLORS=&quot;true&quot;</span><br><br><span class="hljs-comment"># Uncomment the following line to disable auto-setting terminal title.</span><br><span class="hljs-comment"># DISABLE_AUTO_TITLE=&quot;true&quot;</span><br><br><span class="hljs-comment"># Uncomment the following line to enable command auto-correction.</span><br><span class="hljs-comment"># ENABLE_CORRECTION=&quot;true&quot;</span><br><br><span class="hljs-comment"># Uncomment the following line to display red dots whilst waiting for completion.</span><br><span class="hljs-comment"># COMPLETION_WAITING_DOTS=&quot;true&quot;</span><br><br><span class="hljs-comment"># Uncomment the following line if you want to disable marking untracked files</span><br><span class="hljs-comment"># under VCS as dirty. This makes repository status check for large repositories</span><br><span class="hljs-comment"># much, much faster.</span><br><span class="hljs-comment"># DISABLE_UNTRACKED_FILES_DIRTY=&quot;true&quot;</span><br><br><span class="hljs-comment"># Uncomment the following line if you want to change the command execution time</span><br><span class="hljs-comment"># stamp shown in the history command output.  One of the following values can</span><br><span class="hljs-comment"># be used to specify the timestamp format.</span><br><span class="hljs-comment"># * &#x27;mm/dd/yyyy&#x27;     # mm/dd/yyyy + time</span><br><span class="hljs-comment"># * &#x27;dd.mm.yyyy&#x27;     # dd.mm.yyyy + time</span><br><span class="hljs-comment"># * &#x27;yyyy-mm-dd&#x27;     # yyyy-mm-dd + time</span><br><span class="hljs-comment"># * &#x27;[mm/dd/yyyy]&#x27;   # [mm/dd/yyyy] + [time] with colors</span><br><span class="hljs-comment"># * &#x27;[dd.mm.yyyy]&#x27;   # [dd.mm.yyyy] + [time] with colors</span><br><span class="hljs-comment"># * &#x27;[yyyy-mm-dd]&#x27;   # [yyyy-mm-dd] + [time] with colors</span><br><span class="hljs-comment"># If not set, the default value is &#x27;yyyy-mm-dd&#x27;.</span><br><span class="hljs-comment"># HIST_STAMPS=&#x27;yyyy-mm-dd&#x27;</span><br><br><span class="hljs-comment"># Uncomment the following line if you do not want OMB to overwrite the existing</span><br><span class="hljs-comment"># aliases by the default OMB aliases defined in lib/*.sh</span><br><span class="hljs-comment"># OMB_DEFAULT_ALIASES=&quot;check&quot;</span><br><br><span class="hljs-comment"># Would you like to use another custom folder than $OSH/custom?</span><br><span class="hljs-comment"># OSH_CUSTOM=/path/to/new-custom-folder</span><br><br><span class="hljs-comment"># To disable the uses of &quot;sudo&quot; by oh-my-bash, please set &quot;false&quot; to</span><br><span class="hljs-comment"># this variable.  The default behavior for the empty value is &quot;true&quot;.</span><br>OMB_USE_SUDO=<span class="hljs-literal">true</span><br><br><span class="hljs-comment"># To enable/disable display of Python virtualenv and condaenv</span><br><span class="hljs-comment"># OMB_PROMPT_SHOW_PYTHON_VENV=true  # enable</span><br><span class="hljs-comment"># OMB_PROMPT_SHOW_PYTHON_VENV=false # disable</span><br><br><span class="hljs-comment"># Which completions would you like to load? (completions can be found in ~/.oh-my-bash/completions/*)</span><br><span class="hljs-comment"># Custom completions may be added to ~/.oh-my-bash/custom/completions/</span><br><span class="hljs-comment"># Example format: completions=(ssh git bundler gem pip pip3)</span><br><span class="hljs-comment"># Add wisely, as too many completions slow down shell startup.</span><br>completions=(<br>  git<br>  ssh<br>)<br><br><span class="hljs-comment"># Which aliases would you like to load? (aliases can be found in ~/.oh-my-bash/aliases/*)</span><br><span class="hljs-comment"># Custom aliases may be added to ~/.oh-my-bash/custom/aliases/</span><br><span class="hljs-comment"># Example format: aliases=(vagrant composer git-avh)</span><br><span class="hljs-comment"># Add wisely, as too many aliases slow down shell startup.</span><br><span class="hljs-comment">#aliases=(</span><br><span class="hljs-comment">#  general</span><br><span class="hljs-comment">#)</span><br><br><span class="hljs-comment"># Which plugins would you like to load? (plugins can be found in ~/.oh-my-bash/plugins/*)</span><br><span class="hljs-comment"># Custom plugins may be added to ~/.oh-my-bash/custom/plugins/</span><br><span class="hljs-comment"># Example format: plugins=(rails git textmate ruby lighthouse)</span><br><span class="hljs-comment"># Add wisely, as too many plugins slow down shell startup.</span><br>plugins=(<br>  git<br>  bashmarks<br>)<br><br><span class="hljs-comment"># Which plugins would you like to conditionally load? (plugins can be found in ~/.oh-my-bash/plugins/*)</span><br><span class="hljs-comment"># Custom plugins may be added to ~/.oh-my-bash/custom/plugins/</span><br><span class="hljs-comment"># Example format:</span><br><span class="hljs-comment">#  if [ &quot;$DISPLAY&quot; ] || [ &quot;$SSH&quot; ]; then</span><br><span class="hljs-comment">#      plugins+=(tmux-autoattach)</span><br><span class="hljs-comment">#  fi</span><br><br><span class="hljs-built_in">source</span> <span class="hljs-string">&quot;<span class="hljs-variable">$OSH</span>&quot;</span>/oh-my-bash.sh<br><br><span class="hljs-comment"># User configuration</span><br><span class="hljs-comment"># export MANPATH=&quot;/usr/local/man:$MANPATH&quot;</span><br><br><span class="hljs-comment"># You may need to manually set your language environment</span><br><span class="hljs-comment"># export LANG=en_US.UTF-8</span><br><br><span class="hljs-comment"># Preferred editor for local and remote sessions</span><br><span class="hljs-comment"># if [[ -n $SSH_CONNECTION ]]; then</span><br><span class="hljs-comment">#   export EDITOR=&#x27;vim&#x27;</span><br><span class="hljs-comment"># else</span><br><span class="hljs-comment">#   export EDITOR=&#x27;mvim&#x27;</span><br><span class="hljs-comment"># fi</span><br><br><span class="hljs-comment"># Compilation flags</span><br><span class="hljs-comment"># export ARCHFLAGS=&quot;-arch x86_64&quot;</span><br><br><span class="hljs-comment"># ssh</span><br><span class="hljs-comment"># export SSH_KEY_PATH=&quot;~/.ssh/rsa_id&quot;</span><br><br><span class="hljs-comment"># Set personal aliases, overriding those provided by oh-my-bash libs,</span><br><span class="hljs-comment"># plugins, and themes. Aliases can be placed here, though oh-my-bash</span><br><span class="hljs-comment"># users are encouraged to define aliases within the OSH_CUSTOM folder.</span><br><span class="hljs-comment"># For a full list of active aliases, run `alias`.</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment"># Example aliases</span><br><span class="hljs-comment"># alias bashconfig=&quot;mate ~/.bashrc&quot;</span><br><span class="hljs-comment"># alias ohmybash=&quot;mate ~/.oh-my-bash&quot;</span><br><br><span class="hljs-comment">## &gt;&gt;&gt; conda initialize &gt;&gt;&gt;</span><br><span class="hljs-comment"># !! Contents within this block are managed by &#x27;conda init&#x27; !!</span><br>__conda_setup=<span class="hljs-string">&quot;<span class="hljs-subst">$(&#x27;/home/wpsze/anaconda3/bin/conda&#x27; &#x27;shell.bash&#x27; &#x27;hook&#x27; 2&gt; /dev/null)</span>&quot;</span><br><span class="hljs-keyword">if</span> [ $? -eq 0 ]; <span class="hljs-keyword">then</span><br>    <span class="hljs-built_in">eval</span> <span class="hljs-string">&quot;<span class="hljs-variable">$__conda_setup</span>&quot;</span><br><span class="hljs-keyword">else</span><br>    <span class="hljs-keyword">if</span> [ -f <span class="hljs-string">&quot;/home/wpsze/anaconda3/etc/profile.d/conda.sh&quot;</span> ]; <span class="hljs-keyword">then</span><br>        . <span class="hljs-string">&quot;/home/wpsze/anaconda3/etc/profile.d/conda.sh&quot;</span><br>    <span class="hljs-keyword">else</span><br>        <span class="hljs-built_in">export</span> PATH=<span class="hljs-string">&quot;/home/wpsze/anaconda3/bin:<span class="hljs-variable">$PATH</span>&quot;</span><br>    <span class="hljs-keyword">fi</span><br><span class="hljs-keyword">fi</span><br><span class="hljs-built_in">unset</span> __conda_setup<br><span class="hljs-comment"># &lt;&lt;&lt; conda initialize &lt;&lt;&lt;</span><br><br><span class="hljs-comment">## History of most recent directories and jump </span><br><span class="hljs-keyword">function</span> <span class="hljs-function"><span class="hljs-title">dl</span></span>()&#123;<br>    <span class="hljs-built_in">dirs</span> -v | <span class="hljs-built_in">head</span> -n 10<br>&#125;<br><br><span class="hljs-comment">##</span><br><span class="hljs-comment"># some more ls aliases</span><br><span class="hljs-built_in">alias</span> ll=<span class="hljs-string">&#x27;ls -alF&#x27;</span><br><span class="hljs-built_in">alias</span> la=<span class="hljs-string">&#x27;ls -A&#x27;</span><br><span class="hljs-built_in">alias</span> l=<span class="hljs-string">&#x27;ls -CF&#x27;</span><br><br><span class="hljs-comment"># statistic bash</span><br><span class="hljs-keyword">function</span> <span class="hljs-function"><span class="hljs-title">bash_stats</span></span>()&#123;<br>  <span class="hljs-built_in">fc</span> -l 1 \<br>    | awk <span class="hljs-string">&#x27;&#123; CMD[$2]++; count++; &#125; END &#123; for (a in CMD) print CMD[a] &quot; &quot; CMD[a]*100/count &quot;% &quot; a &#125;&#x27;</span> \<br>    | grep -v <span class="hljs-string">&quot;./&quot;</span> | <span class="hljs-built_in">sort</span> -nr | <span class="hljs-built_in">head</span> -n 20 | column -c3 -s <span class="hljs-string">&quot; &quot;</span> -t | <span class="hljs-built_in">nl</span><br>&#125;<br><br><br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>Linux</category>
      
    </categories>
    
    
    <tags>
      
      <tag>HPC</tag>
      
      <tag>shell script</tag>
      
      <tag>bashrc</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>neovim</title>
    <link href="/2023/05/01/neovim/"/>
    <url>/2023/05/01/neovim/</url>
    
    <content type="html"><![CDATA[<h1 id="neovim">neovim</h1><p><a href="https://github.com/neovim/neovim">Git neovim</a></p><h2 id="installation">Installation</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs sh">git <span class="hljs-built_in">clone</span> https://github.com/neovim/neovim<br><span class="hljs-built_in">cd</span> neovim <br>make CMAKE_BUILD_TYPE=Release<br>git checkout stable<br><br><span class="hljs-built_in">rm</span> -r build/  <span class="hljs-comment"># clear the CMake cache</span><br><span class="hljs-comment"># To install the executable to a certain location, use:</span><br>make CMAKE_EXTRA_FLAGS=<span class="hljs-string">&quot;-DCMAKE_INSTALL_PREFIX=<span class="hljs-variable">$HOME</span>/shells_setup/neovim&quot;</span><br>make install<br><span class="hljs-built_in">export</span> PATH=<span class="hljs-string">&quot;<span class="hljs-variable">$HOME</span>/shells_setup/neovim/bin:<span class="hljs-variable">$PATH</span>&quot;</span><br></code></pre></td></tr></table></figure><p>make CMAKE_BUILD_TYPE=Release/Debug/RelWithDebInfo</p><p>The build type determines the level of used compiler optimizations and debug information: - <strong>Release</strong>: Full compiler optimizations and no debug information. Expect the best performance from this build type. Often used by package maintainers. - <strong>Debug</strong>: Full debug information; few optimizations. Use this for development to get meaningful output from debuggers like GDB or LLDB. This is the default if CMAKE_BUILD_TYPE is not specified. - <strong>RelWithDebInfo</strong> ("Release With Debug Info"): Enables many optimizations and adds enough debug info so that when Neovim ever crashes, you can still get a backtrace.</p><h2 id="edit-nvim-config">Edit nvim config</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-built_in">mkdir</span> ~/.config/nvim/<br>~/.config/nvim/init.vim<br></code></pre></td></tr></table></figure><h2 id="apple-others-config">Apple other's config</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sh">git <span class="hljs-built_in">clone</span> --depth=1 https://github.com/Avimitin/nvim.git ~/.config/nvim<br><span class="hljs-comment"># or</span><br><br></code></pre></td></tr></table></figure><h2 id="error">Error</h2><h3 id="binsh-2-cmake-not-found">/bin/sh: 2: cmake: not found</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-built_in">sudo</span> apt install gcc-multilib<br><span class="hljs-built_in">sudo</span> apt install cmake<br></code></pre></td></tr></table></figure><h3 id="could-not-find-gettext">Could NOT find Gettext</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-built_in">sudo</span> apt-get install -y gettext<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>Linux</category>
      
    </categories>
    
    
    <tags>
      
      <tag>HPC</tag>
      
      <tag>vim</tag>
      
      <tag>editor</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ERA5 dataset</title>
    <link href="/2023/04/30/ERA5_dataset/"/>
    <url>/2023/04/30/ERA5_dataset/</url>
    
    <content type="html"><![CDATA[<h1 id="era5-dataset">ERA5 dataset</h1><p>It is imperative to complete the registration process on the Copernicus Climate Data Store by creating an account.</p><p>Some related links,</p><p><a href="https://forum.mmm.ucar.edu/threads/wrf-using-era5-data.12116/">WRF using ERA5 data</a></p><ul><li><a href="https://cds.climate.copernicus.eu/">Climate Data Store - Copernicus</a></li><li><a href="https://rda.ucar.edu/datasets/ds633.0/dataaccess/">ERA5 (UCAR) ERA5 Reanalysis (0.25 Degree Latitude-Longitude Grid) ds633.0 DOI: 10.5065/BH6N-5N20</a></li><li><a href="https://cds.climate.copernicus.eu/cdsapp#!/dataset/reanalysis-era5-single-levels?tab=overview">ERA5 hourly data on single levels from 1940 to present</a></li><li><a href="https://cds.climate.copernicus.eu/cdsapp#!/dataset/reanalysis-era5-pressure-levels?tab=overview">ERA5 hourly data on pressure levels from 1940 to present</a></li></ul><h2 id="required-meteorological-fields-for-running-wrf">Required Meteorological Fields for Running WRF</h2><blockquote><p><a href="https://www2.mmm.ucar.edu/wrf/users/docs/user_guide_v4/v4.1/users_guide_chap3.html#_Required_Meteorological_Fields">user_guide_v4/v4.1/users_guide_chap3.html#_Required_Meteorological_Fields</a></p></blockquote><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs sh">3D Data (e.g. data on pressure levels)<br>Temperature<br>U and V components of Wind<br>Geopotential Height<br>Relative Humidity (the code can calculate RH <span class="hljs-keyword">if</span> Specific Humidity is available;this is controlled <span class="hljs-keyword">in</span> the Vtable)<br><br>2D Data<br>Surface Pressure<br>Mean Sea Level Pressure<br>Skin Temperature/SST<br>2-meter Temperature<br>2-meter Relative or Specific Humidity<br>10-meter U and V components of wind<br>Soil data (temperature and moisture) and soil height<br>If any masked field is ingested, <span class="hljs-keyword">then</span> a LANDSEA field is recommended<br>Water equivalent snow depth (SNOW) is a <span class="hljs-built_in">nice</span> field to have, but not required.<br>SEAICE is good to have <span class="hljs-keyword">for</span> a high latitude winter <span class="hljs-keyword">case</span>, but it is not required.<br></code></pre></td></tr></table></figure><h2 id="shell-script">Shell script</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-meta">#!/bin/sh</span><br><span class="hljs-comment"># source requried packages</span><br><span class="hljs-built_in">source</span> /home/wpsze/anaconda3/bin/activate venv<br><br>yyyy=<span class="hljs-string">&#x27;2022&#x27;</span><br>mm=<span class="hljs-string">&#x27;06&#x27;</span><br><span class="hljs-built_in">dd</span>=<span class="hljs-string">&#x27;26&#x27;</span><br>hh=<span class="hljs-string">&#x27;18&#x27;</span><br><br><span class="hljs-keyword">for</span> next_hh <span class="hljs-keyword">in</span> $(<span class="hljs-built_in">seq</span> 0 3 36); <span class="hljs-keyword">do</span> <span class="hljs-comment"># Forecast time = 12, 24, 36, 48, 60, 72, 84, 96, 108, 130</span><br>NEXT_DATE=$(TZ=UTC <span class="hljs-built_in">date</span> -d <span class="hljs-string">&quot;<span class="hljs-variable">$&#123;yyyy&#125;</span>-<span class="hljs-variable">$&#123;mm&#125;</span>-<span class="hljs-variable">$&#123;dd&#125;</span>T<span class="hljs-variable">$&#123;hh&#125;</span>:00:00Z +<span class="hljs-variable">$next_hh</span> hour&quot;</span> +%Y%m%d%H)<br><span class="hljs-built_in">echo</span> <span class="hljs-variable">$&#123;NEXT_DATE&#125;</span><br><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;downloading &quot;</span> <span class="hljs-variable">$&#123;NEXT_DATE&#125;</span><br>SLoutfile=<span class="hljs-string">&quot;ERA5-0p25-SL-<span class="hljs-variable">$&#123;NEXT_DATE&#125;</span>.grib&quot;</span><br>PLoutfile=<span class="hljs-string">&quot;ERA5-0p25-PL-<span class="hljs-variable">$&#123;NEXT_DATE&#125;</span>.grib&quot;</span><br>resolution=<span class="hljs-string">&quot;0.25&quot;</span><br><br>python ERA5-sl.py <span class="hljs-variable">$&#123;NEXT_DATE&#125;</span> <span class="hljs-variable">$&#123;SLoutfile&#125;</span> <span class="hljs-variable">$&#123;resolution&#125;</span><br>python ERA5-pl.py <span class="hljs-variable">$&#123;NEXT_DATE&#125;</span> <span class="hljs-variable">$&#123;PLoutfile&#125;</span> <span class="hljs-variable">$&#123;resolution&#125;</span><br><span class="hljs-keyword">done</span><br></code></pre></td></tr></table></figure><h2 id="era5-sl.py">ERA5-sl.py</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/env python</span><br><span class="hljs-comment"># Retrieve ERA5 data on single levels(sl)</span><br><span class="hljs-keyword">import</span> argparse<br>parser = argparse.ArgumentParser()<br>parser.add_argument(<span class="hljs-string">&quot;datetime_string&quot;</span>, <span class="hljs-built_in">help</span>=<span class="hljs-string">&quot;Datetime string of the downloaded data in format YYYYMMDDHH&quot;</span>, <span class="hljs-built_in">type</span>=<span class="hljs-built_in">str</span>)<br>parser.add_argument(<span class="hljs-string">&quot;ofile&quot;</span>, <span class="hljs-built_in">help</span>=<span class="hljs-string">&quot;Output file of the downloaded data, e.g. ERA5-SL-YYYYMMDDHH.grib&quot;</span>, <span class="hljs-built_in">type</span>=<span class="hljs-built_in">str</span>)<br>parser.add_argument(<span class="hljs-string">&quot;resoln&quot;</span>, <span class="hljs-built_in">help</span>=<span class="hljs-string">&quot;Horizontal resolution of the downloaded data (in degree), e.g. 0.25&quot;</span>, <span class="hljs-built_in">type</span>=<span class="hljs-built_in">str</span>)<br>args = parser.parse_args()<br><br><span class="hljs-keyword">import</span> datetime<br>datetime_object = datetime.datetime.strptime(args.datetime_string, <span class="hljs-string">&quot;%Y%m%d%H&quot;</span>)<br>yyyy = datetime_object.strftime(<span class="hljs-string">&quot;%Y&quot;</span>)<br>mm = datetime_object.strftime(<span class="hljs-string">&quot;%m&quot;</span>)<br>dd = datetime_object.strftime(<span class="hljs-string">&quot;%d&quot;</span>)<br>hh = datetime_object.strftime(<span class="hljs-string">&quot;%H:00&quot;</span>)<br><br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;================&quot;</span>, args)<br><br><span class="hljs-keyword">import</span> sys<br><span class="hljs-keyword">import</span> logging<br><span class="hljs-keyword">import</span> cdsapi<br>c = cdsapi.Client()<br><span class="hljs-keyword">try</span>:<br>    c.retrieve(<br>        <span class="hljs-string">&quot;reanalysis-era5-single-levels&quot;</span>,<br>        &#123;<br>            <span class="hljs-string">&quot;product_type&quot;</span>: <span class="hljs-string">&quot;reanalysis&quot;</span>,<br>            <span class="hljs-string">&quot;format&quot;</span>: <span class="hljs-string">&quot;grib&quot;</span>,<br>            <span class="hljs-string">&quot;variable&quot;</span>: [<br>                <span class="hljs-string">&quot;10m_u_component_of_wind&quot;</span>,<br>                <span class="hljs-string">&quot;10m_v_component_of_wind&quot;</span>,<br>                <span class="hljs-string">&quot;2m_dewpoint_temperature&quot;</span>,<br>                <span class="hljs-string">&quot;2m_temperature&quot;</span>,<br>                <span class="hljs-string">&quot;land_sea_mask&quot;</span>,<br>                <span class="hljs-string">&quot;mean_sea_level_pressure&quot;</span>,<br>                <span class="hljs-string">&quot;sea_ice_cover&quot;</span>,<br>                <span class="hljs-string">&quot;sea_surface_temperature&quot;</span>,<br>                <span class="hljs-string">&quot;skin_temperature&quot;</span>,<br>                <span class="hljs-string">&quot;snow_density&quot;</span>,<br>                <span class="hljs-string">&quot;snow_depth&quot;</span>,<br>                <span class="hljs-string">&quot;soil_temperature_level_1&quot;</span>,<br>                <span class="hljs-string">&quot;soil_temperature_level_2&quot;</span>,<br>                <span class="hljs-string">&quot;soil_temperature_level_3&quot;</span>,<br>                <span class="hljs-string">&quot;soil_temperature_level_4&quot;</span>,<br>                <span class="hljs-string">&quot;surface_pressure&quot;</span>,<br>                <span class="hljs-string">&quot;volumetric_soil_water_layer_1&quot;</span>,<br>                <span class="hljs-string">&quot;volumetric_soil_water_layer_2&quot;</span>,<br>                <span class="hljs-string">&quot;volumetric_soil_water_layer_3&quot;</span>,<br>                <span class="hljs-string">&quot;volumetric_soil_water_layer_4&quot;</span>,<br><span class="hljs-string">&quot;geopotential&quot;</span><br>            ],<br>            <span class="hljs-string">&quot;grid&quot;</span>: [args.resoln, args.resoln],<br>            <span class="hljs-string">&quot;year&quot;</span>: yyyy,<br>            <span class="hljs-string">&quot;month&quot;</span>: [<br>                mm<br>            ],<br>            <span class="hljs-string">&quot;day&quot;</span>: [<br>                dd<br>            ],<br>            <span class="hljs-string">&quot;time&quot;</span>: [<br>                hh<br>            ],<br>        <span class="hljs-comment">#    &quot;area&quot;:[15, 90, 10, 120], # North, West, South, East. Default: global</span><br>        &#125;,<br>        args.ofile)<br><span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> err:<br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">str</span>(err) == <span class="hljs-string">&quot;no data is available within your requested subset. Request returned no data.&quot;</span>:<br>        logging.exception(err)<br>        sys.exit(<span class="hljs-number">96</span>)<br>    <span class="hljs-keyword">else</span>:<br>        <span class="hljs-keyword">raise</span> err<br></code></pre></td></tr></table></figure><blockquote><p>Remark: + geopotential? Yes for SOILHGT field not found in intermediate file ERA5</p></blockquote><h2 id="era5-pl.py">ERA5-pl.py</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-meta">#!/usr/bin/env python</span><br><span class="hljs-comment"># Retrieve ERA5 data on pressure level(pl)</span><br>import argparse<br>parser = argparse.ArgumentParser()<br>parser.add_argument(<span class="hljs-string">&quot;datetime_string&quot;</span>, <span class="hljs-built_in">help</span>=<span class="hljs-string">&quot;Datetime string of the downloaded data in format YYYYMMDDHH&quot;</span>, <span class="hljs-built_in">type</span>=str)<br>parser.add_argument(<span class="hljs-string">&quot;ofile&quot;</span>, <span class="hljs-built_in">help</span>=<span class="hljs-string">&quot;Output file of the downloaded data, e.g. ERA5-PL-YYYYMMDDHH.grib&quot;</span>, <span class="hljs-built_in">type</span>=str)<br>parser.add_argument(<span class="hljs-string">&quot;resoln&quot;</span>, <span class="hljs-built_in">help</span>=<span class="hljs-string">&quot;Horizontal resolution of the downloaded data (in degree), e.g. 0.25&quot;</span>, <span class="hljs-built_in">type</span>=str)<br>args = parser.parse_args()<br><br>import datetime<br>datetime_object = datetime.datetime.strptime(args.datetime_string, <span class="hljs-string">&quot;%Y%m%d%H&quot;</span>)<br>yyyy = datetime_object.strftime(<span class="hljs-string">&quot;%Y&quot;</span>)<br>mm = datetime_object.strftime(<span class="hljs-string">&quot;%m&quot;</span>)<br><span class="hljs-built_in">dd</span> = datetime_object.strftime(<span class="hljs-string">&quot;%d&quot;</span>)<br>hh = datetime_object.strftime(<span class="hljs-string">&quot;%H:00&quot;</span>)<br><br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;================&quot;</span>, args)<br><br>import sys<br>import logging<br>import cdsapi<br>c = cdsapi.Client()<br>try:<br>    c.retrieve(<br>        <span class="hljs-string">&quot;reanalysis-era5-pressure-levels&quot;</span>,<br>        &#123;<br>            <span class="hljs-string">&quot;product_type&quot;</span>: <span class="hljs-string">&quot;reanalysis&quot;</span>,<br>            <span class="hljs-string">&quot;format&quot;</span>: <span class="hljs-string">&quot;grib&quot;</span>,<br>            <span class="hljs-string">&quot;variable&quot;</span>: [<br>                <span class="hljs-string">&quot;geopotential&quot;</span>,<br>                <span class="hljs-string">&quot;relative_humidity&quot;</span>,<br>                <span class="hljs-string">&quot;specific_humidity&quot;</span>,<br>                <span class="hljs-string">&quot;temperature&quot;</span>,<br>                <span class="hljs-string">&quot;u_component_of_wind&quot;</span>,<br>                <span class="hljs-string">&quot;v_component_of_wind&quot;</span><br>            ],<br>            <span class="hljs-string">&quot;pressure_level&quot;</span>: [<br>                <span class="hljs-string">&#x27;1&#x27;</span>, <span class="hljs-string">&#x27;2&#x27;</span>, <span class="hljs-string">&#x27;3&#x27;</span>,<br>                <span class="hljs-string">&#x27;5&#x27;</span>, <span class="hljs-string">&#x27;7&#x27;</span>, <span class="hljs-string">&#x27;10&#x27;</span>,<br>                <span class="hljs-string">&#x27;20&#x27;</span>, <span class="hljs-string">&#x27;30&#x27;</span>, <span class="hljs-string">&#x27;50&#x27;</span>,<br>                <span class="hljs-string">&#x27;70&#x27;</span>, <span class="hljs-string">&#x27;100&#x27;</span>, <span class="hljs-string">&#x27;125&#x27;</span>,<br>                <span class="hljs-string">&#x27;150&#x27;</span>, <span class="hljs-string">&#x27;175&#x27;</span>, <span class="hljs-string">&#x27;200&#x27;</span>,<br>                <span class="hljs-string">&#x27;225&#x27;</span>, <span class="hljs-string">&#x27;250&#x27;</span>, <span class="hljs-string">&#x27;300&#x27;</span>,<br>                <span class="hljs-string">&#x27;350&#x27;</span>, <span class="hljs-string">&#x27;400&#x27;</span>, <span class="hljs-string">&#x27;450&#x27;</span>,<br>                <span class="hljs-string">&#x27;500&#x27;</span>, <span class="hljs-string">&#x27;550&#x27;</span>, <span class="hljs-string">&#x27;600&#x27;</span>,<br>                <span class="hljs-string">&#x27;650&#x27;</span>, <span class="hljs-string">&#x27;700&#x27;</span>, <span class="hljs-string">&#x27;750&#x27;</span>,<br>                <span class="hljs-string">&#x27;775&#x27;</span>, <span class="hljs-string">&#x27;800&#x27;</span>, <span class="hljs-string">&#x27;825&#x27;</span>,<br>                <span class="hljs-string">&#x27;850&#x27;</span>, <span class="hljs-string">&#x27;875&#x27;</span>, <span class="hljs-string">&#x27;900&#x27;</span>,<br>                <span class="hljs-string">&#x27;925&#x27;</span>, <span class="hljs-string">&#x27;950&#x27;</span>, <span class="hljs-string">&#x27;975&#x27;</span>,<br>                <span class="hljs-string">&#x27;1000&#x27;</span><br>            ],<br>            <span class="hljs-string">&quot;grid&quot;</span>: [args.resoln, args.resoln],<br>            <span class="hljs-string">&quot;year&quot;</span>: yyyy,<br>            <span class="hljs-string">&quot;month&quot;</span>: [<br>                mm<br>            ],<br>            <span class="hljs-string">&quot;day&quot;</span>: [<br>                <span class="hljs-built_in">dd</span><br>            ],<br>            <span class="hljs-string">&quot;time&quot;</span>: [<br>                hh<br>            ],<br>        <span class="hljs-comment">#    &quot;area&quot;:[15, 90, 10, 120], # North, West, South, East. Default: global</span><br>        &#125;,<br>        args.ofile)<br>except Exception as err:<br>    <span class="hljs-keyword">if</span> str(err) == <span class="hljs-string">&quot;no data is available within your requested subset. Request returned no data.&quot;</span>:<br>        logging.exception(err)<br>        sys.exit(96)<br>    <span class="hljs-keyword">else</span>:<br>        raise err<br><br><br></code></pre></td></tr></table></figure><h2 id="vtable">Vtable</h2><p>The Vtable that comes with WRF includes not only Vtable.ECMWF, but also Vtable.ERA-interim.pl and Vtable.ERA-interim.ml, where Vtable.ERA-interim.pl corresponds to the ERA-Interim data of the pressure level, Vtable.ERA-interim.ml corresponds to the ERA-Interim data of the model level.</p><h3 id="vtable.era-interim.pl">Vtable.ERA-interim.pl</h3><p><strong>Latest commit b5df64a on Apr 12, 2011</strong> For use with ERA-interim pressure-level output For ERA-interim data at NCAR, use the pl (sc and uv) and sfc sc files. &gt; <a href="https://github.com/openwfm/wrf-fire/blob/master/WPS/ungrib/Variable_Tables/Vtable.ERA-interim.pl">Vtable.ERA-interim.pl</a></p><h3 id="vtable.ecmwf">Vtable.ECMWF</h3><p><strong>Latest commit 5c01f57 on Jun 12, 2010</strong> &gt; <a href="https://github.com/openwfm/wrf-fire/blob/master/WPS/ungrib/Variable_Tables/Vtable.ECMWF">Vtable.ECMWF</a></p><h3 id="vtable.era-interim.ml">Vtable.ERA-interim.ml</h3><p><strong>Latest commit b5df64a on Apr 12, 2011</strong> For use with ERA-interim model-level output. For ERA-interim data at NCAR, use the ml (sc and uv) and sfc sc files. &gt; <a href="https://github.com/openwfm/wrf-fire/blob/master/WPS/ungrib/Variable_Tables/Vtable.ERA-interim.ml">Vtable.ERA-interim.ml</a></p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-built_in">ln</span> -s /xxx/ERA-interim.pl Vtable<br><br><span class="hljs-comment"># If Vtable.ERA-interim.pl works for you, I don&#x27;t think you need to switch to Vtable.ECMWRF.</span><br><span class="hljs-comment"># If not, Please use Vtable.ECMWF to ungrib ERA5 data. </span><br><span class="hljs-built_in">ln</span> -s /xxx/Vtable.ECMWF Vtable<br></code></pre></td></tr></table></figure><h2 id="link_grib.csh">./link_grib.csh</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">$ ./link_grib.csh ../DATA/ERA5/*.grib<br></code></pre></td></tr></table></figure><h2 id="namelist.wps-setup-ungrib">namelist.wps, setup &amp;ungrib</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs sh">&amp;ungrib<br> out_format = <span class="hljs-string">&#x27;WPS&#x27;</span>,<br> prefix = <span class="hljs-string">&#x27;FILE&#x27;</span>,<br>/<br></code></pre></td></tr></table></figure><h2 id="ungrib.exe">./ungrib.exe</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">$ ./ungrib.exe<br></code></pre></td></tr></table></figure><p>Outputs are format of <strong>FILE:2022-06-27_15</strong> that is intermediate file that are ready for WRF metgrid or MPAS init.</p><h2 id="error-missingincomplete-configuration-file-homexx.cdsapirc">Error: Missing/incomplete configuration file: /home/xx/.cdsapirc??</h2><p>The reason is that the .cdsapirc file under /home/xx/ is missing. This file contains the downloaded Key. We go to this link (https://cds.climate.copernicus.eu/api-how-to) to get it as required To our Key, if there is no registration, the key will appear directly on the right after registration. At this time, we will copy the things on the right Copy the code shown next to the file $HOME/.cdsapirc (in your Unix/Linux environment).</p><p>check, &gt; ll -a /home/wpsze/.cdsapirc</p><h2 id="soilhgt-field-not-found-in-intermediate-file-era5">SOILHGT field not found in intermediate file ERA5</h2><p>Besides processing the time-dependent atmospheric and land-surface ERA5 fields, I think you will also need to use ungrib to process the ERA5 invariant fields, including SOILHGT. Once you've created an intermediate file with invariant fields, you can concatenate the contents of that file to each of your time-varying intermediate files. <a href="https://forum.mmm.ucar.edu/threads/error-while-interpolating-regional-initial-conditions-using-era-5-grib-data.12532/">link</a></p><p>The HGT_M value from geogrid comes from the static topographic data. The met_em files contain both that HGT_M value, which is identical to the value from geogrid, and <strong>SOILHGT, which is the terrain information coming from the input/first-guess data (e.g., GFS)</strong>. During real.exe, both are used again. The HGT value in the wrfinput* files comes from the HGT_M value and should still be the same at that time (if using the default namelist setting surface_input_source=3). <strong>real.exe also checks for SOILHGT, which is used for smoothing the coarse grid topography on domain 1 during the wrf process.</strong> <a href="https://forum.mmm.ucar.edu/threads/soilhgt.11582/">link</a></p><p>Smooth_cg_topo and ERA-5 / ERA-Interim data? &gt; For ECMWF and ERA, the Vtable says it uses grib code 129 level 0 for both SOILGEO and SOILHGT. Please download ERA5 terrain data from /FS/DECS/DS630.0/e5.oper.invariant/201601/e5.oper.invariant.128_129_z.regn320sc.2016010100_2016010100.grb ERA-I terrain can be found in https://rda.ucar.edu/datasets/ds627.0/, where if you download any sfc dataset, you can find terrain data in it.<a href="https://forum.mmm.ucar.edu/threads/smooth_cg_topo-and-era-5-era-interim-data.9323/">link</a></p>]]></content>
    
    
    <categories>
      
      <category>NWP</category>
      
    </categories>
    
    
    <tags>
      
      <tag>WRF</tag>
      
      <tag>WPS</tag>
      
      <tag>MPAS</tag>
      
      <tag>IC/BC</tag>
      
      <tag>ERA5</tag>
      
      <tag>ECMWF</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>WRF | WPS namelist.wps Best Practices</title>
    <link href="/2023/04/30/WPS_namelist_wps_Best_Practices/"/>
    <url>/2023/04/30/WPS_namelist_wps_Best_Practices/</url>
    
    <content type="html"><![CDATA[<h1 id="wps-namelist.wps-best-practices">WPS namelist.wps: Best Practices</h1><p><a href="https://www2.mmm.ucar.edu/wrf/users/namelist_best_prac_wps.html">https://www2.mmm.ucar.edu/wrf/users/namelist_best_prac_wps.html</a></p><ol type="1"><li>In namelist.wps, multiple columns are used for multiple domains; however max_domains determines how many columns will be used. For example, if you use 3 columns, but only set max_dom = 2, the last column will be ignored.</li><li>Not all parameters have mulitple columns.</li></ol><h2 id="max_dom">max_dom</h2><p>Nested domains are necessary when scaling down from coarse first-guess (input) data to a fine resolution, and the recommended ratios for coarse data resolution to the parent domain are odd ratios of <strong>3:1 or 5:1</strong>. For example, if your domain of interest needs to have a resolution of 3 km, but your input data have a resolution of 27 km, and you are using a 3:1 ratio, your domain 01, should be around 9 km, and then you can have a nested domain with 3 km grid spacing. In this case, max_dom = 3.</p><h2 id="parent_grid_ratio">parent_grid_ratio</h2><p>The nesting ratio relative to the domain's parent. <strong>For the coarsest domain, parent_grid_ratio should be set to 1</strong>. <strong>Recommended ratios are 3 or 5</strong>. If you are unfamiliar with the model, it is best to leave this set to 3. It is not recommended to use an even number ratio since it is best to have a center grid cell for the fine domain that corresponds with the center of the coarse domain. grid cell.</p><h2 id="i_-j_parent_start">i_, j_parent_start</h2><p>It is good practice to keep nest boundaries away from coarse domain boundaries, and to keep them away from steep topography. As a rough approximation, <strong>keep about 1/3 of the coarse-grid domain surrounding each side of the nest</strong>. This does not have to be exact, and the nest does not have to be centered perfectly, but this helps to stay away from problems later. If the prevailing winds are westerly, it is better to place the nest further away from the west boundary, than the east.</p><h2 id="e_we-e_sn">e_we, e_sn</h2><p>It is recommended to have domains <strong>no smaller than about 100x100</strong>. Note that there will be about 10 grid points (minimum of 5) on each side, in the boundary zone. If domains are too small, the solution will be determined by forcing data. When considering the size of the coarse domain, <strong>there is no need to be economical. Doubling the size of the coarse grid domain will only result in a 25% nested forecast time increase</strong>. <strong>It's also important to consider the speed at which systems are moving through the simulated region. A multi-day forecast needs a much larger domain than a short forecast. If cost is prohibitive, consider adding an external domain.</strong></p><h2 id="geog_data_res">geog_data_res</h2><p>Prior to V3.8, if you wish to use the MODIS data, it would be necessary to specify:</p><blockquote><p>geog_data_res = 'modis_30s+10m', 'modis_30s+2m', 'modis_30s+30s'</p></blockquote><p>Possible available resolutions are <strong>10m (~19km), 5m (~9km), 2m (~4km), and 30s (~0.9km)</strong>. When there are multiple resolutions available for geographical input data, choose a resolution that is <strong>slightly better</strong> than your grid resolution. For example, <strong>if your grid resolution is 9km, using 2 minute static data would be ideal</strong>.</p><h2 id="dx-dy">dx, dy</h2><p>This is given in meters for the Lambert, Polar, and Mercator projections. For the 'lat-lon' projection, this is given in degrees latitude. For namelist.wps it is only necessary to specify the coarse domain resolution, as nest domains will be calculated based on parent_grid_ratio. It is recommended that <strong>dx and dy have the same value</strong> for Mercator, Polar, and Lambert projections.</p><h2 id="map_proj">map_proj</h2><ul><li>lambert: well-suited for mid-latitudes; domain cannot contain poles; domain cannot be periodic in west-east direction</li><li>mercator: well-suited for low-latitudes; may be used for a "channel" domain (periodic in west-east direction).</li><li>polar: good for high-latitude domains, especially if the domain contains a pole</li><li>lat-lon: also called cylindrical equidistant; required for global domains (but does not have to be global); can be used in its normal or rotated aspect</li></ul><p>It is best to check the range of the map scale factor (e.g., <strong>MAPFRAC_M</strong> for the map factor in the center of a grid cell) after running geogrid.exe (this can be checked easily with the ncview program). <strong>Values should be close to 1 to ensure the projection is not causing distortion.</strong></p><h2 id="ref_lat-ref_lon">ref_lat, ref_lon</h2><p>Real values specifying the latitude and longitude of a location whose (i,j) location in the simulation is known. &gt; For ARW, ref_lat and ref_lon give the latitude and longitude of a known location in the domain (it's recommended that these are set to the center of the coarse domain</p><h2 id="truelat12">truelat1/2</h2><ul><li>truelat1: A real value specifying the first true latitude for the Lambert conformal conic projection, or the true latitude for the polar stereographic projection, or the Mercator projection.</li><li>truelat2: A real value specifying the second true latitude for the Lambert conformal conic projection.</li></ul><h2 id="stand_lon">stand_lon</h2><p>If this longitude is set to the <strong>same value as ref_lon</strong>, your coarsest domain will be centered.</p><h2 id="geog_data_path">geog_data_path</h2><p>It's best to set this to <strong>the absolute path.</strong></p><h2 id="ungrid">&amp;ungrid</h2><h3 id="out_format">out_format</h3><p>If you are running ungrib in the WPS/ program, this should be set to <strong>"WPS."</strong></p><h3 id="prefix">prefix</h3><p>The prefix that will be assigned to intermediate files (produced from the ungrib.exe program). This can be left as set to 'FILE' or can be changed to anything you choose like GFS, ERA5, SST.</p><blockquote><p>If you will be using more than one type of input data, and it's necessary to run ungrib twice, you may consider setting this to something that is meaningful to the data type (e.g., "SST" for sea surface temperature data). If you do need to run ungrib twice, set this to only one prefix name per ungrib.exe run.</p></blockquote><h2 id="metgrid">&amp;metgrid</h2><h3 id="fg_name">fg_name</h3><p>This is the prefix that was used when the intermediate files were created (see above). To combine different data sources, <strong>list all prefixes</strong> (e.g., fg_name = 'GFS', 'SST'), that combine GFS and SST</p>]]></content>
    
    
    <categories>
      
      <category>WRF</category>
      
    </categories>
    
    
    <tags>
      
      <tag>WRF</tag>
      
      <tag>WPS</tag>
      
      <tag>namelist.wps</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>WRF | WPS namelist.wps Examples</title>
    <link href="/2023/04/30/WPS_namelist_wps_examples/"/>
    <url>/2023/04/30/WPS_namelist_wps_examples/</url>
    
    <content type="html"><![CDATA[<h1 id="wps-namelist.wps-examples">WPS namelist.wps Examples</h1><h2 id="namelist.wps">namelist.wps</h2><p><a href="https://github.com/wrf-model/WPS/blob/master/namelist.wps">Git namelist.wps</a></p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs sh">&amp;share<br> wrf_core = <span class="hljs-string">&#x27;ARW&#x27;</span>,<br> max_dom = 2,<br> start_date = <span class="hljs-string">&#x27;2019-09-04_12:00:00&#x27;</span>,<span class="hljs-string">&#x27;2019-09-04_12:00:00&#x27;</span>,<br> end_date   = <span class="hljs-string">&#x27;2019-09-06_00:00:00&#x27;</span>,<span class="hljs-string">&#x27;2019-09-04_12:00:00&#x27;</span>,<br> interval_seconds = 10800<br>/<br><br>&amp;geogrid<br> parent_id         =   1,   1,<br> parent_grid_ratio =   1,   3,<br> i_parent_start    =   1,  53,<br> j_parent_start    =   1,  25,<br> e_we              =  150, 220,<br> e_sn              =  130, 214,<br> geog_data_res = <span class="hljs-string">&#x27;default&#x27;</span>,<span class="hljs-string">&#x27;default&#x27;</span>,<br> dx = 15000,<br> dy = 15000,<br> map_proj = <span class="hljs-string">&#x27;lambert&#x27;</span>,<br> ref_lat   =  33.00,<br> ref_lon   = -79.00,<br> truelat1  =  30.0,<br> truelat2  =  60.0,<br> stand_lon = -79.0,<br> geog_data_path = <span class="hljs-string">&#x27;/glade/work/wrfhelp/WPS_GEOG/&#x27;</span><br>/<br><br>&amp;ungrib<br> out_format = <span class="hljs-string">&#x27;WPS&#x27;</span>,<br> prefix = <span class="hljs-string">&#x27;FILE&#x27;</span>,<br>/<br><br>&amp;metgrid<br> fg_name = <span class="hljs-string">&#x27;FILE&#x27;</span><br>/<br></code></pre></td></tr></table></figure><h2 id="namelist.wps.all_options">namelist.wps.all_options</h2><p><a href="https://github.com/wrf-model/WPS/blob/master/namelist.wps.all_options">Git namelist.wps.all_options</a></p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><code class="hljs sh">&amp;share<br> wrf_core = <span class="hljs-string">&#x27;ARW&#x27;</span>,<br> max_dom = 2,<br> start_date = <span class="hljs-string">&#x27;2006-08-16_12:00:00&#x27;</span>,<span class="hljs-string">&#x27;2006-08-16_12:00:00&#x27;</span>,<br> end_date   = <span class="hljs-string">&#x27;2006-08-16_18:00:00&#x27;</span>,<span class="hljs-string">&#x27;2006-08-16_12:00:00&#x27;</span>,<br> interval_seconds = 21600<br> active_grid = .<span class="hljs-literal">true</span>., .<span class="hljs-literal">true</span>.,<br> subgrid_ratio_x = 1<br> subgrid_ratio_y = 1<br> io_form_geogrid = 2,<br> opt_output_from_geogrid_path = <span class="hljs-string">&#x27;./&#x27;</span>,<br> debug_level = 0<br>/<br> start_date = <span class="hljs-string">&#x27;2000-01-24_12:00:00&#x27;</span>,<span class="hljs-string">&#x27;2000-01-24_12:00:00&#x27;</span>,<br> end_date   = <span class="hljs-string">&#x27;2000-01-25_12:00:00&#x27;</span>,<span class="hljs-string">&#x27;2000-01-24_12:00:00&#x27;</span>,<br> start_year   = 2006, 2006,<br> start_month  =   08,   08,<br> start_day    =   16,   16,<br> start_hour   =   12,   12,<br> start_minute =   00,   00,<br> start_second =   00,   00,<br> end_year     = 2006, 2006,<br> end_month    =   08,   08,<br> end_day      =   16,   16,<br> end_hour     =   18,   12,<br> end_minute   =   00,   00,<br> end_second   =   00,   00,<br><br>&amp;geogrid<br> parent_id         =   1,   1,<br> parent_grid_ratio =   1,   3,<br> i_parent_start    =   1,  31,<br> j_parent_start    =   1,  17,<br> s_we              =   1,   1,<br> e_we              =  74, 112,<br> s_sn              =   1,   1,<br> e_sn              =  61,  97,<br> !<br> !!!!!!!!!!!!!!!!!!!!!!!!!!!! IMPORTANT NOTE !!!!!!!!!!!!!!!!!!!!!!!!!!!!<br> ! The default datasets used to produce the MAXSNOALB and ALBEDO12M<br> ! fields have changed <span class="hljs-keyword">in</span> WPS v4.0. These fields are now interpolated<br> ! from MODIS-based datasets.<br> !<br> ! To match the output given by the default namelist.wps <span class="hljs-keyword">in</span> WPS v3.9.1,<br> ! the following setting <span class="hljs-keyword">for</span> geog_data_res may be used:<br> !<br> ! geog_data_res = <span class="hljs-string">&#x27;maxsnowalb_ncep+albedo_ncep+default&#x27;</span>, <span class="hljs-string">&#x27;maxsnowalb_ncep+albedo_ncep+default&#x27;</span>,<br> !<br> !!!!!!!!!!!!!!!!!!!!!!!!!!!! IMPORTANT NOTE !!!!!!!!!!!!!!!!!!!!!!!!!!!!<br> !<br> geog_data_res = <span class="hljs-string">&#x27;default&#x27;</span>,<span class="hljs-string">&#x27;default&#x27;</span>,<br> dx        = 30000,<br> dy        = 30000,<br> map_proj  = <span class="hljs-string">&#x27;lambert&#x27;</span>,<br> ref_lat   =  34.83,<br> ref_lon   = -81.03,<br> ref_x     =  37.0,<br> ref_y     =  30.5,<br> truelat1  =  30.0,<br> truelat2  =  60.0,<br> stand_lon = -98.0,<br> geog_data_path = <span class="hljs-string">&#x27;/glade/work/wrfhelp/WPS_GEOG/&#x27;</span><br> opt_geogrid_tbl_path = <span class="hljs-string">&#x27;geogrid/&#x27;</span><br>/<br> geog_data_res     = <span class="hljs-string">&#x27;modis_lakes+10m&#x27;</span>,<span class="hljs-string">&#x27;modis_lakes+2m&#x27;</span>,<br> geog_data_res     = <span class="hljs-string">&#x27;usgs_lakes+10m&#x27;</span>,<span class="hljs-string">&#x27;usgs_lakes+2m&#x27;</span>,<br><br>&amp;ungrib<br> out_format = <span class="hljs-string">&#x27;WPS&#x27;</span>,<br> prefix     = <span class="hljs-string">&#x27;FILE&#x27;</span>,<br> ec_rec_len = 26214508,<br> pmin = 100.<br>/<br><br>&amp;metgrid<br> fg_name         = <span class="hljs-string">&#x27;FILE&#x27;</span><br> constants_name  = <span class="hljs-string">&#x27;./TAVGSFC&#x27;</span><br> io_form_metgrid = 2, <br> opt_output_from_metgrid_path = <span class="hljs-string">&#x27;./&#x27;</span>,<br> opt_metgrid_tbl_path         = <span class="hljs-string">&#x27;metgrid/&#x27;</span>,<br> process_only_bdy = 5,<br>/<br><br>&amp;mod_levs<br> press_pa = 201300 , 200100 , 100000 , <br>             95000 ,  90000 , <br>             85000 ,  80000 , <br>             75000 ,  70000 , <br>             65000 ,  60000 , <br>             55000 ,  50000 , <br>             45000 ,  40000 , <br>             35000 ,  30000 , <br>             25000 ,  20000 , <br>             15000 ,  10000 , <br>              5000 ,   1000<br>/<br><br>&amp;plotfmt<br> ix = 100<br> jx = 100<br> ioff = 30<br> joff = 30<br>/<br></code></pre></td></tr></table></figure><h2 id="namelist.wps.global">namelist.wps.global</h2><p><a href="https://github.com/wrf-model/WPS/blob/master/namelist.wps.global">Git namelist.wps.global</a></p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><code class="hljs sh">&amp;share<br> wrf_core = <span class="hljs-string">&#x27;ARW&#x27;</span>,<br> max_dom = 2,<br> start_date = <span class="hljs-string">&#x27;2006-08-16_12:00:00&#x27;</span>,<span class="hljs-string">&#x27;2006-08-16_12:00:00&#x27;</span>,<br> end_date   = <span class="hljs-string">&#x27;2006-08-16_12:00:00&#x27;</span>,<span class="hljs-string">&#x27;2006-08-16_12:00:00&#x27;</span>,<br> interval_seconds = 21600<br> io_form_geogrid = 2,<br>/<br><br>&amp;geogrid<br> parent_id         =   1,   1,<br> parent_grid_ratio =   1,   3,<br> i_parent_start    =   1,  31,<br> j_parent_start    =   1,  17,<br> e_we              =  129, 127,<br> e_sn              =  65,  64,<br> !<br> !!!!!!!!!!!!!!!!!!!!!!!!!!!! IMPORTANT NOTE !!!!!!!!!!!!!!!!!!!!!!!!!!!!<br> ! The default datasets used to produce the MAXSNOALB and ALBEDO12M<br> ! fields have changed <span class="hljs-keyword">in</span> WPS v4.0. These fields are now interpolated<br> ! from MODIS-based datasets.<br> !<br> ! To match the output given by the default namelist.wps <span class="hljs-keyword">in</span> WPS v3.9.1,<br> ! the following setting <span class="hljs-keyword">for</span> geog_data_res may be used:<br> !<br> ! geog_data_res = <span class="hljs-string">&#x27;maxsnowalb_ncep+albedo_ncep+default&#x27;</span>, <span class="hljs-string">&#x27;maxsnowalb_ncep+albedo_ncep+default&#x27;</span>,<br> !<br> !!!!!!!!!!!!!!!!!!!!!!!!!!!! IMPORTANT NOTE !!!!!!!!!!!!!!!!!!!!!!!!!!!!<br> !<br> geog_data_res = <span class="hljs-string">&#x27;default&#x27;</span>,<span class="hljs-string">&#x27;default&#x27;</span>,<br> map_proj = <span class="hljs-string">&#x27;lat-lon&#x27;</span>,<br> stand_lon = 0.<br> pole_lat = 90.0<br> pole_lon = 0.0<br> geog_data_path = <span class="hljs-string">&#x27;/glade/work/wrfhelp/WPS_GEOG/&#x27;</span><br>/<br> ref_lat = 45.0<br> ref_lon = -98<br> dx = 1.0<br> dy = 1.0<br><br>&amp;ungrib<br> out_format = <span class="hljs-string">&#x27;WPS&#x27;</span>,<br> prefix = <span class="hljs-string">&#x27;FILE&#x27;</span>,<br>/<br><br>&amp;metgrid<br> fg_name = <span class="hljs-string">&#x27;FILE&#x27;</span><br> io_form_metgrid = 2, <br>/<br><br>&amp;mod_levs<br> press_pa = 201300 , 200100 , 100000 , <br>             95000 ,  90000 , <br>             85000 ,  80000 , <br>             75000 ,  70000 , <br>             65000 ,  60000 , <br>             55000 ,  50000 , <br>             45000 ,  40000 , <br>             35000 ,  30000 , <br>             25000 ,  20000 , <br>             15000 ,  10000 , <br>              5000 ,   1000<br>/<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>WRF</category>
      
    </categories>
    
    
    <tags>
      
      <tag>WRF</tag>
      
      <tag>WPS</tag>
      
      <tag>namelist.wps</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>WRF | WRF namelist.input: Best Practices</title>
    <link href="/2023/04/30/WRF_namelist_input_Best_Practices/"/>
    <url>/2023/04/30/WRF_namelist_input_Best_Practices/</url>
    
    <content type="html"><![CDATA[<h1 id="wrf-namelist.input-best-practices">WRF namelist.input: Best Practices</h1><p><a href="https://www2.mmm.ucar.edu/wrf/users/namelist_best_prac_wrf.html">https://www2.mmm.ucar.edu/wrf/users/namelist_best_prac_wrf.html</a></p><p><a href="https://github.com/wrf-model/WRF/blob/master/run/README.namelist">Git: WRF/run/README.namelist</a></p><ol type="1"><li>In namelist.input, multiple columns are used for multiple domains; however max_dom determines how many columns will be used. For example, if you use 3 columns, but only set max_dom = 2, the last column will be ignored.</li><li>Not all parameters have mulitple columns. In the descriptions below, it has been specified if a parameter is to be used for multiple domains (max_dom). If this is not shown, then you must only specify one value (in the first column), or you will receive a namelist error upon running.</li></ol><h2 id="domains">&amp;domains</h2><h3 id="time_step">time_step</h3><p>It is recommended to use a value of <strong>5-6xDX (in km)</strong> for a typical case. If you are using many vertical levels and/or with map-scale-factors much larger than 1, you will need to use a smaller time_step. If you are getting CFL errors that stop your run, this means your run has become unstable and <strong>you may need to decrease this value to about 4xDX (or perhaps even 3xDX)</strong>. It makes things easier if you use a time step that evenly divides into your history_interval, so that your output times will be evenly spaced.</p><h3 id="e_vert-max_dom">e_vert (max_dom)</h3><p>The number of vertical (or Eta) levels onto which real.exe will interpolate the incoming data. This number must be the same for each domain. It is not recommended to have fewer than 35 levels.** Typically 40-60 levels is recommended**.</p><h3 id="p_top_requested">p_top_requested</h3><p>The pressure top (in Pa) to use in the model. This level must be available in the incoming WPS data. &gt; The <strong>default and recommended value is 5000 Pa</strong>, and it is not suggested to use a level any lower (in the atmosphere) than this.</p><h3 id="num_metgrid_levels">num_metgrid_levels</h3><p>look for the value near the top of the log.ncdump file. &gt; ncdump -h met_em.d01.<date> &gt;&amp; log.ncdump</p><h3 id="feedback">feedback</h3><p>This determines whether feedback will be used when using nesting, and should be used to determine whether the run will be a one-way or two-way nested run. When feedback is on, the values of the coarse domain are overwritten by the values of the variables (average of cell values for mass points, and average of the cell-face values for horizontal momentum points) in the nest at the coincident points. For masked fields, only the single point value at the collocating points is fed back. If the parent_grid_ratio is even, an arbitrary choice of the southwest corner point value is used for feedback. This is the reason it is recommended to use an odd parent_grid_ratio with this option. When feedback is off , it is equivalent to a one-way nested run, since nest results are not reflected in the parent domain.</p><p><strong>usually, set is feedback = 0 (off)</strong></p><h3 id="smooth_option">smooth_option</h3><p>Determines whether smoothing is to be used for the parent domain in the area of the nest <strong>if feedback is on (feedback = 1)</strong>. Three options are available: - 0 = no smoothing - 1 = 1-2-1 smoothing - 2 = smoothing-desmoothing. <strong>It is typically recommended to keep this option set to 0.</strong></p><h2 id="physics">&amp;physics</h2><h3 id="mp_physics-max_dom">mp_physics (max_dom)</h3><p>WSM6 or ...</p><h3 id="ra_lw_physics-max_dom">ra_lw_physics (max_dom)</h3><p>This should be set to the same option for each domain. <strong>We recommend using the RRTMG option (option 4).</strong></p><h3 id="ra_sw_physics-max_dom">ra_sw_physics (max_dom)</h3><p>This should be set to the same option for each domain. <strong>We recommend using the RRTMG option (option 4).</strong></p><h3 id="radt-max_dom">radt (max_dom)</h3><p>Minutes between radiation physics calls. It is recommended to <strong>use 1 minute per km of dx</strong> (e.g., <strong>set to 10 for 10km parent domain</strong>). If you are running a high-resolution domain and compute time is a concern, then it is okay to use radt = 10-15 min, along with setting 'swint_opt'.<strong>Use the same value for all domains</strong>.</p><h3 id="sf_sfclay_physics-max_dom">sf_sfclay_physics (max_dom)</h3><p>Surface layer physics option. A given option may only work with a certain PBL option. This should be set to <strong>the same option for each domain</strong>.</p><h3 id="sf_surface_physics-max_dom">sf_surface_physics (max_dom)</h3><p>Land surface model (LSM) option. This choice must be made prior to running real.exe. num_soil_layers must also match this option. This should be set to the <strong>same option for each domain</strong>. If you decide to change this option later, <strong>make sure num_soil_layers is set correctly for the new option, and you will need to re-run real.exe</strong>.</p><h3 id="num_soil_layers">num_soil_layers</h3><p>If you choose to use a different LSM later, you must make sure this value is set correctly for the new model, and you will need to re-run real.exe.</p><h3 id="bl_pbl_physics-max_dom">bl_pbl_physics (max_dom)</h3><p>This option <strong>should be used when your domain grid size is &gt; 500m</strong>.</p><h3 id="bldt-max_dom">bldt (max_dom)</h3><p>Minutes between boundary layer physics calls. This should be set to the <strong>same option for each domain</strong>. <strong>The typical/recommended value is 0 (every time step)</strong>.</p><blockquote><p><strong>bldt (max_dom) = 0, ! minutes between boundary-layer physics calls</strong></p></blockquote><h3 id="cu_physics-max_dom">cu_physics (max_dom)</h3><ul><li>For a grid size &gt;10 km, a cumulus scheme is necessary.</li><li>It is not necessary when the grid size is &lt; 4km.</li><li>In <strong>between 4km and 10km is a somewhat gray area</strong>, so avoid this range if possible.<ul><li>If you must use this size, however, you can try the <strong>GF and MSKF schemes (options 3 and 11), as these schemes are scale-aware</strong>.</li></ul></li></ul><h3 id="cudt">cudt ?</h3><p>Minutes between cumulus physics calls. The<strong>typical/recommended value is every time step</strong>, as <strong>most cumulus schemes are cheap to run</strong>. Note: for the KF scheme this is also used for averaging time for vertical velocity trigger. This options is not used by the G3 or GD schemes.</p><blockquote><p><strong>cudt (max_dom) = 0, ! minutes between cumulus physics calls</strong></p></blockquote><h3 id="isfflx">isfflx ?</h3><p>Option that determines heat and moisture fluxes from the surface. Use this option if you wish to turn off surface sensible and latent heat fluxes for some of the surface physics options. It may also be used to control how surface fluxes are used in idealized simulations (e.g., LES).</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs sh">isfflx                              = 1,! heat and moisture fluxes from the surface<br>                                                 (only works <span class="hljs-keyword">for</span> sf_sfclay_physics = 1,5,7,11)<br>                                                 1 = with fluxes from the surface <br>                                                 0 = no flux from the surface<br>                                                     with bl_pbl_physics=0 this uses tke_drag_coefficient<br>                                                     and tke_heat_flux <span class="hljs-keyword">in</span> vertical diffusion<br>                                                 2 = use drag from sf_sfclay_physics and heat flux from<br>                                                     tke_heat_flux with bl_pbl_physics=0<br></code></pre></td></tr></table></figure><blockquote><p><strong>isfflx = 1,</strong></p></blockquote><h3 id="ifsnow">ifsnow ?</h3><p>This option can be turned off to remove snow effects for the simple soil model (sf_surface_physics = 1).</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs sh">ifsnow                              = 1,! snow-cover effects<br>                                                 (only works <span class="hljs-keyword">for</span> sf_surface_physics = 1)<br>                                                 1 = with snow-cover effect<br>                                                 0 = without snow-cover effect<br></code></pre></td></tr></table></figure><blockquote><p><strong>ifsnow = 1,</strong></p></blockquote><h3 id="icloud">icloud ?</h3><p>Option to compute cloud fraction for radiation.</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs sh">icloud                              = 1,! cloud effect to the optical depth <span class="hljs-keyword">in</span> radiation<br>                                                 (only works <span class="hljs-keyword">for</span> ra_sw_physics = 1,4 and ra_lw_physics = 1,4)<br>                                                 Since 3.6, this also controls the cloud fraction options<br>                                                 1 = with cloud effect, and use cloud fraction option 1<br>                                                     (Xu-Randall method) <br>                                                 0 = without cloud effect<br>                                                 2 = with cloud effect, and use cloud fraction option 2 (0/1 based<br>                                                     on threshold<br>                                                 3 = with cloud effect, and use cloud fraction option 3, based on<br>                                                     Sundqvist et al. (1989) (since 3.7)<br></code></pre></td></tr></table></figure><blockquote><p><strong>icloud = 1,</strong></p></blockquote><p>or consider the icloud = 3 that may be better.</p><h3 id="surface_input_source">surface_input_source</h3><p>Where landuse and soil category data come from. Available options are: <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs sh">surface_input_source                = 3,! <span class="hljs-built_in">where</span> landuse and soil category data come from:<br>                                                 1 = WPS/geogrid but with dominant categories recomputed<br>                                                 2 = GRIB data from another model (only possible<br>                                                     (VEGCAT/SOILCAT are <span class="hljs-keyword">in</span> met_em files from WPS)<br>                                                 3 = use dominant land and soil categories from WPS/geogrid (default since 3.8)<br></code></pre></td></tr></table></figure></p><h3 id="num_land_cat">num_land_cat</h3><p>The number of land categories in the input static/geogrid data. This must match what's produced in WPS/geogrid. Available options are: <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs sh">num_land_cat                        = 21,      ! number of land categories <span class="hljs-keyword">in</span> input data.<br>                                                 24 - <span class="hljs-keyword">for</span> USGS (default); 20 <span class="hljs-keyword">for</span> MODIS<br>                                                 28 - <span class="hljs-keyword">for</span> USGS <span class="hljs-keyword">if</span> including lake category<br>                                                 21 - <span class="hljs-keyword">for</span> MODIS <span class="hljs-keyword">if</span> including lake category (default since 3.8)<br>                                      40 - <span class="hljs-keyword">for</span> NCLD<br></code></pre></td></tr></table></figure> and may be 5x for LCZ dataset (Urban).</p><h3 id="sf_urban_physics-max_dom">sf_urban_physics (max_dom)</h3><p>This value <strong>must be the same for each domain, and it must be set for each domain.</strong></p><h2 id="dynamics">&amp;dynamics</h2><h3 id="w_damping">w_damping ??</h3><p>Vertical velocity damping flag. Options are 1=with damping; 0=without damping. <strong>For real-time/operational runs, this should always be turned on for model stability</strong> (it is only activated when required.) For budget studies, do not use this option.</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sh">w_damping                           = 0,       ! vertical velocity damping flag (<span class="hljs-keyword">for</span> operational use)<br>                                                 0 = without damping<br>                                                 1 = with    damping<br></code></pre></td></tr></table></figure><h3 id="diff_opt-max_dom">diff_opt (max_dom) ?</h3><p>Turbulence and mixing option.</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs sh">diff_opt(max_dom)                   = 1,! turbulence and mixing option:<br>                                                 0 = no turbulence or explicit<br>                                                     spatial numerical filters (km_opt IS IGNORED).<br>                                                 1 = evaluates 2nd order<br>                                                     diffusion term on coordinate surfaces.<br>                                                     uses kvdif <span class="hljs-keyword">for</span> vertical diff unless PBL option<br>                                                     is used. may be used with km_opt = 1 and 4.<br>                                                     (= 1, recommended <span class="hljs-keyword">for</span> real-data cases)<br>                                                 2 = evaluates mixing terms <span class="hljs-keyword">in</span><br>                                                     physical space (stress form) (x,y,z).<br>                                                     turbulence parameterization is chosen<br>                                                     by specifying km_opt.<br></code></pre></td></tr></table></figure><blockquote><p><strong>diff_opt = 1, 1, 1,</strong></p></blockquote><h3 id="km_opt-max_dom">km_opt (max_dom) ?</h3><p>Eddy coefficient option.</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs sh">km_opt(max_dom)                     = 4,! eddy coefficient option<br>                                                 1 = constant (use khdif kvdif)<br>                                                 2 = 1.5 order TKE closure (3D)<br>                                                 3 = Smagorinsky first order closure (3D)<br>                                                     Note: option 2 and 3 are not recommended <span class="hljs-keyword">for</span> DX &gt; 2 km<br>                                                 4 = horizontal Smagorinsky first order closure<br>                                                     (recommended <span class="hljs-keyword">for</span> real-data cases)<br>                                                 5 = SMS-3DTKE scale-adaptive LES/PBL scheme. It must be<br>                                                     used with diff_opt = 2. PBL schemes must be turned off<br>                                                     (bl_pbl_physics=0). It can work with sf_sfclay_physics = 1, 5, 91.<br></code></pre></td></tr></table></figure><blockquote><p><strong>km_opt = 4, 4, 4,</strong></p></blockquote><h3 id="diff_6th_opt">diff_6th_opt ?</h3><p>6th order numerical diffusion option.</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs sh">diff_6th_opt (max_dom)              = 0,       ! 6th-order numerical diffusion<br>                                                 0 = no 6th-order diffusion (default)<br>                                                 1 = 6th-order numerical diffusion (not recommended)<br>                                                 2 = 6th-order numerical diffusion but prohibit up-gradient diffusion<br></code></pre></td></tr></table></figure><blockquote><p><strong>diff_6th_opt = 0, 0, 0,</strong></p></blockquote><h3 id="diff_6th_factor">diff_6th_factor ?</h3><p>6th order numerical diffusion non-dimensional rate. The maximum value is 1.0, which corresponds to complete removal of 2dx wave in one timestep.</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh">diff_6th_factor (max_dom)           = 0.12,    ! 6th-order numerical diffusion non-dimensional rate (max value 1.0<br>                                                     corresponds to complete removal of 2dx wave <span class="hljs-keyword">in</span> one timestep)<br></code></pre></td></tr></table></figure><blockquote><p><strong>diff_6th_factor = 0.12, 0.12, 0.12,</strong></p></blockquote><h3 id="base_temp">base_temp ?</h3><p>Base state sea-level (surface) temperature (in K). This option can help to improve simulations when the model top is higher than 20 km (~ 50 mb). Note: This option is only available for real data, and em-only. This is a representative temperature at sea-level in the middle of your domain, regardless of the topography height at that point. <strong>Typical values range from 270-300 K</strong>. This value must stay the same through initialization, model runs, and restarts.</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">base_temp                           = 290.,    ! real-data, em ONLY, base sea-level temp (K)<br></code></pre></td></tr></table></figure><blockquote><p><strong>base_temp = 290.,</strong></p></blockquote><h3 id="damp_opt">damp_opt ?</h3><p>Upper-level damping flag.</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs sh">damp_opt                            = 0,! upper level damping flag <br>                                                 0 = without damping<br>                                                 1 = with diffusive damping, maybe used <span class="hljs-keyword">for</span> real-data cases <br>                                                     (dampcoef nondimensional ~0.01-0.1)<br>                                                 2 = with Rayleigh  damping (dampcoef inverse time scale [1/s] e.g. .003; idealized <span class="hljs-keyword">case</span> only<br>                                                     not <span class="hljs-keyword">for</span> real-data cases)<br>                                                 3 = with w-Rayleigh damping (dampcoef inverse time scale [1/s] e.g. .2; <br>                                                     <span class="hljs-keyword">for</span> real-data cases)<br></code></pre></td></tr></table></figure><blockquote><p><strong>damp_opt = 0,</strong></p></blockquote><h3 id="zdamp-max_dom">zdamp (max_dom) ?</h3><p>Damping depth (in meters) from model top. <strong>(default is 5000.)</strong></p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">zdamp (max_dom)                     = 5000.,! damping depth (m) from model top<br></code></pre></td></tr></table></figure><blockquote><p><strong>z_damp = 5000., 5000., 5000.,</strong></p></blockquote><h3 id="dampcoef-max_dom">dampcoef (max_dom) ??</h3><p>Damping coefficient (also see damp_opt above)</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">dampcoef (max_dom)                  = 0.,! damping coefficient (see above)<br></code></pre></td></tr></table></figure><blockquote><p><strong>dampcoef = 0.2, 0.2, 0.2,</strong></p></blockquote><h3 id="khdif-max_dom">khdif (max_dom) ?</h3><p>Horizontal diffusion constant (m^2/s)</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">khdif (max_dom)                     = 0,; horizontal diffusion constant (m^2/s). A typical value should be 0.1*DX <span class="hljs-keyword">in</span> meters.<br></code></pre></td></tr></table></figure><h3 id="kvdif-max_dom">kvdif (max_dom) ?</h3><p>Vertical diffusion constant (m^2/s)</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">kvdif (max_dom)                     = 0,! vertical diffusion constant (m^2/s). A typical value should be 100.<br></code></pre></td></tr></table></figure><h3 id="non_hydrostatic-max_dom">non_hydrostatic (max_dom) ??</h3><p>Whether running the model in hydrostatic or non-hydrotstatic (default) mode.</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">non_hydrostatic (max_dom)           = .<span class="hljs-literal">true</span>.,! whether running the model <span class="hljs-keyword">in</span> hydrostatic or non-hydro mode<br></code></pre></td></tr></table></figure><h3 id="moist_adv_opt-max_dom">moist_adv_opt (max_dom)</h3><p>Positive-definite or monotonic advection to help eliminate over/under prediction of moisture. Option are: - 0 = advection with no bounds or filters in place - <strong>1 = positive-definite advection of moisure (default)</strong> - 2 = monotonic option</p><h3 id="scalar_adv_opt-max_dom">scalar_adv_opt (max_dom)</h3><p>Positive-definite advection of scalars. Options are: - 0 = advection with no bounds or filters in place - <strong>1 = positive-definite advection of moisure (default)</strong> - 2 = monotonic option</p><h2 id="bdy_control">&amp;bdy_control</h2><h3 id="spec_bdy_width">spec_bdy_width</h3><p>The number of rows for specified boundary value nudging. This value is the total of 'spec_zone' and 'relax_zone' (see below). <strong>A wider boundary zone may work better for coarser driving data</strong>.</p><blockquote><p><strong>spec_bdy_width = 5,</strong></p></blockquote><h3 id="spec_zone">spec_zone</h3><p>The number of points in specified zone (specific boundary condition option). Leave this <strong>set to the default of 1</strong>.</p><blockquote><p><strong>spec_zone = 1,</strong></p></blockquote><h3 id="relax_zone">relax_zone</h3><p>The number of points in relaxation zone (specific boundary condition option). A <strong>wider boundary zone may work better for coarser driving data</strong>.</p><blockquote><p><strong>relax_zone = 4,</strong></p></blockquote><h3 id="specified-max_dom">specified (max_dom)</h3><p>Specified boundary conditions.</p><blockquote><p>The first row and column are specified with external model values (spec_zone = 1, which should not be changed). The rows and columns in relax_zone have values blended from an external model and WRF. The value of relax_zone may be changed, as long as spec_bdy_width = spec_zone + relax_zone. This can be used with periodic_x in tropical channel simulations.</p></blockquote><p><strong>This can only be turned on (.true.) for domain 01 - must be false for all other domains. This is for real data cases only</strong>.</p><blockquote><p><strong>specified = .true., .false., .false.,</strong></p></blockquote><h3 id="nested-max_dom">nested (max_dom)</h3><p>Nested boundary conditions. This <strong>must be set to .true. for nests.</strong> This can be used for real or idealized cases.</p><blockquote><p><strong>nested = .false., .true., .true.,</strong></p></blockquote>]]></content>
    
    
    <categories>
      
      <category>WRF</category>
      
    </categories>
    
    
    <tags>
      
      <tag>WRF</tag>
      
      <tag>namelist.input</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>WRF | WRF em_real namelist.input Examples</title>
    <link href="/2023/04/30/WRF_em_real_namelist_input_Examples/"/>
    <url>/2023/04/30/WRF_em_real_namelist_input_Examples/</url>
    
    <content type="html"><![CDATA[<h1 id="wrf-em_real-namelist.input-examples">WRF em_real namelist.input Examples</h1><p>For em_real</p><h2 id="namelist.input.default">namelist.input.default</h2><p>The default namelist.input file for real cases had several settings that go against best practices and recommendations.</p><p><a href="https://github.com/wrf-model/WRF/blob/master/test/em_real/namelist.input.default">WRF/test/em_real/namelist.input.default</a> <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><code class="hljs sh">&amp;time_control<br>run_days                            = 0,! Number of simulation days. DO NOT ADD ADDITIONAL COLUMNS.<br>run_hours                           = 36,! Number of simulation hours. DO NOT ADD ADDITIONAL COLUMNS.<br>run_minutes                         = 0,! Number of simulation minutes. DO NOT ADD ADDITIONAL COLUMNS.<br>run_seconds                         = 0,! Number of simulation seconds. DO NOT ADD ADDITIONAL COLUMNS.<br>! *NOTE: real.exe does not <span class="hljs-built_in">read</span> run_days/hours/minutes/seconds. Only <span class="hljs-built_in">read</span> by wrf.exe<br>! real.exe only reads start_* and end_* parameters.<br>start_year                          = 2019, 2019, 2019,! Starting year of the simulation.<br>start_month                         = 09,   09,   09,! Starting month of the simulation.<br>start_day                           = 04,   04,   24,! Starting day of the simulation.<br>start_hour                          = 12,   12,   12,! Starting hour of the simulation.<br>end_year                            = 2019, 2019, 2019,! Ending year of the simulation.<br>end_month                           = 09,   09,   09,! Ending month of the simulation.<br>end_day                             = 06,   06,   06,! Ending day of the simulation.<br>end_hour                            = 00,   00,   00,! Ending hour of the simulation.<br>interval_seconds                    = 21600! Time interval (s) between input data. DO NOT ADD ADDITIONAL COLUMNS.<br>input_from_file                     = .<span class="hljs-literal">true</span>.,.<span class="hljs-literal">true</span>.,.<span class="hljs-literal">true</span>.,! Logical - whether input files (e.g., met_em*) will be used.<br>history_interval                    = 180,  60,   60,! Interval between <span class="hljs-built_in">history</span> output (mins). *Note: to change the units of history_interval, add _s (secs), _h (hours)<br>frames_per_outfile                  = 1000, 1000, 1000,! Number of <span class="hljs-built_in">history</span> output <span class="hljs-built_in">times</span> printed to each wrf output (wrfout) file.<br>restart                             = .<span class="hljs-literal">false</span>.,! Logical - whether the run is a <span class="hljs-string">&quot;restart&quot;</span> simulation. DO NOT ADD ADDITIONAL COLUMNS.<br>restart_interval                    = 7200,! Interval between restart (wrfrst) files (min). DO NOT ADD ADDITIONAL COLUMNS.<br>io_form_history                     = 2! File format <span class="hljs-keyword">for</span> <span class="hljs-built_in">history</span> (wrfout) files. See Users<span class="hljs-string">&#x27; Guide for options. DO NOT ADD ADDITIONAL COLUMNS.</span><br><span class="hljs-string">io_form_restart                     = 2! File format for restart (wrfrst) files. See Users&#x27;</span> Guide <span class="hljs-keyword">for</span> options. DO NOT ADD ADDITIONAL COLUMNS.<br>io_form_input                       = 2! File format <span class="hljs-keyword">for</span> the input (wrfinput) files. See Users<span class="hljs-string">&#x27; Guide for options. DO NOT ADD ADDITIONAL COLUMNS.</span><br><span class="hljs-string">io_form_boundary                    = 2! File format for the boundary (wrfbdy) file. See Users&#x27;</span> Guide <span class="hljs-keyword">for</span> options. DO NOT ADD ADDITIONAL COLUMNS.<br>/<br><br>&amp;domains<br>time_step                           = 90,! Time step <span class="hljs-keyword">for</span> model integration (s). Must use 6xDX (or less). DO NOT ADD ADDITIONAL COLUMNS.<br>time_step_fract_num                 = 0,! Numerator <span class="hljs-keyword">if</span> using fractional time step. DO NOT ADD ADDITIONAL COLUMNS.<br>time_step_fract_den                 = 1,! Denomenator <span class="hljs-keyword">if</span> using fractional time step. DO NOT ADD ADDITIONAL COLUMNS.<br>max_dom                             = 1,! Total number of domains <span class="hljs-keyword">for</span> the simulation. DO NOT ADD ADDITIONAL COLUMNS.<br>e_we                                = 150,    220,   200,! Number of grid spaces <span class="hljs-keyword">in</span> the x direction (west-east).<br>e_sn                                = 130,    214,   210,! Number of grid spaces <span class="hljs-keyword">in</span> the y direction (south-north).<br>e_vert                              = 45,     45,    45,! Number of full vertical levels. must be the same <span class="hljs-keyword">for</span> all domains.<br>dzstretch_s                         = 1.1! Surface stretch <span class="hljs-built_in">factor</span> when auto_levels_opt = 2 (<span class="hljs-built_in">which</span> is default). DO NOT ADD ADDITIONAL COLUMNS.<br>p_top_requested                     = 5000,! Pressure top (<span class="hljs-keyword">in</span> Pa) to use <span class="hljs-keyword">for</span> the simulation. The input data must go up to this value. DO NOT ADD ADDITIONAL COLUMNS.<br>num_metgrid_levels                  = 34,! Number of vertical levels <span class="hljs-keyword">in</span> the WPS output. DO NOT ADD ADDITIONAL COLUMNS.<br>num_metgrid_soil_levels             = 4,! Number of soil levels <span class="hljs-keyword">in</span> the WPS output. DO NOT ADD ADDITIONAL COLUMNS.<br>dx                                  = 15000,! Length (m) of each grid <span class="hljs-keyword">in</span> the x (west-east) direction (resolution). DO NOT ADD ADDITIONAL COLUMNS. <br>dy                                  = 15000,! Length (m) of each grid <span class="hljs-keyword">in</span> the y (south-north) direction (resolution). DO NOT ADD ADDITIONAL COLUMNS.  <br>grid_id                             = 1,     2,     3,! Identifier number of each domain.<br>parent_id                           = 0,     1,     2,! The ID of the parent of each domain.<br>i_parent_start                      = 1,     53,    30,! Starting location of the lower left corner i-indice within the parent domain.<br>j_parent_start                      = 1,     25,    30,! Starting location of the lower left corner j-indice within the parent domain.<br>parent_grid_ratio                   = 1,     3,     3,! Ratio of the parent to nest grid size (resolution).<br>parent_time_step_ratio              = 1,     3,     3,! Time_step ratio of the parent to nest.<br>feedback                            = 1,! Switch <span class="hljs-keyword">for</span> feedback from the nest to it<span class="hljs-string">&#x27;s parent at corresponding grid points (1=on;0=off). DO NOT ADD ADDITIONAL COLUMNS.</span><br><span class="hljs-string">smooth_option                       = 0! Smoothing option for the boundary between parent and nest domains (when feedback=1). DO NOT ADD ADDITIONAL COLUMNS.</span><br><span class="hljs-string">/</span><br><span class="hljs-string"></span><br><span class="hljs-string">&amp;physics</span><br><span class="hljs-string">physics_suite                       = &#x27;</span>CONUS<span class="hljs-string">&#x27;! Physics suite option (CONUS or tropical). See Users&#x27;</span> Guide <span class="hljs-keyword">for</span> details. DO NOT ADD ADDITIONAL COLUMNS.<br>mp_physics                          = -1,    -1,    -1,! Microphysics scheme. See Users<span class="hljs-string">&#x27; Guide for options (-1=option from suite). Every domain must be the same.</span><br><span class="hljs-string">cu_physics                          = -1,    -1,     0,! Cumulus scheme. See Users&#x27;</span> Guide <span class="hljs-keyword">for</span> options (-1=option from suite).<br>ra_lw_physics                       = -1,    -1,    -1,! Longwave radiation scheme. See Users<span class="hljs-string">&#x27; Guide for options (-1=option from suite). Every domain must be the same.</span><br><span class="hljs-string">ra_sw_physics                       = -1,    -1,    -1,! Shortwave radiation scheme. See Users&#x27;</span> Guide <span class="hljs-keyword">for</span> options (-1=option from suite). Every domain must be the same.<br>bl_pbl_physics                      = -1,    -1,    -1,! PBL scheme. See Users<span class="hljs-string">&#x27; Guide for options (-1=option from suite).</span><br><span class="hljs-string">sf_sfclay_physics                   = -1,    -1,    -1,! Surface layer scheme. See Users&#x27;</span> Guide <span class="hljs-keyword">for</span> options (-1=option from suite). Every domain must be the same.<br>sf_surface_physics                  = -1,    -1,    -1,! LSM scheme. See Users<span class="hljs-string">&#x27; Guide for options (-1=option from suite). Every domain must be the same.</span><br><span class="hljs-string">radt                                = 15,    15,    15,! Minutes between radiation physics calls (recommended 1 min per km of d01 dx). Every domain must be the same.</span><br><span class="hljs-string">bldt                                = 0,     0,     0,! Minutes between boundary-layer physics calls (recommended 0=every time step). Every domain must be the same.</span><br><span class="hljs-string">cudt                                = 0,     0,     0,! Minutes between cumulus physics calls. Set to 0 (called every time step) for all cumulus schemes except Kain-Fritsch.  Every domain must be the same.</span><br><span class="hljs-string">icloud                              = 1,! Option to couple subgrid-scale clouds from the PBL scheme to radiation schemes (only works with RRTM/RRTMG rad schemes). See Users&#x27;</span> Guide <span class="hljs-keyword">for</span> options. DO NOT ADD ADDITIONAL COLUMNS.<br>num_land_cat                        = 21,! Number of land categories from WPS input data. See Users<span class="hljs-string">&#x27; Guide for details. DO NOT ADD ADDITIONAL COLUMNS.</span><br><span class="hljs-string">sf_urban_physics                    = 0,     0,     0,! Option for activating urban canopy model (only for Noah LSM). See Users&#x27;</span> Guide <span class="hljs-keyword">for</span> details. Use same value <span class="hljs-keyword">for</span> all domains. <br>/<br><br>&amp;fdda<br>/<br><br>&amp;dynamics<br>hybrid_opt                          = 2,! Hybrid coordinate option (2=Klemp cubic form with etac; default beginning V4.0). DO NOT ADD ADDITIONAL COLUMNS. <br>w_damping                           = 0,! Vertical velocity damping flag (0=off;1=on). DO NOT ADD ADDITIONAL COLUMNS.<br>diff_opt                            = 2,      2,      2,! Turbulence and mixing option. See Users<span class="hljs-string">&#x27; Guide for options. </span><br><span class="hljs-string">km_opt                              = 4,      4,      4,! Eddy coefficient option. See Users&#x27;</span> Guide <span class="hljs-keyword">for</span> options.<br>diff_6th_opt                        = 0,      0,      0,! 6th order numerical diffusion option. See Users<span class="hljs-string">&#x27; Guide for options.</span><br><span class="hljs-string">diff_6th_factor                     = 0.12,   0.12,   0.12,! 6th order numerical diffusion non-dimensional rate (max 1.0 = complete removal of 2dx wave in 1 timestep). </span><br><span class="hljs-string">base_temp                           = 290.! Base state temp (K). For real cases only. DO NOT ADD ADDITIONAL COLUMNS.</span><br><span class="hljs-string">damp_opt                            = 3,! Upper-level damping option. See Users&#x27;</span> Guide <span class="hljs-keyword">for</span> options. DO NOT ADD ADDITIONAL COLUMNS.<br>zdamp                               = 5000.,  5000.,  5000.,! Damping depth (m) from model top.<br>dampcoef                            = 0.2,    0.2,    0.2,! Damping coefficient corresponding to damp_opt. See Users<span class="hljs-string">&#x27; Guide for details.</span><br><span class="hljs-string">khdif                               = 0,      0,      0,! Horizontal diffusion constant (m^2/s)</span><br><span class="hljs-string">kvdif                               = 0,      0,      0,! Vertical diffusion constant (m^2/s)</span><br><span class="hljs-string">non_hydrostatic                     = .true., .true., .true.,! Set to false to run the model hydrostatically.</span><br><span class="hljs-string">moist_adv_opt                       = 1,      1,      1,     ! Advection option for moisture. See Users&#x27;</span> Guide <span class="hljs-keyword">for</span> details.<br>scalar_adv_opt                      = 1,      1,      1,     ! Advection option <span class="hljs-keyword">for</span> scalars. See Users<span class="hljs-string">&#x27; Guide for details.</span><br><span class="hljs-string">gwd_opt                             = 1,      1,      0,! Switch for gravity wave drag option (1=on;0=off)</span><br><span class="hljs-string">/</span><br><span class="hljs-string"></span><br><span class="hljs-string">&amp;bdy_control</span><br><span class="hljs-string">spec_bdy_width                      = 5,! Total number of rows for specified boundary value nudging for real cases only. DO NOT ADD ADDITIONAL COLUMNS.</span><br><span class="hljs-string">specified                           = .true.! Specified boundary condition for real cases only. DO NOT ADD ADDITIONAL COLUMNS.</span><br><span class="hljs-string">/</span><br><span class="hljs-string"></span><br><span class="hljs-string">&amp;grib2</span><br><span class="hljs-string">/</span><br><span class="hljs-string"></span><br><span class="hljs-string">&amp;namelist_quilt</span><br><span class="hljs-string">nio_tasks_per_group = 0,! Number of I/O tasks per group for quilting. 0=no quilting. DO NOT ADD ADDITIONAL COLUMNS.</span><br><span class="hljs-string">nio_groups = 1,! Number of I/O groups for quilting. DO NOT ADD ADDITIONAL COLUMNS.</span><br><span class="hljs-string">/</span><br></code></pre></td></tr></table></figure></p><h2 id="examples.namelist-many-cases">examples.namelist (Many cases)</h2><p><a href="https://github.com/wrf-model/WRF/blob/master/test/em_real/examples.namelist">Git em_real/examples.namelist</a></p><blockquote><p>Note, this is not a namelist.input file. <strong>Find what interests you, and cut and paste them to your own namelist.input file.</strong> For more information on these namelist parameters, please see run/README.namelist or Chapter 5 of the User's Guide.</p></blockquote><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br><span class="line">635</span><br><span class="line">636</span><br><span class="line">637</span><br><span class="line">638</span><br><span class="line">639</span><br><span class="line">640</span><br><span class="line">641</span><br><span class="line">642</span><br><span class="line">643</span><br><span class="line">644</span><br><span class="line">645</span><br><span class="line">646</span><br><span class="line">647</span><br><span class="line">648</span><br><span class="line">649</span><br><span class="line">650</span><br><span class="line">651</span><br><span class="line">652</span><br><span class="line">653</span><br><span class="line">654</span><br><span class="line">655</span><br><span class="line">656</span><br><span class="line">657</span><br><span class="line">658</span><br><span class="line">659</span><br><span class="line">660</span><br><span class="line">661</span><br><span class="line">662</span><br><span class="line">663</span><br><span class="line">664</span><br><span class="line">665</span><br><span class="line">666</span><br><span class="line">667</span><br><span class="line">668</span><br><span class="line">669</span><br><span class="line">670</span><br><span class="line">671</span><br><span class="line">672</span><br><span class="line">673</span><br><span class="line">674</span><br><span class="line">675</span><br><span class="line">676</span><br><span class="line">677</span><br><span class="line">678</span><br><span class="line">679</span><br><span class="line">680</span><br><span class="line">681</span><br><span class="line">682</span><br><span class="line">683</span><br><span class="line">684</span><br><span class="line">685</span><br><span class="line">686</span><br><span class="line">687</span><br><span class="line">688</span><br><span class="line">689</span><br><span class="line">690</span><br><span class="line">691</span><br><span class="line">692</span><br><span class="line">693</span><br><span class="line">694</span><br><span class="line">695</span><br><span class="line">696</span><br><span class="line">697</span><br><span class="line">698</span><br><span class="line">699</span><br><span class="line">700</span><br><span class="line">701</span><br><span class="line">702</span><br><span class="line">703</span><br><span class="line">704</span><br><span class="line">705</span><br><span class="line">706</span><br><span class="line">707</span><br><span class="line">708</span><br><span class="line">709</span><br><span class="line">710</span><br><span class="line">711</span><br><span class="line">712</span><br><span class="line">713</span><br><span class="line">714</span><br><span class="line">715</span><br><span class="line">716</span><br><span class="line">717</span><br><span class="line">718</span><br><span class="line">719</span><br><span class="line">720</span><br><span class="line">721</span><br><span class="line">722</span><br><span class="line">723</span><br><span class="line">724</span><br><span class="line">725</span><br><span class="line">726</span><br><span class="line">727</span><br><span class="line">728</span><br><span class="line">729</span><br><span class="line">730</span><br><span class="line">731</span><br><span class="line">732</span><br><span class="line">733</span><br><span class="line">734</span><br><span class="line">735</span><br><span class="line">736</span><br><span class="line">737</span><br><span class="line">738</span><br><span class="line">739</span><br><span class="line">740</span><br><span class="line">741</span><br><span class="line">742</span><br><span class="line">743</span><br><span class="line">744</span><br><span class="line">745</span><br><span class="line">746</span><br><span class="line">747</span><br><span class="line">748</span><br><span class="line">749</span><br><span class="line">750</span><br><span class="line">751</span><br><span class="line">752</span><br><span class="line">753</span><br><span class="line">754</span><br><span class="line">755</span><br><span class="line">756</span><br><span class="line">757</span><br><span class="line">758</span><br><span class="line">759</span><br><span class="line">760</span><br><span class="line">761</span><br><span class="line">762</span><br><span class="line">763</span><br><span class="line">764</span><br><span class="line">765</span><br><span class="line">766</span><br><span class="line">767</span><br><span class="line">768</span><br><span class="line">769</span><br><span class="line">770</span><br><span class="line">771</span><br><span class="line">772</span><br><span class="line">773</span><br><span class="line">774</span><br><span class="line">775</span><br><span class="line">776</span><br><span class="line">777</span><br><span class="line">778</span><br><span class="line">779</span><br><span class="line">780</span><br><span class="line">781</span><br><span class="line">782</span><br><span class="line">783</span><br></pre></td><td class="code"><pre><code class="hljs sh">Note, this is not a namelist.input file. Find what interests you, and <span class="hljs-built_in">cut</span> and <span class="hljs-built_in">paste</span> them <br>      to your own namelist.input file. For more information on these namelist parameters,<br>      please see run/README.namelist or Chapter 5 of the User<span class="hljs-string">&#x27;s Guide.</span><br><span class="hljs-string"></span><br><span class="hljs-string">** More options for real in namelist record &amp;domains:</span><br><span class="hljs-string"></span><br><span class="hljs-string"> p_top_requested                     = 5000</span><br><span class="hljs-string"> interp_type                         = 2</span><br><span class="hljs-string"> extrap_type                         = 2</span><br><span class="hljs-string"> t_extrap_type                       = 2</span><br><span class="hljs-string"> lowest_lev_from_sfc                 = .false.</span><br><span class="hljs-string"> use_levels_below_ground             = .true.</span><br><span class="hljs-string"> use_surface                         = .true.</span><br><span class="hljs-string"> lagrange_order                      = 2</span><br><span class="hljs-string"> force_sfc_in_vinterp                = 1</span><br><span class="hljs-string"> zap_close_levels                    = 500</span><br><span class="hljs-string"> sfcp_to_sfcp                        = .false.</span><br><span class="hljs-string"> adjust_heights                      = .false.</span><br><span class="hljs-string"> smooth_cg_topo                      = .false.</span><br><span class="hljs-string"> eta_levels                          = 1.000, 0.990, 0.978, 0.964, 0.946,</span><br><span class="hljs-string">                                       0.922, 0.894, 0.860, 0.817, 0.766,</span><br><span class="hljs-string">                                       0.707, 0.644, 0.576, 0.507, 0.444,</span><br><span class="hljs-string">                                       0.380, 0.324, 0.273, 0.228, 0.188,</span><br><span class="hljs-string">                                       0.152, 0.121, 0.093, 0.069, 0.048,</span><br><span class="hljs-string">                                       0.029, 0.014, 0.000,</span><br><span class="hljs-string"></span><br><span class="hljs-string">** Using sst_update option (add these to namelist records &amp;time_control and</span><br><span class="hljs-string">   &amp;physics respectively):</span><br><span class="hljs-string"></span><br><span class="hljs-string"> &amp;time_control</span><br><span class="hljs-string"> auxinput4_inname                    = &quot;wrflowinp_d&lt;domain&gt;&quot;</span><br><span class="hljs-string"> auxinput4_interval                  = 360, 360, 360, </span><br><span class="hljs-string"> io_form_auxinput4                   = 2</span><br><span class="hljs-string"></span><br><span class="hljs-string"> &amp;physics</span><br><span class="hljs-string"> sst_update                          = 1,</span><br><span class="hljs-string"></span><br><span class="hljs-string">** Using qna_update option (add these to namelist records &amp;time_control and</span><br><span class="hljs-string">   &amp;physics respectively):</span><br><span class="hljs-string"></span><br><span class="hljs-string"> &amp;time_control</span><br><span class="hljs-string"> auxinput17_inname                   = &quot;wrfqnainp_d&lt;domain&gt;&quot;</span><br><span class="hljs-string"> auxinput17_interval                 = 360, 360, 360,</span><br><span class="hljs-string"> io_form_auxinput17                  = 2</span><br><span class="hljs-string"></span><br><span class="hljs-string"> &amp;physics</span><br><span class="hljs-string"> qna_update                          = 1,</span><br><span class="hljs-string"></span><br><span class="hljs-string">** Using Noah-MP option (Use sf_surface_physics option = 4, and add</span><br><span class="hljs-string">   &amp;noah_mp namelist record)</span><br><span class="hljs-string"></span><br><span class="hljs-string">&amp;physics</span><br><span class="hljs-string">   sf_surface_physics = 4</span><br><span class="hljs-string"></span><br><span class="hljs-string">&amp;noah_mp</span><br><span class="hljs-string"> dveg     = 4,</span><br><span class="hljs-string"> opt_crs  = 1,</span><br><span class="hljs-string"> opt_btr  = 1,</span><br><span class="hljs-string"> opt_run  = 1,</span><br><span class="hljs-string"> opt_sfc  = 1, </span><br><span class="hljs-string"> opt_frz  = 1, </span><br><span class="hljs-string"> opt_inf  = 1, </span><br><span class="hljs-string"> opt_rad  = 3, </span><br><span class="hljs-string"> opt_alb  = 2,</span><br><span class="hljs-string"> opt_snf  = 1,</span><br><span class="hljs-string"> opt_tbot = 2, </span><br><span class="hljs-string"> opt_stc  = 1,</span><br><span class="hljs-string">/</span><br><span class="hljs-string"></span><br><span class="hljs-string">** Using UCM urban model</span><br><span class="hljs-string">&amp;physics</span><br><span class="hljs-string"> sf_urban_physics                    = 1,      1,     1,</span><br><span class="hljs-string"></span><br><span class="hljs-string">** Using BEP urban model</span><br><span class="hljs-string">&amp;physics</span><br><span class="hljs-string"> sf_urban_physics                    = 2,      2,     2,</span><br><span class="hljs-string"></span><br><span class="hljs-string">** Using BEM urban model</span><br><span class="hljs-string">&amp;physics</span><br><span class="hljs-string"> sf_urban_physics                    = 3,      3,     3,</span><br><span class="hljs-string"></span><br><span class="hljs-string">** Using lake model</span><br><span class="hljs-string">&amp;physics</span><br><span class="hljs-string"> sf_lake_physics                     = 1,      1,     1,</span><br><span class="hljs-string"> lakedepth_default                   = 50.,    50.,   50.,</span><br><span class="hljs-string"> lake_min_elev                       = 5.,     5.,    5.,</span><br><span class="hljs-string"></span><br><span class="hljs-string">** Using shallow water roughness (constant depth)</span><br><span class="hljs-string">&amp;physics</span><br><span class="hljs-string">shalwater_z0                        = 1,       1,     1, </span><br><span class="hljs-string">shalwater_depth                     = 40.0,</span><br><span class="hljs-string"></span><br><span class="hljs-string">** Using shallow water roughness (with bathymetry data)</span><br><span class="hljs-string">&amp;physics</span><br><span class="hljs-string">shalwater_z0                        = 1,       1,     1, </span><br><span class="hljs-string">shalwater_depth                     = 0.0,</span><br><span class="hljs-string"></span><br><span class="hljs-string">** Using stochastic backscatter scheme (new namelist record since v3.6)</span><br><span class="hljs-string"></span><br><span class="hljs-string">&amp;stoch</span><br><span class="hljs-string"> stoch_force_opt                     = 1,        1,        1,</span><br><span class="hljs-string"> stoch_vertstruc_opt                 = 0,        0,        0,</span><br><span class="hljs-string"> tot_backscat_psi                    = 1.E-05,   1.E-05,   1.E-05,</span><br><span class="hljs-string"> tot_backscat_t                      = 1.E-06,   1.E-06,   1.E-06,</span><br><span class="hljs-string"> nens                                = 1,</span><br><span class="hljs-string"> ztau_psi                            = 10800.0,</span><br><span class="hljs-string"> ztau_t                              = 10800.0,</span><br><span class="hljs-string"> rexponent_psi                       =-1.83,</span><br><span class="hljs-string"> rexponent_t                         =-1.83,</span><br><span class="hljs-string"> zsigma2_eps                         = 0.0833,</span><br><span class="hljs-string"> zsigma2_eta                         = 0.0833,</span><br><span class="hljs-string"> kminforc                            = 1,</span><br><span class="hljs-string"> kminforc                            = 1,</span><br><span class="hljs-string"> kminforct                           = 1,</span><br><span class="hljs-string"> lminforct                           = 1,</span><br><span class="hljs-string"> kmaxforc                            = 1000000,</span><br><span class="hljs-string"> lmaxforc                            = 1000000,</span><br><span class="hljs-string"> kmaxforct                           = 1000000,</span><br><span class="hljs-string"> lmaxforct                           = 1000000,</span><br><span class="hljs-string"> perturb_bdy                         = 0,</span><br><span class="hljs-string"></span><br><span class="hljs-string"></span><br><span class="hljs-string">** Using DFI options (note this is a separate namelist record):</span><br><span class="hljs-string"></span><br><span class="hljs-string"> &amp;dfi_control</span><br><span class="hljs-string"> dfi_opt                             = 3,</span><br><span class="hljs-string"> dfi_nfilter                         = 7,</span><br><span class="hljs-string"> dfi_cutoff_seconds                  = 3600,</span><br><span class="hljs-string"> dfi_write_filtered_input            = .true.</span><br><span class="hljs-string"> dfi_write_dfi_history               = .false.</span><br><span class="hljs-string"> dfi_bckstop_year                    = 2000,</span><br><span class="hljs-string"> dfi_bckstop_month                   = 01,</span><br><span class="hljs-string"> dfi_bckstop_day                     = 24,</span><br><span class="hljs-string"> dfi_bckstop_hour                    = 10,</span><br><span class="hljs-string"> dfi_bckstop_minute                  = 00,</span><br><span class="hljs-string"> dfi_bckstop_second                  = 00,</span><br><span class="hljs-string"> dfi_fwdstop_year                    = 2000,</span><br><span class="hljs-string"> dfi_fwdstop_month                   = 01,</span><br><span class="hljs-string"> dfi_fwdstop_day                     = 24,</span><br><span class="hljs-string"> dfi_fwdstop_hour                    = 13,</span><br><span class="hljs-string"> dfi_fwdstop_minute                  = 00,</span><br><span class="hljs-string"> dfi_fwdstop_second                  = 00,</span><br><span class="hljs-string"> /</span><br><span class="hljs-string"></span><br><span class="hljs-string"> &amp;domains</span><br><span class="hljs-string"> time_step_dfi                       = 60</span><br><span class="hljs-string"></span><br><span class="hljs-string">** Using gridded nudging option (note this is a separate namelist record) for</span><br><span class="hljs-string">   upperair nudging</span><br><span class="hljs-string"></span><br><span class="hljs-string">** Upper air gridded nudging requires an file generated by the real</span><br><span class="hljs-string">   program.  Activating grid_fdda for the real program is adequate.</span><br><span class="hljs-string"></span><br><span class="hljs-string"> &amp;fdda</span><br><span class="hljs-string"> grid_fdda                           = 1,     1,     1,</span><br><span class="hljs-string"> gfdda_inname                        = &quot;wrffdda_d&lt;domain&gt;&quot;,</span><br><span class="hljs-string"> gfdda_end_h                         = 24,    24,    24,</span><br><span class="hljs-string"> gfdda_interval_m                    = 360,   360,   360,</span><br><span class="hljs-string"> fgdt                                = 0,     0,     0,</span><br><span class="hljs-string"> if_no_pbl_nudging_uv                = 0,     0,     0,</span><br><span class="hljs-string"> if_no_pbl_nudging_t                 = 1,     1,     1,</span><br><span class="hljs-string"> if_no_pbl_nudging_q                 = 1,     1,     1,</span><br><span class="hljs-string"> if_zfac_uv                          = 0,     0,     0,</span><br><span class="hljs-string">  k_zfac_uv                          = 10,   10,    10,</span><br><span class="hljs-string"> if_zfac_t                           = 0,     0,     0,</span><br><span class="hljs-string">  k_zfac_t                           = 10,   10,    10,</span><br><span class="hljs-string"> if_zfac_q                           = 0,     0,     0,</span><br><span class="hljs-string">  k_zfac_q                           = 10,   10,    10,</span><br><span class="hljs-string"> guv                                 = 0.0003,     0.0003,     0.0003,</span><br><span class="hljs-string"> gt                                  = 0.0003,     0.0003,     0.0003,</span><br><span class="hljs-string"> gq                                  = 0.0003,     0.0003,     0.0003,</span><br><span class="hljs-string"> if_ramping                          = 1,</span><br><span class="hljs-string"> dtramp_min                          = 60.0,</span><br><span class="hljs-string"> io_form_gfdda                       = 2,</span><br><span class="hljs-string"></span><br><span class="hljs-string">** Using gridded surface nudging option (note this is a separate namelist </span><br><span class="hljs-string">   record)</span><br><span class="hljs-string"></span><br><span class="hljs-string">** Note that upper-air and surface gridded nudging may be used together </span><br><span class="hljs-string">   or separately.  Surface nudging requires an input file generated by the</span><br><span class="hljs-string">   obsgrid program.</span><br><span class="hljs-string"></span><br><span class="hljs-string"> &amp;fdda</span><br><span class="hljs-string"> grid_sfdda                          = 1,     1,     1,</span><br><span class="hljs-string"> sgfdda_inname                       = &quot;wrfsfdda_d&lt;domain&gt;&quot;,</span><br><span class="hljs-string"> sgfdda_end_h                        = 24,    24,    24,</span><br><span class="hljs-string"> sgfdda_interval_m                   = 360,   360,   360,</span><br><span class="hljs-string"> io_form_sgfdda                      = 2,</span><br><span class="hljs-string"> guv_sfc                             = 0.0003,     0.0003,     0.0003,</span><br><span class="hljs-string"> gt_sfc                              = 0.0003,     0.0003,     0.0003,</span><br><span class="hljs-string"> gq_sfc                              = 0.0003,     0.0003,     0.0003,</span><br><span class="hljs-string"> rinblw                              = 250.,       250.,       250., </span><br><span class="hljs-string"></span><br><span class="hljs-string">** Using observation nudging option (note &amp;fdda is a separate namelist record):</span><br><span class="hljs-string"></span><br><span class="hljs-string"> &amp;time_control</span><br><span class="hljs-string"> auxinput11_interval_s               = 180 , 180 , 180</span><br><span class="hljs-string"> auxinput11_end_h                    = 6   , 6   , 6</span><br><span class="hljs-string"></span><br><span class="hljs-string"> &amp;fdda</span><br><span class="hljs-string"> obs_nudge_opt                       = 1,1,1,</span><br><span class="hljs-string"> max_obs                             = 150000,</span><br><span class="hljs-string"> fdda_start                          = 0.,  0.,  0.,</span><br><span class="hljs-string"> fdda_end                            = 720.,720.,720.,</span><br><span class="hljs-string"> obs_nudge_wind                      = 1,1,1,</span><br><span class="hljs-string"> obs_coef_wind                       = 6.E-4,6.E-4,6.E-4,</span><br><span class="hljs-string"> obs_nudge_temp                      = 1,1,1,</span><br><span class="hljs-string"> obs_coef_temp                       = 6.E-4,6.E-4,6.E-4,</span><br><span class="hljs-string"> obs_nudge_mois                      = 1,1,1,</span><br><span class="hljs-string"> obs_coef_mois                       = 6.E-4,6.E-4,6.E-4,</span><br><span class="hljs-string"> obs_rinxy                           = 240.,240.,180.,</span><br><span class="hljs-string"> obs_rinsig                          = 0.1,</span><br><span class="hljs-string"> obs_twindo                          = 0.6666667,0.6666667,0.6666667,</span><br><span class="hljs-string"> obs_npfi                            = 10,</span><br><span class="hljs-string"> obs_ionf                            = 2, 2, 2,</span><br><span class="hljs-string"> obs_idynin                          = 0,</span><br><span class="hljs-string"> obs_dtramp                          = 40.,</span><br><span class="hljs-string"> obs_prt_freq                        = 10, 10, 10,</span><br><span class="hljs-string"> obs_prt_max                         = 10</span><br><span class="hljs-string"> obs_ipf_errob                       = .true.</span><br><span class="hljs-string"> obs_ipf_nudob                       = .true.</span><br><span class="hljs-string"> obs_ipf_in4dob                      = .true</span><br><span class="hljs-string"> obs_no_pbl_nudge_uv                 = 0</span><br><span class="hljs-string"> obs_no_pbl_nudge_t                  = 0</span><br><span class="hljs-string"> obs_no_pbl_nudge_q                  = 0</span><br><span class="hljs-string"> obs_sfc_scheme_horiz                = 0</span><br><span class="hljs-string"> obs_sfc_scheme_vert                 = 0</span><br><span class="hljs-string"> obs_max_sndng_gap                   = 20</span><br><span class="hljs-string"> obs_nudgezfullr1_uv                 = 50</span><br><span class="hljs-string"> obs_nudgezrampr1_uv                 = 50</span><br><span class="hljs-string"> obs_nudgezfullr2_uv                 = 50</span><br><span class="hljs-string"> obs_nudgezrampr2_uv                 = 50</span><br><span class="hljs-string"> obs_nudgezfullr4_uv                 = -5000</span><br><span class="hljs-string"> obs_nudgezrampr4_uv                 = 50  </span><br><span class="hljs-string"> obs_nudgezfullr1_t                  = 50 </span><br><span class="hljs-string"> obs_nudgezrampr1_t                  = 50</span><br><span class="hljs-string"> obs_nudgezfullr2_t                  = 50</span><br><span class="hljs-string"> obs_nudgezrampr2_t                  = 50</span><br><span class="hljs-string"> obs_nudgezfullr4_t                  = -5000</span><br><span class="hljs-string"> obs_nudgezrampr4_t                  = 50  </span><br><span class="hljs-string"> obs_nudgezfullr1_q                  = 50 </span><br><span class="hljs-string"> obs_nudgezrampr1_q                  = 50</span><br><span class="hljs-string"> obs_nudgezfullr2_q                  = 50</span><br><span class="hljs-string"> obs_nudgezrampr2_q                  = 50</span><br><span class="hljs-string"> obs_nudgezfullr4_q                  = -5000</span><br><span class="hljs-string"> obs_nudgezrampr4_q                  = 50</span><br><span class="hljs-string"> obs_nudgezfullmin                   = 50</span><br><span class="hljs-string"> obs_nudgezrampmin                   = 50</span><br><span class="hljs-string"> obs_nudgezmax                       = 3000</span><br><span class="hljs-string"> obs_sfcfact                         = 1.0</span><br><span class="hljs-string"> obs_sfcfacr                         = 1.0</span><br><span class="hljs-string"> obs_dpsmx                           = 7.5</span><br><span class="hljs-string"> /</span><br><span class="hljs-string"></span><br><span class="hljs-string">** Using spectral nudging option </span><br><span class="hljs-string"></span><br><span class="hljs-string"> &amp;fdda</span><br><span class="hljs-string"> grid_fdda                           = 2,     2,     2,</span><br><span class="hljs-string"> gfdda_inname                        = &quot;wrffdda_d&lt;domain&gt;&quot;,</span><br><span class="hljs-string"> gfdda_end_h                         = 24,    24,    24,</span><br><span class="hljs-string"> gfdda_interval_m                    = 360,   360,   360,</span><br><span class="hljs-string"> fgdt                                = 0,     0,     0,</span><br><span class="hljs-string"> fgdtzero                            = 0,     0,     0,</span><br><span class="hljs-string"> if_no_pbl_nudging_uv                = 0,     0,     0,</span><br><span class="hljs-string"> if_no_pbl_nudging_t                 = 0,     0,     0,</span><br><span class="hljs-string"> if_no_pbl_nudging_ph                = 0,     0,     0,</span><br><span class="hljs-string"> if_zfac_uv                          = 0,     0,     0,</span><br><span class="hljs-string">  k_zfac_uv                          = 10,   10,    10,</span><br><span class="hljs-string"> if_zfac_t                           = 0,     0,     0,</span><br><span class="hljs-string">  k_zfac_t                           = 10,   10,    10,</span><br><span class="hljs-string"> if_zfac_ph                          = 0,     0,     0,</span><br><span class="hljs-string">  k_zfac_ph                          = 10,   10,    10,</span><br><span class="hljs-string"> dk_zfac_uv                          = 1,     1,     1,</span><br><span class="hljs-string"> dk_zfac_t                           = 1,     1,     1,</span><br><span class="hljs-string"> dk_zfac_ph                          = 1,     1,     1,</span><br><span class="hljs-string"> guv                                 = 0.0003,     0.0003,     0.0003,</span><br><span class="hljs-string"> gt                                  = 0.0003,     0.0003,     0.0003,</span><br><span class="hljs-string"> gph                                 = 0.0003,     0.0003,     0.0003,</span><br><span class="hljs-string"> xwavenum                            = 3,</span><br><span class="hljs-string"> ywavenum                            = 3,</span><br><span class="hljs-string"> if_ramping                          = 1,</span><br><span class="hljs-string"> dtramp_min                          = 60.0,</span><br><span class="hljs-string"> io_form_gfdda                       = 2,</span><br><span class="hljs-string"></span><br><span class="hljs-string">** Using adaptive time step option (add these in namelist record &amp;domains):</span><br><span class="hljs-string"></span><br><span class="hljs-string"> use_adaptive_time_step              = .true.,</span><br><span class="hljs-string"> step_to_output_time                 = .true.,</span><br><span class="hljs-string"> target_cfl                          = 1.2, 1.2, 1.2,</span><br><span class="hljs-string"> target_hcfl                         = .84, .84, .84,</span><br><span class="hljs-string"> max_step_increase_pct               = 5,   51,  51,</span><br><span class="hljs-string"> starting_time_step                  = -1,  -1,  -1,</span><br><span class="hljs-string"> max_time_step                       = 360, 120, 40,</span><br><span class="hljs-string"> min_time_step                       =  90,  30, 10,</span><br><span class="hljs-string"> adaptation_domain                   =  1,</span><br><span class="hljs-string"></span><br><span class="hljs-string">** Using automatic vortex-following option (tropical storm tracking only;</span><br><span class="hljs-string">   add these in namelist record &amp;domains):</span><br><span class="hljs-string"></span><br><span class="hljs-string"> vortex_interval                     = 15, 15, 15,</span><br><span class="hljs-string"> max_vortex_speed                    = 40, 40, 40,</span><br><span class="hljs-string"> corral_dist                         =  8, 15, 15,</span><br><span class="hljs-string"> track_level                         = 50000,</span><br><span class="hljs-string"></span><br><span class="hljs-string">** Miscellaneous physics options for namelist record &amp;physics:</span><br><span class="hljs-string"></span><br><span class="hljs-string">Topographic shading (only effective when grid sizes are a few kilometers)</span><br><span class="hljs-string"></span><br><span class="hljs-string"> slope_rad                           = 1,     1,     1,</span><br><span class="hljs-string"> topo_shading                        = 1,     1,     1,</span><br><span class="hljs-string"> shadlen                             = 25000, </span><br><span class="hljs-string"></span><br><span class="hljs-string">Setting threshold value for defining seaice if seaice is not in the input file:</span><br><span class="hljs-string"></span><br><span class="hljs-string"> seaice_threshold                    = 271,</span><br><span class="hljs-string"></span><br><span class="hljs-string">Switching off latent heating from a microphysics scheme (must also set cu_physics = 0):</span><br><span class="hljs-string"></span><br><span class="hljs-string"> no_mp_heating                       = 0,</span><br><span class="hljs-string"></span><br><span class="hljs-string">** Using precipiatiion bucket in a time interval (minutes):</span><br><span class="hljs-string"></span><br><span class="hljs-string"> prec_acc_dt                         = 60.</span><br><span class="hljs-string"></span><br><span class="hljs-string">** Using bucket accumulations for multi-year simulations (guideline: mean monthly accumulation)</span><br><span class="hljs-string"></span><br><span class="hljs-string"> bucket_mm                           = 100.</span><br><span class="hljs-string"> bucket_J                            = 1.e9</span><br><span class="hljs-string"></span><br><span class="hljs-string">** Optional gravitational settling of fog/cloud droplets (MYNN PBL only)</span><br><span class="hljs-string"></span><br><span class="hljs-string"> grav_settling                       = 1,       ; default 0</span><br><span class="hljs-string"></span><br><span class="hljs-string">** Using implicit gravity-wave damping option (add these in namelist record &amp;dynamics):</span><br><span class="hljs-string"></span><br><span class="hljs-string"> damp_opt                            = 3,</span><br><span class="hljs-string"> zdamp                               = 5000.,  5000.,  5000.,</span><br><span class="hljs-string"> dampcoef                            = 0.2,    0.2,    0.2</span><br><span class="hljs-string"></span><br><span class="hljs-string">** Using expanded boundary zone and exponential decay option (add or modify these in</span><br><span class="hljs-string">    namelist record &amp;bdy_control). </span><br><span class="hljs-string">    spec_zone is ALWAYS = 1 </span><br><span class="hljs-string">    relax_zone is ALWAYS = spec_bdy_width - spec_zone</span><br><span class="hljs-string"></span><br><span class="hljs-string">&amp;bdy_control</span><br><span class="hljs-string"> spec_bdy_width                      = 10,</span><br><span class="hljs-string"> specified                           = .true.,</span><br><span class="hljs-string"> spec_exp                            = 0.33</span><br><span class="hljs-string"></span><br><span class="hljs-string">For a tropical channel configuration, set the following:</span><br><span class="hljs-string"></span><br><span class="hljs-string"> specified                           = .true.,</span><br><span class="hljs-string"> periodic_x                          = .true.,</span><br><span class="hljs-string"></span><br><span class="hljs-string">** Using split lateral boundary files</span><br><span class="hljs-string">     The run-time flag multi_bdy_files must be set to TRUE (default is false), and the</span><br><span class="hljs-string">     lateral boundary files must have a date associated. When using the split LBC option,</span><br><span class="hljs-string">     there is ALWAYS and ONLY a single time LBC time in each file.</span><br><span class="hljs-string"></span><br><span class="hljs-string"> multi_bdy_files                     = .true.</span><br><span class="hljs-string"></span><br><span class="hljs-string">Also requires</span><br><span class="hljs-string">&amp;time_control</span><br><span class="hljs-string"> bdy_inname                          = &quot;wrfbdy_d&lt;domain&gt;_&lt;date&gt;&quot;</span><br><span class="hljs-string"></span><br><span class="hljs-string">** using io quilting option to improve output efficiency for large domain runs</span><br><span class="hljs-string">    (note that this is a separate namelist record):</span><br><span class="hljs-string"></span><br><span class="hljs-string"> &amp;namelist_quilt</span><br><span class="hljs-string"> nio_tasks_per_group = 2,</span><br><span class="hljs-string"> nio_groups = 1,</span><br><span class="hljs-string"></span><br><span class="hljs-string">** for tc bogusing:</span><br><span class="hljs-string">   Helpful hints</span><br><span class="hljs-string">   1) The TC bogus *MUST* only be run with a single processor: serial </span><br><span class="hljs-string">      (with or without a nest build option), or as a DM build with np=1.</span><br><span class="hljs-string">   2) Run the TC program for only the initial model time. Remember to copy </span><br><span class="hljs-string">      your metgrid file to a safe location and then let the TC scheme </span><br><span class="hljs-string">      generate the auxiliary files.</span><br><span class="hljs-string">   3) The TC program does not handle soil moisture or soil temperature </span><br><span class="hljs-string">      correctly. After running the TC program, use an NCL script to put the </span><br><span class="hljs-string">      modified fields back into the original metgrid file (remember that you</span><br><span class="hljs-string">      are keeping a pristine copy elsewhere). The modified fields to copy</span><br><span class="hljs-string">      are:  &quot;RH&quot;, &quot;TT&quot;, &quot;UU&quot;, &quot;VV&quot;, &quot;GHT&quot;, &quot;PRES&quot;, &quot;PMSL&quot;, &quot;PSFC&quot;.</span><br><span class="hljs-string">   4) The TC program runs quickly, only a few seconds. It is a good idea to </span><br><span class="hljs-string">      process multiple runs, and vary the TC initialization. It would be </span><br><span class="hljs-string">      reasonable to select the maximum wind speed (vmax_meters_per_second) </span><br><span class="hljs-string">      from 30 to 60 by 5, select the radius of maximum winds ((m), rmax) = </span><br><span class="hljs-string">      50000 to 200000 by 50000, and select a tuning parameter for the </span><br><span class="hljs-string">      vortex (vmax_ratio) = 0.5 to 0.9 by 0.1. Look at the resulting </span><br><span class="hljs-string">      bogus storms (sea level pressure, surface wind speeds, and </span><br><span class="hljs-string">      overall storm size), and choose the best.  </span><br><span class="hljs-string">   5) Remember to also consider starting the TC program at a later or</span><br><span class="hljs-string">      earlier time during your parameter space exploration.</span><br><span class="hljs-string">   6) The bogus storm will organize better if the initialization of the</span><br><span class="hljs-string">      tropical storm is entirely over water, and if the storm is able to </span><br><span class="hljs-string">      develop over water for several days.</span><br><span class="hljs-string">   7) After the metgrid file is finalized, and the real program is run,</span><br><span class="hljs-string">      use DFI in WRF. Removing and then introducing an entire bogus typhoon</span><br><span class="hljs-string">      is the definition of unbalanced. Running DFI for 2-3 hours back and forth</span><br><span class="hljs-string">      will be a benefit. For a successful implementation of a TC bogus storm in </span><br><span class="hljs-string">      WRF, the storm should not oscillate in size, should not be radiating </span><br><span class="hljs-string">      massive amounts of gravity waves, and should not rapidly weaken.</span><br><span class="hljs-string"></span><br><span class="hljs-string"> &amp;tc</span><br><span class="hljs-string"> insert_bogus_storm                  = .true.,</span><br><span class="hljs-string"> remove_storm                        = .false.,</span><br><span class="hljs-string"> num_storm                           = 1,</span><br><span class="hljs-string"> latc_loc                            = 15.,</span><br><span class="hljs-string"> lonc_loc                            = -90.,</span><br><span class="hljs-string"> vmax_meters_per_second              = 30,</span><br><span class="hljs-string"> rmax                                = 50000,</span><br><span class="hljs-string"> vmax_ratio                          = 0.5,</span><br><span class="hljs-string"> /</span><br><span class="hljs-string"></span><br><span class="hljs-string">** for regional climate surface diagnostics such as max/min/mean/std of T2/Q2/wind/rainfall</span><br><span class="hljs-string">between selected output times (e.g. daily) in auxhist3</span><br><span class="hljs-string"></span><br><span class="hljs-string"> &amp;time_control</span><br><span class="hljs-string"> output_diagnostics      = 1</span><br><span class="hljs-string"> auxhist3_outname        = &#x27;</span>wrfxtrm_d&lt;domain&gt;_&lt;<span class="hljs-built_in">date</span>&gt;<span class="hljs-string">&#x27;</span><br><span class="hljs-string"> io_form_auxhist3        = 2</span><br><span class="hljs-string"> auxhist3_interval       = 1440</span><br><span class="hljs-string"> frames_per_auxhist3     = 1</span><br><span class="hljs-string"> /</span><br><span class="hljs-string"></span><br><span class="hljs-string"></span><br><span class="hljs-string">** for pressure-level (and some surface) diagnostics, output is on stream 23,</span><br><span class="hljs-string">where the listed pressure levels are in Pa.  For the height level interpolation,</span><br><span class="hljs-string">the unit is stream 22.</span><br><span class="hljs-string"></span><br><span class="hljs-string"> &amp;time_control</span><br><span class="hljs-string"> io_form_auxhist23                   =  2,</span><br><span class="hljs-string"> auxhist23_interval                  = 30,   30,    30,</span><br><span class="hljs-string"> frames_per_auxhist23                =  1,    1,     1, </span><br><span class="hljs-string"> auxhist23_outname                   = &quot;PLEVS_d&lt;domain&gt;_&lt;date&gt;&quot;</span><br><span class="hljs-string"> /</span><br><span class="hljs-string"></span><br><span class="hljs-string"> &amp;diags</span><br><span class="hljs-string"> p_lev_diags                         = 1</span><br><span class="hljs-string"> num_press_levels                    = 4</span><br><span class="hljs-string"> press_levels                        = 85000, 70000, 50000, 25000</span><br><span class="hljs-string"> use_tot_or_hyd_p                    = 2</span><br><span class="hljs-string"> /</span><br><span class="hljs-string"></span><br><span class="hljs-string"></span><br><span class="hljs-string">** for height-level diagnostics, output is on stream 22 (negative values</span><br><span class="hljs-string">for z_levels means AGL, so -500 is 500 m AGL, and 10000 is 10 km).</span><br><span class="hljs-string"></span><br><span class="hljs-string"> &amp;time_control</span><br><span class="hljs-string"> io_form_auxhist22                   =  2,</span><br><span class="hljs-string"> auxhist22_interval                  = 30,   30,    30,</span><br><span class="hljs-string"> frames_per_auxhist22                =  1,    1,     1, </span><br><span class="hljs-string"> auxhist22_outname                   = &quot;ZLEVS_d&lt;domain&gt;_&lt;date&gt;&quot;</span><br><span class="hljs-string"> /</span><br><span class="hljs-string"></span><br><span class="hljs-string"> &amp;diags</span><br><span class="hljs-string"> z_lev_diags                         = 1</span><br><span class="hljs-string"> num_z_levels                        = 2</span><br><span class="hljs-string"> z_levels                            = -500, 10000</span><br><span class="hljs-string"> /</span><br><span class="hljs-string"></span><br><span class="hljs-string"></span><br><span class="hljs-string">** For solar diagnostics, 2-D fields of variables relevant to solar forecasting are output </span><br><span class="hljs-string">when option solar_diagnostics is activated in diags section of namelist, as shown below.</span><br><span class="hljs-string">Also, if tslist is present when solar_diagnostics is activated, then these same variables</span><br><span class="hljs-string">are output to the time series files for the location(s) specified in tslist.</span><br><span class="hljs-string">All variables are calculated in phys/module_diag_solar.F and defined in registry.solar_fields</span><br><span class="hljs-string"></span><br><span class="hljs-string"> &amp;diags</span><br><span class="hljs-string"> solar_diagnostics                   =  1</span><br><span class="hljs-string"> /</span><br><span class="hljs-string"></span><br><span class="hljs-string"></span><br><span class="hljs-string">** Using different flux formulation for tropical storm simulations</span><br><span class="hljs-string">   (best for grid spacing less than 2 km) </span><br><span class="hljs-string">   simple 1-D ocean mixed layer, or University of Miami 3DPWP ocean model</span><br><span class="hljs-string">   (add these in namelist record &amp;physics):</span><br><span class="hljs-string"></span><br><span class="hljs-string"> isftcflx                            = 1,</span><br><span class="hljs-string"> sf_ocean_physics                    = 0 (off), 1 (OML), 2 (3D PWP)</span><br><span class="hljs-string"> oml_hml0                            = 50,</span><br><span class="hljs-string"> oml_gamma                           = 0.14</span><br><span class="hljs-string"> omdt                                = 1</span><br><span class="hljs-string"></span><br><span class="hljs-string"> Add these in the &amp;domains section.  Note that the example here is for</span><br><span class="hljs-string"> a warm ocean: ocean_z is the depth of each layer (m), from the surface</span><br><span class="hljs-string"> downward; the associated temperature is ocean_t (K); and the associated </span><br><span class="hljs-string"> salinity is ocean_s (ppt).</span><br><span class="hljs-string"></span><br><span class="hljs-string"> ocean_levels                        = 30,</span><br><span class="hljs-string"> ocean_z                             =       5.,       15.,       25.,       35.,       45.,       55.,</span><br><span class="hljs-string">                                            65.,       75.,       85.,       95.,      105.,      115.,</span><br><span class="hljs-string">                                           125.,      135.,      145.,      155.,      165.,      175.,</span><br><span class="hljs-string">                                           185.,      195.,      210.,      230.,      250.,      270.,</span><br><span class="hljs-string">                                           290.,      310.,      330.,      350.,      370.,      390.</span><br><span class="hljs-string"> ocean_t                             = 302.3493,  302.3493,  302.3493,  302.1055,  301.9763,  301.6818,</span><br><span class="hljs-string">                                       301.2220,  300.7531,  300.1200,  299.4778,  298.7443,  297.9194,</span><br><span class="hljs-string">                                       297.0883,  296.1443,  295.1941,  294.1979,  293.1558,  292.1136,</span><br><span class="hljs-string">                                       291.0714,  290.0293,  288.7377,  287.1967,  285.6557,  284.8503,</span><br><span class="hljs-string">                                       284.0450,  283.4316,  283.0102,  282.5888,  282.1674,  281.7461</span><br><span class="hljs-string"> ocean_s                             =  34.0127,   34.0127,   34.0127,   34.3217,   34.2624,   34.2632,</span><br><span class="hljs-string">                                        34.3240,   34.3824,   34.3980,   34.4113,   34.4220,   34.4303,</span><br><span class="hljs-string">                                        34.6173,   34.6409,   34.6535,   34.6550,   34.6565,   34.6527,</span><br><span class="hljs-string">                                        34.6490,   34.6446,   34.6396,   34.6347,   34.6297,   34.6247,</span><br><span class="hljs-string">                                        34.6490,   34.6446,   34.6396,   34.6347,   34.6297,   34.6247</span><br><span class="hljs-string"></span><br><span class="hljs-string"></span><br><span class="hljs-string">References for 3D ocean circulation model:</span><br><span class="hljs-string">Lee, C.-Y., and S. S. Chen, 2013: Stable Boundary Layer and Its Impact on Tropical Cyclone Structure in a Coupled Atmosphere-Ocean Model, Mon. Wea. Rev.</span><br><span class="hljs-string">Price, J. F., T. B. Sanford, and G. Z. Forristal, 1994: Forced stage response to a moving hurricane. J. Phy. Oceanogr., 24, 233-260.</span><br><span class="hljs-string"></span><br><span class="hljs-string"></span><br><span class="hljs-string"></span><br><span class="hljs-string">** Using the ACOM Forward Lagrangian trajectory calculation:</span><br><span class="hljs-string"></span><br><span class="hljs-string">&amp;domains</span><br><span class="hljs-string"> num_traj                            = 25,</span><br><span class="hljs-string"></span><br><span class="hljs-string">&amp;physics</span><br><span class="hljs-string"> traj_opt                            = 1,</span><br><span class="hljs-string"> dm_has_traj                         = .true.,  ..true.,  .true.</span><br><span class="hljs-string"> </span><br><span class="hljs-string"></span><br><span class="hljs-string">For domain #1, the file must &quot;wrfinput_traj_d01&quot; exist in the working directory. Similarly for domain 2, 3, etc. Each domain</span><br><span class="hljs-string">has a separate file for a namelist.</span><br><span class="hljs-string"></span><br><span class="hljs-string">&amp;traj_default</span><br><span class="hljs-string"> traj_def%start_time        = &#x27;</span>2000-01-24_12:00:00<span class="hljs-string">&#x27;,</span><br><span class="hljs-string"> traj_def%stop_time         = &#x27;</span>2000-01-25_12:00:00<span class="hljs-string">&#x27;,</span><br><span class="hljs-string"> traj_def%dyn_name(1:6)     = &#x27;</span>p<span class="hljs-string">&#x27;, &#x27;</span>T<span class="hljs-string">&#x27;, &#x27;</span>z<span class="hljs-string">&#x27;, &#x27;</span>u<span class="hljs-string">&#x27;, &#x27;</span>v<span class="hljs-string">&#x27;, &#x27;</span>w<span class="hljs-string">&#x27;,</span><br><span class="hljs-string"> traj_def%hyd_name(1)       = &#x27;</span>QVAPOR<span class="hljs-string">&#x27;,</span><br><span class="hljs-string">/</span><br><span class="hljs-string">  </span><br><span class="hljs-string">&amp;traj_spec</span><br><span class="hljs-string"> traj_type%start_time = &#x27;</span>2000-01-24_12:00:00<span class="hljs-string">&#x27;,  &#x27;</span>2000-01-24_12:00:00<span class="hljs-string">&#x27;,  </span><br><span class="hljs-string">                        &#x27;</span>2000-01-24_12:00:00<span class="hljs-string">&#x27;,  &#x27;</span>2000-01-24_12:00:00<span class="hljs-string">&#x27;,  </span><br><span class="hljs-string">                        &#x27;</span>2000-01-24_12:00:00<span class="hljs-string">&#x27;,  &#x27;</span>2000-01-24_12:00:00<span class="hljs-string">&#x27;,  </span><br><span class="hljs-string">                        &#x27;</span>2000-01-24_12:00:00<span class="hljs-string">&#x27;,  &#x27;</span>2000-01-24_12:00:00<span class="hljs-string">&#x27;,  </span><br><span class="hljs-string">                        &#x27;</span>2000-01-24_12:00:00<span class="hljs-string">&#x27;,  &#x27;</span>2000-01-24_12:00:00<span class="hljs-string">&#x27;,  </span><br><span class="hljs-string">                        &#x27;</span>2000-01-24_12:00:00<span class="hljs-string">&#x27;,  </span><br><span class="hljs-string"> traj_type%stop_time  = &#x27;</span>2000-01-25_12:00:00<span class="hljs-string">&#x27;,  &#x27;</span>2000-01-25_12:00:00<span class="hljs-string">&#x27;,  </span><br><span class="hljs-string">                        &#x27;</span>2000-01-25_12:00:00<span class="hljs-string">&#x27;,  &#x27;</span>2000-01-25_12:00:00<span class="hljs-string">&#x27;,  </span><br><span class="hljs-string">                        &#x27;</span>2000-01-25_12:00:00<span class="hljs-string">&#x27;,  &#x27;</span>2000-01-25_12:00:00<span class="hljs-string">&#x27;,  </span><br><span class="hljs-string">                        &#x27;</span>2000-01-25_12:00:00<span class="hljs-string">&#x27;,  &#x27;</span>2000-01-25_12:00:00<span class="hljs-string">&#x27;,  </span><br><span class="hljs-string">                        &#x27;</span>2000-01-25_12:00:00<span class="hljs-string">&#x27;,  &#x27;</span>2000-01-25_12:00:00<span class="hljs-string">&#x27;,  </span><br><span class="hljs-string">                        &#x27;</span>2000-01-25_12:00:00<span class="hljs-string">&#x27;,  </span><br><span class="hljs-string"> traj_type%lev        = 60., 60., 60., 60., 60., 60., 60., 60., 60., 60., 60., </span><br><span class="hljs-string"> traj_type%lon        = -79.88470, -79.74551, -79.60422, -79.46072, </span><br><span class="hljs-string">                        -79.31503, -79.16708, -79.01682, -78.86417, </span><br><span class="hljs-string">                        -78.70911, -78.55151, -78.39142,</span><br><span class="hljs-string"> traj_type%lat        =  29.18063,  29.70515,  30.23069,  30.75718,  </span><br><span class="hljs-string">                         31.28461,  31.81292,  32.34208,  32.87204,  </span><br><span class="hljs-string">                         33.40276,  33.93421,  34.46631,</span><br><span class="hljs-string">/</span><br><span class="hljs-string"></span><br><span class="hljs-string"></span><br><span class="hljs-string"></span><br><span class="hljs-string">** Vertical nesting</span><br><span class="hljs-string"></span><br><span class="hljs-string">The WRF model now supports vertical nesting for a coincident (online)</span><br><span class="hljs-string">model simulation (during a single model run, differing numbers of</span><br><span class="hljs-string">vertical levels may be used per domain).  This is activated with a switch</span><br><span class="hljs-string">to turn on the option (vert_refine_method).  The namelist array eta_levels</span><br><span class="hljs-string">is manually filled in for each domain.  Below is an example for two </span><br><span class="hljs-string">domains.  </span><br><span class="hljs-string"></span><br><span class="hljs-string">NOTE: The user is restricted to using the RRTM LW and Dudhia SW radiation schemes.</span><br><span class="hljs-string">NOTE: The user is restricted from using the hybrid vertical coordinate.</span><br><span class="hljs-string"></span><br><span class="hljs-string"> &amp;domains</span><br><span class="hljs-string"> max_dom                             = 2,</span><br><span class="hljs-string"> e_vert                              = 35,    45,</span><br><span class="hljs-string"> eta_levels(1:35)                    = 1., 0.993, 0.983, 0.97, 0.954, 0.934, 0.909, 0.88, 0.8406663, 0.8013327, </span><br><span class="hljs-string">                                       0.761999, 0.7226653, 0.6525755, 0.5877361, 0.5278192, 0.472514, </span><br><span class="hljs-string">                                       0.4215262, 0.3745775, 0.3314044, 0.2917579, 0.2554026, 0.2221162, </span><br><span class="hljs-string">                                       0.1916888, 0.1639222, 0.1386297, 0.1156351, 0.09525016, 0.07733481, </span><br><span class="hljs-string">                                       0.06158983, 0.04775231, 0.03559115, 0.02490328, 0.0155102, 0.007255059, 0.</span><br><span class="hljs-string"> eta_levels(36:81)                   = 1.0000, 0.9946, 0.9875, 0.9789, 0.9685, 0.9562, 0.9413, 0.9238, 0.9037, 0.8813, 0.8514,</span><br><span class="hljs-string">                                       0.8210, 0.7906, 0.7602, 0.7298, 0.6812, 0.6290, 0.5796, 0.5333, 0.4901, 0.4493, 0.4109,</span><br><span class="hljs-string">                                       0.3746, 0.3412, 0.3098, 0.2802, 0.2524, 0.2267, 0.2028, 0.1803, 0.1593, 0.1398, 0.1219,</span><br><span class="hljs-string">                                       0.1054, 0.0904, 0.0766, 0.0645, 0.0534, 0.0433, 0.0341, 0.0259, 0.0185, 0.0118, 0.0056, 0.    </span><br><span class="hljs-string"> vert_refine_method                  = 0,     2,</span><br><span class="hljs-string"></span><br><span class="hljs-string"></span><br><span class="hljs-string"></span><br><span class="hljs-string">** Tropopause data level of max winds data, for program real.exe only</span><br><span class="hljs-string"></span><br><span class="hljs-string">When information (mostly NCEP supplied through GFS or NAM) is available </span><br><span class="hljs-string">in the Grib2 file, AND extracted with ungrib, the metgrid program inserts</span><br><span class="hljs-string">flag information into the data stream that is input by real.  The real</span><br><span class="hljs-string">program is able to use the available u, v, T, height fields (each may be on</span><br><span class="hljs-string">a tropopause .OR. the level of max winds) in the vertical interpolation.</span><br><span class="hljs-string">To &quot;tune&quot; the data, the user may select a level below which the max wind </span><br><span class="hljs-string">inforamtion is ignored.  The default is 300 hPa.  The user may also </span><br><span class="hljs-string">select the level that when exceeded the trop and maxw fields are ignored</span><br><span class="hljs-string">(due to the horizontal pressure difference detecting a user-defined</span><br><span class="hljs-string">discontinuity, and the metgrid horizontal interpolation across the </span><br><span class="hljs-string">discontinuity would be suspect).  By default, this option is turned off.</span><br><span class="hljs-string">The user may choose to individually activate the vertical interpolation of</span><br><span class="hljs-string">either the level of max winds .OR. the tropopause level.</span><br><span class="hljs-string"></span><br><span class="hljs-string">Default (all pressure units Pa):</span><br><span class="hljs-string"> &amp;domains</span><br><span class="hljs-string"> maxw_horiz_pres_diff                = 5000</span><br><span class="hljs-string"> trop_horiz_pres_diff                = 5000</span><br><span class="hljs-string"> maxw_above_this_level               = 30000</span><br><span class="hljs-string"> use_maxw_level                      = 0 (0=do not use level, 1 = use level)</span><br><span class="hljs-string"> use_trop_level                      = 0 (0=do not use level, 1 = use level)</span><br><span class="hljs-string"></span><br><span class="hljs-string"></span><br><span class="hljs-string"></span><br><span class="hljs-string"></span><br><span class="hljs-string">** Using aerosol option aer_opt = 2:</span><br><span class="hljs-string"></span><br><span class="hljs-string">&amp;physics</span><br><span class="hljs-string"> aer_opt            = 2,</span><br><span class="hljs-string"> aer_type           = 1,</span><br><span class="hljs-string"> aer_aod550_opt     = 1,</span><br><span class="hljs-string"> aer_aod550_val     = 0.12,</span><br><span class="hljs-string"> aer_angexp_opt     = 1,</span><br><span class="hljs-string"> aer_angexp_val     = 1.3,</span><br><span class="hljs-string"> aer_ssa_opt        = 1,</span><br><span class="hljs-string"> aer_ssa_val        = 0.85,</span><br><span class="hljs-string"> aer_asy_opt        = 1,</span><br><span class="hljs-string"> aer_asy_val        = 0.90,</span><br><span class="hljs-string"></span><br><span class="hljs-string"></span><br><span class="hljs-string">** Using Jimenez wind-farm scheme</span><br><span class="hljs-string"></span><br><span class="hljs-string">In the &amp;physics namelist record, set the MAX_DOM value:</span><br><span class="hljs-string"> windfarm                            = 1,    1,    1</span><br><span class="hljs-string"></span><br><span class="hljs-string">Also in the directory with namelist.input, is the file defining the</span><br><span class="hljs-string">specifics of the wind turbine type: wind-turbine-1.tbl</span><br><span class="hljs-string"></span><br><span class="hljs-string">The location of wind turbines are specified as lat lon, and </span><br><span class="hljs-string">the turbine type: windturbines.txt</span><br><span class="hljs-string"></span><br><span class="hljs-string">** Using stochastic schemes</span><br><span class="hljs-string">&amp;stoch</span><br><span class="hljs-string"> skebs              = 1, 1, 1, </span><br><span class="hljs-string"> rand_perturb       = 1, 1, 1, </span><br><span class="hljs-string"></span><br><span class="hljs-string"></span><br><span class="hljs-string">** Using kfcupscheme cu_physics (cumulus scheme option). This has been tested with</span><br><span class="hljs-string">the CAM radiation scheme and is not recommended with other radiation schemes.</span><br><span class="hljs-string">Regarding cu_rad_feedback, users want the parameterized clouds to affect radiation.  </span><br><span class="hljs-string">Turning it off is only useful as a sensitivity study to determine the importance of </span><br><span class="hljs-string">that effect. Regarding shallowcu_forced_ra option, setting it to true will override </span><br><span class="hljs-string">the cloud fraction calculations to a prescribed maximum cloud fraction (a value of 0.36)</span><br><span class="hljs-string">which can be changed by the user for sensitivity testing purposes.</span><br><span class="hljs-string"></span><br><span class="hljs-string">&amp;physics</span><br><span class="hljs-string"> cu_physics          = 10,    10,    10,</span><br><span class="hljs-string"> ra_lw_physics       = 3,     3,     3,</span><br><span class="hljs-string"> ra_sw_physics       = 3,     3,     3,</span><br><span class="hljs-string"> cu_rad_feedback     =.true.,.true.,.true.,</span><br><span class="hljs-string"> shallowcu_forced_ra = .false.,.false.,.false.,</span><br><span class="hljs-string"> numBins             = 21,    21,    21,</span><br><span class="hljs-string"> thBinSize           = 0.1,   0.1,   0.1,</span><br><span class="hljs-string"> rBinSize            = 0.0001,0.0001,0.0001,</span><br><span class="hljs-string"> minDeepFreq         = 0.333, 0.333, 0.333,</span><br><span class="hljs-string"> minShallowFreq      = 0.01,  0.01,  0.01, </span><br><span class="hljs-string"></span><br><span class="hljs-string"></span><br><span class="hljs-string">** To write out an input file during the model simulation.</span><br><span class="hljs-string"></span><br><span class="hljs-string">&amp;time_control</span><br><span class="hljs-string"> write_input                         = .TRUE.,</span><br><span class="hljs-string"> inputout_interval_m                 = 60, 60, 60</span><br><span class="hljs-string"> input_outname                       = &quot;wrfinput_out_d&lt;domain&gt;_&lt;date&gt;&quot;</span><br><span class="hljs-string"> inputout_begin_h                    = 3, 6, 6</span><br><span class="hljs-string"> inputout_end_h                      = 9, 6, 6</span><br><span class="hljs-string"></span><br><span class="hljs-string">** To use climatological data in Thompson microphysics option 28: in addition to</span><br><span class="hljs-string">process additional data in metgrid, use these:</span><br><span class="hljs-string"></span><br><span class="hljs-string">&amp;domains</span><br><span class="hljs-string"> wif_input_opt                       = 1</span><br><span class="hljs-string"> num_wif_levels                      = 30</span><br><span class="hljs-string"></span><br><span class="hljs-string">&amp;physics</span><br><span class="hljs-string"> mp_physics                          = 28,    28,    28,</span><br><span class="hljs-string"> use_aero_icbc                       = .true.</span><br><span class="hljs-string"></span><br><span class="hljs-string"></span><br><span class="hljs-string">** The hybrid vertical coordinate (HVC) requires three pieces:</span><br><span class="hljs-string">1. The WRF and real codes must be built with HVC activated (./configure -hyb)</span><br><span class="hljs-string">2. The eta location (etac) at which the eta levels higher up in the atmosphere</span><br><span class="hljs-string">   become isobaric must be defined (suggested default in Registry).</span><br><span class="hljs-string">3. The run-time option to select the HVC (hybrid_opt, default is OFF): </span><br><span class="hljs-string">&amp;dynamics</span><br><span class="hljs-string"> hybrid_opt          = 2,</span><br><span class="hljs-string"> etac                = 0.2,</span><br><span class="hljs-string"></span><br><span class="hljs-string">** New mechanism to specify physics:</span><br><span class="hljs-string"></span><br><span class="hljs-string">&amp;physics</span><br><span class="hljs-string"> physics_suite = &#x27;</span>CONUS<span class="hljs-string">&#x27;</span><br><span class="hljs-string"></span><br><span class="hljs-string">which is equivalent to</span><br><span class="hljs-string"></span><br><span class="hljs-string"> mp_physics         = 8,</span><br><span class="hljs-string"> cu_physics         = 6,</span><br><span class="hljs-string"> ra_lw_physics      = 4,</span><br><span class="hljs-string"> ra_sw_physics      = 4,</span><br><span class="hljs-string"> bl_pbl_physics     = 2,</span><br><span class="hljs-string"> sf_sfclay_physics  = 2,</span><br><span class="hljs-string"> sf_surface_physics = 2,</span><br><span class="hljs-string"></span><br><span class="hljs-string">&amp;physics</span><br><span class="hljs-string"> physics_suite = &#x27;</span>TROPICAL<span class="hljs-string">&#x27;</span><br><span class="hljs-string"></span><br><span class="hljs-string">which is equivalent to</span><br><span class="hljs-string"></span><br><span class="hljs-string"> mp_physics         = 6,</span><br><span class="hljs-string"> cu_physics         = 16,</span><br><span class="hljs-string"> ra_lw_physics      = 4,</span><br><span class="hljs-string"> ra_sw_physics      = 4,</span><br><span class="hljs-string"> bl_pbl_physics     = 1,</span><br><span class="hljs-string"> sf_sfclay_physics  = 91,</span><br><span class="hljs-string"> sf_surface_physics = 2,</span><br><span class="hljs-string"></span><br><span class="hljs-string"></span><br><span class="hljs-string">To overwrite the cu_physics option for a second nest, set </span><br><span class="hljs-string"></span><br><span class="hljs-string"> &amp;physics</span><br><span class="hljs-string"> physics_suite                       = &#x27;</span>tropical<span class="hljs-string">&#x27;</span><br><span class="hljs-string"> cu_physics                          = -1,    -1,     0,</span><br><span class="hljs-string"> ...</span><br><span class="hljs-string"></span><br><span class="hljs-string">** New way to automatically choose levels (default auto_levels_opt=2)</span><br><span class="hljs-string"> max_dz                              = 1000.</span><br><span class="hljs-string"> auto_levels_opt                     = 2</span><br><span class="hljs-string"> dzbot                               = 50.</span><br><span class="hljs-string"> dzstretch_s                         = 1.3</span><br><span class="hljs-string"> dzstretch_u                         = 1.1</span><br><span class="hljs-string"></span><br><span class="hljs-string">** Using the scale-adaptive SMS-3DTKE subgrid turbulent mixing scheme: </span><br><span class="hljs-string"> &amp;physics</span><br><span class="hljs-string">   bl_pbl_physics = 0,</span><br><span class="hljs-string">   sf_sfclay_physics = 1(or 5, 91), </span><br><span class="hljs-string"> /</span><br><span class="hljs-string"> &amp;dynamics</span><br><span class="hljs-string">   diff_opt       = 2,</span><br><span class="hljs-string">   km_opt         = 5, </span><br><span class="hljs-string"> /</span><br><span class="hljs-string"></span><br><span class="hljs-string"></span><br><span class="hljs-string">** Using lightning option</span><br><span class="hljs-string"> &amp;physics</span><br><span class="hljs-string"> lightning_option                    = 2,</span><br><span class="hljs-string"> iccg_method                         = 1,</span><br><span class="hljs-string"> iccg_prescribed_num                 = 2,</span><br><span class="hljs-string"> iccg_prescribed_den                 = 1,</span><br><span class="hljs-string"> cldtop_adjustment                   = 0,</span><br><span class="hljs-string"> lightning_dt                        = 5,   ; default: time_step</span><br><span class="hljs-string"> lightning_start_seconds             = 600,</span><br><span class="hljs-string"> flashrate_factor                    = 1.0,</span><br><span class="hljs-string"> ltng_temp_upper                    = -45., ; used by lnox_opt=2</span><br><span class="hljs-string"> ltng_temp_lower                    = -15., ; used by lnox_opt=2</span><br><span class="hljs-string"> /</span><br><span class="hljs-string"> </span><br><span class="hljs-string"> &amp;chem</span><br><span class="hljs-string"> lnox_opt                           = 2,</span><br><span class="hljs-string"> n_ic                               = 200,</span><br><span class="hljs-string"> n_cg                               = 200,</span><br><span class="hljs-string"> lnox_passive                       = .false.,</span><br><span class="hljs-string"> /</span><br><span class="hljs-string"></span><br><span class="hljs-string"></span><br><span class="hljs-string">** Using the irrigation parameterizations:</span><br><span class="hljs-string">&amp;physics</span><br><span class="hljs-string"> sf_surf_irr_scheme                  = 3,</span><br><span class="hljs-string"> irr_daily_amount                    = 5.7,</span><br><span class="hljs-string"> irr_start_hour                      = 2,</span><br><span class="hljs-string"> irr_num_hours                       = 3,</span><br><span class="hljs-string"> irr_start_julianday                 = 135,</span><br><span class="hljs-string"> irr_end_julianday                   = 350,</span><br><span class="hljs-string"> irr_ph                              = 0,</span><br><span class="hljs-string"> irr_freq                            = 1,</span><br><span class="hljs-string">/</span><br></code></pre></td></tr></table></figure><h2 id="namelist.input-d0115km">namelist.input d01=15km</h2><p><a href="https://github.com/wrf-model/WRF/blob/master/test/em_real/namelist.input">Git em_real/namelist.input</a></p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><code class="hljs sh">&amp;time_control<br>run_days                            = 0,<br>run_hours                           = 36,<br>run_minutes                         = 0,<br>run_seconds                         = 0,<br>start_year                          = 2019, 2019,<br>start_month                         = 09,   09, <br>start_day                           = 04,   04,<br>start_hour                          = 12,   12,<br>end_year                            = 2019, 2019,<br>end_month                           = 09,   09,<br>end_day                             = 06,   06,<br>end_hour                            = 00,   00,<br>interval_seconds                    = 10800<br>input_from_file                     = .<span class="hljs-literal">true</span>.,.<span class="hljs-literal">true</span>.,<br>history_interval                    = 60,  60,<br>frames_per_outfile                  = 1, 1,<br>restart                             = .<span class="hljs-literal">false</span>.,<br>restart_interval                    = 7200,<br>io_form_history                     = 2<br>io_form_restart                     = 2<br>io_form_input                       = 2<br>io_form_boundary                    = 2<br>/<br><br>&amp;domains<br>time_step                           = 90,<br>time_step_fract_num                 = 0,<br>time_step_fract_den                 = 1,<br>max_dom                             = 2,<br>e_we                                = 150,    220,<br>e_sn                                = 130,    214,<br>e_vert                              = 45,     45,<br>dzstretch_s                         = 1.1<br>p_top_requested                     = 5000,<br>num_metgrid_levels                  = 34,<br>num_metgrid_soil_levels             = 4,<br>dx                                  = 15000,<br>dy                                  = 15000,<br>grid_id                             = 1,     2,<br>parent_id                           = 0,     1,<br>i_parent_start                      = 1,     53,<br>j_parent_start                      = 1,     25,<br>parent_grid_ratio                   = 1,     3,<br>parent_time_step_ratio              = 1,     3,<br>feedback                            = 1,<br>smooth_option                       = 0<br>/<br><br>&amp;physics<br>physics_suite                       = <span class="hljs-string">&#x27;CONUS&#x27;</span><br>mp_physics                          = -1,    -1,<br>cu_physics                          = -1,    -1,<br>ra_lw_physics                       = -1,    -1,<br>ra_sw_physics                       = -1,    -1,<br>bl_pbl_physics                      = -1,    -1,<br>sf_sfclay_physics                   = -1,    -1,<br>sf_surface_physics                  = -1,    -1,<br>radt                                = 15,    15,<br>bldt                                = 0,     0,<br>cudt                                = 0,     0,<br>icloud                              = 1,<br>num_land_cat                        = 21,<br>sf_urban_physics                    = 0,     0,<br>fractional_seaice                   = 1,<br>/<br><br>&amp;fdda<br>/<br><br>&amp;dynamics<br>hybrid_opt                          = 2, <br>w_damping                           = 0,<br>diff_opt                            = 2,      2,<br>km_opt                              = 4,      4,<br>diff_6th_opt                        = 0,      0,<br>diff_6th_factor                     = 0.12,   0.12,<br>base_temp                           = 290.<br>damp_opt                            = 3,<br>zdamp                               = 5000.,  5000.,<br>dampcoef                            = 0.2,    0.2,<br>khdif                               = 0,      0,<br>kvdif                               = 0,      0,<br>non_hydrostatic                     = .<span class="hljs-literal">true</span>., .<span class="hljs-literal">true</span>.,<br>moist_adv_opt                       = 1,      1,<br>scalar_adv_opt                      = 1,      1,<br>gwd_opt                             = 1,      0,<br>/<br><br>&amp;bdy_control<br>spec_bdy_width                      = 5,<br>specified                           = .<span class="hljs-literal">true</span>.<br>/<br><br>&amp;grib2<br>/<br><br>&amp;namelist_quilt<br>nio_tasks_per_group = 0,<br>nio_groups = 1,<br>/<br></code></pre></td></tr></table></figure><h2 id="namelist.input-d014km">namelist.input d01=4km</h2><p><a href="https://github.com/wrf-model/WRF/blob/master/test/em_real/namelist.input.4km">Git em_real/namelist.input.4km</a></p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><code class="hljs sh">&amp;time_control<br>run_days                            = 0,<br>run_hours                           = 12,<br>run_minutes                         = 0,<br>run_seconds                         = 0,<br>start_year                          = 2001, 2001, 2001,<br>start_month                         = 06,   06,   06,<br>start_day                           = 11,   11,   11,<br>start_hour                          = 12,   12,   12,<br>end_year                            = 2001, 2001, 2001,<br>end_month                           = 06,   06,   06,<br>end_day                             = 12,   12,   12,<br>end_hour                            = 12,   12,   12,<br>interval_seconds                    = 10800<br>input_from_file                     = .<span class="hljs-literal">true</span>.,.<span class="hljs-literal">true</span>.,.<span class="hljs-literal">true</span>.,<br>history_interval                    = 60,   60,   60,<br>frames_per_outfile                  = 1,    1,    1,<br>restart                             = .<span class="hljs-literal">false</span>.,<br>restart_interval                    = 1440,<br>io_form_history                     = 2<br>io_form_restart                     = 2<br>io_form_input                       = 2<br>io_form_boundary                    = 2<br>/<br><br>&amp;domains<br>time_step                           = 24,<br>time_step_fract_num                 = 0,<br>time_step_fract_den                 = 1,<br>max_dom                             = 1,<br>e_we                                = 225,   112,   94,<br>e_sn                                = 202,   97,    91,<br>e_vert                              = 35,    35,    35,<br>p_top_requested                     = 5000,<br>num_metgrid_levels                  = 32<br>num_metgrid_soil_levels             = 4,<br>dx                                  = 4000,<br>dy                                  = 4000,<br>grid_id                             = 1,     2,     3,<br>parent_id                           = 0,     1,     2,<br>i_parent_start                      = 1,     31,    30,<br>j_parent_start                      = 1,     17,    30,<br>parent_grid_ratio                   = 1,     3,     3,<br>parent_time_step_ratio              = 1,     3,     3,<br>feedback                            = 1,<br>smooth_option                       = 0<br>/<br><br>&amp;physics<br>mp_physics                          = 8,     8,     8,<br>ra_lw_physics                       = 4,     4,     4,<br>ra_sw_physics                       = 4,     4,     4,<br>radt                                = 10,    10,    10,<br>sf_sfclay_physics                   = 1,     1,     1,<br>sf_surface_physics                  = 2,     2,     2,<br>bl_pbl_physics                      = 1,     1,     1,<br>bldt                                = 0,     0,     0,<br>ysu_topdown_pblmix                  = 1,<br>cu_physics                          = 0,     0,     0,<br>cudt                                = 0,     0,     0,<br>icloud                              = 1,<br>num_land_cat                        = 21,<br>sf_urban_physics                    = 0,     0,     0,<br>/<br><br>&amp;fdda<br>/<br><br>&amp;dynamics<br>hybrid_opt                          = 2, <br>w_damping                           = 0,<br>diff_opt                            = 1,      1,      1,<br>km_opt                              = 4,      4,      4,<br>diff_6th_opt                        = 0,      0,      0,<br>diff_6th_factor                     = 0.12,   0.12,   0.12,<br>base_temp                           = 290.<br>damp_opt                            = 3,<br>zdamp                               = 5000.,  5000.,  5000.,<br>dampcoef                            = 0.2,    0.2,    0.2<br>khdif                               = 0,      0,      0,<br>kvdif                               = 0,      0,      0,<br>non_hydrostatic                     = .<span class="hljs-literal">true</span>., .<span class="hljs-literal">true</span>., .<span class="hljs-literal">true</span>.,<br>moist_adv_opt                       = 2,      2,      2,<br>scalar_adv_opt                      = 2,      2,      2,<br>/<br><br>&amp;bdy_control<br>spec_bdy_width                      = 5,<br>specified                           = .<span class="hljs-literal">true</span>.,<br>/<br><br>&amp;grib2<br>/<br><br>&amp;namelist_quilt<br>nio_tasks_per_group = 0,<br>nio_groups = 1,<br>/<br></code></pre></td></tr></table></figure><h2 id="namelist.input.pbl-les">namelist.input.PBL-LES</h2><p><a href="https://github.com/wrf-model/WRF/blob/master/test/em_real/namelist.input.pbl-les">Git PBL LES</a></p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><code class="hljs sh">&amp;time_control<br>run_days                            = 0,<br>run_hours                           = 12,<br>run_minutes                         = 0,<br>run_seconds                         = 0,<br>start_year                          = 2001, 2001, 2001,<br>start_month                         = 06,   06,   06,<br>start_day                           = 11,   11,   11,<br>start_hour                          = 12,   12,   12,<br>start_minute                        = 00,   00,   00,<br>start_second                        = 00,   00,   00,<br>end_year                            = 2001, 2001, 2001,<br>end_month                           = 06,   06,   06,<br>end_day                             = 12,   12,   12,<br>end_hour                            = 12,   12,   12,<br>end_minute                          = 00,   00,   00,<br>end_second                          = 00,   00,   00,<br>interval_seconds                    = 10800<br>input_from_file                     = .<span class="hljs-literal">true</span>.,.<span class="hljs-literal">true</span>.,.<span class="hljs-literal">true</span>.,<br>history_interval                    = 60,   60,   60,<br>frames_per_outfile                  = 1,    1,    1,<br>restart                             = .<span class="hljs-literal">false</span>.,<br>restart_interval                    = 60,<br>io_form_history                     = 2<br>io_form_restart                     = 2<br>io_form_input                       = 2<br>io_form_boundary                    = 2<br>/<br><br>&amp;domains<br>time_step                           = 5,<br>time_step_fract_num                 = 0,<br>time_step_fract_den                 = 1,<br>max_dom                             = 3,<br>e_we                                = 225,   112,   94,<br>e_sn                                = 202,   97,    91,<br>e_vert                              = 35,    35,    35,<br>p_top_requested                     = 5000,<br>num_metgrid_levels                  = 40<br>num_metgrid_soil_levels             = 4,<br>dx                                  = 1000,<br>dy                                  = 1000,<br>grid_id                             = 1,     2,     3,<br>parent_id                           = 0,     1,     2,<br>i_parent_start                      = 1,     31,    30,<br>j_parent_start                      = 1,     17,    30,<br>parent_grid_ratio                   = 1,     3,     3,<br>parent_time_step_ratio              = 1,     3,     3,<br>feedback                            = 1,<br>smooth_option                       = 0<br>/<br><br>&amp;physics<br>mp_physics                          = 8,     8,     8,<br>ra_lw_physics                       = 4,     4,     4,<br>ra_sw_physics                       = 4,     4,     4,<br>radt                                = 1,     1,     1,<br>sf_sfclay_physics                   = 1,     1,     1,<br>sf_surface_physics                  = 2,     2,     2,<br>bl_pbl_physics                      = 1,     0,     0,<br>bldt                                = 0,     0,     0,<br>ysu_topdown_pblmix                  = 1,<br>cu_physics                          = 0,     0,     0,<br>cudt                                = 0,     0,     0,<br>icloud                              = 1,<br>num_land_cat                        = 21,<br>sf_urban_physics                    = 0,     0,     0,<br>/<br><br>&amp;dynamics<br>hybrid_opt                          = 2, <br>w_damping                           = 0,<br>diff_opt                            = 2,      2,      2,<br>km_opt                              = 4,      3,      3,<br>diff_6th_opt                        = 0,      0,      0,<br>diff_6th_factor                     = 0.12,   0.12,   0.12,<br>base_temp                           = 290.<br>damp_opt                            = 3,<br>zdamp                               = 5000.,  5000.,  5000.,<br>dampcoef                            = 0.2,    0.2,    0.2<br>khdif                               = 0,      0,      0,<br>kvdif                               = 0,      0,      0,<br>non_hydrostatic                     = .<span class="hljs-literal">true</span>., .<span class="hljs-literal">true</span>., .<span class="hljs-literal">true</span>.,<br>moist_adv_opt                       = 2,      2,      2,<br>scalar_adv_opt                      = 2,      2,      2,<br>/<br><br>&amp;bdy_control<br>spec_bdy_width                      = 5,<br>specified                           = .<span class="hljs-literal">true</span>.,<br>/<br><br>&amp;namelist_quilt<br>nio_tasks_per_group = 0,<br>nio_groups = 1,<br>/<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>WRF</category>
      
    </categories>
    
    
    <tags>
      
      <tag>WRF</tag>
      
      <tag>namelist.input</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>zsh &amp; oh-my-zsh</title>
    <link href="/2023/04/30/zsh_oh_my_zsh/"/>
    <url>/2023/04/30/zsh_oh_my_zsh/</url>
    
    <content type="html"><![CDATA[<h1 id="zsh-oh-my-zsh">zsh &amp; oh-my-zsh</h1><p>The pre-installed shell of most Linux distributions is bash. But, zsh is more powerfull tool on the terminal.</p><h2 id="zsh">zsh</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-built_in">sudo</span> apt install zsh<br><br><span class="hljs-comment"># change the default shell</span><br><span class="hljs-built_in">sudo</span> chsh -s $(<span class="hljs-built_in">which</span> zsh) $(<span class="hljs-built_in">whoami</span>)<br></code></pre></td></tr></table></figure><p>Note: Because the Shell can set different default values ​​according to each account, so referring to the syntax of this article, a whoami technique is used to dynamically obtain the name of the currently logged-in account through the command to set it.</p><h3 id="install-oh-my-zsh">Install oh-my-zsh</h3><p>After installing zsh in the previous step, we can start to adjust the command line appearance settings we want, but the original zsh was too difficult to set up, so it didn’t receive much attention when it first appeared many years ago, until someone wrote a set The framework called oh-my-zsh helps everyone use zsh, and zsh became popular. Now almost all zsh useful tools support oh-my-zsh, so of course it is necessary to install this thing</p><p>Installation <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">sh -c <span class="hljs-string">&quot;<span class="hljs-subst">$(curl -fsSL https://raw.githubusercontent.com/robbyrussell/oh-my-zsh/master/tools/install.sh)</span>&quot;</span><br></code></pre></td></tr></table></figure> After execution, if there is no error message, it means success, and you will find more folders of oh-my-zsh ~/.oh-my-zsh</p><p>However, oh-my-zsh has a lot of built-in themes, and there are many screenshots on its github wiki for reference &gt; https://github.com/ohmyzsh/ohmyzsh/wiki/Themes</p><p>It is very simple to switch the built-in theme, directly modify your ~/.zshrc, and change the original ZSH_THEME="robbyrussell" to what you want</p><h3 id="edit-.zshrc">Edit .zshrc</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># some more ls aliases</span><br><span class="hljs-built_in">alias</span> ll=<span class="hljs-string">&#x27;ls -alF&#x27;</span><br><span class="hljs-built_in">alias</span> la=<span class="hljs-string">&#x27;ls -A&#x27;</span><br><span class="hljs-built_in">alias</span> l=<span class="hljs-string">&#x27;ls -CF&#x27;</span><br><br><span class="hljs-comment"># export TERM=&#x27;xterm-256color&#x27;</span><br><span class="hljs-comment"># # To determine the prompt format, use the $PS1 variable.</span><br><span class="hljs-comment"># PS1=&quot;%&#123;$fg[red]%&#125;%n%&#123;$reset_color%&#125;@%&#123;$fg[green]%&#125;%m %&#123;$fg[yellow]%&#125;%(5~|%-1~/.../%3~|%4~) %&#123;$reset_color%&#125;%% &quot;</span><br></code></pre></td></tr></table></figure><blockquote><p>ZSH_THEME=”agnoster” # Try changing robbyrussell to agnoster After any zsh settings are modified, the following commands must be executed to take effect</p></blockquote><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-built_in">exec</span> <span class="hljs-variable">$SHELL</span><br></code></pre></td></tr></table></figure><h3 id="conda-problem">Conda problem</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs sh">CommandNotFoundError: Your shell has not been properly configured to use <span class="hljs-string">&#x27;conda activate&#x27;</span>.<br>To initialize your shell, run<br><br>    $ conda init &lt;SHELL_NAME&gt;<br><br>Currently supported shells are:<br>  - bash<br>  - fish<br>  - tcsh<br>  - xonsh<br>  - zsh<br>  - powershell<br><br>See <span class="hljs-string">&#x27;conda init --help&#x27;</span> <span class="hljs-keyword">for</span> more information and options.<br>IMPORTANT: You may need to close and restart your shell after running <span class="hljs-string">&#x27;conda init&#x27;</span>.<br></code></pre></td></tr></table></figure><p>do <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">conda init zsh<br></code></pre></td></tr></table></figure></p><h3 id="zsh-autosuggestions">zsh-autosuggestions</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">git <span class="hljs-built_in">clone</span> https://github.com/zsh-users/zsh-autosuggestions <span class="hljs-variable">$&#123;ZSH_CUSTOM:-~/.oh-my-zsh/custom&#125;</span>/plugins/zsh-autosuggestions<br></code></pre></td></tr></table></figure><p>In .zshrc, &gt; plugins=(zsh-autosuggestions) and then, source ~/.zshrc</p><p>Usage &gt; If you think it is correct, you can press CTRL+F to accept it</p><h3 id="quick-jump-cd--">quick jump: cd -</h3><p>As mentioned earlier, switching between different paths is a headache in command line work. In addition to the abbreviation completion mentioned above, is there a faster way for me to immediately switch to a certain path I recently jumped to? path? Of course there is the <strong>"cd -"</strong> command</p><p>After inputting cd followed by a minus sign, press tab once to list the recent paths visited after this login, and then enter the number according to the prompt below and press Enter to pass, for example, input:** $ cd -5 &lt; Press Enter&gt;** to jump to the ~/software/libclang-python3 path. Of course, instead of entering numbers, you can press tab again to enter the selection mode, use the up and down keys or ctrl+n/p to select, press Enter to confirm, and ctrl+g to return.</p><h3 id="jump-d">jump: d</h3><p>Zsh's directory jump is more intelligent, you don't need to enter cd, just enter the path directly. .. means back one directory, ../../ means back two levels, and so on. (The function of ... is the same as that of ../../) Enter d to list all directories visited by the current session, and then press the number prompted to enter the corresponding directory. <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs sh">~ &gt; d<br>0 ~ <br>1 ~/Applications <br>2 ~/.proxychains <br>3 /opt/homebrew-cask/Caskroom<br>~ &gt; 1<br>~/Applications<br></code></pre></td></tr></table></figure></p><h2 id="zsh-mkdirsource...-not-found">zsh mkdir/source/...: not found</h2><p>Using bash for all script, &gt; #!/bin/bash</p><h2 id="building-zsh-without-root">Building zsh without root</h2><blockquote><p>No terminal handling library found</p></blockquote><p>Have to install <strong>ncurses</strong> <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh">wget https://invisible-island.net/ncurses/#download_ncurses<br>ex<br></code></pre></td></tr></table></figure> output is <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs sh">=== output ===<br>** Configuration summary <span class="hljs-keyword">for</span> NCURSES 6.3 20211021:<br><br>       extended funcs: <span class="hljs-built_in">yes</span><br>       xterm terminfo: xterm-new<br><br>        bin directory: /home/wpsze/zsh/ncurses/bin<br>        lib directory: /home/wpsze/zsh/ncurses/lib<br>    include directory: /home/wpsze/zsh/ncurses/include/ncurses<br>        man directory: /home/wpsze/zsh/ncurses/share/man<br>   terminfo directory: /home/wpsze/zsh/ncurses/share/terminfo<br><br>** Include-directory is not <span class="hljs-keyword">in</span> a standard location<br>=====<br></code></pre></td></tr></table></figure></p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs sh">wget -O zsh.tar.xz https://sourceforge.net/projects/zsh/files/latest/download --no-check-certificate<br>tar -xvf zsh.tar<br><span class="hljs-built_in">cd</span> zsh<br><br>INSTALLATION_PATH=<span class="hljs-string">&#x27;/home/wpsze/zsh/ncurses/&#x27;</span><br><span class="hljs-built_in">export</span> PATH=<span class="hljs-variable">$INSTALLATION_PATH</span>/bin/:<span class="hljs-variable">$PATH</span><br><span class="hljs-built_in">export</span> LD_LIBRARY_PATH=<span class="hljs-variable">$INSTALLATION_PATH</span>/lib:<span class="hljs-variable">$LD_LIBRARY_PATH</span><br><span class="hljs-built_in">export</span> CFLAGS=-I<span class="hljs-variable">$INSTALLATION_PATH</span>/include<br><br><span class="hljs-built_in">export</span> CPPFLAGS=<span class="hljs-string">&quot;-I<span class="hljs-variable">$INSTALLATION_PATH</span>/include&quot;</span> <br><span class="hljs-built_in">export</span> LDFLAGS=<span class="hljs-string">&quot;-L<span class="hljs-variable">$INSTALLATION_PATH</span>/lib&quot;</span><br><br>./configure --prefix=<span class="hljs-variable">$HOME</span>/zsh<br>make <br>make install<br></code></pre></td></tr></table></figure><p>Error <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sh">/usr/bin/ld: /home/wpsze/zsh/ncurses//lib/libncurses.a(comp_captab.o): relocation R_X86_64_32 against `.rodata<span class="hljs-string">&#x27; can not be used when making a shared object; recompile with -fPIC</span><br><span class="hljs-string">/usr/bin/ld: final link failed: Nonrepresentable section on output</span><br><span class="hljs-string">collect2: error: ld returned 1 exit status</span><br></code></pre></td></tr></table></figure> and <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs sh">zsh configuration<br>-----------------<br>zsh version               : 5.9<br>host operating system     : x86_64-pc-linux-gnu<br><span class="hljs-built_in">source</span> code location      : .<br>compiler                  : gcc -std=gnu11<br>preprocessor flags        : -I/home/wpsze/zsh/ncurses//include<br>executable compiler flags : -I/home/wpsze/zsh/ncurses//include -fPIC<br>module compiler flags     : -I/home/wpsze/zsh/ncurses//include -fPIC -fPIC<br>executable linker flags   : -L/home/wpsze/zsh/ncurses//lib  -rdynamic<br>module linker flags       : -L/home/wpsze/zsh/ncurses//lib  -shared<br>library flags             : -ldl -lncurses -lrt -lm  -lc<br>installation <span class="hljs-built_in">basename</span>     : zsh<br>binary install path       : /home/wpsze/zsh/bin<br>man page install path     : /home/wpsze/zsh/share/man<br>info install path         : /home/wpsze/zsh/share/info<br><span class="hljs-built_in">functions</span> install path    : /home/wpsze/zsh/share/zsh/5.9/functions<br>See config.modules <span class="hljs-keyword">for</span> installed modules and <span class="hljs-built_in">functions</span>.<br></code></pre></td></tr></table></figure> &gt; gcc -std=gnu11 -L/home/wpsze/zsh/ncurses//lib -rdynamic -o zsh main.o <code>cat stamp-modobjs</code> -ldl -lncurses -lrt -lm -lc</p><blockquote><p>recompile with -fPIC</p></blockquote><p>Not solved</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">6903 LIBS=<span class="hljs-string">&quot;<span class="hljs-variable">$ac_func_search_save_LIBS</span> -fPIC&quot;</span><br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>Linux</category>
      
    </categories>
    
    
    <tags>
      
      <tag>HPC</tag>
      
      <tag>shell script</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>GFS/FNL dataset</title>
    <link href="/2023/04/27/GFS_FNL/"/>
    <url>/2023/04/27/GFS_FNL/</url>
    
    <content type="html"><![CDATA[<h1 id="news-2024-july">News (2024 July)</h1><p><strong>RDA Data Services Unavailable July 30, 2024</strong></p><p>New setup goes to</p><p><a href="https://waipangsze.github.io/2024/08/16/GFS_FNL_RDA_upgrade/" class="uri">https://waipangsze.github.io/2024/08/16/GFS_FNL_RDA_upgrade/</a></p><h1 id="gfs">GFS</h1><p>The Global Forecast System (GFS)<sup id="fnref:1" class="footnote-ref"><a href="#fn:1" rel="footnote"><span class="hint--top hint--rounded" data-aria-label="[GFS Data Access](https://www.ncei.noaa.gov/products/weather-climate-models/global-forecast)">[1]</span></a></sup> is a National Centers for Environmental Prediction (NCEP) weather forecast model that generates data for dozens of atmospheric and land-soil variables, including temperatures, winds, precipitation, soil moisture, and atmospheric ozone concentration. The system couples four separate models (atmosphere, ocean model, land/soil model, and sea ice) that work together to accurately depict weather conditions.</p><h2 id="specifications">Specifications</h2><p>The GFS<sup id="fnref:2" class="footnote-ref"><a href="#fn:2" rel="footnote"><span class="hint--top hint--rounded" data-aria-label="[GFS home page](https://www.emc.ncep.noaa.gov/emc/pages/numerical_forecast_systems/gfs.php)">[2]</span></a></sup> <sup id="fnref:3" class="footnote-ref"><a href="#fn:3" rel="footnote"><span class="hint--top hint--rounded" data-aria-label="[Global Models Verification](https://www.emc.ncep.noaa.gov/users/verification/global/)">[3]</span></a></sup> is run four times a day, producing forecasts up to 16 days in advance. The forecast component uses the Finite Volume Cubed (FV3) model with a resolution of ~13 km, with the atmosphere coupled to the NCEP Global Wave Model. In the vertical, the model is divided into 127 vertical layers. It produces hourly forecast output for the first 120 hours, then 3 hourly for days 5-16. Details on the June 2019 implementation of the initial FV3 version of the GFS (GFSv15) and the March 2021 implementation of GFSv16 can be found in the links listed below.</p><h2 id="download">Download</h2><p>NCEP GFS 0.25 Degree Global Forecast Grids Historical Archive ds084.1 | DOI: 10.5065/D65D8PWK &gt; https://rda.ucar.edu/datasets/ds084.1/ &gt; The NCEP operational Global Forecast System analysis and forecast grids are on a 0.25 by 0.25 global latitude longitude grid. Grids include analysis and forecast time steps at a 3 hourly interval from 0 to 240, and a 12 hourly interval from 240 to 384. Model forecast runs occur at 00, 06, 12, and 18 UTC daily.</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-meta">#!/bin/sh</span><br><span class="hljs-comment">#################################################################</span><br><span class="hljs-comment"># Csh Script (wpsze: to sh script) to retrieve 34 online Data files of &#x27;ds084.1&#x27;,</span><br><span class="hljs-comment"># total 7.16G. This script uses &#x27;wget&#x27; to download data.</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment"># Highlight this script by Select All, Copy and Paste it into a file;</span><br><span class="hljs-comment"># make the file executable and run it on command line.</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment"># You need pass in your password as a parameter to execute</span><br><span class="hljs-comment"># this script; or you can set an environment variable RDAPSWD</span><br><span class="hljs-comment"># if your Operating System supports it.</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment"># Contact rdahelp@ucar.edu (RDA help desk) for further assistance.</span><br><span class="hljs-comment">#################################################################</span><br><br>wget --no-check-certificate -O \<br>Authentication.<span class="hljs-built_in">log</span> --save-cookies auth.rda_ucar_edu \<br>--article-data=<span class="hljs-string">&quot;email=**xxx@gmail.com**&amp;passwd=**xxx**&amp;action=login&quot;</span> https://rda.ucar.edu/cgi-bin/login<br><br>yyyy=<span class="hljs-string">&#x27;2023&#x27;</span><br>mm=<span class="hljs-string">&#x27;03&#x27;</span><br><span class="hljs-built_in">dd</span>=<span class="hljs-string">&#x27;19&#x27;</span><br>hh=<span class="hljs-string">&#x27;00&#x27;</span><br>yyyymm=<span class="hljs-variable">$&#123;yyyy&#125;</span><br><br><span class="hljs-keyword">for</span> gfsfile <span class="hljs-keyword">in</span> $(<span class="hljs-built_in">seq</span> 0 3 12); <span class="hljs-keyword">do</span> <span class="hljs-comment"># Forecast time = 12, 24, 36, 48, 60, 72, 84, 96, 108, 130, 142, 154</span><br>tmp=$(<span class="hljs-built_in">printf</span> <span class="hljs-string">&quot;%03d&quot;</span> <span class="hljs-variable">$&#123;gfsfile&#125;</span>)<br>tmp=<span class="hljs-string">&quot;<span class="hljs-variable">$&#123;yyyy&#125;</span>/<span class="hljs-variable">$&#123;yyyy&#125;</span><span class="hljs-variable">$&#123;mm&#125;</span><span class="hljs-variable">$&#123;dd&#125;</span>/gfs.0p25.<span class="hljs-variable">$&#123;yyyy&#125;</span><span class="hljs-variable">$&#123;mm&#125;</span><span class="hljs-variable">$&#123;dd&#125;</span><span class="hljs-variable">$&#123;hh&#125;</span>.f<span class="hljs-variable">$&#123;tmp&#125;</span>.grib2&quot;</span><br><span class="hljs-built_in">echo</span> <span class="hljs-variable">$&#123;tmp&#125;</span><br><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;downloading ...&quot;</span><br>wget --no-check-certificate -N --load-cookies auth.rda_ucar_edu https://rda.ucar.edu/data/ds084.1/<span class="hljs-variable">$&#123;tmp&#125;</span><br><span class="hljs-keyword">done</span><br></code></pre></td></tr></table></figure><h2 id="rename-gfs-files-by-soft-link">Rename GFS files by soft-link</h2><p>If your operational process needs the format of GFS files like as &gt; gfs_20170724_0000_0p25_000</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-meta">#!/bin/sh</span><br><br>old_gfs=`<span class="hljs-built_in">ls</span> ./*.grib2`<br><br><span class="hljs-keyword">for</span> eachfile <span class="hljs-keyword">in</span> <span class="hljs-variable">$&#123;old_gfs&#125;</span><br><span class="hljs-keyword">do</span><br>   <span class="hljs-built_in">echo</span> <span class="hljs-variable">$&#123;eachfile&#125;</span><br>   <span class="hljs-built_in">echo</span> <span class="hljs-variable">$&#123;eachfile:11:8&#125;</span>, <span class="hljs-variable">$&#123;eachfile:19:2&#125;</span>, <span class="hljs-variable">$&#123;eachfile:23:3&#125;</span><br>   <span class="hljs-built_in">echo</span> gfs_<span class="hljs-variable">$&#123;eachfile:11:8&#125;</span>_00<span class="hljs-variable">$&#123;eachfile:19:2&#125;</span>_0p25_<span class="hljs-variable">$&#123;eachfile:23:3&#125;</span><br>   <span class="hljs-built_in">ln</span> -s <span class="hljs-variable">$&#123;eachfile&#125;</span> gfs_<span class="hljs-variable">$&#123;eachfile:11:8&#125;</span>_00<span class="hljs-variable">$&#123;eachfile:19:2&#125;</span>_0p25_<span class="hljs-variable">$&#123;eachfile:23:3&#125;</span><br><span class="hljs-keyword">done</span><br></code></pre></td></tr></table></figure><h2 id="usage-of-gfs-on-wrfnwp">Usage of GFS on WRF/NWP</h2><p>GFS Data &gt; https://www2.mmm.ucar.edu/wrf/OnLineTutorial/DATA/GFS/gfs.php &gt; GFS (Global Forecast System) is a model product from NCEP. &gt; Type: GRIB1 / GRIB2 data</p><p>Resolution: &gt; 0.25 deg global data &gt; Output frequency 3 hourly &gt; 34 pressure levels</p><p>Availability: &gt; From NCAR's RDA site: https://rda.ucar.edu/datasets/ds084.1/</p><p>Vtable: <strong>Vtable.GFS</strong></p><h3 id="namelist.wps">namelist.wps</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># Edit namelist.wps</span><br>start_date = <span class="hljs-string">&#x27;2019-11-29_12:00:00&#x27;</span>,<br>end_date = <span class="hljs-string">&#x27;2019-12-01_00:00:00&#x27;</span>,<br>interval_seconds = 10800,<br>prefix = <span class="hljs-string">&#x27;FILE&#x27;</span>,<br></code></pre></td></tr></table></figure><h3 id="script">Script</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># Notes on running UNGRIB for this data</span><br><span class="hljs-comment"># Examine the GRIB files, e.g.,</span><br><span class="hljs-comment"># ./util/g2print.exe ../DATA/co_blizzard/gfs.0p25.2019112912.f000.grib2</span><br><br><span class="hljs-built_in">ln</span> -sf ungrib/Variable_Tables/Vtable.GFS Vtable<br>./link_grib.csh ../DATA/co_blizzard/gfs.0p25.2019<br><br>./ungrib.exe<br><span class="hljs-comment"># This will create an ungrib.log for your records.</span><br><br><span class="hljs-comment"># Examine the intermediate files, e.g.,</span><br><span class="hljs-comment"># ./util/rd_intermediate.exe FILE:2019-11-29_12</span><br><span class="hljs-comment"># ncl /util/plotfmt_ncl &#x27;filename=&quot;FILE:2019-11-29_12&quot;&#x27;</span><br></code></pre></td></tr></table></figure><h2 id="usage-of-fnl-on-wrfnwp">Usage of FNL on WRF/NWP</h2><p>The NCEP FNL (Final) Operational Global Analysis<sup id="fnref:4" class="footnote-ref"><a href="#fn:4" rel="footnote"><span class="hint--top hint--rounded" data-aria-label="[FNL more](https://rda.ucar.edu/OS/web/datasets/ds083.2/docs/more.html)">[4]</span></a></sup> <sup id="fnref:5" class="footnote-ref"><a href="#fn:5" rel="footnote"><span class="hint--top hint--rounded" data-aria-label="[GFS vs FNL](https://rda.ucar.edu/OS/web/datasets/ds083.2/docs/FNLvGFS.pdf)">[5]</span></a></sup> <sup id="fnref:6" class="footnote-ref"><a href="#fn:6" rel="footnote"><span class="hint--top hint--rounded" data-aria-label="[Analysis,  reanalysis, forecast—what’s the difference?](https://rda.ucar.edu/OS/web/datasets/ds083.2/docs/Analysis.pdf)">[6]</span></a></sup> is on 1x1 degree grids are available every six hours. The analyses are from the NCEP Final Analyses (FNL). These were operationally prepared by NCEP, but are available for download from NCAR/RDA.</p><p>This product is from the Global Data Assimilation System (GDAS), which continuously collects observational data from the Global Telecommunications System (GTS), and other sources, for many analyses. The FNLs are made with the same model which NCEP uses in the Global Forecast System (GFS), <strong>but the FNLs are prepared about an hour or so after the GFS is initialized. The FNLs are delayed so that more observational data can be used</strong>. <em>The GFS is run earlier in support of time critical forecast needs, and uses the FNL from the previous 6 hour cycle as part of its initialization</em>.</p><p>FNL数据集和GFS数据集虽有联系，但在同一资料同化和预报系统中却有不同的产品。它们共享相同的基础模型和数据同化技术。它们包含相同的数据源——<strong>但是在gfs和fnl的初始条件中吸收的“真实”数据的数量有细微的差别</strong>。即使有ncep的巨大计算资源，运行一个全球nwp模型也需要时间。因此，他们需要尽早启动gfs来获得预报而不是后报。fnl是最终的分析结果，比gfs稍晚一些，以便能包括所有可用的观测数据。通常，fnl比gfs多摄取约10%的观察结果。虽然开始时间较晚，但仍有足够的时间，因此6小时的fnl6小时预报可作为下一个gfs资料同化周期的背景场例如，如果你想要00z的气球数据，你必须等待气球上升穿过大气层。对于能够到达平流层的大型氦气箱来说，这可能需要多达90分钟。然后气球的数据需要从世界各地传送到美国马里兰州的ncep中心。如果你想要00z的卫星数据，你必须等待卫星经过一个地面站，这样它才能下载数据。地面站然后通过陆地或海底电缆(如果有的话)传送数据，或者通过另一颗(通信)卫星传送数据。<sup id="fnref:7" class="footnote-ref"><a href="#fn:7" rel="footnote"><span class="hint--top hint--rounded" data-aria-label="[FNL再分析数据和GFS数据之间的区别和联系](http://www.ihamodel.com/?p=17426)">[7]</span></a></sup></p><p>For further information about the FNL archives at NCAR: See, http://rda.ucar.edu/datasets/ds083.2.</p><p>Type: &gt; GRIB2 data</p><p>Resolution: &gt; 1deg global data &gt; Output frequency 6 hourly &gt; 34 pressure levels</p><p>Availability: &gt; http://rda.ucar.edu/datasets/ds083.2 &gt; Follow the tab to "Data Access -&gt; Internet Download". You must register (it is free) to access the data.</p><p>Vtable: <strong>Vtable.GFS</strong></p><h3 id="namelist.wps-1">namelist.wps</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs sh">Edit namelist.wps<br>start_date = <span class="hljs-string">&#x27;2019-11-25_12:00:00&#x27;</span>,<br>end_date = <span class="hljs-string">&#x27;2019-11-27_00:00:00&#x27;</span>,<br>interval_seconds = 21600,<br>prefix = <span class="hljs-string">&#x27;FILE&#x27;</span>,<br></code></pre></td></tr></table></figure><h3 id="script-1">Script</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># Notes on running UNGRIB for this data</span><br><span class="hljs-comment"># Examine the GRIB files, e.g.,</span><br><span class="hljs-comment"># ./util/g2print.exe ../DATA/boulder_snow/fnl_20191125_12_00.grib2</span><br><span class="hljs-built_in">ln</span> -sf ungrib/Variable_Tables/Vtable.GFS Vtable<br><br>./link_grib.csh ../DATA/boulder_snow/fnl_2019<br><br>./ungrib.exe<br><span class="hljs-comment"># This will create an ungrib.log for your records.</span><br><br><span class="hljs-comment"># Examine the intermediate files, e.g.,</span><br><span class="hljs-comment"># ./util/rd_intermediate.exe FILE:2019-11-25_12</span><br><span class="hljs-comment"># ncl /util/plotfmt.ncl &#x27;filename=&quot;FILE:2019-11-25_12&quot;&#x27;</span><br></code></pre></td></tr></table></figure><h2 id="read-and-plot-grib2-files">Read and Plot grib2 files</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sh">import xarray as xr<br>ds = xr.open_dataset(<span class="hljs-string">&#x27;./fnl_20191125_12_00.grib2&#x27;</span>,engine=<span class="hljs-string">&#x27;pynio&#x27;</span>)<br>ds<br></code></pre></td></tr></table></figure><section class="footnotes"><div class="footnote-list"><ol><li><span id="fn:1" class="footnote-text"><span><a href="https://www.ncei.noaa.gov/products/weather-climate-models/global-forecast">GFS Data Access</a> <a href="#fnref:1" rev="footnote" class="footnote-backref"> ↩</a></span></span></li><li><span id="fn:2" class="footnote-text"><span><a href="https://www.emc.ncep.noaa.gov/emc/pages/numerical_forecast_systems/gfs.php">GFS home page</a> <a href="#fnref:2" rev="footnote" class="footnote-backref"> ↩</a></span></span></li><li><span id="fn:3" class="footnote-text"><span><a href="https://www.emc.ncep.noaa.gov/users/verification/global/">Global Models Verification</a> <a href="#fnref:3" rev="footnote" class="footnote-backref"> ↩</a></span></span></li><li><span id="fn:4" class="footnote-text"><span><a href="https://rda.ucar.edu/OS/web/datasets/ds083.2/docs/more.html">FNL more</a> <a href="#fnref:4" rev="footnote" class="footnote-backref"> ↩</a></span></span></li><li><span id="fn:5" class="footnote-text"><span><a href="https://rda.ucar.edu/OS/web/datasets/ds083.2/docs/FNLvGFS.pdf">GFS vs FNL</a> <a href="#fnref:5" rev="footnote" class="footnote-backref"> ↩</a></span></span></li><li><span id="fn:6" class="footnote-text"><span><a href="https://rda.ucar.edu/OS/web/datasets/ds083.2/docs/Analysis.pdf">Analysis, reanalysis, forecast—what’s the difference?</a> <a href="#fnref:6" rev="footnote" class="footnote-backref"> ↩</a></span></span></li><li><span id="fn:7" class="footnote-text"><span><a href="http://www.ihamodel.com/?p=17426">FNL再分析数据和GFS数据之间的区别和联系</a> <a href="#fnref:7" rev="footnote" class="footnote-backref"> ↩</a></span></span></li></ol></div></section>]]></content>
    
    
    <categories>
      
      <category>NWP</category>
      
    </categories>
    
    
    <tags>
      
      <tag>WRF</tag>
      
      <tag>WPS</tag>
      
      <tag>MPAS</tag>
      
      <tag>IC/BC</tag>
      
      <tag>NCEP</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Git/Github</title>
    <link href="/2023/04/27/Git_GitHub/"/>
    <url>/2023/04/27/Git_GitHub/</url>
    
    <content type="html"><![CDATA[<h1 id="create-an-empty-git-repo">Create an empty git repo</h1><p>Git settings will be recorded in the <code>~/.gitconfig</code> 、<code>~/.config/git/config</code> file under the home page of the user's directory. We need to use the config command to set it.</p><p>Git 附帶一個名為 <code>git config</code> 的工具，讓你能夠取得和設定組態參數。任何倉儲中 Git 資料夾的 config 檔案（位於 <code>.git/config</code>）：這個倉儲的專用設定</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh">$ git config --global user.name <span class="hljs-string">&quot;&lt;username&gt;&quot;</span><br>$ git config --global user.email <span class="hljs-string">&quot;&lt;email&gt;&quot;</span><br></code></pre></td></tr></table></figure><p>Follow this command, you can set the color of Git's output (output) results. <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">$ git config --global color.ui auto<br></code></pre></td></tr></table></figure></p><p>change editor, <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">$ git config --global core.editor <span class="hljs-string">&quot;vim&quot;</span><br></code></pre></td></tr></table></figure></p><p>若你想檢查設定值，可使用 <code>git config --list</code> 命令列出所有 Git 在目前位置能找到的設定值, <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">$ git config --list<br></code></pre></td></tr></table></figure></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs `.gitconfig">[alias]<br>logg = log --graph --pretty=format:&#x27;%C(yellow)%h%Creset%C(auto)%d%Creset %s %Cgreen(%cd) %C(bold blue)&lt;%an&gt;%Creset&#x27; --abbrev-commit --date=relative<br>[user]<br>name = wpsze<br>email = waipangsze@gmail.com<br>......<br></code></pre></td></tr></table></figure><p>Follow the steps below to set the newly created tutorial directory as a Git database <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs sh">$ <span class="hljs-built_in">mkdir</span> tutorial<br>$ <span class="hljs-built_in">cd</span> tutorial<br>$ git init<br><br><span class="hljs-comment">## Initialized empty Git repository in /Users/yourname/Desktop/tutorial/.git/</span><br>$ git status<br>$ git add .<br>$ git commit -m <span class="hljs-string">&quot;first commit&quot;</span><br>$ git commit --amend<br>$ git status<br>$ git <span class="hljs-built_in">log</span><br>$ git <span class="hljs-built_in">log</span> --all --graph --oneline<br></code></pre></td></tr></table></figure></p><p><img src="https://i.imgur.com/AnlwuNk.png" width="600" /></p><h1 id="create-branch-and-swich">Create branch and swich</h1><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs sh">$ git checkout -b iss53 <span class="hljs-comment"># 同時建立且切換分支</span><br>Switched to a new branch <span class="hljs-string">&quot;iss53&quot;</span><br>This is shorthand <span class="hljs-keyword">for</span>:<br><br>$ git branch iss53<br>$ git checkout iss53<br></code></pre></td></tr></table></figure><h1 id="git-push">git push</h1><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh">$ git remote add &lt;name&gt; &lt;url&gt;<br>$ git remote add origin https://xxx/tutorial.git<br></code></pre></td></tr></table></figure><p>Execute the following command to submit the push to the remote database origin, specify the parameter -u item when executing the submission, and then omit the specified branch name. But when pushing to a blank remote database, you must specify the name of the remote database and branch, which must not be omitted. During the process, the system will/may ask for user name and password</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sh">$ git push -u origin master<br>$ git push origin HEAD:refs/for/master<br>$ git <span class="hljs-built_in">clone</span> &lt;repository&gt; &lt;directory&gt;<br></code></pre></td></tr></table></figure><ol type="1"><li>git push <遠端主機名稱> <本機分支名稱> : <遠端分支名稱><ol type="1"><li>例如 <code>git push origin master：refs/for/master</code><ol type="1"><li>是將本地的master分支推送到遠端主機origin上的對應master分支</li><li>origin 是遠端主機名，</li><li>第一個master是本地分支名，</li><li>第二個master是遠端分支名。</li></ol></li><li><code>git push origin master</code><ol type="1"><li>如果遠端分支被省略，如上則表示將本地分支推送到與之存在追蹤關係的遠端分支（通常兩者同名），如果該遠端分支不存在，則會被新建</li><li>（例如，如果只是git push origin HEAD，也就是沒有指定遠端分支，則會推送到與目前分支同名的遠端分支，如果遠端沒有這個同名分支，則在遠端程式庫建立一個和目前分支名稱一樣的遠端分支)</li></ol></li><li><code>git push origin HEAD:refs/for/master</code><ol type="1"><li>（注意這裡的orgin和HEAD沒什麼關係，比如說：git branch --set-upstream-to=origin/dev dev_local 這裡是origin/dev，中間有個/，意思就是遠端函式庫的dev分支）</li><li>git push 肯定是推送</li><li>origin : 是遠端的函式庫的名字</li><li>HEAD: 是一個特別的指針，它是一個指向你正在工作的本地分支的指針，可以把它當作本地分支的別名，git這樣就可以知道你工作在哪個分支</li><li>refs/for :意義在於我們提交程式碼到伺服器之後是需要經過 code review 之後才能進行merge的</li><li>refs/heads： 不需要</li></ol></li></ol></li></ol><h1 id="git-pull">git pull</h1><p>git pull - Fetch from and integrate with another repository or a local branch</p><p><a href="https://www.cnblogs.com/wangiqngpei557/p/6056624.html">聊下git pull --rebase</a></p><p>有一種場景是經常發生的。大家都基於develop拉出分支進行並行開發，這裡的分支可能是多到數十個。然後彼此在進行自己的邏輯編寫，時間可能需要幾天或幾週。在這段期間你可能需要時不時的需要pull下遠端develop分支上的同事的提交。這是個好的習慣，這樣下去就可以避免你在一個無用的程式碼上進行長期的開發，回頭來看這些程式碼不是新的程式碼。甚至是會面臨很多衝突需要解決，而這個時候你可能還需要對衝突的部分程式碼進行測試回歸，這就很麻煩了。</p><p>那我們來看看你在pull時候需要習慣性的加上—rebase參數，這樣可以避免很多問題。 --rebase的本意是想讓事情的發展看起來很連續和優美，而不是多出很多無用的merge commit。</p><p>因為程式碼都有一個前後依賴，只是這個依賴在開發的時候誰先誰後的問題。</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs sh">$ git pull --rebase<br>You are not currently on a branch.<br>Please specify <span class="hljs-built_in">which</span> branch you want to rebase against.<br>See git-pull(1) <span class="hljs-keyword">for</span> details.<br><br>    git pull &lt;remote&gt; &lt;branch&gt;<br><br>$ git branch<br>master<br>....<br><br>$ git checkout master<br>Updating files: 100% (43/43), <span class="hljs-keyword">done</span>.<br>Previous HEAD position was c1d75b7 Merge <span class="hljs-string">&quot;MPAS Benchmark System - added GFS support to scorecard&quot;</span><br>Switched to branch <span class="hljs-string">&#x27;master&#x27;</span><br>Your branch is up to <span class="hljs-built_in">date</span> with <span class="hljs-string">&#x27;origin/master&#x27;</span>.<br><br>$ git <span class="hljs-built_in">log</span><br>$ git pull --rebase<br></code></pre></td></tr></table></figure><h1 id="撤銷修改場景">撤銷修改場景</h1><p>撤銷修改場景 工作區文件修改了，但還沒進入版本管理，現在不想要了，如何回退、撤銷已有的修改</p><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs cmake"><span class="hljs-comment"># 建議使用restore指令</span><br>git restore &lt;<span class="hljs-keyword">file</span>&gt;<br><span class="hljs-comment"># revert all local change</span><br>git restore .<br><span class="hljs-comment"># Warning this will reset all of your unpushed commits to master!:</span><br>git reset<br><span class="hljs-comment"># To remove untracked files and untracked directories (e.g., new files, generated files):</span><br>git clean -fd<br></code></pre></td></tr></table></figure><h1 id="stash-暫存修改內容">stash 暫存修改內容</h1><p>有時候我們會遇到需臨時修改它分支的狀況，這邊的臨時代表正在開發的項目並不是它分支的內容，比如說 master 分支需做緊急修改，但我們目前正在跑 feature 分支的進度，這時你可能會將 feature 尚未提交成 commit 的修改內容複製到一個空白文件上，以確保修改內容不會不見，最後當 master 分支修改完成時，再將修改內容貼回到 feature 上，這確實也是個辦法，但其實不用這麼麻煩，Git 本身就有專門處理此情況的指令，名為 stash，可將當下分支的修改內容暫存起來，日後有需要再將它取出即可。</p><p>我們可使用以下指令將當前分支的修改給暫存下來：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs sh">暫存當前分支修改內容：<br>git stash<br>git status <span class="hljs-comment">#check: working tree clean</span><br><br>暫存當前分支修改內容 (包含未追蹤)：<br>git stash -u<br>git status <span class="hljs-comment">#check: working tree clean</span><br></code></pre></td></tr></table></figure><p>我們可使用以下指令查看所有暫存內容： <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">git stash list<br></code></pre></td></tr></table></figure></p><p>假設你已經完成臨時的任務，此時可使用以下指令<strong>取出暫存內容</strong>：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs sh">將最新暫存套用至當前分支，成功後銷毀暫存 (即 stash@&#123;0&#125;)：<br>git stash pop<br><br>將指定暫存套用至當前分支，成功後銷毀暫存：<br>git stash pop stash@&#123;1&#125;<br></code></pre></td></tr></table></figure><p>使用 pop 可以把某個 stash 拿出來並套用在目前的分支上，套用完成即銷毀這個暫存內容，如果你<strong>不想銷毀暫存內容</strong>，可改用以下指令：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs sh">將最新暫存套用至當前分支，成功後保留暫存：<br>git stash apply<br><br>將指定暫存套用至當前分支，成功後保留暫存：<br>git stash apply stash@&#123;1&#125;<br></code></pre></td></tr></table></figure><p>apply 只會將暫存做套用的動作，並不會銷毀暫存，如果你不想要某個暫存了，可使用以下指令：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs sh">刪除最新暫存 (即 stash@&#123;0&#125;)<br>git stash drop<br><br>刪除指定暫存：<br>git stash drop stash@&#123;1&#125;<br><br>刪除全部暫存：<br>git stash clear<br></code></pre></td></tr></table></figure><h1 id="合併本地多次提交記錄場景">合併本地多次提交記錄場景</h1><p>場景：有時開發某一個功能時會提交很多次commit，這樣會顯得版本日誌很亂，尤其是在多人協作的開發場景中。這時可以將多個緊密相關的commit合併成一個。</p><p>簡單情況：只是對最新一次的commit進行修正的話，可以使用</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">git commit -v --amend<br></code></pre></td></tr></table></figure><p>更複雜情況： <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs sh">git rebase -i HEAD~4 <span class="hljs-comment"># 合併最近4次提交記錄</span><br><span class="hljs-comment"># 進入vi編輯模式，依照提示對應commit選擇指令，常用的包括pick,edit,squash,fixup</span><br>s cacc52da add: qrcode<br>s f072ef48 update: indexeddb hack<br>s 4e84901a feat: add indexedDB floder<br>p 8f33126c feat: add test2.js<br></code></pre></td></tr></table></figure> 合併成功後，git log會發現四個版本資訊變成了一個。</p><p>如果異常退出vi編輯窗口，可以執行 <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sh">git rebase --edit-todo<br><span class="hljs-comment">#進入編輯視窗繼續編輯儲存</span><br>git rebase --<span class="hljs-built_in">continue</span><br></code></pre></td></tr></table></figure></p><p>不要合併已經提交遠端分支的記錄，否則會報錯 <figure class="highlight console"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs console">error: cannot &#x27;squash&#x27; without a previous commit<br></code></pre></td></tr></table></figure></p><h1 id="拉取主分支最新版本到個人開發分支場景">拉取主分支最新版本到個人開發分支場景</h1><p>這在團隊開發中很常見，主分支頻繁更新，個人開發特性分支相比主分支會落後，需要及時更新master主分支最新變動</p><ul><li>方法一：使用git merge master合併主分支最新變動，但git日誌裡會出現merge資訊。</li><li>方法二：如果希望保持乾淨的commit，使用git rebase。</li></ul><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs sh">git rebase master<br><span class="hljs-comment"># 如果出現衝突，需要解決衝突，然後git add</span><br>git add something<br>git rebase --<span class="hljs-built_in">continue</span><br><br><span class="hljs-comment"># 後悔選項，終止rebase操作</span><br>git rebase --abort<br></code></pre></td></tr></table></figure><h1 id="版本回滾場景">版本回滾場景</h1><p>理解GIT三種模式：工作區、暫存區、版本庫</p><ul><li>場景1：工作目錄程式碼檔案修改完，但還未 <code>git add</code> 納入了暫存區<ul><li>使用 <code>git checkout .</code> 使用暫存區文件覆蓋工作區文件</li></ul></li><li>場景2：已經執行 <code>git add</code> 納入暫存區，但還沒提交commit到版本庫。<ul><li><code>git reset</code> #先用HEAD指標覆蓋目前的暫存區內容</li><li><code>git checkout .</code> #再用暫存區內容覆蓋工作區內容</li><li><code>git reset --hard</code> #直接使用HEAD覆蓋目前暫存區和工作區</li></ul></li><li>場景3：已經 commit 提交到本地版本記錄中，但還沒有推送到 git push 遠端倉庫.<ul><li><code>git reset --hard &lt;last_commit_id&gt;</code> #覆蓋本機版本庫、暫存區和工作區</li></ul></li><li>場景4：已經 <code>git push</code> 推送到遠端倉庫<ul><li><code>git reset --hard &lt;commit_id&gt;</code></li><li><code>git push origin &lt;remote_branch&gt; --forc</code>e</li></ul></li></ul><h1 id="誤在主分支開發場景">誤在主分支開發場景</h1><p>專案規定develop分支為開發主分支，成員不能直接在該分支上修改提交，必須建立類似feature/xxx特性分支進行開發。但有時候拉取版本後忘了創建特性分支，直接在develop分支修改。此時如何處理？</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># 暫存develop分支修改內容</span><br>git stash<br><span class="hljs-comment"># 然後建立特性分支</span><br>git checkout -b new_branch <span class="hljs-comment"># # 同時建立且切換分支</span><br><span class="hljs-comment"># 將暫存修改放到新分支中</span><br>git stash pop<br><span class="hljs-comment"># 此時可以正常使用git add繼續開發</span><br></code></pre></td></tr></table></figure><h1 id="比對檔案與版本差異">比對檔案與版本差異</h1><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs sh">git diff <span class="hljs-comment">#在什麼參數都不加的使用情況，比對的是「工作目錄」與「索引」(index)之間的差異</span><br>git diff commit1 commit2 <span class="hljs-comment">#比對兩個版本間的差異</span><br>git diff HEAD <span class="hljs-comment"># 最常用的指令，因為這代表你要拿「工作目錄」與「當前分支的最新版」進行比對</span><br>git diff --cached HEAD <span class="hljs-comment"># 最常用的指令(索引(index)狀態)，這個語法代表的是「當前的索引狀態」與「當前分支的最新版」進行比對。</span><br><br>git diff =&gt; 工作目錄 vs 索引(index)<br>git diff HEAD =&gt; 工作目錄 vs HEAD<br>git diff --cached HEAD =&gt; 索引(index) vs HEAD<br>git diff --cached =&gt; 索引 vs HEAD<br>git diff HEAD^ HEAD =&gt; HEAD^ vs HEAD<br></code></pre></td></tr></table></figure><h1 id="git-merge">git merge</h1><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># 先切換到主分支</span><br>$ git checkout master<br> <br><span class="hljs-comment"># 使用 fast-forward</span><br>$ git merge &lt;branch&gt; <br><br>or <br><span class="hljs-comment"># 使用 no-fast-forward</span><br>$ git merge &lt;branch&gt; --no-ff <br></code></pre></td></tr></table></figure><h1 id="git-rebase">git rebase</h1><p>Rebase 是 “Re-” 與 “Base” 的複合字，這裡的 “Base” 代表「基礎版本」的意思，表示你想要重新修改特定分支的「基礎版本」，把另外一個分支的變更，當成我這個分支的基礎。</p><p>功能一：合併版本 <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># 切換至 branch1 分支：</span><br>git checkout branch1<br> <br><span class="hljs-comment"># 然後執行 Rebase 動作，把 master 當成我們的基礎版本： </span><br>git rebase master<br></code></pre></td></tr></table></figure></p><p>功能二：修改歷史 commit 紀錄 <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh">除上述功能外，rebase 還能用來修改特定分支線上任何一個版本的版本資訊<br>git rebase -i HEAD~3<br></code></pre></td></tr></table></figure></p><ul><li>請非常小心使用，因為 rebase 會改變歷史紀錄</li></ul><h1 id="updates-were-rejected">Updates were rejected</h1><figure class="highlight console"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs console">To github.com:waipangsze/waipangsze.github.io.git<br> ! [rejected]            hexo -&gt; hexo (non-fast-forward)<br>error: failed to push some refs to &#x27;git@github.com:waipangsze/waipangsze.github.io.git&#x27;<br>hint: Updates were rejected because the tip of your current branch is behind<br>hint: its remote counterpart. Integrate the remote changes (e.g.<br>hint: &#x27;git pull ...&#x27;) before pushing again.<br>hint: See the &#x27;Note about fast-forwards&#x27; in &#x27;git push --help&#x27; for details.<br></code></pre></td></tr></table></figure><p>這是因為遠端 repository 和我本地的 repository 衝突導致的; 但是卻沒有pull到本地。這樣就產生了版本衝突的問題。</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs sh">1. 使用强制push的方法<br>git push -u origin master -f<br>这样会使远程修改丢失&amp;#xff0c;一般是不可取的&amp;#xff0c;尤其是多人协作开发的时候。<br><br>2. push前先将远程repository修改pull下来<br>git pull origin master<br>git push -u origin master<br></code></pre></td></tr></table></figure><h1 id="conflicts">Conflicts</h1><p>Between your last push and the next push, if someone else pushes to update the remote database but you do not update your local database, your push will be rejected. At this time, you need to perform a merge operation to import other people's modification history,otherwise the push will be rejected.</p><h2 id="resolve-conflict">Resolve conflict</h2><blockquote><p>The upper part separated by == is the editing content of the local database, and the lower part is the editing content of the remote database. After modifying all conflicting places, performing a commit will submit the commit content of the conflicting merge message.</p></blockquote><h1 id="git-addcommitpush">git add/commit/push</h1><p>When the remote github repo is known, You can git clone the remote address first Then copy the project file to be submitted to the clone folder</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># Add all files, such as submitting only some files requires a single git add file name</span><br>git add. <br>git commit -m <span class="hljs-string">&quot;remarks for submission&quot;</span><br><span class="hljs-comment"># Make some changes</span><br>git commit --amend<br><br><span class="hljs-comment"># Force push can overwrite master</span><br>git push -u -f origin master<br></code></pre></td></tr></table></figure><p>If you git <strong>commit --amend</strong> here, then error "Your branch and 'origin/master' have diverged" will reject your git push. The process here is,</p><ol type="1"><li>git clone github repo (latest one with commit ID A)</li><li>you make something changes</li><li>$ git commit --amend -m "remarks for submission"</li><li>The above commit with amend will create a New commit ID and rewrite the original commit ID A. Therefore, it can not reconignate two commit ID's and tell your branch and remote 'origin/master' have diverged.</li></ol><p>The solution is, <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sh">git rebase origin/master <span class="hljs-comment"># git rebase origin main</span><br><span class="hljs-comment"># or</span><br>git merge origin/master <span class="hljs-comment"># git merge origin main</span><br></code></pre></td></tr></table></figure> <a href="https://poanchen.github.io/blog/2020/09/19/what-to-do-when-git-branch-has-diverged">WHAT TO DO WHEN GIT BRANCH HAS DIVERGED?</a></p><h1 id="common-error">Common Error</h1><h2 id="rejected-master---master-non-fast-forward">[rejected] master -&gt; master (non-fast-forward)</h2><blockquote><p>! [rejected] master -&gt; master (non-fast-forward) error: failed to push some refs to ’’ To prevent you from losing history, non-fast-forward updates were rejected Merge the remote changes (e.g. 'git pull') before pushing again. See the 'Note about fast-forwards' section of 'git push --help' for details.</p></blockquote><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs sh">$ git pull origin master<br><br><span class="hljs-comment"># * branch master -&gt; FETCH_HEAD</span><br><span class="hljs-comment"># CONFLICT (content): Merge conflict in file</span><br><span class="hljs-comment"># Automatic merge failed; fix conflicts and then commit the result.</span><br><span class="hljs-comment"># A warning message will appear warning about conflicts during the merge.</span><br></code></pre></td></tr></table></figure><p>The conficts like, &gt; &lt;&lt;&lt;&lt;&lt;&lt;&lt; HEAD &gt; commit records the state of the index &gt; ======= &gt; pull Get the content of the remote database &gt; &gt;&gt;&gt;&gt;&gt;&gt;&gt; 4c0182374230cd6eaa93b30049ef2386264fe12a</p><p>Modify the conflicting places, import the modifications of both parties, and delete the redundant marked lines.</p><blockquote><p>commit records the state of the index pull Get the content of the remote database</p></blockquote><p>When the content is modified and the file conflict is resolved, a commit is required. <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh">$ git add sample.txt<br>$ git commit -m <span class="hljs-string">&quot;merge&quot;</span><br></code></pre></td></tr></table></figure></p><h1 id="gitignore-file-itself-is-not-being-ignored">.gitignore file itself is not being ignored</h1><p>This means that .gitignore is a tracked file.... so you changed it, so it shows up as changed. This would be the expected result... and it makes sense. Do you want to ignore .gitignore? This is not quite a good idea because by tracking it, everyone gets to ignore the same things in the project. Now, if you would like to be the only person in the project to be ignoring the files that you started the question from, you might have to consider adding that to <strong>.git/info/exclude</strong> so that it's only on you and no one else.</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs sh"> $ <span class="hljs-built_in">cat</span> .git/info/exclude<br><span class="hljs-comment"># git ls-files --others --exclude-from=.git/info/exclude</span><br><span class="hljs-comment"># Lines that start with &#x27;#&#x27; are comments.</span><br><span class="hljs-comment"># For a project mostly in C, the following would be a good set of</span><br><span class="hljs-comment"># exclude patterns (uncomment them if you want to use them):</span><br><span class="hljs-comment"># *.[oa]</span><br><span class="hljs-comment"># *~</span><br></code></pre></td></tr></table></figure><h1 id="持續整合continuous-integration-ci系統">持續整合（Continuous integration CI）系統</h1><p>當開發人員將本機Git倉庫中的程式碼更新後，執行commit和push操作；該動作會產生一個事件，並觸發Jenkins進行建置。如果開發人員在程式碼中加入和Junit或testng測試案例，也會在建置過程中執行；建置完成後，jenkins會將建置的結果以Gerrit投票的方式傳到Gerrit伺服器上。專案Owner登入Gerrit Web UI，進行Code Review時會看到Jenkins建置的結果並進行code review。只有當建置成功，且code review通過時，專案owner才會將程式碼合到主分支上，如果說jenkins上建置失敗，則表示程式碼肯定有問題，Owner不用Code Review，直接通知開發檢查程式碼並重新提交。</p><p>近年來，由於開源專案、社群的活躍熱度大增，進而引來持續整合（CI）系統的誕生，也越發的聽到更多的人在說協同開發、敏捷開發、迭代開發、持續整合和單元測試這些拉風的術語。然而，大都是僅僅聽到在說而已，國內也很少有公司能有完整的 CI 體系流程。反之一些開源專案都有完整的 CI體系，例如openstack。為了實現程式碼託管-&gt;程式碼審核-&gt;程式碼發佈的一套自動化流程，我特意在IDC伺服器上部署了<code>Gitlab+Gerrit+Jenkins</code>對接環境，</p><p><img src="https://i.imgur.com/Lsz18A6.png" width="600" /></p><ol type="1"><li><code>Gitlab</code>上進行程式碼託管 在gitlab上建立的專案設定成Private，一般使用者對這個專案就只有pull權限，不能直接進行push，Git自帶code review功能。<ul><li>強制Review ：在Gitlab 上建立的項目，指定相關使用者只有Reporter權限，這樣使用者沒有權限使用git push功能，只能git review到Gerrit 系統上，Jenkins在監聽Gerrit上的項目事件會觸發建置任務來測試程式碼， Jenkins 把測試結果透過ssh gerrit 給這個專案打上Verified （資訊校驗）成功或失敗標記，成功通知其它人員Review（程式碼審核） 。</li><li>Gitlab保護Master 分支：在Gitlab 上創建的專案可以把Master 分支保護起來，普通用戶可以自己創建分支並提交代碼到自己的分支上，沒有權限直接提交到Master分支，用戶最後提交申請把自己的分支Merge到Master ，管理員收到Merge 請求後， Review 後選擇是否合併。</li><li>可以將gitlab和gerrit部署在兩台機器上，這樣gitlab既可以託管gerrit程式碼，也可以作為gerrit的備份。</li><li>因為gitlab和gerrit做了同步，gerrit上的程式碼會同步到gitlab。這樣即使gerrit部署機故障，它裡面的程式碼也不會遺失，可以去gitlab上拿。</li></ul></li><li><code>Gerrit</code>審核代碼<ul><li>Gerrit是一款被Android開源專案廣泛採用的code review(程式碼審核)系統。普通用戶將gitlab裡的專案clone到本地，修改程式碼後，雖不能直接push到程式碼中心 ，但是可以透過git review提交到gerrit上進行審核。 gerrit相關審核員看到review資訊後，判斷是否通過，透過即commit提交。然後，gerrit程式碼會和gitlab完成同步。</li><li>grrit的精髓在於不允許直接將本地修改同步到遠端倉庫。客戶機必須先push到遠端倉庫的refs/for/*分支上，等待審核。</li><li>gerrit上也可以比較程式碼審核提交前後的內容狀態。</li></ul></li><li><code>jenkins</code>代碼發布<ul><li>當使用者git review後，程式碼透過jenkins自動測試（verified）、人工review 後，程式碼只是merge到了Gerrit的專案中，並沒有merge到Gitlab的專案中，所以需要當Gerrit 專案倉庫有變更時自動同步到Gitlab的項目倉庫中。 Gerrit 自備一個 Replication 功能，同時我們在安裝 Gerrit 時候預設安裝了這個 Plugin，透過新增replication.config 給 Gerrit</li></ul></li></ol><h1 id="references">References</h1><ol type="1"><li><a href="https://mp.weixin.qq.com/s/YhTDnBKXC1ENbu8i6-1pJw">日常开发场景Git使用技巧记录</a></li><li><a href="https://mp.weixin.qq.com/s?__biz=MzkxNTM4ODc4Ng==&amp;mid=2247485667&amp;idx=1&amp;sn=898316a92cbc30b0aa216d1d464d8949&amp;chksm=c15ea8fef62921e8ea69a5fbeceedea1ed43fa87a79b8f2cd2860c475617fe05d8ca99d50804&amp;cur_album_id=3026951976829517826&amp;scene=189#wechat_redirect">Git commit提交信息规范</a></li><li><a href="https://awdr74100.github.io/2020-05-06-git-stash/">Git 版本控制系統 - stash 暫存修改內容</a></li><li><a href="https://www.maxlist.xyz/2020/05/02/git-merge-rebase/">【Git教學】分支合併: merge 與 rebase 差異</a></li></ol>]]></content>
    
    
    <categories>
      
      <category>Git</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Github</tag>
      
      <tag>git</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>WRF | WRF/WPS Geographical Static Data</title>
    <link href="/2023/04/27/WRF_geographical_static_Data/"/>
    <url>/2023/04/27/WRF_geographical_static_Data/</url>
    
    <content type="html"><![CDATA[<h1 id="wrf-geographical-static-data">WRF geographical static Data</h1><ul><li><a href="https://www2.mmm.ucar.edu/wrf/users/download/get_sources_wps_geog.html">WPS V4 Geographical Static Data Downloads Page</a></li></ul><p>These are all the mandatory fields required to run WPS and WRF.</p><p>All are under:</p><ul><li><a href="https://www2.mmm.ucar.edu/wrf/src/wps_files/" class="uri">https://www2.mmm.ucar.edu/wrf/src/wps_files/</a></li></ul><p>Download links:</p><ul><li><a href="http://www2.mmm.ucar.edu/wrf/src/wps_files/geog_complete.tar.bz2" class="uri">http://www2.mmm.ucar.edu/wrf/src/wps_files/geog_complete.tar.bz2</a><ul><li>This is a large compressed file (≈ 2.3 GB)</li><li>This file will expand to about 50GB in size.</li><li>bunzip2 geog complete.tar.bz2</li><li>tar -xf geog complete.tar</li></ul></li><li><a href="https://www2.mmm.ucar.edu/wrf/users/download/get_sources_wps_geog.html" class="uri">https://www2.mmm.ucar.edu/wrf/users/download/get_sources_wps_geog.html</a><ul><li>Highest Resolution of each Mandatory Field (*Note: ~29G Uncompressed (2.6G Compressed))</li><li>WPS Geographical Input Data Mandatory for Specific Applications</li><li>Optional WPS Geographical Input Data</li></ul></li></ul><p>For the WPS geographical input data download sets that correspond to <strong>Version 3</strong> of the WPS/WRF code.</p><ul><li><a href="https://www2.mmm.ucar.edu/wrf/users/download/get_sources_wps_geog_V3.html" class="uri">https://www2.mmm.ucar.edu/wrf/users/download/get_sources_wps_geog_V3.html</a></li></ul><h2 id="landuse">Landuse</h2><p><a href="https://forum.mmm.ucar.edu/threads/references-for-geogrid-static-data.168/">References for geogrid static data</a></p><p>The Noah LSM page identifies the sources of data that they use. We believe, with high probability, that we are using the same. The topography data is definitely the USGS GTOPO30, the soil category data is probably the hybrid STATSGO/FAO, and the land-cover data is probably the USGS GLCC v2 land-use/land-cover data. For future reference, here is a link to the Noah page: <a href="http://www.ral.ucar.edu/research/land/technology/lsm.php">Land Atmosphere Interactions | Research Applications Laboratory</a></p><p>The 30-arc-second MODIS land use datasets (both with and without lakes) are probably derived from the "Modified IGBP MODIS" data in the Noah link.</p><p>To the best of our knowledge, all of the land cover data in the 'landuse_*' directories are the USGS GLCC data from 1992-1993. The coarser resolutions are derived from the 30-arc-second data.</p><p>The data in the 'modis_landuse_20class_15s' directory is based on:</p><ul><li><ol type="1"><li>Broxton, P. D., Zeng, X., Sulla-Menashe, D., &amp; Troch, P. A. (2014). A</li></ol></li></ul><p>global land cover climatology using MODIS data. Journal of Applied Meteorology and Climatology, 53(6), 1593-1605. DOI: 10.1175/JAMC-D-13-0270.1 and</p><ul><li><ol start="2" type="1"><li>ftp://ftp.emc.ncep.noaa.gov/mmb/gcp/ldas/noahlsm/README</li></ol></li></ul><p>The data in the 'modis_landuse_20class_30s' directory were provided by NCEP and include the addition of a tundra class; these data were most likely collected in 2001.</p><p>The data in the 'modis_landuse_20class_30s_with_lakes' directory are the same as in the 'modis_landuse_20class_30s' directory, but have an inland water body category that was added by NCAR.</p><p>The data in the 'modis_landuse_21class_30s' data were modified by Boston University, most likely based on data collected in 2004.</p><h3 id="in-summary">In summary:</h3><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">landuse_30s</span> - USGS GLCC, <span class="hljs-number">1992</span>-<span class="hljs-number">1993</span><br><span class="hljs-attribute">landuse_30s_with_lakes</span> - USGS GLCC, <span class="hljs-number">1992</span>-<span class="hljs-number">1993</span>, lakes added by NCAR<br><span class="hljs-attribute">landuse_2m</span> - USGS GLCC, <span class="hljs-number">1992</span>-<span class="hljs-number">1993</span>, coarsened from <span class="hljs-number">30</span>s<br><span class="hljs-attribute">landuse_5m</span> - USGS GLCC, <span class="hljs-number">1992</span>-<span class="hljs-number">1993</span>, coarsened from <span class="hljs-number">30</span>s<br><span class="hljs-attribute">landuse_10m</span> - USGS GLCC, <span class="hljs-number">1992</span>-<span class="hljs-number">1993</span>, coarsened from <span class="hljs-number">30</span>s<br><br><span class="hljs-attribute">modis_landuse_20class_15s</span> - MODIS, See reference<br><span class="hljs-attribute">modis_landuse_20class_30s</span> - MODIS, NCEP included tundra class, <span class="hljs-number">2001</span><br><span class="hljs-attribute">modis_landuse_20class_30s_with_lakes</span> - MODIS, NCEP included tundra class, <span class="hljs-number">2001</span>, lakes added by NCAR<br><span class="hljs-attribute">modis_landuse_21class_30s</span> - MODIS, modified by BU, <span class="hljs-number">2004</span><br></code></pre></td></tr></table></figure><h1 id="interpolation-options-for-different-resolution">Interpolation options for different resolution</h1><ol type="1"><li>Is there an algorithm in geogrid/src that compares the original binary data resolution to the model resolution to apply the interpolation option differently?</li></ol><ul><li>No, I don't think so. The interpolation option is always dependent on that specified in GEOGRID.TBL</li></ul><ol start="2" type="1"><li>If not, is there an algorithm that applies appropriate interpolation options when receiving categorical or continuous variables?</li></ol><ul><li>For both categorical and continuous variables, the interpolation is conducted based on the option given in GEOGRID.TBL.</li></ul><h1 id="references">References</h1><ol type="1"><li><a href="https://www2.mmm.ucar.edu/wrf/users/tutorial/presentation_pdfs/202101/duda_wps_advanced.pdf">Advanced Usage of the WRF Preprocessing System</a></li></ol>]]></content>
    
    
    <categories>
      
      <category>WRF</category>
      
    </categories>
    
    
    <tags>
      
      <tag>WRF</tag>
      
      <tag>WPS</tag>
      
      <tag>geodata</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Git rebase -i </title>
    <link href="/2023/04/26/Git-rebase-i/"/>
    <url>/2023/04/26/Git-rebase-i/</url>
    
    <content type="html"><![CDATA[<h1 id="use-rebase--i-to-merge-commits">Use rebase -i to merge commits</h1><blockquote><p>Ref: https://backlog.com/git-tutorial/tw/stepup/stepup7_5.html</p></blockquote><p>To merge past commits, use the rebase -i command</p><blockquote><p>$ git rebase -i HEAD~~</p></blockquote><p>The default text editor will open automatically, and you will see commits from HEAD to HEAD~~</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs sh">pick 9a54fd4 add commit instructions<br>pick 0d4a808 Add instructions <span class="hljs-keyword">for</span> pull<br><br><span class="hljs-comment"># Rebase 326fc9f..0d4a808 onto d286baa</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment"># Commands:</span><br><span class="hljs-comment">#  p, pick = use commit</span><br><span class="hljs-comment">#  r, reword = use commit, but edit the commit message</span><br><span class="hljs-comment">#  e, edit = use commit, but stop for amending</span><br><span class="hljs-comment">#  s, squash = use commit, but meld into previous commit</span><br><span class="hljs-comment">#  f, fixup = like &quot;squash&quot;, but discard this commit&#x27;s log message</span><br><span class="hljs-comment">#  x, exec = run command (the rest of the line) using shell</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment"># If you remove a line here THAT COMMIT WILL BE LOST.</span><br><span class="hljs-comment"># However, if you remove everything, the rebase will be aborted.</span><br><span class="hljs-comment">#</span><br></code></pre></td></tr></table></figure><p>Change the "pick" in the <strong>second line to "squash", save and exit</strong>. Since you need to submit after merging, the editor will remind you to edit the latest submission message, please save and exit after editing the message. In this way, the two commits are merged into one commit. Please check the history with the log command.</p><h1 id="amend-commits-with-rebase--i">Amend commits with rebase -i</h1><blockquote><p>Ref: https://backlog.com/git-tutorial/tw/stepup/stepup7_6.html</p></blockquote><p>Use the rebase -i command to select the commits to amend</p><blockquote><p>$ git rebase -i HEAD~~</p><p>The default text editor will open commits from HEAD to HEAD~~</p></blockquote><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs sh">pick 9a54fd4 add commit instructions<br>pick 0d4a808 Add instructions <span class="hljs-keyword">for</span> pull<br><br><span class="hljs-comment"># Rebase 326fc9f..0d4a808 onto d286baa</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment"># Commands:</span><br><span class="hljs-comment">#  p, pick = use commit</span><br><span class="hljs-comment">#  r, reword = use commit, but edit the commit message</span><br><span class="hljs-comment">#  e, edit = use commit, but stop for amending</span><br><span class="hljs-comment">#  s, squash = use commit, but meld into previous commit</span><br><span class="hljs-comment">#  f, fixup = like &quot;squash&quot;, but discard this commit&#x27;s log message</span><br><span class="hljs-comment">#  x, exec = run command (the rest of the line) using shell</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment"># If you remove a line here THAT COMMIT WILL BE LOST.</span><br><span class="hljs-comment"># However, if you remove everything, the rebase will be aborted.</span><br><span class="hljs-comment">#</span><br></code></pre></td></tr></table></figure><p><strong>Change the text of "pick" in the first line to "edit"</strong>, save and exit. Then, the following content will be displayed, and the commit to be modified will be checked out.</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs sh">Stopped at d286baa... add commit<br>You can amend the commit now, with<br><br>        git commit --amend<br><br>Once you are satisfied with your changes, run<br><br>        git rebase --<span class="hljs-built_in">continue</span><br></code></pre></td></tr></table></figure><p>open sample.txt ，make changes.</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh">$ git add sample.txt<br>$ git commit --amend<br></code></pre></td></tr></table></figure><p>You now need to execute "git rebase --continue" to complete the rebase.</p><blockquote><p>$ git rebase --continue</p></blockquote>]]></content>
    
    
    <categories>
      
      <category>Git</category>
      
    </categories>
    
    
    <tags>
      
      <tag>git rebase</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>GNU GCC</title>
    <link href="/2023/04/25/GNU/"/>
    <url>/2023/04/25/GNU/</url>
    
    <content type="html"><![CDATA[<p>GNU<sup id="fnref:1" class="footnote-ref"><a href="#fn:1" rel="footnote"><span class="hint--top hint--rounded" data-aria-label="[GNU](https://www.gnu.org/)">[1]</span></a></sup> <sup id="fnref:2" class="footnote-ref"><a href="#fn:2" rel="footnote"><span class="hint--top hint--rounded" data-aria-label="[List of GNU packages](https://en.wikipedia.org/wiki/List_of_GNU_packages)">[2]</span></a></sup> is an operating system that is free software—that is, it respects users' freedom. The GNU operating system consists of GNU packages (programs specifically released by the GNU Project) as well as free software released by third parties. The development of GNU made it possible to use a computer without software that would trample your freedom.</p><h2 id="gnu-compiler-collection-gcc">GNU Compiler Collection (GCC)</h2><p>As of May 2021, the recent 11.1 release of GCC includes front ends for C (gcc), C++ (g++), Objective-C, Fortran (gfortran), Ada (GNAT), Go (gccgo) and D (gdc, since 9.1) programming languages, with the OpenMP and OpenACC parallel language extensions being supported since GCC 5.1. Versions prior to GCC 7 also supported Java (gcj), allowing compilation of Java to native machine code. Modula-2 support, previously offered by third parties, will be merged into GCC 13. Regarding language version support for C++ and C, since GCC 11.1 the default target is gnu++17, a superset of C++17, and gnu11, a superset of C11, with strict standard support also available. GCC also provides experimental support for C++20 and upcoming C++23. <sup id="fnref:3" class="footnote-ref"><a href="#fn:3" rel="footnote"><span class="hint--top hint--rounded" data-aria-label="[GCC GNU Compiler Collection](https://en.wikipedia.org/wiki/GNU_Compiler_Collection)">[3]</span></a></sup></p><h2 id="installation">Installation</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-meta">#!/bin/bash</span><br><span class="hljs-comment">############################## Directory Listing ############################</span><br><span class="hljs-built_in">export</span> HOME=`<span class="hljs-built_in">pwd</span>`<br><span class="hljs-built_in">export</span> download_DIR=<span class="hljs-variable">$HOME</span>/download_DIR/<br><span class="hljs-built_in">export</span> libs_DIR=<span class="hljs-variable">$HOME</span>/Library/<br><br><span class="hljs-built_in">echo</span> <span class="hljs-variable">$HOME</span><br><span class="hljs-built_in">echo</span> <span class="hljs-variable">$download_DIR</span><br><span class="hljs-built_in">echo</span> <span class="hljs-variable">$libs_DIR</span><br><br><span class="hljs-built_in">mkdir</span> -p download_DIR<br><span class="hljs-built_in">mkdir</span> -p Library<br><br><span class="hljs-comment">############################## GCC ############################</span><br><span class="hljs-built_in">cd</span> <span class="hljs-variable">$download_DIR</span><br><br>gcc_version=<span class="hljs-string">&quot;12.2.0&quot;</span> <span class="hljs-comment"># 4.8.5/8.3.0/9.3.0/10.3.0/12.2.0</span><br><br>wget -c --no-check-certificate https://ftp.gnu.org/gnu/gcc/gcc-<span class="hljs-variable">$&#123;gcc_version&#125;</span>/gcc-<span class="hljs-variable">$&#123;gcc_version&#125;</span>.tar.gz<br>tar -xvf gcc-<span class="hljs-variable">$&#123;gcc_version&#125;</span>.tar.gz<br><span class="hljs-built_in">cd</span> gcc-<span class="hljs-variable">$&#123;gcc_version&#125;</span><br><br>./contrib/download_prerequisites<br>./configure --prefix=<span class="hljs-variable">$libs_DIR</span>/gcc-v<span class="hljs-variable">$&#123;gcc_version&#125;</span> --enable-languages=c,c++,fortran --disable-multilib<br><br>make<br>make -j &amp;&amp; make install<br>gcc --version<br><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;===================&quot;</span><br><span class="hljs-built_in">export</span> PATH=<span class="hljs-variable">$PATH</span>:/<span class="hljs-variable">$libs_DIR</span>/gcc-v<span class="hljs-variable">$&#123;gcc_version&#125;</span>/bin<br>gcc --version<br><br></code></pre></td></tr></table></figure><h2 id="bug-and-error">Bug and Error</h2><blockquote><p>Bug: configure: error: Building GCC requires GMP 4.2+, MPFR 3.1.0+ and MPC 0.8.0+.??? <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># Inside the gcc directory, do this command:</span><br>./contrib/download_prerequisites<br><span class="hljs-comment"># After that script, GMP, MPFR, and MPC will be ready to use. Continue with ./configure.</span><br></code></pre></td></tr></table></figure></p></blockquote><section class="footnotes"><div class="footnote-list"><ol><li><span id="fn:1" class="footnote-text"><span><a href="https://www.gnu.org/">GNU</a> <a href="#fnref:1" rev="footnote" class="footnote-backref"> ↩</a></span></span></li><li><span id="fn:2" class="footnote-text"><span><a href="https://en.wikipedia.org/wiki/List_of_GNU_packages">List of GNU packages</a> <a href="#fnref:2" rev="footnote" class="footnote-backref"> ↩</a></span></span></li><li><span id="fn:3" class="footnote-text"><span><a href="https://en.wikipedia.org/wiki/GNU_Compiler_Collection">GCC GNU Compiler Collection</a> <a href="#fnref:3" rev="footnote" class="footnote-backref"> ↩</a></span></span></li></ol></div></section>]]></content>
    
    
    <categories>
      
      <category>Linux</category>
      
    </categories>
    
    
    <tags>
      
      <tag>HPC</tag>
      
      <tag>NWP</tag>
      
      <tag>gnu</tag>
      
      <tag>gcc</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>WRF | WRF installation on a Linux-based machine</title>
    <link href="/2023/04/25/WRF_installation_on_a_Linux_based_machine/"/>
    <url>/2023/04/25/WRF_installation_on_a_Linux_based_machine/</url>
    
    <content type="html"><![CDATA[<h1 id="wrf">WRF</h1><ul><li>Version 1.0: WRF was first released December 2000</li><li>Version 2.0: May 2004</li><li>Version 3.0: April 2008</li><li>Version 4.0: June 2018 (add hybrid vertical coordinate)</li><li>Version 4.1: April 2019</li><li>Version 4.2: April 2020</li><li>Version 4.3: May 2021</li><li>Version 4.4: April 2022</li><li>Version 4.5: April 2023<ul><li>4.5.1: July 2023</li><li>4.5.2: December 2023</li></ul></li><li>Version 4.6: May 2024</li></ul><h1 id="wrf-installation-on-a-linux-based-machine">WRF installation on a Linux-based machine</h1><p>Weather Research &amp; Forecasting Model (WRF) is a state of the art mesoscale numerical weather prediction system designed for both atmospheric research and operational forecasting applications <sup id="fnref:1" class="footnote-ref"><a href="#fn:1" rel="footnote"><span class="hint--top hint--rounded" data-aria-label="[WRF](https://www.mmm.ucar.edu/models/wrf)">[1]</span></a></sup>.</p><p>The installation steps are,</p><ol type="1"><li>Source gcc compiler</li><li>Test gcc compiler</li><li>Install all requried libraries</li><li>Test libraries</li><li>Install WRF</li><li>Install WPS</li></ol><p>Three shell scripts are under the same directory,</p><blockquote><p>gcc_env.sh wrf_env.sh wrf_env_install.sh wrf_wps_install.sh</p></blockquote><h2 id="gcc-version-gcc_env.sh">GCC version (gcc_env.sh)</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-meta">#!/bin/bash</span><br><br><span class="hljs-built_in">export</span> gcc_libs_DIR=/home/wpsze/gcc/<br><span class="hljs-built_in">export</span> LD_LIBRARY_PATH=<span class="hljs-variable">$gcc_libs_DIR</span>/lib:<span class="hljs-variable">$LD_LIBRARY_PATH</span><br><span class="hljs-built_in">export</span> PATH=<span class="hljs-variable">$gcc_libs_DIR</span>/bin:<span class="hljs-variable">$PATH</span><br><br><span class="hljs-built_in">export</span> gcc_version=<span class="hljs-string">&quot;gcc-v4.8.5&quot;</span> <span class="hljs-comment"># 4.8.5/8.3.0/9.3.0/10.3.0/12.2.0</span><br><br><span class="hljs-built_in">export</span> PATH=<span class="hljs-variable">$gcc_libs_DIR</span>/<span class="hljs-variable">$&#123;gcc_version&#125;</span>/bin:<span class="hljs-variable">$PATH</span><br><span class="hljs-built_in">export</span> LD_LIBRARY_PATH=<span class="hljs-variable">$gcc_libs_DIR</span>/<span class="hljs-variable">$&#123;gcc_version&#125;</span>/lib:<span class="hljs-variable">$LD_LIBRARY_PATH</span><br><span class="hljs-built_in">export</span> LD_LIBRARY_PATH=<span class="hljs-variable">$gcc_libs_DIR</span>/<span class="hljs-variable">$&#123;gcc_version&#125;</span>/lib64:<span class="hljs-variable">$LD_LIBRARY_PATH</span><br><br>gcc --version<br>gfortran --version<br></code></pre></td></tr></table></figure><h3 id="testing-system-compatibility">Testing System Compatibility</h3><p>We have to test the compiler system in your computer/clsuter. #### Download test tar files,</p><blockquote><p>http://www2.mmm.ucar.edu/wrf/OnLineTutorial/compile_tutorial/tar_files/Fortran_C_tests.tar</p></blockquote><h4 id="run_gcc_test.sh">run_gcc_test.sh</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-meta">#!/bin/bash</span><br><span class="hljs-built_in">source</span> gcc_env.sh<br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;==========================================================================================&quot;</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot; All tests are from http://www2.mmm.ucar.edu/wrf/OnLineTutorial/compile_tutorial/tar_files/Fortran_C_tests.tar &quot;</span><br>gfortran --version<br>gcc --version<br>cpp --version<br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;==========================================================================================&quot;</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;=============================== Fortran_C_tests.tar  =====================================&quot;</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;==========================================================================================&quot;</span><br><span class="hljs-comment"># Unpack the test files by entering the following input into the terminal:</span><br><span class="hljs-comment"># tar -xf Fortran_C_tests.tar</span><br><br><span class="hljs-comment"># TEST #1: FIXED FORMAT FORTRAN TEST</span><br>gfortran TEST_1_fortran_only_fixed.f<br>./a.out<br><span class="hljs-comment"># SUCCESS test 1 fortran only fixed format</span><br><br><span class="hljs-comment"># TEST #2: FREE FORMAT FORTRAN TEST</span><br>gfortran TEST_2_fortran_only_free.f90<br>./a.out<br><span class="hljs-comment"># Assume Fortran 2003: has FLUSH, ALLOCATABLE, derived type, and ISO C Binding</span><br><span class="hljs-comment"># SUCCESS test 2 fortran only free format</span><br><br><span class="hljs-comment"># TEST #3: C</span><br>gcc TEST_3_c_only.c<br>./a.out<br><span class="hljs-comment"># SUCCESS test 3 c only</span><br><br><span class="hljs-comment"># TEST #4: FORTRAN CALLING A C FUNCTION (GCC AND GFORTRAN HAVE DIFFERENT DEFAULTS, </span><br><span class="hljs-comment"># SO WE FORCE BOTH TO ALWAYS USE 64 BIT (-M64) WHEN COMBINING THEM)</span><br>gcc -c -m64 TEST_4_fortran+c_c.c<br>gfortran -c -m64 TEST_4_fortran+c_f.f90<br>gfortran -m64 TEST_4_fortran+c_f.o TEST_4_fortran+c_c.o<br>./a.out<br><span class="hljs-comment"># C function called by Fortran</span><br><span class="hljs-comment"># Values are xx = 2.00 and ii = 1</span><br><span class="hljs-comment"># SUCCESS test 4 fortran calling c</span><br><br><span class="hljs-comment"># TEST #5: CSH</span><br>./TEST_csh.csh<br><span class="hljs-comment"># SUCCESS csh test</span><br><span class="hljs-comment">#  TEST #6: PERL</span><br>./TEST_perl.pl<br><span class="hljs-comment"># SUCCESS perl test</span><br><span class="hljs-comment">#  TEST #7: SH</span><br>./TEST_sh.sh<br><span class="hljs-comment"># SUCCESS sh test</span><br></code></pre></td></tr></table></figure><h2 id="wrf-v3.8.1-2">WRF v3.8.1 <sup id="fnref:2" class="footnote-ref"><a href="#fn:2" rel="footnote"><span class="hint--top hint--rounded" data-aria-label="[WRFv3.8.1 installation on a Linux machine](https://metclim.ucd.ie/2017/06/wrf-installation-on-a-linux-machine/)">[2]</span></a></sup></h2><p>Using a version of gfortran which is 4.4.0 or newer is recommended.</p><blockquote><p>https://www2.mmm.ucar.edu/wrf/OnLineTutorial/compile_tutorial/tar_files/ netcdf-4.1.3 mpich-3.0.4 zlib-1.2.7 libpng-1.2.50 JasPer-1.900.1</p></blockquote><p>The above libraries are requried for running WRF and download to folder wrf_instsall/.</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-built_in">source</span> gcc_env.sh<br><span class="hljs-comment">#export gcc_version=&quot;gcc-v4.8.5&quot; # and change gcc_env.sh !!!!!!</span><br><br><span class="hljs-built_in">export</span> HOME=`<span class="hljs-built_in">pwd</span>`<br><span class="hljs-built_in">export</span> download_DIR=<span class="hljs-variable">$HOME</span>/wrf_install/<br><span class="hljs-built_in">export</span> libs_DIR=<span class="hljs-variable">$HOME</span>/Library/<br><br><span class="hljs-built_in">export</span> LD_LIBRARY_PATH=<span class="hljs-variable">$libs_DIR</span>/lib:<span class="hljs-variable">$LD_LIBRARY_PATH</span><br><span class="hljs-built_in">export</span> LDFLAGS=-L<span class="hljs-variable">$libs_DIR</span>/lib<br><span class="hljs-built_in">export</span> CPPFLAGS=-I<span class="hljs-variable">$libs_DIR</span>/include<br><br>gcc --version<br>gfortran --version<br><br><span class="hljs-built_in">echo</span> <span class="hljs-variable">$HOME</span><br><span class="hljs-built_in">echo</span> <span class="hljs-variable">$download_DIR</span><br><span class="hljs-built_in">echo</span> <span class="hljs-variable">$libs_DIR</span><br><br><span class="hljs-built_in">mkdir</span> -p wrf_install<br><span class="hljs-built_in">mkdir</span> -p Library<br><br><span class="hljs-comment">############################## zlib ############################</span><br><span class="hljs-built_in">cd</span> <span class="hljs-variable">$download_DIR</span><br><span class="hljs-built_in">rm</span> -rf zlib-1.2.7/<br>tar xvf zlib-1.2.7.tar.gz<br><br><span class="hljs-built_in">cd</span> zlib-1.2.7/<br><br>./configure --prefix=<span class="hljs-variable">$libs_DIR</span><br>make<br>make install<br><br><span class="hljs-comment">############################## libpng ############################</span><br><span class="hljs-built_in">cd</span> <span class="hljs-variable">$download_DIR</span><br><span class="hljs-built_in">rm</span> -rf libpng-1.2.50<br>tar xvf libpng-1.2.50.tar.gz<br><br><span class="hljs-built_in">cd</span> libpng-1.2.50/<br><br>./configure --prefix=<span class="hljs-variable">$libs_DIR</span><br>make<br>make install<br><br><span class="hljs-comment">############################## netcdf-C ############################</span><br><span class="hljs-built_in">cd</span> <span class="hljs-variable">$download_DIR</span><br><span class="hljs-built_in">rm</span> -rf netcdf-4.1.3<br>tar xvf netcdf-4.1.3.tar.gz<br><br><span class="hljs-built_in">cd</span> netcdf-4.1.3/<br><br><span class="hljs-built_in">export</span> LD_LIBRARY_PATH=<span class="hljs-variable">$libs_DIR</span>/lib:<span class="hljs-variable">$LD_LIBRARY_PATH</span><br><span class="hljs-built_in">export</span> LDFLAGS=-L<span class="hljs-variable">$libs_DIR</span>/lib<br><span class="hljs-built_in">export</span> CPPFLAGS=-I<span class="hljs-variable">$libs_DIR</span>/include<br><br><span class="hljs-comment"># ./configure --prefix=$libs_DIR</span><br>./configure --prefix=<span class="hljs-variable">$libs_DIR</span> --disable-dap --disable-netcdf-4 --disable-shared<br>make<br>make install<br><br><span class="hljs-built_in">export</span> PATH=<span class="hljs-variable">$libs_DIR</span>/bin:<span class="hljs-variable">$PATH</span><br><span class="hljs-built_in">export</span> NETCDF=<span class="hljs-variable">$libs_DIR</span><br><span class="hljs-comment">############################## JasPer ############################</span><br><span class="hljs-built_in">cd</span> <span class="hljs-variable">$download_DIR</span><br><span class="hljs-built_in">rm</span> -rf jasper-1.900.1<br>tar vxf jasper-1.900.1.tar.gz<br><br><span class="hljs-built_in">cd</span> jasper-1.900.1<br><br><span class="hljs-comment">#sed -i &#x27;s|char|const char|g&#x27; src/libjasper/jpg/jpg_dummy.c</span><br><br>./configure --prefix=<span class="hljs-variable">$libs_DIR</span><br><br>make<br>make install<br><span class="hljs-comment">##############################MPICH############################</span><br><span class="hljs-built_in">cd</span> <span class="hljs-variable">$download_DIR</span><br><span class="hljs-built_in">rm</span> mpich-3.0.4<br>tar vxf mpich-3.0.4.tar.gz<br><br><span class="hljs-built_in">cd</span> mpich-3.0.4/<br>./configure --prefix=<span class="hljs-variable">$libs_DIR</span> <span class="hljs-comment">#--with-device=ch3</span><br><br>make<br>make install<br><br><span class="hljs-built_in">export</span> PATH=<span class="hljs-variable">$libs_DIR</span>/bin:<span class="hljs-variable">$PATH</span><br></code></pre></td></tr></table></figure><p>and, combine all required libaries in wrf_env.sh</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-meta">#!/bin/bash</span><br><span class="hljs-built_in">source</span> gcc_env.sh<br><span class="hljs-built_in">export</span> HOME=`<span class="hljs-built_in">pwd</span>`<br><span class="hljs-built_in">export</span> libs_DIR=<span class="hljs-variable">$HOME</span>/Library/<br><span class="hljs-built_in">export</span> LD_LIBRARY_PATH=<span class="hljs-variable">$libs_DIR</span>/lib:<span class="hljs-variable">$LD_LIBRARY_PATH</span><br><span class="hljs-built_in">export</span> LDFLAGS=-L<span class="hljs-variable">$libs_DIR</span>/lib<br><span class="hljs-built_in">export</span> CPPFLAGS=-I<span class="hljs-variable">$libs_DIR</span>/include<br><span class="hljs-built_in">export</span> PATH=<span class="hljs-variable">$libs_DIR</span>/bin:<span class="hljs-variable">$PATH</span><br><span class="hljs-built_in">export</span> NETCDF=<span class="hljs-variable">$libs_DIR</span><br></code></pre></td></tr></table></figure><h3 id="library-compatibility-tests">Library Compatibility Tests</h3><p>We have to test the Library in your computer/clsuter. #### Download test tar files,</p><blockquote><p>http://www2.mmm.ucar.edu/wrf/OnLineTutorial/compile_tutorial/tar_files/Fortran_C_NETCDF_MPI_tests.tar</p></blockquote><h4 id="run_library_test.sh">run_library_test.sh</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-meta">#!/bin/bash</span><br><span class="hljs-built_in">source</span> wrf_env.sh<br><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;=================================================================&quot;</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;=================== Fortran_C_NETCDF_MPI_tests.tar ==============&quot;</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;=================================================================&quot;</span><br><br><span class="hljs-comment"># To unpack the tar file, type:</span><br><span class="hljs-comment"># wget -c https://www2.mmm.ucar.edu/wrf/OnLineTutorial/compile_tutorial/tar_files/Fortran_C_NETCDF_MPI_tests.tar</span><br><span class="hljs-comment"># tar -xf Fortran_C_NETCDF_MPI_tests.tar</span><br><br><span class="hljs-comment"># Test #1: Fortran + C + NetCDF</span><br><br><span class="hljs-comment"># The NetCDF-only test requires the include file from the NETCDF package be in this directory. Copy the file here:</span><br><span class="hljs-built_in">cp</span> <span class="hljs-variable">$&#123;NETCDF&#125;</span>/include/netcdf.inc .<br><br><span class="hljs-comment"># Compile the Fortran and C codes for the purpose of this test </span><br><span class="hljs-comment"># (the -c option says to not try to build an executable). Type the following commands:</span><br>gfortran -c 01_fortran+c+netcdf_f.f<br>gcc -c 01_fortran+c+netcdf_c.c<br>gfortran 01_fortran+c+netcdf_f.o 01_fortran+c+netcdf_c.o \<br>     -L<span class="hljs-variable">$&#123;NETCDF&#125;</span>/lib -lnetcdff -lnetcdf<br>./a.out<br><br><span class="hljs-comment"># The following should be displayed on your screen:</span><br><span class="hljs-comment"># C function called by Fortran</span><br><span class="hljs-comment"># Values are xx = 2.00 and ii = 1</span><br><span class="hljs-comment"># SUCCESS test 1 fortran + c + netcdf</span><br><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;=================================================================&quot;</span><br><span class="hljs-comment"># Test #2: Fortran + C + NetCDF + MPI</span><br><br><span class="hljs-comment"># The NetCDF+MPI test requires include files from both of these packages be in this directory, </span><br><span class="hljs-comment"># but the MPI scripts automatically make the mpif.h file available without assistance, </span><br><span class="hljs-comment"># so no need to copy that one. Copy the NetCDF include file here:</span><br><span class="hljs-built_in">cp</span> <span class="hljs-variable">$&#123;NETCDF&#125;</span>/include/netcdf.inc .<br><br><span class="hljs-comment"># Note that the MPI executables mpif90 and mpicc are used below when compiling. Issue the following commands:</span><br>mpif90 -c 02_fortran+c+netcdf+mpi_f.f<br>mpicc -c 02_fortran+c+netcdf+mpi_c.c<br>mpif90 02_fortran+c+netcdf+mpi_f.o \<br>02_fortran+c+netcdf+mpi_c.o \<br>     -L<span class="hljs-variable">$&#123;NETCDF&#125;</span>/lib -lnetcdff -lnetcdf<br>mpirun ./a.out<br><br><span class="hljs-comment"># The following should be displayed on your screen:</span><br><span class="hljs-comment"># C function called by Fortran</span><br><span class="hljs-comment"># Values are xx = 2.00 and ii = 1</span><br><span class="hljs-comment"># status = 2</span><br><span class="hljs-comment"># SUCCESS test 2 fortran + c + netcdf + mpi</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;=================================================================&quot;</span><br></code></pre></td></tr></table></figure><h3 id="install-wrfv3.8.1">Install WRFv3.8.1</h3><h4 id="download">Download</h4><blockquote><p>http://www2.mmm.ucar.edu/wrf/src/WRFV3.8.1.TAR.gz</p></blockquote><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-meta">#!/bin/bash</span><br><span class="hljs-comment"># WRF will not compile using GCC version 6 or higher. </span><br><span class="hljs-comment"># It will only work with version 4.8.5. </span><br><span class="hljs-comment"># The GCC6 module loads automatically when you log in.</span><br><span class="hljs-comment"># If you unload it, the system will default to GCC 4.8.5.</span><br><br><span class="hljs-built_in">source</span> wrf_env.sh<br><span class="hljs-built_in">export</span> HOME=`<span class="hljs-built_in">pwd</span>` <br><span class="hljs-built_in">export</span> libs_DIR=/home/wpsze/WRFv381/Library/ <span class="hljs-comment"># HOME = /home/wpsze/WRFv381/</span><br><span class="hljs-built_in">export</span> download_DIR=<span class="hljs-variable">$HOME</span>/wrf_install/<br><br><span class="hljs-comment"># gunzip WRFV3.8.1.TAR.gz</span><br><span class="hljs-comment"># tar -xf WRFV3.8.1.TAR</span><br><br><span class="hljs-built_in">cd</span> <span class="hljs-variable">$download_DIR</span><br><br><span class="hljs-built_in">cd</span> WRFV3/<br><br><span class="hljs-built_in">export</span> WRF_DIR=<span class="hljs-string">&quot;WRFV3&quot;</span><br><br><span class="hljs-comment">#./clean -a ## running or not</span><br><br>./configure <br><span class="hljs-comment">##  34 (dmpar) GNU [gfortran/gcc]</span><br><br>./compile -j 4 em_real 2&gt;&amp;1 | <span class="hljs-built_in">tee</span> compile.log<br><span class="hljs-comment">#./compile em_real 2&gt;&amp;1 | tee compile.log</span><br><br><span class="hljs-comment"># # #It should fail on the first time (namely main/real.exe is not created)</span><br><span class="hljs-comment"># # #with the following error:</span><br><span class="hljs-comment"># # #+++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><br><span class="hljs-comment"># # #real_em.f90:32.7:</span><br><br><span class="hljs-comment"># # #   USE module_initialize_real, ONLY : wrfu_initialize, find_my_parent, find_my_</span><br><span class="hljs-comment"># # 1</span><br><span class="hljs-comment"># # #Fatal Error: Can&#x27;t open module file &#x27;module_initialize_real.mod&#x27; for reading at (1): No such file or</span><br><span class="hljs-comment"># # #directory</span><br><span class="hljs-comment"># # #nup_em.f90:90.7:</span><br><br><span class="hljs-comment"># # #   USE module_initialize_real, only : wrfu_initialize</span><br><span class="hljs-comment"># # #       1</span><br><span class="hljs-comment"># # #Fatal Error: Can&#x27;t open module file &#x27;module_initialize_real.mod&#x27; for reading at (1): No such file or</span><br><span class="hljs-comment"># # #directory</span><br><span class="hljs-comment"># # #+++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><br><br><span class="hljs-comment"># # #Then it should end successfully when running the</span><br><span class="hljs-comment"># # #command a second time (do not understand why but it works...)</span><br><br><span class="hljs-comment"># # # ---&gt;                  Executables successfully built                  &lt;---</span><br></code></pre></td></tr></table></figure><p>This should return the following four files:</p><blockquote><p>wrf.exe real.exe ndown.exe tc.exe</p></blockquote><h3 id="install-wpsv3.8.1">Install WPSv3.8.1</h3><h4 id="download-1">Download</h4><blockquote><p>http://www2.mmm.ucar.edu/wrf/src/WPSV3.8.1.TAR.gz</p></blockquote><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-meta">#!/bin/bash</span><br><span class="hljs-built_in">source</span> wrf_env.sh<br><span class="hljs-built_in">export</span> HOME=`<span class="hljs-built_in">pwd</span>` <br><span class="hljs-built_in">export</span> libs_DIR=/home/wpsze/WRFv381/Library/ <span class="hljs-comment"># HOME = /home/wpsze/WRFv381/</span><br><span class="hljs-built_in">export</span> download_DIR=<span class="hljs-variable">$HOME</span>/wrf_install/<br><br><span class="hljs-built_in">cd</span> <span class="hljs-variable">$download_DIR</span><br><span class="hljs-comment">#tar xvf xxxx.tar.gz</span><br><span class="hljs-built_in">cd</span> WPS/<br><span class="hljs-built_in">export</span> WRF_DIR=../WRFV3/<br><span class="hljs-built_in">export</span> JASPERLIB=<span class="hljs-variable">$libs_DIR</span>/lib/<br><span class="hljs-built_in">export</span> JASPERINC=<span class="hljs-variable">$libs_DIR</span>/include/<br><br><span class="hljs-comment">#then option 1 Linux x86_64, gfortran    (serial)</span><br><br><span class="hljs-comment"># ./clean -a</span><br><br>./configure<br><br><span class="hljs-comment"># 1 (dmpar) gfortran</span><br><br>./compile 2&gt;&amp;1 | <span class="hljs-built_in">tee</span> compile.log<br></code></pre></td></tr></table></figure><p>This should return the three executable files needed to run WPS.</p><blockquote><p>geogrid.exe metgrid.exe ungrib.exe</p></blockquote><h2 id="wrf-v4.4.0">WRF v4.4.0</h2><section class="footnotes"><div class="footnote-list"><ol><li><span id="fn:1" class="footnote-text"><span><a href="https://www.mmm.ucar.edu/models/wrf">WRF</a> <a href="#fnref:1" rev="footnote" class="footnote-backref"> ↩</a></span></span></li><li><span id="fn:2" class="footnote-text"><span><a href="https://metclim.ucd.ie/2017/06/wrf-installation-on-a-linux-machine/">WRFv3.8.1 installation on a Linux machine</a> <a href="#fnref:2" rev="footnote" class="footnote-backref"> ↩</a></span></span></li></ol></div></section>]]></content>
    
    
    <categories>
      
      <category>WRF</category>
      
    </categories>
    
    
    <tags>
      
      <tag>NWP</tag>
      
      <tag>gnu</tag>
      
      <tag>gcc</tag>
      
      <tag>WRF</tag>
      
      <tag>WPS</tag>
      
      <tag>Installation</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Slurm</title>
    <link href="/2023/04/24/Slurm/"/>
    <url>/2023/04/24/Slurm/</url>
    
    <content type="html"><![CDATA[<p>SLURM (Simple Linux Utility for Resource Management) <sup id="fnref:1" class="footnote-ref"><a href="#fn:1" rel="footnote"><span class="hint--top hint--rounded" data-aria-label="[Slurm](https://slurm.schedmd.com/documentation.html)">[1]</span></a></sup> <sup id="fnref:5" class="footnote-ref"><a href="#fn:5" rel="footnote"><span class="hint--top hint--rounded" data-aria-label="[Slurm中英文對照文檔](https://docs.slurm.cn/master/man-pages-shou-ce)">[5]</span></a></sup> is a powerful and flexible workload manager, designed for distributed computing environments. It is an open-source, highly-scalable system that provides advanced job scheduling, efficient job submission, and comprehensive system monitoring capabilities. SLURM allows users to manage computing resources efficiently, enabling more efficient and cost-effective research and data analysis. Overall, SLURM provides a highly efficient and flexible resource management solution for distributed computing environments. Its features make it an excellent choice for researchers and scientists looking to optimize their computing resources, streamline their workflows, and enhance their productivity.</p><p>Usual commands:</p><table><thead><tr class="header"><th style="text-align: left;">Purpose</th><th style="text-align: left;">Command</th></tr></thead><tbody><tr class="odd"><td style="text-align: left;">To check what queues (partitions) are available</td><td style="text-align: left;">sinfo</td></tr><tr class="even"><td style="text-align: left;">To submit job</td><td style="text-align: left;">sbatch <your_job_script></td></tr><tr class="odd"><td style="text-align: left;">To view the queue status</td><td style="text-align: left;">squeue</td></tr><tr class="even"><td style="text-align: left;">To view the queue status of your job</td><td style="text-align: left;">squeue -u $USER</td></tr><tr class="odd"><td style="text-align: left;">To cancel a running or pending job</td><td style="text-align: left;">scancel JOBID</td></tr><tr class="even"><td style="text-align: left;">To view detailed information of your job</td><td style="text-align: left;">scontrol show job JOBID</td></tr><tr class="odd"><td style="text-align: left;">To View resource accounting information for finished and running jobs</td><td style="text-align: left;">sacct</td></tr><tr class="even"><td style="text-align: left;">To View resource accounting information for running jobs</td><td style="text-align: left;">sstat</td></tr></tbody></table><h2 id="sample-script">Sample script</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-meta">#!/bin/bash</span><br><br><span class="hljs-comment"># NOTE: Lines starting with &quot;#SBATCH&quot; are valid SLURM commands or statements,</span><br><span class="hljs-comment">#       while those starting with &quot;#&quot; and &quot;##SBATCH&quot; are comments.  Uncomment</span><br><span class="hljs-comment">#       &quot;##SBATCH&quot; line means to remove one # and start with #SBATCH to be a</span><br><span class="hljs-comment">#       SLURM command or statement.</span><br><br><span class="hljs-comment">#SBATCH -J slurm_job # Slurm job name</span><br><span class="hljs-comment">#SBATCH -t 48:00:00  # time limit: (D-HH:MM or D-HH:MM:SS)</span><br><br><span class="hljs-comment"># Enable email notificaitons when job begins and ends, uncomment if you need it</span><br><span class="hljs-comment">##SBATCH --mail-user=waipangsze@gmail.com # Update your email address</span><br><span class="hljs-comment">##SBATCH --mail-type=end           # NONE, BEGIN, END, FAIL, REQUEUE, ALL</span><br><br><span class="hljs-comment"># Choose partition (queue) to use. Note: replace &lt;partition_to_use&gt; with the name of partition</span><br><span class="hljs-comment">#SBATCH -p &lt;partition_to_use&gt;</span><br><br><span class="hljs-comment"># Use memory, nodes and cores</span><br><span class="hljs-comment">#SBATCH --mem=32000            # memory per node in MB </span><br><span class="hljs-comment">#SBATCH --nodes=1              # number of nodes</span><br><span class="hljs-comment">#SBATCH --ntasks-per-node=16   # number of cores</span><br><br><span class="hljs-comment"># Setup runtime environment if necessary</span><br><span class="hljs-comment"># For example, setup intel MPI environment</span><br>module gnu8<br><span class="hljs-comment"># Setup runtime environment if necessary </span><br><span class="hljs-comment"># or you can source ~/.bashrc or ~/.bash_profile </span><br><span class="hljs-comment"># Go to the job submission directory and run your application</span><br><span class="hljs-built_in">cd</span> <span class="hljs-variable">$HOME</span>/apps/slurm<br>mpirun ./your_mpi_application<br><br><span class="hljs-comment"># or another work</span><br>module load intel/compiler/64/2017/17.0.0<br>module load intel/mkl/64/2017/0.098<br>module load intel/mpi/64/2017/0.098<br><span class="hljs-built_in">cd</span> /gpfs/projects/samples/intel_mpi_hello/<br>mpiicc mpi_hello.c -o intel_mpi_hello<br>mpirun ./intel_mpi_hello<br><br><span class="hljs-comment"># or GPU</span><br><span class="hljs-comment">#SBATCH -N 1 -n 8 -p GPU-V100 --gres=gpu:v100:2</span><br>./your-gpu-prog<br></code></pre></td></tr></table></figure><p>You have to module what you need (compiler and correspoinding libraries)<sup id="fnref:2" class="footnote-ref"><a href="#fn:2" rel="footnote"><span class="hint--top hint--rounded" data-aria-label="[HKUST ITSC: JOB SCHEDULING SYSTEM (SLURM)](https://itsc.hkust.edu.hk/services/academic-teaching-support/high-performance-computing/hpc3-cluster/jobs)">[2]</span></a></sup>.</p><p>Upon job completion, the standard output will be stored in the job submission directory under the filename <strong>slurm-<your_slurm_jobid>.out</strong> or assign filename as</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment">#SBATCH --output=slurm.out     # file to collect standard output</span><br><span class="hljs-comment">#SBATCH --error=slurm.err      # file to collect standard errors</span><br></code></pre></td></tr></table></figure><p>If the time limit is not specified in the submit script, SLURM will assign the default run time, 3 days. This means the job will be terminated by SLURM in 72 hrs. If the memory limit is not requested, SLURM will assign the default 16 GB. The maximum allowed memory per node is 128 GB. To see how much RAM per node your job is using, you can run commands sacct or sstat to query MaxRSS for the job on the node.</p><h2 id="query-job-information">Query job information</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-meta">#!/bin/bash</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;===========================================================&quot;</span><br>sacct --format=JobID,Jobname,start,end,elapsed,nnodes,ncpus,AveRSS,MaxRSS,MaxDiskRead,MaxDiskWrite,CPUTime,MaxVMSize<br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;===========================================================&quot;</span><br>squeue -o<span class="hljs-string">&quot;%.7i %.9P %.8j %.8u %.2t %.10M %.6D %C %m %z %V %l&quot;</span><br>squeue -o<span class="hljs-string">&quot;%.7i %o&quot;</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;===========================================================&quot;</span><br></code></pre></td></tr></table></figure><p><a href="https://slurm.schedmd.com/sinfo.html"><strong>sinfo</strong></a></p><p><a href="https://slurm.schedmd.com/squeue.html"><strong>squeue</strong></a></p><p><a href="https://slurm.schedmd.com/sacct.html"><strong>sacct</strong></a></p><p><a href="https://slurm.schedmd.com/scontrol.html"><strong>scontrol</strong></a></p><p>One more for check historical jobs, <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-built_in">alias</span> sacct_job=<span class="hljs-string">&#x27;sacct --format=&quot;JobId,JobName%50,Partition,Nodelist,Account,AllocCPUS,State,Submit,Start,End,Elapsed&quot;&#x27;</span><br><br>sacct_job --starttime=2023-05-01<br></code></pre></td></tr></table></figure></p><h3 id="seff">seff</h3><p>The Slurm job efficiency report (seff)<sup id="fnref:3" class="footnote-ref"><a href="#fn:3" rel="footnote"><span class="hint--top hint--rounded" data-aria-label="[Slurm command: seff](https://bugs.schedmd.com/show_bug.cgi?id=1611)">[3]</span></a></sup></p><p>Summary: seff takes a jobid and reports on the efficiency of that job's cpu and memory utilization. The rpm/tarball comes with an 'smail' utility that allows for Slurm end-of-job emails to include a seff report. This allows users to become aware if they are wasting resources. <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># This script is roughtly equivalent to:</span><br><span class="hljs-comment"># sacct -P -n -a --format JobID,User,Group,State,Cluster,AllocCPUS,REQMEM,TotalCPU,Elapsed,MaxRSS,ExitCode,NNodes,NTasks -j &lt;job_id&gt;</span><br></code></pre></td></tr></table></figure></p><p>or copy from github <a href="https://github.com/SchedMD/slurm/blob/260ced654c920481eaf03558e887741e673cca53/contribs/seff/seff">SchedMd slurm seff</a></p><h2 id="ulimit--s-unlimited">ulimit -s unlimited</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-built_in">ulimit</span> -l unlimited<br><span class="hljs-built_in">ulimit</span> -s unlimited<br></code></pre></td></tr></table></figure><h2 id="slurm-job-dependencies">SLURM Job Dependencies</h2><p>You may submit jobs that runs depending on status of the previously submitted jobs or schedule a bunch of jobs to run one after the other.<sup id="fnref:4" class="footnote-ref"><a href="#fn:4" rel="footnote"><span class="hint--top hint--rounded" data-aria-label="[HKU slurm-job-dependencies](https://hpc.hku.hk/guide/slurm-guide/slurm-job-dependencies/)">[4]</span></a></sup> <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># Format is </span><br>$ sbatch --dependency=<span class="hljs-built_in">type</span>:job_id jobfile<br>$ sbatch --dependency=<span class="hljs-built_in">type</span>:job_id,job_id,job_id jobfile <span class="hljs-comment"># requires more than one job to be completed</span><br><br>jobID=$(sbatch first_job.sh)<br>sbatch --dependency=afterok:<span class="hljs-variable">$&#123;jobID&#125;</span> second_job.sh<br></code></pre></td></tr></table></figure></p><h2 id="submit-a-job-to-a-specific-node">Submit a job to a specific node</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sh">sbatch --nodelist=node[01-09]<br>sbatch --nodelist=node01<br>sbatch --exclude=node[10-19] <span class="hljs-comment"># Slurm sbatch exclude nodes or node list</span><br></code></pre></td></tr></table></figure><h2 id="mem-per-cpu">--mem-per-cpu</h2><ul><li><a href="https://researchcomputing.princeton.edu/support/knowledge-base/memory" class="uri">https://researchcomputing.princeton.edu/support/knowledge-base/memory</a></li></ul><p>In this case the correct action would be to decrease the required memory by using something like <strong>#SBATCH --mem-per-cpu=3G</strong>. It is wise to request more memory than you actually need for safety. Remember that the job will fail if it runs out of memory.</p><div class="note note-primary">            <p>However, it is important not to request an excessive amount because that would make it harder for the job scheduler to schedule the job which results in longer queue times.</p>          </div><h2 id="parameters-for-openmp">Parameters for OpenMP</h2><p>The OMP_STACKSIZE environment variable controls the size of the stack for threads created by the OpenMP implementation. <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># Parameters for OpenMP</span><br><span class="hljs-built_in">export</span> OMP_STACKSIZE=512m <span class="hljs-comment"># the number is suffixed by B, K, M or G</span><br><span class="hljs-built_in">export</span> OMP_NUM_THREADS=1<br></code></pre></td></tr></table></figure></p><h1 id="references">References</h1><ol type="1"><li><a href="https://docs.hpc.sjtu.edu.cn/job/slurm.html">上海交大超算平台用户手册 Documentation Slurm 作业调度系统</a></li><li><a href="https://scc.ustc.edu.cn/zlsc/user_doc/html/slurm/index.html">中国科大超算中心用户使用手册 Slurm作业调度系统</a><section class="footnotes"><div class="footnote-list"><ol><li><span id="fn:1" class="footnote-text"><span><a href="https://slurm.schedmd.com/documentation.html">Slurm</a> <a href="#fnref:1" rev="footnote" class="footnote-backref"> ↩</a></span></span></li><li><span id="fn:2" class="footnote-text"><span><a href="https://itsc.hkust.edu.hk/services/academic-teaching-support/high-performance-computing/hpc3-cluster/jobs">HKUST ITSC: JOB SCHEDULING SYSTEM (SLURM)</a> <a href="#fnref:2" rev="footnote" class="footnote-backref"> ↩</a></span></span></li><li><span id="fn:3" class="footnote-text"><span><a href="https://bugs.schedmd.com/show_bug.cgi?id=1611">Slurm command: seff</a> <a href="#fnref:3" rev="footnote" class="footnote-backref"> ↩</a></span></span></li><li><span id="fn:4" class="footnote-text"><span><a href="https://hpc.hku.hk/guide/slurm-guide/slurm-job-dependencies/">HKU slurm-job-dependencies</a> <a href="#fnref:4" rev="footnote" class="footnote-backref"> ↩</a></span></span></li><li><span id="fn:5" class="footnote-text"><span><a href="https://docs.slurm.cn/master/man-pages-shou-ce">Slurm中英文對照文檔</a> <a href="#fnref:5" rev="footnote" class="footnote-backref"> ↩</a></span></span></li><li><span id="fn:6" class="footnote-text"><span><a href="https://hpc.hku.hk/guide/slurm-guide/slurm-job-script/">HKU SLURM Job script</a> <a href="#fnref:6" rev="footnote" class="footnote-backref"> ↩</a></span></span></li></ol></div></section></li></ol>]]></content>
    
    
    <categories>
      
      <category>Linux</category>
      
    </categories>
    
    
    <tags>
      
      <tag>slurm</tag>
      
      <tag>HPC</tag>
      
      <tag>NWP</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Setting up Blog on github.io</title>
    <link href="/2023/04/23/github-io/"/>
    <url>/2023/04/23/github-io/</url>
    
    <content type="html"><![CDATA[<p>This article shares the process of setting up blog website on github.io.</p><h2 id="create-a-new-github-and-git-clone-to-local-computer">Create a new github and git clone to local computer</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># the project to your own account and renaming the repo with &lt;yourusername&gt;.github.io</span><br>git <span class="hljs-built_in">clone</span> git@github.com:xxx/xxx.github.io<br></code></pre></td></tr></table></figure><h2 id="install-packages">Install packages</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs sh">conda create -n jekyll<br>conda activate jekyll<br>conda install -c conda-forge c-compiler compilers cxx-compiler<br>conda install -c conda-forge ruby<br>gem update --system<br>gem install bundler<br>gem install jekyll<br>gem install jekyll-paginate<br></code></pre></td></tr></table></figure><p>Remark: $ conda install -c conda-forge ruby=3.3.3</p><p>and checking, <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-built_in">which</span> jekyll<br><span class="hljs-built_in">which</span> ruby<br><span class="hljs-built_in">ln</span> -s /xxx/anaconda3/envs/jekyll/bin/ruby /xxx/anaconda3/envs/jekyll/share/rubygems/bin/ruby<br>bundle init<br>bundle install<br>bundle update --bundler<br>bundle add jekyll<br>gem <span class="hljs-string">&quot;jekyll&quot;</span><br>gem <span class="hljs-string">&quot;jekyll-paginate&quot;</span><br>bundle update<br>bundle <span class="hljs-built_in">exec</span> jekyll -v<br>vim Gemfile + gem <span class="hljs-string">&quot;jekyll-paginate&quot;</span><br></code></pre></td></tr></table></figure></p><h2 id="run-on-local-computer">Run on local computer</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh">bundle update<br>bundle <span class="hljs-built_in">exec</span> jekyll serve<br></code></pre></td></tr></table></figure><p>iMac is <figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs vim">Run in <span class="hljs-keyword">verbose</span> <span class="hljs-keyword">mode</span> <span class="hljs-keyword">to</span> see <span class="hljs-keyword">all</span> warnings.<br>                    done in <span class="hljs-number">2.362</span> seconds.<br> Auto-regeneration: enabled <span class="hljs-keyword">for</span> <span class="hljs-string">&#x27;/Users/wpsze/Documents/git-local/waipangsze.github.io&#x27;</span><br>    Server address: http://<span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span>:<span class="hljs-number">4000</span><br>  Server running... press ctrl-<span class="hljs-keyword">c</span> <span class="hljs-keyword">to</span> <span class="hljs-keyword">stop</span>.<br>[<span class="hljs-number">2022</span>-<span class="hljs-number">06</span>-<span class="hljs-number">01</span> <span class="hljs-number">13</span>:<span class="hljs-number">15</span>:<span class="hljs-number">18</span>] ERROR `/js/pageContent.js<span class="hljs-string">&#x27; not found.</span><br></code></pre></td></tr></table></figure></p><p>Open a browser with the ip address in above output</p><h2 id="upload-to-github">Upload to github</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs sh">git pull --rebase <span class="hljs-comment"># do this at the beginning</span><br>git status<br>git add . <span class="hljs-comment"># add all files</span><br>git commit --amend<br>git push (-f)<br>git push -u origin main<br></code></pre></td></tr></table></figure><h2 id="errors">Errors</h2><ol type="1"><li>jekyll/share/rubygems/bin/ruby: No such file or directory</li><li>Error installing jekyll: Failed to build gem native extension</li><li>cannot load such file – jekyll-paginate</li><li>Could not locate Gemfile (bundle init)</li><li>jekyll is not currently included in the bundle, perhaps you meant to add it to your Gemfile (Edit Gemfile, + gem "jekyll", "~&gt; 4.3"</li><li>make: /usr/bin/mkdir: Command not found ==&gt; in .zshrc, add source ~/.bashrc, and sudo ln -s /bin/mkdir /usr/bin/mkdir</li></ol><p>Reference: 1. <a href="https://s-canchi.github.io/2021-04-30-jekyll-conda/">Setting up a blog site with jekyll using conda</a> 2. <a href="https://github.com/kitian616/jekyll-TeXt-theme">TeXt Theme</a> 3. <a href="https://github.com/kitian616/jekyll-TeXt-theme/tree/master/docs/_posts">_posts</a> 4. <a href="https://github.com/Gaohaoyang/gaohaoyang.github.io/tree/master">gaohaoyang.github.io)</a> 5. <a href="https://gaohaoyang.github.io/">Welcome to HyG's Blog! 这里记录着我的前端学习之路</a></p>]]></content>
    
    
    <categories>
      
      <category>github</category>
      
    </categories>
    
    
    <tags>
      
      <tag>github.io</tag>
      
      <tag>blog</tag>
      
      <tag>jekyll</tag>
      
    </tags>
    
  </entry>
  
  
  
  
</search>
